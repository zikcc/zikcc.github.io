<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>嵌入式Linux开发面试题-2</title>
      <link href="/2025/05/22/%E5%B5%8C%E5%85%A5%E5%BC%8FLinux%E5%BC%80%E5%8F%91%E9%9D%A2%E8%AF%95%E9%A2%98-2/"/>
      <url>/2025/05/22/%E5%B5%8C%E5%85%A5%E5%BC%8FLinux%E5%BC%80%E5%8F%91%E9%9D%A2%E8%AF%95%E9%A2%98-2/</url>
      
        <content type="html"><![CDATA[<h2 id="嵌入式linux开发面试题-2"><a class="markdownIt-Anchor" href="#嵌入式linux开发面试题-2"></a> 嵌入式Linux开发面试题-2</h2><ol><li>指针与引用的核心区别？项目中如何应用？<ul><li>区别：<ul><li>指针是变量存储地址，可重指向其他对象；引用是别名，绑定后不可更改。</li><li>指针可为空(nullptr), 引用必须绑定有效对象。</li></ul></li><li>项目关联：<br />在OpenCV图像处理中，使用指针传递大型图像数据矩阵(如cv::Mat*)避免拷贝；引用用于函数参数传递(如 const cv::Mat&amp;)保证安全访问。<br />例如:<ul><li>使用指针:  <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">proccessImage</span><span class="params">(cv::Mat* img)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 假设对图像进行灰度化处理</span></span><br><span class="line">    cv::<span class="built_in">cvColor</span>(*img, *img, cv::COLOR_BGR2GRAY);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>不加const修饰时，可改变指针指向，和指向的值。<br />常量指针(const cv::Mat* img)：不能通过该指针修改指针指向的值。<br />指针常量(cv::Mat* const img)：不能修改指针的指向(也就是指针指向的地址不能变)</li><li>使用引用:  <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">proccessImage</span><span class="params">(<span class="type">const</span> cv::Mat&amp; img)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 灰度化处理</span></span><br><span class="line">    cv::Mat grayImg;</span><br><span class="line">    cv::<span class="built_in">cvtColor</span>(img, grayImg, cv::COLOR_BGR2GRAY);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul>最佳实践:<ul><li>如果只是函数参数传递，优先使用 const cv::Mat&amp;（更安全、更简洁）</li><li>如果需要处理 nullptr (例如void proccessImage(const cv::Mat* img = nullptr) {} ) 或动态切换对象，使用 const cv::Mat*。</li></ul><blockquote><p>常量指针(const cv::Mat* img)是否一定能保证指向的值不会被改变？<br />不一定！const cv::Mat* img（指向常量的指针）只能保证不能通过该指针修改数据，但原始数据仍可能被其他方式修改。</p></blockquote></li></ul></li><li>const 关键字在函数参数和成员函数中的作用？<ul><li>参数: const T&amp; 防止修改输入数据(如传感器的原始数据)。</li><li>成员函数: void func() const 承诺不修改对象状态(如线程安全的配置类), 表示只读。<br />例如:  <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Config</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span> width_;</span><br><span class="line">    <span class="type">int</span> height_;</span><br><span class="line">    <span class="keyword">mutable</span> <span class="type">int</span> accessCount_;   <span class="comment">// 可被 const 函数修改</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// const 成员函数，承诺不修改对象状态</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">printConfig</span><span class="params">()</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">        <span class="comment">// width_ = 100;    // 错误，不能修改非 mutable 成员</span></span><br><span class="line">        accessCount_++;     <span class="comment">// 正确，mutable成员可修改</span></span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Width: &quot;</span> &lt;&lt; width_ &lt;&lt; <span class="string">&quot;, Height: &quot;</span> &lt;&lt; height_ &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>返回非 const 指针/引用是危险的  <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">BadExample</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::vector&lt;<span class="type">int</span>&gt; data_;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// 危险：const 函数暴露了可修改的内部数据</span></span><br><span class="line">    <span class="function">std::vector&lt;<span class="type">int</span>&gt;&amp; <span class="title">getData</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> data_; &#125;  <span class="comment">// 不要这样做！</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>const 成员函数和非 const 成员函数可以重载</li><li>项目关联: 在模型推理的类中，const修饰推理函数确保权重不被意外修改。</li></ul></li><li>手写单例模式(线程安全版) <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Singleton</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">static</span> Singleton&amp; <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="type">static</span> Singleton instance;  <span class="comment">// 即使多次访问这个函数，instance也只会初始化一次。</span></span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">Singleton</span>(<span class="type">const</span> Singleton&amp;) = <span class="keyword">delete</span>;   <span class="comment">// 禁止拷贝构造</span></span><br><span class="line">    Singleton&amp; <span class="keyword">operator</span>=(<span class="type">const</span> Singleton&amp;) = <span class="keyword">delete</span>;    <span class="comment">// 禁用赋值构造</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="built_in">Singleron</span>() = <span class="keyword">default</span>;  <span class="comment">// 私有构造函数</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>项目关联: 用于全局配置管理(如摄像头参数加载)，避免多线程重复初始化。</li></ol>]]></content>
      
      
      <categories>
          
          <category> 嵌入式 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C++ </tag>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>嵌入式Linux开发面试题-1</title>
      <link href="/2025/05/21/%E5%B5%8C%E5%85%A5%E5%BC%8FLinux%E5%BC%80%E5%8F%91%E9%9D%A2%E8%AF%95%E9%A2%98-1/"/>
      <url>/2025/05/21/%E5%B5%8C%E5%85%A5%E5%BC%8FLinux%E5%BC%80%E5%8F%91%E9%9D%A2%E8%AF%95%E9%A2%98-1/</url>
      
        <content type="html"><![CDATA[<h2 id="嵌入式linux开发面试题-1"><a class="markdownIt-Anchor" href="#嵌入式linux开发面试题-1"></a> 嵌入式Linux开发面试题-1</h2><ol><li><p>C语言中 volatile 关键字的作用是什么? 举一个必须使用 volatile 的实际场景。</p><ul><li>作用: 告诉编译器不要优化对该变量的访问，每次必须从内存读取最新的值。</li><li>场景: 多线程共享变量、硬件寄存器访问(状态寄存器)、中断服务程序(ISR)中修改的全局变量。</li></ul></li><li><p>解释结构体内存对齐的规则，并给出优化结构体大小的两种方法。</p><ul><li>对齐原则: 成员偏移量是自身大小或编译器对齐值的整数倍，结构体总大小为最大对齐值的整数倍。</li><li>优化方法:<ol><li>按成员大小降序排列 (double -&gt; int -&gt; char)</li><li>使用 #pragma pack(1) 强制1字节对齐(牺牲性能换空间)</li></ol></li></ul></li><li><p>FreeRTOS中任务有哪几种状态? 如何让一个任务从阻塞态切换到就绪态?</p><ul><li>状态: 运行态(Runing)、就绪态(Ready)、阻塞态(Blocked)、挂起态(Suspended)。</li><li>切换方法: 通过信号量释放(xSemaphoreGive)、任务通知(xTaskNotify)、延迟到期(vTaskDelay)。</li></ul></li><li><p>IIC总线的上拉电阻阻值选择不当会导致什么问题? 如何计算合理的阻值</p><ul><li>问题: 阻值过小 -&gt; 电流过大损坏器件；阻值过大 -&gt; 上升沿过慢导致通信失败。</li><li>计算: 根据总线电容© 和上升时间($$t_r$$) 计算，公式: $$ R_max = t_r / (0.8473 * C) $$ (例: 100pF电容 + 1us 上升时间 -&gt; $$R_max \approx 1.18 k\Omega$$)</li></ul></li><li><p>嵌入式Linux系统与标准Linux系统的核心区别是什么?<br />嵌入式Linux系统针对特定的硬件裁剪内核，强调实时性、低功耗和小型化，通常搭配 BusyBox 等精简工具链。标准的Linux面向通用计算，功能更全面但资源占用高。</p></li><li><p>Linux内核架构分为哪几层? 简述各层的功能。<br />分为四级架构：</p><ul><li>硬件子系统: 管理中断、存储设备驱动(UART/SD)</li><li>核心中介层: 虚拟内存管理、内核态调度器。</li><li>应用支持层: 提供系统调用接口和程序库。</li><li>任务管理层: 处理进程调度和资源分配。</li></ul></li><li><p>设备树在嵌入式Linux中的作用是什么？<br />设备树以结构化的数据描述硬件的配置(如外设地址、中断号)，实现硬件和驱动解耦，避免内核重新编译即可适配不同硬件。</p></li><li><p>解释交叉编译的概念及其必要性。<br />交叉编译器指在开发主机(x86)上生成目标平台(如ARM)的可执行文件。<br />必要性:</p><ol><li>嵌入式设备资源有限，无法本地编译。</li><li>开发机性能强，提升编译效率。</li></ol></li><li><p>嵌入式Linux驱动开发的基本步骤有哪些？</p><ol><li>定义设备与驱动的接口(如字符设备)</li><li>编写驱动代码并编译成内核模块</li><li>修改设备树添加节点绑定驱动</li><li>加载模块并测试硬件功能</li></ol></li><li><p>设备树 (Device Tree) 中如何定义一个 GPIO 按键中断？写出对应的DTS代码片段。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&amp;gpio0 &#123;    <span class="comment">// 引用GPIO控制器节点 (例如某个芯片的GPIO0模块) (不可更改，厂商定义)</span></span><br><span class="line">    button &#123;    <span class="comment">// 定义一个字节点，表示按键设备 (节点名称，可自定义命名)</span></span><br><span class="line">        compatible = <span class="string">&quot;gpio-keys&quot;</span>;   <span class="comment">// 告诉内核，此设备使用 gpio-keys 驱动 (不可更改)</span></span><br><span class="line">        button1 &#123;   <span class="comment">// 定义第一个按键的具体参数 (字节点名称，可更改)</span></span><br><span class="line">            label = <span class="string">&quot;USER_BUTTON&quot;</span>;  <span class="comment">// 按键的标签，方便调试 (value 可更改，自定义)</span></span><br><span class="line">            gpios = &lt;&amp;gpio0 <span class="number">14</span> GPIO_ACTIVE_LOW&gt;;    <span class="comment">// 使用GPIO0的14号引脚，低电平有效 (不能改)</span></span><br><span class="line">            linux, code = &lt;KEY_ENTER&gt;;  <span class="comment">// 按下时生成&quot;回车键事件&quot; (key不能改，value可在内核的事件定义中查找更改)</span></span><br><span class="line">            interrupts-extended = &lt;&amp;gpio0 <span class="number">14</span> IRQ_TYPE_EDGE_FALLING&gt;;    <span class="comment">// 中断触发方式，下降沿触发 (key 不能改，value须适配)</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol>]]></content>
      
      
      <categories>
          
          <category> 嵌入式 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C++ </tag>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>搭建Nginx-FLV流媒体服务器</title>
      <link href="/2025/05/21/%E6%90%AD%E5%BB%BANginx-FLV%E6%B5%81%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1%E5%99%A8/"/>
      <url>/2025/05/21/%E6%90%AD%E5%BB%BANginx-FLV%E6%B5%81%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1%E5%99%A8/</url>
      
        <content type="html"><![CDATA[<h2 id="搭建nginx-flv"><a class="markdownIt-Anchor" href="#搭建nginx-flv"></a> 搭建nginx-FLV</h2><blockquote><p>查看更多信息请前往 <a href="https://github.com/zikcc/nginx-streaming-demos">github: nginx-streaming-demos</a></p></blockquote><h3 id="准备工作"><a class="markdownIt-Anchor" href="#准备工作"></a> 准备工作</h3><p>请查看 <a href="/2025/05/21/%E6%90%AD%E5%BB%BANginx-RTMP%E6%B5%81%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1%E5%99%A8/#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C" title="搭建Nginx-RTMP流媒体服务器">搭建Nginx-RTMP流媒体服务器的准备工作</a></p><h3 id="构建镜像"><a class="markdownIt-Anchor" href="#构建镜像"></a> 构建镜像</h3><p>由于之前是拉取的 nginx-rtmp 的镜像，不支持flv。所以需要重新构建一个支持flv的nginx镜像。</p><p>nginx-http-flv-module 支持flv且具备 nginx-rtmp-module的功能。</p><p>依然采用挂载的方式，在虚拟机本地创建目录</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p \</span><br><span class="line">  ~/Desktop/docker/projects/nginx-flv/&#123;config,data/hls,data/recordings,dist,logs,certs&#125;</span><br><span class="line">  </span><br></pre></td></tr></table></figure><p>开启HTTPS 服务生成，自签名证书</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">openssl req -x509 -nodes -days 365 -newkey rsa:2048 \</span><br><span class="line">  -keyout certs/key.pem \</span><br><span class="line">  -out certs/cert.pem \</span><br><span class="line">  -subj <span class="string">&quot;/CN=localhost&quot;</span> \</span><br><span class="line">  -addext <span class="string">&quot;subjectAltName=DNS:localhost,IP:192.168.217.130&quot;</span></span><br></pre></td></tr></table></figure><p>编写Dockerfile</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用多阶段构建减小镜像体积</span></span><br><span class="line"><span class="keyword">FROM</span> alpine:<span class="number">3.18</span> AS builder</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装编译依赖</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apk add --no-cache \</span></span><br><span class="line"><span class="language-bash">    build-base \</span></span><br><span class="line"><span class="language-bash">    pcre-dev \</span></span><br><span class="line"><span class="language-bash">    openssl-dev \</span></span><br><span class="line"><span class="language-bash">    zlib-dev \</span></span><br><span class="line"><span class="language-bash">    git</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载 Nginx 和模块源码</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> git <span class="built_in">clone</span> https://github.com/winshining/nginx-http-flv-module.git &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    wget http://nginx.org/download/nginx-1.25.3.tar.gz &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    tar -zxvf nginx-1.25.3.tar.gz</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译 Nginx (包含 RTMP 和 FLV 模块)</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /nginx-1.25.3</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> ./configure \</span></span><br><span class="line"><span class="language-bash">    --prefix=/usr/local/nginx \</span></span><br><span class="line"><span class="language-bash">    --with-http_ssl_module \</span></span><br><span class="line"><span class="language-bash">    --with-http_stub_status_module \</span></span><br><span class="line"><span class="language-bash">    --with-http_realip_module \</span></span><br><span class="line"><span class="language-bash">    --with-http_auth_request_module \</span></span><br><span class="line"><span class="language-bash">    --with-http_v2_module \</span></span><br><span class="line"><span class="language-bash">    --with-http_dav_module \</span></span><br><span class="line"><span class="language-bash">    --with-http_slice_module \</span></span><br><span class="line"><span class="language-bash">    --with-threads \</span></span><br><span class="line"><span class="language-bash">    --with-http_addition_module \</span></span><br><span class="line"><span class="language-bash">    --with-http_gunzip_module \</span></span><br><span class="line"><span class="language-bash">    --with-http_gzip_static_module\</span></span><br><span class="line"><span class="language-bash">    --add-module=../nginx-http-flv-module &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    make -j$(<span class="built_in">nproc</span>) &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    make install</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建最终镜像</span></span><br><span class="line"><span class="keyword">FROM</span> alpine:<span class="number">3.18</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /usr/local/nginx /usr/local/nginx</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装运行时依赖</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apk add --no-cache pcre openssl zlib &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">mkdir</span> -p /tmp/hls /var/log/nginx &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">chmod</span> 755 /tmp/hls &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">rm</span> -rf /var/cache/apk/*</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># 设置环境变量</span></span><br><span class="line"><span class="keyword">ENV</span> PATH=<span class="string">&quot;/usr/local/nginx/sbin:$&#123;PATH&#125;&quot;</span> \</span><br><span class="line">    NGINX_LOG_DIR=<span class="string">&quot;/var/log/nginx&quot;</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># 暴露端口</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">1935</span> <span class="number">80</span> <span class="number">443</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动命令</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;/usr/local/nginx/sbin/nginx&quot;</span>, <span class="string">&quot;-g&quot;</span>, <span class="string">&quot;daemon off;&quot;</span>]</span></span><br></pre></td></tr></table></figure><p>构建镜像</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t nginx-flv .</span><br></pre></td></tr></table></figure><h3 id="配置"><a class="markdownIt-Anchor" href="#配置"></a> 配置</h3><p>编写nginx.conf</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line">worker_processes auto;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections 1024;</span><br><span class="line">    use epoll;</span><br><span class="line">&#125;</span><br><span class="line">http &#123;</span><br><span class="line">    include mime.types;</span><br><span class="line">    default_type application/octet-stream;</span><br><span class="line">    </span><br><span class="line">    sendfile on;</span><br><span class="line">    tcp_nopush on;</span><br><span class="line">    tcp_nodelay on;</span><br><span class="line">    keepalive_timeout 65;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">     listen 443 ssl;  <span class="comment"># 启用 HTTPS</span></span><br><span class="line">        ssl_certificate      /etc/nginx/certs/cert.pem;</span><br><span class="line">        ssl_certificate_key  /etc/nginx/certs/key.pem;</span><br><span class="line">        root /usr/share/nginx/html;</span><br><span class="line">        index index.html;</span><br><span class="line">        </span><br><span class="line">        location / &#123;</span><br><span class="line">            root /usr/share/nginx/html;</span><br><span class="line">            try_files <span class="variable">$uri</span> <span class="variable">$uri</span>/ /index.html;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment"># HLS 端点</span></span><br><span class="line">        location /hls &#123;</span><br><span class="line">            <span class="built_in">alias</span> /tmp/hls;</span><br><span class="line">    types &#123;</span><br><span class="line">application/vnd.apple.mpegurl m3u8;</span><br><span class="line">video/mp2t ts;</span><br><span class="line">    &#125;</span><br><span class="line">    add_header Cache-Control no-cache;</span><br><span class="line">    add_header Access-Control-Allow-Origin *;</span><br><span class="line">    add_header Access-Control-Allow-Methods GET,OPTIONS;</span><br><span class="line">    add_header Access-Control-Allow-Headers *;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment"># HTTP-FLV 播放端点</span></span><br><span class="line">        location /live &#123;</span><br><span class="line">            flv_live on;</span><br><span class="line">    add_header Access-Control-Allow-Origin *;</span><br><span class="line">    add_header Access-Control-Allow-Methods GET,OPTIONS;</span><br><span class="line">    add_header Access-Control-Allow-Headers *;</span><br><span class="line">    add_header Access-Control-Allow-Credentials <span class="literal">true</span>;</span><br><span class="line">    chunked_transfer_encoding on;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 状态监控端点</span></span><br><span class="line">        location /stat &#123;</span><br><span class="line">            rtmp_stat all;</span><br><span class="line">            rtmp_stat_stylesheet stat.xsl;</span><br><span class="line">        &#125;</span><br><span class="line">        location /stat.xsl &#123;</span><br><span class="line">            root /usr/local/nginx/conf;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        server_name localhost;</span><br><span class="line">        <span class="built_in">return</span> 301 https://$host<span class="variable">$request_uri</span>;  <span class="comment"># HTTP 强制跳转 HTTPS</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">rtmp_auto_push on;</span><br><span class="line">rtmp_auto_push_reconnect 1s;</span><br><span class="line">rtmp &#123;</span><br><span class="line">    out_queue           4096;</span><br><span class="line">    out_cork            8;</span><br><span class="line">    max_streams         128;</span><br><span class="line">    <span class="built_in">timeout</span>             15s;</span><br><span class="line">    drop_idle_publisher 15s;</span><br><span class="line"></span><br><span class="line">    log_interval 5s; <span class="comment">#log模块在access.log中记录日志的间隔时间，对调试非常有用</span></span><br><span class="line">    log_size     1m; <span class="comment">#log模块用来记录日志的缓冲区大小</span></span><br><span class="line">    server &#123;</span><br><span class="line">        listen 1935;</span><br><span class="line">        chunk_size 4096;</span><br><span class="line">        ping 30s;</span><br><span class="line">        notify_method get;</span><br><span class="line"></span><br><span class="line">        application live &#123;</span><br><span class="line">            live on;</span><br><span class="line">            meta off;</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># HLS 配置</span></span><br><span class="line">            hls on;</span><br><span class="line">            hls_path /tmp/hls;</span><br><span class="line">            hls_fragment 2s;       <span class="comment"># 切片时长至少1秒，建议2秒</span></span><br><span class="line">            hls_playlist_length 6s; <span class="comment"># 播放列表保留3个切片</span></span><br><span class="line">            hls_sync 100ms;</span><br><span class="line">            hls_base_url /hls/;</span><br><span class="line">            hls_cleanup on;       <span class="comment"># 自动清理旧切片</span></span><br><span class="line">            hls_continuous on;    <span class="comment"># 连续模式（避免播放中断）</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>编写 index.html</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;zh-CN&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>直播监控<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">&quot;/css/video-js.min.css&quot;</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="comment">/* 容器样式 */</span></span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.player-container</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">display</span>: flex;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">gap</span>: <span class="number">20px</span>; <span class="comment">/* 播放器间距 */</span></span></span><br><span class="line"><span class="language-css">            <span class="attribute">padding</span>: <span class="number">20px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">max-width</span>: <span class="number">1600px</span>; <span class="comment">/* 最大宽度限制 */</span></span></span><br><span class="line"><span class="language-css">            <span class="attribute">margin</span>: <span class="number">0</span> auto; <span class="comment">/* 居中 */</span></span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="comment">/* 单个播放器包装 */</span></span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.player-wrapper</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">flex</span>: <span class="number">1</span>; <span class="comment">/* 等分剩余空间 */</span></span></span><br><span class="line"><span class="language-css">            <span class="attribute">min-width</span>: <span class="number">300px</span>; <span class="comment">/* 最小宽度防止挤压 */</span></span></span><br><span class="line"><span class="language-css">            <span class="attribute">background</span>: <span class="number">#f5f5f5</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border-radius</span>: <span class="number">8px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">padding</span>: <span class="number">15px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">4px</span> <span class="number">6px</span> <span class="built_in">rgba</span>(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0.1</span>);</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="comment">/* 视频元素自适应 */</span></span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.video-js</span>, <span class="selector-id">#videoElement</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">width</span>: <span class="number">100%</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">height</span>: auto;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border-radius</span>: <span class="number">4px</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="comment">/* 标题样式 */</span></span></span><br><span class="line"><span class="language-css">        <span class="selector-tag">h3</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">margin</span>: <span class="number">0</span> <span class="number">0</span> <span class="number">10px</span> <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">color</span>: <span class="number">#333</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">font-size</span>: <span class="number">1.2em</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">text-align</span>: center;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="comment">/* 移动端适配 */</span></span></span><br><span class="line"><span class="language-css">        <span class="keyword">@media</span> (<span class="attribute">max-width</span>: <span class="number">768px</span>) &#123;</span></span><br><span class="line"><span class="language-css">            <span class="selector-class">.player-container</span> &#123;</span></span><br><span class="line"><span class="language-css">                <span class="attribute">flex-direction</span>: column; <span class="comment">/* 小屏幕垂直排列 */</span></span></span><br><span class="line"><span class="language-css">            &#125;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 播放器容器 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;player-container&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- HLS 播放器 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;player-wrapper&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">h3</span>&gt;</span>HLS 直播流<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">video</span> <span class="attr">id</span>=<span class="string">&quot;hlsPlayer&quot;</span> <span class="attr">class</span>=<span class="string">&quot;video-js vjs-default-skin&quot;</span> <span class="attr">controls</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">source</span> <span class="attr">src</span>=<span class="string">&quot;/hls/stream.m3u8&quot;</span> <span class="attr">type</span>=<span class="string">&quot;application/vnd.apple.mpegurl&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">video</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- FLV 播放器 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;player-wrapper&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">h3</span>&gt;</span>FLV 低延迟流<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">video</span> <span class="attr">id</span>=<span class="string">&quot;videoElement&quot;</span> <span class="attr">controls</span>&gt;</span><span class="tag">&lt;/<span class="name">video</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 依赖库 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/js/video.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/js/flv.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// HLS播放器初始化</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> hlsPlayer = <span class="title function_">videojs</span>(<span class="string">&#x27;hlsPlayer&#x27;</span>, &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">autoplay</span>: <span class="literal">true</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">fluid</span>: <span class="literal">true</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">techOrder</span>: [<span class="string">&#x27;html5&#x27;</span>]  <span class="comment">// 强制使用HTML5模式</span></span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// flv播放器初始化</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> videoElement = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;videoElement&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> flvPlayer = flvjs.<span class="title function_">createPlayer</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">type</span>: <span class="string">&#x27;flv&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">url</span>: <span class="string">&#x27;/live?app=live&amp;stream=stream&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">isLive</span>: <span class="literal">true</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">hasAudio</span>: <span class="literal">false</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">stashInitialSize</span>: <span class="number">128</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">withCredentials</span>: <span class="literal">true</span>  <span class="comment">// 允许跨域带凭证</span></span></span><br><span class="line"><span class="language-javascript">&#125;);</span></span><br><span class="line"><span class="language-javascript">        flvPlayer.<span class="title function_">attachMediaElement</span>(videoElement);</span></span><br><span class="line"><span class="language-javascript">        flvPlayer.<span class="title function_">load</span>();</span></span><br><span class="line"><span class="language-javascript">        flvPlayer.<span class="title function_">play</span>();</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>使用docker compose构建容器</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">nginx-flv:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx-flv:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">nginx-flv</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;1935:1935&quot;</span>  <span class="comment"># RTMP协议端口</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;80:80&quot;</span>      <span class="comment"># HTTP协议端口</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;443:443&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./config/nginx.conf:/usr/local/nginx/conf/nginx.conf</span>  <span class="comment"># 修正配置文件路径</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data/hls:/tmp/hls</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data/recordings:/tmp/recordings</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./logs:/var/log/nginx</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./dist:/usr/share/nginx/html</span>  <span class="comment"># 静态文件目录</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./certs:/etc/nginx/certs</span>  <span class="comment"># 挂载证书目录</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br></pre></td></tr></table></figure><p>使用ffmpeg进行推流</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 推流参数配置</span></span><br><span class="line">INPUT_DEVICE=<span class="string">&quot;/dev/video0&quot;</span>                              <span class="comment"># 摄像头设备</span></span><br><span class="line">RTMP_URL=<span class="string">&quot;rtmp://192.168.217.130/live/stream&quot;</span>       <span class="comment"># 流名称需匹配前端播放器</span></span><br><span class="line">RESOLUTION=<span class="string">&quot;640x480&quot;</span>                                   <span class="comment"># 建议分辨率</span></span><br><span class="line">FPS=15                                                  <span class="comment"># 帧率</span></span><br><span class="line">BITRATE=<span class="string">&quot;2000k&quot;</span>                                         <span class="comment"># 码率</span></span><br><span class="line"></span><br><span class="line">ffmpeg \</span><br><span class="line">  -f v4l2 \</span><br><span class="line">  -input_format yuyv422 \</span><br><span class="line">  -video_size <span class="variable">$RESOLUTION</span> \</span><br><span class="line">  -framerate <span class="variable">$FPS</span> \</span><br><span class="line">  -i <span class="string">&quot;<span class="variable">$INPUT_DEVICE</span>&quot;</span> \</span><br><span class="line">  -vf <span class="string">&quot;format=yuv420p&quot;</span> \</span><br><span class="line">  -c:v libx264 \</span><br><span class="line">  -profile:v main \</span><br><span class="line">  -preset ultrafast \</span><br><span class="line">  -tune zerolatency \</span><br><span class="line">  -x264-params <span class="string">&quot;keyint=60:min-keyint=30:no-scenecut=1&quot;</span> \</span><br><span class="line">  -b:v <span class="variable">$BITRATE</span> \</span><br><span class="line">  -maxrate <span class="variable">$BITRATE</span> \</span><br><span class="line">  -minrate <span class="variable">$BITRATE</span> \</span><br><span class="line">  -f flv \</span><br><span class="line">  <span class="string">&quot;<span class="variable">$RTMP_URL</span>&quot;</span></span><br></pre></td></tr></table></figure><h3 id="运行容器"><a class="markdownIt-Anchor" href="#运行容器"></a> 运行容器</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker compose up -d</span><br><span class="line"></span><br><span class="line"><span class="comment">#删除并运行（更新文件后）</span></span><br><span class="line">docker compose down -v &amp;&amp; docker compose up -d</span><br></pre></td></tr></table></figure><h3 id="效果"><a class="markdownIt-Anchor" href="#效果"></a> 效果</h3><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/202505172013321.png" alt="image-20250517201341792" /></p><h2 id="有哪些坑"><a class="markdownIt-Anchor" href="#有哪些坑"></a> 有哪些坑？</h2><blockquote><p><code>访问页面只显示nginx的官方页面，自己的index.html未生效，但是已经挂载了(可以进入容器内查看)</code> —&gt; 文件或文件夹权限问题。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入容器检查挂载目录</span></span><br><span class="line">docker <span class="built_in">exec</span> -it nginx-flv <span class="built_in">ls</span> -l /usr/share/nginx/html</span><br><span class="line"></span><br><span class="line"><span class="comment"># 预期输出</span></span><br><span class="line">total 12</span><br><span class="line">-rw-r--r-- 1 root root  537 index.html</span><br><span class="line">drwxr-xr-x 2 root root 4096 css</span><br><span class="line">drwxr-xr-x 2 root root 4096 js</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修补措施</span></span><br><span class="line"><span class="comment"># 在宿主机执行（假设挂载目录为 ./html）</span></span><br><span class="line"><span class="built_in">chmod</span> -R 755 ./html      <span class="comment"># 目录权限</span></span><br><span class="line">find ./html -<span class="built_in">type</span> f -<span class="built_in">exec</span> <span class="built_in">chmod</span> 644 &#123;&#125; \;  <span class="comment"># 文件权限</span></span><br></pre></td></tr></table></figure></blockquote><blockquote><p><code>如果docker ps 后发现没有端口信息，应该是出错了。使用 docker logs 容器id 查看错误信息</code></p><p>例如</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/202505171614609.png" alt="image-20250517161421511" /></p></blockquote><blockquote><p>index.html文件中的视频地址如果采用ip+路径的形式，会存在跨域问题，为了简单，直接使用了相对地址</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 流媒体 </category>
          
          <category> 部署 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Docker </tag>
            
            <tag> Nginx </tag>
            
            <tag> RTMP </tag>
            
            <tag> HLS </tag>
            
            <tag> FFmpeg </tag>
            
            <tag> HTTP-FLV </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>搭建Nginx-RTMP流媒体服务器</title>
      <link href="/2025/05/21/%E6%90%AD%E5%BB%BANginx-RTMP%E6%B5%81%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1%E5%99%A8/"/>
      <url>/2025/05/21/%E6%90%AD%E5%BB%BANginx-RTMP%E6%B5%81%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1%E5%99%A8/</url>
      
        <content type="html"><![CDATA[<h2 id="搭建nginx-rtmp"><a class="markdownIt-Anchor" href="#搭建nginx-rtmp"></a> 搭建Nginx-RTMP</h2><blockquote><p>该服务器仅支持HLS, 不支持HTTP-FLV, 如果要使用HTTP-FLV协议请前往 <a href="/2025/05/21/%E6%90%AD%E5%BB%BANginx-FLV%E6%B5%81%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1%E5%99%A8/" title="搭建Nginx-FLV流媒体服务器">搭建Nginx-FLV流媒体服务器</a><br />查看更多信息请前往 <a href="https://github.com/zikcc/nginx-streaming-demos">github: nginx-streaming-demos</a></p></blockquote><h3 id="准备工作"><a class="markdownIt-Anchor" href="#准备工作"></a> 准备工作</h3><ol><li><p>安装docker</p> <a href="/2025/05/21/ubuntu22-04%E5%AE%89%E8%A3%85docker/" title="ubuntu22.04安装docker">安装教程</a></li><li><p>安装ffmpeg:</p> <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt update</span><br><span class="line"><span class="built_in">sudo</span> apt install ffmpeg</span><br><span class="line"><span class="comment"># 查看版本</span></span><br><span class="line">ffmpeg -version</span><br></pre></td></tr></table></figure></li><li><p>采用文件挂载的方式修改docker容器(可选):<br />为了综合管理以后的多个docker容器，在本地ubuntu中创建以下文件结构，以后将这些目录挂载到docker容器上。</p> <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p \</span><br><span class="line">~/Desktop/docker/projects/nginx-rtmp/&#123;config,data/hls,data/recordings,dist,logs&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/home/lzk/Desktop/docker/</span><br><span class="line">├── projects/                    <span class="comment"># 所有Docker项目</span></span><br><span class="line">├── nginx-rtmp/               <span class="comment"># 流媒体服务</span></span><br><span class="line">        ├── config/            <span class="comment"># Nginx配置</span></span><br><span class="line">        │   └── nginx.conf</span><br><span class="line">        ├── data/              <span class="comment"># 持久化数据</span></span><br><span class="line">        │   ├── hls/           <span class="comment"># HLS切片</span></span><br><span class="line">        │   └── recordings/    <span class="comment"># 录像文件</span></span><br><span class="line">        ├── logs/              <span class="comment"># 日志文件</span></span><br><span class="line">        ├── dist/              <span class="comment"># 前端编译后的静态文件</span></span><br><span class="line">        └── docker-compose.yml         <span class="comment"># 主编排文件</span></span><br></pre></td></tr></table></figure></li></ol><h3 id="拉取镜像"><a class="markdownIt-Anchor" href="#拉取镜像"></a> 拉取镜像</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker pull tiangolo/nginx-rtmp:latest</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看</span></span><br><span class="line">docker images</span><br></pre></td></tr></table></figure><p>使用Docker命令运行Nginx-RTMP容器，并映射好必要的端口（如RTMP协议的1935端口和HTTP协议的80端口）。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 1935:1935 -p 80:80 --name nginx-rtmp tiangolo/nginx-rtmp:latest</span><br></pre></td></tr></table></figure><p>直接在容器中修改配置文件，可能会由于容器重启或删除而失效。故采用-v挂载的方式。</p><p>复制配置文件</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">cp</span> nginx-rtmp:/etc/nginx/nginx.conf ~/Desktop/docker/projects/nginx-rtmp/config/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除这个容器，后面再启动</span></span><br><span class="line">docker <span class="built_in">rm</span> -f nginx-rtmp</span><br></pre></td></tr></table></figure><h3 id="修改nignxconf配置文件"><a class="markdownIt-Anchor" href="#修改nignxconf配置文件"></a> 修改nignx.conf配置文件</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">worker_processes auto;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections 1024;</span><br><span class="line">    use epoll;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">rtmp &#123;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen 1935;</span><br><span class="line">        chunk_size 8192;</span><br><span class="line">        max_streams 64;</span><br><span class="line">        ack_window 5000000;  <span class="comment"># 合理ACK窗口大小</span></span><br><span class="line">        </span><br><span class="line">        application live &#123;</span><br><span class="line">            live on;</span><br><span class="line">            meta off;         <span class="comment"># 禁用元数据缓存</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># HLS低延迟优化</span></span><br><span class="line">            hls on;</span><br><span class="line">            hls_path /tmp/hls;</span><br><span class="line">            hls_fragment 1s;     <span class="comment"># 切片时长1s</span></span><br><span class="line">            hls_playlist_length 3s; <span class="comment"># 播放列表保留3秒切片</span></span><br><span class="line">            hls_sync 100ms;         <span class="comment"># 音视频同步阈值</span></span><br><span class="line">            hls_base_url /hls/;  <span class="comment"># HLS访问路径</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 关键帧间隔优化</span></span><br><span class="line">            wait_key off;    <span class="comment"># 不等待关键帧</span></span><br><span class="line">            idle_streams off;</span><br><span class="line">          </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include mime.types;</span><br><span class="line">    default_type application/octet-stream;</span><br><span class="line">    </span><br><span class="line">    sendfile on;</span><br><span class="line">    tcp_nopush on;</span><br><span class="line">    tcp_nodelay on;</span><br><span class="line">    keepalive_timeout 65;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        server_name localhost;</span><br><span class="line"></span><br><span class="line">root /usr/share/nginx/html;  <span class="comment"># 必须与挂载路径一致</span></span><br><span class="line">        index index.html;</span><br><span class="line">        </span><br><span class="line">        location / &#123;</span><br><span class="line">            try_files <span class="variable">$uri</span> <span class="variable">$uri</span>/ /index.html;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># HLS端点（极低延迟配置）</span></span><br><span class="line">        location /hls &#123;</span><br><span class="line">            <span class="built_in">alias</span> /tmp/hls;</span><br><span class="line">            types &#123;</span><br><span class="line">                application/vnd.apple.mpegurl m3u8;</span><br><span class="line">                video/mp2t ts;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 状态监控端点</span></span><br><span class="line">        location /stat &#123;</span><br><span class="line">            rtmp_stat all;</span><br><span class="line">            rtmp_stat_stylesheet stat.xsl;</span><br><span class="line">        &#125;</span><br><span class="line">        location /stat.xsl &#123;</span><br><span class="line">            root /usr/local/nginx/conf;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="indexhtml"><a class="markdownIt-Anchor" href="#indexhtml"></a> index.html</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;zh-CN&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>直播监控<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">&quot;/css/video-js.min.css&quot;</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- HLS播放器 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;margin:20px;&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h3</span>&gt;</span>HLS直播流<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">video</span> <span class="attr">id</span>=<span class="string">&quot;hlsPlayer&quot;</span> <span class="attr">class</span>=<span class="string">&quot;video-js vjs-default-skin&quot;</span> <span class="attr">controls</span> <span class="attr">width</span>=<span class="string">&quot;1024&quot;</span> <span class="attr">height</span>=<span class="string">&quot;576&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">source</span> <span class="attr">src</span>=<span class="string">&quot;/hls/stream.m3u8&quot;</span> <span class="attr">type</span>=<span class="string">&quot;application/vnd.apple.mpegurl&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">video</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 依赖库 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/js/video.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// HLS播放器初始化</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> hlsPlayer = <span class="title function_">videojs</span>(<span class="string">&#x27;hlsPlayer&#x27;</span>, &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">autoplay</span>: <span class="literal">true</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">fluid</span>: <span class="literal">true</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">techOrder</span>: [<span class="string">&#x27;html5&#x27;</span>]  <span class="comment">// 强制使用HTML5模式</span></span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="编写-docker-composeyml"><a class="markdownIt-Anchor" href="#编写-docker-composeyml"></a> 编写 docker-compose.yml</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">nginx-rtmp:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">tiangolo/nginx-rtmp:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">nginx-rtmp</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;1935:1935&quot;</span>  <span class="comment"># RTMP协议端口</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;80:80&quot;</span>      <span class="comment"># HTTP协议端口</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./config/nginx.conf:/etc/nginx/nginx.conf</span>     <span class="comment"># 配置文件</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data/hls:/tmp/hls</span>                          <span class="comment"># HLS切片存储</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data/recordings:/tmp/recordings</span>            <span class="comment"># 录像文件存储</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./logs:/var/log/nginx</span>                        <span class="comment"># 日志文件</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./dist:/usr/share/nginx/html</span>                 <span class="comment"># 前端编译文件</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span>                             <span class="comment"># 时区设置</span></span><br></pre></td></tr></table></figure><h3 id="启动服务"><a class="markdownIt-Anchor" href="#启动服务"></a> 启动服务</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装docker-compose</span></span><br><span class="line"><span class="built_in">sudo</span> apt  install docker-compose</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入项目目录</span></span><br><span class="line"><span class="built_in">cd</span> ~/Desktop/docker/projects/nginx-rtmp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动容器（后台模式）</span></span><br><span class="line">docker compose up -d</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看运行状态</span></span><br><span class="line">docker-compose ps</span><br><span class="line"><span class="comment"># 应显示状态为 Up</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果修改了本地文件则需要重新启动</span></span><br><span class="line">docker compose down -v &amp;&amp; docker compose up -d</span><br></pre></td></tr></table></figure><h3 id="验证挂载结果"><a class="markdownIt-Anchor" href="#验证挂载结果"></a> 验证挂载结果</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检查配置文件同步</span></span><br><span class="line">docker <span class="built_in">exec</span> nginx-rtmp <span class="built_in">ls</span> -l /etc/nginx/</span><br><span class="line"><span class="comment"># 应看到nginx.conf的修改时间为当前时间</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看HLS目录权限</span></span><br><span class="line">docker <span class="built_in">exec</span> nginx-rtmp <span class="built_in">ls</span> -ld /tmp/hls</span><br><span class="line"><span class="comment"># 应显示权限为 drwxr-xr-x</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证dist文件挂载</span></span><br><span class="line">docker <span class="built_in">exec</span> nginx-rtmp <span class="built_in">ls</span> /usr/share/nginx/html</span><br></pre></td></tr></table></figure><p>ubuntu主机开放端口</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> ufw allow 80/tcp</span><br><span class="line"><span class="built_in">sudo</span> ufw allow 1935/tcp</span><br><span class="line"><span class="built_in">sudo</span> ufw reload</span><br></pre></td></tr></table></figure><h3 id="推流测试"><a class="markdownIt-Anchor" href="#推流测试"></a> 推流测试</h3><p>命令行形式：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 延迟 45 秒</span></span><br><span class="line">ffmpeg -f v4l2 -input_format yuyv422 -i /dev/video0 \</span><br><span class="line">  -c:v libx264 -preset ultrafast -tune zerolatency \</span><br><span class="line">  -f flv rtmp://192.168.217.130/live/stream</span><br></pre></td></tr></table></figure><p>使用脚本，创建 push_stream.sh</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">INPUT_DEVICE=<span class="string">&quot;/dev/video0&quot;</span></span><br><span class="line">RTMP_URL=<span class="string">&quot;rtmp://192.168.217.130/live/stream&quot;</span></span><br><span class="line">  </span><br><span class="line">ffmpeg \</span><br><span class="line">  -f v4l2 \</span><br><span class="line">  -input_format yuyv422 \</span><br><span class="line">  -video_size 640x480 \</span><br><span class="line">  -framerate 30 \</span><br><span class="line">  -i <span class="string">&quot;<span class="variable">$INPUT_DEVICE</span>&quot;</span> \</span><br><span class="line">  -vf <span class="string">&quot;format=yuv420p&quot;</span> \</span><br><span class="line">  -c:v libx264 \</span><br><span class="line">  -profile:v baseline \</span><br><span class="line">  -level 3.1 \</span><br><span class="line">  -preset ultrafast \</span><br><span class="line">  -tune zerolatency \</span><br><span class="line">  -x264-params <span class="string">&quot;keyint=30:min-keyint=30:no-scenecut=1&quot;</span> \</span><br><span class="line">  -b:v 1M \</span><br><span class="line">  -maxrate 1M \</span><br><span class="line">  -minrate 1M \</span><br><span class="line">  -f flv \</span><br><span class="line">  <span class="string">&quot;<span class="variable">$RTMP_URL</span>&quot;</span></span><br></pre></td></tr></table></figure><p>进入浏览器查看</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:80</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 流媒体 </category>
          
          <category> 部署 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Docker </tag>
            
            <tag> Nginx </tag>
            
            <tag> RTMP </tag>
            
            <tag> HLS </tag>
            
            <tag> FFmpeg </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ubuntu22.04安装docker</title>
      <link href="/2025/05/21/ubuntu22-04%E5%AE%89%E8%A3%85docker/"/>
      <url>/2025/05/21/ubuntu22-04%E5%AE%89%E8%A3%85docker/</url>
      
        <content type="html"><![CDATA[<h2 id="安装docker"><a class="markdownIt-Anchor" href="#安装docker"></a> 安装docker</h2><p>虚拟机 ubuntu 22.04 安装 docker</p><h3 id="准备工作"><a class="markdownIt-Anchor" href="#准备工作"></a> 准备工作</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#安装前先卸载操作系统默认安装的docker，</span></span><br><span class="line"><span class="built_in">sudo</span> apt-get remove docker docker-engine docker.io containerd runc</span><br><span class="line"></span><br><span class="line"><span class="comment">#安装必要支持</span></span><br><span class="line"><span class="built_in">sudo</span> apt install apt-transport-https ca-certificates curl software-properties-common gnupg lsb-release</span><br></pre></td></tr></table></figure><h3 id="添加源"><a class="markdownIt-Anchor" href="#添加源"></a> 添加源</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#添加 Docker 官方 GPG key （可能国内现在访问会存在问题）</span></span><br><span class="line">curl -fsSL https://download.docker.com/linux/ubuntu/gpg | <span class="built_in">sudo</span> gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg</span><br><span class="line"></span><br><span class="line"><span class="comment"># 阿里源（推荐使用阿里的gpg KEY）</span></span><br><span class="line">curl -fsSL https://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | <span class="built_in">sudo</span> gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg</span><br><span class="line"></span><br><span class="line"><span class="comment">#添加 apt 源:</span></span><br><span class="line"><span class="comment">#Docker官方源</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;deb [arch=<span class="subst">$(dpkg --print-architecture)</span> signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu <span class="subst">$(lsb_release -cs)</span> stable&quot;</span> | <span class="built_in">sudo</span> <span class="built_in">tee</span> /etc/apt/sources.list.d/docker.list &gt; /dev/null</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#阿里apt源</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;deb [arch=<span class="subst">$(dpkg --print-architecture)</span> signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://mirrors.aliyun.com/docker-ce/linux/ubuntu <span class="subst">$(lsb_release -cs)</span> stable&quot;</span> | <span class="built_in">sudo</span> <span class="built_in">tee</span> /etc/apt/sources.list.d/docker.list &gt; /dev/null</span><br><span class="line"></span><br><span class="line"><span class="comment">#更新源</span></span><br><span class="line"><span class="built_in">sudo</span> apt update</span><br><span class="line"><span class="built_in">sudo</span> apt-get update</span><br></pre></td></tr></table></figure><h3 id="安装最新版docker"><a class="markdownIt-Anchor" href="#安装最新版docker"></a> 安装最新版docker</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#安装最新版本的Docker</span></span><br><span class="line"><span class="built_in">sudo</span> apt install docker-ce docker-ce-cli containerd.io</span><br><span class="line"><span class="comment">#等待安装完成</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看Docker版本</span></span><br><span class="line"><span class="built_in">sudo</span> docker version</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看Docker运行状态</span></span><br><span class="line"><span class="built_in">sudo</span> systemctl status docker</span><br></pre></td></tr></table></figure><h3 id="不想-sudo-docker"><a class="markdownIt-Anchor" href="#不想-sudo-docker"></a> 不想 sudo docker …?</h3><p>此时使用 docker ps 会提示权限不够，需要 sudo docker ps</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#添加docker用户组</span></span><br><span class="line"><span class="built_in">sudo</span> groupadd docker</span><br><span class="line"></span><br><span class="line"><span class="comment">#将当前用户添加到用户组</span></span><br><span class="line"><span class="built_in">sudo</span> usermod -aG docker <span class="variable">$USER</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#使权限生效</span></span><br><span class="line">newgrp docker</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看所有容器</span></span><br><span class="line">docker ps -a</span><br></pre></td></tr></table></figure><p>如果没有此行命令，你会发现，当你每次打开新的终端<br />你都必须先执行一次 “newgrp docker” 命令<br />否则当前用户还是不可以执行docker命令</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">gedit ~/.bashrc</span><br><span class="line"><span class="comment"># 在文件最下方加入</span></span><br><span class="line"><span class="keyword">if</span> ! <span class="built_in">groups</span> | grep -q docker; <span class="keyword">then</span></span><br><span class="line">    newgrp docker</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure><h3 id="配置仓库镜像"><a class="markdownIt-Anchor" href="#配置仓库镜像"></a> 配置仓库镜像</h3><p>另外，我们需要在docker daemon 配置文件中增加国的可用的 docker hub mirror ，<br />找到你的daemon.json 文件，通常在 /etc/docker/daemon.json 这个位置，如果没有就创建一个</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> gedit /etc/docker/daemon.json</span><br></pre></td></tr></table></figure><p>在daemon.json 中增加</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;registry-mirrors&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;https://docker.m.daocloud.io&quot;</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>重置生效</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl daemon-reload</span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl restart docker</span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker info</span><br></pre></td></tr></table></figure><h3 id="如果中途出错可以执行以下命令卸载docker重试"><a class="markdownIt-Anchor" href="#如果中途出错可以执行以下命令卸载docker重试"></a> 如果中途出错可以，执行以下命令卸载docker，重试</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt-get purge docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 环境搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ubuntu22.04安装编译OpenCV</title>
      <link href="/2025/05/21/ubuntu22-04%E5%AE%89%E8%A3%85%E7%BC%96%E8%AF%91OpenCV/"/>
      <url>/2025/05/21/ubuntu22-04%E5%AE%89%E8%A3%85%E7%BC%96%E8%AF%91OpenCV/</url>
      
        <content type="html"><![CDATA[<h2 id="安装opencv"><a class="markdownIt-Anchor" href="#安装opencv"></a> 安装opencv</h2><h3 id="前置环境"><a class="markdownIt-Anchor" href="#前置环境"></a> 前置环境</h3><p>需要系统上存在cmake, g++, make 或者 ninja-build<br />如果没有, 执行下面命令安装:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#更新apt可安装包列表</span></span><br><span class="line"><span class="built_in">sudo</span> apt update</span><br><span class="line"> </span><br><span class="line"><span class="comment">#安装cmake和g++</span></span><br><span class="line"><span class="built_in">sudo</span> apt install -y cmake g++</span><br><span class="line"> </span><br><span class="line"><span class="comment">#安装项目构建工具，有两个选择，make或ninja</span></span><br><span class="line"><span class="built_in">sudo</span> apt install make </span><br><span class="line"><span class="built_in">sudo</span> apt install ninja-build</span><br></pre></td></tr></table></figure><h3 id="卸载旧版本"><a class="markdownIt-Anchor" href="#卸载旧版本"></a> 卸载旧版本</h3><p>如果系统上存在旧版本的 opencv 或者 使用 sudo apt install libopencv-dev 命令下载的可以选择使用以下命令删除：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt purge libopencv-dev</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">rm</span> -rf /usr/include/opencv4 /usr/lib/x86_64-linux-gnu/libopencv_* </span><br></pre></td></tr></table></figure><h3 id="下载官方源代码"><a class="markdownIt-Anchor" href="#下载官方源代码"></a> 下载官方源代码</h3><p>新建文件夹放置下载的源码<br />这里我下载到了</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~/Desktop/vision/opencv_lib</span><br></pre></td></tr></table></figure><p>从github 下载opencv源码和扩展模块的源码</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git https://github.com/opencv/opencv.git</span><br><span class="line">git https://github.com/opencv/opencv_contrib.git</span><br></pre></td></tr></table></figure><p>opencv_lib文件夹下存在</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">opencv-4.11.0</span><br><span class="line">opencv_contrib</span><br></pre></td></tr></table></figure><h3 id="安装opencv-依赖"><a class="markdownIt-Anchor" href="#安装opencv-依赖"></a> 安装opencv 依赖</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt install -y \</span><br><span class="line">    build-essential cmake git pkg-config libgtk-3-dev \</span><br><span class="line">    libavcodec-dev libavformat-dev libswscale-dev libv4l-dev \</span><br><span class="line">    libxvidcore-dev libx264-dev libjpeg-dev libpng-dev libtiff-dev \</span><br><span class="line">    gfortran openexr libatlas-base-dev python3-dev python3-numpy \</span><br><span class="line">    libtbb2 libtbb-dev libdc1394-22-dev libopenexr-dev \</span><br><span class="line">    libgstreamer-plugins-base1.0-dev libgstreamer1.0-dev \</span><br><span class="line">    libice-dev libbsd-dev</span><br></pre></td></tr></table></figure><h3 id="配置并编译-opencv"><a class="markdownIt-Anchor" href="#配置并编译-opencv"></a> 配置并编译 opencv</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~/Desktop/vision/opencv_lib/opencv-4.11.0/build</span><br><span class="line"><span class="comment"># 如果之前配置出错可以删除</span></span><br><span class="line"><span class="built_in">rm</span> -rf *</span><br><span class="line"><span class="comment"># \ 后面注意不要有空格，否则在终端运行会出错</span></span><br><span class="line">cmake -D CMAKE_BUILD_TYPE=RELEASE \</span><br><span class="line">      -D CMAKE_INSTALL_PREFIX=/usr/local \</span><br><span class="line">      -D OPENCV_GENERATE_PKGCONFIG=ON \</span><br><span class="line">      -D OPENCV_EXTRA_MODULES_PATH=~/Desktop/vision/opencv_lib/opencv_contrib/modules \</span><br><span class="line">      -D BUILD_EXAMPLES=OFF \</span><br><span class="line">      -D WITH_GTK=ON \</span><br><span class="line">      -D WITH_FFMPEG=ON \</span><br><span class="line">      -D WITH_V4L=ON \</span><br><span class="line">      ..</span><br><span class="line"></span><br><span class="line">make -j$(<span class="built_in">nproc</span>)</span><br><span class="line"><span class="built_in">sudo</span> make install</span><br><span class="line"><span class="built_in">sudo</span> ldconfig</span><br></pre></td></tr></table></figure><h3 id="查看opencv4版本"><a class="markdownIt-Anchor" href="#查看opencv4版本"></a> 查看opencv4版本</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pkg-config --modversion opencv4</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 环境搭建 </category>
          
          <category> 视觉 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> OpenCV </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>逆向破解加密爬取音乐实战</title>
      <link href="/2025/05/20/%E9%80%86%E5%90%91%E7%A0%B4%E8%A7%A3%E5%8A%A0%E5%AF%86%E7%88%AC%E5%8F%96%E9%9F%B3%E4%B9%90%E5%AE%9E%E6%88%98/"/>
      <url>/2025/05/20/%E9%80%86%E5%90%91%E7%A0%B4%E8%A7%A3%E5%8A%A0%E5%AF%86%E7%88%AC%E5%8F%96%E9%9F%B3%E4%B9%90%E5%AE%9E%E6%88%98/</url>
      
        <content type="html"><![CDATA[<blockquote><p>该音乐网站已经停止运维</p></blockquote><h2 id="逆向模拟加密请求接口"><a class="markdownIt-Anchor" href="#逆向模拟加密请求接口"></a> 逆向模拟加密请求接口</h2><h3 id="搜索api"><a class="markdownIt-Anchor" href="#搜索api"></a> 搜索api</h3><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/%E7%88%AC%E8%99%AB/1738923287003.png" alt="1738923287003" /></p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/%E7%88%AC%E8%99%AB/1738923324521.png" alt="1738923324521" /></p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/%E7%88%AC%E8%99%AB/1738923343388.png" alt="1738923343388" /></p><p>接口地址：<a href="https://tool.liumingye.cn/music/api/search">https://tool.liumingye.cn/music/api/search</a><br />POST请求<br />请求参数为：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;YQM&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;text&quot;</span><span class="punctuation">:</span><span class="string">&quot;唯一&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;page&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;v&quot;</span><span class="punctuation">:</span><span class="string">&quot;beta&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;_t&quot;</span><span class="punctuation">:</span><span class="number">1738923249577</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;token&quot;</span><span class="punctuation">:</span><span class="string">&quot;20241016.e38efcba0d384a6782e835d8d63a2837&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>响应数据格式：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">200</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;list&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;zEAY&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;唯一&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;time&quot;</span><span class="punctuation">:</span> <span class="number">262</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;quality&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                    <span class="number">128</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="number">320</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="number">2000</span></span><br><span class="line">                <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;album&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;zqyA&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;唯一&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;pic&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https:\/\/i.biliimg.com\/bfs\/im\/895931b7dea76e5ad7148cf8714192621b9b12bf.jpg@&#123;size&#125;w_&#123;size&#125;h_1c.webp&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;artist&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                    <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;zYOg&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;王力宏&quot;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;hash&quot;</span><span class="punctuation">:</span> <span class="string">&quot;d3f636iePH3nJMVUD1wbsSTfgf-QwuOgyE9H3WcjYfUEDiX2YdQ&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;唯一&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;artist&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                    <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;mfm&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;告五人&quot;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;m3f63OtUGNZoMDio1Kv1QtTI8xsjKJ_Mheyn12w07dWSL0qLZFeLha7Ur2BjAcJo&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;pic&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https:\/\/d.musicapp.migu.cn\/data\/oss\/resource\/00\/2h\/xz\/6w.webp&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;lyric&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https:\/\/d.musicapp.migu.cn\/data\/oss\/resource\/00\/1v\/uz\/x8&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;quality&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                    <span class="number">128</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="number">320</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="number">2000</span></span><br><span class="line">                <span class="punctuation">]</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;唯一&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;artist&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                    <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;mfm&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;王力宏&quot;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;m3f63OtUGNZoMDio1KvtWvzQ-xJiZdK54cSf02lE7dWSL0q_ZFeLha7Yo2R7Be58&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;pic&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https:\/\/d.musicapp.migu.cn\/data\/oss\/resource\/00\/2u\/km\/05e4226dce81478f918831450cb3c79e.webp&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;lyric&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http:\/\/d.musicapp.migu.cn\/prod\/file-service\/file-down01\/4eedd78464c21ce789dea6928415b323\/503186ae19388b5d720c7634363ae4a2\/a3e5f7ace5da52aec33936e1af18845c&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;quality&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                    <span class="number">128</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="number">320</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="number">2000</span></span><br><span class="line">                <span class="punctuation">]</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    ......</span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="number">221146</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;word&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;唯一&quot;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;msg&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>开始分析源代码</p><p>首先搜索  api/search  发现这个字符串在混淆变量中</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/%E7%88%AC%E8%99%AB/1738929338043.png" alt="1738929338043" /></p><p>const e = [“text-xl font-semibold”, “wheel”, “bc-none”, …]</p><p>把混淆变量复制过来放到代码文件中</p><p>查找 api/search 的索引为 52，在源代码中搜索 （52）发现没有，有可能代码进行了混淆导致索引偏移了</p><p>然后在源代码中追踪一下这个混淆变量，也就是调用 qo() 的地方</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/%E7%88%AC%E8%99%AB/1738929473247.png" alt="1738929473247" /></p><p>发现果然会偏移混淆变量</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/%E7%88%AC%E8%99%AB/1738930064364.png" alt="1738930064364" /></p><p>尝试搜索 POST</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/%E7%88%AC%E8%99%AB/1738928985755.png" alt="1738928985755" /></p><p>打断点刷新网页进行调试，发现网页成功截停</p><p>然后在控制台输入 console.log(r(570))，输出 /api/auth/login</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/%E7%88%AC%E8%99%AB/1738929045345.png" alt="1738929045345" /></p><p>发现这是一个验证登录的接口，然后就在文件中查找 /api/auth/login 的索引，为 796</p><p>果然，在源代码中 570 ，实际上是 796，偏移了 226</p><p>那么，源代码中的 52（也就是 api/search）会不会偏移到了混淆变量的末尾呢，</p><p>混淆变量的长度为 2112， 那么我们就尝试搜索一下 1938 或者搜索 page 或 text</p><p>终于找到了：</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/%E7%88%AC%E8%99%AB/1738931509721.png" alt="1738931509721" /></p><p>其中 s 就是偏移后的混淆变量</p><p>可以发现这里的 v 是固定的 beta</p><p>打断点调试</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/%E7%88%AC%E8%99%AB/1738932203971.png" alt="1738932203971" /></p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/%E7%88%AC%E8%99%AB/1738932253262.png" alt="1738932253262" /></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(o[<span class="title function_">e</span>(<span class="number">1129</span>)][<span class="title function_">e</span>(<span class="number">1291</span>)][<span class="title function_">e</span>(<span class="number">1750</span>)](), o.<span class="property">params</span>.<span class="property">keywords</span>.<span class="title function_">toString</span>(), i.<span class="property">page</span>))[<span class="title function_">e</span>(<span class="number">780</span>)][<span class="title function_">e</span>(<span class="number">780</span>)];</span><br><span class="line"></span><br><span class="line">(o[params][engine][toString](), o.<span class="property">params</span>.<span class="property">keywords</span>.<span class="title function_">toString</span>(), i.<span class="property">page</span>))[data][data];</span><br><span class="line"></span><br><span class="line">猜测一下， i.<span class="property">page</span>应该是 <span class="number">1</span> </span><br><span class="line">再大胆猜测一下 o[params][engine][toString]() 应该对应上面请求的 e, o.<span class="property">params</span>.<span class="property">keywords</span>.<span class="title function_">toString</span>() 对应t 也就是 text</span><br><span class="line">i.<span class="property">page</span> 对应的是 page</span><br><span class="line"></span><br><span class="line">那么， text 和 page 和 v 都已知， 要搞清楚 type 也就是 e</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/%E7%88%AC%E8%99%AB/1738933021265.png" alt="1738933021265" /></p><p>找到 o 看一下他到底是什么</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/%E7%88%AC%E8%99%AB/1738933202162.png" alt="1738933202162" /></p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/%E7%88%AC%E8%99%AB/1738936228728.png" alt="1738936228728" /></p><p>这个函数没有 token 和 _t 的字段，应该是调用了这个函数之后又调用了其它的函数</p><p>那么，这个接口的参数还剩下 token 和  _t ，这两个是主要的，尤其 是 token，_t 可以猜一下是时间戳</p><p>那就尝试一下在源代码中搜索一下 token, 发现有 7 个，数量不多，其中一个还是在混淆变量里，可以都打上断点调试一下，</p><p>如果没有停下，那就搜索一下混淆变量里 token 的索引， 不过，很幸运，程序停在了：</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/%E7%88%AC%E8%99%AB/1738936905000.png" alt="1738936905000" /></p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/%E7%88%AC%E8%99%AB/1738936935689.png" alt="1738936935689" /></p><p>可以看到 token 和 _t 是在这段代码加入的</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/%E7%88%AC%E8%99%AB/1738946360576.png" alt="1738946360576" /></p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/%E7%88%AC%E8%99%AB/1738946463201.png" alt="1738946463201" /></p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/%E7%88%AC%E8%99%AB/1738946478773.png" alt="1738946478773" /></p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/%E7%88%AC%E8%99%AB/1738947140824.png" alt="1738947140824" /></p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/%E7%88%AC%E8%99%AB/1738947372920.png" alt="1738947372920" /></p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/%E7%88%AC%E8%99%AB/1738947365166.png" alt="1738947365166" /></p><p>在AI的帮助下对整个过程有了大致了解，让AI生成整体流程代码，然后多次调试修正后，最终成功逆向了这个加密算法，如下：</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/%E7%88%AC%E8%99%AB/1738990206639.png" alt="1738990206639" /></p><h3 id="播放api"><a class="markdownIt-Anchor" href="#播放api"></a> 播放api</h3><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/%E7%88%AC%E8%99%AB/1738822590547.png" alt="1738822590547" /></p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/%E7%88%AC%E8%99%AB/1738822733852.png" alt="1738822733852" /></p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/%E7%88%AC%E8%99%AB/1738822750837.png" alt="1738822750837" /></p><p>可以看到，这api没有任何返回值，那么问题来了，前端是怎么知道播放链接的呢，会不会是，根据某些前端数据拼接成的播放链接呢？</p><p>经过一系列分析和打断点调试，有以下发现：</p><p>uri编码后的数据：</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/%E7%88%AC%E8%99%AB/1738992896652.png" alt="1738992896652" /></p><p>可以结合search api 的返回结果来看，就比较清楚了</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/%E7%88%AC%E8%99%AB/1738992870921.png" alt="1738992870921" /></p><p>多次调试后，有了重大发现:</p><ol><li><p>index.js源代码中的loadSong()：<img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/%E7%88%AC%E8%99%AB/1738993446758.png" alt="1738993446758" /></p><p>果然，前端这里直接拼接成了播放地址，那就对这个播放地址分析一下</p></li><li><p>对于list[0]这个比较特殊的</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;https://tool.liumingye.cn/music/api/link?id=d3f636iePH3nJMVUD1wbsSTfgf-QwuOgyE9H3WcjYfUEDiX2YdQ&amp;quality=128&amp;_t=1738993370934&amp;token=20241016.e8917799e456aad902485db1aa7a7a83&quot;</span></span><br></pre></td></tr></table></figure><p>网址中的 id -&gt; hash, 那token是怎么获得的呢？还是使用的之前的加密算法，与search api 不同的是，uri用的 data 是  “{“id”:“d3f636iePH3nJMVUD1wbsSTfgf-QwuOgyE9H3WcjYfUEDiX2YdQ”,“quality”:“128”,”_t&quot;:“1738992521608”}&quot;</p></li><li><p>对于更普遍的 list[2]这种情况</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;https://tool.liumingye.cn/music/api/link?id=m3f63OtUGNZoMDio1KvtWvzQ-xJiZdK54cSf02lE7dWSL0q_ZFeLha7Yo2R7Be58&amp;quality=128&amp;_t=1738993160654&amp;token=20241016.5940ea862f12cf113aa5faddc706d8fe&quot;</span></span><br></pre></td></tr></table></figure><p>同样，这个id 就是 search api 返回结果里的 id, 使用相同的算法产生 token，不同的就是 uri 那部分</p></li></ol><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/%E7%88%AC%E8%99%AB/1739511271821.png" alt="1739511271821" /></p>]]></content>
      
      
      <categories>
          
          <category> 逆向 </category>
          
          <category> 爬虫 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>安卓项目进行模型推理</title>
      <link href="/2025/05/20/%E5%AE%89%E5%8D%93%E9%A1%B9%E7%9B%AE%E8%BF%9B%E8%A1%8C%E6%A8%A1%E5%9E%8B%E6%8E%A8%E7%90%86/"/>
      <url>/2025/05/20/%E5%AE%89%E5%8D%93%E9%A1%B9%E7%9B%AE%E8%BF%9B%E8%A1%8C%E6%A8%A1%E5%9E%8B%E6%8E%A8%E7%90%86/</url>
      
        <content type="html"><![CDATA[<h2 id="集成-tensorflow-lite"><a class="markdownIt-Anchor" href="#集成-tensorflow-lite"></a> 集成 TensorFlow Lite</h2><h3 id="配置环境"><a class="markdownIt-Anchor" href="#配置环境"></a> 配置环境</h3><p>模块级 <em>build.gradle</em> 添加：</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        ndk &#123;</span><br><span class="line">            abiFilters <span class="string">&#x27;armeabi-v7a&#x27;</span>, <span class="string">&#x27;arm64-v8a&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">     androidResources &#123;</span><br><span class="line">        noCompress <span class="string">&#x27;tflite&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    <span class="comment">// Tensorflow lite dependencies</span></span><br><span class="line">    implementation <span class="string">&#x27;org.tensorflow:tensorflow-lite-task-vision:0.4.0&#x27;</span></span><br><span class="line">    <span class="comment">// Import the GPU delegate plugin Library for GPU inference</span></span><br><span class="line">    implementation <span class="string">&#x27;org.tensorflow:tensorflow-lite-gpu:2.9.0&#x27;</span></span><br><span class="line">    implementation <span class="string">&#x27;org.tensorflow:tensorflow-lite-gpu-delegate-plugin:0.4.0&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="编写程序验证"><a class="markdownIt-Anchor" href="#编写程序验证"></a> 编写程序验证</h3><p>参考 <em>TensorFlow Lite</em> 官方例程：</p><p>[<a href="https://github.com/tensorflow/examples/blob/master/lite/examples/image_classification/android_java/README.md">examples/lite/examples/image_classification/android_java/README.md 在 master ·TensorFlow/示例 — examples/lite/examples/image_classification/android_java/README.md at master · tensorflow/examples</a>](<a href="https://github.com/tensorflow/examples/blob/master/lite/examples/image_classification/android_java/README.md">https://github.com/tensorflow/examples/blob/master/lite/examples/image_classification/android_java/README.md</a>)</p><p>测试模型采用官方的图像分类模型</p><p>官方例程是从手机摄像头中拿取的图片，为了测试方便，就直接测试 <em>assets</em> 里的图片了</p><p>在 <em>algo</em> 文件夹下新建 <em>ImageClassifierHelper</em> 类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Copyright 2022 The TensorFlow Authors. All Rights Reserved.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></span><br><span class="line"><span class="comment"> * you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment"> * You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *             http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment"> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></span><br><span class="line"><span class="comment"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment"> * See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment"> * limitations under the License.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.gxl_recognitionsystem.algo;</span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Bitmap;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Canvas;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Paint;</span><br><span class="line"><span class="keyword">import</span> android.os.SystemClock;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> org.tensorflow.lite.gpu.CompatibilityList;</span><br><span class="line"><span class="keyword">import</span> org.tensorflow.lite.support.image.ImageProcessor;</span><br><span class="line"><span class="keyword">import</span> org.tensorflow.lite.support.image.TensorImage;</span><br><span class="line"><span class="keyword">import</span> org.tensorflow.lite.support.image.ops.ResizeOp;</span><br><span class="line"><span class="keyword">import</span> org.tensorflow.lite.support.image.ops.Rot90Op;</span><br><span class="line"><span class="keyword">import</span> org.tensorflow.lite.support.metadata.schema.NormalizationOptions;</span><br><span class="line"><span class="keyword">import</span> org.tensorflow.lite.task.core.BaseOptions;</span><br><span class="line"><span class="keyword">import</span> org.tensorflow.lite.task.vision.classifier.Classifications;</span><br><span class="line"><span class="keyword">import</span> org.tensorflow.lite.task.vision.classifier.ImageClassifier;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Helper class for wrapping Image Classification actions */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ImageClassifierHelper</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TAG</span> <span class="operator">=</span> <span class="string">&quot;ImageClassifierHelper&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">DELEGATE_CPU</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">DELEGATE_GPU</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">DELEGATE_NNAPI</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MODEL_ISINSTRUMENT</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MODEL_ISINSTALL</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MODEL_MOBILENETV1</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">float</span> threshold;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> numThreads;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> maxResults;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> currentDelegate;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> currentModel;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Context context;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ClassifierListener imageClassifierListener;</span><br><span class="line">    <span class="keyword">private</span> ImageClassifier imageClassifier;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Helper class for wrapping Image Classification actions */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ImageClassifierHelper</span><span class="params">(Float threshold,</span></span><br><span class="line"><span class="params">                                 <span class="type">int</span> numThreads,</span></span><br><span class="line"><span class="params">                                 <span class="type">int</span> maxResults,</span></span><br><span class="line"><span class="params">                                 <span class="type">int</span> currentDelegate,</span></span><br><span class="line"><span class="params">                                 <span class="type">int</span> currentModel,</span></span><br><span class="line"><span class="params">                                 Context context,</span></span><br><span class="line"><span class="params">                                 ClassifierListener imageClassifierListener)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.threshold = threshold;</span><br><span class="line">        <span class="built_in">this</span>.numThreads = numThreads;</span><br><span class="line">        <span class="built_in">this</span>.maxResults = maxResults;</span><br><span class="line">        <span class="built_in">this</span>.currentDelegate = currentDelegate;</span><br><span class="line">        <span class="built_in">this</span>.currentModel = currentModel;</span><br><span class="line">        <span class="built_in">this</span>.context = context;</span><br><span class="line">        <span class="built_in">this</span>.imageClassifierListener = imageClassifierListener;</span><br><span class="line">        setupImageClassifier();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ImageClassifierHelper <span class="title function_">create</span><span class="params">(</span></span><br><span class="line"><span class="params">            Context context,</span></span><br><span class="line"><span class="params">            ClassifierListener listener</span></span><br><span class="line"><span class="params">    )</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ImageClassifierHelper</span>(</span><br><span class="line">                <span class="number">0.5f</span>,</span><br><span class="line">                <span class="number">2</span>,</span><br><span class="line">                <span class="number">3</span>,</span><br><span class="line">                <span class="number">0</span>,</span><br><span class="line">                <span class="number">2</span>,</span><br><span class="line">                context,</span><br><span class="line">                listener</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">float</span> <span class="title function_">getThreshold</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> threshold;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setThreshold</span><span class="params">(<span class="type">float</span> threshold)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.threshold = threshold;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getNumThreads</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> numThreads;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setNumThreads</span><span class="params">(<span class="type">int</span> numThreads)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.numThreads = numThreads;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getMaxResults</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> maxResults;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMaxResults</span><span class="params">(<span class="type">int</span> maxResults)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.maxResults = maxResults;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCurrentDelegate</span><span class="params">(<span class="type">int</span> currentDelegate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.currentDelegate = currentDelegate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCurrentModel</span><span class="params">(<span class="type">int</span> currentModel)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.currentModel = currentModel;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">setupImageClassifier</span><span class="params">()</span> &#123;</span><br><span class="line">        ImageClassifier.ImageClassifierOptions.<span class="type">Builder</span> <span class="variable">optionsBuilder</span> <span class="operator">=</span></span><br><span class="line">                ImageClassifier.ImageClassifierOptions.builder()</span><br><span class="line">                        .setScoreThreshold(threshold)</span><br><span class="line">                        .setMaxResults(maxResults);</span><br><span class="line"></span><br><span class="line">        BaseOptions.<span class="type">Builder</span> <span class="variable">baseOptionsBuilder</span> <span class="operator">=</span></span><br><span class="line">                BaseOptions.builder().setNumThreads(numThreads);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (currentDelegate) &#123;</span><br><span class="line">            <span class="keyword">case</span> DELEGATE_CPU:</span><br><span class="line">                <span class="comment">// Default</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> DELEGATE_GPU:</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">new</span> <span class="title class_">CompatibilityList</span>().isDelegateSupportedOnThisDevice()) &#123;</span><br><span class="line">                    baseOptionsBuilder.useGpu();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    imageClassifierListener.onError(<span class="string">&quot;GPU is not supported on &quot;</span></span><br><span class="line">                            + <span class="string">&quot;this device&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> DELEGATE_NNAPI:</span><br><span class="line">                baseOptionsBuilder.useNnapi();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String modelName;</span><br><span class="line">        <span class="keyword">switch</span> (currentModel) &#123;</span><br><span class="line">            <span class="keyword">case</span> MODEL_ISINSTRUMENT:</span><br><span class="line">                modelName = <span class="string">&quot;is_instrument2.tflite&quot;</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> MODEL_ISINSTALL:</span><br><span class="line">                modelName = <span class="string">&quot;is_install2.tflite&quot;</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> MODEL_MOBILENETV1:</span><br><span class="line">                modelName = <span class="string">&quot;mobilenetv1.tflite&quot;</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                modelName = <span class="string">&quot;is_instrument2.tflite&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            imageClassifier =</span><br><span class="line">                    ImageClassifier.createFromFileAndOptions(</span><br><span class="line">                            context,</span><br><span class="line">                            modelName,</span><br><span class="line">                            optionsBuilder.build());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            imageClassifierListener.onError(<span class="string">&quot;Image classifier failed to &quot;</span></span><br><span class="line">                    + <span class="string">&quot;initialize. See error logs for details&quot;</span>);</span><br><span class="line">            Log.e(TAG, <span class="string">&quot;TFLite failed to load model with error: &quot;</span></span><br><span class="line">                    + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">classify</span><span class="params">(Bitmap image, <span class="type">int</span> imageRotation)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (imageClassifier == <span class="literal">null</span>) &#123;</span><br><span class="line">            setupImageClassifier();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Inference time is the difference between the system time at the start</span></span><br><span class="line">        <span class="comment">// and finish of the process</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">inferenceTime</span> <span class="operator">=</span> SystemClock.uptimeMillis();</span><br><span class="line"></span><br><span class="line">        <span class="type">Bitmap</span> <span class="variable">convertedBitmap</span> <span class="operator">=</span> Bitmap.createBitmap(image.getWidth(), image.getHeight(), Bitmap.Config.ARGB_8888);</span><br><span class="line"></span><br><span class="line">        <span class="type">Canvas</span> <span class="variable">canvas</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Canvas</span>(convertedBitmap);</span><br><span class="line">        <span class="type">Paint</span> <span class="variable">paint</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Paint</span>();</span><br><span class="line">        canvas.drawBitmap(image, <span class="number">0</span>, <span class="number">0</span>, paint);</span><br><span class="line">        <span class="comment">// Create preprocessor for the image.</span></span><br><span class="line">        <span class="comment">// See https://www.tensorflow.org/lite/inference_with_metadata/</span></span><br><span class="line">        <span class="comment">//            lite_support#imageprocessor_architecture</span></span><br><span class="line">        <span class="type">ImageProcessor</span> <span class="variable">imageProcessor</span> <span class="operator">=</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ImageProcessor</span>.Builder()</span><br><span class="line"><span class="comment">//                        .add(new TransposeOp(new int[]&#123;0, 2, 3, 1&#125;))  // 将 [1,3,height,width] 转为 [1,height,width,3]</span></span><br><span class="line">                        .add(<span class="keyword">new</span> <span class="title class_">Rot90Op</span>(-imageRotation / <span class="number">90</span>)).build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Preprocess the image and convert it into a TensorImage for classification.</span></span><br><span class="line">        <span class="type">TensorImage</span> <span class="variable">tensorImage</span> <span class="operator">=</span></span><br><span class="line">                imageProcessor.process(TensorImage.fromBitmap(convertedBitmap));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Classify the input image</span></span><br><span class="line">        imageClassifier.classify(tensorImage);</span><br><span class="line"></span><br><span class="line">        List&lt;Classifications&gt; result = imageClassifier.classify(tensorImage);</span><br><span class="line"></span><br><span class="line">        inferenceTime = SystemClock.uptimeMillis() - inferenceTime;</span><br><span class="line">        imageClassifierListener.onResults(result, inferenceTime);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">clearImageClassifier</span><span class="params">()</span> &#123;</span><br><span class="line">        imageClassifier = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Listener for passing results back to calling class */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ClassifierListener</span> &#123;</span><br><span class="line">        <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(String error)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">void</span> <span class="title function_">onResults</span><span class="params">(List&lt;Classifications&gt; results, <span class="type">long</span> inferenceTime)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在 <em>test</em> 类中加入：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从 assets 加载图片并进行图像分类</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> context        上下文对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> assetImageFile assets 下的图片文件名（例如 &quot;testAlgo.jpg&quot;）</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> imageRotation  图片旋转角度（单位：度）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">testModel</span><span class="params">(Context context, String assetImageFile, <span class="type">int</span> imageRotation)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1. 准备图片</span></span><br><span class="line">            <span class="comment">// 从 assets 中加载图片</span></span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">is</span> <span class="operator">=</span> context.getAssets().open(assetImageFile);</span><br><span class="line">            <span class="type">Bitmap</span> <span class="variable">bitmap</span> <span class="operator">=</span> BitmapFactory.decodeStream(is);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (bitmap == <span class="literal">null</span>) &#123;</span><br><span class="line">                Log.e(<span class="string">&quot;ImageLoad&quot;</span>, <span class="string">&quot;图片加载失败. Please check if the file exists in assets and the file name is correct.&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Log.d(<span class="string">&quot;ImageLoad&quot;</span>, <span class="string">&quot;Bitmap 加载成功: &quot;</span> + bitmap.getWidth() + <span class="string">&quot; x &quot;</span> + bitmap.getHeight());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 创建 ImageClassifierHelper</span></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 构造方法，用于初始化 ImageClassifierHelper 实例。</span></span><br><span class="line"><span class="comment">             *</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> threshold           分类结果的概率阈值（0.0f 到 1.0f）。</span></span><br><span class="line"><span class="comment">             *                            例如，设置为 0.5f 表示只有概率大于 50% 的分类结果才会被返回。</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> numThreads          运行分类任务的线程数，建议设置为 2 或 3。</span></span><br><span class="line"><span class="comment">             *                            更多的线程可能提高性能，但也会增加资源消耗。</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> maxResults          每次分类返回的最大结果数量，建议设置为 2 到 5。</span></span><br><span class="line"><span class="comment">             *                            设置为 2 表示每次分类最多返回 2 个最可能的类别。</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> currentDelegate     当前使用的委托类型，用于指定硬件加速方式等。</span></span><br><span class="line"><span class="comment">             *                            例如，设置为 0 表示使用CPU，1：GPU。</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> currentModel        当前使用的模型类型，用于指定不同的分类模型。</span></span><br><span class="line"><span class="comment">             *                            0: is_instrument     1: is_install      2. mobilenetv1</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> context             应用上下文，用于加载资源等。</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> imageClassifierListener 分类结果监听器，用于接收分类结果或错误信息。</span></span><br><span class="line"><span class="comment">             *                            通过实现 ClassifierListener 接口，可以在分类完成或出错时得到回调。</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="type">ImageClassifierHelper</span> <span class="variable">classifierHelper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ImageClassifierHelper</span>(</span><br><span class="line">                    <span class="number">0.5f</span>,</span><br><span class="line">                    <span class="number">2</span>,</span><br><span class="line">                    <span class="number">3</span>,</span><br><span class="line">                    <span class="number">0</span>,</span><br><span class="line">                    <span class="number">0</span>,</span><br><span class="line">                    context,</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">ImageClassifierHelper</span>.ClassifierListener() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(String error)</span> &#123;</span><br><span class="line">                            Log.d(<span class="string">&quot;testModel&quot;</span>, <span class="string">&quot;算法测试出错了&quot;</span>);</span><br><span class="line"><span class="comment">//                        Toast.makeText(Administrators_MainActivity.this, error, Toast.LENGTH_SHORT).show());</span></span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onResults</span><span class="params">(List&lt;Classifications&gt; results, <span class="type">long</span> inferenceTime)</span> &#123;</span><br><span class="line">                            Log.d(<span class="string">&quot;testModel&quot;</span>, <span class="string">&quot;推理耗时: &quot;</span> + inferenceTime + <span class="string">&quot; ms&quot;</span>);</span><br><span class="line">                            <span class="keyword">for</span> (Classifications classification : results) &#123;</span><br><span class="line">                                Log.d(<span class="string">&quot;testModel&quot;</span>, <span class="string">&quot;推理结果: &quot;</span> + classification.toString());</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 调用 classify 方法进行图像分类</span></span><br><span class="line">            classifierHelper.classify(bitmap, imageRotation);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在 <em>Adminstrators_MainActivity</em> 中加入：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Administrators_MainActivity</span> <span class="keyword">extends</span> <span class="title class_">Activity</span> <span class="keyword">implements</span> <span class="title class_">View</span>.OnClickListener &#123;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="comment">// 测试算法模型</span></span><br><span class="line">        testModel();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">testModel</span><span class="params">()</span> &#123;</span><br><span class="line">        ArrayList&lt;String&gt; assetsImgList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        assetsImgList.add(<span class="string">&quot;testAlgo.jpg&quot;</span>);</span><br><span class="line">        assetsImgList.add(<span class="string">&quot;test1.jpg&quot;</span>);</span><br><span class="line">        assetsImgList.add(<span class="string">&quot;test2.jpg&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (String img : assetsImgList) &#123;</span><br><span class="line">            testAlgo.testModel(<span class="built_in">this</span>, img, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行，测试结果如下：</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/Android/202503062116665.png" alt="image-20250306211621612" /></p><p>第一个图片识别失败了，可能是由于图片分辨率太低，后面两张图片都识别出是杯子（cup）了</p><h2 id="自定义训练模型"><a class="markdownIt-Anchor" href="#自定义训练模型"></a> 自定义训练模型</h2><h3 id="技术路线"><a class="markdownIt-Anchor" href="#技术路线"></a> 技术路线</h3><p>尝试使用 <em>tensorflow</em> 官方的 <em>TensorFlow Lite Model Maker</em> 进行训练，这个会给模型自动添加元数据，使用训练完成的 <em>tflite</em> 文件在安卓端进行推理测试：</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/Android/202503131232092.png" alt="image-20250313123209039" /></p><p>测试成功！</p><h3 id="编写算法逻辑代码测试"><a class="markdownIt-Anchor" href="#编写算法逻辑代码测试"></a> 编写算法逻辑代码测试</h3><p>在 <em>Adminstrators_MainActivity</em> 中加入：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Administrators_MainActivity</span> <span class="keyword">extends</span> <span class="title class_">Activity</span> <span class="keyword">implements</span> <span class="title class_">View</span>.OnClickListener &#123;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="comment">// 测试算法判断逻辑 testAlgo</span></span><br><span class="line">        testAlgo();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 测试 算法判断逻辑 testAlgo</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">testAlgo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">assetFilePath</span> <span class="operator">=</span> <span class="string">&quot;normal.jpg&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">tempDir</span> <span class="operator">=</span> getCacheDir().getAbsolutePath();</span><br><span class="line">        <span class="comment">// 复制到缓存区以获得绝对路径</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">tempFilePath</span> <span class="operator">=</span> tempDir + <span class="string">&quot;/&quot;</span> + assetFilePath;</span><br><span class="line">        <span class="comment">// 将图片从 assets 目录复制到临时目录</span></span><br><span class="line">        test.copyFileFromAssets(<span class="built_in">this</span>, assetFilePath, tempFilePath);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> test.testAlgo(<span class="built_in">this</span>, tempFilePath, <span class="number">0</span>);</span><br><span class="line">        Log.d(<span class="string">&quot;testAlgo&quot;</span>, s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>下面编写识别逻辑：</p><p><em>test</em> 类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.gxl_recognitionsystem.algo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Bitmap;</span><br><span class="line"><span class="keyword">import</span> android.graphics.BitmapFactory;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.chaquo.python.PyObject;</span><br><span class="line"><span class="keyword">import</span> com.chaquo.python.Python;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.tensorflow.lite.support.label.Category;</span><br><span class="line"><span class="keyword">import</span> org.tensorflow.lite.task.vision.classifier.Classifications;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Objects;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.CountDownLatch;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test</span> &#123;</span><br><span class="line"><span class="comment">// 设置置信度</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">float</span> <span class="variable">CONFIDENCE_THRESHOLD</span> <span class="operator">=</span> <span class="number">0.5f</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 方法描述：</span></span><br><span class="line"><span class="comment">     * 1. 图片模糊检测：</span></span><br><span class="line"><span class="comment">     *    - 调用 Python 模块中 detetion.py 的 is_image_blur 方法，对传入的图片文件进行模糊检测。</span></span><br><span class="line"><span class="comment">     *    - 如果检测结果表明图片模糊，则方法直接返回错误提示，提示用户提供更清晰的图像，后续处理不再继续。</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 2. 图片加载：</span></span><br><span class="line"><span class="comment">     *    - 使用 BitmapFactory 从指定的临时文件路径加载图片生成 Bitmap 对象。</span></span><br><span class="line"><span class="comment">     *    - 如果图片加载失败（返回的 Bitmap 为 null），则记录错误日志，并返回错误提示信息。</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 3. 仪表设备检测（is_instrument 模型）：</span></span><br><span class="line"><span class="comment">     *    - 创建 ImageClassifierHelper 实例，配置推理参数，包括置信度阈值、线程数、最大返回结果数量、委托类型、模型类型等。</span></span><br><span class="line"><span class="comment">     *      此处模型类型指定为 0，表示使用 is_instrument.tflite 模型。</span></span><br><span class="line"><span class="comment">     *    - 调用 classify 方法，对加载的 Bitmap 进行推理，同时传入图片的旋转角度（单位：度），以确保图片方向正确。</span></span><br><span class="line"><span class="comment">     *    - 在推理回调的 onResults 方法中，通过遍历返回的分类结果，调用自定义方法 isInstrument 来判断是否检测到仪表设备，</span></span><br><span class="line"><span class="comment">     *      并将判断结果赋值给 instrumentFlag 标志。</span></span><br><span class="line"><span class="comment">     *    - 如果在推理过程中发生错误，则 onError 回调方法会记录相关错误日志。</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 4. 仪表设备判断：</span></span><br><span class="line"><span class="comment">     *    - 如果 isInstrument 的判断结果为 false（即未检测到仪表设备），则方法直接返回错误提示“Error: 未检测到仪表设备”，</span></span><br><span class="line"><span class="comment">     *      不进行后续的安装情况检测。</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 5. 安装情况检测（is_install 模型）：</span></span><br><span class="line"><span class="comment">     *    - 如果仪表设备检测通过，则继续进行安装情况的检测。</span></span><br><span class="line"><span class="comment">     *    - 创建另一个 ImageClassifierHelper 实例，配置参数时将模型类型设置为 1，表示使用 is_install.tflite 模型。</span></span><br><span class="line"><span class="comment">     *    - 同样调用 classify 方法对图片进行推理，并在 onResults 回调中调用 isInstall 方法解析分类结果，</span></span><br><span class="line"><span class="comment">     *      根据返回的判断值更新 installFlag 标志；同时记录推理耗时及分类结果日志。</span></span><br><span class="line"><span class="comment">     *    - 推理出错时，onError 方法会记录错误日志。</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 6. 返回最终结果：</span></span><br><span class="line"><span class="comment">     *    - 根据 installFlag 的判断值，返回最终结果字符串：</span></span><br><span class="line"><span class="comment">     *         - 若 installFlag 为 true，返回 &quot;判断结果: 安装&quot;；</span></span><br><span class="line"><span class="comment">     *         - 若 installFlag 为 false，返回 &quot;Error: 未安装&quot;。</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 7. 清理临时文件：</span></span><br><span class="line"><span class="comment">     *    - 无论过程是否出现异常，最终都会在 finally 块中调用 deleteFile 方法删除临时图片文件，</span></span><br><span class="line"><span class="comment">     *      以确保临时资源得到及时释放。</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 注意事项：</span></span><br><span class="line"><span class="comment">     * - 本方法依赖 Python 模块（detection.py）、is_instrument.tflite 模型以及 is_install.tflite 模型，</span></span><br><span class="line"><span class="comment">     *   所以需要确保这些资源存在且正确配置。</span></span><br><span class="line"><span class="comment">     * - 分类推理操作可能为异步执行，需确保回调方法执行完成后再依据 flag 标志进行逻辑判断，</span></span><br><span class="line"><span class="comment">     *   否则可能会出现由于异步调用导致的逻辑错误。</span></span><br><span class="line"><span class="comment">     * - 日志记录信息有助于排查推理过程中的异常及错误，但需要注意日志中的信息描述应与实际操作保持一致。</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> context       应用上下文，用于资源加载、模型初始化及其他相关操作。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tempFilePath  临时存储图片的绝对路径，图片将用于后续的模糊检测和分类推理。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> imageRotation 图片的旋转角度（单位：度），用于在推理前对图片进行方向校正。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 返回最终判断结果的字符串，包括错误提示或成功的检测结果信息。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">testAlgo</span><span class="params">(Context context, String tempFilePath, <span class="type">int</span> imageRotation)</span> &#123;</span><br><span class="line">        <span class="type">Python</span> <span class="variable">py</span> <span class="operator">=</span> Python.getInstance();</span><br><span class="line">        <span class="type">Bitmap</span> <span class="variable">bitmap</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1. 检测图片模糊</span></span><br><span class="line">            <span class="type">PyObject</span> <span class="variable">isImageBlurObj</span> <span class="operator">=</span> py.getModule(<span class="string">&quot;detetion&quot;</span>).callAttr(<span class="string">&quot;is_image_blur&quot;</span>, tempFilePath);</span><br><span class="line">            <span class="type">Boolean</span> <span class="variable">isBlur</span> <span class="operator">=</span> isImageBlurObj.toJava(Boolean.class);</span><br><span class="line">            <span class="keyword">if</span> (isBlur) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;Error: 图片模糊，请提供更清晰的图像&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 加载图片</span></span><br><span class="line">            bitmap = BitmapFactory.decodeFile(tempFilePath);</span><br><span class="line">            <span class="keyword">if</span> (bitmap == <span class="literal">null</span>) &#123;</span><br><span class="line">                Log.e(<span class="string">&quot;ImageLoad&quot;</span>, <span class="string">&quot;图片加载失败&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;Error: 图片加载失败&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2. 进行 is_instrument 推理</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">boolean</span>[] instrumentFlag = <span class="keyword">new</span> <span class="title class_">boolean</span>[<span class="number">1</span>];</span><br><span class="line">            <span class="type">CountDownLatch</span> <span class="variable">latch1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 构造方法，用于初始化 ImageClassifierHelper 实例。</span></span><br><span class="line"><span class="comment">             *</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> threshold           分类结果的概率阈值（0.0f 到 1.0f）。</span></span><br><span class="line"><span class="comment">             *                            例如，设置为 0.5f 表示只有概率大于 50% 的分类结果才会被返回。</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> numThreads          运行分类任务的线程数，建议设置为 2 或 3。</span></span><br><span class="line"><span class="comment">             *                            更多的线程可能提高性能，但也会增加资源消耗。</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> maxResults          每次分类返回的最大结果数量，建议设置为 2 到 5。</span></span><br><span class="line"><span class="comment">             *                            设置为 2 表示每次分类最多返回 2 个最可能的类别。</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> currentDelegate     当前使用的委托类型，用于指定硬件加速方式等。</span></span><br><span class="line"><span class="comment">             *                            例如，设置为 0 表示使用CPU，1：GPU。</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> currentModel        当前使用的模型类型，用于指定不同的分类模型。</span></span><br><span class="line"><span class="comment">             *                            0: is_instrument     1: is_install      2. mobilenetv1</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> context             应用上下文，用于加载资源等。</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> imageClassifierListener 分类结果监听器，用于接收分类结果或错误信息。</span></span><br><span class="line"><span class="comment">             *                            通过实现 ClassifierListener 接口，可以在分类完成或出错时得到回调。</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="type">ImageClassifierHelper</span> <span class="variable">classifierInstrument</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ImageClassifierHelper</span>(CONFIDENCE_THRESHOLD,</span><br><span class="line">                    <span class="number">2</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">0</span>, context,</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">ImageClassifierHelper</span>.ClassifierListener() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(String error)</span> &#123;</span><br><span class="line">                            Log.e(<span class="string">&quot;ClassifierHelper&quot;</span>, <span class="string">&quot;is_instrument error: &quot;</span> + error);</span><br><span class="line">                            latch1.countDown();  <span class="comment">// 释放等待</span></span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onResults</span><span class="params">(List&lt;Classifications&gt; results, <span class="type">long</span> inferenceTime)</span> &#123;</span><br><span class="line">                            Log.d(<span class="string">&quot;testModel&quot;</span>, <span class="string">&quot;is_instrument 推理耗时: &quot;</span> + inferenceTime + <span class="string">&quot; ms&quot;</span>);</span><br><span class="line">                            instrumentFlag[<span class="number">0</span>] = isInstrument(results);</span><br><span class="line">                            latch1.countDown();  <span class="comment">// 释放等待</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line"></span><br><span class="line">            classifierInstrument.classify(bitmap, imageRotation);</span><br><span class="line">            latch1.await();  <span class="comment">// 等待推理完成</span></span><br><span class="line">            classifierInstrument.clearImageClassifier();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!instrumentFlag[<span class="number">0</span>]) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;Error: 未检测到仪表设备&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 3. 进行 is_install 推理</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">boolean</span>[] installFlag = <span class="keyword">new</span> <span class="title class_">boolean</span>[<span class="number">1</span>];</span><br><span class="line">            <span class="type">CountDownLatch</span> <span class="variable">latch2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            <span class="type">ImageClassifierHelper</span> <span class="variable">classifierInstall</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ImageClassifierHelper</span>(CONFIDENCE_THRESHOLD,</span><br><span class="line">                    <span class="number">2</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">1</span>, context,</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">ImageClassifierHelper</span>.ClassifierListener() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(String error)</span> &#123;</span><br><span class="line">                            Log.e(<span class="string">&quot;ClassifierHelper&quot;</span>, <span class="string">&quot;is_install error: &quot;</span> + error);</span><br><span class="line">                            latch2.countDown();  <span class="comment">// 释放等待</span></span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onResults</span><span class="params">(List&lt;Classifications&gt; results, <span class="type">long</span> inferenceTime)</span> &#123;</span><br><span class="line">                            Log.d(<span class="string">&quot;testModel&quot;</span>, <span class="string">&quot;is_install 推理耗时: &quot;</span> + inferenceTime + <span class="string">&quot; ms&quot;</span>);</span><br><span class="line">                            installFlag[<span class="number">0</span>] = isInstall(results);</span><br><span class="line">                            latch2.countDown();  <span class="comment">// 释放等待</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line"></span><br><span class="line">            classifierInstall.classify(bitmap, imageRotation);</span><br><span class="line">            latch2.await();  <span class="comment">// 等待推理完成</span></span><br><span class="line">            classifierInstall.clearImageClassifier();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> installFlag[<span class="number">0</span>] ? <span class="string">&quot;判断结果: 安装&quot;</span> : <span class="string">&quot;Error: 未安装&quot;</span>;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            Log.e(<span class="string">&quot;testAlgo&quot;</span>, <span class="string">&quot;Exception occurred&quot;</span>, e);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Error: &quot;</span> + e.toString();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (bitmap != <span class="literal">null</span> &amp;&amp; !bitmap.isRecycled()) &#123;</span><br><span class="line">                bitmap.recycle();</span><br><span class="line">            &#125;</span><br><span class="line">            deleteFile(tempFilePath);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是不是仪表的判断逻辑，根据模型推理的结果判断</span></span><br><span class="line"><span class="comment">     * 判断仪表设备：取第一个分类结果的第一个类别，</span></span><br><span class="line"><span class="comment">     * 双条件判断：类别索引必须为1，并且置信度不低于阈值。</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> results 推理返回的分类结果列表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true 表示判断为仪表设备；false 表示不是</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isInstrument</span><span class="params">(List&lt;Classifications&gt; results)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (results == <span class="literal">null</span> || results.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;Category&gt; categories = results.get(<span class="number">0</span>).getCategories();</span><br><span class="line">        <span class="keyword">if</span> (categories == <span class="literal">null</span> || categories.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Category</span> <span class="variable">topCategory</span> <span class="operator">=</span> categories.get(<span class="number">0</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">top1Index</span> <span class="operator">=</span> topCategory.getIndex();</span><br><span class="line">        <span class="type">float</span> <span class="variable">top1Conf</span> <span class="operator">=</span> topCategory.getScore();</span><br><span class="line">        <span class="type">String</span> <span class="variable">categoryName</span> <span class="operator">=</span> topCategory.getLabel();</span><br><span class="line"></span><br><span class="line">        Log.d(<span class="string">&quot;ClassifierHelper&quot;</span>, <span class="string">&quot;[Debug] 模型类别名称: &quot;</span> + categoryName);</span><br><span class="line">        Log.d(<span class="string">&quot;ClassifierHelper&quot;</span>, <span class="string">&quot;[Debug] 预测索引:&quot;</span> + top1Index + <span class="string">&quot; 置信度:&quot;</span> + String.format(<span class="string">&quot;%.2f&quot;</span>, top1Conf));</span><br><span class="line"></span><br><span class="line"><span class="comment">//        return (top1Index == 1) &amp;&amp; (top1Conf &gt;= CONFIDENCE_THRESHOLD);</span></span><br><span class="line">        <span class="keyword">return</span> (top1Conf &gt;= CONFIDENCE_THRESHOLD) &amp;&amp; (Objects.equals(categoryName, <span class="string">&quot;yibiao&quot;</span>));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否安装的判断逻辑</span></span><br><span class="line"><span class="comment">     * 判断安装情况：逻辑与 isInstrument 相同。</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> results 推理返回的分类结果列表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true 表示判断为“安装”；false 表示未安装</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isInstall</span><span class="params">(List&lt;Classifications&gt; results)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (results == <span class="literal">null</span> || results.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;Category&gt; categories = results.get(<span class="number">0</span>).getCategories();</span><br><span class="line">        <span class="keyword">if</span> (categories == <span class="literal">null</span> || categories.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Category</span> <span class="variable">topCategory</span> <span class="operator">=</span> categories.get(<span class="number">0</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">top1Index</span> <span class="operator">=</span> topCategory.getIndex();</span><br><span class="line">        <span class="type">float</span> <span class="variable">top1Conf</span> <span class="operator">=</span> topCategory.getScore();</span><br><span class="line">        <span class="type">String</span> <span class="variable">categoryName</span> <span class="operator">=</span> topCategory.getLabel();</span><br><span class="line"></span><br><span class="line">        Log.d(<span class="string">&quot;ClassifierHelper&quot;</span>, <span class="string">&quot;[Debug] 模型类别名称: &quot;</span> + categoryName);</span><br><span class="line">        Log.d(<span class="string">&quot;ClassifierHelper&quot;</span>, <span class="string">&quot;[Debug] 预测索引:&quot;</span> + top1Index + <span class="string">&quot; 置信度:&quot;</span> + String.format(<span class="string">&quot;%.2f&quot;</span>, top1Conf));</span><br><span class="line"></span><br><span class="line"><span class="comment">//        return (top1Index == 1) &amp;&amp; (top1Conf &gt;= CONFIDENCE_THRESHOLD);</span></span><br><span class="line">        <span class="keyword">return</span> (top1Conf &gt;= CONFIDENCE_THRESHOLD) &amp;&amp; (Objects.equals(categoryName, <span class="string">&quot;installed&quot;</span>));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将 assets 路径下的图片复制到缓存区。 后续读取缓存区的绝对路径，opencv 需要读取图片的绝对路径。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> context         上下文对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> assetFilePath  assets 下的图片文件名（例如 &quot;testAlgo.jpg&quot;）</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tempFilePath   缓存图片路径</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">copyFileFromAssets</span><span class="params">(Context context, String assetFilePath, String tempFilePath)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> context.getAssets().open(assetFilePath);</span><br><span class="line">             <span class="type">OutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(tempFilePath)) &#123;</span><br><span class="line">            <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">            <span class="type">int</span> length;</span><br><span class="line">            <span class="keyword">while</span> ((length = inputStream.read(buffer)) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                outputStream.write(buffer, <span class="number">0</span>, length);</span><br><span class="line">            &#125;</span><br><span class="line">            outputStream.flush();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            Log.e(<span class="string">&quot;FileUtils&quot;</span>, <span class="string">&quot;Error copying file from assets: &quot;</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除缓存区的图片</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> filePath 图片的路径</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">deleteFile</span><span class="params">(String filePath)</span> &#123;</span><br><span class="line">        <span class="comment">// 创建 File 对象</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(filePath);</span><br><span class="line">        <span class="keyword">if</span> (file.exists()) &#123;</span><br><span class="line">            <span class="comment">// 删除文件</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">isDeleted</span> <span class="operator">=</span> file.delete();</span><br><span class="line">            <span class="keyword">if</span> (isDeleted) &#123;</span><br><span class="line">                <span class="comment">// 删除成功</span></span><br><span class="line">                Log.d(<span class="string">&quot;FileDeletion&quot;</span>, <span class="string">&quot;文件删除成功: &quot;</span> + filePath);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 删除失败</span></span><br><span class="line">                Log.e(<span class="string">&quot;FileDeletion&quot;</span>, <span class="string">&quot;文件删除失败: &quot;</span> + filePath);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 文件不存在</span></span><br><span class="line">            Log.d(<span class="string">&quot;FileDeletion&quot;</span>, <span class="string">&quot;文件不存在: &quot;</span> + filePath);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><em>tensorflow</em> 提供的 <em>Category</em> 类，后续需要拿哪些数据可以查看 <em>get</em> 方法:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@UsedByReflection(&quot;TFLiteSupport/Task&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Category</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">DEFAULT_INDEX</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">float</span> <span class="variable">TOLERANCE</span> <span class="operator">=</span> <span class="number">1.0E-6F</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> index;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String label;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String displayName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">float</span> score;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@UsedByReflection(&quot;TFLiteSupport/Task&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Category <span class="title function_">create</span><span class="params">(String label, String displayName, <span class="type">float</span> score, <span class="type">int</span> index)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Category</span>(label, displayName, score, index);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@UsedByReflection(&quot;TFLiteSupport/Task&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Category <span class="title function_">create</span><span class="params">(String label, String displayName, <span class="type">float</span> score)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Category</span>(label, displayName, score, -<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@UsedByReflection(&quot;TFLiteSupport/Task&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Category</span><span class="params">(String label, <span class="type">float</span> score)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(label, <span class="string">&quot;&quot;</span>, score, -<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Category</span><span class="params">(String label, String displayName, <span class="type">float</span> score, <span class="type">int</span> index)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.label = label;</span><br><span class="line">        <span class="built_in">this</span>.displayName = displayName;</span><br><span class="line">        <span class="built_in">this</span>.score = score;</span><br><span class="line">        <span class="built_in">this</span>.index = index;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getLabel</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.label;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getDisplayName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.displayName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">float</span> <span class="title function_">getScore</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.score;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getIndex</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.index;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!(o <span class="keyword">instanceof</span> Category)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">Category</span> <span class="variable">other</span> <span class="operator">=</span> (Category)o;</span><br><span class="line">            <span class="keyword">return</span> other.getLabel().equals(<span class="built_in">this</span>.label) &amp;&amp; other.getDisplayName().equals(<span class="built_in">this</span>.displayName) &amp;&amp; Math.abs(other.getScore() - <span class="built_in">this</span>.score) &lt; <span class="number">1.0E-6F</span> &amp;&amp; other.getIndex() == <span class="built_in">this</span>.index;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Objects.hash(<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="built_in">this</span>.label, <span class="built_in">this</span>.displayName, <span class="built_in">this</span>.score, <span class="built_in">this</span>.index&#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&lt;Category \&quot;&quot;</span> + <span class="built_in">this</span>.label + <span class="string">&quot;\&quot; (displayName=&quot;</span> + <span class="built_in">this</span>.displayName + <span class="string">&quot; score=&quot;</span> + <span class="built_in">this</span>.score + <span class="string">&quot; index=&quot;</span> + <span class="built_in">this</span>.index + <span class="string">&quot;)&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="测试结果"><a class="markdownIt-Anchor" href="#测试结果"></a> 测试结果</h3><blockquote><p>使用 模糊图片：vague.jpg</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 测试 算法判断逻辑 testAlgo</span></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">testAlgo</span><span class="params">()</span> &#123;</span><br><span class="line">     <span class="type">String</span> <span class="variable">assetFilePath</span> <span class="operator">=</span> <span class="string">&quot;uninstall.jpg&quot;</span>;</span><br><span class="line">     <span class="type">String</span> <span class="variable">tempDir</span> <span class="operator">=</span> getCacheDir().getAbsolutePath();</span><br><span class="line">     <span class="comment">// 复制到缓存区以获得绝对路径</span></span><br><span class="line">     <span class="type">String</span> <span class="variable">tempFilePath</span> <span class="operator">=</span> tempDir + <span class="string">&quot;/&quot;</span> + assetFilePath;</span><br><span class="line">     <span class="comment">// 将图片从 assets 目录复制到临时目录</span></span><br><span class="line">     test.copyFileFromAssets(<span class="built_in">this</span>, assetFilePath, tempFilePath);</span><br><span class="line"></span><br><span class="line">     <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> test.testAlgo(<span class="built_in">this</span>, tempFilePath, <span class="number">0</span>);</span><br><span class="line">     Log.d(<span class="string">&quot;testAlgo&quot;</span>, s);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/Android/202503131409708.png" alt="image-20250313140926419" /></p></blockquote><blockquote><p>使用 不是仪表的图片：mouse.jpg</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 测试 算法判断逻辑 testAlgo</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">testAlgo</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">assetFilePath</span> <span class="operator">=</span> <span class="string">&quot;mouse.jpg&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">tempDir</span> <span class="operator">=</span> getCacheDir().getAbsolutePath();</span><br><span class="line">    <span class="comment">// 复制到缓存区以获得绝对路径</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">tempFilePath</span> <span class="operator">=</span> tempDir + <span class="string">&quot;/&quot;</span> + assetFilePath;</span><br><span class="line">    <span class="comment">// 将图片从 assets 目录复制到临时目录</span></span><br><span class="line">    test.copyFileFromAssets(<span class="built_in">this</span>, assetFilePath, tempFilePath);</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> test.testAlgo(<span class="built_in">this</span>, tempFilePath, <span class="number">0</span>);</span><br><span class="line">    Log.d(<span class="string">&quot;testAlgo&quot;</span>, s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/Android/202503131412572.png" alt="image-20250313141212485" /></p></blockquote><blockquote><p>使用 仪表未安装的图片：uninstall.jpg</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 测试 算法判断逻辑 testAlgo</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">testAlgo</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">assetFilePath</span> <span class="operator">=</span> <span class="string">&quot;uninstall.jpg&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">tempDir</span> <span class="operator">=</span> getCacheDir().getAbsolutePath();</span><br><span class="line">    <span class="comment">// 复制到缓存区以获得绝对路径</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">tempFilePath</span> <span class="operator">=</span> tempDir + <span class="string">&quot;/&quot;</span> + assetFilePath;</span><br><span class="line">    <span class="comment">// 将图片从 assets 目录复制到临时目录</span></span><br><span class="line">    test.copyFileFromAssets(<span class="built_in">this</span>, assetFilePath, tempFilePath);</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> test.testAlgo(<span class="built_in">this</span>, tempFilePath, <span class="number">0</span>);</span><br><span class="line">    Log.d(<span class="string">&quot;testAlgo&quot;</span>, s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/Android/202503131413469.png" alt="image-20250313141343393" /></p></blockquote><blockquote><p>使用 正常安装的仪表图片：normal.jpg</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 测试 算法判断逻辑 testAlgo</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">testAlgo</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">assetFilePath</span> <span class="operator">=</span> <span class="string">&quot;normal.jpg&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">tempDir</span> <span class="operator">=</span> getCacheDir().getAbsolutePath();</span><br><span class="line">    <span class="comment">// 复制到缓存区以获得绝对路径</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">tempFilePath</span> <span class="operator">=</span> tempDir + <span class="string">&quot;/&quot;</span> + assetFilePath;</span><br><span class="line">    <span class="comment">// 将图片从 assets 目录复制到临时目录</span></span><br><span class="line">    test.copyFileFromAssets(<span class="built_in">this</span>, assetFilePath, tempFilePath);</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> test.testAlgo(<span class="built_in">this</span>, tempFilePath, <span class="number">0</span>);</span><br><span class="line">    Log.d(<span class="string">&quot;testAlgo&quot;</span>, s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/Android/202503131414341.png" alt="image-20250313141459263" /></p></blockquote><h3 id="失败尝试"><a class="markdownIt-Anchor" href="#失败尝试"></a> 失败尝试</h3><ul><li><blockquote><p>算法使用 <em>yolov8n-cls</em> 预训练模型再使用数据集进行训练得到 <em>.pt</em> 模型文件，由于是基于 <em>pytorch</em> 训练的，模型的输入和神经网络的一些内部结构与 <em>tensorflow</em> 不兼容，在 <em>github</em> 上找到了 <em>pytorch</em> 官方安卓项目例程：</p><p><a href="https://github.com/pytorch/android-demo-app">https://github.com/pytorch/android-demo-app</a></p><p>集成到此安卓项目后，官方提供的 <em><a href="http://model.pt">model.pt</a></em> 模型文件可以跑通，但是通过 <em>yolo</em> 训练得到的模型文件会报错：</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/Android/202503131230661.png" alt="image-20250313123051589" /></p><p>可能是版本不兼容的问题，也有可能与 <em>yolo</em> 模型内部的结构有关。</p></blockquote></li><li><blockquote><p>算法在预训练模型 <em>mobilenet</em> 的基础上采用 <em>tensorflow</em> 进行训练，转换成 <em>tflite</em> 模型文件后，出现错误：</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/Android/202503131231057.png" alt="image-20250313123135002" /></p><p>原因是找不到模型的 <strong>元数据</strong> ，尝试 <em>tensorflow</em> 官方提供的添加元数据的脚本文件：</p><p><a href="https://github.com/tensorflow/examples/tree/master/lite/examples/image_classification/metadata">https://github.com/tensorflow/examples/tree/master/lite/examples/image_classification/metadata</a></p><p>会出现很多的 <em>python</em> 环境包冲突问题</p></blockquote></li></ul>]]></content>
      
      
      <categories>
          
          <category> 环境搭建 </category>
          
          <category> 视觉 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> OpenCV </tag>
            
            <tag> Java </tag>
            
            <tag> Python </tag>
            
            <tag> Pytorch </tag>
            
            <tag> TFlite </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>安卓项目集成python环境</title>
      <link href="/2025/05/19/%E5%AE%89%E5%8D%93%E9%A1%B9%E7%9B%AE%E9%9B%86%E6%88%90python%E7%8E%AF%E5%A2%83/"/>
      <url>/2025/05/19/%E5%AE%89%E5%8D%93%E9%A1%B9%E7%9B%AE%E9%9B%86%E6%88%90python%E7%8E%AF%E5%A2%83/</url>
      
        <content type="html"><![CDATA[<h2 id="集成-chaquopy"><a class="markdownIt-Anchor" href="#集成-chaquopy"></a> 集成 Chaquopy</h2><h3 id="配置环境"><a class="markdownIt-Anchor" href="#配置环境"></a> 配置环境</h3><p>在顶级 <em>build.gradle</em>  中加入：</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">plugins &#123;</span><br><span class="line">       id <span class="string">&quot;com.chaquo.python&quot;</span> version <span class="string">&quot;15.0.1&quot;</span> apply <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在模块级 <em>build.gradle</em> 中加入：</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">plugins &#123;</span><br><span class="line">    id <span class="string">&quot;com.chaquo.python&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">         ndk &#123;</span><br><span class="line">            abiFilters <span class="string">&quot;arm64-v8a&quot;</span>, <span class="string">&quot;x86_64&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">chaquopy &#123;</span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">    <span class="comment">// 替换路径 我使用的是 python 3.8.19</span></span><br><span class="line">        buildPython(<span class="string">&quot;D:\\Users\\L\\anaconda3\\envs\\yolo\\python.exe&quot;</span>)</span><br><span class="line">        version = <span class="string">&quot;3.8&quot;</span></span><br><span class="line">        pip &#123;</span><br><span class="line">            options(<span class="string">&quot;--index-url&quot;</span>, <span class="string">&quot;https://chaquo.com/pypi-13.1/&quot;</span>)</span><br><span class="line">            <span class="comment">// A requirement specifier, with or without a version number:</span></span><br><span class="line">            install(<span class="string">&quot;numpy&quot;</span>)</span><br><span class="line">            install(<span class="string">&quot;opencv-python&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment">// &quot;-r&quot;` followed by a requirements filename, relative to the project directory:</span></span><br><span class="line">            <span class="comment">//  install(&quot;-r&quot;, &quot;requirements.txt&quot;)</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    productFlavors &#123; &#125;</span><br><span class="line">    sourceSets &#123;</span><br><span class="line">        getByName(<span class="string">&quot;main&quot;</span>) &#123;</span><br><span class="line">            srcDir(<span class="string">&quot;src/main/python&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>版本兼容表：</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/Android/202503062114297.png" alt="image-20250306211455240" /></p><p>[<a href="https://chaquo.com/chaquopy/doc/current/versions.html">Version summary - Chaquopy</a>](<a href="https://chaquo.com/chaquopy/doc/current/versions.html">https://chaquo.com/chaquopy/doc/current/versions.html</a>)</p><p>包仓库：</p><p><a href="https://chaquo.com/pypi-13.1/">https://chaquo.com/pypi-13.1/</a></p><p>全局使用 <em>python</em> ，在 <em>AndroidManifest.xml</em> 中的 <em>&lt;application…/&gt;</em> 添加以下属性:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android:name=&quot;com.chaquo.python.android.PyApplication&quot;</span><br></pre></td></tr></table></figure><p>官方文档：[<a href="https://chaquo.com/chaquopy/doc/15.0/">Chaquopy 15.0</a>](<a href="https://chaquo.com/chaquopy/doc/15.0/">https://chaquo.com/chaquopy/doc/15.0/</a>)</p><h3 id="编写程序验证"><a class="markdownIt-Anchor" href="#编写程序验证"></a> 编写程序验证</h3><p>在 <em>src/main/</em> 新建 <em>pyhton</em> 文件夹存放 <em>python</em> 文件 <em><a href="http://algoTest.py">algoTest.py</a></em></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">algoFunc</span>(<span class="params">code, imgAddressList</span>):</span><br><span class="line">    res = <span class="string">&quot;error&quot;</span></span><br><span class="line">    <span class="keyword">if</span> code == <span class="string">&quot;1&quot;</span>:</span><br><span class="line">        res = algo1(imgAddressList)</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">algo1</span>(<span class="params">imgAddressList</span>):</span><br><span class="line">    <span class="comment"># OpenCV 测试程序</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 遍历Java的ArrayList对象</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(imgAddressList.size()):</span><br><span class="line">            img_path = imgAddressList.get(i)</span><br><span class="line">            <span class="built_in">print</span>(img_path)</span><br><span class="line">            img = cv2.imread(img_path)</span><br><span class="line">            <span class="keyword">if</span> img <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="comment"># 如果图像加载成功，返回成功信息</span></span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;成功加载图像：&quot;</span> + img_path + <span class="string">&quot; &quot;</span> +  cv2.__version__</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;图像加载失败：&quot;</span> + img_path + <span class="string">&quot; &quot;</span> + cv2.__version__</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;OpenCV 测试失败：&quot;</span> + <span class="built_in">str</span>(e)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>新建 <em>algo</em> 文件夹，新建 <em>test</em> 类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.gxl_recognitionsystem.algo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Bitmap;</span><br><span class="line"><span class="keyword">import</span> android.graphics.BitmapFactory;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.chaquo.python.PyObject;</span><br><span class="line"><span class="keyword">import</span> com.chaquo.python.Python;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.tensorflow.lite.task.vision.classifier.Classifications;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test</span> &#123;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">testPython</span><span class="params">(Context context, String code, ArrayList&lt;String&gt; imgAddressArrayList)</span> &#123;</span><br><span class="line">        <span class="type">Python</span> <span class="variable">py</span> <span class="operator">=</span> Python.getInstance();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 转换数据类型，将路径传递给 Python</span></span><br><span class="line">            List&lt;PyObject&gt; imgAddressList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;PyObject&gt;();</span><br><span class="line">            <span class="keyword">for</span> (String imgPath : imgAddressArrayList) &#123;</span><br><span class="line">                imgAddressList.add(PyObject.fromJava(imgPath));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">PyObject</span> <span class="variable">result</span> <span class="operator">=</span> py.getModule(<span class="string">&quot;algoTest&quot;</span>).callAttr(<span class="string">&quot;algoFunc&quot;</span>, code, imgAddressList);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 将 Python 返回值转换为 Java 字符串</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">response</span> <span class="operator">=</span> result.toJava(String.class);</span><br><span class="line">            Log.d(<span class="string">&quot;PythonCall&quot;</span>, <span class="string">&quot;Response from Python: &quot;</span> + response);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            Log.e(<span class="string">&quot;PythonCall&quot;</span>, <span class="string">&quot;Error accessing assets: &quot;</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将 assets 路径下的图片复制到缓存区。 后续读取缓存区的绝对路径，opencv 需要读取图片的绝对路径。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> context         上下文对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> assetFilePath  assets 下的图片文件名（例如 &quot;testAlgo.jpg&quot;）</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tempFilePath   缓存图片路径</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">copyFileFromAssets</span><span class="params">(Context context, String assetFilePath, String tempFilePath)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> context.getAssets().open(assetFilePath);</span><br><span class="line">             <span class="type">OutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(tempFilePath)) &#123;</span><br><span class="line">            <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">            <span class="type">int</span> length;</span><br><span class="line">            <span class="keyword">while</span> ((length = inputStream.read(buffer)) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                outputStream.write(buffer, <span class="number">0</span>, length);</span><br><span class="line">            &#125;</span><br><span class="line">            outputStream.flush();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            Log.e(<span class="string">&quot;FileUtils&quot;</span>, <span class="string">&quot;Error copying file from assets: &quot;</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><!--因为opencv需要使用绝对路径读取图片，所以将assets里的图片复制到缓存区，再用opencv读取缓存区图片路径--><p>在 <em>Adminstrators_MainActivity</em> 中加入：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.chaquo.python.android.AndroidPlatform;</span><br><span class="line"><span class="keyword">import</span> com.chaquo.python.Python;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Administrators_MainActivity</span> <span class="keyword">extends</span> <span class="title class_">Activity</span> <span class="keyword">implements</span> <span class="title class_">View</span>.OnClickListener &#123;</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line"><span class="comment">// 初始化Python环境</span></span><br><span class="line">    initPython();</span><br><span class="line">    testPythonCode();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 初始化Python环境</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initPython</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (! Python.isStarted()) &#123;</span><br><span class="line">            Python.start(<span class="keyword">new</span> <span class="title class_">AndroidPlatform</span>(<span class="built_in">this</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用python代码</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">testPythonCode</span><span class="params">()</span> &#123;</span><br><span class="line">        ArrayList&lt;String&gt; assetsImgList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        ArrayList&lt;String&gt; tempDirImgList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        assetsImgList.add(<span class="string">&quot;testAlgo.jpg&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">tempDir</span> <span class="operator">=</span> getCacheDir().getAbsolutePath();</span><br><span class="line">        <span class="comment">// 复制到缓存区以获得绝对路径</span></span><br><span class="line">        <span class="keyword">for</span> (String assetFilePath  : assetsImgList) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">tempFilePath</span> <span class="operator">=</span> tempDir + <span class="string">&quot;/&quot;</span> + assetFilePath;</span><br><span class="line">            tempDirImgList.add(tempFilePath);</span><br><span class="line">            <span class="comment">// 将图片从 assets 目录复制到临时目录</span></span><br><span class="line">            FileUtils.copyFileFromAssets(<span class="built_in">this</span>, assetFilePath, tempFilePath);</span><br><span class="line">        &#125;</span><br><span class="line">        testAlgo.testPython(<span class="built_in">this</span>, <span class="string">&quot;1&quot;</span>, tempDirImgList);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行，测试结果如下：</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/Android/202503062115064.png" alt="image-20250306211537016" /></p><p>/data/user/0/com.gxl_recognitionsystem/cache/testAlgo.jpg 是图片在安卓手机上的绝对路径</p><p>4.5.1 是 <em>opencv</em> 的版本号</p>]]></content>
      
      
      <categories>
          
          <category> 环境搭建 </category>
          
          <category> 视觉 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> OpenCV </tag>
            
            <tag> Java </tag>
            
            <tag> Python </tag>
            
            <tag> Chaquopy </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>安装cuda和pytorch</title>
      <link href="/2025/05/19/%E5%AE%89%E8%A3%85cuda%E5%92%8Cpytorch/"/>
      <url>/2025/05/19/%E5%AE%89%E8%A3%85cuda%E5%92%8Cpytorch/</url>
      
        <content type="html"><![CDATA[<h2 id="查看显卡驱动版本"><a class="markdownIt-Anchor" href="#查看显卡驱动版本"></a> 查看显卡驱动版本</h2><p>查看cuda版本支持：</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/linux_camera/202503111803366.png" alt="image-20250311180335312" /></p><p>终端输入：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nvidia-smi</span><br></pre></td></tr></table></figure><p>最高支持12.7</p><p>下载CUDA Toolkit 12.6 Update 3</p><h2 id="创建conda环境"><a class="markdownIt-Anchor" href="#创建conda环境"></a> 创建conda环境</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">conda create -n env-name python=3.11.5</span><br></pre></td></tr></table></figure><h2 id="下载pytorch"><a class="markdownIt-Anchor" href="#下载pytorch"></a> 下载pytorch</h2><p>[<a href="https://pytorch.org/get-started/locally/">Start Locally | PyTorch</a>](<a href="https://pytorch.org/get-started/locally/">https://pytorch.org/get-started/locally/</a>)</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/linux_camera/202503111854319.png" alt="image-20250311185414247" /></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu126</span><br></pre></td></tr></table></figure><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/linux_camera/202503111900945.png" alt="image-20250311190011897" /></p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/linux_camera/202503111859376.png" alt="image-20250311185958340" /></p><h2 id="卸载pytorch"><a class="markdownIt-Anchor" href="#卸载pytorch"></a> 卸载pytorch</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip uninstall torch torchvision torchaudio</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 环境搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Cuda </tag>
            
            <tag> Pytorch </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vscode与cmake</title>
      <link href="/2025/05/19/vscode%E4%B8%8Ecmake/"/>
      <url>/2025/05/19/vscode%E4%B8%8Ecmake/</url>
      
        <content type="html"><![CDATA[<h2 id="vscode-使用-cmake-构建工程"><a class="markdownIt-Anchor" href="#vscode-使用-cmake-构建工程"></a> vscode 使用 cmake 构建工程</h2><h3 id="多文件编译"><a class="markdownIt-Anchor" href="#多文件编译"></a> 多文件编译：</h3><ul><li><p>指定cmake 编译器 g++ ;</p></li><li><ul><li>CMakeLists.txt文件中</li><li><ul><li>setexcable</li><li>add_definitions(&quot;-Wall -g&quot;)</li></ul></li></ul></li><li><p>在build 文件夹下 执行<code>cmake -G &quot;MinGW Makefiles&quot; ..</code>，会在build 文件夹下生成makefile</p></li><li><p>windows 下的 make： mingw32-make.exe</p></li></ul><blockquote><p>更改后若要调试，先用cmake 和 mingw32-make.exe生成一下可执行文件，或者编写tasks.json</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 环境搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C++ </tag>
            
            <tag> Vscode </tag>
            
            <tag> Camke </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vscode与clangd</title>
      <link href="/2025/05/19/vscode%E4%B8%8Eclangd/"/>
      <url>/2025/05/19/vscode%E4%B8%8Eclangd/</url>
      
        <content type="html"><![CDATA[<h2 id="vscode-安装-clangd-出现找不到头文件"><a class="markdownIt-Anchor" href="#vscode-安装-clangd-出现找不到头文件"></a> vscode 安装 clangd 出现找不到头文件</h2><h3 id="编写settingsjson"><a class="markdownIt-Anchor" href="#编写settingsjson"></a> 编写settings.json</h3><p>在 <code>.vscode</code> 目录下的 <code>setting.json</code> 中加入</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;clangd.arguments&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;--background-index&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;--compile-commands-dir=build&quot;</span><span class="punctuation">,</span>  <span class="comment">//compile_command.json相对路径，cmake默认生成在build，自行配置</span></span><br><span class="line">        <span class="string">&quot;-j=12&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;--all-scopes-completion&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;--completion-style=detailed&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;--header-insertion=iwyu&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;--pch-storage=memory&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;--cross-file-rename&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;--enable-config&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;--fallback-style=WebKit&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;--pretty&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;--clang-tidy&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="comment">// 网上别人配置clang++，但我这边windows、linux实测不加这行也没啥问题，可能mac可能需要另外加</span></span><br><span class="line">        <span class="string">&quot;--query-driver=C:/mingw/bin/g*&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br></pre></td></tr></table></figure><h3 id="更好地方法"><a class="markdownIt-Anchor" href="#更好地方法"></a> 更好地方法</h3><p>在项目根目录下创建 <code>.clangd</code>  文件</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Fragment common to C and C++ source files</span></span><br><span class="line"><span class="attr">CompileFlags:</span></span><br><span class="line">    <span class="attr">Add:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;--include-directory=./include&quot;</span>   <span class="string">//</span> <span class="string">相对路径</span></span><br><span class="line"> <span class="bullet">-</span> <span class="string">&quot;--include-directory=C:/code_project/cfiles test/include&quot;</span>   <span class="string">//</span> <span class="string">绝对路径</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 环境搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C++ </tag>
            
            <tag> Vscode </tag>
            
            <tag> Clangd </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>git指南</title>
      <link href="/2025/05/19/git%E6%8C%87%E5%8D%97/"/>
      <url>/2025/05/19/git%E6%8C%87%E5%8D%97/</url>
      
        <content type="html"><![CDATA[<h2 id="新建仓库"><a class="markdownIt-Anchor" href="#新建仓库"></a> 新建仓库</h2><h3 id="远程仓库"><a class="markdownIt-Anchor" href="#远程仓库"></a> 远程仓库</h3><p>在 <code>github</code> 上创建新仓库</p><h3 id="本地仓库"><a class="markdownIt-Anchor" href="#本地仓库"></a> 本地仓库</h3><p><code>github</code> 已经创建新仓库，使用以下命令初始化本地仓库并推送到远程仓库</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">进入项目根目录</span></span><br><span class="line">cd ~/your-project-folder</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">初始化 Git 仓库</span></span><br><span class="line">git init</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建 .gitignore 文件（可选）</span></span><br><span class="line">echo &quot;*.log&quot; &gt;&gt; .gitignore</span><br><span class="line">echo &quot;tmp/&quot; &gt;&gt; .gitignore</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">添加所有文件到暂存区</span></span><br><span class="line">git add .</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">提交代码</span></span><br><span class="line">git commit -m &quot;初始提交：***项目&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">关联远程仓库（替换 YOUR-USERNAME）</span></span><br><span class="line">git remote add origin https://github.com/YOUR-USERNAME/nginx-streaming-demos.git</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">推送到 GitHub</span></span><br><span class="line">git branch -M main</span><br><span class="line">git push -u origin main</span><br></pre></td></tr></table></figure><h2 id="已有远程仓库与本地仓库"><a class="markdownIt-Anchor" href="#已有远程仓库与本地仓库"></a> 已有远程仓库与本地仓库</h2><p>有修改，需更新</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看当前分支</span></span><br><span class="line">git branch</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果要切换到其他分支</span></span><br><span class="line">git checkout &lt;branch-name&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将更改添加到本地暂存区</span></span><br><span class="line">git add .</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果只是指定文件</span></span><br><span class="line">git add &lt;file-name&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">提交更改</span></span><br><span class="line">git commit -m &quot;Your commit message&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">推送</span></span><br><span class="line">git push</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果没有设置上游分支，要指定分支</span></span><br><span class="line">git push origin &lt;branch-name&gt;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Git </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>nuxt3项目使用docker部署在华为云上</title>
      <link href="/2025/05/19/nuxt3%E9%A1%B9%E7%9B%AE%E4%BD%BF%E7%94%A8docker%E9%83%A8%E7%BD%B2%E5%9C%A8%E5%8D%8E%E4%B8%BA%E4%BA%91%E4%B8%8A/"/>
      <url>/2025/05/19/nuxt3%E9%A1%B9%E7%9B%AE%E4%BD%BF%E7%94%A8docker%E9%83%A8%E7%BD%B2%E5%9C%A8%E5%8D%8E%E4%B8%BA%E4%BA%91%E4%B8%8A/</url>
      
        <content type="html"><![CDATA[<h2 id="购买华为云服务器"><a class="markdownIt-Anchor" href="#购买华为云服务器"></a> 购买华为云服务器</h2><h3 id="配置"><a class="markdownIt-Anchor" href="#配置"></a> 配置</h3><h4 id="付费模式"><a class="markdownIt-Anchor" href="#付费模式"></a> 付费模式</h4><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/606a3b3a7b41b9e1a8804ada1bcff486.png" alt="image-20240514100751274" /></p><h4 id="硬件"><a class="markdownIt-Anchor" href="#硬件"></a> 硬件</h4><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/3cb353f0c0b39f7b7ea6df41b69db8bb.png" alt="image-20240514100833326" /></p><h4 id="操作系统"><a class="markdownIt-Anchor" href="#操作系统"></a> 操作系统</h4><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/7deb4a1d93f694f1c0030d9c38ce9806.png" alt="image-20240515104651134" /></p><h4 id="网络配置"><a class="markdownIt-Anchor" href="#网络配置"></a> 网络配置</h4><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/adcd3a9337af940c458a915d8fc82baa.png" alt="image-20240514101126668" /></p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/0d3932486fa10c25fa9669c3036c9385.png" alt="image-20240514101138055" /></p><h4 id="高级配置"><a class="markdownIt-Anchor" href="#高级配置"></a> 高级配置</h4><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/2adeeb4a7b3e752dc462a91dfe68f423.png" alt="image-20240515093631584" /></p><p>记录密码，后续远程登录时要用。</p><h4 id="确认配置"><a class="markdownIt-Anchor" href="#确认配置"></a> 确认配置</h4><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/fcb68d2a4e4b5738f6dd53a135a45ded.png#pic_center" alt="image-20240514101520005" /></p><h2 id="服务器安装docker"><a class="markdownIt-Anchor" href="#服务器安装docker"></a> 服务器安装docker</h2><h3 id="远程登录"><a class="markdownIt-Anchor" href="#远程登录"></a> 远程登录</h3><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/832715cddcf015fde59a9d5960b3c286.png" alt="image-20240514101719060" /></p><h4 id="安装yum工具"><a class="markdownIt-Anchor" href="#安装yum工具"></a> 安装yum工具</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install -y yum-utils \</span><br><span class="line">           device-mapper-persistent-data \</span><br><span class="line">           lvm2 --skip-broken</span><br></pre></td></tr></table></figure><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/6d424099e865f22c09f37d9b56ad2a85.png" alt="image-20240514102553996" /></p><p>然后更新本地镜像源：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">yum-config-manager \</span><br><span class="line">    --add-repo \</span><br><span class="line">    https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line">    </span><br><span class="line">sed -i &#x27;s/download.docker.com/mirrors.aliyun.com\/docker-ce/g&#x27; /etc/yum.repos.d/docker-ce.repo</span><br><span class="line"></span><br><span class="line">yum makecache fast</span><br></pre></td></tr></table></figure><h4 id="docker"><a class="markdownIt-Anchor" href="#docker"></a> docker</h4><p>docker版本：</p><p>CE( Community Edition)是社区版，简单理解是免费使用，提供小企业与小的IT团队使用,希望从Docker开始，并尝试基于容器的应用程序部署。</p><p>EE(Docker Enterprise Edition)是企业版，收费。提供功能更强。适合大企业与打的IT团队。为企业开发和IT团队设计，他们在生产中构建、交付和运行业务关键应用程序</p><p>安装docker</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y docker-ce</span><br></pre></td></tr></table></figure><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/7ceac64871bc86c576dea432401a419b.png#pic_center" alt="image-20240514103152379" /></p><p>系统启动时自动启动docker</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable docker</span><br></pre></td></tr></table></figure><p>启动docker</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start docker </span><br></pre></td></tr></table></figure><h4 id="配置docker镜像加速"><a class="markdownIt-Anchor" href="#配置docker镜像加速"></a> 配置docker镜像加速</h4><p>docker官方镜像仓库网速较差，我们需要设置国内镜像服务：</p><p>参考阿里云的镜像加速文档：<a href="https://cr.console.aliyun.com/cn-hangzhou/instances/mirrors">https://cr.console.aliyun.com/cn-hangzhou/instances/mirrors</a></p><h2 id="项目打包"><a class="markdownIt-Anchor" href="#项目打包"></a> 项目打包</h2><h3 id="nuxt3项目打包"><a class="markdownIt-Anchor" href="#nuxt3项目打包"></a> nuxt3项目打包</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm run build</span><br></pre></td></tr></table></figure><p>打包后，在.output目录里就是打包好的SSR项目文件。</p><p>在.output/下创建个Dockerfile文件。这个里面是编写的docker项目运行环境、打包镜像和运行项目命令的一个配置文件。</p><p>查看开发所用的 node 版本</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/e06821ad0b0e290f658dd9c6b3787551.png" alt="image-20240514104518281" /></p><h4 id="新建dockerfile"><a class="markdownIt-Anchor" href="#新建dockerfile"></a> 新建dockerfile</h4><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/50a8ed1165571852f0cf2a3502955fb6.png" alt="image-20240514142710386" /></p><h4 id="编写dockerfile"><a class="markdownIt-Anchor" href="#编写dockerfile"></a> 编写dockerfile</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 基于镜像node版本</span></span></span><br><span class="line">FROM node:18.18.0</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 参数，node的环境为生产环境</span></span></span><br><span class="line">ENV NODE_ENV=production</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 任意ip</span></span></span><br><span class="line">ENV HOST 0.0.0.0</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 容器内创建目录/nuxt3</span></span></span><br><span class="line">RUN mkdir -p /nuxt3</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 复制当前的内容到容器内容部目录/nuxt3</span></span></span><br><span class="line">COPY . /nuxt3/</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 切换工作目录到/nuxt3</span></span></span><br><span class="line">WORKDIR /nuxt3</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 暴露端口3000，默认端口</span></span></span><br><span class="line">EXPOSE 3000</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># start</span></span></span><br><span class="line">CMD [&quot;node&quot;,&quot;./server/index.mjs&quot;]</span><br></pre></td></tr></table></figure><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/fa753c53b9864f98f8ee5a0bf272da8b.png" alt="image-20240514105724143" /></p><h4 id="打包项目"><a class="markdownIt-Anchor" href="#打包项目"></a> 打包项目</h4><p>使用7-zip把public、server、dockerfile、nitro.json都压缩到nuxt.tar</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/bb5c33807560f7d04665a68a4aff43ff.png" alt="image-20240514125935332" /></p><p>在服务器home目录下创建web文件夹</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/9b9bae96dff6943f9bfe5e0ef3dbe162.png" alt="image-20240514130020178" /></p><h3 id="上传到服务器"><a class="markdownIt-Anchor" href="#上传到服务器"></a> 上传到服务器</h3><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/6b874e50f36cc4de113aa0836cd83130.png" alt="image-20240514130036487" /></p><p>转到web目录下</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /</span><br><span class="line">cd home/web</span><br><span class="line">ls</span><br></pre></td></tr></table></figure><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/d00b486ccb707fde418b14e0d59f5d5b.png" alt="image-20240514130220214" /></p><h4 id="解压tar文件"><a class="markdownIt-Anchor" href="#解压tar文件"></a> 解压tar文件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -xvf nuxt.tar</span><br></pre></td></tr></table></figure><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/37c2cb6dc852a5aef589a40183c8fe7e.png" alt="image-20240514130450877" /></p><h4 id="构建镜像"><a class="markdownIt-Anchor" href="#构建镜像"></a> 构建镜像</h4><p>名称为group_web</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t group_web .</span><br></pre></td></tr></table></figure><p>使用以下命令查看是否创建成功</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker images</span><br></pre></td></tr></table></figure><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/7db49a3ba78df6bb9ca0fe18a52644f7.png" alt="image-20240514132050509" /></p><h4 id="创建容器"><a class="markdownIt-Anchor" href="#创建容器"></a> 创建容器</h4><p>创建一个运行该镜像的容器，命名为my_group_web，并映射端口（服务器端口：容器端口）</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name my_group_web -d -p 9020:3000 group_web</span><br></pre></td></tr></table></figure><p>查看容器</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker ps //正在运行的容器</span><br><span class="line">or</span><br><span class="line">docker ps -a //所有容器</span><br></pre></td></tr></table></figure><h4 id="访问项目"><a class="markdownIt-Anchor" href="#访问项目"></a> 访问项目</h4><p>地址：<strong>公网ip:9020</strong></p><p>如果打不开请检查服务器安全组<br /><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/fe5ee2ac7429456d2e77bc8bab756711.png#pic_center" alt="image-20240514144636841" /></p><p>选中WebServer，嫌麻烦直接选中FullAccess，然后再次访问即可。</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/2dfc0a9e6d062ebb5ff662cfff886c16.png" alt="image-20240514144700411" /></p><p>进入安全组：</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/a4447420f19d7b304092a5602e30df7c.png" alt="image-20240514144408471" /></p><p>配置规则</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/c52daa75151275c78eeaaeb9f93171ca.png" alt="image-20240514144442604" /></p><p>添加规则即可</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/495c60ecdd79f9e41a396623d8649984.png" alt="image-20240514144511788" /></p><h2 id="更新项目"><a class="markdownIt-Anchor" href="#更新项目"></a> 更新项目</h2><p>需要执行：<strong>停止容器、删除容器、重新进行项目打包、创建并运行镜像。</strong></p><p>查看容器</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker ps</span><br></pre></td></tr></table></figure><p>停止容器</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker stop my_group_web</span><br></pre></td></tr></table></figure><p>删除容器</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker rm -f my_group_web</span><br></pre></td></tr></table></figure><p>查看是否删除成功</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker ps -a</span><br></pre></td></tr></table></figure><p>删除镜像</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker rmi -f group_web</span><br></pre></td></tr></table></figure><p>进入home/web</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /</span><br><span class="line">cd home/web</span><br></pre></td></tr></table></figure><p>删除文件和文件夹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm * -rf</span><br></pre></td></tr></table></figure><p>重新执行<strong>项目打包</strong>步骤</p><h2 id="参考自"><a class="markdownIt-Anchor" href="#参考自"></a> 参考自</h2><p><a href="https://blog.csdn.net/jay100500/article/details/130139964">如何用docker容器部署nuxt3项目_docker 部署nuxt3-CSDN博客</a></p>]]></content>
      
      
      <categories>
          
          <category> 部署 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
            <tag> Nuxt3 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>课题组网站开发记录</title>
      <link href="/2025/05/19/%E8%AF%BE%E9%A2%98%E7%BB%84%E7%BD%91%E7%AB%99%E5%BC%80%E5%8F%91%E8%AE%B0%E5%BD%95/"/>
      <url>/2025/05/19/%E8%AF%BE%E9%A2%98%E7%BB%84%E7%BD%91%E7%AB%99%E5%BC%80%E5%8F%91%E8%AE%B0%E5%BD%95/</url>
      
        <content type="html"><![CDATA[<h2 id="准备工作"><a class="markdownIt-Anchor" href="#准备工作"></a> 准备工作</h2><p>后端：</p><p>java 17，springboot，mybatis，maven，mysql</p><p>前端：</p><p>vue3，element-ui</p><p>npm 镜像配置</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm config <span class="built_in">set</span> registry https://registry.npmmirror.com</span><br></pre></td></tr></table></figure><p>安装vue脚手架</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g @vue/cli</span><br></pre></td></tr></table></figure><p>环境</p><p><img src="C:%5CUsers%5CL%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240215233926470.png" alt="image-20240215233926470" /></p><p>使用vue ui来创建项目</p><p>安装axios</p><p>npm install axios</p><p>设置端口号</p><p><img src="C:%5CUsers%5CL%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240216001259371.png" alt="image-20240216001259371" /></p><p>仿照<a href="http://www.rufanzhang-group.cn/">欢迎访问张如范教授课题组！Welcome to Rufan Zhang Group！ (rufanzhang-group.cn)</a></p><h2 id="数据库表结构"><a class="markdownIt-Anchor" href="#数据库表结构"></a> 数据库表结构</h2><p>1、登录用户表users</p><table><thead><tr><th style="text-align:center">id</th><th style="text-align:center">email</th><th>name</th><th style="text-align:center">username</th><th style="text-align:center">password</th><th style="text-align:center">level_key</th><th>status</th><th style="text-align:center">update_time</th><th style="text-align:center">create_time</th></tr></thead><tbody></tbody></table><p>2、课题组成员教师表teachers</p><table><thead><tr><th>id</th><th style="text-align:center">name</th><th style="text-align:center">image</th><th style="text-align:center">username</th><th>edu_exp</th><th>direction</th><th style="text-align:center">introduction</th></tr></thead><tbody></tbody></table><p>3、课题组成员学生表students</p><table><thead><tr><th style="text-align:center">id</th><th style="text-align:center">name</th><th style="text-align:center">image</th><th style="text-align:center">username</th><th style="text-align:center">degree</th><th style="text-align:center">grade</th><th style="text-align:center">direction</th></tr></thead><tbody></tbody></table><p>4、研究成果表research</p><table><thead><tr><th style="text-align:center">id</th><th style="text-align:center">papers</th><th style="text-align:center">patents</th></tr></thead><tbody></tbody></table><h2 id="接口文档"><a class="markdownIt-Anchor" href="#接口文档"></a> 接口文档</h2><h3 id="1-登录接口"><a class="markdownIt-Anchor" href="#1-登录接口"></a> 1. 登录接口</h3><h4 id="11-基本信息"><a class="markdownIt-Anchor" href="#11-基本信息"></a> 1.1 基本信息</h4><blockquote><p>请求路径：/login</p><p>请求方式：post</p><p>接口描述：登录完毕后，系统下发JWT令牌。</p></blockquote><h4 id="12-请求参数"><a class="markdownIt-Anchor" href="#12-请求参数"></a> 1.2 请求参数</h4><p>参数格式：json</p><p>参数说明：</p><table><thead><tr><th>名称</th><th>类型</th><th>是否必须</th><th>备注</th></tr></thead><tbody><tr><td>username</td><td>string</td><td>必须</td><td>账号</td></tr><tr><td>password</td><td>string</td><td>必须</td><td>密码</td></tr></tbody></table><p>请求样例：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;admin&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;password&quot;</span><span class="punctuation">:</span> <span class="string">&quot;123456&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h4 id="13-响应数据"><a class="markdownIt-Anchor" href="#13-响应数据"></a> 1.3 响应数据</h4><p>参数格式：json</p><p>参数说明：</p><table><thead><tr><th>名称</th><th>类型</th><th>是否必须</th><th>默认值</th><th>备注</th><th>其他信息</th></tr></thead><tbody><tr><td>code</td><td>number</td><td>必须</td><td></td><td>响应码, 1 成功 ; 0  失败</td><td></td></tr><tr><td>msg</td><td>string</td><td>非必须</td><td></td><td>提示信息</td><td></td></tr><tr><td>data</td><td>string</td><td>必须</td><td></td><td>返回的数据 , jwt令牌</td><td></td></tr></tbody></table><p>响应数据样例：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;msg&quot;</span><span class="punctuation">:</span> <span class="string">&quot;success&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;管理员&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span><span class="string">&quot;admin&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span></span><br><span class="line"><span class="string">&quot;eyJhbGciOiJIUzI1NiJ9.eyJlbXBJZCI6MSwiZXhwIjoxNzA4MDk3MjY3fQ.LsY9v1oQMBTc3EEzd7Qdo3QP-B6Dl3kpzxznz9lOGtA&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h4 id="14-备注说明"><a class="markdownIt-Anchor" href="#14-备注说明"></a> 1.4 备注说明</h4><blockquote><p>用户登录成功后，系统会自动下发JWT令牌，然后在后续的每次请求中，都需要在请求头header中携带到服务端，请求头的名称为 token ，值为 登录时下发的JWT令牌。</p><p>如果检测到用户未登录，则会返回如下固定错误信息：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;msg&quot;</span><span class="punctuation">:</span> <span class="string">&quot;NOT_LOGIN&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></blockquote><h3 id="2-注册接口"><a class="markdownIt-Anchor" href="#2-注册接口"></a> 2. 注册接口</h3><h4 id="21-基本信息"><a class="markdownIt-Anchor" href="#21-基本信息"></a> 2.1 基本信息</h4><blockquote><p>请求路径：/register</p><p>请求方式：post</p><p>接口描述：登录完毕后，系统下发JWT令牌。</p></blockquote><h4 id="22-请求参数"><a class="markdownIt-Anchor" href="#22-请求参数"></a> 2.2 请求参数</h4><p>参数格式：json</p><p>参数说明：</p><table><thead><tr><th>名称</th><th>类型</th><th>是否必须</th><th>备注</th></tr></thead><tbody><tr><td>username</td><td>string</td><td>必须</td><td>账号</td></tr><tr><td>password</td><td>string</td><td>必须</td><td>密码</td></tr><tr><td>email</td><td>string</td><td>必须</td><td>邮箱</td></tr><tr><td>name</td><td>string</td><td>必须</td><td>名称</td></tr></tbody></table><p>请求样例：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;admin&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;password&quot;</span><span class="punctuation">:</span> <span class="string">&quot;123456&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;email&quot;</span><span class="punctuation">:</span> <span class="string">&quot;xxxx@xxx.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;xxx&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h4 id="23-响应数据"><a class="markdownIt-Anchor" href="#23-响应数据"></a> 2.3 响应数据</h4><p>参数格式：json</p><p>参数说明：</p><table><thead><tr><th>名称</th><th>类型</th><th>是否必须</th><th>默认值</th><th>备注</th><th>其他信息</th></tr></thead><tbody><tr><td>code</td><td>number</td><td>必须</td><td></td><td>响应码, 1 成功 ; 0  失败</td><td></td></tr><tr><td>msg</td><td>string</td><td>非必须</td><td></td><td>提示信息</td><td></td></tr><tr><td>data</td><td>string</td><td>非必须</td><td></td><td>返回的数据</td><td></td></tr></tbody></table><p>响应数据样例：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;msg&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="3-获取成员接口"><a class="markdownIt-Anchor" href="#3-获取成员接口"></a> 3. 获取成员接口</h3><h4 id="31-基本信息"><a class="markdownIt-Anchor" href="#31-基本信息"></a> 3.1 基本信息</h4><blockquote><p>请求路径：/members</p><p>请求方式：get</p><p>接口描述：获取教师和学生信息</p></blockquote><h4 id="32-请求参数"><a class="markdownIt-Anchor" href="#32-请求参数"></a> 3.2 请求参数</h4><p>无</p><h4 id="33-响应数据"><a class="markdownIt-Anchor" href="#33-响应数据"></a> 3.3 响应数据</h4><p>参数格式：json</p><p>参数说明：</p><table><thead><tr><th>名称</th><th>类型</th><th>是否必须</th><th>默认值</th><th>备注</th><th>其他信息</th></tr></thead><tbody><tr><td>code</td><td>number</td><td>必须</td><td></td><td>响应码, 1 成功 ; 0  失败</td><td></td></tr><tr><td>msg</td><td>string</td><td>非必须</td><td></td><td>提示信息</td><td></td></tr><tr><td>data</td><td>string</td><td>必须</td><td></td><td>返回的数据</td><td></td></tr></tbody></table><p>响应数据样例：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;msg&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;member_info&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;teachers&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;xxx&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;image&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://xxx.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;eduExp&quot;</span><span class="punctuation">:</span> <span class="string">&quot;xxx&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;direction&quot;</span><span class="punctuation">:</span> <span class="string">&quot;xxx&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;students&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;xxx&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;image&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://xxx.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;degree&quot;</span><span class="punctuation">:</span> <span class="string">&quot;xx&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;grade&quot;</span><span class="punctuation">:</span> <span class="string">&quot;xxxx&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;direction&quot;</span><span class="punctuation">:</span> <span class="string">&quot;xxx&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;xxx&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;image&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://xxx.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;degree&quot;</span><span class="punctuation">:</span> <span class="string">&quot;xx&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;grade&quot;</span><span class="punctuation">:</span> <span class="string">&quot;xxxx&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;direction&quot;</span><span class="punctuation">:</span> <span class="string">&quot;xxx&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h4 id="34-备注说明"><a class="markdownIt-Anchor" href="#34-备注说明"></a> 3.4 备注说明</h4><blockquote><p>java里封装两个表的实体类，然后把实体类装入到 Map&lt;String, List&lt;?&gt;&gt; 中，一起返回数据。</p><p>后续可以优化</p></blockquote><h3 id="4-获取研究成果接口"><a class="markdownIt-Anchor" href="#4-获取研究成果接口"></a> 4. 获取研究成果接口</h3><h4 id="41-基本信息"><a class="markdownIt-Anchor" href="#41-基本信息"></a> 4.1 基本信息</h4><blockquote><p>请求路径：/works</p><p>请求方式：get</p><p>接口描述：获取研究成果</p></blockquote><h4 id="42-请求参数"><a class="markdownIt-Anchor" href="#42-请求参数"></a> 4.2 请求参数</h4><p>无</p><h4 id="43-响应数据"><a class="markdownIt-Anchor" href="#43-响应数据"></a> 4.3 响应数据</h4><p>参数格式：json</p><p>参数说明：</p><table><thead><tr><th>名称</th><th>类型</th><th>是否必须</th><th>默认值</th><th>备注</th><th>其他信息</th></tr></thead><tbody><tr><td>code</td><td>number</td><td>必须</td><td></td><td>响应码, 1 成功 ; 0  失败</td><td></td></tr><tr><td>msg</td><td>string</td><td>非必须</td><td></td><td>提示信息</td><td></td></tr><tr><td>data</td><td>string</td><td>必须</td><td></td><td>返回的数据</td><td></td></tr></tbody></table><p>响应数据样例：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;msg&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;works&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;papers&quot;</span><span class="punctuation">:</span> <span class="string">&quot;论文1&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;patents&quot;</span><span class="punctuation">:</span> <span class="string">&quot;专利1&quot;</span> </span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;papers&quot;</span><span class="punctuation">:</span> <span class="string">&quot;论文2&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;patents&quot;</span><span class="punctuation">:</span> <span class="string">&quot;专利2&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="5-获取教师信息接口"><a class="markdownIt-Anchor" href="#5-获取教师信息接口"></a> 5. 获取教师信息接口</h3><h4 id="51-基本信息"><a class="markdownIt-Anchor" href="#51-基本信息"></a> 5.1 基本信息</h4><blockquote><p>请求路径：/t_info</p><p>请求方式：get</p><p>接口描述：获取教师信息</p></blockquote><h4 id="52-请求参数"><a class="markdownIt-Anchor" href="#52-请求参数"></a> 5.2 请求参数</h4><p>无</p><h4 id="53-响应数据"><a class="markdownIt-Anchor" href="#53-响应数据"></a> 5.3 响应数据</h4><p>参数格式：json</p><p>参数说明：</p><table><thead><tr><th>名称</th><th>类型</th><th>是否必须</th><th>默认值</th><th>备注</th><th>其他信息</th></tr></thead><tbody><tr><td>code</td><td>number</td><td>必须</td><td></td><td>响应码, 1 成功 ; 0  失败</td><td></td></tr><tr><td>msg</td><td>string</td><td>非必须</td><td></td><td>提示信息</td><td></td></tr><tr><td>data</td><td>string</td><td>必须</td><td></td><td>返回的数据</td><td></td></tr></tbody></table><p>响应数据样例：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;msg&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;xxx&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;image&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://xxx.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;niyuanzhi&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;eduExp&quot;</span><span class="punctuation">:</span> <span class="string">&quot;xxx&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;direction&quot;</span><span class="punctuation">:</span> <span class="string">&quot;xx&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;introduction&quot;</span><span class="punctuation">:</span> <span class="string">&quot;xxxxxx&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="6-根据账号获取教师信息接口"><a class="markdownIt-Anchor" href="#6-根据账号获取教师信息接口"></a> 6. 根据账号获取教师信息接口</h3><h4 id="61-基本信息"><a class="markdownIt-Anchor" href="#61-基本信息"></a> 6.1 基本信息</h4><blockquote><p>请求路径：/teac</p><p>请求方式：get</p><p>接口描述：获取教师信息</p></blockquote><h4 id="62-请求参数"><a class="markdownIt-Anchor" href="#62-请求参数"></a> 6.2 请求参数</h4><table><thead><tr><th>名称</th><th>类型</th><th>是否必须</th><th>默认值</th><th>备注</th><th>其他信息</th></tr></thead><tbody><tr><td>username</td><td>string</td><td>必须</td><td></td><td>账号</td><td></td></tr></tbody></table><h4 id="63-响应数据"><a class="markdownIt-Anchor" href="#63-响应数据"></a> 6.3 响应数据</h4><p>参数格式：json</p><p>参数说明：</p><table><thead><tr><th>名称</th><th>类型</th><th>是否必须</th><th>默认值</th><th>备注</th><th>其他信息</th></tr></thead><tbody><tr><td>code</td><td>number</td><td>必须</td><td></td><td>响应码, 1 成功 ; 0  失败</td><td></td></tr><tr><td>msg</td><td>string</td><td>非必须</td><td></td><td>提示信息</td><td></td></tr><tr><td>data</td><td>string</td><td>必须</td><td></td><td>返回的数据</td><td></td></tr></tbody></table><p>响应数据样例：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;msg&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;xxx&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;image&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://xxx.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;niyuanzhi&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;eduExp&quot;</span><span class="punctuation">:</span> <span class="string">&quot;xxx&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;direction&quot;</span><span class="punctuation">:</span> <span class="string">&quot;xx&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;introduction&quot;</span><span class="punctuation">:</span> <span class="string">&quot;xxxxxx&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="7-修改教师信息接口"><a class="markdownIt-Anchor" href="#7-修改教师信息接口"></a> 7. 修改教师信息接口</h3><h4 id="71-基本信息"><a class="markdownIt-Anchor" href="#71-基本信息"></a> 7.1 基本信息</h4><blockquote><p>请求路径：/teac</p><p>请求方式：put</p><p>接口描述：修改教师信息</p></blockquote><h4 id="72-请求参数"><a class="markdownIt-Anchor" href="#72-请求参数"></a> 7.2 请求参数</h4><p>参数格式：json</p><p>参数说明：</p><table><thead><tr><th>名称</th><th>类型</th><th>是否必须</th><th>默认值</th><th>备注</th></tr></thead><tbody><tr><td>id</td><td>int</td><td>必须</td><td></td><td>id</td></tr><tr><td>name</td><td>string</td><td>必须</td><td></td><td>姓名</td></tr><tr><td>image</td><td>string</td><td>非必须</td><td></td><td>图片</td></tr><tr><td>edu_exp</td><td>string</td><td>必须</td><td></td><td>教育经历</td></tr><tr><td>direction</td><td>string</td><td>必须</td><td></td><td>研究方向</td></tr><tr><td>introduction</td><td>string</td><td>非必须</td><td></td><td>介绍</td></tr></tbody></table><h4 id="73-响应数据"><a class="markdownIt-Anchor" href="#73-响应数据"></a> 7.3 响应数据</h4><p>参数格式：json</p><p>参数说明：</p><table><thead><tr><th>名称</th><th>类型</th><th>是否必须</th><th>默认值</th><th>备注</th><th>其他信息</th></tr></thead><tbody><tr><td>code</td><td>number</td><td>必须</td><td></td><td>响应码, 1 成功 ; 0  失败</td><td></td></tr><tr><td>msg</td><td>string</td><td>非必须</td><td></td><td>提示信息</td><td></td></tr><tr><td>data</td><td>string</td><td>必须</td><td></td><td>返回的数据</td><td></td></tr></tbody></table><p>响应数据样例：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;msg&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">null</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="8-根据账号获取学生信息接口"><a class="markdownIt-Anchor" href="#8-根据账号获取学生信息接口"></a> 8. 根据账号获取学生信息接口</h3><h4 id="81-基本信息"><a class="markdownIt-Anchor" href="#81-基本信息"></a> 8.1 基本信息</h4><blockquote><p>请求路径：/stud</p><p>请求方式：get</p><p>接口描述：获取学生信息</p></blockquote><h4 id="82-请求参数"><a class="markdownIt-Anchor" href="#82-请求参数"></a> 8.2 请求参数</h4><table><thead><tr><th>名称</th><th>类型</th><th>是否必须</th><th>默认值</th><th>备注</th><th>其他信息</th></tr></thead><tbody><tr><td>username</td><td>string</td><td>必须</td><td></td><td>账号</td><td></td></tr></tbody></table><h4 id="83-响应数据"><a class="markdownIt-Anchor" href="#83-响应数据"></a> 8.3 响应数据</h4><p>参数格式：json</p><p>参数说明：</p><table><thead><tr><th>名称</th><th>类型</th><th>是否必须</th><th>默认值</th><th>备注</th><th>其他信息</th></tr></thead><tbody><tr><td>code</td><td>number</td><td>必须</td><td></td><td>响应码, 1 成功 ; 0  失败</td><td></td></tr><tr><td>msg</td><td>string</td><td>非必须</td><td></td><td>提示信息</td><td></td></tr><tr><td>data</td><td>string</td><td>必须</td><td></td><td>返回的数据</td><td></td></tr></tbody></table><p>响应数据样例：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;msg&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;xxx&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;image&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://xxx.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;xxx&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;degree&quot;</span><span class="punctuation">:</span> <span class="string">&quot;xx&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;grade&quot;</span><span class="punctuation">:</span> <span class="string">&quot;xxxx&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;direction&quot;</span><span class="punctuation">:</span> <span class="string">&quot;xx&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="9-修改学生信息接口"><a class="markdownIt-Anchor" href="#9-修改学生信息接口"></a> 9. 修改学生信息接口</h3><h4 id="91-基本信息"><a class="markdownIt-Anchor" href="#91-基本信息"></a> 9.1 基本信息</h4><blockquote><p>请求路径：/stud</p><p>请求方式：put</p><p>接口描述：修改学生信息</p></blockquote><h4 id="92-请求参数"><a class="markdownIt-Anchor" href="#92-请求参数"></a> 9.2 请求参数</h4><p>参数格式：json</p><p>参数说明：</p><table><thead><tr><th>名称</th><th>类型</th><th>是否必须</th><th>默认值</th><th>备注</th></tr></thead><tbody><tr><td>name</td><td>string</td><td>必须</td><td></td><td>姓名</td></tr><tr><td>image</td><td>string</td><td>非必须</td><td></td><td>图片</td></tr><tr><td>degree</td><td>string</td><td>必须</td><td></td><td>教育经历</td></tr><tr><td>grade</td><td>string</td><td>必须</td><td></td><td>研究方向</td></tr><tr><td>direction</td><td>string</td><td>非必须</td><td></td><td>介绍</td></tr></tbody></table><h4 id="93-响应数据"><a class="markdownIt-Anchor" href="#93-响应数据"></a> 9.3 响应数据</h4><p>参数格式：json</p><p>参数说明：</p><table><thead><tr><th>名称</th><th>类型</th><th>是否必须</th><th>默认值</th><th>备注</th><th>其他信息</th></tr></thead><tbody><tr><td>code</td><td>number</td><td>必须</td><td></td><td>响应码, 1 成功 ; 0  失败</td><td></td></tr><tr><td>msg</td><td>string</td><td>非必须</td><td></td><td>提示信息</td><td></td></tr><tr><td>data</td><td>string</td><td>必须</td><td></td><td>返回的数据</td><td></td></tr></tbody></table><p>响应数据样例：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;msg&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">null</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="10校验token接口"><a class="markdownIt-Anchor" href="#10校验token接口"></a> 10.校验token接口</h3><h4 id="101-基本信息"><a class="markdownIt-Anchor" href="#101-基本信息"></a> 10.1 基本信息</h4><blockquote><p>请求路径：/token</p><p>请求方式：post</p><p>接口描述：校验token是否合法。</p></blockquote><h4 id="102-请求参数"><a class="markdownIt-Anchor" href="#102-请求参数"></a> 10.2 请求参数</h4><table><thead><tr><th>名称</th><th>类型</th><th>是否必须</th><th>默认值</th><th>备注</th><th>其他信息</th></tr></thead><tbody><tr><td>token</td><td>string</td><td>必须</td><td></td><td></td><td></td></tr></tbody></table><h4 id="103-响应数据"><a class="markdownIt-Anchor" href="#103-响应数据"></a> 10.3 响应数据</h4><p>参数格式：json</p><p>参数说明：</p><table><thead><tr><th>名称</th><th>类型</th><th>是否必须</th><th>默认值</th><th>备注</th><th>其他信息</th></tr></thead><tbody><tr><td>code</td><td>number</td><td>必须</td><td></td><td>响应码, 1 成功 ; 0  失败</td><td></td></tr><tr><td>msg</td><td>string</td><td>非必须</td><td></td><td>提示信息</td><td></td></tr><tr><td>data</td><td>string</td><td>必须</td><td></td><td>返回的数据</td><td></td></tr></tbody></table><p>响应数据样例：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;msg&quot;</span><span class="punctuation">:</span> <span class="string">&quot;success&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;管理员&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span><span class="string">&quot;admin&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="11退出登录接口"><a class="markdownIt-Anchor" href="#11退出登录接口"></a> 11.退出登录接口</h3><h4 id="111-基本信息"><a class="markdownIt-Anchor" href="#111-基本信息"></a> 11.1 基本信息</h4><blockquote><p>请求路径：/logout</p><p>请求方式：post</p><p>接口描述：退出登录。</p></blockquote><h4 id="112-请求参数"><a class="markdownIt-Anchor" href="#112-请求参数"></a> 11.2 请求参数</h4><table><thead><tr><th>名称</th><th>类型</th><th>是否必须</th><th>默认值</th><th>备注</th><th>其他信息</th></tr></thead><tbody><tr><td>token</td><td>string</td><td>必须</td><td></td><td></td><td></td></tr></tbody></table><h4 id="113-响应数据"><a class="markdownIt-Anchor" href="#113-响应数据"></a> 11.3 响应数据</h4><p>参数格式：json</p><p>参数说明：</p><table><thead><tr><th>名称</th><th>类型</th><th>是否必须</th><th>默认值</th><th>备注</th><th>其他信息</th></tr></thead><tbody><tr><td>code</td><td>number</td><td>必须</td><td></td><td>响应码, 1 成功 ; 0  失败</td><td></td></tr><tr><td>msg</td><td>string</td><td>非必须</td><td></td><td>提示信息</td><td></td></tr><tr><td>data</td><td>string</td><td>必须</td><td></td><td>返回的数据</td><td></td></tr></tbody></table><p>响应数据样例：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;msg&quot;</span><span class="punctuation">:</span> <span class="string">&quot;success&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h2 id="springboot开发记录"><a class="markdownIt-Anchor" href="#springboot开发记录"></a> springboot开发记录</h2><p>pojo:  UserLoginDTO------UserLoginVo------User</p><p>server: UserController------UserMapper------UserService  UserServiceImpl</p><h2 id="vue3开发记录"><a class="markdownIt-Anchor" href="#vue3开发记录"></a> Vue3开发记录</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">router-link</span> <span class="attr">to</span>=<span class="string">&quot;/login&quot;</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">router-link</span>&gt;</span>|</span><br><span class="line"><span class="tag">&lt;<span class="name">router-link</span> <span class="attr">to</span>=<span class="string">&quot;/register&quot;</span>&gt;</span>注册<span class="tag">&lt;/<span class="name">router-link</span>&gt;</span>|</span><br><span class="line"><span class="tag">&lt;<span class="name">router-link</span> <span class="attr">to</span>=<span class="string">&quot;/stud&quot;</span>&gt;</span>学生端<span class="tag">&lt;/<span class="name">router-link</span>&gt;</span>|</span><br><span class="line"><span class="tag">&lt;<span class="name">router-link</span> <span class="attr">to</span>=<span class="string">&quot;/teac&quot;</span>&gt;</span>教师端<span class="tag">&lt;/<span class="name">router-link</span>&gt;</span>|</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">router-link</span> <span class="attr">to</span>=<span class="string">&quot;/&quot;</span>&gt;</span>首页<span class="tag">&lt;/<span class="name">router-link</span>&gt;</span> |</span><br><span class="line"><span class="tag">&lt;<span class="name">router-link</span> <span class="attr">to</span>=<span class="string">&quot;/members&quot;</span>&gt;</span>课题组成员<span class="tag">&lt;/<span class="name">router-link</span>&gt;</span>|</span><br><span class="line"><span class="tag">&lt;<span class="name">router-link</span> <span class="attr">to</span>=<span class="string">&quot;/t_info&quot;</span>&gt;</span>教师信息<span class="tag">&lt;/<span class="name">router-link</span>&gt;</span>|</span><br><span class="line"><span class="tag">&lt;<span class="name">router-link</span> <span class="attr">to</span>=<span class="string">&quot;/works&quot;</span>&gt;</span>研究成果<span class="tag">&lt;/<span class="name">router-link</span>&gt;</span></span><br><span class="line">       </span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 开发记录 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> SpringBoot </tag>
            
            <tag> Vue </tag>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
