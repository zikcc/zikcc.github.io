<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>每日Linux-Cpp-6</title>
      <link href="/2025/05/28/%E6%AF%8F%E6%97%A5Linux-Cpp-6/"/>
      <url>/2025/05/28/%E6%AF%8F%E6%97%A5Linux-Cpp-6/</url>
      
        <content type="html"><![CDATA[<h2 id="每日-linux-cpp-6">每日 Linux-Cpp-6</h2><hr><h3 id="1-c中引用和指针的区别"><strong>1.C++中引用(&amp;)和指针(*)的区别</strong></h3><ul><li>通俗解释​​：引用像​​身份证复印件​​——必须绑定原身份（初始化后不可改），操作复印件等同操作本人；指针像​​快递单号​​——可随时修改指向的包裹（可重赋值），但可能填错单号（空指针）。</li><li>​技术解析​​： 引用：​​不可为空​​、​​不可重绑定​​、​​无独立内存​​指针：可为空、可重指向、有独立内存地址  <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span><span class="token keyword">int</span><span class="token operator">&amp;</span> ref <span class="token operator">=</span> a<span class="token punctuation">;</span>  <span class="token comment">// 引用必须初始化，ref是a的别名</span><span class="token keyword">int</span><span class="token operator">*</span> ptr <span class="token operator">=</span> <span class="token operator">&amp;</span>a<span class="token punctuation">;</span> <span class="token comment">// 指针存储地址，可修改 ptr = nullptr;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li><li>​​应用场景​​： 函数参数传递：引用避免拷贝（void print(const string&amp;s)），指针用于需重指向的场景（链表操作）</li><li>​​避坑指南​​：函数返回局部变量引用会导致悬空引用！应返回静态变量或传值</li></ul><h3 id="2-const关键字的作用"><strong>2. ​​const关键字的作用​</strong></h3><ul><li>通俗解释​​：const是​​防篡改封条​​：贴变量上（值不可改），贴函数参数上（函数内不可改），贴成员函数上（函数不改对象状态）。</li><li>​技术解析​​：  <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">const</span> <span class="token keyword">int</span> MAX <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>       <span class="token comment">// 常量不可修改</span><span class="token keyword">void</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token keyword">const</span> Student<span class="token operator">&amp;</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 保证不修改s</span><span class="token keyword">class</span> <span class="token class-name">Circle</span> <span class="token punctuation">{</span><span class="token keyword">double</span> <span class="token function">getArea</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>  <span class="token comment">// 承诺不修改类成员</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>常量指针：不能通过指针修改指向的值，变量自身不可变（const int* p）指针常量：不能改变指针的指向，指向的对象不可变（int* const p）</li><li>应用场景​​： 硬件寄存器映射（volatile const uint32_t*REG_ADDR），防止误写</li></ul><h3 id="3-虚函数实现原理"><strong>3. ​​虚函数实现原理​​</strong></h3><ul><li>通俗解释​​：父类定义​​万能遥控器按钮​​（虚函数），子类​​重写按钮功能​​。按父类按钮（基类指针）实际执行子类功能（动态绑定）。</li><li>技术解析​​：  <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">Animal</span> <span class="token punctuation">{</span><span class="token keyword">public</span><span class="token operator">:</span><span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">speak</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> cout <span class="token operator">&lt;&lt;</span> <span class="token string">"???"</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">// 虚函数 → 生成虚函数表</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">Dog</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Animal</span></span> <span class="token punctuation">{</span><span class="token keyword">void</span> <span class="token function">speak</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">override</span> <span class="token punctuation">{</span> cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Wang!"</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">// 覆盖虚函数表项</span><span class="token punctuation">}</span><span class="token punctuation">;</span>Animal<span class="token operator">*</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Dog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>a<span class="token operator">-&gt;</span><span class="token function">speak</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出 "Wang!" （查虚函数表调用Dog::speak）</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>核心机制：​​虚函数表（vtable）​​ + ​​虚表指针（vptr）​​代价：每个对象增加8字节（64位）</li><li>应用场景​​： 插件架构（基类定义接口，动态库实现具体功能）</li></ul><h3 id="4-进程-vs-线程的区别"><strong>4. 进程 vs线程的区别</strong></h3><table><thead><tr><th style="text-align: center;"><strong>对比项</strong></th><th style="text-align: center;"><strong>进程</strong></th><th style="text-align: center;"><strong>线程</strong></th></tr></thead><tbody><tr><td style="text-align: center;"><strong>🍎 通俗比喻</strong></td><td style="text-align: center;">独立办公室（有独立资源）</td><td style="text-align: center;">办公室内同事（共享资源）</td></tr><tr><td style="text-align: center;"><strong>资源隔离</strong></td><td style="text-align: center;">内存、文件句柄独立</td><td style="text-align: center;">共享进程内存和文件</td></tr><tr><td style="text-align: center;"><strong>创建开销</strong></td><td style="text-align: center;">大（需复制父进程资源）</td><td style="text-align: center;">小（仅复制栈和寄存器）</td></tr><tr><td style="text-align: center;"><strong>通信成本</strong></td><td style="text-align: center;">高（需IPC：管道/共享内存）</td><td style="text-align: center;">低（直接读写共享变量）</td></tr><tr><td style="text-align: center;"><strong>崩溃影响</strong></td><td style="text-align: center;">不影响其他进程</td><td style="text-align: center;">同一进程内线程全部终止</td></tr></tbody></table><ul><li>应用场景：Chrome浏览器：每个标签页是独立进程（崩溃隔离），页面渲染用多线程</li></ul><h3 id="5-互斥锁-vs-自旋锁的选择"><strong>5. 互斥锁 vs自旋锁的选择</strong></h3><ul><li><p>通俗解释：</p><ul><li><strong>互斥锁</strong>：发现厕所有人→<strong>去休息室睡觉</strong>（线程休眠），等人出来再被唤醒</li><li><strong>自旋锁</strong>：发现厕所有人→<strong>门口转圈盯门</strong>（CPU空转），门开立即冲入</li></ul></li><li><p>技术解析：</p><table><thead><tr><th style="text-align: center;"><strong>锁类型</strong></th><th style="text-align: center;"><strong>适用场景</strong></th><th style="text-align: center;"><strong>临界区耗时</strong></th><th style="text-align: center;"><strong>性能影响</strong></th></tr></thead><tbody><tr><td style="text-align: center;">互斥锁</td><td style="text-align: center;">I/O操作、复杂计算</td><td style="text-align: center;">&gt;1μs</td><td style="text-align: center;">上下文切换开销大</td></tr><tr><td style="text-align: center;">自旋锁</td><td style="text-align: center;">短时操作（如计数器自增）</td><td style="text-align: center;">&lt;1μs</td><td style="text-align: center;">浪费CPU但响应快</td></tr></tbody></table></li><li><p>应用场景：网卡收包中断处理（自旋锁），数据库连接池管理（互斥锁）</p></li></ul><h3 id="6-虚拟内存的作用"><strong>6. 虚拟内存的作用</strong></h3><ul><li>通俗解释： 虚拟内存像酒店房间管理系统： -每个程序觉得独占所有房间（连续地址空间） -实际房间（物理内存）可能不足，部分客人行李存车库（磁盘交换区） -保安（MMU）实时查房卡（页表）找真实房间号</li><li>技术解析：<ul><li><strong>页表（Page Table）</strong>：映射虚拟页→物理页帧</li><li><strong>缺页中断</strong>：访问未加载页时触发，OS从磁盘调入</li><li><strong>写时复制（Copy-on-Write）</strong>：子进程共享父进程页，仅修改时复制</li></ul></li><li>应用场景：运行超内存程序（如8GB内存启动16GB的VMware），进程隔离（防止A进程篡改B进程数据）</li></ul><h3 id="7-哈希表冲突解决方案"><strong>​7.​哈希表冲突解决方案​</strong></h3><ul><li><p>通俗解释​​： 两辆车（数据）被导航到同一车位（哈希冲突）：​​链地址法​​：车位改成立体车库（链表挂多辆车）​​开放寻址法​​：保安找下一个空位（线性/二次探测）</p></li><li><p>技术解析​​：</p>  <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// 链地址法实现（C++简版）</span><span class="token keyword">class</span> <span class="token class-name">HashMap</span> <span class="token punctuation">{</span>vector<span class="token operator">&lt;</span>list<span class="token operator">&lt;</span>pair<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> string<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> buckets<span class="token punctuation">;</span> <span class="token comment">// 桶数组+链表</span><span class="token keyword">void</span> <span class="token function">insert</span><span class="token punctuation">(</span><span class="token keyword">int</span> key<span class="token punctuation">,</span> string val<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">int</span> idx <span class="token operator">=</span> <span class="token function">hash</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">%</span> buckets<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> p <span class="token operator">:</span> buckets<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>first <span class="token operator">==</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span> p<span class="token punctuation">.</span>second <span class="token operator">=</span> val<span class="token punctuation">;</span> <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">// 键存在则更新</span>    <span class="token punctuation">}</span>    buckets<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token punctuation">{</span>key<span class="token punctuation">,</span> val<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 冲突时链表追加</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><table><thead><tr><th style="text-align: center;"><strong>方法</strong></th><th style="text-align: center;"><strong>平均时间复杂度</strong></th><th style="text-align: center;"><strong>空间开销</strong></th><th style="text-align: center;"><strong>适用场景</strong></th></tr></thead><tbody><tr><td style="text-align: center;">链地址法</td><td style="text-align: center;">O(1 + α)</td><td style="text-align: center;">指针额外空间</td><td style="text-align: center;">通用场景</td></tr><tr><td style="text-align: center;">开放寻址法</td><td style="text-align: center;">O(1/(1-α))</td><td style="text-align: center;">无指针开销</td><td style="text-align: center;">缓存友好，内存紧张</td></tr></tbody></table></li><li><p>应用场景​​：Redis字典（链地址法），Linux内核页缓存（开放寻址）</p></li></ul><h3 id="8-二叉树前序中序后序遍历"><strong>8.二叉树前序/中序/后序遍历​​</strong></h3><ul><li><p>通俗解释​​： 遍历像​​查户口登记​​：​​前序​​：先登记自己，再查左子树，最后右子树（根→左→右）​​中序​​：先查左子树，再登记自己，最后右子树（左→根→右）→​​二叉搜索树输出有序序列​​ ​​后序​​：先查左右子树，最后登记自己（左→右→根）→​​用于释放子树内存​</p></li><li><p>技术解析​​：</p>  <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// 递归中序遍历（升序输出二叉搜索树）</span><span class="token keyword">void</span> <span class="token function">inorder</span><span class="token punctuation">(</span>TreeNode<span class="token operator">*</span> root<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>root<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span><span class="token function">inorder</span><span class="token punctuation">(</span>root<span class="token operator">-&gt;</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 先左子树</span>cout <span class="token operator">&lt;&lt;</span> root<span class="token operator">-&gt;</span>val <span class="token operator">&lt;&lt;</span> <span class="token string">" "</span><span class="token punctuation">;</span> <span class="token comment">// 输出当前节点</span><span class="token function">inorder</span><span class="token punctuation">(</span>root<span class="token operator">-&gt;</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 再右子树</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><table><thead><tr><th style="text-align: center;"><strong>遍历方式</strong></th><th style="text-align: center;"><strong>非递归实现核心</strong></th><th style="text-align: center;"><strong>应用场景</strong></th></tr></thead><tbody><tr><td style="text-align: center;">前序</td><td style="text-align: center;">栈顶→右子入栈→左子入栈</td><td style="text-align: center;">目录树结构展示</td></tr><tr><td style="text-align: center;">中序</td><td style="text-align: center;">左链入栈→弹出访问→转右子树</td><td style="text-align: center;">二叉搜索树有序输出</td></tr><tr><td style="text-align: center;">后序</td><td style="text-align: center;">双栈法/反向前序</td><td style="text-align: center;">表达式树求值（后缀表达式）</td></tr></tbody></table></li><li><p>应用场景​​：编译器解析数学表达式（后序遍历求值），文件系统树状展示（前序遍历）</p></li></ul><h3 id="9-tcp为什么需要三次握手">​<strong>9.​TCP为什么需要三次握手？</strong></h3><ul><li>通俗解释​​： 类比打电话： A打给B：“能听到吗？”（SYN）B回答：“能听到，你听得到我吗？”（SYN-ACK） A说：“我也能听到”（ACK）→​​双方确认通信能力​​ 如果只有两次：B无法确认A是否收到回复（可能B白等）</li><li>技术解析​​：  <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span> <span class="token expression">TCP握手抓包示例（Wireshark）</span></span><span class="token number">1.</span> Client → Server<span class="token operator">:</span> <span class="token punctuation">[</span>SYN<span class="token punctuation">]</span> Seq<span class="token operator">=</span><span class="token number">0</span><span class="token number">2.</span> Server → Client<span class="token operator">:</span> <span class="token punctuation">[</span>SYN<span class="token punctuation">,</span> ACK<span class="token punctuation">]</span> Seq<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> Ack<span class="token operator">=</span><span class="token number">1</span><span class="token number">3.</span> Client → Server<span class="token operator">:</span> <span class="token punctuation">[</span>ACK<span class="token punctuation">]</span> Seq<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> Ack<span class="token operator">=</span><span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>​- ​防历史连接​​：避免旧重复SYN导致错误连接 ​-​同步初始序列号​​：防止网络延迟导致数据错乱</li><li>​​避坑指南​​：服务端未收到第三次ACK会重传SYN-ACK（默认重试5次），可能被SYNFlood攻击！</li></ul><h3 id="10-epoll比select高效的原因"><strong>10.Epoll比Select高效的原因​</strong></h3><ul><li><p>通俗解释​​：​​Select​​：快递员每次挨个问1000个货架（fd）：“有包裹吗？”（O(n)遍历）​​Epoll​​：货架装传感器，快递员直接看指示灯（事件驱动），哪亮去哪（O(1)定位）</p></li><li><p>技术解析​​：</p>  <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// Epoll核心API</span><span class="token keyword">int</span> epfd <span class="token operator">=</span> <span class="token function">epoll_create1</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 创建epoll实例</span><span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> ev<span class="token punctuation">;</span>ev<span class="token punctuation">.</span>events <span class="token operator">=</span> EPOLLIN<span class="token punctuation">;</span>          <span class="token comment">// 监听可读事件</span><span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epfd<span class="token punctuation">,</span> EPOLL_CTL_ADD<span class="token punctuation">,</span> sockfd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ev<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 注册socket</span><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token function">epoll_wait</span><span class="token punctuation">(</span>epfd<span class="token punctuation">,</span> events<span class="token punctuation">,</span> MAX_EVENTS<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 等待事件</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> EPOLLIN<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">handle_read</span><span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 直接处理活跃fd</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><table><thead><tr><th style="text-align: center;"><strong>模型</strong></th><th style="text-align: center;"><strong>时间复杂度</strong></th><th style="text-align: center;"><strong>最大fd数</strong></th><th style="text-align: center;"><strong>内核态拷贝</strong></th></tr></thead><tbody><tr><td style="text-align: center;">select</td><td style="text-align: center;">O(n)</td><td style="text-align: center;">1024</td><td style="text-align: center;">每次全量拷贝fd集合</td></tr><tr><td style="text-align: center;">epoll</td><td style="text-align: center;">O(1)</td><td style="text-align: center;">10万+</td><td style="text-align: center;">仅返回活跃fd</td></tr></tbody></table></li><li><p>应用场景​​： Nginx高并发连接（10万+），Redis事件处理</p></li></ul>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> C++ </tag>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>每日Linux-Cpp-5</title>
      <link href="/2025/05/27/%E6%AF%8F%E6%97%A5Linux-Cpp-5/"/>
      <url>/2025/05/27/%E6%AF%8F%E6%97%A5Linux-Cpp-5/</url>
      
        <content type="html"><![CDATA[<h2 id="每日-linux-cpp-5">每日 Linux-Cpp-5</h2><hr><h3 id="1-sfinae-substitution-failure-is-not-an-error-替换失败不是错误-的原理及在类型萃取中的应用"><strong>1.SFINAE (Substitution Failure Is Not An Error) (替换失败不是错误)的原理及在类型萃取中的应用</strong></h3><ul><li>原理: 模板实例化时, 若替换导致无效类型/表达式, 该模板被静默忽略,继续寻找其他可行模板, 它允许在模板实例化过程中,如果某个模板参数的替换导致编译错误, 编译器不会报错,而是简单地忽略这个模板实例化。。</li><li>应用:  <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// 如果输入的 T 具有 serialize 这个成员函数, 那么不会产生错误, has_serialize 就会继承 true_type 这个类, 里面只有一个静态成员 true</span><span class="token comment">// 如果没有这个成员函数, 就会出错, 那么就会跳过下面的这个模板, 去调用上面的模板, 也就是直接继承 false_type</span><span class="token comment">// 为什么认为 serialize 是成员函数而不是成员变量? </span><span class="token comment">// &amp;T::serialize 用于获取T类型中的serialize成员的地址</span><span class="token comment">// 如果 serialize 是成员函数, decltype(&amp;T::serialize) 会得到一个指向成员函数的指针 例如, void (T::*)(), int (T::*) (int)等</span><span class="token comment">// &amp;T::serialize会得到一个指向成员变量的指针 例如, int T::*</span><span class="token comment">// void_t 能够将 表达式的结果类型折叠为 void, 但是没有 void 的变量类型。</span><span class="token comment">// 获取成员变量一般使用 T::member</span><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token operator">=</span> <span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token keyword">struct</span> <span class="token class-name">has_serialize</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token class-name">false_type</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span><span class="token keyword">struct</span> <span class="token class-name">has_serialize</span><span class="token operator">&lt;</span>T<span class="token punctuation">,</span> void_t<span class="token operator">&lt;</span><span class="token keyword">decltype</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>T<span class="token double-colon punctuation">::</span>serialize<span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span> <span class="token operator">:</span> true_type <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>项目关联: 在模型序列化框架中, 用 SFINAE 检测自定义层是否实现serialize() 方法, 实现泛型处理(类似 ONNX 的序列化机制)</li></ul><h3 id="2-crtp-curiously-recurring-template-pattern-奇异递归模板模式-的静态多态实现"><strong>2.CRTP (Curiously Recurring Template Pattern) (奇异递归模板模式)的静态多态实现</strong></h3><ul><li>引言: CRTP, 即奇异递归模板模式(Curiously Recurring TemplatePattern), 是C++中一个独特而强大的设计模式。它利用模板和继承的特性,允许在编译时进行多态操作, 从而提高代码的性能和灵活性。在人类思维中,我们经常倾向于通过继承和类似性来理解和分类事物。CRTP以一种类似的方式工作,通过继承自己(在子类中使用父类模板),它在技术上实现了一种“自我认知”的模式。</li><li>实现: 派生类将自身作为模板参数传递给基类  <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">Derived</span><span class="token operator">&gt;</span><span class="token keyword">class</span> <span class="token class-name">Base</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span><span class="token operator">:</span>        <span class="token keyword">void</span> <span class="token function">interface</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>Derived<span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token function">implementation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">Derived</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Base</span><span class="token operator">&lt;</span><span class="token class-name">Derived</span><span class="token operator">&gt;</span></span> <span class="token punctuation">{</span>    <span class="token keyword">public</span><span class="token operator">:</span>        <span class="token keyword">void</span> <span class="token function">implementation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment">/* ... */</span>        <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>优势: 零虚函数开销, 适合于嵌入式高频调用的算法基类<ul><li>例如:  <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">Derived</span><span class="token operator">&gt;</span><span class="token keyword">class</span> <span class="token class-name">Shape</span> <span class="token punctuation">{</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token keyword">void</span> <span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>Derived<span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">draw_impl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 调用具体子类的 draw_impl()</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">Circle</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Shape</span><span class="token operator">&lt;</span><span class="token class-name">Circle</span><span class="token operator">&gt;</span></span> <span class="token punctuation">{</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token keyword">void</span> <span class="token function">draw_impl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Drawing a circle\n"</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">Square</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Shape</span><span class="token operator">&lt;</span><span class="token class-name">Square</span><span class="token operator">&gt;</span></span> <span class="token punctuation">{</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token keyword">void</span> <span class="token function">draw_impl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Drawing a square\n"</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    Circle c<span class="token punctuation">;</span>    c<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 输出 "Drawing a circle"（无虚函数开销！）</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><table><thead><tr><th style="text-align: left;"><strong>对比项</strong></th><th style="text-align: left;"><strong>CRTP</strong></th><th style="text-align: left;"><strong>虚函数</strong></th></tr></thead><tbody><tr><td style="text-align: left;"><strong>多态时机</strong></td><td style="text-align: left;">编译期</td><td style="text-align: left;">运行期</td></tr><tr><td style="text-align: left;"><strong>性能</strong></td><td style="text-align: left;">无虚表查找开销</td><td style="text-align: left;">有虚函数调用开销</td></tr><tr><td style="text-align: left;"><strong>是否可静态调用</strong></td><td style="text-align: left;">支持（如 <code>static_func</code>）</td><td style="text-align: left;">不支持</td></tr><tr><td style="text-align: left;"><strong>代码生成</strong></td><td style="text-align: left;">模板实例化（可能代码膨胀）</td><td style="text-align: left;">单份虚表</td></tr><tr><td style="text-align: left;"><strong>适用场景</strong></td><td style="text-align: left;">高性能库、编译期检查</td><td style="text-align: left;">运行时动态多态</td></tr></tbody></table></li></ul><h3 id="3-完美转发-perfect-forwarding-的实现与-stdforward-的作用"><strong>3.完美转发 (Perfect Forwarding) 的实现与 std::forward 的作用</strong></h3><ul><li>前言:<ul><li>万能引用（Universal Reference） 万能引用是完美转发的基础, 其形式为T&amp;&amp;, 其中 T 是模板参数：  <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span><span class="token keyword">void</span> <span class="token function">foo</span><span class="token punctuation">(</span>T<span class="token operator">&amp;&amp;</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// arg 是万能引用</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>万能引用的关键特性：<ul><li>可以绑定到左值或右值</li><li>通过引用折叠规则（Reference Collapsing）确定最终类型 引用折叠规则:当模板参数推导遇到引用的引用时, C++使用以下规则进行折叠：  <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">T<span class="token operator">&amp;</span> <span class="token operator">&amp;</span> → T<span class="token operator">&amp;</span>T<span class="token operator">&amp;</span> <span class="token operator">&amp;&amp;</span> → T<span class="token operator">&amp;</span>T<span class="token operator">&amp;&amp;</span> <span class="token operator">&amp;</span> → T<span class="token operator">&amp;</span>T<span class="token operator">&amp;&amp;</span> <span class="token operator">&amp;&amp;</span> → T<span class="token operator">&amp;&amp;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li></ul></li></ul></li><li>原理: 通过右值引用和引用折叠保留参数原始类型  <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span><span class="token keyword">void</span> <span class="token function">warpper</span><span class="token punctuation">(</span>T<span class="token operator">&amp;&amp;</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">target</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">forward</span><span class="token generic class-name"><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 保留arg的左值/右值性。在转发时恢复参数的原始类型</span><span class="token punctuation">}</span><span class="token keyword">void</span> <span class="token function">target</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">&amp;</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span> std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"左值引用\n"</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token keyword">void</span> <span class="token function">target</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">&amp;&amp;</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span> std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"右值引用\n"</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>    <span class="token function">wrapper</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 调用 target(int&amp;)</span>    <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 调用 target(int&amp;&amp;)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>std::forward: 条件转换为右值引用 (当 T 为非左值引用类型时)</li></ul><h3 id="4-模板元编程在嵌入式性能优化中的局限性"><strong>4.模板元编程在嵌入式性能优化中的局限性</strong></h3><ul><li>局限性：<ul><li>编译时间膨胀(模板实例化过多)</li><li>调试困难(错误信息冗长)</li><li>代码体积增大(可能影响 Flash 存储)</li></ul></li><li>优化策略：<ul><li>限制递归深度 (如 constexpr 替代部分模板)<ol type="1"><li>模板元编程（TMP） 时期：编译期执行机制：通过模板特化、递归实例化在编译期生成代码典型应用：类型计算、编译期数值计算缺点：语法晦涩、编译错误信息难懂、编译速度慢 例如：</li></ol>  <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// 用模板计算阶乘</span><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">int</span> N<span class="token operator">&gt;</span><span class="token keyword">struct</span> <span class="token class-name">Factorial</span> <span class="token punctuation">{</span>    <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">int</span> value <span class="token operator">=</span> N <span class="token operator">*</span> Factorial<span class="token operator">&lt;</span>N<span class="token operator">-</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span>value<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token keyword">struct</span> <span class="token class-name">Factorial</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>    <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">int</span> value <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">int</span> x <span class="token operator">=</span> Factorial<span class="token operator">&lt;</span><span class="token number">5</span><span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span>value<span class="token punctuation">;</span> <span class="token comment">// 编译期计算120</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="2" type="1"><li>constexpr 函数 时期：编译期或运行期执行（取决于调用上下文）机制：用普通函数语法实现编译期计算 典型应用：替代简单的模板数值计算优点：代码直观、编译错误友好</li></ol>  <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">constexpr</span> <span class="token keyword">int</span> <span class="token function">factorial</span><span class="token punctuation">(</span><span class="token keyword">int</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> n <span class="token operator">*</span> <span class="token function">factorial</span><span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token function">factorial</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 编译期计算120</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>使用 concepts (C++20) 约束模板参数</li></ul></li></ul><h3 id="5-自旋锁-spinlock-与互斥锁-mutex-的使用场景对比"><strong>5.自旋锁 (spinlock) 与互斥锁 (mutex) 的使用场景对比</strong></h3><ul><li><p>前言：</p><table><thead><tr><th style="text-align: left;"><strong>锁类型</strong></th><th style="text-align: left;"><strong>比喻场景</strong></th><th style="text-align: left;"><strong>行为</strong></th></tr></thead><tbody><tr><td style="text-align: left;"><strong>自旋锁</strong></td><td style="text-align: left;">你在便利店抢最后一瓶水，不断问店员：“有了吗？有了吗？”（循环检查）</td><td style="text-align: left;"><strong>忙等待（Busy-wait）</strong>：占着CPU一直检查锁是否释放</td></tr><tr><td style="text-align: left;"><strong>互斥锁</strong></td><td style="text-align: left;">你在便利店抢最后一瓶水，店员说“没货了“，你去旁边沙发睡觉，到货后店员叫醒你</td><td style="text-align: left;"><strong>睡眠等待（Sleep-wait）</strong>：让出CPU，锁可用时被系统唤醒</td></tr></tbody></table><table><thead><tr><th style="text-align: left;"><strong>特性</strong></th><th style="text-align: left;"><strong>自旋锁（Spinlock）</strong></th><th style="text-align: left;"><strong>互斥锁（Mutex）</strong></th></tr></thead><tbody><tr><td style="text-align: left;"><strong>等待方式</strong></td><td style="text-align: left;">循环检查（消耗CPU）</td><td style="text-align: left;">线程挂起（不消耗CPU）</td></tr><tr><td style="text-align: left;"><strong>开销</strong></td><td style="text-align: left;">高频CPU占用</td><td style="text-align: left;">上下文切换开销</td></tr><tr><td style="text-align: left;"><strong>适用场景</strong></td><td style="text-align: left;">锁持有时间极短（纳秒/微秒级）</td><td style="text-align: left;">锁持有时间较长（毫秒级以上）</td></tr><tr><td style="text-align: left;"><strong>实现级别</strong></td><td style="text-align: left;">通常需原子指令（如CAS）</td><td style="text-align: left;">依赖操作系统API（如futex）</td></tr><tr><td style="text-align: left;"><strong>线程状态</strong></td><td style="text-align: left;">始终处于运行状态（Runnable）</td><td style="text-align: left;">可能被阻塞（Blocked）</td></tr></tbody></table></li><li><p>自旋锁：</p><ul><li>场景：临界区极短(无阻塞)、中断上下文、多核环境</li><li>实现：忙等待 (spin_lock_irqsave())</li></ul></li><li><p>互斥锁：</p><ul><li>场景：临界区较长、可能阻塞 (如文件 IO)、用户态线程</li><li>实现：睡眠等待 (mutex_lock())</li></ul></li><li><p>项目关联：在多核 ARM 设备驱动中,中断处理函数用自旋锁保护共享寄存器 为什么在中断处理中用自旋锁？中断上下文不能睡眠：中断处理函数（如Linux的irq_handler）不能调用可能引发睡眠的函数（如互斥锁mutex_lock）,而自旋锁是唯一选择。 多核竞争：多核CPU可能同时访问同一硬件寄存器,需保证原子性。 短临界区：寄存器操作通常极快（纳秒级）,适合自旋锁的忙等待特性。</p></li></ul><h3 id="6-rcu-read-copy-update-的原理及适用场景"><strong>6. RCU(Read-Copy-Update) 的原理及适用场景</strong></h3><ul><li>前言： RCU（Read-Copy-Update）是Linux内核中一种重要的同步机制,它针对“读多写少“的场景提供了极高的读取性能。RCU的基本理念可以用三句话概括： 读取无锁：读者不需要任何锁或原子操作,可以极速访问数据 写者同步：写者通过复制-更新-替换的方式修改数据延迟回收：确保没有读者后再释放旧数据这种设计使得在读取频率远高于写入频率的场景下,性能远超传统的读写锁。</li><li>原理:<ol type="1"><li>读侧：无锁访问数据 (仅需内存屏障)</li><li>写侧：创建副本修改后, 原子替换指针, 异步回收旧数据</li></ol></li><li>适用场景： 读多写少的数据结构 (如路由表、内核链表)</li><li>优势： 读操作零阻塞, 写操作延迟回收避免竞争。</li></ul><h3 id="7-内存屏障-memory-barrier-在-arm-多核架构中的作用"><strong>7.内存屏障 (Memory Barrier) 在 ARM 多核架构中的作用</strong></h3><ul><li>问题：多核乱序执行和缓存不一致可能导致数据同步错误</li><li>解决方案：<ul><li>写屏障 (dmb st) : 确保屏障前的写操作先于屏障后的写操作完成。</li><li>读屏障 (dmb ld) : 确保屏障前的读操作先于屏障后的读操作完成。</li></ul></li><li>项目关联： 在异构计算 (CPU + NPU)中同步模型权重数据时需显式插入内存屏障</li></ul><h3 id="8-模型量化的基本原理及对推理速度精度的影响"><strong>8.模型量化的基本原理及对推理速度/精度的影响</strong></h3><ul><li>原理：将 FP32 权重/激活值映射到 INT8 (动态范围缩放)</li><li>影响：<ul><li>速度：减少内存带宽, 加速 SIMD 指令 (如 ARM NEON 的vqmovn)</li><li>精度：可能损失边缘样本的识别能力 (需校准数据集补偿)</li></ul></li><li>项目关联: TensorRT 中采用混合量化策略 (敏感层保持 FP16)</li></ul><h3 id="9-嵌入式部署中模型权重的内存对齐优化方法"><strong>9.嵌入式部署中模型权重的内存对齐优化方法</strong></h3><ul><li>优化方法：<ul><li>权重数组按 64 字节对齐 (适配 Cache Line)</li><li>使用 posix_memalign 分配内存</li><li>结构体用 <strong>attribute</strong>((aligned))修饰</li></ul></li><li>效果: 减少 Cache Miss, 提升 NPU DMA 传输效率 (如瑞芯微 RKNNSDK)</li></ul><h3 id="10-解释-tensorrt-中的层融合-layer-fusion-优化原理"><strong>10.解释 TensorRT 中的层融合 (Layer Fusion) 优化原理</strong></h3><ul><li>原理：将连续层(如 Conv + ReLU + BN) 合并为单一内核, 减少:<ul><li>内存读写次数 (中间结果复用)</li><li>内核启动开销 (CUDA 上下文切换)</li></ul></li><li>项目关联：在 Jetson Nano 部署 YOLOv5 时, TensorRT 自动融合 Backbone中的 Conv+Silu 层, 推理速度提升3倍。</li></ul><hr><h3 id="综合应用题"><strong>综合应用题</strong></h3><p>设计一个支持动态优先级调整的线程池</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">ThreadPool</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span><span class="token operator">:</span>        <span class="token keyword">using</span> Task <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>function<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>        <span class="token function">ThreadPool</span><span class="token punctuation">(</span>size_t threads<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">for</span><span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> threads<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>                workers<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>                    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lock</span><span class="token punctuation">(</span>queue_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token comment">// 阻塞在这里，只有 stop 或者 队列不为空才结束 wait</span>                        condition<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>lock<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>                            <span class="token keyword">return</span> stop <span class="token operator">||</span> <span class="token operator">!</span>tasks<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token punctuation">}</span><span class="token punctuation">)</span>                        <span class="token keyword">if</span> <span class="token punctuation">(</span>stop <span class="token operator">&amp;&amp;</span> tasks<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>                        <span class="token comment">// std::move 的作用</span>                        <span class="token comment">// 将tasks.top().second从左值转为右值（允许移动而非拷贝）</span>                        <span class="token comment">// 如果second的类型支持移动语义（如std::function、std::string等），则会调用移动构造函数</span>                        <span class="token comment">// 避免不必要的深拷贝，提高性能</span>                        <span class="token keyword">auto</span> task <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>tasks<span class="token punctuation">.</span><span class="token function">top</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>second<span class="token punctuation">)</span><span class="token punctuation">;</span>                        tasks<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token function">task</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token operator">~</span><span class="token function">ThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token punctuation">{</span>                std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lock</span><span class="token punctuation">(</span>queue_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>                stop <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            condition<span class="token punctuation">.</span><span class="token function">notify_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> worker <span class="token operator">:</span> workers<span class="token punctuation">)</span> worker<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">void</span> <span class="token function">enqueue</span><span class="token punctuation">(</span><span class="token keyword">int</span> priority<span class="token punctuation">,</span> Task task<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token punctuation">{</span>                std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lock</span><span class="token punctuation">(</span>queue_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>                tasks<span class="token punctuation">.</span><span class="token function">emplace</span><span class="token punctuation">(</span>priority<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            condition<span class="token punctuation">.</span><span class="token function">notify_one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token keyword">private</span><span class="token operator">:</span>        std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>thread<span class="token operator">&gt;</span> workers<span class="token punctuation">;</span>        std<span class="token double-colon punctuation">::</span>priority_queue<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>pair<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> Task<span class="token operator">&gt;&gt;</span> tasks<span class="token punctuation">;</span>        std<span class="token double-colon punctuation">::</span>mutex queue_mutex<span class="token punctuation">;</span>        std<span class="token double-colon punctuation">::</span>condition_variable condition<span class="token punctuation">;</span>        <span class="token keyword">bool</span> stop<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>   <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> C++ </tag>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>自定义协议栈服务器开发导航</title>
      <link href="/2025/05/26/%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8D%8F%E8%AE%AE%E6%A0%88%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BC%80%E5%8F%91%E5%AF%BC%E8%88%AA/"/>
      <url>/2025/05/26/%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8D%8F%E8%AE%AE%E6%A0%88%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BC%80%E5%8F%91%E5%AF%BC%E8%88%AA/</url>
      
        <content type="html"><![CDATA[<h2 id="自定义协议栈服务器开发导航">自定义协议栈服务器开发导航</h2><hr><ol type="1"><li><a href="/2025/05/26/%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8D%8F%E8%AE%AE%E6%A0%88%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BC%80%E5%8F%91-1/" title="自定义协议栈服务器开发-1">自定义协议栈服务器开发-1</a></li><li><a href="/2025/05/26/%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8D%8F%E8%AE%AE%E6%A0%88%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BC%80%E5%8F%91-2/" title="自定义协议栈服务器开发-2">自定义协议栈服务器开发-2</a></li><li><a href="/2025/05/26/%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8D%8F%E8%AE%AE%E6%A0%88%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BC%80%E5%8F%91-3/" title="自定义协议栈服务器开发-3">自定义协议栈服务器开发-3</a></li><li><a href="/2025/05/26/%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8D%8F%E8%AE%AE%E6%A0%88%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BC%80%E5%8F%91-4/" title="自定义协议栈服务器开发-4">自定义协议栈服务器开发-4</a></li><li><a href="/2025/05/26/%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8D%8F%E8%AE%AE%E6%A0%88%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BC%80%E5%8F%91-5/" title="自定义协议栈服务器开发-5">自定义协议栈服务器开发-5</a></li></ol>]]></content>
      
      
      <categories>
          
          <category> 开发记录 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> C++ </tag>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>自定义协议栈服务器开发-5</title>
      <link href="/2025/05/26/%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8D%8F%E8%AE%AE%E6%A0%88%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BC%80%E5%8F%91-5/"/>
      <url>/2025/05/26/%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8D%8F%E8%AE%AE%E6%A0%88%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BC%80%E5%8F%91-5/</url>
      
        <content type="html"><![CDATA[<h2 id="扩展多协议支持">扩展多协议支持</h2><h2 id="当前架构设计">当前架构设计</h2><h3 id="11-模块分层以及职责">1.1 模块分层以及职责</h3><pre class="line-numbers language-none"><code class="language-none">+----------------------+        +----------------------+        +----------------------+  | 客户端（TCP 发送）   | ----▶  | 主线程：epoll Reactor | ----▶  | 线程池：Task 处理      |  +----------------------+        +----------------------+        +----------------------+  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ol type="1"><li><p><strong>客户端</strong></p><ul><li>建立 TCP 连接到服务器 <code>IP:port</code>。</li><li>将自定义 <code>Packet</code> 数据通过 <code>send()</code>推送。</li></ul></li><li><p><strong>主线程（Reactor）</strong></p><ul><li><strong>初始化 epoll</strong>，注册<code>listen_fd</code>（TCP监听套接字）。</li><li><strong>Accept</strong>：当 <code>listen_fd</code> 可读(<code>EPOLLIN</code>) 时，调用 <code>accept()</code> 获取<code>conn_fd</code>，并将其加入 epoll 监听。</li><li><strong>事件分发</strong>：对 <code>conn_fd</code> 上的<code>EPOLLIN</code> / <code>EPOLLOUT</code> 事件，封装成<code>EventTask</code>，并提交到线程池处理队列。</li></ul></li><li><p><strong>线程池（Worker）</strong></p><ul><li><strong>Task队列</strong>：主线程投递任务，Worker从队列中拉取。</li><li><strong>Protocol 处理</strong>：调用 <code>Protocol</code> 对象的<code>tryReceivePacket(Packet&amp;)</code> 或<code>flushSendBuffer()</code>，执行底层 I/O 并管理<code>send_buffer_</code> / <code>recv_buffer_</code>。</li><li><strong>Packet解析</strong>：<code>Protocol::parseFromBuffer()</code>将流缓冲区数据拆分成完整 <code>Packet</code>。</li><li><strong>业务回调</strong>：将解析后的 <code>Packet</code>分发给上层逻辑（例如消息路由）。</li></ul></li></ol><h3 id="22-核心类和接口">2.2 核心类和接口</h3><h4 id="221-iprotocol-接口">2.2.1 <code>IProtocol</code> 接口</h4><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">IProtocol</span> <span class="token punctuation">{</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token keyword">enum</span> <span class="token keyword">class</span> <span class="token class-name">ReadStatus</span> <span class="token punctuation">{</span> OK<span class="token punctuation">,</span> NeedRetry<span class="token punctuation">,</span> Error <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">IProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>    <span class="token keyword">virtual</span> ReadStatus <span class="token function">tryReceivePacket</span><span class="token punctuation">(</span>Packet<span class="token operator">&amp;</span> pkt<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">enqueuePacket</span><span class="token punctuation">(</span><span class="token keyword">const</span> Packet<span class="token operator">&amp;</span> pkt<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">virtual</span> <span class="token keyword">bool</span> <span class="token function">flushSendBuffer</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">&amp;</span> saved_errno<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">virtual</span> <span class="token keyword">bool</span> <span class="token function">hasPendingSendData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="222-tcpprotocol-实现">2.2.2 <code>TcpProtocol</code> 实现</h4><ul><li><strong>底层 I/O</strong>：<code>recv()</code> /<code>send()</code>。</li><li><strong>缓冲管理</strong>：维护 <code>recv_buffer_</code>用于流式读取，<code>send_buffer_</code> 用于缓存待发数据。</li><li><strong>协议解析</strong>：<code>parseFromBuffer()</code> 根据固定头(magic + length + checksum) 提取完整包。</li></ul><h4 id="223-threadpool">2.2.3 <code>ThreadPool</code></h4><ul><li><strong>线程数量</strong>：可配置，典型为 CPU 核数 * 2。</li><li><strong>队列</strong>：无界或有界队列，防止过载时回压。</li><li><strong>任务类型</strong>：封装 <code>conn_fd</code>和事件类型，回调 <code>IProtocol</code> 方法。</li></ul><hr><h2 id="3-当前数据流与事件流程">3. 当前数据流与事件流程</h2><ol type="1"><li><p><strong>客户端发送</strong></p><ul><li>客户端将 <code>Packet::serialize()</code> 得到的字节流，调用<code>send()</code> 发往服务器。</li></ul></li><li><p><strong>服务器 Accept</strong></p><ul><li>主线程通过 epoll 捕获 <code>listen_fd</code> 的新连接事件，建立<code>conn_fd</code> 并注册。</li></ul></li><li><p><strong>数据到达</strong></p><ul><li>客户端数据到达 <code>conn_fd</code>，epoll 触发<code>EPOLLIN</code>。</li></ul></li><li><p><strong>事件分发</strong></p><ul><li>主线程封装<code>EventTask(conn_fd, EPOLLIN)</code>，投递到线程池。</li></ul></li><li><p><strong>协议层读取</strong></p><ul><li>Worker 调用 <code>TcpProtocol::tryReceivePacket(pkt)</code>，内部<code>recv()</code> 数据至 <code>recv_buffer_</code>，并尝试<code>parseFromBuffer()</code>。</li></ul></li><li><p><strong>Packet 回调</strong></p><ul><li>成功解析后，得到 <code>Packet</code> 对象，交给上层<code>onPacketReceived(pkt)</code> 处理。</li></ul></li><li><p><strong>响应发送</strong></p><ul><li>如果有回复，调用 <code>Protocol::enqueuePacket()</code>，接着<code>flushSendBuffer()</code> 写数据，可能触发 <code>EPOLLOUT</code>事件。</li></ul></li></ol><hr><h2 id="4-存在的局限与瓶颈">4. 存在的局限与瓶颈</h2><ol type="1"><li><strong>单协议支持</strong>：仅限TCP，不支持无连接或多播协议（UDP）。</li><li><strong>Packet类型固定</strong>：仅支持一种包格式，无法灵活扩展命令/心跳/文件传输等。</li><li><strong>同步 I/O</strong>：目前基于<code>recv/send</code>，阻塞或半阻塞模式下吞吐受限。</li><li><strong>扩展困难</strong>：增加新协议或包类型需侵入式修改现有<code>Protocol</code> 类。</li></ol><hr><h2 id="5-未来重构方案">5. 未来重构方案</h2><h3 id="51-多协议支持">5.1 多协议支持</h3><ul><li><strong>策略模式</strong>：定义 <code>IProtocol</code>，实现<code>TcpProtocol</code>、<code>UdpProtocol</code>、<code>QuicProtocol</code>等。</li><li><strong>工厂模式</strong>：根据配置或 URI Scheme(<code>tcp://</code>、<code>udp://</code>) 动态创建<code>IProtocol</code> 实例。</li><li><strong>异步 I/O</strong>：引入 <code>Boost.Asio</code> 或<code>io_uring</code>，统一封装多协议异步操作。</li></ul><h3 id="52-多包类型">5.2 多包类型</h3><ul><li><strong>IPacket 接口</strong>：定义 <code>IPacket</code>基类，不同业务<code>VideoPacket</code>、<code>ControlPacket</code>、<code>HeartbeatPacket</code>继承。</li><li><strong>PacketFactory</strong>：维护<code>typeId</code>→<code>IPacket</code>反序列化函数映射，解耦协议与包结构。</li><li><strong>协议层处理</strong>：<code>IProtocol::tryReceivePacket(shared_ptr&lt;IPacket&gt;&amp; pkt)</code>，协议只负责流切包，上层负责反序列化。</li></ul><h3 id="53-架构扩展与优化">5.3 架构扩展与优化</h3><ul><li><strong>多进程 +SO_REUSEPORT</strong>：提升并发连接接入能力，减少锁竞争。</li><li><strong>零拷贝</strong>：结合 <code>splice()</code>,<code>vmsplice()</code> 或 <code>io_uring</code>实现文件/网络零拷贝。</li><li><strong>负载均衡</strong>：使用 LVS 或 Nginx前置负载均衡，将流量分发至多实例；</li><li><strong>配置中心</strong>：使用 Consul/Eureka管理协议版本、端口和包格式。</li></ul><hr><h2 id="6-结语">6. 结语</h2><p>本报告聚焦<strong>网络协议层面</strong>，从当前 TCP自定义协议服务器的 Reactor +线程池架构、数据流程到核心类设计进行了详述，并给出支持多协议、多包类型的重构方案。通过引入设计模式与高性能I/O，可以构建一套<strong>高可用、可扩展</strong>的通用协议服务器框架。</p>]]></content>
      
      
      <categories>
          
          <category> 开发记录 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> C++ </tag>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>自定义协议栈服务器开发-4</title>
      <link href="/2025/05/26/%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8D%8F%E8%AE%AE%E6%A0%88%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BC%80%E5%8F%91-4/"/>
      <url>/2025/05/26/%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8D%8F%E8%AE%AE%E6%A0%88%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BC%80%E5%8F%91-4/</url>
      
        <content type="html"><![CDATA[<h2 id="一ioctl通用设备控制接口">一、<code>ioctl</code>：通用设备控制接口</h2><h3 id="1-什么是-ioctlfd-request-argp">1. 什么是<code>ioctl(fd, request, argp)</code>？</h3><ul><li><code>fd</code>：之前用 <code>open()</code>得到的设备文件描述符（这里是 <code>/dev/video0</code>）。</li><li><code>request</code>：一个数字常量，告诉内核“我要对这个设备做什么操作”。</li><li><code>argp</code>：指向一个结构体或整数的指针，存放或接收额外的参数／返回值。</li></ul><blockquote><p>简单类比：</p><ul><li><code>read(fd, buf, len)</code>：从设备读数据</li><li><code>write(fd, buf, len)</code>：向设备写数据</li><li><code>ioctl(fd, XXX, &amp;y)</code>：向设备发送“指令”XXX，可能携带或返回数据y</li></ul></blockquote><h3 id="2-v4l2-常用的几个-ioctl-请求request">2. V4L2 常用的几个<code>ioctl</code> 请求（request）</h3><table><thead><tr><th>请求宏</th><th>作用</th></tr></thead><tbody><tr><td><code>VIDIOC_REQBUFS</code></td><td>“请为我申请 N 个缓冲区”（参数是<code>v4l2_requestbuffers</code>）</td></tr><tr><td><code>VIDIOC_QUERYBUF</code></td><td>“告诉我第 i 个缓冲区的大小和在内核空间的偏移量”（参数是<code>v4l2_buffer</code>）</td></tr><tr><td><code>VIDIOC_QBUF</code></td><td>“把编号为 i 的空缓冲区放入内核的采集队列”，让驱动往里写新帧</td></tr><tr><td><code>VIDIOC_DQBUF</code></td><td>“从内核队列里取出一个已写满帧的缓冲区”，交给用户进程处理</td></tr><tr><td><code>VIDIOC_STREAMON</code></td><td>“启动流模式”，开始不停往缓冲区写入帧</td></tr><tr><td><code>VIDIOC_STREAMOFF</code></td><td>“停止流模式”，停止往缓冲区写帧</td></tr></tbody></table><ul><li><strong><code>VIDIOC_REQBUFS</code></strong>：告诉驱动“我想用 mmap模式，一次准备读取 4 帧数据，快给我分配 4 块内核缓冲区”。</li><li><strong><code>VIDIOC_QUERYBUF</code></strong>：对每块缓冲区执行此命令后，<code>v4l2_buffer</code>结构体会告诉你：<ul><li><code>length</code>：这块缓存的字节大小</li><li><code>m.offset</code>：这块缓存相对于设备文件起始处的偏移量</li></ul></li><li><strong><code>VIDIOC_QBUF</code></strong>：把一块空的、已经<code>QUERYBUF</code>过的缓存放到“待写入”队列里。驱动拿到后会往里写下一帧。</li><li><strong><code>VIDIOC_STREAMON</code> /<code>STREAMOFF</code></strong>：启动或停止“流”模式，让驱动开始/停止循环地往这些队列缓存里写入／停止写入帧。</li><li><strong><code>VIDIOC_DQBUF</code></strong>：从“已写入”队列里取出一个缓存，告诉你它是哪块（<code>buf.index</code>），以及写入了多少字节（<code>buf.bytesused</code>），用户层就能处理这帧数据。</li></ul><h2 id="二mmap内存映射让用户进程直接访问缓冲区">二、<code>mmap</code>：内存映射，让用户进程直接访问缓冲区</h2><h3 id="1-为什么要用-mmap-而不是-read">1. 为什么要用 <code>mmap</code>而不是 <code>read</code>？</h3><ul><li><strong><code>read()</code></strong>：每次都得内核→用户空间拷贝一次，效率较低。</li><li><strong><code>mmap()</code></strong>：把内核分配的那块物理内存“映射”到用户进程地址空间，同一块内存，内核和用户共用一份，不用额外拷贝，速度更快。</li></ul><h3 id="2-mmap-怎么用">2. <code>mmap</code> 怎么用？</h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">void</span><span class="token operator">*</span> addr <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span>    <span class="token keyword">nullptr</span><span class="token punctuation">,</span>       <span class="token comment">// 让系统自动选择一个合适的起始地址</span>    length<span class="token punctuation">,</span>        <span class="token comment">// 映射大小（字节数）</span>    PROT_READ      <span class="token comment">// 用户进程可读</span>    <span class="token operator">|</span> PROT_WRITE<span class="token punctuation">,</span>  <span class="token comment">// 用户进程可写（对 MMAP 这种设备来说一般写入无用，但必须有）</span>    MAP_SHARED<span class="token punctuation">,</span>    <span class="token comment">// 多个进程（内核/用户）共享这块映射，写到它会通知内核</span>    fd<span class="token punctuation">,</span>            <span class="token comment">// 哪个文件或设备</span>    offset         <span class="token comment">// 从文件(设备)的哪个偏移量开始映射</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><strong><code>length</code></strong>：我们之前用<code>VIDIOC_QUERYBUF</code> 得到过，它告诉这个缓冲区有多大。</li><li><strong><code>offset</code></strong>：同样来自<code>VIDIOC_QUERYBUF</code>，表示内核里这块缓冲区相对于设备文件开始的位置。</li><li>返回值 <code>addr</code>：之后你就可以像读普通内存一样读<code>addr[0]</code>、<code>addr[1]</code>…，读到的就是摄像头给你写的帧数据。</li></ul><h3 id="3-映射后你需要做两件事">3. 映射后，你需要做两件事：</h3><ol type="1"><li><strong>入队</strong>（<code>VIDIOC_QBUF</code>）——让驱动知道“这块内存我准备好了，快写新帧进来”。</li><li><strong>取队</strong>（<code>VIDIOC_DQBUF</code>）——告诉驱动“我处理完了，把写好的帧拿给我”，此时<code>buf.index</code> 告诉你是哪块，<code>bytesused</code>告诉你写了多少字节，你就用 <code>mmap</code>返回的指针去拷贝或解码。</li></ol><p>最终，<strong>零拷贝</strong>、高并发地完成了“生产（驱动写帧）—消费（用户进程读帧）”的循环。</p>]]></content>
      
      
      <categories>
          
          <category> 开发记录 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> C++ </tag>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>自定义协议栈服务器开发-3</title>
      <link href="/2025/05/26/%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8D%8F%E8%AE%AE%E6%A0%88%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BC%80%E5%8F%91-3/"/>
      <url>/2025/05/26/%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8D%8F%E8%AE%AE%E6%A0%88%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BC%80%E5%8F%91-3/</url>
      
        <content type="html"><![CDATA[<h2 id="jigsaw-代码流程一步步来看">🧩 代码流程一步步来看：</h2><h3 id="1-启动服务器maincpp">1.启动服务器（<code>main.cpp</code>）：</h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    Server <span class="token function">server</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    server<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-初始化监听-socketserversetupserversocket">2. 初始化监听socket（<code>Server::setupServerSocket</code>）：</h3><ul><li>创建 socket</li><li>绑定端口</li><li>设置非阻塞</li><li>开始监听</li></ul><h3 id="3-epoll-注册监听-socket">3. epoll 注册监听 socket：</h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epoll_fd<span class="token punctuation">,</span> EPOLL_CTL_ADD<span class="token punctuation">,</span> listen_fd<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>告诉 epoll：“有新连接来了请通知我。”</p><hr><h3 id="4-主循环serverrun">4.主循环（<code>Server::run()</code>）：</h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">epoll_wait</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 阻塞等待事件</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>事件 in events<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>事件来自 listen_fd<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 接受新连接，并注册到 epoll</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token comment">// 有客户端发消息，调用 Connection::onReadable()</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h3 id="5-每个连接怎么处理connection">5.每个连接怎么处理（<code>Connection</code>）：</h3><ul><li><code>onReadable()</code> 从 socket 读取数据</li><li>把数据丢到线程池处理（比如解析、计算、构造回复）</li><li>线程池的线程处理后调用回调函数发送响应</li></ul><hr><h3 id="6-线程池作用">6. 线程池作用：</h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">thread_pool<span class="token operator">-&gt;</span><span class="token function">enqueue</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">=</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>    <span class="token comment">// 处理业务逻辑</span>    <span class="token function">send</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token string">"Hello"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>这样就不会卡住主线程，能并发处理很多连接。</p><hr><h2 id="bulb-总结一句话解释整个流程">💡 总结：一句话解释整个流程</h2><blockquote><p><strong>主线程只管 epoll +分发，线程池负责干活（处理数据并回复），所有 socket都是非阻塞的。</strong></p></blockquote><pre><code>             [客户端1]                |             [客户端2]                |             [客户端3]                |               ...                |             [客户端N]                |    ╔════════════════╗    ║          内核 (TCP/IP栈)    ║    ║                             ║    ║  listen_fd (监听 socket)    ║◄─── bind(), listen()    ║          │                 ║    ║          │连接到达时        ║    ║          ▼                 ║    ║  conn_fd1 (连接 socket) ◄───── 客户端1接入    ║  conn_fd2 (连接 socket) ◄───── 客户端2接入    ║  conn_fd3 (连接 socket) ◄───── 客户端3接入    ║        ...                  ║    ╚════════════════╝                │           [epoll 监听多个 conn_fd]                │        [线程池处理业务逻辑]</code></pre><h2 id="mag-一步步解释结构组成">🔍 一步步解释结构组成：</h2><h3 id="1-listen_fd监听-socket">1. <code>listen_fd</code>：监听socket</h3><ul><li>你用 <code>socket()</code>, <code>bind()</code>,<code>listen()</code> 创建的最初的 socket。</li><li>只负责监听端口是否有新的连接进来。</li><li>当有客户端来连接，就会触发 <code>epoll</code> 事件，你再用<code>accept()</code> 把连接拿出来。</li></ul><h3 id="2-conn_fd已连接-socket">2. <code>conn_fd</code>：已连接socket</h3><ul><li>每次 <code>accept()</code> 返回一个新的socket，这就是你和客户端之间通信的 socket。</li><li>每个客户端一个连接，<strong>一个 fd</strong>。</li><li>你用 <code>read()/write()</code> 或 <code>recv()/send()</code>来与该客户端进行数据交换。</li></ul><h3 id="3-epoll-监听这些连接-fd">3. <code>epoll</code> 监听这些连接fd</h3><ul><li><code>epoll</code> 用来监听 <code>conn_fd1</code>,<code>conn_fd2</code>, …, 发生事件（如可读/可写）。</li><li>一旦某个 fd 有数据，epoll 告诉你，然后你就用线程池去处理。</li></ul><h3 id="4-线程池做处理不阻塞主线程">4. 线程池做处理，不阻塞主线程</h3><ul><li>主线程只负责接收连接、触发 epoll。</li><li>每当有数据到达，就把这个事件扔进线程池处理。</li></ul><h2 id="white_check_mark-为什么这种设计适合高并发">✅为什么这种设计适合高并发？</h2><table><thead><tr><th>优势</th><th>说明</th></tr></thead><tbody><tr><td>高性能 epoll</td><td>支持百万连接，O(1) 的事件通知</td></tr><tr><td>每个客户端独立 fd</td><td>无共享，不影响彼此</td></tr><tr><td>非阻塞 IO</td><td>不卡线程</td></tr><tr><td>线程池</td><td>避免线程爆炸，任务处理更平滑</td></tr><tr><td>可扩展性强</td><td>后期可加入定时器、连接池、协程等机制</td></tr></tbody></table><h2 id="-举个更直观的例子">🛠 举个更直观的例子：</h2><p>假设你写了一个 Web 服务器监听 8080：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> listen_fd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">bind</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">listen</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">,</span> SOMAXCONN<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>你用 epoll 监听这个 <code>listen_fd</code>，发现有连接来：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> conn_fd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 得到客户端 socket</span><span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epfd<span class="token punctuation">,</span> EPOLL_CTL_ADD<span class="token punctuation">,</span> conn_fd<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 加入 epoll 监听</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>从现在开始，<code>conn_fd</code> 就是你跟某个客户端通信的通道，你用<code>read(conn_fd, buf, len)</code> 来收消息，用<code>write(conn_fd, buf, len)</code> 发消息。</p><p>当你有成千上万个连接时，你 epoll 管理的 fd 列表就像：</p><pre class="line-numbers language-none"><code class="language-none">epoll 监听：- conn_fd1- conn_fd2- conn_fd3- ...- conn_fd9999<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>而且所有连接共用同一个 epoll 和线程池，不需要开成千个线程。</p><hr><h2 id="pushpin-总结一句话">📌 总结一句话：</h2><blockquote><p><strong>服务器本身只有一个监听socket（listen_fd），但每个客户端连接都会创建一个独立的通信socket（conn_fd），由 epoll 来统一管理这些 fd的事件，并用线程池异步处理它们。</strong></p></blockquote><h3 id="重构方案概览"><strong>重构方案概览</strong></h3><table><thead><tr><th style="text-align: center;">模块</th><th style="text-align: center;">原问题</th><th style="text-align: center;">重构方法</th><th style="text-align: center;">代码示例</th><th style="text-align: center;">不改的坏处</th><th style="text-align: center;">改动的好处</th></tr></thead><tbody><tr><td style="text-align: center;"><strong>协议层</strong></td><td style="text-align: center;">无发送缓冲区导致数据丢失</td><td style="text-align: center;">拆分<code>send_packet</code>为数据入队和实际发送</td><td style="text-align: center;"><code>enqueuePacket()</code> +<code>flushSendBuffer()</code></td><td style="text-align: center;">数据可能丢失</td><td style="text-align: center;">支持部分发送和重试机制</td></tr><tr><td style="text-align: center;"><strong>协议层</strong></td><td style="text-align: center;">无接收缓冲区导致粘包处理错误</td><td style="text-align: center;">引入接收缓冲区</td><td style="text-align: center;"><code>tryReceivePacket()</code></td><td style="text-align: center;">数据解析失败</td><td style="text-align: center;">正确处理TCP流式数据</td></tr><tr><td style="text-align: center;"><strong>连接层</strong></td><td style="text-align: center;">直接操作裸指针导致线程竞争</td><td style="text-align: center;">使用智能指针+互斥锁</td><td style="text-align: center;"><code>std::shared_ptr&lt;Connection&gt;</code></td><td style="text-align: center;">数据竞争导致崩溃</td><td style="text-align: center;">线程安全读写</td></tr><tr><td style="text-align: center;"><strong>事件循环</strong></td><td style="text-align: center;">递归调用<code>handleWrite</code></td><td style="text-align: center;">通过<code>EPOLLOUT</code>事件触发发送</td><td style="text-align: center;"><code>triggerWriteEvent()</code></td><td style="text-align: center;">栈溢出风险</td><td style="text-align: center;">解耦读写逻辑</td></tr><tr><td style="text-align: center;"><strong>资源管理</strong></td><td style="text-align: center;">手动关闭socket易遗漏</td><td style="text-align: center;">RAII包装文件描述符</td><td style="text-align: center;"><code>ScopedFileDescriptor</code></td><td style="text-align: center;">资源泄漏</td><td style="text-align: center;">自动释放资源</td></tr></tbody></table><h4 id="阻塞模式-vs-非阻塞模式的核心区别"><strong>阻塞模式 vs非阻塞模式的核心区别</strong></h4><table><thead><tr><th style="text-align: center;"><strong>特征</strong></th><th style="text-align: center;"><strong>阻塞模式</strong></th><th style="text-align: center;"><strong>非阻塞模式</strong></th></tr></thead><tbody><tr><td style="text-align: center;"><strong>read/write 行为</strong></td><td style="text-align: center;">操作未完成时线程挂起，直到数据就绪或超时</td><td style="text-align: center;">操作立即返回，若数据未就绪返回错误码（<code>EAGAIN</code>或 <code>EWOULDBLOCK</code>）</td></tr><tr><td style="text-align: center;"><strong>适用场景</strong></td><td style="text-align: center;">简单客户端、低并发服务端</td><td style="text-align: center;">高并发服务端（如 Nginx、Redis）</td></tr><tr><td style="text-align: center;"><strong>资源占用</strong></td><td style="text-align: center;">每个连接需独占线程，线程数随连接数线性增长</td><td style="text-align: center;">单线程可处理数千连接（通过事件驱动）</td></tr></tbody></table><h3 id="阻塞-vs-非阻塞模式的核心区别"><strong>阻塞 vs非阻塞模式的核心区别</strong></h3><table><thead><tr><th style="text-align: center;"><strong>socket 模式</strong></th><th style="text-align: center;"><strong><code>read</code>行为</strong></th><th style="text-align: center;"><strong>代码表现</strong></th></tr></thead><tbody><tr><td style="text-align: center;"><strong>阻塞模式</strong></td><td style="text-align: center;">若内核缓冲区无数据，<code>read</code><strong>挂起线程</strong>，直到数据到达或超时。</td><td style="text-align: center;">线程卡在 <code>read</code>处，无法处理其他任务。</td></tr><tr><td style="text-align: center;"><strong>非阻塞模式</strong></td><td style="text-align: center;">若内核缓冲区无数据，<code>read</code><strong>立即返回错误</strong>，设置 <code>errno</code> 为<code>EAGAIN</code> 或 <code>EWOULDBLOCK</code>。</td><td style="text-align: center;">线程继续执行，需检查 <code>errno</code>并重试。</td></tr></tbody></table><h3 id="为何必须使用接收缓冲区"><strong>为何必须使用接收缓冲区？</strong></h3><h4 id="tcp-协议的核心特性"><strong>TCP 协议的核心特性</strong></h4><ul><li><strong>流式协议</strong>：无消息边界，数据像水流一样连续。</li><li><strong>可能分片</strong>：一个应用层数据包可能被拆分为多个TCP段发送。</li></ul><h4 id="示例粘包与半包"><strong>示例：粘包与半包</strong></h4><pre class="line-numbers language-none"><code class="language-none">客户端发送： [Packet1][Packet2]服务端接收： [Pa][cket1Packet2][...] （分多次到达）<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li><strong>无缓冲区</strong>：无法正确识别 <code>Packet1</code> 和<code>Packet2</code> 的边界。</li><li><strong>有缓冲区</strong>：积累数据，直到能提取完整包。</li></ul>]]></content>
      
      
      <categories>
          
          <category> 开发记录 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> C++ </tag>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>自定义协议栈服务器开发-2</title>
      <link href="/2025/05/26/%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8D%8F%E8%AE%AE%E6%A0%88%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BC%80%E5%8F%91-2/"/>
      <url>/2025/05/26/%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8D%8F%E8%AE%AE%E6%A0%88%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BC%80%E5%8F%91-2/</url>
      
        <content type="html"><![CDATA[<h2 id="自定义协议栈服务器开发-2">自定义协议栈服务器开发-2</h2><h2 id="dart-目标改造为高性能通信架构">🎯目标：改造为高性能通信架构</h2><p>原始架构是：</p><ul><li>🚫 阻塞 I/O（<code>recv/send</code> 会卡住）</li><li>🚫 单线程处理（一个客户端连接就卡住一个线程）</li><li>🚫 同步爬虫、同步协议处理</li></ul><p>目标：</p><p>✅ <strong>非阻塞 I/O</strong> ✅ <strong>Reactor模式（epoll）监听连接和可读事件</strong> ✅<strong>线程池处理业务逻辑</strong>（如协议解析、爬虫） ✅<strong>主线程永远不阻塞，不做耗时操作</strong></p><h3 id="white_check_mark-阻塞的地方在哪">✅<strong>阻塞的地方在哪？</strong></h3><ol type="1"><li><strong>客户端（Client）：</strong><ul><li><code>connect(sock_fd, ...)</code>：会<strong>阻塞</strong>直到连接成功或失败。</li><li><code>recv(...)</code> 或<code>proto.receive_packet(...)</code>：在没有数据可读时<strong>会阻塞</strong>，直到服务器发送了数据或连接断开。</li><li><code>std::getline(std::cin, input)</code>：会阻塞等待用户输入。</li></ul></li><li><strong>服务器（Server）：</strong><ul><li><code>accept(server_fd, ...)</code>：<strong>阻塞等待客户端连接</strong>，直到某个客户端连接成功才返回。</li><li><code>recv(...)</code> 或<code>proto.receive_packet(...)</code>：<strong>阻塞</strong>，直到有数据到来，或者客户端断开连接。</li><li><code>send(...)</code> 或<code>proto.send_packet(...)</code>：在某些情况下（例如发送缓冲区满），也可能<strong>阻塞</strong>。</li></ul></li></ol><p>项目结构</p><pre class="line-numbers language-none"><code class="language-none">project_root/├── include/│   ├── core/               ← 数据结构、协议类（Packet.hpp）│   ├── net/                ← 网络通信（Connection.hpp）│   ├── threading/          ← 线程池（ThreadPool.hpp）│   ├── vision/             ← 图像处理（OpenCV 封装类）│   └── app/                ← 主应用接口（ServerApp.hpp）│├── src/│   ├── core/               ← Packet.cpp、Protocol.cpp│   ├── net/                ← Connection.cpp、ReactorServer.cpp、Client.cpp│   ├── threading/          ← ThreadPool.cpp│   ├── vision/             ← Crawler.cpp（如果做图像处理）、未来的OpenCV功能│   └── app/                ← Server.cpp、App类封装│├── main/│   └── main.cpp            ← 仅程序启动入口（含 main 函数）│├── lib/                    ← 用于保存构建输出的 .so/.a 文件├── build/                  ← CMake 构建输出（加入 .gitignore）├── tests/                  ← GTest 单元测试│   ├── PacketTest.cpp│   └── CMakeLists.txt│├── third_party/            ← OpenCV/GTest 等第三方库├── CMakeLists.txt          ← 项目主构建入口├── run.sh                  ← 编译 + 运行脚本└── README.md<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="rocket-整体目标写一个高性能服务器">🚀整体目标：写一个<strong>高性能服务器</strong></h2><p>我们要实现一个这样的服务器：</p><ul><li>能同时处理很多客户端连接（比如上千个）。</li><li>每个客户端都可以发消息，服务器处理完后回消息。</li><li>不能阻塞 —— 有一个慢的客户端不应该卡住整个服务器。</li><li>要<strong>充分利用多核 CPU</strong>，用线程池处理逻辑。</li></ul><hr><h2 id="brain-核心概念一为什么不用传统方式">🧠核心概念一：为什么不用传统方式？</h2><p>传统的 <code>accept-read-write</code> 方式大致像这样：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">int</span> client_fd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token function">read</span><span class="token punctuation">(</span>client_fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">write</span><span class="token punctuation">(</span>client_fd<span class="token punctuation">,</span> response<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="问题">问题：</h3><ul><li><code>accept</code> 和 <code>read</code>是阻塞的：如果一个客户端连接了但不发消息，服务器就一直卡住。</li><li>无法同时处理多个客户端（除非开线程/进程，很慢）。</li></ul><hr><h2 id="brain-核心概念二epoll-是什么">🧠 核心概念二：epoll 是什么？</h2><p><code>epoll</code> 是 Linux下的一个<strong>事件通知机制</strong>，用于同时管理多个文件描述符（比如socket）。它就像一个“电铃监控中心”，告诉你：</p><blockquote><p>“嘿，哪个 socket 上有人发消息了，你可以去处理了。”</p></blockquote><p>这样，你不用一直 <code>read()</code> 检查每个 socket，而是等着 epoll通知你哪个客户端“响铃”了（即有事件，比如可读）。</p><h3 id="epoll-流程">epoll 流程：</h3><ol type="1"><li>把监听 socket（listen_fd）和客户端 socket 注册到 epoll。</li><li>等待 <code>epoll_wait()</code> 通知哪个 socket 有事件。</li><li>读取/处理这些事件。</li><li>再回到 <code>epoll_wait()</code>。</li></ol><hr><h2 id="brain-核心概念三为什么用线程池">🧠核心概念三：为什么用线程池？</h2><ul><li>epoll 是<strong>IO多路复用</strong>，能告诉你“哪个 socket有消息了”。</li><li>但业务逻辑可能很复杂，不能在主线程里直接处理。</li><li>所以用一个线程池，让多个线程处理“读到的数据”。</li></ul><hr><h2 id="bricks-每个组件的作用">🧱 每个组件的作用：</h2><table><thead><tr><th>文件</th><th>作用</th></tr></thead><tbody><tr><td><code>main.cpp</code></td><td>启动服务器</td></tr><tr><td><code>Server.h/cpp</code></td><td>服务器主逻辑（epoll 注册/等待/事件分发）</td></tr><tr><td><code>Connection.h/cpp</code></td><td>表示一个客户端连接，读取数据后扔到线程池</td></tr><tr><td><code>ThreadPool.h/cpp</code></td><td>多线程任务池，负责处理耗时逻辑</td></tr><tr><td><code>Util.h/cpp</code></td><td>工具函数，比如设置非阻塞</td></tr></tbody></table><hr>]]></content>
      
      
      <categories>
          
          <category> 开发记录 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> C++ </tag>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>自定义协议栈服务器开发-1</title>
      <link href="/2025/05/26/%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8D%8F%E8%AE%AE%E6%A0%88%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BC%80%E5%8F%91-1/"/>
      <url>/2025/05/26/%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8D%8F%E8%AE%AE%E6%A0%88%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BC%80%E5%8F%91-1/</url>
      
        <content type="html"><![CDATA[<h2 id="自定义协议栈服务器开发-1">自定义协议栈服务器开发-1</h2><table><thead><tr><th>文件名</th><th>作用描述</th></tr></thead><tbody><tr><td><code>Packet.hpp/.cpp</code></td><td>定义数据包结构，序列化和反序列化函数</td></tr><tr><td><code>Protocol.hpp/.cpp</code></td><td>网络通信的封装（send/recv）</td></tr><tr><td><code>Server.cpp</code></td><td>TCP服务端，接收客户端消息并回复</td></tr><tr><td><code>Client.cpp</code></td><td>TCP客户端，发送消息并读取服务器回应</td></tr></tbody></table><p>大厂级高性能 TCP 服务端架构思路及示例代码片段，基于 <strong>Reactor模式 + epoll + 线程池</strong>，把网络 I/O和业务处理彻底拆开，保证主线程专注于I/O，所有耗时业务（如爬虫、协议解析）都扔给工作线程去做。</p><h3 id="white_check_mark-1-单线程--非阻塞-io">✅ 1. 单线程 + 非阻塞I/O</h3><p>传统的服务端模型（例如阻塞式<code>accept-read-write</code>）每个客户端都需要一个线程。假设每个线程消耗1MB 栈空间，1万连接就需要 10GB 内存，而且线程调度开销极大。</p><p>非阻塞 I/O + epoll只需要<strong>一个主线程</strong>就可以<strong>同时管理上万连接</strong>。它不会因为某个连接的数据没准备好而阻塞。</p><h3 id="white_check_mark-2-epoll-是-o1-的-io-多路复用">✅ 2. epoll 是O(1) 的 I/O 多路复用</h3><ul><li><code>select</code>/<code>poll</code> 每次都要遍历所有fd，时间复杂度 O(n)。</li><li><code>epoll</code>只返回<strong>就绪的文件描述符列表</strong>，时间复杂度接近 O(1)。</li></ul><p>所以 <code>epoll</code> 对大并发连接场景特别高效。</p><h3 id="white_check_mark-3-边沿触发edge-triggered减少系统调用">✅ 3.边沿触发（Edge Triggered）减少系统调用</h3><p>epoll 支持两种模式：</p><ul><li>Level Trigger（水平触发）：数据没读完会一直通知。</li><li><strong>EdgeTrigger（边沿触发）</strong>：只在状态变化时通知一次，需要把 buffer一次读干净。</li></ul><p>这显著减少了 <code>epoll_wait()</code>的返回次数，降低系统调用频率。</p><h3 id="white_check_mark-4-主线程不做业务线程池异步执行逻辑">✅ 4.主线程不做业务，线程池异步执行逻辑</h3><p>主线程只管网络事件，不涉及业务计算（如爬虫、数据库等耗时任务），这样它能持续保持高响应性。</p><p>业务线程通过线程池统一调度，充分利用多核 CPU的并发能力，避免线程频繁创建/销毁的性能浪费。</p><h3 id="white_check_mark-5-内存复用和缓冲池可拓展优化">✅ 5.内存复用和缓冲池（可拓展优化）</h3><ul><li>不频繁 new/delete → 对象池（Object Pool）</li><li>避免多线程 malloc/free 抢锁 → Arena 分配器</li><li>提前准备 buffer，提高 cache 命中率</li></ul><h3 id="white_check_mark-6-异步写回避免阻塞">✅ 6. 异步写回避免阻塞</h3><p>如果你直接在主线程或业务线程里 <code>write()</code>客户端，可能因为客户端读太慢导致阻塞（内核 send buffer 满）。</p><p>我们这里的做法：</p><ul><li>把写数据加入一个 <code>outbuf</code> 中</li><li>主线程监听 EPOLLOUT 时间再去写</li><li>一次写不完就下次继续</li></ul><p>这样即使写出慢，也不会阻塞主线程或业务线程。</p><h3 id="white_check_mark-7-高可扩展性">✅ 7. 高可扩展性</h3><p>你可以非常轻松地做出扩展：</p><ul><li>✅ 加缓存（如 LRU）</li><li>✅ 加限流（如令牌桶）</li><li>✅ 加负载均衡（Nginx 前置）</li><li>✅ 微服务化部署（爬虫、数据分析、识别模块独立服务）</li></ul><h2 id="wrench-总结架构优势一图看懂">🔧 总结架构优势（一图看懂）</h2><table><thead><tr><th>模块</th><th>技术方案</th><th>好处</th></tr></thead><tbody><tr><td>I/O 多路复用</td><td>epoll + 非阻塞 I/O</td><td>管理上万连接，高性能低开销</td></tr><tr><td>事件处理</td><td>Reactor 模式</td><td>解耦 I/O 与业务，低延迟响应</td></tr><tr><td>并发处理</td><td>线程池</td><td>高并发、稳定、可复用线程资源</td></tr><tr><td>写回机制</td><td>异步写 + 缓冲区</td><td>不阻塞 I/O，不影响主线程性能</td></tr><tr><td>扩展性</td><td>模块化、插件化</td><td>支持微服务、可水平扩展</td></tr></tbody></table><h2 id="speech_balloon-现代大厂使用案例对比">💬现代大厂使用案例对比</h2><table><thead><tr><th>大厂</th><th>使用模式</th><th>对应点</th></tr></thead><tbody><tr><td>Nginx</td><td>epoll + 非阻塞 + 事件驱动</td><td>完整的 Reactor 模式</td></tr><tr><td>Redis</td><td>单线程 + epoll</td><td>利用 epoll 高效调度请求</td></tr><tr><td>Netty</td><td>Reactor + 线程池 + 编解码器</td><td>和我们这套结构非常相似</td></tr><tr><td>MySQL Proxy</td><td>主线程监听连接 + worker 处理查询</td><td>主从分离的 I/O 与业务处理思想</td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> 开发记录 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> C++ </tag>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>每日Linux_Cpp导航</title>
      <link href="/2025/05/26/%E6%AF%8F%E6%97%A5Linux-Cpp%E5%AF%BC%E8%88%AA/"/>
      <url>/2025/05/26/%E6%AF%8F%E6%97%A5Linux-Cpp%E5%AF%BC%E8%88%AA/</url>
      
        <content type="html"><![CDATA[<h2 id="每日linux_cpp导航">每日Linux_Cpp导航</h2><hr><ol type="1"><li><a href="/2025/05/21/%E6%AF%8F%E6%97%A5Linux-Cpp-1/" title="每日Linux-Cpp-1">每日Linux_Cpp-1</a></li><li><a href="/2025/05/22/%E6%AF%8F%E6%97%A5Linux-Cpp-2/" title="每日Linux-Cpp-2">每日Linux_Cpp-2</a></li><li><a href="/2025/05/23/%E6%AF%8F%E6%97%A5Linux-Cpp-3/" title="每日Linux-Cpp-3">每日Linux_Cpp-3</a></li><li><a href="/2025/05/26/%E6%AF%8F%E6%97%A5Linux-Cpp-4/" title="每日Linux-Cpp-4">每日Linux_Cpp-4</a></li><li><a href="/2025/05/27/%E6%AF%8F%E6%97%A5Linux-Cpp-5/" title="每日Linux-Cpp-5">每日Linux_Cpp-5</a></li><li><a href="/2025/05/28/%E6%AF%8F%E6%97%A5Linux-Cpp-6/" title="每日Linux-Cpp-6">每日Linux_Cpp-6</a></li></ol>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> C++ </tag>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>每日Linux-Cpp-4</title>
      <link href="/2025/05/26/%E6%AF%8F%E6%97%A5Linux-Cpp-4/"/>
      <url>/2025/05/26/%E6%AF%8F%E6%97%A5Linux-Cpp-4/</url>
      
        <content type="html"><![CDATA[<h2 id="每日linux-cpp-4">每日Linux-Cpp-4</h2><hr><h3 id="1-虚函数表vtable的实现原理及多态性能损耗"><strong>1.虚函数表(vtable)的实现原理及多态性能损耗</strong></h3><ul><li>原理：每个包含虚函数的类会生成一个虚函数表，存储虚函数指针；对象内存首部包含指向该表的指针(vptr)。动态绑定通过运行时查找虚函数表实现。</li><li>性能损耗：多态调用需额外查表跳转(约 1-2个时钟周期)，嵌入式场景中需权衡灵活性与实时性。</li><li>项目关联：在 OpenCV图像处理基类中，用虚函数实现不同算法的多态调用(如FeatureDetector::detect())。</li></ul><h3 id="2-智能指针的线程安全性及-stdshared_ptr-循环引用问题"><strong>2.智能指针的线程安全性及 std::shared_ptr 循环引用问题</strong></h3><ul><li>线程安全：std::shared_ptr的引用计数原子操作保证线程安全，但指向的堆对象需额外同步。</li><li>循环引用：若 A 持有 B 的shared_ptr, B 也持有 A 的 shared_ptr,引用计数永不归零(两个气球相互牵引，彼此都无法被释放)。</li><li>解决方案：用 std::weak_ptr 替代单向持有关系(如观察者模式中的订阅者列表)。</li><li>项目关联：在模型部署框架中管理 TensorRT 引擎时，用 unique_ptr避免循环引用导致内存泄漏。</li></ul><h3 id="3-const-成员函数与-mutable-关键字的应用场景"><strong>3. const成员函数与 mutable 关键字的应用场景</strong></h3><ul><li>const 成员函数：承诺不修改对象状态 (如 size() const)，允许 const对象调用。</li><li>mutable: 修饰可能被 const 函数修改的成员 (如缓存标记、互斥锁)。</li><li>项目关联：在实时数据采集类中，用 mutable std::mutex 保证 const函数内的线程安全。</li></ul><h3 id="4-c11-右值引用与移动语义的优化原理"><strong>4. C++11右值引用与移动语义的优化原理。</strong></h3><ul><li>右值引用(&amp;&amp;)：标识临时对象，允许资源转移而非拷贝(如std::move())。右值引用可以直接指向右值，也可以通过std::move指向左值；而左值引用只能指向左值(const左值引用也能指向右值)。作为函数形参时，右值引用更灵活。虽然const左值引用也可以做到左右值都接受，但它无法修改，有一定局限性。</li><li>移动构造函数:接管原对象资源(如指针)，将原对象置空避免双重释放，避免了传统的深拷贝的消耗，但是原对象被释放。</li></ul><h3 id="5-嵌入式场景中-volatile-与内存屏障的作用"><strong>5.嵌入式场景中 volatile 与内存屏障的作用</strong></h3><ul><li>volatile：阻止编译器优化对变量的读写(如硬件寄存器映射变量)。</li><li>内存屏障：确保指令执行顺序(如 __sync_synchronize()防止多核缓存不一致)。</li><li>项目关联：在 STM32 中断服务程序中，用 volatile修饰全局计时器变量，配合内存屏障保证数据可见性。</li></ul><h3 id="6-进程间通信-ipc-的5种方式及适用场景"><strong>6. 进程间通信(IPC) 的5种方式及适用场景</strong></h3><ul><li>管道 (Pipe) : 单向通信，父子进程间使用 (如 Shell 命令的 |操作)。</li><li>共享内存：高效大数据传输，需同步机制 (如信号量)。</li><li>消息队列：结构化数据传递，支持多线程异步通信。</li><li>信号 (Signal) : 简单事件通知 (如 SIGINT 终止进程)。</li><li>套接字 (Socket) : 跨网络或本机进程通信。</li></ul><h3 id="7-虚拟内存与物理内存的映射机制-mmu-作用"><strong>7.虚拟内存与物理内存的映射机制 (MMU 作用)</strong></h3><ul><li>MMU 功能：<ul><li>虚拟地址 -&gt; 物理地址转换 (页表查询)。</li><li>内存权限检查 (读/写/执行)。</li><li>TLB 缓存加速地址转换。</li></ul></li><li>项目关联：在嵌入式 AI 推理中，MMU隔离模型权重内存区，防止非法访问。</li></ul><h3 id="8-linux-内核中断处理流程-上半部-vs-下半部"><strong>8. Linux内核中断处理流程 (上半部 vs 下半部)</strong></h3><ul><li>上半部 (Top Half) : 在中断上下文中快速响应(如置标志位)，不可阻塞。</li><li>下半部 (Bottom Half) : 延后处理耗时操作 (如 tasklet 或 workqueue),可调度。</li><li>项目关联：摄像头数据采集时，上半部读取硬件缓冲区，下半部进行图像预处理。</li></ul><h3 id="9-用户态与内核态切换的性能损耗及优化方法"><strong>9.用户态与内核态切换的性能损耗及优化方法。</strong></h3><ul><li>损耗来源：上下文保存/恢复、CPU模式切换(约数百纳秒)。</li><li>优化方法：<ul><li>减少系统调用次数(如批量读写)</li><li>使用mmap映射文件到用户空间。</li><li>内核旁路技术(如 DPDK)</li></ul></li></ul><h3 id="10-编写-linux-内核模块的基本步骤"><strong>10. 编写 Linux内核模块的基本步骤</strong></h3><ol type="1"><li>实现模块初始化函数 (module_init()) 和退出函数 (module_exit())</li><li>注册设备驱动或文件系统接口</li><li>处理并发 (如自旋锁 spin_lock())</li><li>编译为 .ko 文件并加载 (insmod)</li></ol><ul><li>项目关联：在 Jetson Nano 上开发自定义 GPIO驱动时，需编写内核模块实现引脚控制。</li></ul><h3 id="如何设计线程安全的环形缓冲区ring-buffer">如何设计线程安全的环形缓冲区(RingBuffer)？</h3><ul><li>代码如下：  <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">RingBuffer</span> <span class="token punctuation">{</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token function">RingBuffer</span><span class="token punctuation">(</span>size_t size<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">buf_</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">head_</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">tail_</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token keyword">bool</span> <span class="token function">push</span><span class="token punctuation">(</span>unit8_t data<span class="token punctuation">)</span> <span class="token punctuation">{</span>        std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lock</span><span class="token punctuation">(</span>mutex_<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>head_ <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> buf_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> tail_<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>   <span class="token comment">// 满 </span>        buf_<span class="token punctuation">[</span>head_<span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">;</span>        head_ <span class="token operator">=</span> <span class="token punctuation">(</span>head_ <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token function">buf_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">bool</span> <span class="token function">pop</span><span class="token punctuation">(</span>unit8_t<span class="token operator">&amp;</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>        std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lock</span><span class="token punctuation">(</span>mutex_<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>head_ <span class="token operator">==</span> tail_<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>   <span class="token comment">// 空</span>        data <span class="token operator">=</span> buf_<span class="token punctuation">[</span>tail_<span class="token punctuation">]</span><span class="token punctuation">;</span>        tail_ <span class="token operator">=</span> <span class="token punctuation">(</span>tail_ <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> buf_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token keyword">private</span><span class="token operator">:</span>    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>unit8_t<span class="token operator">&gt;</span> buf_<span class="token punctuation">;</span>    size_t head_<span class="token punctuation">,</span> tail_<span class="token punctuation">;</span>    std<span class="token double-colon punctuation">::</span>mutex mutex_<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> C++ </tag>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>GDB_调试指南</title>
      <link href="/2025/05/24/GDB-%E8%B0%83%E8%AF%95%E6%8C%87%E5%8D%97/"/>
      <url>/2025/05/24/GDB-%E8%B0%83%E8%AF%95%E6%8C%87%E5%8D%97/</url>
      
        <content type="html"><![CDATA[<p>以下是一份详细的 <strong>GDB调试指南</strong>，涵盖基础到高级用法，适用于 Linux C/C++程序调试（包括多线程、核心转储分析等场景）。</p><hr><h2 id="1-gdb-基础使用"><strong>1. GDB 基础使用</strong></h2><h3 id="11-启动-gdb"><strong>1.1 启动 GDB</strong></h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 调试可执行文件</span>gdb ./your_program<span class="token comment"># 调试正在运行的进程</span>gdb <span class="token parameter variable">-p</span> <span class="token operator">&lt;</span>PID<span class="token operator">&gt;</span><span class="token comment"># 调试核心转储文件（coredump）</span>gdb ./your_program core<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="12-常用基础命令"><strong>1.2 常用基础命令</strong></h3><table><thead><tr><th>命令</th><th>缩写</th><th>作用</th></tr></thead><tbody><tr><td><code>run</code></td><td><code>r</code></td><td>启动程序</td></tr><tr><td><code>break &lt;location&gt;</code></td><td><code>b</code></td><td>设置断点（如 <code>b main</code>, <code>b file.cpp:10</code>）</td></tr><tr><td><code>continue</code></td><td><code>c</code></td><td>继续执行到下一个断点</td></tr><tr><td><code>next</code></td><td><code>n</code></td><td>单步执行（不进入函数）</td></tr><tr><td><code>step</code></td><td><code>s</code></td><td>单步执行（进入函数）</td></tr><tr><td><code>print &lt;var&gt;</code></td><td><code>p</code></td><td>打印变量值</td></tr><tr><td><code>backtrace</code></td><td><code>bt</code></td><td>查看调用栈</td></tr><tr><td><code>quit</code></td><td><code>q</code></td><td>退出 GDB</td></tr></tbody></table><hr><h2 id="2-断点管理"><strong>2. 断点管理</strong></h2><h3 id="21-设置断点"><strong>2.1 设置断点</strong></h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">b main          <span class="token comment"># 在 main 函数开头断点</span>b file.cpp:20   <span class="token comment"># 在 file.cpp 的第 20 行断点</span>b *0x4005a6     <span class="token comment"># 在内存地址断点（反汇编调试）</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="22-条件断点"><strong>2.2 条件断点</strong></h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">b foo <span class="token keyword">if</span> x <span class="token operator">&gt;</span> <span class="token number">10</span>   <span class="token comment"># 当 x &gt; 10 时在 foo 函数中断</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="23-查看删除断点"><strong>2.3 查看/删除断点</strong></h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">info breakpoints  <span class="token comment"># 查看所有断点</span>delete <span class="token operator">&lt;</span>num<span class="token operator">&gt;</span>      <span class="token comment"># 删除指定编号的断点</span><span class="token function">clear</span>             <span class="token comment"># 清除当前行的断点</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><hr><h2 id="3-变量与内存操作"><strong>3. 变量与内存操作</strong></h2><h3 id="31-查看变量"><strong>3.1 查看变量</strong></h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">p x              <span class="token comment"># 打印变量 x</span>p/x x            <span class="token comment"># 以十六进制打印</span>p *ptr@10        <span class="token comment"># 打印指针 ptr 指向的 10 个元素</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="32-修改变量"><strong>3.2 修改变量</strong></h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">set</span> var x <span class="token operator">=</span> <span class="token number">5</span>    <span class="token comment"># 修改变量 x 的值</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="33-检查内存"><strong>3.3 检查内存</strong></h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">x/8wx 0x400000   <span class="token comment"># 查看内存（8 个 4 字节字，十六进制）</span>x/s ptr          <span class="token comment"># 打印字符串（直到 '\0'）</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><hr><h2 id="4-多线程调试"><strong>4. 多线程调试</strong></h2><h3 id="41-线程控制"><strong>4.1 线程控制</strong></h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">info threads     <span class="token comment"># 查看所有线程</span>thread <span class="token operator">&lt;</span>ID<span class="token operator">&gt;</span>      <span class="token comment"># 切换到指定线程</span>b foo thread <span class="token number">2</span>   <span class="token comment"># 仅在线程 2 的 foo 函数中断</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="42-锁定线程调度"><strong>4.2 锁定线程调度</strong></h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">set</span> scheduler-locking on  <span class="token comment"># 仅当前线程运行（其他暂停）</span><span class="token builtin class-name">set</span> scheduler-locking off <span class="token comment"># 恢复线程自由切换</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="43-死锁调试"><strong>4.3 死锁调试</strong></h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">catch syscall pthread_mutex_lock  <span class="token comment"># 捕获锁调用</span>thread apply all bt              <span class="token comment"># 查看所有线程堆栈</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><hr><h2 id="5-核心转储core-dump分析"><strong>5. 核心转储（CoreDump）分析</strong></h2><h3 id="51-生成-core-dump"><strong>5.1 生成 Core Dump</strong></h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">ulimit</span> <span class="token parameter variable">-c</span> unlimited  <span class="token comment"># 允许生成 core 文件</span>./your_program       <span class="token comment"># 崩溃后生成 core</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="52-分析-core"><strong>5.2 分析 Core</strong></h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gdb ./your_program corebt                   <span class="token comment"># 查看崩溃时的调用栈</span>p <span class="token operator">&lt;</span>var<span class="token operator">&gt;</span>              <span class="token comment"># 检查变量状态</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><hr><h2 id="6-高级功能"><strong>6. 高级功能</strong></h2><h3 id="61-反汇编调试"><strong>6.1 反汇编调试</strong></h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">disassemble          <span class="token comment"># 查看当前函数的汇编代码</span>si / ni              <span class="token comment"># 汇编级单步执行（step/next instruction）</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="62-自定义命令"><strong>6.2 自定义命令</strong></h3><p>在 <code>~/.gdbinit</code> 中定义快捷命令：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">define print_array  <span class="token builtin class-name">set</span> <span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span>  <span class="token keyword">while</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token variable">$arg0</span>    <span class="token builtin class-name">printf</span> <span class="token string">"arr[%d] = %d<span class="token entity" title="\n">\n</span>"</span>, <span class="token variable">$i</span>, arr<span class="token punctuation">[</span><span class="token variable">$i</span><span class="token punctuation">]</span>    <span class="token builtin class-name">set</span> <span class="token variable">$i</span> <span class="token operator">=</span> <span class="token variable">$i</span> + <span class="token number">1</span>  endend<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>使用时：<code>print_array 10</code>。</p><h3 id="63-反向调试reverse-debugging"><strong>6.3 反向调试（ReverseDebugging）</strong></h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">record full          <span class="token comment"># 开始记录执行流程</span>reverse-step         <span class="token comment"># 反向执行</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><hr><h2 id="7-调试优化后的代码"><strong>7. 调试优化后的代码</strong></h2><p>如果程序编译时用了 <code>-O2</code>，变量可能被优化掉，需：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 禁用优化或添加调试符号</span>gcc <span class="token parameter variable">-O0</span> <span class="token parameter variable">-g</span> program.c<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><hr><h2 id="8-实用技巧"><strong>8. 实用技巧</strong></h2><ul><li><strong>日志输出</strong>：<br><code>printf "x=%d\n", x</code>（在 GDB 中直接打印日志）。</li><li><strong>跳过代码块</strong>：<br><code>until &lt;line&gt;</code>（执行到指定行）。</li><li><strong>调试子进程</strong>：<br><code>set follow-fork-mode child</code>（跟踪子进程）。</li></ul><hr><h2 id="9-推荐学习资源"><strong>9. 推荐学习资源</strong></h2><ul><li><strong>官方手册</strong>：<code>gdb -tui</code>（文本界面模式）或<code>info gdb</code>。</li><li><strong>图形化前端</strong>：<ul><li><code>cgdb</code>（增强型命令行 GDB）</li><li><code>ddd</code>（图形化调试器）。</li></ul></li></ul><hr><p>掌握这些命令后，你可以高效诊断段错误、死锁、数据竞争等问题。对于复杂项目，建议结合<strong>VS Code + GDB 插件</strong> 提升效率。</p>]]></content>
      
      
      <categories>
          
          <category> 笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> GDB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>每日Linux-Cpp-3</title>
      <link href="/2025/05/23/%E6%AF%8F%E6%97%A5Linux-Cpp-3/"/>
      <url>/2025/05/23/%E6%AF%8F%E6%97%A5Linux-Cpp-3/</url>
      
        <content type="html"><![CDATA[<h2 id="每日linux-cpp-3">每日Linux-Cpp-3</h2><hr><h3 id="1-用-define-声明一个常量表示一年秒数忽略闰年并解释ul后缀的作用"><strong>1.用 #define声明一个常量表示一年秒数(忽略闰年)并解释UL后缀的作用。</strong></h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SECONDS_PER_YEAR</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">365</span><span class="token punctuation">)</span>UL</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>作用: UL表示无符号长整型 (Unsinged Long), 防止数值溢出(如某些编译器默认int为16位时，计算结果可能超过范围)。</li><li>项目关联:在嵌入式设备的定时器配置中，需避免直接写“魔法数字“，使用宏定义提升代码可维护性。</li></ul><h3 id="2-手写线程安全的单例模式代码并解释-volatile-关键字在嵌入式场景中的作用"><strong>2.手写线程安全的单例模式代码，并解释 volatile关键字在嵌入式场景中的作用。</strong></h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">Singleton</span> <span class="token punctuation">{</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token keyword">static</span> Singleton<span class="token operator">*</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lock</span><span class="token punctuation">(</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> instance<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">Singleton</span><span class="token punctuation">(</span><span class="token keyword">const</span> Singleton<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>    Singleton<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> Singleton<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span><span class="token keyword">private</span><span class="token operator">:</span>    <span class="token keyword">static</span> Singleton<span class="token operator">*</span> instance<span class="token punctuation">;</span>    <span class="token keyword">static</span> std<span class="token double-colon punctuation">::</span>mutex mutex<span class="token punctuation">;</span>    <span class="token function">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>Singleton<span class="token operator">*</span> Singleton<span class="token double-colon punctuation">::</span>instance <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>std<span class="token double-colon punctuation">::</span>mutex Singleton<span class="token double-colon punctuation">::</span>mutex<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>volatile的作用：防止编译器优化对多线程共享变量的访问。(如中断服务程序修改的硬件寄存器的值)。</li></ul><h3 id="3-黑盒测试与白盒测试的区别你在项目中如何应用"><strong>3.黑盒测试与白盒测试的区别？你在项目中如何应用？</strong></h3><ul><li>区别：<ul><li>黑盒测试：关注输入输出，不关心内部实现(如功能测试)；</li><li>白盒测试：基于代码逻辑设计用例(如路径覆盖、分支覆盖)；</li></ul></li><li>项目关联：在图像处理算法开发中，用黑盒测试验证模型输出精度，白盒测试检查核心函数(如边缘检测)的分支覆盖。</li></ul><h3 id="4-如何用gdb调试多进程程序举例说明"><strong>4.如何用gdb调试多进程程序？举例说明。</strong></h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gdb <span class="token parameter variable">-p</span> <span class="token operator">&lt;</span>parent_pid<span class="token operator">&gt;</span>     <span class="token comment"># 附加到父进程</span><span class="token builtin class-name">set</span> follow-fork-mode child  <span class="token comment"># 跟踪子进程</span>b main.c:20     <span class="token comment"># 在子进程代码行设断点</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>项目关联：在嵌入式多进程通信框架调试中，追踪子进程崩溃问题(如共享内存竞争)。</li></ul><h3 id="5-解释-ls--amore-命令的错误及正确用法"><strong>5. 解释 ls -amore命令的错误及正确用法</strong></h3><ul><li>错误原因：-amore 被解析为 -a -m -o -r -e, 实际应为 ls -a | more(分页显示隐藏文件)</li><li>正确用法：  <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">ls</span> <span class="token parameter variable">-a</span> <span class="token operator">|</span> <span class="token function">more</span>    <span class="token comment"># 分页显示所有文件 (含隐藏文件)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ul><h3 id="6-如何用vi进行块拷贝粘贴和删除操作"><strong>6.如何用vi进行块拷贝、粘贴和删除操作？</strong></h3><ul><li>块操作步骤：<ol type="1"><li>进入可视块模式：Ctrl + V -&gt; 选中区域</li><li>拷贝：y；粘贴：p；删除d。</li></ol></li><li>项目关联：在修改嵌入式设备配置文件(如/etc/fstab)时快速调整多行参数。</li></ul><h3 id="7-合并n个有序链表为一个新有序链表手写代码"><strong>7.合并N个有序链表为一个新有序链表(手写代码)</strong></h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">struct</span> <span class="token class-name">ListNode</span><span class="token operator">*</span> <span class="token function">mergeKLists</span><span class="token punctuation">(</span>vector<span class="token operator">&lt;</span>ListNode<span class="token operator">*</span><span class="token operator">&gt;</span><span class="token operator">&amp;</span> lists<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">auto</span> cmp <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>ListNode<span class="token operator">*</span> a<span class="token punctuation">,</span> ListNode<span class="token operator">*</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> a<span class="token operator">-&gt;</span>val <span class="token operator">&gt;</span> b<span class="token operator">-&gt;</span>val<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>    priority_queue<span class="token operator">&lt;</span>ListNode<span class="token operator">*</span><span class="token punctuation">,</span> vector<span class="token operator">&lt;</span>ListNode<span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token keyword">decltype</span><span class="token punctuation">(</span>cmp<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token function">pq</span><span class="token punctuation">(</span>cmp<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> node <span class="token operator">:</span> lists<span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">)</span> pq<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>    ListNode dummy<span class="token punctuation">,</span> <span class="token operator">*</span>curr <span class="token operator">=</span> <span class="token operator">&amp;</span>dummy<span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>pq<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">auto</span> top <span class="token operator">=</span> pq<span class="token punctuation">.</span><span class="token function">top</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> pq<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        curr<span class="token operator">-&gt;</span>next <span class="token operator">=</span> top<span class="token punctuation">;</span>        curr <span class="token operator">=</span> curr<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>top<span class="token operator">-&gt;</span>next<span class="token punctuation">)</span> pq<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>top<span class="token operator">-&gt;</span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> dummy<span class="token punctuation">.</span>next<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="8-哈希表冲突的链地址法-vs-开放寻址法嵌入式场景中如何选择"><strong>8.哈希表冲突的链地址法 vs 开放寻址法，嵌入式场景中如何选择？</strong></h3><ul><li>链地址法：稳定但需要指针开销(适合PC端)</li><li>开放寻址法：内存利用率高，适合嵌入式小内存场景(如缓存查询表)</li></ul><h3 id="9-快速排序的最优最差时间复杂度如何避免最差情况"><strong>9.快速排序的最优/最差时间复杂度？如何避免最差情况？</strong></h3><ul><li>最优：O(n log n) (均匀分割)；最差：O(n^2) (完全有序数组)</li><li>避免方法：随机选择枢轴 (pivot) 或三数取中法。</li></ul><h3 id="10-编写函数统计文件字符数使用while循环"><strong>10.编写函数统计文件字符数(使用while循环)</strong></h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">charnum</span><span class="token punctuation">(</span><span class="token keyword">char</span> fn<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    FILE<span class="token operator">*</span> fp <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fp<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">fgetc</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">EOF</span><span class="token punctuation">)</span> count<span class="token operator">++</span><span class="token punctuation">;</span>    <span class="token function">fclose</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> count<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> C++ </tag>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>每日Linux-Cpp-2</title>
      <link href="/2025/05/22/%E6%AF%8F%E6%97%A5Linux-Cpp-2/"/>
      <url>/2025/05/22/%E6%AF%8F%E6%97%A5Linux-Cpp-2/</url>
      
        <content type="html"><![CDATA[<h2 id="每日linux-cpp-2">每日Linux-Cpp-2</h2><hr><h3 id="1-指针与引用的核心区别项目中如何应用"><strong>1.指针与引用的核心区别？项目中如何应用？</strong></h3><ul><li>区别：<ul><li>指针是变量存储地址，可重指向其他对象；引用是别名，绑定后不可更改。</li><li>指针可为空(nullptr), 引用必须绑定有效对象。</li></ul></li><li>项目关联：在OpenCV图像处理中，使用指针传递大型图像数据矩阵(如cv::Mat*)避免拷贝；引用用于函数参数传递(如const cv::Mat&amp;)保证安全访问。 例如:<ul><li>使用指针:  <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token function">proccessImage</span><span class="token punctuation">(</span>cv<span class="token double-colon punctuation">::</span>Mat<span class="token operator">*</span> img<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">// 假设对图像进行灰度化处理</span>    cv<span class="token double-colon punctuation">::</span><span class="token function">cvColor</span><span class="token punctuation">(</span><span class="token operator">*</span>img<span class="token punctuation">,</span> <span class="token operator">*</span>img<span class="token punctuation">,</span> cv<span class="token double-colon punctuation">::</span>COLOR_BGR2GRAY<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>不加const修饰时，可改变指针指向，和指向的值。 常量指针(const cv::Mat*img)：不能通过该指针修改指针指向的值。 指针常量(cv::Mat* constimg)：不能修改指针的指向(也就是指针指向的地址不能变)</li><li>使用引用:  <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token function">proccessImage</span><span class="token punctuation">(</span><span class="token keyword">const</span> cv<span class="token double-colon punctuation">::</span>Mat<span class="token operator">&amp;</span> img<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">// 灰度化处理</span>    cv<span class="token double-colon punctuation">::</span>Mat grayImg<span class="token punctuation">;</span>    cv<span class="token double-colon punctuation">::</span><span class="token function">cvtColor</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> grayImg<span class="token punctuation">,</span> cv<span class="token double-colon punctuation">::</span>COLOR_BGR2GRAY<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul>最佳实践:<ul><li>如果只是函数参数传递，优先使用 constcv::Mat&amp;（更安全、更简洁）</li><li>如果需要处理 nullptr (例如void proccessImage(const cv::Mat* img =nullptr) {} ) 或动态切换对象，使用 const cv::Mat*。</li></ul><blockquote><p>常量指针(const cv::Mat* img)是否一定能保证指向的值不会被改变？不一定！const cv::Mat*img（指向常量的指针）只能保证不能通过该指针修改数据，但原始数据仍可能被其他方式修改。</p></blockquote></li></ul><h3 id="2-const-关键字在函数参数和成员函数中的作用"><strong>2. const关键字在函数参数和成员函数中的作用？</strong></h3><ul><li>参数: const T&amp; 防止修改输入数据(如传感器的原始数据)。</li><li>成员函数: void func() const 承诺不修改对象状态(如线程安全的配置类),表示只读。 例如:  <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">Config</span> <span class="token punctuation">{</span><span class="token keyword">private</span><span class="token operator">:</span>    <span class="token keyword">int</span> width_<span class="token punctuation">;</span>    <span class="token keyword">int</span> height_<span class="token punctuation">;</span>    <span class="token keyword">mutable</span> <span class="token keyword">int</span> accessCount_<span class="token punctuation">;</span>   <span class="token comment">// 可被 const 函数修改</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token comment">// const 成员函数，承诺不修改对象状态</span>    <span class="token keyword">void</span> <span class="token function">printConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>        <span class="token comment">// width_ = 100;    // 错误，不能修改非 mutable 成员</span>        accessCount_<span class="token operator">++</span><span class="token punctuation">;</span>     <span class="token comment">// 正确，mutable成员可修改</span>        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Width: "</span> <span class="token operator">&lt;&lt;</span> width_ <span class="token operator">&lt;&lt;</span> <span class="token string">", Height: "</span> <span class="token operator">&lt;&lt;</span> height_ <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>返回非 const 指针/引用是危险的  <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">BadExample</span> <span class="token punctuation">{</span><span class="token keyword">private</span><span class="token operator">:</span>    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> data_<span class="token punctuation">;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token comment">// 危险：const 函数暴露了可修改的内部数据</span>    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token operator">&amp;</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> data_<span class="token punctuation">;</span> <span class="token punctuation">}</span>  <span class="token comment">// 不要这样做！</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>const 成员函数和非 const 成员函数可以重载</li><li>项目关联:在模型推理的类中，const修饰推理函数确保权重不被意外修改。</li></ul><h3 id="3-手写单例模式线程安全版"><strong>3.手写单例模式(线程安全版)</strong></h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">Singleton</span> <span class="token punctuation">{</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token keyword">static</span> Singleton<span class="token operator">&amp;</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">static</span> Singleton instance<span class="token punctuation">;</span>  <span class="token comment">// 即使多次访问这个函数，instance也只会初始化一次。</span>        <span class="token keyword">return</span> instance<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">Singleton</span><span class="token punctuation">(</span><span class="token keyword">const</span> Singleton<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>   <span class="token comment">// 禁止拷贝构造</span>    Singleton<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> Singleton<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>    <span class="token comment">// 禁用赋值构造</span><span class="token keyword">private</span><span class="token operator">:</span>    <span class="token function">Singleron</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>  <span class="token comment">// 私有构造函数</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>项目关联:用于全局配置管理(如摄像头参数加载)，避免多线程重复初始化。</li></ul><h3 id="4-ps--aux-和-top-命令的区别项目中如何用"><strong>4. ps -aux 和top 命令的区别？项目中如何用？</strong></h3><ul><li>ps -aux: 静态快照显示所有进程信息(如PID，CPU占用)</li><li>top: 动态实时监控进程资源(按CPU排序，支持交互命令)</li><li>项目关联:部署YOLO模型时用top监控推理进程的CPU/内存峰值，优化线程数。</li></ul><h3 id="5-如何用grep-搜索日志中的segmentation-fault"><strong>5.如何用grep 搜索日志中的“segmentation fault“?</strong></h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">grep</span> <span class="token string">"segmentation fault"</span> /var/log/syslog <span class="token operator">|</span> <span class="token function">tail</span> <span class="token parameter variable">-n</span> <span class="token number">20</span>  <span class="token comment"># 显示最后20行</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>项目关联: 在嵌入式设备调试中，快速定位模型推理崩溃的堆栈信息。</li></ul><h3 id="6-解释-strace-命令的作用并举例"><strong>6. 解释 strace命令的作用并举例</strong></h3><ul><li>作用: 追踪进程的系统调用(如文件读写、信号处理)</li><li>示例:  <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">strace</span> <span class="token parameter variable">-o</span> debug.log ./inference_app  <span class="token comment"># 记录系统调用到文件</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li>项目关联: 分析 OpenCV 视频采集卡顿问题，发现 read()调用阻塞事件过长。</li></ul><h3 id="7-链表反转手写代码--优化思路"><strong>7. 链表反转(手写代码 +优化思路)</strong></h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">ListNode<span class="token operator">*</span> <span class="token function">reverseList</span><span class="token punctuation">(</span>ListNode<span class="token operator">*</span> head<span class="token punctuation">)</span> <span class="token punctuation">{</span>    ListNode<span class="token operator">*</span> prev <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token operator">*</span>curr <span class="token operator">=</span> head<span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>curr<span class="token punctuation">)</span> <span class="token punctuation">{</span>        ListNode<span class="token operator">*</span> next <span class="token operator">=</span> curr <span class="token operator">-&gt;</span> next<span class="token punctuation">;</span>        curr <span class="token operator">-&gt;</span> next <span class="token operator">=</span> prev<span class="token punctuation">;</span>        prev <span class="token operator">=</span> curr<span class="token punctuation">;</span>        curr <span class="token operator">=</span> next<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> prev<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>优化思路:嵌入式设备中避免递归防止栈溢出，用迭代法减少内存消耗。</li></ul><h3 id="8-哈希表冲突解决方法的优缺点"><strong>8.哈希表冲突解决方法的优缺点?</strong></h3><ul><li>开放寻址: 内存紧凑但易聚集(适合嵌入式小内存场景)</li><li>链地址法: 稳定但须额外指针(PC端常用)</li><li>项目关联: 在特征点匹配算法中，用链地址法哈希表加速特征查询。</li></ul><h3 id="9-快速排序实现及时间复杂度分析"><strong>9.快速排序实现及时间复杂度分析</strong></h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// 分区函数：选择 pivot，将小于 pivot 的元素放在左边，大于 pivot 的放在右边</span><span class="token keyword">int</span> <span class="token function">partition</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token operator">&amp;</span> arr<span class="token punctuation">,</span> <span class="token keyword">int</span> low<span class="token punctuation">,</span> <span class="token keyword">int</span> high<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">int</span> pivot <span class="token operator">=</span> arr<span class="token punctuation">[</span>high<span class="token punctuation">]</span><span class="token punctuation">;</span>   <span class="token comment">// 选择最后一个元素作为 pivot</span>    <span class="token keyword">int</span> i <span class="token operator">=</span> low <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>     <span class="token comment">// i 是小于 pivot 的区域的边界</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span>  low<span class="token punctuation">;</span> j <span class="token operator">&lt;</span> high<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">&lt;</span> pivot<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token operator">++</span>i<span class="token punctuation">;</span>            std<span class="token double-colon punctuation">::</span><span class="token function">swap</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    std<span class="token double-colon punctuation">::</span><span class="token function">swap</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> privat<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 将 pivot 放到正确的位置</span>    <span class="token keyword">return</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>     <span class="token comment">// 返回 pivot 的索引</span><span class="token punctuation">}</span><span class="token keyword">void</span> <span class="token function">quickSort</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token operator">&amp;</span> arr<span class="token punctuation">,</span> <span class="token keyword">int</span> low<span class="token punctuation">,</span> <span class="token keyword">int</span> high<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>low <span class="token operator">&lt;</span> high<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span> pivotIndex <span class="token operator">=</span> <span class="token function">partition</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> low<span class="token punctuation">,</span> high<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">quickSort</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> low<span class="token punctuation">,</span> pivotIndex <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">quickSort</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> pivotIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> high<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment">// 递归版本可能在大数据量时导致 栈溢出, 可以用栈模拟递归：</span><span class="token keyword">void</span> <span class="token function">quickSortIterative</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token operator">&amp;</span> arr<span class="token punctuation">,</span> <span class="token keyword">int</span> low<span class="token punctuation">,</span> <span class="token keyword">int</span> high<span class="token punctuation">)</span> <span class="token punctuation">{</span>    std<span class="token double-colon punctuation">::</span>stack<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>pair<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">&gt;&gt;</span> st<span class="token punctuation">;</span>    st<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>low<span class="token punctuation">,</span> high<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>st<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">auto</span> <span class="token punctuation">{</span>l<span class="token punctuation">,</span> h<span class="token punctuation">}</span> <span class="token operator">=</span> st<span class="token punctuation">.</span><span class="token function">top</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        st<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>l <span class="token operator">&gt;=</span> h<span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> pivotIndex <span class="token operator">=</span> <span class="token function">partition</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> l<span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">;</span>        st<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>l<span class="token punctuation">,</span> pivotIndex <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        st<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>pivotIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> h<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="10-用栈实现队列的功能"><strong>10.用栈实现队列的功能</strong></h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">MyQueue</span> <span class="token punctuation">{</span>    stack<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> in<span class="token punctuation">,</span> out<span class="token punctuation">;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token keyword">void</span> <span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>        in<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">int</span> <span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>out<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment">// 如果 out 为空，那就把 in 的所有元素倒过来, 也就是压入 out中</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>in<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                out<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>in<span class="token punctuation">.</span><span class="token function">top</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                in<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">int</span> val <span class="token operator">=</span> out<span class="token punctuation">.</span><span class="token function">top</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        out<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> val<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">int</span> <span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>outStack<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment">// 如果 outStack 为空，把 inStack 的所有元素倒过来</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>inStack<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                outStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>inStack<span class="token punctuation">.</span><span class="token function">top</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                inStack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> outStack<span class="token punctuation">.</span><span class="token function">top</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 只是观察，不删除元素</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="每日知识加油站"><strong>每日知识加油站:</strong></h3><p><strong>内存分区</strong></p><table><thead><tr><th style="text-align: left;"><strong>分区</strong></th><th style="text-align: left;"><strong>存储内容</strong></th><th style="text-align: left;"><strong>管理方式</strong></th><th style="text-align: left;"><strong>生命周期</strong></th><th style="text-align: left;"><strong>示例</strong></th></tr></thead><tbody><tr><td style="text-align: left;"><strong>栈 (Stack)</strong></td><td style="text-align: left;">局部变量、函数参数、返回地址</td><td style="text-align: left;">编译器自动管理</td><td style="text-align: left;">函数执行结束自动释放</td><td style="text-align: left;"><code>int x = 10;</code></td></tr><tr><td style="text-align: left;"><strong>堆 (Heap)</strong></td><td style="text-align: left;">动态分配的内存（<code>new</code>/<code>malloc</code>）</td><td style="text-align: left;">手动管理（需<code>delete</code>/<code>free</code>）</td><td style="text-align: left;">显式释放前一直存在</td><td style="text-align: left;"><code>int* p = new int(42);</code></td></tr><tr><td style="text-align: left;"><strong>全局/静态区</strong></td><td style="text-align: left;">全局变量、静态变量（<code>static</code>）</td><td style="text-align: left;">编译器分配</td><td style="text-align: left;">程序启动到结束</td><td style="text-align: left;"><code>int globalVar; static int s_var;</code></td></tr><tr><td style="text-align: left;"><strong>常量区</strong></td><td style="text-align: left;">字符串常量、<code>const</code>全局变量</td><td style="text-align: left;">只读，编译器分配</td><td style="text-align: left;">程序运行期间</td><td style="text-align: left;"><code>const char* str = "Hello";</code></td></tr><tr><td style="text-align: left;"><strong>代码区</strong></td><td style="text-align: left;">程序指令（二进制代码）</td><td style="text-align: left;">编译器生成</td><td style="text-align: left;">程序运行期间</td><td style="text-align: left;">函数定义（如<code>main()</code>）</td></tr></tbody></table><table><thead><tr><th style="text-align: left;"><strong>特性</strong></th><th style="text-align: left;">栈</th><th style="text-align: left;">堆</th><th style="text-align: left;">全局/静态区</th></tr></thead><tbody><tr><td style="text-align: left;"><strong>分配速度</strong></td><td style="text-align: left;">快（指针移动）</td><td style="text-align: left;">慢（查找空闲块）</td><td style="text-align: left;">程序启动时分配</td></tr><tr><td style="text-align: left;"><strong>生命周期</strong></td><td style="text-align: left;">自动</td><td style="text-align: left;">手动</td><td style="text-align: left;">程序全程</td></tr><tr><td style="text-align: left;"><strong>线程安全</strong></td><td style="text-align: left;">线程独立</td><td style="text-align: left;">需同步</td><td style="text-align: left;">需同步</td></tr><tr><td style="text-align: left;"><strong>适用场景</strong></td><td style="text-align: left;">临时变量、小对象</td><td style="text-align: left;">大对象、共享数据</td><td style="text-align: left;">配置参数、单例</td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> C++ </tag>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>每日Linux-Cpp-1</title>
      <link href="/2025/05/21/%E6%AF%8F%E6%97%A5Linux-Cpp-1/"/>
      <url>/2025/05/21/%E6%AF%8F%E6%97%A5Linux-Cpp-1/</url>
      
        <content type="html"><![CDATA[<h2 id="每日linux-cpp-1">每日Linux-Cpp-1</h2><hr><h3 id="1-c语言中-volatile-关键字的作用是什么-举一个必须使用-volatile-的实际场景"><strong>1.C语言中 volatile 关键字的作用是什么? 举一个必须使用 volatile的实际场景。</strong></h3><ul><li>作用:告诉编译器不要优化对该变量的访问，每次必须从内存读取最新的值。</li><li>场景:多线程共享变量、硬件寄存器访问(状态寄存器)、中断服务程序(ISR)中修改的全局变量。</li></ul><h3 id="2-解释结构体内存对齐的规则并给出优化结构体大小的两种方法"><strong>2.解释结构体内存对齐的规则，并给出优化结构体大小的两种方法。</strong></h3><ul><li>对齐原则:成员偏移量是自身大小或编译器对齐值的整数倍，结构体总大小为最大对齐值的整数倍。</li><li>优化方法:<ol type="1"><li>按成员大小降序排列 (double -&gt; int -&gt; char)</li><li>使用 #pragma pack(1) 强制1字节对齐(牺牲性能换空间)</li></ol></li></ul><h3 id="3-freertos中任务有哪几种状态-如何让一个任务从阻塞态切换到就绪态"><strong>3.FreeRTOS中任务有哪几种状态?如何让一个任务从阻塞态切换到就绪态?</strong></h3><ul><li>状态:运行态(Runing)、就绪态(Ready)、阻塞态(Blocked)、挂起态(Suspended)。</li><li>切换方法:通过信号量释放(xSemaphoreGive)、任务通知(xTaskNotify)、延迟到期(vTaskDelay)。</li></ul><h3 id="4-iic总线的上拉电阻阻值选择不当会导致什么问题-如何计算合理的阻值"><strong>4.IIC总线的上拉电阻阻值选择不当会导致什么问题?如何计算合理的阻值</strong></h3><ul><li>问题: 阻值过小 -&gt; 电流过大损坏器件；阻值过大 -&gt;上升沿过慢导致通信失败。</li><li>计算: 根据总线电容(<span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.05ex;" xmlns="http://www.w3.org/2000/svg" width="1.719ex" height="1.645ex" role="img" focusable="false" viewBox="0 -705 760 727"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D436" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q484 659 454 652T382 628T299 572T226 479Q194 422 175 346T156 222Q156 108 232 58Q280 24 350 24Q441 24 512 92T606 240Q610 253 612 255T628 257Q648 257 648 248Q648 243 647 239Q618 132 523 55T319 -22Q206 -22 128 53T50 252Z"></path></g></g></g></svg></mjx-container></span>)和上升时间(<span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.357ex;" xmlns="http://www.w3.org/2000/svg" width="1.726ex" height="1.773ex" role="img" focusable="false" viewBox="0 -626 762.9 783.8"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path></g><g data-mml-node="mi" transform="translate(394,-150) scale(0.707)"><path data-c="1D45F" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q161 442 183 430T214 408T225 388Q227 382 228 382T236 389Q284 441 347 441H350Q398 441 422 400Q430 381 430 363Q430 333 417 315T391 292T366 288Q346 288 334 299T322 328Q322 376 378 392Q356 405 342 405Q286 405 239 331Q229 315 224 298T190 165Q156 25 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g></g></g></g></svg></mjx-container></span>) 计算，公式: <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="23.576ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 10420.7 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D445" d="M230 637Q203 637 198 638T193 649Q193 676 204 682Q206 683 378 683Q550 682 564 680Q620 672 658 652T712 606T733 563T739 529Q739 484 710 445T643 385T576 351T538 338L545 333Q612 295 612 223Q612 212 607 162T602 80V71Q602 53 603 43T614 25T640 16Q668 16 686 38T712 85Q717 99 720 102T735 105Q755 105 755 93Q755 75 731 36Q693 -21 641 -21H632Q571 -21 531 4T487 82Q487 109 502 166T517 239Q517 290 474 313Q459 320 449 321T378 323H309L277 193Q244 61 244 59Q244 55 245 54T252 50T269 48T302 46H333Q339 38 339 37T336 19Q332 6 326 0H311Q275 2 180 2Q146 2 117 2T71 2T50 1Q33 1 33 10Q33 12 36 24Q41 43 46 45Q50 46 61 46H67Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628Q287 635 230 637ZM630 554Q630 586 609 608T523 636Q521 636 500 636T462 637H440Q393 637 386 627Q385 624 352 494T319 361Q319 360 388 360Q466 361 492 367Q556 377 592 426Q608 449 619 486T630 554Z"></path></g><g data-mml-node="mi" transform="translate(792,-150) scale(0.707)"><path data-c="1D45A" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g></g><g data-mml-node="mi" transform="translate(1462.8,0)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path></g><g data-mml-node="mi" transform="translate(1991.8,0)"><path data-c="1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path></g><g data-mml-node="mo" transform="translate(2841.6,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="msub" transform="translate(3897.4,0)"><g data-mml-node="mi"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path></g><g data-mml-node="mi" transform="translate(394,-150) scale(0.707)"><path data-c="1D45F" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q161 442 183 430T214 408T225 388Q227 382 228 382T236 389Q284 441 347 441H350Q398 441 422 400Q430 381 430 363Q430 333 417 315T391 292T366 288Q346 288 334 299T322 328Q322 376 378 392Q356 405 342 405Q286 405 239 331Q229 315 224 298T190 165Q156 25 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(4660.3,0)"><g data-mml-node="mo"><path data-c="2F" d="M423 750Q432 750 438 744T444 730Q444 725 271 248T92 -240Q85 -250 75 -250Q68 -250 62 -245T56 -231Q56 -221 230 257T407 740Q411 750 423 750Z"></path></g></g><g data-mml-node="mo" transform="translate(5160.3,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mn" transform="translate(5549.3,0)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path><path data-c="2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z" transform="translate(500,0)"></path><path data-c="38" d="M70 417T70 494T124 618T248 666Q319 666 374 624T429 515Q429 485 418 459T392 417T361 389T335 371T324 363L338 354Q352 344 366 334T382 323Q457 264 457 174Q457 95 399 37T249 -22Q159 -22 101 29T43 155Q43 263 172 335L154 348Q133 361 127 368Q70 417 70 494ZM286 386L292 390Q298 394 301 396T311 403T323 413T334 425T345 438T355 454T364 471T369 491T371 513Q371 556 342 586T275 624Q268 625 242 625Q201 625 165 599T128 534Q128 511 141 492T167 463T217 431Q224 426 228 424L286 386ZM250 21Q308 21 350 55T392 137Q392 154 387 169T375 194T353 216T330 234T301 253T274 270Q260 279 244 289T218 306L210 311Q204 311 181 294T133 239T107 157Q107 98 150 60T250 21Z" transform="translate(778,0)"></path><path data-c="34" d="M462 0Q444 3 333 3Q217 3 199 0H190V46H221Q241 46 248 46T265 48T279 53T286 61Q287 63 287 115V165H28V211L179 442Q332 674 334 675Q336 677 355 677H373L379 671V211H471V165H379V114Q379 73 379 66T385 54Q393 47 442 46H471V0H462ZM293 211V545L74 212L183 211H293Z" transform="translate(1278,0)"></path><path data-c="37" d="M55 458Q56 460 72 567L88 674Q88 676 108 676H128V672Q128 662 143 655T195 646T364 644H485V605L417 512Q408 500 387 472T360 435T339 403T319 367T305 330T292 284T284 230T278 162T275 80Q275 66 275 52T274 28V19Q270 2 255 -10T221 -22Q210 -22 200 -19T179 0T168 40Q168 198 265 368Q285 400 349 489L395 552H302Q128 552 119 546Q113 543 108 522T98 479L95 458V455H55V458Z" transform="translate(1778,0)"></path><path data-c="33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z" transform="translate(2278,0)"></path></g><g data-mml-node="mo" transform="translate(8549.5,0)"><path data-c="2217" d="M229 286Q216 420 216 436Q216 454 240 464Q241 464 245 464T251 465Q263 464 273 456T283 436Q283 419 277 356T270 286L328 328Q384 369 389 372T399 375Q412 375 423 365T435 338Q435 325 425 315Q420 312 357 282T289 250L355 219L425 184Q434 175 434 161Q434 146 425 136T401 125Q393 125 383 131T328 171L270 213Q283 79 283 63Q283 53 276 44T250 35Q231 35 224 44T216 63Q216 80 222 143T229 213L171 171Q115 130 110 127Q106 124 100 124Q87 124 76 134T64 161Q64 166 64 169T67 175T72 181T81 188T94 195T113 204T138 215T170 230T210 250L74 315Q65 324 65 338Q65 353 74 363T98 374Q106 374 116 368T171 328L229 286Z"></path></g><g data-mml-node="mi" transform="translate(9271.7,0)"><path data-c="1D436" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q484 659 454 652T382 628T299 572T226 479Q194 422 175 346T156 222Q156 108 232 58Q280 24 350 24Q441 24 512 92T606 240Q610 253 612 255T628 257Q648 257 648 248Q648 243 647 239Q618 132 523 55T319 -22Q206 -22 128 53T50 252Z"></path></g><g data-mml-node="mo" transform="translate(10031.7,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g></svg></mjx-container></span> (例: 100pF电容+ 1us 上升时间 -&gt; <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.357ex;" xmlns="http://www.w3.org/2000/svg" width="15.652ex" height="1.95ex" role="img" focusable="false" viewBox="0 -704 6918.4 861.8"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D445" d="M230 637Q203 637 198 638T193 649Q193 676 204 682Q206 683 378 683Q550 682 564 680Q620 672 658 652T712 606T733 563T739 529Q739 484 710 445T643 385T576 351T538 338L545 333Q612 295 612 223Q612 212 607 162T602 80V71Q602 53 603 43T614 25T640 16Q668 16 686 38T712 85Q717 99 720 102T735 105Q755 105 755 93Q755 75 731 36Q693 -21 641 -21H632Q571 -21 531 4T487 82Q487 109 502 166T517 239Q517 290 474 313Q459 320 449 321T378 323H309L277 193Q244 61 244 59Q244 55 245 54T252 50T269 48T302 46H333Q339 38 339 37T336 19Q332 6 326 0H311Q275 2 180 2Q146 2 117 2T71 2T50 1Q33 1 33 10Q33 12 36 24Q41 43 46 45Q50 46 61 46H67Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628Q287 635 230 637ZM630 554Q630 586 609 608T523 636Q521 636 500 636T462 637H440Q393 637 386 627Q385 624 352 494T319 361Q319 360 388 360Q466 361 492 367Q556 377 592 426Q608 449 619 486T630 554Z"></path></g><g data-mml-node="mi" transform="translate(792,-150) scale(0.707)"><path data-c="1D45A" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g></g><g data-mml-node="mi" transform="translate(1462.8,0)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path></g><g data-mml-node="mi" transform="translate(1991.8,0)"><path data-c="1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path></g><g data-mml-node="mo" transform="translate(2841.6,0)"><path data-c="2248" d="M55 319Q55 360 72 393T114 444T163 472T205 482Q207 482 213 482T223 483Q262 483 296 468T393 413L443 381Q502 346 553 346Q609 346 649 375T694 454Q694 465 698 474T708 483Q722 483 722 452Q722 386 675 338T555 289Q514 289 468 310T388 357T308 404T224 426Q164 426 125 393T83 318Q81 289 69 289Q55 289 55 319ZM55 85Q55 126 72 159T114 210T163 238T205 248Q207 248 213 248T223 249Q262 249 296 234T393 179L443 147Q502 112 553 112Q609 112 649 141T694 220Q694 249 708 249T722 217Q722 153 675 104T555 55Q514 55 468 76T388 123T308 170T224 192Q164 192 125 159T83 84Q80 55 69 55Q55 55 55 85Z"></path></g><g data-mml-node="mn" transform="translate(3897.4,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path data-c="2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z" transform="translate(500,0)"></path><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z" transform="translate(778,0)"></path><path data-c="38" d="M70 417T70 494T124 618T248 666Q319 666 374 624T429 515Q429 485 418 459T392 417T361 389T335 371T324 363L338 354Q352 344 366 334T382 323Q457 264 457 174Q457 95 399 37T249 -22Q159 -22 101 29T43 155Q43 263 172 335L154 348Q133 361 127 368Q70 417 70 494ZM286 386L292 390Q298 394 301 396T311 403T323 413T334 425T345 438T355 454T364 471T369 491T371 513Q371 556 342 586T275 624Q268 625 242 625Q201 625 165 599T128 534Q128 511 141 492T167 463T217 431Q224 426 228 424L286 386ZM250 21Q308 21 350 55T392 137Q392 154 387 169T375 194T353 216T330 234T301 253T274 270Q260 279 244 289T218 306L210 311Q204 311 181 294T133 239T107 157Q107 98 150 60T250 21Z" transform="translate(1278,0)"></path></g><g data-mml-node="mi" transform="translate(5675.4,0)"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path></g><g data-mml-node="mi" transform="translate(6196.4,0)"><path data-c="3A9" d="M55 454Q55 503 75 546T127 617T197 665T272 695T337 704H352Q396 704 404 703Q527 687 596 615T666 454Q666 392 635 330T559 200T499 83V80H543Q589 81 600 83T617 93Q622 102 629 135T636 172L637 177H677V175L660 89Q645 3 644 2V0H552H488Q461 0 456 3T451 20Q451 89 499 235T548 455Q548 512 530 555T483 622T424 656T361 668Q332 668 303 658T243 626T193 560T174 456Q174 380 222 233T270 20Q270 7 263 0H77V2Q76 3 61 89L44 175V177H84L85 172Q85 171 88 155T96 119T104 93Q109 86 120 84T178 80H222V83Q206 132 162 199T87 329T55 454Z"></path></g></g></g></svg></mjx-container></span>)</li></ul><h3 id="5-嵌入式linux系统与标准linux系统的核心区别是什么"><strong>5.嵌入式Linux系统与标准Linux系统的核心区别是什么?</strong></h3><p>嵌入式Linux系统针对特定的硬件裁剪内核，强调实时性、低功耗和小型化，通常搭配BusyBox等精简工具链。标准的Linux面向通用计算，功能更全面但资源占用高。</p><h3 id="6-linux内核架构分为哪几层-简述各层的功能"><strong>6.Linux内核架构分为哪几层? 简述各层的功能。</strong></h3><ul><li>分为四级架构：<ul><li>硬件子系统: 管理中断、存储设备驱动(UART/SD)</li><li>核心中介层: 虚拟内存管理、内核态调度器。</li><li>应用支持层: 提供系统调用接口和程序库。</li><li>任务管理层: 处理进程调度和资源分配。</li></ul></li></ul><h3 id="7-设备树在嵌入式linux中的作用是什么"><strong>7.设备树在嵌入式Linux中的作用是什么？</strong></h3><p>设备树以结构化的数据描述硬件的配置(如外设地址、中断号)，实现硬件和驱动解耦，避免内核重新编译即可适配不同硬件。</p><h3 id="8-解释交叉编译的概念及其必要性"><strong>8.解释交叉编译的概念及其必要性。</strong></h3><p>交叉编译器指在开发主机(x86)上生成目标平台(如ARM)的可执行文件。</p><ul><li>必要性:<ol type="1"><li>嵌入式设备资源有限，无法本地编译。</li><li>开发机性能强，提升编译效率。</li></ol></li></ul><h3 id="9-嵌入式linux驱动开发的基本步骤有哪些"><strong>9.嵌入式Linux驱动开发的基本步骤有哪些？</strong></h3><ol type="1"><li>定义设备与驱动的接口(如字符设备)</li><li>编写驱动代码并编译成内核模块</li><li>修改设备树添加节点绑定驱动</li><li>加载模块并测试硬件功能</li></ol><h3 id="10-设备树-device-tree-中如何定义一个-gpio-按键中断写出对应的dts代码片段"><strong>10.设备树 (Device Tree) 中如何定义一个 GPIO按键中断？写出对应的DTS代码片段。</strong></h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token operator">&amp;</span>gpio0 <span class="token punctuation">{</span>    <span class="token comment">// 引用GPIO控制器节点 (例如某个芯片的GPIO0模块) (不可更改，厂商定义)</span>    button <span class="token punctuation">{</span>    <span class="token comment">// 定义一个字节点，表示按键设备 (节点名称，可自定义命名)</span>        compatible <span class="token operator">=</span> <span class="token string">"gpio-keys"</span><span class="token punctuation">;</span>   <span class="token comment">// 告诉内核，此设备使用 gpio-keys 驱动 (不可更改)</span>        button1 <span class="token punctuation">{</span>   <span class="token comment">// 定义第一个按键的具体参数 (字节点名称，可更改)</span>            label <span class="token operator">=</span> <span class="token string">"USER_BUTTON"</span><span class="token punctuation">;</span>  <span class="token comment">// 按键的标签，方便调试 (value 可更改，自定义)</span>            gpios <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio0 <span class="token number">14</span> GPIO_ACTIVE_LOW<span class="token operator">&gt;</span><span class="token punctuation">;</span>    <span class="token comment">// 使用GPIO0的14号引脚，低电平有效 (不能改)</span>            linux<span class="token punctuation">,</span> code <span class="token operator">=</span> <span class="token operator">&lt;</span>KEY_ENTER<span class="token operator">&gt;</span><span class="token punctuation">;</span>  <span class="token comment">// 按下时生成"回车键事件" (key不能改，value可在内核的事件定义中查找更改)</span>            interrupts<span class="token operator">-</span>extended <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio0 <span class="token number">14</span> IRQ_TYPE_EDGE_FALLING<span class="token operator">&gt;</span><span class="token punctuation">;</span>    <span class="token comment">// 中断触发方式，下降沿触发 (key 不能改，value须适配)</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> C++ </tag>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>搭建Nginx-FLV流媒体服务器</title>
      <link href="/2025/05/21/%E6%90%AD%E5%BB%BANginx-FLV%E6%B5%81%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1%E5%99%A8/"/>
      <url>/2025/05/21/%E6%90%AD%E5%BB%BANginx-FLV%E6%B5%81%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1%E5%99%A8/</url>
      
        <content type="html"><![CDATA[<h2 id="搭建nginx-flv">搭建nginx-FLV</h2><blockquote><p>查看更多信息请前往 <a href="https://github.com/zikcc/nginx-streaming-demos">github:nginx-streaming-demos</a></p></blockquote><h3 id="准备工作">准备工作</h3><p>请查看 <a href="/2025/05/21/%E6%90%AD%E5%BB%BANginx-RTMP%E6%B5%81%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1%E5%99%A8/#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C" title="搭建Nginx-RTMP流媒体服务器">搭建Nginx-RTMP流媒体服务器的准备工作</a></p><h3 id="构建镜像">构建镜像</h3><p>由于之前是拉取的 nginx-rtmp的镜像，不支持flv。所以需要重新构建一个支持flv的nginx镜像。</p><p>nginx-http-flv-module 支持flv且具备 nginx-rtmp-module的功能。</p><p>依然采用挂载的方式，在虚拟机本地创建目录</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token punctuation">\</span>  ~/Desktop/docker/projects/nginx-flv/<span class="token punctuation">{</span>config,data/hls,data/recordings,dist,logs,certs<span class="token punctuation">}</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>开启HTTPS 服务生成，自签名证书</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">openssl req <span class="token parameter variable">-x509</span> <span class="token parameter variable">-nodes</span> <span class="token parameter variable">-days</span> <span class="token number">365</span> <span class="token parameter variable">-newkey</span> rsa:2048 <span class="token punctuation">\</span>  <span class="token parameter variable">-keyout</span> certs/key.pem <span class="token punctuation">\</span>  <span class="token parameter variable">-out</span> certs/cert.pem <span class="token punctuation">\</span>  <span class="token parameter variable">-subj</span> <span class="token string">"/CN=localhost"</span> <span class="token punctuation">\</span>  <span class="token parameter variable">-addext</span> <span class="token string">"subjectAltName=DNS:localhost,IP:192.168.217.130"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>编写Dockerfile</p><pre class="line-numbers language-docker" data-language="docker"><code class="language-docker"><span class="token comment"># 使用多阶段构建减小镜像体积</span><span class="token instruction"><span class="token keyword">FROM</span> alpine:3.18 <span class="token keyword">AS</span> builder</span><span class="token comment"># 安装编译依赖</span><span class="token instruction"><span class="token keyword">RUN</span> apk add --no-cache <span class="token operator">\</span>    build-base <span class="token operator">\</span>    pcre-dev <span class="token operator">\</span>    openssl-dev <span class="token operator">\</span>    zlib-dev <span class="token operator">\</span>    git</span><span class="token comment"># 下载 Nginx 和模块源码</span><span class="token instruction"><span class="token keyword">RUN</span> git clone https://github.com/winshining/nginx-http-flv-module.git &amp;&amp; <span class="token operator">\</span>    wget http://nginx.org/download/nginx-1.25.3.tar.gz &amp;&amp; <span class="token operator">\</span>    tar -zxvf nginx-1.25.3.tar.gz</span><span class="token comment"># 编译 Nginx (包含 RTMP 和 FLV 模块)</span><span class="token instruction"><span class="token keyword">WORKDIR</span> /nginx-1.25.3</span><span class="token instruction"><span class="token keyword">RUN</span> ./configure <span class="token operator">\</span>    --prefix=/usr/local/nginx <span class="token operator">\</span>    --with-http_ssl_module <span class="token operator">\</span>    --with-http_stub_status_module <span class="token operator">\</span>    --with-http_realip_module <span class="token operator">\</span>    --with-http_auth_request_module <span class="token operator">\</span>    --with-http_v2_module <span class="token operator">\</span>    --with-http_dav_module <span class="token operator">\</span>    --with-http_slice_module <span class="token operator">\</span>    --with-threads <span class="token operator">\</span>    --with-http_addition_module <span class="token operator">\</span>    --with-http_gunzip_module <span class="token operator">\</span>    --with-http_gzip_static_module<span class="token operator">\</span>    --add-module=../nginx-http-flv-module &amp;&amp; <span class="token operator">\</span>    make -j$(nproc) &amp;&amp; <span class="token operator">\</span>    make install</span><span class="token comment"># 构建最终镜像</span><span class="token instruction"><span class="token keyword">FROM</span> alpine:3.18</span><span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">builder</span></span> /usr/local/nginx /usr/local/nginx</span><span class="token comment"># 安装运行时依赖</span><span class="token instruction"><span class="token keyword">RUN</span> apk add --no-cache pcre openssl zlib &amp;&amp; <span class="token operator">\</span>    mkdir -p /tmp/hls /var/log/nginx &amp;&amp; <span class="token operator">\</span>    chmod 755 /tmp/hls &amp;&amp; <span class="token operator">\</span>    rm -rf /var/cache/apk/*</span>    <span class="token comment"># 设置环境变量</span><span class="token instruction"><span class="token keyword">ENV</span> PATH=<span class="token string">"/usr/local/nginx/sbin:${PATH}"</span> <span class="token operator">\</span>    NGINX_LOG_DIR=<span class="token string">"/var/log/nginx"</span></span>    <span class="token comment"># 暴露端口</span><span class="token instruction"><span class="token keyword">EXPOSE</span> 1935 80 443</span><span class="token comment"># 启动命令</span><span class="token instruction"><span class="token keyword">CMD</span> [<span class="token string">"/usr/local/nginx/sbin/nginx"</span>, <span class="token string">"-g"</span>, <span class="token string">"daemon off;"</span>]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>构建镜像</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> build <span class="token parameter variable">-t</span> nginx-flv <span class="token builtin class-name">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="配置">配置</h3><p>编写nginx.conf</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">worker_processes auto<span class="token punctuation">;</span>events <span class="token punctuation">{</span>    worker_connections <span class="token number">1024</span><span class="token punctuation">;</span>    use epoll<span class="token punctuation">;</span><span class="token punctuation">}</span>http <span class="token punctuation">{</span>    include mime.types<span class="token punctuation">;</span>    default_type application/octet-stream<span class="token punctuation">;</span>        sendfile on<span class="token punctuation">;</span>    tcp_nopush on<span class="token punctuation">;</span>    tcp_nodelay on<span class="token punctuation">;</span>    keepalive_timeout <span class="token number">65</span><span class="token punctuation">;</span>    server <span class="token punctuation">{</span>     listen <span class="token number">443</span> ssl<span class="token punctuation">;</span>  <span class="token comment"># 启用 HTTPS</span>        ssl_certificate      /etc/nginx/certs/cert.pem<span class="token punctuation">;</span>        ssl_certificate_key  /etc/nginx/certs/key.pem<span class="token punctuation">;</span>        root /usr/share/nginx/html<span class="token punctuation">;</span>        index index.html<span class="token punctuation">;</span>                location / <span class="token punctuation">{</span>            root /usr/share/nginx/html<span class="token punctuation">;</span>            try_files <span class="token variable">$uri</span> <span class="token variable">$uri</span>/ /index.html<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment"># HLS 端点</span>        location /hls <span class="token punctuation">{</span>            <span class="token builtin class-name">alias</span> /tmp/hls<span class="token punctuation">;</span>    types <span class="token punctuation">{</span>application/vnd.apple.mpegurl m3u8<span class="token punctuation">;</span>video/mp2t ts<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    add_header Cache-Control no-cache<span class="token punctuation">;</span>    add_header Access-Control-Allow-Origin *<span class="token punctuation">;</span>    add_header Access-Control-Allow-Methods GET,OPTIONS<span class="token punctuation">;</span>    add_header Access-Control-Allow-Headers *<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment"># HTTP-FLV 播放端点</span>        location /live <span class="token punctuation">{</span>            flv_live on<span class="token punctuation">;</span>    add_header Access-Control-Allow-Origin *<span class="token punctuation">;</span>    add_header Access-Control-Allow-Methods GET,OPTIONS<span class="token punctuation">;</span>    add_header Access-Control-Allow-Headers *<span class="token punctuation">;</span>    add_header Access-Control-Allow-Credentials <span class="token boolean">true</span><span class="token punctuation">;</span>    chunked_transfer_encoding on<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment"># 状态监控端点</span>        location /stat <span class="token punctuation">{</span>            rtmp_stat all<span class="token punctuation">;</span>            rtmp_stat_stylesheet stat.xsl<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        location /stat.xsl <span class="token punctuation">{</span>            root /usr/local/nginx/conf<span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    server <span class="token punctuation">{</span>        listen <span class="token number">80</span><span class="token punctuation">;</span>        server_name localhost<span class="token punctuation">;</span>        <span class="token builtin class-name">return</span> <span class="token number">301</span> https://<span class="token variable">$host</span><span class="token variable">$request_uri</span><span class="token punctuation">;</span>  <span class="token comment"># HTTP 强制跳转 HTTPS</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>rtmp_auto_push on<span class="token punctuation">;</span>rtmp_auto_push_reconnect 1s<span class="token punctuation">;</span>rtmp <span class="token punctuation">{</span>    out_queue           <span class="token number">4096</span><span class="token punctuation">;</span>    out_cork            <span class="token number">8</span><span class="token punctuation">;</span>    max_streams         <span class="token number">128</span><span class="token punctuation">;</span>    <span class="token function">timeout</span>             15s<span class="token punctuation">;</span>    drop_idle_publisher 15s<span class="token punctuation">;</span>    log_interval 5s<span class="token punctuation">;</span> <span class="token comment">#log模块在access.log中记录日志的间隔时间，对调试非常有用</span>    log_size     1m<span class="token punctuation">;</span> <span class="token comment">#log模块用来记录日志的缓冲区大小</span>    server <span class="token punctuation">{</span>        listen <span class="token number">1935</span><span class="token punctuation">;</span>        chunk_size <span class="token number">4096</span><span class="token punctuation">;</span>        <span class="token function">ping</span> 30s<span class="token punctuation">;</span>        notify_method get<span class="token punctuation">;</span>        application live <span class="token punctuation">{</span>            live on<span class="token punctuation">;</span>            meta off<span class="token punctuation">;</span>                        <span class="token comment"># HLS 配置</span>            hls on<span class="token punctuation">;</span>            hls_path /tmp/hls<span class="token punctuation">;</span>            hls_fragment 2s<span class="token punctuation">;</span>       <span class="token comment"># 切片时长至少1秒，建议2秒</span>            hls_playlist_length 6s<span class="token punctuation">;</span> <span class="token comment"># 播放列表保留3个切片</span>            hls_sync 100ms<span class="token punctuation">;</span>            hls_base_url /hls/<span class="token punctuation">;</span>            hls_cleanup on<span class="token punctuation">;</span>       <span class="token comment"># 自动清理旧切片</span>            hls_continuous on<span class="token punctuation">;</span>    <span class="token comment"># 连续模式（避免播放中断）</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>编写 index.html</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>zh-CN<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>直播监控<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/css/video-js.min.css<span class="token punctuation">"</span></span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">        <span class="token comment">/* 容器样式 */</span>        <span class="token selector">.player-container</span> <span class="token punctuation">{</span>            <span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span>            <span class="token property">gap</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span> <span class="token comment">/* 播放器间距 */</span>            <span class="token property">padding</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span>            <span class="token property">max-width</span><span class="token punctuation">:</span> 1600px<span class="token punctuation">;</span> <span class="token comment">/* 最大宽度限制 */</span>            <span class="token property">margin</span><span class="token punctuation">:</span> 0 auto<span class="token punctuation">;</span> <span class="token comment">/* 居中 */</span>        <span class="token punctuation">}</span>        <span class="token comment">/* 单个播放器包装 */</span>        <span class="token selector">.player-wrapper</span> <span class="token punctuation">{</span>            <span class="token property">flex</span><span class="token punctuation">:</span> 1<span class="token punctuation">;</span> <span class="token comment">/* 等分剩余空间 */</span>            <span class="token property">min-width</span><span class="token punctuation">:</span> 300px<span class="token punctuation">;</span> <span class="token comment">/* 最小宽度防止挤压 */</span>            <span class="token property">background</span><span class="token punctuation">:</span> #f5f5f5<span class="token punctuation">;</span>            <span class="token property">border-radius</span><span class="token punctuation">:</span> 8px<span class="token punctuation">;</span>            <span class="token property">padding</span><span class="token punctuation">:</span> 15px<span class="token punctuation">;</span>            <span class="token property">box-shadow</span><span class="token punctuation">:</span> 0 4px 6px <span class="token function">rgba</span><span class="token punctuation">(</span>0<span class="token punctuation">,</span>0<span class="token punctuation">,</span>0<span class="token punctuation">,</span>0.1<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment">/* 视频元素自适应 */</span>        <span class="token selector">.video-js, #videoElement</span> <span class="token punctuation">{</span>            <span class="token property">width</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>            <span class="token property">height</span><span class="token punctuation">:</span> auto<span class="token punctuation">;</span>            <span class="token property">border-radius</span><span class="token punctuation">:</span> 4px<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment">/* 标题样式 */</span>        <span class="token selector">h3</span> <span class="token punctuation">{</span>            <span class="token property">margin</span><span class="token punctuation">:</span> 0 0 10px 0<span class="token punctuation">;</span>            <span class="token property">color</span><span class="token punctuation">:</span> #333<span class="token punctuation">;</span>            <span class="token property">font-size</span><span class="token punctuation">:</span> 1.2em<span class="token punctuation">;</span>            <span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment">/* 移动端适配 */</span>        <span class="token atrule"><span class="token rule">@media</span> <span class="token punctuation">(</span><span class="token property">max-width</span><span class="token punctuation">:</span> 768px<span class="token punctuation">)</span></span> <span class="token punctuation">{</span>            <span class="token selector">.player-container</span> <span class="token punctuation">{</span>                <span class="token property">flex-direction</span><span class="token punctuation">:</span> column<span class="token punctuation">;</span> <span class="token comment">/* 小屏幕垂直排列 */</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>    <span class="token comment">&lt;!-- 播放器容器 --&gt;</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>player-container<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>        <span class="token comment">&lt;!-- HLS 播放器 --&gt;</span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>player-wrapper<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">&gt;</span></span>HLS 直播流<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>video</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hlsPlayer<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>video-js vjs-default-skin<span class="token punctuation">"</span></span> <span class="token attr-name">controls</span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/hls/stream.m3u8<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>application/vnd.apple.mpegurl<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>video</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>        <span class="token comment">&lt;!-- FLV 播放器 --&gt;</span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>player-wrapper<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">&gt;</span></span>FLV 低延迟流<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>video</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>videoElement<span class="token punctuation">"</span></span> <span class="token attr-name">controls</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>video</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>    <span class="token comment">&lt;!-- 依赖库 --&gt;</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/js/video.min.js<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/js/flv.min.js<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">        <span class="token comment">// HLS播放器初始化</span>        <span class="token keyword">const</span> hlsPlayer <span class="token operator">=</span> <span class="token function">videojs</span><span class="token punctuation">(</span><span class="token string">'hlsPlayer'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>            <span class="token literal-property property">autoplay</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>            <span class="token literal-property property">fluid</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>            <span class="token literal-property property">techOrder</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'html5'</span><span class="token punctuation">]</span>  <span class="token comment">// 强制使用HTML5模式</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// flv播放器初始化</span>        <span class="token keyword">const</span> videoElement <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'videoElement'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">const</span> flvPlayer <span class="token operator">=</span> flvjs<span class="token punctuation">.</span><span class="token function">createPlayer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'flv'</span><span class="token punctuation">,</span>    <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">'/live?app=live&amp;stream=stream'</span><span class="token punctuation">,</span>    <span class="token literal-property property">isLive</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    <span class="token literal-property property">hasAudio</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>    <span class="token literal-property property">stashInitialSize</span><span class="token operator">:</span> <span class="token number">128</span><span class="token punctuation">,</span>    <span class="token literal-property property">withCredentials</span><span class="token operator">:</span> <span class="token boolean">true</span>  <span class="token comment">// 允许跨域带凭证</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        flvPlayer<span class="token punctuation">.</span><span class="token function">attachMediaElement</span><span class="token punctuation">(</span>videoElement<span class="token punctuation">)</span><span class="token punctuation">;</span>        flvPlayer<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        flvPlayer<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>使用docker compose构建容器</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">services</span><span class="token punctuation">:</span>  <span class="token key atrule">nginx-flv</span><span class="token punctuation">:</span>    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>flv<span class="token punctuation">:</span>latest    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>flv    <span class="token key atrule">restart</span><span class="token punctuation">:</span> unless<span class="token punctuation">-</span>stopped    <span class="token key atrule">ports</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token string">"1935:1935"</span>  <span class="token comment"># RTMP协议端口</span>      <span class="token punctuation">-</span> <span class="token string">"80:80"</span>      <span class="token comment"># HTTP协议端口</span>      <span class="token punctuation">-</span> <span class="token string">"443:443"</span>    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> ./config/nginx.conf<span class="token punctuation">:</span>/usr/local/nginx/conf/nginx.conf  <span class="token comment"># 修正配置文件路径</span>      <span class="token punctuation">-</span> ./data/hls<span class="token punctuation">:</span>/tmp/hls      <span class="token punctuation">-</span> ./data/recordings<span class="token punctuation">:</span>/tmp/recordings      <span class="token punctuation">-</span> ./logs<span class="token punctuation">:</span>/var/log/nginx      <span class="token punctuation">-</span> ./dist<span class="token punctuation">:</span>/usr/share/nginx/html  <span class="token comment"># 静态文件目录</span>      <span class="token punctuation">-</span> ./certs<span class="token punctuation">:</span>/etc/nginx/certs  <span class="token comment"># 挂载证书目录</span>    <span class="token key atrule">environment</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> TZ=Asia/Shanghai<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>使用ffmpeg进行推流</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span><span class="token comment"># 推流参数配置</span><span class="token assign-left variable">INPUT_DEVICE</span><span class="token operator">=</span><span class="token string">"/dev/video0"</span>                              <span class="token comment"># 摄像头设备</span><span class="token assign-left variable">RTMP_URL</span><span class="token operator">=</span><span class="token string">"rtmp://192.168.217.130/live/stream"</span>       <span class="token comment"># 流名称需匹配前端播放器</span><span class="token assign-left variable">RESOLUTION</span><span class="token operator">=</span><span class="token string">"640x480"</span>                                   <span class="token comment"># 建议分辨率</span><span class="token assign-left variable">FPS</span><span class="token operator">=</span><span class="token number">15</span>                                                  <span class="token comment"># 帧率</span><span class="token assign-left variable">BITRATE</span><span class="token operator">=</span><span class="token string">"2000k"</span>                                         <span class="token comment"># 码率</span>ffmpeg <span class="token punctuation">\</span>  <span class="token parameter variable">-f</span> v4l2 <span class="token punctuation">\</span>  <span class="token parameter variable">-input_format</span> yuyv422 <span class="token punctuation">\</span>  <span class="token parameter variable">-video_size</span> <span class="token variable">$RESOLUTION</span> <span class="token punctuation">\</span>  <span class="token parameter variable">-framerate</span> <span class="token variable">$FPS</span> <span class="token punctuation">\</span>  <span class="token parameter variable">-i</span> <span class="token string">"<span class="token variable">$INPUT_DEVICE</span>"</span> <span class="token punctuation">\</span>  <span class="token parameter variable">-vf</span> <span class="token string">"format=yuv420p"</span> <span class="token punctuation">\</span>  <span class="token parameter variable">-c:v</span> libx264 <span class="token punctuation">\</span>  <span class="token parameter variable">-profile:v</span> main <span class="token punctuation">\</span>  <span class="token parameter variable">-preset</span> ultrafast <span class="token punctuation">\</span>  <span class="token parameter variable">-tune</span> zerolatency <span class="token punctuation">\</span>  -x264-params <span class="token string">"keyint=60:min-keyint=30:no-scenecut=1"</span> <span class="token punctuation">\</span>  <span class="token parameter variable">-b:v</span> <span class="token variable">$BITRATE</span> <span class="token punctuation">\</span>  <span class="token parameter variable">-maxrate</span> <span class="token variable">$BITRATE</span> <span class="token punctuation">\</span>  <span class="token parameter variable">-minrate</span> <span class="token variable">$BITRATE</span> <span class="token punctuation">\</span>  <span class="token parameter variable">-f</span> flv <span class="token punctuation">\</span>  <span class="token string">"<span class="token variable">$RTMP_URL</span>"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="运行容器">运行容器</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> compose up <span class="token parameter variable">-d</span><span class="token comment">#删除并运行（更新文件后）</span><span class="token function">docker</span> compose down <span class="token parameter variable">-v</span> <span class="token operator">&amp;&amp;</span> <span class="token function">docker</span> compose up <span class="token parameter variable">-d</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="效果">效果</h3><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/202505172013321.png" alt="image-20250517201341792"></p><h2 id="有哪些坑">有哪些坑？</h2><blockquote><p><code>访问页面只显示nginx的官方页面，自己的index.html未生效，但是已经挂载了(可以进入容器内查看)</code>—&gt; 文件或文件夹权限问题。</p><pre class="line-numbers language-none"><code class="language-none"># 进入容器检查挂载目录docker exec -it nginx-flv ls -l /usr/share/nginx/html# 预期输出total 12-rw-r--r-- 1 root root  537 index.htmldrwxr-xr-x 2 root root 4096 cssdrwxr-xr-x 2 root root 4096 js# 修补措施# 在宿主机执行（假设挂载目录为 ./html）chmod -R 755 ./html      # 目录权限find ./html -type f -exec chmod 644 {} \;  # 文件权限<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></blockquote><blockquote><p><code>如果docker ps 后发现没有端口信息，应该是出错了。使用 docker logs 容器id 查看错误信息</code></p><p>例如</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/202505171614609.png" alt="image-20250517161421511"></p></blockquote><blockquote><p>index.html文件中的视频地址如果采用ip+路径的形式，会存在跨域问题，为了简单，直接使用了相对地址</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 部署 </category>
          
          <category> 流媒体 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Docker </tag>
            
            <tag> Nginx </tag>
            
            <tag> RTMP </tag>
            
            <tag> HLS </tag>
            
            <tag> FFmpeg </tag>
            
            <tag> HTTP-FLV </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>搭建Nginx-RTMP流媒体服务器</title>
      <link href="/2025/05/21/%E6%90%AD%E5%BB%BANginx-RTMP%E6%B5%81%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1%E5%99%A8/"/>
      <url>/2025/05/21/%E6%90%AD%E5%BB%BANginx-RTMP%E6%B5%81%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1%E5%99%A8/</url>
      
        <content type="html"><![CDATA[<h2 id="搭建nginx-rtmp">搭建Nginx-RTMP</h2><blockquote><p>该服务器仅支持HLS, 不支持HTTP-FLV, 如果要使用HTTP-FLV协议请前往<a href="/2025/05/21/%E6%90%AD%E5%BB%BANginx-FLV%E6%B5%81%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1%E5%99%A8/" title="搭建Nginx-FLV流媒体服务器">搭建Nginx-FLV流媒体服务器</a> 查看更多信息请前往 <a href="https://github.com/zikcc/nginx-streaming-demos">github:nginx-streaming-demos</a></p></blockquote><h3 id="准备工作">准备工作</h3><ol type="1"><li><p>安装docker</p> <a href="/2025/05/21/ubuntu22-04%E5%AE%89%E8%A3%85docker/" title="ubuntu22.04安装docker">安装教程</a></li><li><p>安装ffmpeg:</p> <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> update<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> ffmpeg<span class="token comment"># 查看版本</span>ffmpeg <span class="token parameter variable">-version</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>采用文件挂载的方式修改docker容器(可选):为了综合管理以后的多个docker容器，在本地ubuntu中创建以下文件结构，以后将这些目录挂载到docker容器上。</p> <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token punctuation">\</span>~/Desktop/docker/projects/nginx-rtmp/<span class="token punctuation">{</span>config,data/hls,data/recordings,dist,logs<span class="token punctuation">}</span>/home/lzk/Desktop/docker/├── projects/                    <span class="token comment"># 所有Docker项目</span>├── nginx-rtmp/               <span class="token comment"># 流媒体服务</span>        ├── config/            <span class="token comment"># Nginx配置</span>        │   └── nginx.conf        ├── data/              <span class="token comment"># 持久化数据</span>        │   ├── hls/           <span class="token comment"># HLS切片</span>        │   └── recordings/    <span class="token comment"># 录像文件</span>        ├── logs/              <span class="token comment"># 日志文件</span>        ├── dist/              <span class="token comment"># 前端编译后的静态文件</span>        └── docker-compose.yml         <span class="token comment"># 主编排文件</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><h3 id="拉取镜像">拉取镜像</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> pull tiangolo/nginx-rtmp:latest<span class="token comment">#查看</span><span class="token function">docker</span> images<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>使用Docker命令运行Nginx-RTMP容器，并映射好必要的端口（如RTMP协议的1935端口和HTTP协议的80端口）。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">-p</span> <span class="token number">1935</span>:1935 <span class="token parameter variable">-p</span> <span class="token number">80</span>:80 <span class="token parameter variable">--name</span> nginx-rtmp tiangolo/nginx-rtmp:latest<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>直接在容器中修改配置文件，可能会由于容器重启或删除而失效。故采用-v挂载的方式。</p><p>复制配置文件</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> <span class="token function">cp</span> nginx-rtmp:/etc/nginx/nginx.conf ~/Desktop/docker/projects/nginx-rtmp/config/<span class="token comment"># 删除这个容器，后面再启动</span><span class="token function">docker</span> <span class="token function">rm</span> <span class="token parameter variable">-f</span> nginx-rtmp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="修改nignxconf配置文件">修改nignx.conf配置文件</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">worker_processes auto<span class="token punctuation">;</span>events <span class="token punctuation">{</span>    worker_connections <span class="token number">1024</span><span class="token punctuation">;</span>    use epoll<span class="token punctuation">;</span><span class="token punctuation">}</span>rtmp <span class="token punctuation">{</span>    server <span class="token punctuation">{</span>        listen <span class="token number">1935</span><span class="token punctuation">;</span>        chunk_size <span class="token number">8192</span><span class="token punctuation">;</span>        max_streams <span class="token number">64</span><span class="token punctuation">;</span>        ack_window <span class="token number">5000000</span><span class="token punctuation">;</span>  <span class="token comment"># 合理ACK窗口大小</span>                application live <span class="token punctuation">{</span>            live on<span class="token punctuation">;</span>            meta off<span class="token punctuation">;</span>         <span class="token comment"># 禁用元数据缓存</span>                        <span class="token comment"># HLS低延迟优化</span>            hls on<span class="token punctuation">;</span>            hls_path /tmp/hls<span class="token punctuation">;</span>            hls_fragment 1s<span class="token punctuation">;</span>     <span class="token comment"># 切片时长1s</span>            hls_playlist_length 3s<span class="token punctuation">;</span> <span class="token comment"># 播放列表保留3秒切片</span>            hls_sync 100ms<span class="token punctuation">;</span>         <span class="token comment"># 音视频同步阈值</span>            hls_base_url /hls/<span class="token punctuation">;</span>  <span class="token comment"># HLS访问路径</span>                        <span class="token comment"># 关键帧间隔优化</span>            wait_key off<span class="token punctuation">;</span>    <span class="token comment"># 不等待关键帧</span>            idle_streams off<span class="token punctuation">;</span>                  <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>http <span class="token punctuation">{</span>    include mime.types<span class="token punctuation">;</span>    default_type application/octet-stream<span class="token punctuation">;</span>        sendfile on<span class="token punctuation">;</span>    tcp_nopush on<span class="token punctuation">;</span>    tcp_nodelay on<span class="token punctuation">;</span>    keepalive_timeout <span class="token number">65</span><span class="token punctuation">;</span>    server <span class="token punctuation">{</span>        listen <span class="token number">80</span><span class="token punctuation">;</span>        server_name localhost<span class="token punctuation">;</span>root /usr/share/nginx/html<span class="token punctuation">;</span>  <span class="token comment"># 必须与挂载路径一致</span>        index index.html<span class="token punctuation">;</span>                location / <span class="token punctuation">{</span>            try_files <span class="token variable">$uri</span> <span class="token variable">$uri</span>/ /index.html<span class="token punctuation">;</span>        <span class="token punctuation">}</span>                <span class="token comment"># HLS端点（极低延迟配置）</span>        location /hls <span class="token punctuation">{</span>            <span class="token builtin class-name">alias</span> /tmp/hls<span class="token punctuation">;</span>            types <span class="token punctuation">{</span>                application/vnd.apple.mpegurl m3u8<span class="token punctuation">;</span>                video/mp2t ts<span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token comment"># 状态监控端点</span>        location /stat <span class="token punctuation">{</span>            rtmp_stat all<span class="token punctuation">;</span>            rtmp_stat_stylesheet stat.xsl<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        location /stat.xsl <span class="token punctuation">{</span>            root /usr/local/nginx/conf<span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="indexhtml">index.html</h3><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>zh-CN<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>直播监控<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/css/video-js.min.css<span class="token punctuation">"</span></span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>    <span class="token comment">&lt;!-- HLS播放器 --&gt;</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">margin</span><span class="token punctuation">:</span>20px<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">&gt;</span></span>HLS直播流<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>video</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hlsPlayer<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>video-js vjs-default-skin<span class="token punctuation">"</span></span> <span class="token attr-name">controls</span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1024<span class="token punctuation">"</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>576<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/hls/stream.m3u8<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>application/vnd.apple.mpegurl<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>video</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>    <span class="token comment">&lt;!-- 依赖库 --&gt;</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/js/video.min.js<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">        <span class="token comment">// HLS播放器初始化</span>        <span class="token keyword">const</span> hlsPlayer <span class="token operator">=</span> <span class="token function">videojs</span><span class="token punctuation">(</span><span class="token string">'hlsPlayer'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>            <span class="token literal-property property">autoplay</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>            <span class="token literal-property property">fluid</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>            <span class="token literal-property property">techOrder</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'html5'</span><span class="token punctuation">]</span>  <span class="token comment">// 强制使用HTML5模式</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="编写-docker-composeyml">编写 docker-compose.yml</h3><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">services</span><span class="token punctuation">:</span>  <span class="token key atrule">nginx-rtmp</span><span class="token punctuation">:</span>    <span class="token key atrule">image</span><span class="token punctuation">:</span> tiangolo/nginx<span class="token punctuation">-</span>rtmp<span class="token punctuation">:</span>latest    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>rtmp    <span class="token key atrule">restart</span><span class="token punctuation">:</span> unless<span class="token punctuation">-</span>stopped    <span class="token key atrule">ports</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token string">"1935:1935"</span>  <span class="token comment"># RTMP协议端口</span>      <span class="token punctuation">-</span> <span class="token string">"80:80"</span>      <span class="token comment"># HTTP协议端口</span>    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> ./config/nginx.conf<span class="token punctuation">:</span>/etc/nginx/nginx.conf     <span class="token comment"># 配置文件</span>      <span class="token punctuation">-</span> ./data/hls<span class="token punctuation">:</span>/tmp/hls                          <span class="token comment"># HLS切片存储</span>      <span class="token punctuation">-</span> ./data/recordings<span class="token punctuation">:</span>/tmp/recordings            <span class="token comment"># 录像文件存储</span>      <span class="token punctuation">-</span> ./logs<span class="token punctuation">:</span>/var/log/nginx                        <span class="token comment"># 日志文件</span>      <span class="token punctuation">-</span> ./dist<span class="token punctuation">:</span>/usr/share/nginx/html                 <span class="token comment"># 前端编译文件</span>    <span class="token key atrule">environment</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> TZ=Asia/Shanghai                             <span class="token comment"># 时区设置</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="启动服务">启动服务</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 安装docker-compose</span><span class="token function">sudo</span> <span class="token function">apt</span>  <span class="token function">install</span> <span class="token function">docker-compose</span><span class="token comment"># 进入项目目录</span><span class="token builtin class-name">cd</span> ~/Desktop/docker/projects/nginx-rtmp<span class="token comment"># 启动容器（后台模式）</span><span class="token function">docker</span> compose up <span class="token parameter variable">-d</span><span class="token comment"># 查看运行状态</span><span class="token function">docker-compose</span> <span class="token function">ps</span><span class="token comment"># 应显示状态为 Up</span><span class="token comment"># 如果修改了本地文件则需要重新启动</span><span class="token function">docker</span> compose down <span class="token parameter variable">-v</span> <span class="token operator">&amp;&amp;</span> <span class="token function">docker</span> compose up <span class="token parameter variable">-d</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="验证挂载结果">验证挂载结果</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 检查配置文件同步</span><span class="token function">docker</span> <span class="token builtin class-name">exec</span> nginx-rtmp <span class="token function">ls</span> <span class="token parameter variable">-l</span> /etc/nginx/<span class="token comment"># 应看到nginx.conf的修改时间为当前时间</span><span class="token comment"># 查看HLS目录权限</span><span class="token function">docker</span> <span class="token builtin class-name">exec</span> nginx-rtmp <span class="token function">ls</span> <span class="token parameter variable">-ld</span> /tmp/hls<span class="token comment"># 应显示权限为 drwxr-xr-x</span><span class="token comment"># 验证dist文件挂载</span><span class="token function">docker</span> <span class="token builtin class-name">exec</span> nginx-rtmp <span class="token function">ls</span> /usr/share/nginx/html<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ubuntu主机开放端口</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> ufw allow <span class="token number">80</span>/tcp<span class="token function">sudo</span> ufw allow <span class="token number">1935</span>/tcp<span class="token function">sudo</span> ufw reload<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="推流测试">推流测试</h3><p>命令行形式：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 延迟 45 秒</span>ffmpeg <span class="token parameter variable">-f</span> v4l2 <span class="token parameter variable">-input_format</span> yuyv422 <span class="token parameter variable">-i</span> /dev/video0 <span class="token punctuation">\</span>  <span class="token parameter variable">-c:v</span> libx264 <span class="token parameter variable">-preset</span> ultrafast <span class="token parameter variable">-tune</span> zerolatency <span class="token punctuation">\</span>  <span class="token parameter variable">-f</span> flv rtmp://192.168.217.130/live/stream<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>使用脚本，创建 push_stream.sh</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span><span class="token assign-left variable">INPUT_DEVICE</span><span class="token operator">=</span><span class="token string">"/dev/video0"</span><span class="token assign-left variable">RTMP_URL</span><span class="token operator">=</span><span class="token string">"rtmp://192.168.217.130/live/stream"</span>  ffmpeg <span class="token punctuation">\</span>  <span class="token parameter variable">-f</span> v4l2 <span class="token punctuation">\</span>  <span class="token parameter variable">-input_format</span> yuyv422 <span class="token punctuation">\</span>  <span class="token parameter variable">-video_size</span> 640x480 <span class="token punctuation">\</span>  <span class="token parameter variable">-framerate</span> <span class="token number">30</span> <span class="token punctuation">\</span>  <span class="token parameter variable">-i</span> <span class="token string">"<span class="token variable">$INPUT_DEVICE</span>"</span> <span class="token punctuation">\</span>  <span class="token parameter variable">-vf</span> <span class="token string">"format=yuv420p"</span> <span class="token punctuation">\</span>  <span class="token parameter variable">-c:v</span> libx264 <span class="token punctuation">\</span>  <span class="token parameter variable">-profile:v</span> baseline <span class="token punctuation">\</span>  <span class="token parameter variable">-level</span> <span class="token number">3.1</span> <span class="token punctuation">\</span>  <span class="token parameter variable">-preset</span> ultrafast <span class="token punctuation">\</span>  <span class="token parameter variable">-tune</span> zerolatency <span class="token punctuation">\</span>  -x264-params <span class="token string">"keyint=30:min-keyint=30:no-scenecut=1"</span> <span class="token punctuation">\</span>  <span class="token parameter variable">-b:v</span> 1M <span class="token punctuation">\</span>  <span class="token parameter variable">-maxrate</span> 1M <span class="token punctuation">\</span>  <span class="token parameter variable">-minrate</span> 1M <span class="token punctuation">\</span>  <span class="token parameter variable">-f</span> flv <span class="token punctuation">\</span>  <span class="token string">"<span class="token variable">$RTMP_URL</span>"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>进入浏览器查看</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">http://localhost:80<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 部署 </category>
          
          <category> 流媒体 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Docker </tag>
            
            <tag> Nginx </tag>
            
            <tag> RTMP </tag>
            
            <tag> HLS </tag>
            
            <tag> FFmpeg </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ubuntu22.04安装docker</title>
      <link href="/2025/05/21/ubuntu22-04%E5%AE%89%E8%A3%85docker/"/>
      <url>/2025/05/21/ubuntu22-04%E5%AE%89%E8%A3%85docker/</url>
      
        <content type="html"><![CDATA[<h2 id="安装docker">安装docker</h2><p>虚拟机 ubuntu 22.04 安装 docker</p><h3 id="准备工作">准备工作</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#安装前先卸载操作系统默认安装的docker，</span><span class="token function">sudo</span> <span class="token function">apt-get</span> remove <span class="token function">docker</span> docker-engine docker.io containerd runc<span class="token comment">#安装必要支持</span><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> apt-transport-https ca-certificates <span class="token function">curl</span> software-properties-common gnupg lsb-release<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="添加源">添加源</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#添加 Docker 官方 GPG key （可能国内现在访问会存在问题）</span><span class="token function">curl</span> <span class="token parameter variable">-fsSL</span> https://download.docker.com/linux/ubuntu/gpg <span class="token operator">|</span> <span class="token function">sudo</span> gpg <span class="token parameter variable">--dearmor</span> <span class="token parameter variable">-o</span> /usr/share/keyrings/docker-archive-keyring.gpg<span class="token comment"># 阿里源（推荐使用阿里的gpg KEY）</span><span class="token function">curl</span> <span class="token parameter variable">-fsSL</span> https://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg <span class="token operator">|</span> <span class="token function">sudo</span> gpg <span class="token parameter variable">--dearmor</span> <span class="token parameter variable">-o</span> /usr/share/keyrings/docker-archive-keyring.gpg<span class="token comment">#添加 apt 源:</span><span class="token comment">#Docker官方源</span><span class="token builtin class-name">echo</span> <span class="token string">"deb [arch=<span class="token variable"><span class="token variable">$(</span>dpkg --print-architecture<span class="token variable">)</span></span> signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu <span class="token variable"><span class="token variable">$(</span>lsb_release <span class="token parameter variable">-cs</span><span class="token variable">)</span></span> stable"</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/apt/sources.list.d/docker.list <span class="token operator">&gt;</span> /dev/null<span class="token comment">#阿里apt源</span><span class="token builtin class-name">echo</span> <span class="token string">"deb [arch=<span class="token variable"><span class="token variable">$(</span>dpkg --print-architecture<span class="token variable">)</span></span> signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://mirrors.aliyun.com/docker-ce/linux/ubuntu <span class="token variable"><span class="token variable">$(</span>lsb_release <span class="token parameter variable">-cs</span><span class="token variable">)</span></span> stable"</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/apt/sources.list.d/docker.list <span class="token operator">&gt;</span> /dev/null<span class="token comment">#更新源</span><span class="token function">sudo</span> <span class="token function">apt</span> update<span class="token function">sudo</span> <span class="token function">apt-get</span> update<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="安装最新版docker">安装最新版docker</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#安装最新版本的Docker</span><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> docker-ce docker-ce-cli containerd.io<span class="token comment">#等待安装完成</span><span class="token comment">#查看Docker版本</span><span class="token function">sudo</span> <span class="token function">docker</span> version<span class="token comment">#查看Docker运行状态</span><span class="token function">sudo</span> systemctl status <span class="token function">docker</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="不想-sudo-docker-">不想 sudo docker …?</h3><p>此时使用 docker ps 会提示权限不够，需要 sudo docker ps</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#添加docker用户组</span><span class="token function">sudo</span> <span class="token function">groupadd</span> <span class="token function">docker</span><span class="token comment">#将当前用户添加到用户组</span><span class="token function">sudo</span> <span class="token function">usermod</span> <span class="token parameter variable">-aG</span> <span class="token function">docker</span> <span class="token environment constant">$USER</span><span class="token comment">#使权限生效</span>newgrp <span class="token function">docker</span><span class="token comment">#查看所有容器</span><span class="token function">docker</span> <span class="token function">ps</span> <span class="token parameter variable">-a</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果没有此行命令，你会发现，当你每次打开新的终端 你都必须先执行一次“newgrp docker” 命令 否则当前用户还是不可以执行docker命令</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gedit ~/.bashrc<span class="token comment"># 在文件最下方加入</span><span class="token keyword">if</span> <span class="token operator">!</span> <span class="token function">groups</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-q</span> <span class="token function">docker</span><span class="token punctuation">;</span> <span class="token keyword">then</span>    newgrp <span class="token function">docker</span><span class="token keyword">fi</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="配置仓库镜像">配置仓库镜像</h3><p>另外，我们需要在docker daemon 配置文件中增加国的可用的 docker hubmirror ， 找到你的daemon.json 文件，通常在 /etc/docker/daemon.json这个位置，如果没有就创建一个</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> gedit /etc/docker/daemon.json<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>在daemon.json 中增加</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">{</span>    <span class="token string">"registry-mirrors"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>        <span class="token string">"https://docker.m.daocloud.io"</span>  <span class="token punctuation">]</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>重置生效</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> systemctl daemon-reload<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> systemctl restart <span class="token function">docker</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> info<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="如果中途出错可以执行以下命令卸载docker重试">如果中途出错可以，执行以下命令卸载docker，重试</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> purge docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 环境搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ubuntu22.04安装编译OpenCV</title>
      <link href="/2025/05/21/ubuntu22-04%E5%AE%89%E8%A3%85%E7%BC%96%E8%AF%91OpenCV/"/>
      <url>/2025/05/21/ubuntu22-04%E5%AE%89%E8%A3%85%E7%BC%96%E8%AF%91OpenCV/</url>
      
        <content type="html"><![CDATA[<h2 id="安装opencv">安装opencv</h2><h3 id="前置环境">前置环境</h3><p>需要系统上存在cmake, g++, make 或者 ninja-build 如果没有,执行下面命令安装:</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#更新apt可安装包列表</span><span class="token function">sudo</span> <span class="token function">apt</span> update <span class="token comment">#安装cmake和g++</span><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> <span class="token parameter variable">-y</span> cmake g++ <span class="token comment">#安装项目构建工具，有两个选择，make或ninja</span><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> <span class="token function">make</span> <span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> ninja-build<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="卸载旧版本">卸载旧版本</h3><p>如果系统上存在旧版本的 opencv 或者 使用 sudo apt installlibopencv-dev 命令下载的可以选择使用以下命令删除：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> purge libopencv-dev<span class="token function">sudo</span> <span class="token function">rm</span> <span class="token parameter variable">-rf</span> /usr/include/opencv4 /usr/lib/x86_64-linux-gnu/libopencv_* <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="下载官方源代码">下载官方源代码</h3><p>新建文件夹放置下载的源码 这里我下载到了</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> ~/Desktop/vision/opencv_lib<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>从github 下载opencv源码和扩展模块的源码</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> https://github.com/opencv/opencv.git<span class="token function">git</span> https://github.com/opencv/opencv_contrib.git<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>opencv_lib文件夹下存在</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">opencv-4.11.0opencv_contrib<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="安装opencv-依赖">安装opencv 依赖</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> <span class="token parameter variable">-y</span> <span class="token punctuation">\</span>    build-essential cmake <span class="token function">git</span> pkg-config libgtk-3-dev <span class="token punctuation">\</span>    libavcodec-dev libavformat-dev libswscale-dev libv4l-dev <span class="token punctuation">\</span>    libxvidcore-dev libx264-dev libjpeg-dev libpng-dev libtiff-dev <span class="token punctuation">\</span>    gfortran openexr libatlas-base-dev python3-dev python3-numpy <span class="token punctuation">\</span>    libtbb2 libtbb-dev libdc1394-22-dev libopenexr-dev <span class="token punctuation">\</span>    libgstreamer-plugins-base1.0-dev libgstreamer1.0-dev <span class="token punctuation">\</span>    libice-dev libbsd-dev<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="配置并编译-opencv">配置并编译 opencv</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> ~/Desktop/vision/opencv_lib/opencv-4.11.0/build<span class="token comment"># 如果之前配置出错可以删除</span><span class="token function">rm</span> <span class="token parameter variable">-rf</span> *<span class="token comment"># \ 后面注意不要有空格，否则在终端运行会出错</span>cmake <span class="token parameter variable">-D</span> <span class="token assign-left variable">CMAKE_BUILD_TYPE</span><span class="token operator">=</span>RELEASE <span class="token punctuation">\</span>      <span class="token parameter variable">-D</span> <span class="token assign-left variable">CMAKE_INSTALL_PREFIX</span><span class="token operator">=</span>/usr/local <span class="token punctuation">\</span>      <span class="token parameter variable">-D</span> <span class="token assign-left variable">OPENCV_GENERATE_PKGCONFIG</span><span class="token operator">=</span>ON <span class="token punctuation">\</span>      <span class="token parameter variable">-D</span> <span class="token assign-left variable">OPENCV_EXTRA_MODULES_PATH</span><span class="token operator">=~</span>/Desktop/vision/opencv_lib/opencv_contrib/modules <span class="token punctuation">\</span>      <span class="token parameter variable">-D</span> <span class="token assign-left variable">BUILD_EXAMPLES</span><span class="token operator">=</span>OFF <span class="token punctuation">\</span>      <span class="token parameter variable">-D</span> <span class="token assign-left variable">WITH_GTK</span><span class="token operator">=</span>ON <span class="token punctuation">\</span>      <span class="token parameter variable">-D</span> <span class="token assign-left variable">WITH_FFMPEG</span><span class="token operator">=</span>ON <span class="token punctuation">\</span>      <span class="token parameter variable">-D</span> <span class="token assign-left variable">WITH_V4L</span><span class="token operator">=</span>ON <span class="token punctuation">\</span>      <span class="token punctuation">..</span><span class="token function">make</span> -j<span class="token variable"><span class="token variable">$(</span>nproc<span class="token variable">)</span></span><span class="token function">sudo</span> <span class="token function">make</span> <span class="token function">install</span><span class="token function">sudo</span> ldconfig<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="查看opencv4版本">查看opencv4版本</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pkg-config <span class="token parameter variable">--modversion</span> opencv4<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 环境搭建 </category>
          
          <category> 视觉 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> OpenCV </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>逆向破解加密爬取音乐实战</title>
      <link href="/2025/05/20/%E9%80%86%E5%90%91%E7%A0%B4%E8%A7%A3%E5%8A%A0%E5%AF%86%E7%88%AC%E5%8F%96%E9%9F%B3%E4%B9%90%E5%AE%9E%E6%88%98/"/>
      <url>/2025/05/20/%E9%80%86%E5%90%91%E7%A0%B4%E8%A7%A3%E5%8A%A0%E5%AF%86%E7%88%AC%E5%8F%96%E9%9F%B3%E4%B9%90%E5%AE%9E%E6%88%98/</url>
      
        <content type="html"><![CDATA[<blockquote><p>该音乐网站已经停止运维</p></blockquote><h2 id="逆向模拟加密请求接口">逆向模拟加密请求接口</h2><h3 id="搜索api">搜索api</h3><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/爬虫/1738923287003.png" alt="1738923287003"></p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/爬虫/1738923324521.png" alt="1738923324521"></p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/爬虫/1738923343388.png" alt="1738923343388"></p><p>接口地址：https://tool.liumingye.cn/music/api/search POST请求请求参数为：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span><span class="token property">"type"</span><span class="token operator">:</span><span class="token string">"YQM"</span><span class="token punctuation">,</span><span class="token property">"text"</span><span class="token operator">:</span><span class="token string">"唯一"</span><span class="token punctuation">,</span><span class="token property">"page"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">"v"</span><span class="token operator">:</span><span class="token string">"beta"</span><span class="token punctuation">,</span><span class="token property">"_t"</span><span class="token operator">:</span><span class="token number">1738923249577</span><span class="token punctuation">,</span><span class="token property">"token"</span><span class="token operator">:</span><span class="token string">"20241016.e38efcba0d384a6782e835d8d63a2837"</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>响应数据格式：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>    <span class="token property">"code"</span><span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>    <span class="token property">"data"</span><span class="token operator">:</span> <span class="token punctuation">{</span>        <span class="token property">"list"</span><span class="token operator">:</span> <span class="token punctuation">[</span>            <span class="token punctuation">{</span>                <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"zEAY"</span><span class="token punctuation">,</span>                <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"唯一"</span><span class="token punctuation">,</span>                <span class="token property">"time"</span><span class="token operator">:</span> <span class="token number">262</span><span class="token punctuation">,</span>                <span class="token property">"quality"</span><span class="token operator">:</span> <span class="token punctuation">[</span>                    <span class="token number">128</span><span class="token punctuation">,</span>                    <span class="token number">320</span><span class="token punctuation">,</span>                    <span class="token number">2000</span>                <span class="token punctuation">]</span><span class="token punctuation">,</span>                <span class="token property">"album"</span><span class="token operator">:</span> <span class="token punctuation">{</span>                    <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"zqyA"</span><span class="token punctuation">,</span>                    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"唯一"</span><span class="token punctuation">,</span>                    <span class="token property">"pic"</span><span class="token operator">:</span> <span class="token string">"https:\/\/i.biliimg.com\/bfs\/im\/895931b7dea76e5ad7148cf8714192621b9b12bf.jpg@{size}w_{size}h_1c.webp"</span>                <span class="token punctuation">}</span><span class="token punctuation">,</span>                <span class="token property">"artist"</span><span class="token operator">:</span> <span class="token punctuation">[</span>                    <span class="token punctuation">{</span>                        <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"zYOg"</span><span class="token punctuation">,</span>                        <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"王力宏"</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">]</span><span class="token punctuation">,</span>                <span class="token property">"hash"</span><span class="token operator">:</span> <span class="token string">"d3f636iePH3nJMVUD1wbsSTfgf-QwuOgyE9H3WcjYfUEDiX2YdQ"</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token punctuation">{</span>                <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"唯一"</span><span class="token punctuation">,</span>                <span class="token property">"artist"</span><span class="token operator">:</span> <span class="token punctuation">[</span>                    <span class="token punctuation">{</span>                        <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"mfm"</span><span class="token punctuation">,</span>                        <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"告五人"</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">]</span><span class="token punctuation">,</span>                <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"m3f63OtUGNZoMDio1Kv1QtTI8xsjKJ_Mheyn12w07dWSL0qLZFeLha7Ur2BjAcJo"</span><span class="token punctuation">,</span>                <span class="token property">"pic"</span><span class="token operator">:</span> <span class="token string">"https:\/\/d.musicapp.migu.cn\/data\/oss\/resource\/00\/2h\/xz\/6w.webp"</span><span class="token punctuation">,</span>                <span class="token property">"lyric"</span><span class="token operator">:</span> <span class="token string">"https:\/\/d.musicapp.migu.cn\/data\/oss\/resource\/00\/1v\/uz\/x8"</span><span class="token punctuation">,</span>                <span class="token property">"quality"</span><span class="token operator">:</span> <span class="token punctuation">[</span>                    <span class="token number">128</span><span class="token punctuation">,</span>                    <span class="token number">320</span><span class="token punctuation">,</span>                    <span class="token number">2000</span>                <span class="token punctuation">]</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token punctuation">{</span>                <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"唯一"</span><span class="token punctuation">,</span>                <span class="token property">"artist"</span><span class="token operator">:</span> <span class="token punctuation">[</span>                    <span class="token punctuation">{</span>                        <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"mfm"</span><span class="token punctuation">,</span>                        <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"王力宏"</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">]</span><span class="token punctuation">,</span>                <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"m3f63OtUGNZoMDio1KvtWvzQ-xJiZdK54cSf02lE7dWSL0q_ZFeLha7Yo2R7Be58"</span><span class="token punctuation">,</span>                <span class="token property">"pic"</span><span class="token operator">:</span> <span class="token string">"https:\/\/d.musicapp.migu.cn\/data\/oss\/resource\/00\/2u\/km\/05e4226dce81478f918831450cb3c79e.webp"</span><span class="token punctuation">,</span>                <span class="token property">"lyric"</span><span class="token operator">:</span> <span class="token string">"http:\/\/d.musicapp.migu.cn\/prod\/file-service\/file-down01\/4eedd78464c21ce789dea6928415b323\/503186ae19388b5d720c7634363ae4a2\/a3e5f7ace5da52aec33936e1af18845c"</span><span class="token punctuation">,</span>                <span class="token property">"quality"</span><span class="token operator">:</span> <span class="token punctuation">[</span>                    <span class="token number">128</span><span class="token punctuation">,</span>                    <span class="token number">320</span><span class="token punctuation">,</span>                    <span class="token number">2000</span>                <span class="token punctuation">]</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>    ......        <span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token property">"total"</span><span class="token operator">:</span> <span class="token number">221146</span><span class="token punctuation">,</span>        <span class="token property">"word"</span><span class="token operator">:</span> <span class="token punctuation">[</span>            <span class="token string">"唯一"</span>        <span class="token punctuation">]</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token property">"msg"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>开始分析源代码</p><p>首先搜索 api/search 发现这个字符串在混淆变量中</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/爬虫/1738929338043.png" alt="1738929338043"></p><p>const e = [“text-xl font-semibold”, “wheel”, “bc-none”, ……]</p><p>把混淆变量复制过来放到代码文件中</p><p>查找 api/search 的索引为 52，在源代码中搜索（52）发现没有，有可能代码进行了混淆导致索引偏移了</p><p>然后在源代码中追踪一下这个混淆变量，也就是调用 qo() 的地方</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/爬虫/1738929473247.png" alt="1738929473247"></p><p>发现果然会偏移混淆变量</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/爬虫/1738930064364.png" alt="1738930064364"></p><p>尝试搜索 POST</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/爬虫/1738928985755.png" alt="1738928985755"></p><p>打断点刷新网页进行调试，发现网页成功截停</p><p>然后在控制台输入 console.log(r(570))，输出 /api/auth/login</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/爬虫/1738929045345.png" alt="1738929045345"></p><p>发现这是一个验证登录的接口，然后就在文件中查找 /api/auth/login的索引，为 796</p><p>果然，在源代码中 570 ，实际上是 796，偏移了 226</p><p>那么，源代码中的 52（也就是api/search）会不会偏移到了混淆变量的末尾呢，</p><p>混淆变量的长度为 2112， 那么我们就尝试搜索一下 1938 或者搜索 page 或text</p><p>终于找到了：</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/爬虫/1738931509721.png" alt="1738931509721"></p><p>其中 s 就是偏移后的混淆变量</p><p>可以发现这里的 v 是固定的 beta</p><p>打断点调试</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/爬虫/1738932203971.png" alt="1738932203971"></p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/爬虫/1738932253262.png" alt="1738932253262"></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">(</span>o<span class="token punctuation">[</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token number">1129</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token number">1291</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token number">1750</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> o<span class="token punctuation">.</span>params<span class="token punctuation">.</span>keywords<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> i<span class="token punctuation">.</span>page<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token number">780</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token number">780</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">(</span>o<span class="token punctuation">[</span>params<span class="token punctuation">]</span><span class="token punctuation">[</span>engine<span class="token punctuation">]</span><span class="token punctuation">[</span>toString<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> o<span class="token punctuation">.</span>params<span class="token punctuation">.</span>keywords<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> i<span class="token punctuation">.</span>page<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span>data<span class="token punctuation">]</span><span class="token punctuation">[</span>data<span class="token punctuation">]</span><span class="token punctuation">;</span>猜测一下， i<span class="token punctuation">.</span>page应该是 <span class="token number">1</span> 再大胆猜测一下 o<span class="token punctuation">[</span>params<span class="token punctuation">]</span><span class="token punctuation">[</span>engine<span class="token punctuation">]</span><span class="token punctuation">[</span>toString<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 应该对应上面请求的 e<span class="token punctuation">,</span> o<span class="token punctuation">.</span>params<span class="token punctuation">.</span>keywords<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 对应t 也就是 texti<span class="token punctuation">.</span>page 对应的是 page那么， text 和 page 和 v 都已知， 要搞清楚 type 也就是 e<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/爬虫/1738933021265.png" alt="1738933021265"></p><p>找到 o 看一下他到底是什么</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/爬虫/1738933202162.png" alt="1738933202162"></p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/爬虫/1738936228728.png" alt="1738936228728"></p><p>这个函数没有 token 和 _t的字段，应该是调用了这个函数之后又调用了其它的函数</p><p>那么，这个接口的参数还剩下 token 和 _t ，这两个是主要的，尤其 是token，_t 可以猜一下是时间戳</p><p>那就尝试一下在源代码中搜索一下 token, 发现有 7个，数量不多，其中一个还是在混淆变量里，可以都打上断点调试一下，</p><p>如果没有停下，那就搜索一下混淆变量里 token 的索引，不过，很幸运，程序停在了：</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/爬虫/1738936905000.png" alt="1738936905000"></p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/爬虫/1738936935689.png" alt="1738936935689"></p><p>可以看到 token 和 _t 是在这段代码加入的</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/爬虫/1738946360576.png" alt="1738946360576"></p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/爬虫/1738946463201.png" alt="1738946463201"></p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/爬虫/1738946478773.png" alt="1738946478773"></p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/爬虫/1738947140824.png" alt="1738947140824"></p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/爬虫/1738947372920.png" alt="1738947372920"></p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/爬虫/1738947365166.png" alt="1738947365166"></p><p>在AI的帮助下对整个过程有了大致了解，让AI生成整体流程代码，然后多次调试修正后，最终成功逆向了这个加密算法，如下：</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/爬虫/1738990206639.png" alt="1738990206639"></p><h3 id="播放api">播放api</h3><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/爬虫/1738822590547.png" alt="1738822590547"></p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/爬虫/1738822733852.png" alt="1738822733852"></p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/爬虫/1738822750837.png" alt="1738822750837"></p><p>可以看到，这api没有任何返回值，那么问题来了，前端是怎么知道播放链接的呢，会不会是，根据某些前端数据拼接成的播放链接呢？</p><p>经过一系列分析和打断点调试，有以下发现：</p><p>uri编码后的数据：</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/爬虫/1738992896652.png" alt="1738992896652"></p><p>可以结合search api 的返回结果来看，就比较清楚了</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/爬虫/1738992870921.png" alt="1738992870921"></p><p>多次调试后，有了重大发现:</p><ol type="1"><li><p>index.js源代码中的loadSong()：<img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/爬虫/1738993446758.png" alt="1738993446758"></p><p>果然，前端这里直接拼接成了播放地址，那就对这个播放地址分析一下</p></li><li><p>对于list[0]这个比较特殊的</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token string">"https://tool.liumingye.cn/music/api/link?id=d3f636iePH3nJMVUD1wbsSTfgf-QwuOgyE9H3WcjYfUEDiX2YdQ&amp;quality=128&amp;_t=1738993370934&amp;token=20241016.e8917799e456aad902485db1aa7a7a83"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>网址中的 id -&gt; hash,那token是怎么获得的呢？还是使用的之前的加密算法，与search api不同的是，uri用的 data 是“{“id”:“d3f636iePH3nJMVUD1wbsSTfgf-QwuOgyE9H3WcjYfUEDiX2YdQ”,“quality”:“128”,”_t“:“1738992521608”}“</p></li><li><p>对于更普遍的 list[2]这种情况</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token string">"https://tool.liumingye.cn/music/api/link?id=m3f63OtUGNZoMDio1KvtWvzQ-xJiZdK54cSf02lE7dWSL0q_ZFeLha7Yo2R7Be58&amp;quality=128&amp;_t=1738993160654&amp;token=20241016.5940ea862f12cf113aa5faddc706d8fe"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>同样，这个id 就是 search api 返回结果里的 id, 使用相同的算法产生token，不同的就是 uri 那部分</p></li></ol><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/爬虫/1739511271821.png" alt="1739511271821"></p>]]></content>
      
      
      <categories>
          
          <category> 逆向 </category>
          
          <category> 爬虫 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>安卓项目进行模型推理</title>
      <link href="/2025/05/20/%E5%AE%89%E5%8D%93%E9%A1%B9%E7%9B%AE%E8%BF%9B%E8%A1%8C%E6%A8%A1%E5%9E%8B%E6%8E%A8%E7%90%86/"/>
      <url>/2025/05/20/%E5%AE%89%E5%8D%93%E9%A1%B9%E7%9B%AE%E8%BF%9B%E8%A1%8C%E6%A8%A1%E5%9E%8B%E6%8E%A8%E7%90%86/</url>
      
        <content type="html"><![CDATA[<h2 id="集成-tensorflow-lite">集成 TensorFlow Lite</h2><h3 id="配置环境">配置环境</h3><p>模块级 <em>build.gradle</em> 添加：</p><pre class="line-numbers language-groovy" data-language="groovy"><code class="language-groovy">android <span class="token punctuation">{</span>    defaultConfig <span class="token punctuation">{</span>        ndk <span class="token punctuation">{</span>            abiFilters <span class="token string">'armeabi-v7a'</span><span class="token punctuation">,</span> <span class="token string">'arm64-v8a'</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>     androidResources <span class="token punctuation">{</span>        noCompress <span class="token string">'tflite'</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>dependencies <span class="token punctuation">{</span>    <span class="token comment">// Tensorflow lite dependencies</span>    implementation <span class="token string">'org.tensorflow:tensorflow-lite-task-vision:0.4.0'</span>    <span class="token comment">// Import the GPU delegate plugin Library for GPU inference</span>    implementation <span class="token string">'org.tensorflow:tensorflow-lite-gpu:2.9.0'</span>    implementation <span class="token string">'org.tensorflow:tensorflow-lite-gpu-delegate-plugin:0.4.0'</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="编写程序验证">编写程序验证</h3><p>参考 <em>TensorFlow Lite</em> 官方例程：</p><p>[<a href="https://github.com/tensorflow/examples/blob/master/lite/examples/image_classification/android_java/README.md">examples/lite/examples/image_classification/android_java/README.md在 master ·TensorFlow/示例 —examples/lite/examples/image_classification/android_java/README.md atmaster ·tensorflow/examples</a>](https://github.com/tensorflow/examples/blob/master/lite/examples/image_classification/android_java/README.md)</p><p>测试模型采用官方的图像分类模型</p><p>官方例程是从手机摄像头中拿取的图片，为了测试方便，就直接测试<em>assets</em> 里的图片了</p><p>在 <em>algo</em> 文件夹下新建 <em>ImageClassifierHelper</em> 类：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/* * Copyright 2022 The TensorFlow Authors. All Rights Reserved. * * Licensed under the Apache License, Version 2.0 (the "License"); * you may not use this file except in compliance with the License. * You may obtain a copy of the License at * *             http://www.apache.org/licenses/LICENSE-2.0 * * Unless required by applicable law or agreed to in writing, software * distributed under the License is distributed on an "AS IS" BASIS, * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. * See the License for the specific language governing permissions and * limitations under the License. */</span><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>gxl_recognitionsystem<span class="token punctuation">.</span>algo</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>content<span class="token punctuation">.</span></span><span class="token class-name">Context</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span></span><span class="token class-name">Bitmap</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span></span><span class="token class-name">Canvas</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span></span><span class="token class-name">Paint</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span><span class="token class-name">SystemClock</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Log</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Arrays</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>tensorflow<span class="token punctuation">.</span>lite<span class="token punctuation">.</span>gpu<span class="token punctuation">.</span></span><span class="token class-name">CompatibilityList</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>tensorflow<span class="token punctuation">.</span>lite<span class="token punctuation">.</span>support<span class="token punctuation">.</span>image<span class="token punctuation">.</span></span><span class="token class-name">ImageProcessor</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>tensorflow<span class="token punctuation">.</span>lite<span class="token punctuation">.</span>support<span class="token punctuation">.</span>image<span class="token punctuation">.</span></span><span class="token class-name">TensorImage</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>tensorflow<span class="token punctuation">.</span>lite<span class="token punctuation">.</span>support<span class="token punctuation">.</span>image<span class="token punctuation">.</span>ops<span class="token punctuation">.</span></span><span class="token class-name">ResizeOp</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>tensorflow<span class="token punctuation">.</span>lite<span class="token punctuation">.</span>support<span class="token punctuation">.</span>image<span class="token punctuation">.</span>ops<span class="token punctuation">.</span></span><span class="token class-name">Rot90Op</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>tensorflow<span class="token punctuation">.</span>lite<span class="token punctuation">.</span>support<span class="token punctuation">.</span>metadata<span class="token punctuation">.</span>schema<span class="token punctuation">.</span></span><span class="token class-name">NormalizationOptions</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>tensorflow<span class="token punctuation">.</span>lite<span class="token punctuation">.</span>task<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">BaseOptions</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>tensorflow<span class="token punctuation">.</span>lite<span class="token punctuation">.</span>task<span class="token punctuation">.</span>vision<span class="token punctuation">.</span>classifier<span class="token punctuation">.</span></span><span class="token class-name">Classifications</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>tensorflow<span class="token punctuation">.</span>lite<span class="token punctuation">.</span>task<span class="token punctuation">.</span>vision<span class="token punctuation">.</span>classifier<span class="token punctuation">.</span></span><span class="token class-name">ImageClassifier</span></span><span class="token punctuation">;</span><span class="token comment">/** Helper class for wrapping Image Classification actions */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ImageClassifierHelper</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">TAG</span> <span class="token operator">=</span> <span class="token string">"ImageClassifierHelper"</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">DELEGATE_CPU</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">DELEGATE_GPU</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">DELEGATE_NNAPI</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MODEL_ISINSTRUMENT</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MODEL_ISINSTALL</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MODEL_MOBILENETV1</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">float</span> threshold<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> numThreads<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> maxResults<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> currentDelegate<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> currentModel<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Context</span> context<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ClassifierListener</span> imageClassifierListener<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token class-name">ImageClassifier</span> imageClassifier<span class="token punctuation">;</span>    <span class="token comment">/** Helper class for wrapping Image Classification actions */</span>    <span class="token keyword">public</span> <span class="token class-name">ImageClassifierHelper</span><span class="token punctuation">(</span><span class="token class-name">Float</span> threshold<span class="token punctuation">,</span>                                 <span class="token keyword">int</span> numThreads<span class="token punctuation">,</span>                                 <span class="token keyword">int</span> maxResults<span class="token punctuation">,</span>                                 <span class="token keyword">int</span> currentDelegate<span class="token punctuation">,</span>                                 <span class="token keyword">int</span> currentModel<span class="token punctuation">,</span>                                 <span class="token class-name">Context</span> context<span class="token punctuation">,</span>                                 <span class="token class-name">ClassifierListener</span> imageClassifierListener<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>threshold <span class="token operator">=</span> threshold<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>numThreads <span class="token operator">=</span> numThreads<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>maxResults <span class="token operator">=</span> maxResults<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>currentDelegate <span class="token operator">=</span> currentDelegate<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>currentModel <span class="token operator">=</span> currentModel<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>context <span class="token operator">=</span> context<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>imageClassifierListener <span class="token operator">=</span> imageClassifierListener<span class="token punctuation">;</span>        <span class="token function">setupImageClassifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ImageClassifierHelper</span> <span class="token function">create</span><span class="token punctuation">(</span>            <span class="token class-name">Context</span> context<span class="token punctuation">,</span>            <span class="token class-name">ClassifierListener</span> listener    <span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ImageClassifierHelper</span><span class="token punctuation">(</span>                <span class="token number">0.5f</span><span class="token punctuation">,</span>                <span class="token number">2</span><span class="token punctuation">,</span>                <span class="token number">3</span><span class="token punctuation">,</span>                <span class="token number">0</span><span class="token punctuation">,</span>                <span class="token number">2</span><span class="token punctuation">,</span>                context<span class="token punctuation">,</span>                listener        <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">float</span> <span class="token function">getThreshold</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> threshold<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setThreshold</span><span class="token punctuation">(</span><span class="token keyword">float</span> threshold<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>threshold <span class="token operator">=</span> threshold<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getNumThreads</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> numThreads<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setNumThreads</span><span class="token punctuation">(</span><span class="token keyword">int</span> numThreads<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>numThreads <span class="token operator">=</span> numThreads<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getMaxResults</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> maxResults<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setMaxResults</span><span class="token punctuation">(</span><span class="token keyword">int</span> maxResults<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>maxResults <span class="token operator">=</span> maxResults<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setCurrentDelegate</span><span class="token punctuation">(</span><span class="token keyword">int</span> currentDelegate<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>currentDelegate <span class="token operator">=</span> currentDelegate<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setCurrentModel</span><span class="token punctuation">(</span><span class="token keyword">int</span> currentModel<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>currentModel <span class="token operator">=</span> currentModel<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setupImageClassifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">ImageClassifier<span class="token punctuation">.</span>ImageClassifierOptions<span class="token punctuation">.</span>Builder</span> optionsBuilder <span class="token operator">=</span>                <span class="token class-name">ImageClassifier<span class="token punctuation">.</span>ImageClassifierOptions</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                        <span class="token punctuation">.</span><span class="token function">setScoreThreshold</span><span class="token punctuation">(</span>threshold<span class="token punctuation">)</span>                        <span class="token punctuation">.</span><span class="token function">setMaxResults</span><span class="token punctuation">(</span>maxResults<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">BaseOptions<span class="token punctuation">.</span>Builder</span> baseOptionsBuilder <span class="token operator">=</span>                <span class="token class-name">BaseOptions</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setNumThreads</span><span class="token punctuation">(</span>numThreads<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">switch</span> <span class="token punctuation">(</span>currentDelegate<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">case</span> <span class="token constant">DELEGATE_CPU</span><span class="token operator">:</span>                <span class="token comment">// Default</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> <span class="token constant">DELEGATE_GPU</span><span class="token operator">:</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CompatibilityList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isDelegateSupportedOnThisDevice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    baseOptionsBuilder<span class="token punctuation">.</span><span class="token function">useGpu</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                    imageClassifierListener<span class="token punctuation">.</span><span class="token function">onError</span><span class="token punctuation">(</span><span class="token string">"GPU is not supported on "</span>                            <span class="token operator">+</span> <span class="token string">"this device"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> <span class="token constant">DELEGATE_NNAPI</span><span class="token operator">:</span>                baseOptionsBuilder<span class="token punctuation">.</span><span class="token function">useNnapi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token class-name">String</span> modelName<span class="token punctuation">;</span>        <span class="token keyword">switch</span> <span class="token punctuation">(</span>currentModel<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">case</span> <span class="token constant">MODEL_ISINSTRUMENT</span><span class="token operator">:</span>                modelName <span class="token operator">=</span> <span class="token string">"is_instrument2.tflite"</span><span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> <span class="token constant">MODEL_ISINSTALL</span><span class="token operator">:</span>                modelName <span class="token operator">=</span> <span class="token string">"is_install2.tflite"</span><span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> <span class="token constant">MODEL_MOBILENETV1</span><span class="token operator">:</span>                modelName <span class="token operator">=</span> <span class="token string">"mobilenetv1.tflite"</span><span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">default</span><span class="token operator">:</span>                modelName <span class="token operator">=</span> <span class="token string">"is_instrument2.tflite"</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            imageClassifier <span class="token operator">=</span>                    <span class="token class-name">ImageClassifier</span><span class="token punctuation">.</span><span class="token function">createFromFileAndOptions</span><span class="token punctuation">(</span>                            context<span class="token punctuation">,</span>                            modelName<span class="token punctuation">,</span>                            optionsBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            imageClassifierListener<span class="token punctuation">.</span><span class="token function">onError</span><span class="token punctuation">(</span><span class="token string">"Image classifier failed to "</span>                    <span class="token operator">+</span> <span class="token string">"initialize. See error logs for details"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"TFLite failed to load model with error: "</span>                    <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">classify</span><span class="token punctuation">(</span><span class="token class-name">Bitmap</span> image<span class="token punctuation">,</span> <span class="token keyword">int</span> imageRotation<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>imageClassifier <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">setupImageClassifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment">// Inference time is the difference between the system time at the start</span>        <span class="token comment">// and finish of the process</span>        <span class="token keyword">long</span> inferenceTime <span class="token operator">=</span> <span class="token class-name">SystemClock</span><span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Bitmap</span> convertedBitmap <span class="token operator">=</span> <span class="token class-name">Bitmap</span><span class="token punctuation">.</span><span class="token function">createBitmap</span><span class="token punctuation">(</span>image<span class="token punctuation">.</span><span class="token function">getWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> image<span class="token punctuation">.</span><span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Bitmap<span class="token punctuation">.</span>Config</span><span class="token punctuation">.</span><span class="token constant">ARGB_8888</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Canvas</span> canvas <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Canvas</span><span class="token punctuation">(</span>convertedBitmap<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Paint</span> paint <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Paint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        canvas<span class="token punctuation">.</span><span class="token function">drawBitmap</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> paint<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// Create preprocessor for the image.</span>        <span class="token comment">// See https://www.tensorflow.org/lite/inference_with_metadata/</span>        <span class="token comment">//            lite_support#imageprocessor_architecture</span>        <span class="token class-name">ImageProcessor</span> imageProcessor <span class="token operator">=</span>                <span class="token keyword">new</span> <span class="token class-name">ImageProcessor<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//                        .add(new TransposeOp(new int[]{0, 2, 3, 1}))  // 将 [1,3,height,width] 转为 [1,height,width,3]</span>                        <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Rot90Op</span><span class="token punctuation">(</span><span class="token operator">-</span>imageRotation <span class="token operator">/</span> <span class="token number">90</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// Preprocess the image and convert it into a TensorImage for classification.</span>        <span class="token class-name">TensorImage</span> tensorImage <span class="token operator">=</span>                imageProcessor<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">TensorImage</span><span class="token punctuation">.</span><span class="token function">fromBitmap</span><span class="token punctuation">(</span>convertedBitmap<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// Classify the input image</span>        imageClassifier<span class="token punctuation">.</span><span class="token function">classify</span><span class="token punctuation">(</span>tensorImage<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Classifications</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> imageClassifier<span class="token punctuation">.</span><span class="token function">classify</span><span class="token punctuation">(</span>tensorImage<span class="token punctuation">)</span><span class="token punctuation">;</span>        inferenceTime <span class="token operator">=</span> <span class="token class-name">SystemClock</span><span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> inferenceTime<span class="token punctuation">;</span>        imageClassifierListener<span class="token punctuation">.</span><span class="token function">onResults</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> inferenceTime<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">clearImageClassifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        imageClassifier <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/** Listener for passing results back to calling class */</span>    <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ClassifierListener</span> <span class="token punctuation">{</span>        <span class="token keyword">void</span> <span class="token function">onError</span><span class="token punctuation">(</span><span class="token class-name">String</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">void</span> <span class="token function">onResults</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Classifications</span><span class="token punctuation">&gt;</span></span> results<span class="token punctuation">,</span> <span class="token keyword">long</span> inferenceTime<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在 <em>test</em> 类中加入：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> test <span class="token punctuation">{</span><span class="token comment">/**     * 从 assets 加载图片并进行图像分类     *     * @param context        上下文对象     * @param assetImageFile assets 下的图片文件名（例如 "testAlgo.jpg"）     * @param imageRotation  图片旋转角度（单位：度）     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">testModel</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">String</span> assetImageFile<span class="token punctuation">,</span> <span class="token keyword">int</span> imageRotation<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token comment">// 1. 准备图片</span>            <span class="token comment">// 从 assets 中加载图片</span>            <span class="token class-name">InputStream</span> is <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getAssets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span>assetImageFile<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">Bitmap</span> bitmap <span class="token operator">=</span> <span class="token class-name">BitmapFactory</span><span class="token punctuation">.</span><span class="token function">decodeStream</span><span class="token punctuation">(</span>is<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>bitmap <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string">"ImageLoad"</span><span class="token punctuation">,</span> <span class="token string">"图片加载失败. Please check if the file exists in assets and the file name is correct."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"ImageLoad"</span><span class="token punctuation">,</span> <span class="token string">"Bitmap 加载成功: "</span> <span class="token operator">+</span> bitmap<span class="token punctuation">.</span><span class="token function">getWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" x "</span> <span class="token operator">+</span> bitmap<span class="token punctuation">.</span><span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment">// 创建 ImageClassifierHelper</span>            <span class="token comment">/**             * 构造方法，用于初始化 ImageClassifierHelper 实例。             *             * @param threshold           分类结果的概率阈值（0.0f 到 1.0f）。             *                            例如，设置为 0.5f 表示只有概率大于 50% 的分类结果才会被返回。             * @param numThreads          运行分类任务的线程数，建议设置为 2 或 3。             *                            更多的线程可能提高性能，但也会增加资源消耗。             * @param maxResults          每次分类返回的最大结果数量，建议设置为 2 到 5。             *                            设置为 2 表示每次分类最多返回 2 个最可能的类别。             * @param currentDelegate     当前使用的委托类型，用于指定硬件加速方式等。             *                            例如，设置为 0 表示使用CPU，1：GPU。             * @param currentModel        当前使用的模型类型，用于指定不同的分类模型。             *                            0: is_instrument     1: is_install      2. mobilenetv1             * @param context             应用上下文，用于加载资源等。             * @param imageClassifierListener 分类结果监听器，用于接收分类结果或错误信息。             *                            通过实现 ClassifierListener 接口，可以在分类完成或出错时得到回调。             */</span>            <span class="token class-name">ImageClassifierHelper</span> classifierHelper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ImageClassifierHelper</span><span class="token punctuation">(</span>                    <span class="token number">0.5f</span><span class="token punctuation">,</span>                    <span class="token number">2</span><span class="token punctuation">,</span>                    <span class="token number">3</span><span class="token punctuation">,</span>                    <span class="token number">0</span><span class="token punctuation">,</span>                    <span class="token number">0</span><span class="token punctuation">,</span>                    context<span class="token punctuation">,</span>                    <span class="token keyword">new</span> <span class="token class-name">ImageClassifierHelper<span class="token punctuation">.</span>ClassifierListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token annotation punctuation">@Override</span>                        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onError</span><span class="token punctuation">(</span><span class="token class-name">String</span> error<span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"testModel"</span><span class="token punctuation">,</span> <span class="token string">"算法测试出错了"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//                        Toast.makeText(Administrators_MainActivity.this, error, Toast.LENGTH_SHORT).show());</span>                        <span class="token punctuation">}</span>                        <span class="token annotation punctuation">@Override</span>                        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onResults</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Classifications</span><span class="token punctuation">&gt;</span></span> results<span class="token punctuation">,</span> <span class="token keyword">long</span> inferenceTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"testModel"</span><span class="token punctuation">,</span> <span class="token string">"推理耗时: "</span> <span class="token operator">+</span> inferenceTime <span class="token operator">+</span> <span class="token string">" ms"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Classifications</span> classification <span class="token operator">:</span> results<span class="token punctuation">)</span> <span class="token punctuation">{</span>                                <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"testModel"</span><span class="token punctuation">,</span> <span class="token string">"推理结果: "</span> <span class="token operator">+</span> classification<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token punctuation">}</span>                        <span class="token punctuation">}</span>                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// 调用 classify 方法进行图像分类</span>            classifierHelper<span class="token punctuation">.</span><span class="token function">classify</span><span class="token punctuation">(</span>bitmap<span class="token punctuation">,</span> imageRotation<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在 <em>Adminstrators_MainActivity</em> 中加入：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Administrators_MainActivity</span> <span class="token keyword">extends</span> <span class="token class-name">Activity</span> <span class="token keyword">implements</span> <span class="token class-name">View<span class="token punctuation">.</span>OnClickListener</span> <span class="token punctuation">{</span><span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token class-name">Bundle</span> savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">// 测试算法模型</span>        <span class="token function">testModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">testModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> assetsImgList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        assetsImgList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"testAlgo.jpg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        assetsImgList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"test1.jpg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        assetsImgList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"test2.jpg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> img <span class="token operator">:</span> assetsImgList<span class="token punctuation">)</span> <span class="token punctuation">{</span>            testAlgo<span class="token punctuation">.</span><span class="token function">testModel</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> img<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>运行，测试结果如下：</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/Android/202503062116665.png" alt="image-20250306211621612"></p><p>第一个图片识别失败了，可能是由于图片分辨率太低，后面两张图片都识别出是杯子（cup）了</p><h2 id="自定义训练模型">自定义训练模型</h2><h3 id="技术路线">技术路线</h3><p>尝试使用 <em>tensorflow</em> 官方的 <em>TensorFlow Lite ModelMaker</em> 进行训练，这个会给模型自动添加元数据，使用训练完成的<em>tflite</em> 文件在安卓端进行推理测试：</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/Android/202503131232092.png" alt="image-20250313123209039"></p><p>测试成功！</p><h3 id="编写算法逻辑代码测试">编写算法逻辑代码测试</h3><p>在 <em>Adminstrators_MainActivity</em> 中加入：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Administrators_MainActivity</span> <span class="token keyword">extends</span> <span class="token class-name">Activity</span> <span class="token keyword">implements</span> <span class="token class-name">View<span class="token punctuation">.</span>OnClickListener</span> <span class="token punctuation">{</span><span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token class-name">Bundle</span> savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">// 测试算法判断逻辑 testAlgo</span>        <span class="token function">testAlgo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token comment">// 测试 算法判断逻辑 testAlgo</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">testAlgo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">String</span> assetFilePath <span class="token operator">=</span> <span class="token string">"normal.jpg"</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> tempDir <span class="token operator">=</span> <span class="token function">getCacheDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 复制到缓存区以获得绝对路径</span>        <span class="token class-name">String</span> tempFilePath <span class="token operator">=</span> tempDir <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> assetFilePath<span class="token punctuation">;</span>        <span class="token comment">// 将图片从 assets 目录复制到临时目录</span>        test<span class="token punctuation">.</span><span class="token function">copyFileFromAssets</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> assetFilePath<span class="token punctuation">,</span> tempFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> s <span class="token operator">=</span> test<span class="token punctuation">.</span><span class="token function">testAlgo</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> tempFilePath<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"testAlgo"</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>下面编写识别逻辑：</p><p><em>test</em> 类：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>gxl_recognitionsystem<span class="token punctuation">.</span>algo</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>content<span class="token punctuation">.</span></span><span class="token class-name">Context</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span></span><span class="token class-name">Bitmap</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span></span><span class="token class-name">BitmapFactory</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Log</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>chaquo<span class="token punctuation">.</span>python<span class="token punctuation">.</span></span><span class="token class-name">PyObject</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>chaquo<span class="token punctuation">.</span>python<span class="token punctuation">.</span></span><span class="token class-name">Python</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>tensorflow<span class="token punctuation">.</span>lite<span class="token punctuation">.</span>support<span class="token punctuation">.</span>label<span class="token punctuation">.</span></span><span class="token class-name">Category</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>tensorflow<span class="token punctuation">.</span>lite<span class="token punctuation">.</span>task<span class="token punctuation">.</span>vision<span class="token punctuation">.</span>classifier<span class="token punctuation">.</span></span><span class="token class-name">Classifications</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">File</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">FileOutputStream</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">InputStream</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">OutputStream</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Objects</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">CountDownLatch</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span></span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> test <span class="token punctuation">{</span><span class="token comment">// 设置置信度</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">float</span> <span class="token constant">CONFIDENCE_THRESHOLD</span> <span class="token operator">=</span> <span class="token number">0.5f</span><span class="token punctuation">;</span>        <span class="token comment">/**     * 方法描述：     * 1. 图片模糊检测：     *    - 调用 Python 模块中 detetion.py 的 is_image_blur 方法，对传入的图片文件进行模糊检测。     *    - 如果检测结果表明图片模糊，则方法直接返回错误提示，提示用户提供更清晰的图像，后续处理不再继续。     *     * 2. 图片加载：     *    - 使用 BitmapFactory 从指定的临时文件路径加载图片生成 Bitmap 对象。     *    - 如果图片加载失败（返回的 Bitmap 为 null），则记录错误日志，并返回错误提示信息。     *     * 3. 仪表设备检测（is_instrument 模型）：     *    - 创建 ImageClassifierHelper 实例，配置推理参数，包括置信度阈值、线程数、最大返回结果数量、委托类型、模型类型等。     *      此处模型类型指定为 0，表示使用 is_instrument.tflite 模型。     *    - 调用 classify 方法，对加载的 Bitmap 进行推理，同时传入图片的旋转角度（单位：度），以确保图片方向正确。     *    - 在推理回调的 onResults 方法中，通过遍历返回的分类结果，调用自定义方法 isInstrument 来判断是否检测到仪表设备，     *      并将判断结果赋值给 instrumentFlag 标志。     *    - 如果在推理过程中发生错误，则 onError 回调方法会记录相关错误日志。     *     * 4. 仪表设备判断：     *    - 如果 isInstrument 的判断结果为 false（即未检测到仪表设备），则方法直接返回错误提示“Error: 未检测到仪表设备”，     *      不进行后续的安装情况检测。     *     * 5. 安装情况检测（is_install 模型）：     *    - 如果仪表设备检测通过，则继续进行安装情况的检测。     *    - 创建另一个 ImageClassifierHelper 实例，配置参数时将模型类型设置为 1，表示使用 is_install.tflite 模型。     *    - 同样调用 classify 方法对图片进行推理，并在 onResults 回调中调用 isInstall 方法解析分类结果，     *      根据返回的判断值更新 installFlag 标志；同时记录推理耗时及分类结果日志。     *    - 推理出错时，onError 方法会记录错误日志。     *     * 6. 返回最终结果：     *    - 根据 installFlag 的判断值，返回最终结果字符串：     *         - 若 installFlag 为 true，返回 "判断结果: 安装"；     *         - 若 installFlag 为 false，返回 "Error: 未安装"。     *     * 7. 清理临时文件：     *    - 无论过程是否出现异常，最终都会在 finally 块中调用 deleteFile 方法删除临时图片文件，     *      以确保临时资源得到及时释放。     *     * 注意事项：     * - 本方法依赖 Python 模块（detection.py）、is_instrument.tflite 模型以及 is_install.tflite 模型，     *   所以需要确保这些资源存在且正确配置。     * - 分类推理操作可能为异步执行，需确保回调方法执行完成后再依据 flag 标志进行逻辑判断，     *   否则可能会出现由于异步调用导致的逻辑错误。     * - 日志记录信息有助于排查推理过程中的异常及错误，但需要注意日志中的信息描述应与实际操作保持一致。     *     * @param context       应用上下文，用于资源加载、模型初始化及其他相关操作。     * @param tempFilePath  临时存储图片的绝对路径，图片将用于后续的模糊检测和分类推理。     * @param imageRotation 图片的旋转角度（单位：度），用于在推理前对图片进行方向校正。     * @return 返回最终判断结果的字符串，包括错误提示或成功的检测结果信息。     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">testAlgo</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">String</span> tempFilePath<span class="token punctuation">,</span> <span class="token keyword">int</span> imageRotation<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">Python</span> py <span class="token operator">=</span> <span class="token class-name">Python</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Bitmap</span> bitmap <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token comment">// 1. 检测图片模糊</span>            <span class="token class-name">PyObject</span> isImageBlurObj <span class="token operator">=</span> py<span class="token punctuation">.</span><span class="token function">getModule</span><span class="token punctuation">(</span><span class="token string">"detetion"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">callAttr</span><span class="token punctuation">(</span><span class="token string">"is_image_blur"</span><span class="token punctuation">,</span> tempFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">Boolean</span> isBlur <span class="token operator">=</span> isImageBlurObj<span class="token punctuation">.</span><span class="token function">toJava</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>isBlur<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token string">"Error: 图片模糊，请提供更清晰的图像"</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment">// 加载图片</span>            bitmap <span class="token operator">=</span> <span class="token class-name">BitmapFactory</span><span class="token punctuation">.</span><span class="token function">decodeFile</span><span class="token punctuation">(</span>tempFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>bitmap <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string">"ImageLoad"</span><span class="token punctuation">,</span> <span class="token string">"图片加载失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token string">"Error: 图片加载失败"</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment">// 2. 进行 is_instrument 推理</span>            <span class="token keyword">final</span> <span class="token keyword">boolean</span><span class="token punctuation">[</span><span class="token punctuation">]</span> instrumentFlag <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">boolean</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token class-name">CountDownLatch</span> latch1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">/**             * 构造方法，用于初始化 ImageClassifierHelper 实例。             *             * @param threshold           分类结果的概率阈值（0.0f 到 1.0f）。             *                            例如，设置为 0.5f 表示只有概率大于 50% 的分类结果才会被返回。             * @param numThreads          运行分类任务的线程数，建议设置为 2 或 3。             *                            更多的线程可能提高性能，但也会增加资源消耗。             * @param maxResults          每次分类返回的最大结果数量，建议设置为 2 到 5。             *                            设置为 2 表示每次分类最多返回 2 个最可能的类别。             * @param currentDelegate     当前使用的委托类型，用于指定硬件加速方式等。             *                            例如，设置为 0 表示使用CPU，1：GPU。             * @param currentModel        当前使用的模型类型，用于指定不同的分类模型。             *                            0: is_instrument     1: is_install      2. mobilenetv1             * @param context             应用上下文，用于加载资源等。             * @param imageClassifierListener 分类结果监听器，用于接收分类结果或错误信息。             *                            通过实现 ClassifierListener 接口，可以在分类完成或出错时得到回调。             */</span>            <span class="token class-name">ImageClassifierHelper</span> classifierInstrument <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ImageClassifierHelper</span><span class="token punctuation">(</span><span class="token constant">CONFIDENCE_THRESHOLD</span><span class="token punctuation">,</span>                    <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> context<span class="token punctuation">,</span>                    <span class="token keyword">new</span> <span class="token class-name">ImageClassifierHelper<span class="token punctuation">.</span>ClassifierListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token annotation punctuation">@Override</span>                        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onError</span><span class="token punctuation">(</span><span class="token class-name">String</span> error<span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string">"ClassifierHelper"</span><span class="token punctuation">,</span> <span class="token string">"is_instrument error: "</span> <span class="token operator">+</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>                            latch1<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 释放等待</span>                        <span class="token punctuation">}</span>                        <span class="token annotation punctuation">@Override</span>                        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onResults</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Classifications</span><span class="token punctuation">&gt;</span></span> results<span class="token punctuation">,</span> <span class="token keyword">long</span> inferenceTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"testModel"</span><span class="token punctuation">,</span> <span class="token string">"is_instrument 推理耗时: "</span> <span class="token operator">+</span> inferenceTime <span class="token operator">+</span> <span class="token string">" ms"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                            instrumentFlag<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">isInstrument</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">;</span>                            latch1<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 释放等待</span>                        <span class="token punctuation">}</span>                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            classifierInstrument<span class="token punctuation">.</span><span class="token function">classify</span><span class="token punctuation">(</span>bitmap<span class="token punctuation">,</span> imageRotation<span class="token punctuation">)</span><span class="token punctuation">;</span>            latch1<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 等待推理完成</span>            classifierInstrument<span class="token punctuation">.</span><span class="token function">clearImageClassifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>instrumentFlag<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token string">"Error: 未检测到仪表设备"</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment">// 3. 进行 is_install 推理</span>            <span class="token keyword">final</span> <span class="token keyword">boolean</span><span class="token punctuation">[</span><span class="token punctuation">]</span> installFlag <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">boolean</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token class-name">CountDownLatch</span> latch2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">ImageClassifierHelper</span> classifierInstall <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ImageClassifierHelper</span><span class="token punctuation">(</span><span class="token constant">CONFIDENCE_THRESHOLD</span><span class="token punctuation">,</span>                    <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> context<span class="token punctuation">,</span>                    <span class="token keyword">new</span> <span class="token class-name">ImageClassifierHelper<span class="token punctuation">.</span>ClassifierListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token annotation punctuation">@Override</span>                        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onError</span><span class="token punctuation">(</span><span class="token class-name">String</span> error<span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string">"ClassifierHelper"</span><span class="token punctuation">,</span> <span class="token string">"is_install error: "</span> <span class="token operator">+</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>                            latch2<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 释放等待</span>                        <span class="token punctuation">}</span>                        <span class="token annotation punctuation">@Override</span>                        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onResults</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Classifications</span><span class="token punctuation">&gt;</span></span> results<span class="token punctuation">,</span> <span class="token keyword">long</span> inferenceTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"testModel"</span><span class="token punctuation">,</span> <span class="token string">"is_install 推理耗时: "</span> <span class="token operator">+</span> inferenceTime <span class="token operator">+</span> <span class="token string">" ms"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                            installFlag<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">isInstall</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">;</span>                            latch2<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 释放等待</span>                        <span class="token punctuation">}</span>                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            classifierInstall<span class="token punctuation">.</span><span class="token function">classify</span><span class="token punctuation">(</span>bitmap<span class="token punctuation">,</span> imageRotation<span class="token punctuation">)</span><span class="token punctuation">;</span>            latch2<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 等待推理完成</span>            classifierInstall<span class="token punctuation">.</span><span class="token function">clearImageClassifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> installFlag<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">?</span> <span class="token string">"判断结果: 安装"</span> <span class="token operator">:</span> <span class="token string">"Error: 未安装"</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string">"testAlgo"</span><span class="token punctuation">,</span> <span class="token string">"Exception occurred"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token string">"Error: "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>bitmap <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>bitmap<span class="token punctuation">.</span><span class="token function">isRecycled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                bitmap<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token function">deleteFile</span><span class="token punctuation">(</span>tempFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 是不是仪表的判断逻辑，根据模型推理的结果判断     * 判断仪表设备：取第一个分类结果的第一个类别，     * 双条件判断：类别索引必须为1，并且置信度不低于阈值。     *     * @param results 推理返回的分类结果列表     * @return true 表示判断为仪表设备；false 表示不是     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">isInstrument</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Classifications</span><span class="token punctuation">&gt;</span></span> results<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>results <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> results<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Category</span><span class="token punctuation">&gt;</span></span> categories <span class="token operator">=</span> results<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCategories</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>categories <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> categories<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token class-name">Category</span> topCategory <span class="token operator">=</span> categories<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> top1Index <span class="token operator">=</span> topCategory<span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">float</span> top1Conf <span class="token operator">=</span> topCategory<span class="token punctuation">.</span><span class="token function">getScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> categoryName <span class="token operator">=</span> topCategory<span class="token punctuation">.</span><span class="token function">getLabel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"ClassifierHelper"</span><span class="token punctuation">,</span> <span class="token string">"[Debug] 模型类别名称: "</span> <span class="token operator">+</span> categoryName<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"ClassifierHelper"</span><span class="token punctuation">,</span> <span class="token string">"[Debug] 预测索引:"</span> <span class="token operator">+</span> top1Index <span class="token operator">+</span> <span class="token string">" 置信度:"</span> <span class="token operator">+</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%.2f"</span><span class="token punctuation">,</span> top1Conf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//        return (top1Index == 1) &amp;&amp; (top1Conf &gt;= CONFIDENCE_THRESHOLD);</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span>top1Conf <span class="token operator">&gt;=</span> <span class="token constant">CONFIDENCE_THRESHOLD</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>categoryName<span class="token punctuation">,</span> <span class="token string">"yibiao"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 是否安装的判断逻辑     * 判断安装情况：逻辑与 isInstrument 相同。     *     * @param results 推理返回的分类结果列表     * @return true 表示判断为“安装”；false 表示未安装     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">isInstall</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Classifications</span><span class="token punctuation">&gt;</span></span> results<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>results <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> results<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Category</span><span class="token punctuation">&gt;</span></span> categories <span class="token operator">=</span> results<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCategories</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>categories <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> categories<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token class-name">Category</span> topCategory <span class="token operator">=</span> categories<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> top1Index <span class="token operator">=</span> topCategory<span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">float</span> top1Conf <span class="token operator">=</span> topCategory<span class="token punctuation">.</span><span class="token function">getScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> categoryName <span class="token operator">=</span> topCategory<span class="token punctuation">.</span><span class="token function">getLabel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"ClassifierHelper"</span><span class="token punctuation">,</span> <span class="token string">"[Debug] 模型类别名称: "</span> <span class="token operator">+</span> categoryName<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"ClassifierHelper"</span><span class="token punctuation">,</span> <span class="token string">"[Debug] 预测索引:"</span> <span class="token operator">+</span> top1Index <span class="token operator">+</span> <span class="token string">" 置信度:"</span> <span class="token operator">+</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%.2f"</span><span class="token punctuation">,</span> top1Conf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//        return (top1Index == 1) &amp;&amp; (top1Conf &gt;= CONFIDENCE_THRESHOLD);</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span>top1Conf <span class="token operator">&gt;=</span> <span class="token constant">CONFIDENCE_THRESHOLD</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>categoryName<span class="token punctuation">,</span> <span class="token string">"installed"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 将 assets 路径下的图片复制到缓存区。 后续读取缓存区的绝对路径，opencv 需要读取图片的绝对路径。     * @param context         上下文对象     * @param assetFilePath  assets 下的图片文件名（例如 "testAlgo.jpg"）     * @param tempFilePath   缓存图片路径     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">copyFileFromAssets</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">String</span> assetFilePath<span class="token punctuation">,</span> <span class="token class-name">String</span> tempFilePath<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getAssets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span>assetFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token class-name">OutputStream</span> outputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span>tempFilePath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token keyword">int</span> length<span class="token punctuation">;</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>length <span class="token operator">=</span> inputStream<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                outputStream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            outputStream<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string">"FileUtils"</span><span class="token punctuation">,</span> <span class="token string">"Error copying file from assets: "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 删除缓存区的图片     *     * @param filePath 图片的路径     *     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">deleteFile</span><span class="token punctuation">(</span><span class="token class-name">String</span> filePath<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">// 创建 File 对象</span>        <span class="token class-name">File</span> file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment">// 删除文件</span>            <span class="token keyword">boolean</span> isDeleted <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>isDeleted<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment">// 删除成功</span>                <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"FileDeletion"</span><span class="token punctuation">,</span> <span class="token string">"文件删除成功: "</span> <span class="token operator">+</span> filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token comment">// 删除失败</span>                <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string">"FileDeletion"</span><span class="token punctuation">,</span> <span class="token string">"文件删除失败: "</span> <span class="token operator">+</span> filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token comment">// 文件不存在</span>            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"FileDeletion"</span><span class="token punctuation">,</span> <span class="token string">"文件不存在: "</span> <span class="token operator">+</span> filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><em>tensorflow</em> 提供的 <em>Category</em>类，后续需要拿哪些数据可以查看 <em>get</em> 方法:</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@UsedByReflection</span><span class="token punctuation">(</span><span class="token string">"TFLiteSupport/Task"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Category</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">DEFAULT_INDEX</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">float</span> <span class="token constant">TOLERANCE</span> <span class="token operator">=</span> <span class="token number">1.0E-6F</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> index<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> label<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> displayName<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">float</span> score<span class="token punctuation">;</span>    <span class="token annotation punctuation">@UsedByReflection</span><span class="token punctuation">(</span><span class="token string">"TFLiteSupport/Task"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Category</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">String</span> label<span class="token punctuation">,</span> <span class="token class-name">String</span> displayName<span class="token punctuation">,</span> <span class="token keyword">float</span> score<span class="token punctuation">,</span> <span class="token keyword">int</span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Category</span><span class="token punctuation">(</span>label<span class="token punctuation">,</span> displayName<span class="token punctuation">,</span> score<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@UsedByReflection</span><span class="token punctuation">(</span><span class="token string">"TFLiteSupport/Task"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Category</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">String</span> label<span class="token punctuation">,</span> <span class="token class-name">String</span> displayName<span class="token punctuation">,</span> <span class="token keyword">float</span> score<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Category</span><span class="token punctuation">(</span>label<span class="token punctuation">,</span> displayName<span class="token punctuation">,</span> score<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@UsedByReflection</span><span class="token punctuation">(</span><span class="token string">"TFLiteSupport/Task"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token class-name">Category</span><span class="token punctuation">(</span><span class="token class-name">String</span> label<span class="token punctuation">,</span> <span class="token keyword">float</span> score<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">(</span>label<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> score<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token class-name">Category</span><span class="token punctuation">(</span><span class="token class-name">String</span> label<span class="token punctuation">,</span> <span class="token class-name">String</span> displayName<span class="token punctuation">,</span> <span class="token keyword">float</span> score<span class="token punctuation">,</span> <span class="token keyword">int</span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>label <span class="token operator">=</span> label<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>displayName <span class="token operator">=</span> displayName<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>score <span class="token operator">=</span> score<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>index <span class="token operator">=</span> index<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getLabel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>label<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getDisplayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>displayName<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">float</span> <span class="token function">getScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>score<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>index<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>o <span class="token keyword">instanceof</span> <span class="token class-name">Category</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token class-name">Category</span> other <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Category</span><span class="token punctuation">)</span>o<span class="token punctuation">;</span>            <span class="token keyword">return</span> other<span class="token punctuation">.</span><span class="token function">getLabel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>label<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> other<span class="token punctuation">.</span><span class="token function">getDisplayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>displayName<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span><span class="token function">getScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>score<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1.0E-6F</span> <span class="token operator">&amp;&amp;</span> other<span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>index<span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>label<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>displayName<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>score<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>index<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token string">"&lt;Category \""</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>label <span class="token operator">+</span> <span class="token string">"\" (displayName="</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>displayName <span class="token operator">+</span> <span class="token string">" score="</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>score <span class="token operator">+</span> <span class="token string">" index="</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>index <span class="token operator">+</span> <span class="token string">")&gt;"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="测试结果">测试结果</h3><blockquote><p>使用 模糊图片：vague.jpg</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 测试 算法判断逻辑 testAlgo</span> <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">testAlgo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token class-name">String</span> assetFilePath <span class="token operator">=</span> <span class="token string">"uninstall.jpg"</span><span class="token punctuation">;</span>     <span class="token class-name">String</span> tempDir <span class="token operator">=</span> <span class="token function">getCacheDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 复制到缓存区以获得绝对路径</span>     <span class="token class-name">String</span> tempFilePath <span class="token operator">=</span> tempDir <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> assetFilePath<span class="token punctuation">;</span>     <span class="token comment">// 将图片从 assets 目录复制到临时目录</span>     test<span class="token punctuation">.</span><span class="token function">copyFileFromAssets</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> assetFilePath<span class="token punctuation">,</span> tempFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token class-name">String</span> s <span class="token operator">=</span> test<span class="token punctuation">.</span><span class="token function">testAlgo</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> tempFilePath<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"testAlgo"</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/Android/202503131409708.png" alt="image-20250313140926419"></p></blockquote><blockquote><p>使用 不是仪表的图片：mouse.jpg</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 测试 算法判断逻辑 testAlgo</span><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">testAlgo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token class-name">String</span> assetFilePath <span class="token operator">=</span> <span class="token string">"mouse.jpg"</span><span class="token punctuation">;</span>    <span class="token class-name">String</span> tempDir <span class="token operator">=</span> <span class="token function">getCacheDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 复制到缓存区以获得绝对路径</span>    <span class="token class-name">String</span> tempFilePath <span class="token operator">=</span> tempDir <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> assetFilePath<span class="token punctuation">;</span>    <span class="token comment">// 将图片从 assets 目录复制到临时目录</span>    test<span class="token punctuation">.</span><span class="token function">copyFileFromAssets</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> assetFilePath<span class="token punctuation">,</span> tempFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">String</span> s <span class="token operator">=</span> test<span class="token punctuation">.</span><span class="token function">testAlgo</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> tempFilePath<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"testAlgo"</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/Android/202503131412572.png" alt="image-20250313141212485"></p></blockquote><blockquote><p>使用 仪表未安装的图片：uninstall.jpg</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 测试 算法判断逻辑 testAlgo</span><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">testAlgo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token class-name">String</span> assetFilePath <span class="token operator">=</span> <span class="token string">"uninstall.jpg"</span><span class="token punctuation">;</span>    <span class="token class-name">String</span> tempDir <span class="token operator">=</span> <span class="token function">getCacheDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 复制到缓存区以获得绝对路径</span>    <span class="token class-name">String</span> tempFilePath <span class="token operator">=</span> tempDir <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> assetFilePath<span class="token punctuation">;</span>    <span class="token comment">// 将图片从 assets 目录复制到临时目录</span>    test<span class="token punctuation">.</span><span class="token function">copyFileFromAssets</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> assetFilePath<span class="token punctuation">,</span> tempFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">String</span> s <span class="token operator">=</span> test<span class="token punctuation">.</span><span class="token function">testAlgo</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> tempFilePath<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"testAlgo"</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/Android/202503131413469.png" alt="image-20250313141343393"></p></blockquote><blockquote><p>使用 正常安装的仪表图片：normal.jpg</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 测试 算法判断逻辑 testAlgo</span><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">testAlgo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token class-name">String</span> assetFilePath <span class="token operator">=</span> <span class="token string">"normal.jpg"</span><span class="token punctuation">;</span>    <span class="token class-name">String</span> tempDir <span class="token operator">=</span> <span class="token function">getCacheDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 复制到缓存区以获得绝对路径</span>    <span class="token class-name">String</span> tempFilePath <span class="token operator">=</span> tempDir <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> assetFilePath<span class="token punctuation">;</span>    <span class="token comment">// 将图片从 assets 目录复制到临时目录</span>    test<span class="token punctuation">.</span><span class="token function">copyFileFromAssets</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> assetFilePath<span class="token punctuation">,</span> tempFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">String</span> s <span class="token operator">=</span> test<span class="token punctuation">.</span><span class="token function">testAlgo</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> tempFilePath<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"testAlgo"</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/Android/202503131414341.png" alt="image-20250313141459263"></p></blockquote><h3 id="失败尝试">失败尝试</h3><ul><li><blockquote><p>算法使用 <em>yolov8n-cls</em> 预训练模型再使用数据集进行训练得到<em>.pt</em> 模型文件，由于是基于 <em>pytorch</em>训练的，模型的输入和神经网络的一些内部结构与 <em>tensorflow</em>不兼容，在 <em>github</em> 上找到了 <em>pytorch</em>官方安卓项目例程：</p><p><a href="https://github.com/pytorch/android-demo-app">https://github.com/pytorch/android-demo-app</a></p><p>集成到此安卓项目后，官方提供的 <em>model.pt</em>模型文件可以跑通，但是通过 <em>yolo</em> 训练得到的模型文件会报错：</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/Android/202503131230661.png" alt="image-20250313123051589"></p><p>可能是版本不兼容的问题，也有可能与 <em>yolo</em>模型内部的结构有关。</p></blockquote></li><li><blockquote><p>算法在预训练模型 <em>mobilenet</em> 的基础上采用 <em>tensorflow</em>进行训练，转换成 <em>tflite</em> 模型文件后，出现错误：</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/Android/202503131231057.png" alt="image-20250313123135002"></p><p>原因是找不到模型的 <strong>元数据</strong> ，尝试 <em>tensorflow</em>官方提供的添加元数据的脚本文件：</p><p><a href="https://github.com/tensorflow/examples/tree/master/lite/examples/image_classification/metadata">https://github.com/tensorflow/examples/tree/master/lite/examples/image_classification/metadata</a></p><p>会出现很多的 <em>python</em> 环境包冲突问题</p></blockquote></li></ul>]]></content>
      
      
      <categories>
          
          <category> 环境搭建 </category>
          
          <category> 视觉 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> OpenCV </tag>
            
            <tag> Java </tag>
            
            <tag> Python </tag>
            
            <tag> TFlite </tag>
            
            <tag> Pytorch </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>安卓项目集成python环境</title>
      <link href="/2025/05/19/%E5%AE%89%E5%8D%93%E9%A1%B9%E7%9B%AE%E9%9B%86%E6%88%90python%E7%8E%AF%E5%A2%83/"/>
      <url>/2025/05/19/%E5%AE%89%E5%8D%93%E9%A1%B9%E7%9B%AE%E9%9B%86%E6%88%90python%E7%8E%AF%E5%A2%83/</url>
      
        <content type="html"><![CDATA[<h2 id="集成-chaquopy">集成 Chaquopy</h2><h3 id="配置环境">配置环境</h3><p>在顶级 <em>build.gradle</em> 中加入：</p><pre class="line-numbers language-groovy" data-language="groovy"><code class="language-groovy">plugins <span class="token punctuation">{</span>       id <span class="token interpolation-string"><span class="token string">"com.chaquo.python"</span></span> version <span class="token interpolation-string"><span class="token string">"15.0.1"</span></span> apply <span class="token boolean">false</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>在模块级 <em>build.gradle</em> 中加入：</p><pre class="line-numbers language-groovy" data-language="groovy"><code class="language-groovy">plugins <span class="token punctuation">{</span>    id <span class="token interpolation-string"><span class="token string">"com.chaquo.python"</span></span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-groovy" data-language="groovy"><code class="language-groovy">android <span class="token punctuation">{</span>    defaultConfig <span class="token punctuation">{</span>         ndk <span class="token punctuation">{</span>            abiFilters <span class="token interpolation-string"><span class="token string">"arm64-v8a"</span></span><span class="token punctuation">,</span> <span class="token interpolation-string"><span class="token string">"x86_64"</span></span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-groovy" data-language="groovy"><code class="language-groovy">chaquopy <span class="token punctuation">{</span>    defaultConfig <span class="token punctuation">{</span>    <span class="token comment">// 替换路径 我使用的是 python 3.8.19</span>        <span class="token function">buildPython</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">"D:\\Users\\L\\anaconda3\\envs\\yolo\\python.exe"</span></span><span class="token punctuation">)</span>        version <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">"3.8"</span></span>        pip <span class="token punctuation">{</span>            <span class="token function">options</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">"--index-url"</span></span><span class="token punctuation">,</span> <span class="token interpolation-string"><span class="token string">"https://chaquo.com/pypi-13.1/"</span></span><span class="token punctuation">)</span>            <span class="token comment">// A requirement specifier, with or without a version number:</span>            <span class="token function">install</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">"numpy"</span></span><span class="token punctuation">)</span>            <span class="token function">install</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">"opencv-python"</span></span><span class="token punctuation">)</span>            <span class="token comment">// "-r"` followed by a requirements filename, relative to the project directory:</span>            <span class="token comment">//  install("-r", "requirements.txt")</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    productFlavors <span class="token punctuation">{</span> <span class="token punctuation">}</span>    sourceSets <span class="token punctuation">{</span>        <span class="token function">getByName</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">"main"</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">srcDir</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">"src/main/python"</span></span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>版本兼容表：</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/Android/202503062114297.png" alt="image-20250306211455240"></p><p>[<a href="https://chaquo.com/chaquopy/doc/current/versions.html">Versionsummary -Chaquopy</a>](https://chaquo.com/chaquopy/doc/current/versions.html)</p><p>包仓库：</p><p><a href="https://chaquo.com/pypi-13.1/">https://chaquo.com/pypi-13.1/</a></p><p>全局使用 <em>python</em> ，在 <em>AndroidManifest.xml</em> 中的<em>&lt;application…/&gt;</em> 添加以下属性:</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup">android:name="com.chaquo.python.android.PyApplication"<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>官方文档：[<a href="https://chaquo.com/chaquopy/doc/15.0/">Chaquopy15.0</a>](https://chaquo.com/chaquopy/doc/15.0/)</p><h3 id="编写程序验证">编写程序验证</h3><p>在 <em>src/main/</em> 新建 <em>pyhton</em> 文件夹存放 <em>python</em>文件 <em>algoTest.py</em></p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> cv2<span class="token keyword">def</span> <span class="token function">algoFunc</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> imgAddressList<span class="token punctuation">)</span><span class="token punctuation">:</span>    res <span class="token operator">=</span> <span class="token string">"error"</span>    <span class="token keyword">if</span> code <span class="token operator">==</span> <span class="token string">"1"</span><span class="token punctuation">:</span>        res <span class="token operator">=</span> algo1<span class="token punctuation">(</span>imgAddressList<span class="token punctuation">)</span>    <span class="token keyword">return</span> res<span class="token keyword">def</span> <span class="token function">algo1</span><span class="token punctuation">(</span>imgAddressList<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># OpenCV 测试程序</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        <span class="token comment"># 遍历Java的ArrayList对象</span>        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>imgAddressList<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            img_path <span class="token operator">=</span> imgAddressList<span class="token punctuation">.</span>get<span class="token punctuation">(</span>i<span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>img_path<span class="token punctuation">)</span>            img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>img_path<span class="token punctuation">)</span>            <span class="token keyword">if</span> img <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>                <span class="token comment"># 如果图像加载成功，返回成功信息</span>                <span class="token keyword">return</span> <span class="token string">"成功加载图像："</span> <span class="token operator">+</span> img_path <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span>  cv2<span class="token punctuation">.</span>__version__            <span class="token keyword">else</span><span class="token punctuation">:</span>                <span class="token keyword">return</span> <span class="token string">"图像加载失败："</span> <span class="token operator">+</span> img_path <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> cv2<span class="token punctuation">.</span>__version__    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string">"OpenCV 测试失败："</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>新建 <em>algo</em> 文件夹，新建 <em>test</em> 类</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>gxl_recognitionsystem<span class="token punctuation">.</span>algo</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>content<span class="token punctuation">.</span></span><span class="token class-name">Context</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span></span><span class="token class-name">Bitmap</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span></span><span class="token class-name">BitmapFactory</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Log</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>chaquo<span class="token punctuation">.</span>python<span class="token punctuation">.</span></span><span class="token class-name">PyObject</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>chaquo<span class="token punctuation">.</span>python<span class="token punctuation">.</span></span><span class="token class-name">Python</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>tensorflow<span class="token punctuation">.</span>lite<span class="token punctuation">.</span>task<span class="token punctuation">.</span>vision<span class="token punctuation">.</span>classifier<span class="token punctuation">.</span></span><span class="token class-name">Classifications</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">InputStream</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> test <span class="token punctuation">{</span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">testPython</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">String</span> code<span class="token punctuation">,</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> imgAddressArrayList<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">Python</span> py <span class="token operator">=</span> <span class="token class-name">Python</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token comment">// 转换数据类型，将路径传递给 Python</span>            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PyObject</span><span class="token punctuation">&gt;</span></span> imgAddressList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PyObject</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> imgPath <span class="token operator">:</span> imgAddressArrayList<span class="token punctuation">)</span> <span class="token punctuation">{</span>                imgAddressList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">PyObject</span><span class="token punctuation">.</span><span class="token function">fromJava</span><span class="token punctuation">(</span>imgPath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token class-name">PyObject</span> result <span class="token operator">=</span> py<span class="token punctuation">.</span><span class="token function">getModule</span><span class="token punctuation">(</span><span class="token string">"algoTest"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">callAttr</span><span class="token punctuation">(</span><span class="token string">"algoFunc"</span><span class="token punctuation">,</span> code<span class="token punctuation">,</span> imgAddressList<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// 将 Python 返回值转换为 Java 字符串</span>            <span class="token class-name">String</span> response <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">toJava</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"PythonCall"</span><span class="token punctuation">,</span> <span class="token string">"Response from Python: "</span> <span class="token operator">+</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string">"PythonCall"</span><span class="token punctuation">,</span> <span class="token string">"Error accessing assets: "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 将 assets 路径下的图片复制到缓存区。 后续读取缓存区的绝对路径，opencv 需要读取图片的绝对路径。     * @param context         上下文对象     * @param assetFilePath  assets 下的图片文件名（例如 "testAlgo.jpg"）     * @param tempFilePath   缓存图片路径     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">copyFileFromAssets</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">String</span> assetFilePath<span class="token punctuation">,</span> <span class="token class-name">String</span> tempFilePath<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getAssets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span>assetFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token class-name">OutputStream</span> outputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span>tempFilePath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token keyword">int</span> length<span class="token punctuation">;</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>length <span class="token operator">=</span> inputStream<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                outputStream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            outputStream<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string">"FileUtils"</span><span class="token punctuation">,</span> <span class="token string">"Error copying file from assets: "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><!--因为opencv需要使用绝对路径读取图片，所以将assets里的图片复制到缓存区，再用opencv读取缓存区图片路径--><p>在 <em>Adminstrators_MainActivity</em> 中加入：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>chaquo<span class="token punctuation">.</span>python<span class="token punctuation">.</span>android<span class="token punctuation">.</span></span><span class="token class-name">AndroidPlatform</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>chaquo<span class="token punctuation">.</span>python<span class="token punctuation">.</span></span><span class="token class-name">Python</span></span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Administrators_MainActivity</span> <span class="token keyword">extends</span> <span class="token class-name">Activity</span> <span class="token keyword">implements</span> <span class="token class-name">View<span class="token punctuation">.</span>OnClickListener</span> <span class="token punctuation">{</span><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token class-name">Bundle</span> savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 初始化Python环境</span>    <span class="token function">initPython</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">testPythonCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment">// 初始化Python环境</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initPython</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token class-name">Python</span><span class="token punctuation">.</span><span class="token function">isStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token class-name">Python</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AndroidPlatform</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment">// 调用python代码</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">testPythonCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> assetsImgList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> tempDirImgList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        assetsImgList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"testAlgo.jpg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> tempDir <span class="token operator">=</span> <span class="token function">getCacheDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 复制到缓存区以获得绝对路径</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> assetFilePath  <span class="token operator">:</span> assetsImgList<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token class-name">String</span> tempFilePath <span class="token operator">=</span> tempDir <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> assetFilePath<span class="token punctuation">;</span>            tempDirImgList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>tempFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// 将图片从 assets 目录复制到临时目录</span>            <span class="token class-name">FileUtils</span><span class="token punctuation">.</span><span class="token function">copyFileFromAssets</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> assetFilePath<span class="token punctuation">,</span> tempFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        testAlgo<span class="token punctuation">.</span><span class="token function">testPython</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">,</span> tempDirImgList<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>运行，测试结果如下：</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/Android/202503062115064.png" alt="image-20250306211537016"></p><p>/data/user/0/com.gxl_recognitionsystem/cache/testAlgo.jpg是图片在安卓手机上的绝对路径</p><p>4.5.1 是 <em>opencv</em> 的版本号</p>]]></content>
      
      
      <categories>
          
          <category> 环境搭建 </category>
          
          <category> 视觉 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> OpenCV </tag>
            
            <tag> Java </tag>
            
            <tag> Python </tag>
            
            <tag> Chaquopy </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>安装cuda和pytorch</title>
      <link href="/2025/05/19/%E5%AE%89%E8%A3%85cuda%E5%92%8Cpytorch/"/>
      <url>/2025/05/19/%E5%AE%89%E8%A3%85cuda%E5%92%8Cpytorch/</url>
      
        <content type="html"><![CDATA[<h2 id="查看显卡驱动版本">查看显卡驱动版本</h2><p>查看cuda版本支持：</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/linux_camera/202503111803366.png" alt="image-20250311180335312"></p><p>终端输入：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">nvidia-smi<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>最高支持12.7</p><p>下载CUDA Toolkit 12.6 Update 3</p><h2 id="创建conda环境">创建conda环境</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">conda create <span class="token parameter variable">-n</span> env-name <span class="token assign-left variable">python</span><span class="token operator">=</span><span class="token number">3.11</span>.5<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="下载pytorch">下载pytorch</h2><p>[<a href="https://pytorch.org/get-started/locally/">Start Locally |PyTorch</a>](https://pytorch.org/get-started/locally/)</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/linux_camera/202503111854319.png" alt="image-20250311185414247"></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pip3 <span class="token function">install</span> torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu126<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/linux_camera/202503111900945.png" alt="image-20250311190011897"></p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/linux_camera/202503111859376.png" alt="image-20250311185958340"></p><h2 id="卸载pytorch">卸载pytorch</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pip uninstall torch torchvision torchaudio<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 环境搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Pytorch </tag>
            
            <tag> Cuda </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vscode与cmake</title>
      <link href="/2025/05/19/vscode%E4%B8%8Ecmake/"/>
      <url>/2025/05/19/vscode%E4%B8%8Ecmake/</url>
      
        <content type="html"><![CDATA[<h2 id="vscode-使用-cmake-构建工程">vscode 使用 cmake 构建工程</h2><h3 id="多文件编译">多文件编译：</h3><ul><li><p>指定cmake 编译器 g++ ;</p></li><li><ul><li>CMakeLists.txt文件中</li><li><ul><li>setexcable</li><li>add_definitions(“-Wall -g”)</li></ul></li></ul></li><li><p>在build 文件夹下执行<code>cmake -G "MinGW Makefiles" .. </code>，会在build文件夹下生成makefile</p></li><li><p>windows 下的 make： mingw32-make.exe</p></li></ul><blockquote><p>更改后若要调试，先用cmake 和mingw32-make.exe生成一下可执行文件，或者编写tasks.json</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 环境搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C++ </tag>
            
            <tag> Vscode </tag>
            
            <tag> Camke </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vscode与clangd</title>
      <link href="/2025/05/19/vscode%E4%B8%8Eclangd/"/>
      <url>/2025/05/19/vscode%E4%B8%8Eclangd/</url>
      
        <content type="html"><![CDATA[<h2 id="vscode-安装-clangd-出现找不到头文件">vscode 安装 clangd出现找不到头文件</h2><h3 id="编写settingsjson">编写settings.json</h3><p>在 <code>.vscode</code> 目录下的 <code>setting.json</code> 中加入</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token property">"clangd.arguments"</span><span class="token operator">:</span> <span class="token punctuation">[</span>        <span class="token string">"--background-index"</span><span class="token punctuation">,</span>        <span class="token string">"--compile-commands-dir=build"</span><span class="token punctuation">,</span>  <span class="token comment">//compile_command.json相对路径，cmake默认生成在build，自行配置</span>        <span class="token string">"-j=12"</span><span class="token punctuation">,</span>        <span class="token string">"--all-scopes-completion"</span><span class="token punctuation">,</span>        <span class="token string">"--completion-style=detailed"</span><span class="token punctuation">,</span>        <span class="token string">"--header-insertion=iwyu"</span><span class="token punctuation">,</span>        <span class="token string">"--pch-storage=memory"</span><span class="token punctuation">,</span>        <span class="token string">"--cross-file-rename"</span><span class="token punctuation">,</span>        <span class="token string">"--enable-config"</span><span class="token punctuation">,</span>        <span class="token string">"--fallback-style=WebKit"</span><span class="token punctuation">,</span>        <span class="token string">"--pretty"</span><span class="token punctuation">,</span>        <span class="token string">"--clang-tidy"</span><span class="token punctuation">,</span>        <span class="token comment">// 网上别人配置clang++，但我这边windows、linux实测不加这行也没啥问题，可能mac可能需要另外加</span>        <span class="token string">"--query-driver=C:/mingw/bin/g*"</span><span class="token punctuation">,</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="更好地方法">更好地方法</h3><p>在项目根目录下创建 <code>.clangd</code> 文件</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># Fragment common to C and C++ source files</span><span class="token key atrule">CompileFlags</span><span class="token punctuation">:</span>    <span class="token key atrule">Add</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> "<span class="token punctuation">-</span><span class="token punctuation">-</span>include<span class="token punctuation">-</span>directory=./include"   // 相对路径 <span class="token punctuation">-</span> "<span class="token punctuation">-</span><span class="token punctuation">-</span>include<span class="token punctuation">-</span>directory=C<span class="token punctuation">:</span>/code_project/cfiles test/include"   // 绝对路径<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 环境搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C++ </tag>
            
            <tag> Vscode </tag>
            
            <tag> Clangd </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>git指南</title>
      <link href="/2025/05/19/git%E6%8C%87%E5%8D%97/"/>
      <url>/2025/05/19/git%E6%8C%87%E5%8D%97/</url>
      
        <content type="html"><![CDATA[<h2 id="新建仓库">新建仓库</h2><h3 id="远程仓库">远程仓库</h3><p>在 <code>github</code> 上创建新仓库</p><h3 id="本地仓库">本地仓库</h3><p><code>github</code>已经创建新仓库，使用以下命令初始化本地仓库并推送到远程仓库</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 进入项目根目录</span><span class="token builtin class-name">cd</span> ~/your-project-folder<span class="token comment"># 初始化 Git 仓库</span><span class="token function">git</span> init<span class="token comment"># 创建 .gitignore 文件（可选）</span><span class="token builtin class-name">echo</span> <span class="token string">"*.log"</span> <span class="token operator">&gt;&gt;</span> .gitignore<span class="token builtin class-name">echo</span> <span class="token string">"tmp/"</span> <span class="token operator">&gt;&gt;</span> .gitignore<span class="token comment"># 添加所有文件到暂存区</span><span class="token function">git</span> <span class="token function">add</span> <span class="token builtin class-name">.</span><span class="token comment"># 提交代码</span><span class="token function">git</span> commit <span class="token parameter variable">-m</span> <span class="token string">"初始提交：***项目"</span><span class="token comment"># 关联远程仓库（替换 YOUR-USERNAME）</span><span class="token function">git</span> remote <span class="token function">add</span> origin https://github.com/YOUR-USERNAME/nginx-streaming-demos.git<span class="token comment"># 推送到 GitHub</span><span class="token function">git</span> branch <span class="token parameter variable">-M</span> main<span class="token function">git</span> push <span class="token parameter variable">-u</span> origin main<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="已有远程仓库与本地仓库">已有远程仓库与本地仓库</h2><p>有修改，需更新</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查看当前分支</span><span class="token function">git</span> branch<span class="token comment"># 如果要切换到其他分支</span><span class="token function">git</span> checkout <span class="token operator">&lt;</span>branch-name<span class="token operator">&gt;</span><span class="token comment"># 将更改添加到本地暂存区</span><span class="token function">git</span> <span class="token function">add</span> <span class="token builtin class-name">.</span><span class="token comment"># 如果只是指定文件</span><span class="token function">git</span> <span class="token function">add</span> <span class="token operator">&lt;</span>file-name<span class="token operator">&gt;</span><span class="token comment"># 提交更改</span><span class="token function">git</span> commit <span class="token parameter variable">-m</span> <span class="token string">"Your commit message"</span><span class="token comment"># 推送</span><span class="token function">git</span> push<span class="token comment"># 如果没有设置上游分支，要指定分支</span><span class="token function">git</span> push origin <span class="token operator">&lt;</span>branch-name<span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Git </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>nuxt3项目使用docker部署在华为云上</title>
      <link href="/2025/05/19/nuxt3%E9%A1%B9%E7%9B%AE%E4%BD%BF%E7%94%A8docker%E9%83%A8%E7%BD%B2%E5%9C%A8%E5%8D%8E%E4%B8%BA%E4%BA%91%E4%B8%8A/"/>
      <url>/2025/05/19/nuxt3%E9%A1%B9%E7%9B%AE%E4%BD%BF%E7%94%A8docker%E9%83%A8%E7%BD%B2%E5%9C%A8%E5%8D%8E%E4%B8%BA%E4%BA%91%E4%B8%8A/</url>
      
        <content type="html"><![CDATA[<h2 id="购买华为云服务器">购买华为云服务器</h2><h3 id="配置">配置</h3><h4 id="付费模式">付费模式</h4><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/606a3b3a7b41b9e1a8804ada1bcff486.png" alt="image-20240514100751274"></p><h4 id="硬件">硬件</h4><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/3cb353f0c0b39f7b7ea6df41b69db8bb.png" alt="image-20240514100833326"></p><h4 id="操作系统">操作系统</h4><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/7deb4a1d93f694f1c0030d9c38ce9806.png" alt="image-20240515104651134"></p><h4 id="网络配置">网络配置</h4><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/adcd3a9337af940c458a915d8fc82baa.png" alt="image-20240514101126668"></p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/0d3932486fa10c25fa9669c3036c9385.png" alt="image-20240514101138055"></p><h4 id="高级配置">高级配置</h4><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/2adeeb4a7b3e752dc462a91dfe68f423.png" alt="image-20240515093631584"></p><p>记录密码，后续远程登录时要用。</p><h4 id="确认配置">确认配置</h4><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/fcb68d2a4e4b5738f6dd53a135a45ded.png#pic_center" alt="image-20240514101520005"></p><h2 id="服务器安装docker">服务器安装docker</h2><h3 id="远程登录">远程登录</h3><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/832715cddcf015fde59a9d5960b3c286.png" alt="image-20240514101719060"></p><h4 id="安装yum工具">安装yum工具</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">yum <span class="token function">install</span> <span class="token parameter variable">-y</span> yum-utils <span class="token punctuation">\</span>           device-mapper-persistent-data <span class="token punctuation">\</span>           lvm2 --skip-broken<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/6d424099e865f22c09f37d9b56ad2a85.png" alt="image-20240514102553996"></p><p>然后更新本地镜像源：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">yum-config-manager <span class="token punctuation">\</span>    --add-repo <span class="token punctuation">\</span>    https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo    <span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">'s/download.docker.com/mirrors.aliyun.com\/docker-ce/g'</span> /etc/yum.repos.d/docker-ce.repoyum makecache fast<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="docker">docker</h4><p>docker版本：</p><p>CE( CommunityEdition)是社区版，简单理解是免费使用，提供小企业与小的IT团队使用,希望从Docker开始，并尝试基于容器的应用程序部署。</p><p>EE(Docker EnterpriseEdition)是企业版，收费。提供功能更强。适合大企业与打的IT团队。为企业开发和IT团队设计，他们在生产中构建、交付和运行业务关键应用程序</p><p>安装docker</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">yum <span class="token function">install</span> <span class="token parameter variable">-y</span> docker-ce<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/7ceac64871bc86c576dea432401a419b.png#pic_center" alt="image-20240514103152379"></p><p>系统启动时自动启动docker</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">systemctl <span class="token builtin class-name">enable</span> <span class="token function">docker</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>启动docker</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">systemctl start <span class="token function">docker</span> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="配置docker镜像加速">配置docker镜像加速</h4><p>docker官方镜像仓库网速较差，我们需要设置国内镜像服务：</p><p>参考阿里云的镜像加速文档：https://cr.console.aliyun.com/cn-hangzhou/instances/mirrors</p><h2 id="项目打包">项目打包</h2><h3 id="nuxt3项目打包">nuxt3项目打包</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> run build<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>打包后，在.output目录里就是打包好的SSR项目文件。</p><p>在.output/下创建个Dockerfile文件。这个里面是编写的docker项目运行环境、打包镜像和运行项目命令的一个配置文件。</p><p>查看开发所用的 node 版本</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/e06821ad0b0e290f658dd9c6b3787551.png" alt="image-20240514104518281"></p><h4 id="新建dockerfile">新建dockerfile</h4><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/50a8ed1165571852f0cf2a3502955fb6.png" alt="image-20240514142710386"></p><h4 id="编写dockerfile">编写dockerfile</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">## 基于镜像node版本</span>FROM node:18.18.0<span class="token comment">## 参数，node的环境为生产环境</span>ENV <span class="token assign-left variable">NODE_ENV</span><span class="token operator">=</span>production<span class="token comment">## 任意ip</span>ENV HOST <span class="token number">0.0</span>.0.0<span class="token comment">## 容器内创建目录/nuxt3</span>RUN <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /nuxt3<span class="token comment">## 复制当前的内容到容器内容部目录/nuxt3</span>COPY <span class="token builtin class-name">.</span> /nuxt3/<span class="token comment">## 切换工作目录到/nuxt3</span>WORKDIR /nuxt3<span class="token comment">## 暴露端口3000，默认端口</span>EXPOSE <span class="token number">3000</span><span class="token comment">## start</span>CMD <span class="token punctuation">[</span><span class="token string">"node"</span>,<span class="token string">"./server/index.mjs"</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/fa753c53b9864f98f8ee5a0bf272da8b.png" alt="image-20240514105724143"></p><h4 id="打包项目">打包项目</h4><p>使用7-zip把public、server、dockerfile、nitro.json都压缩到nuxt.tar</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/bb5c33807560f7d04665a68a4aff43ff.png" alt="image-20240514125935332"></p><p>在服务器home目录下创建web文件夹</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/9b9bae96dff6943f9bfe5e0ef3dbe162.png" alt="image-20240514130020178"></p><h3 id="上传到服务器">上传到服务器</h3><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/6b874e50f36cc4de113aa0836cd83130.png" alt="image-20240514130036487"></p><p>转到web目录下</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> /<span class="token builtin class-name">cd</span> home/web<span class="token function">ls</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/d00b486ccb707fde418b14e0d59f5d5b.png" alt="image-20240514130220214"></p><h4 id="解压tar文件">解压tar文件</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">tar</span> <span class="token parameter variable">-xvf</span> nuxt.tar<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/37c2cb6dc852a5aef589a40183c8fe7e.png" alt="image-20240514130450877"></p><h4 id="构建镜像">构建镜像</h4><p>名称为group_web</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> build <span class="token parameter variable">-t</span> group_web <span class="token builtin class-name">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>使用以下命令查看是否创建成功</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> images<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/7db49a3ba78df6bb9ca0fe18a52644f7.png" alt="image-20240514132050509"></p><h4 id="创建容器">创建容器</h4><p>创建一个运行该镜像的容器，命名为my_group_web，并映射端口（服务器端口：容器端口）</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> run <span class="token parameter variable">--name</span> my_group_web <span class="token parameter variable">-d</span> <span class="token parameter variable">-p</span> <span class="token number">9020</span>:3000 group_web<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>查看容器</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> <span class="token function">ps</span> //正在运行的容器or<span class="token function">docker</span> <span class="token function">ps</span> <span class="token parameter variable">-a</span> //所有容器<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h4 id="访问项目">访问项目</h4><p>地址：<strong>公网ip:9020</strong></p><p>如果打不开请检查服务器安全组 <img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/fe5ee2ac7429456d2e77bc8bab756711.png#pic_center" alt="image-20240514144636841"></p><p>选中WebServer，嫌麻烦直接选中FullAccess，然后再次访问即可。</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/2dfc0a9e6d062ebb5ff662cfff886c16.png" alt="image-20240514144700411"></p><p>进入安全组：</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/a4447420f19d7b304092a5602e30df7c.png" alt="image-20240514144408471"></p><p>配置规则</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/c52daa75151275c78eeaaeb9f93171ca.png" alt="image-20240514144442604"></p><p>添加规则即可</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/495c60ecdd79f9e41a396623d8649984.png" alt="image-20240514144511788"></p><h2 id="更新项目">更新项目</h2><p>需要执行：<strong>停止容器、删除容器、重新进行项目打包、创建并运行镜像。</strong></p><p>查看容器</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> <span class="token function">ps</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>停止容器</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> stop my_group_web<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>删除容器</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> <span class="token function">rm</span> <span class="token parameter variable">-f</span> my_group_web<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>查看是否删除成功</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> <span class="token function">ps</span> <span class="token parameter variable">-a</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>删除镜像</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> rmi <span class="token parameter variable">-f</span> group_web<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>进入home/web</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> /<span class="token builtin class-name">cd</span> home/web<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>删除文件和文件夹</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">rm</span> * <span class="token parameter variable">-rf</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>重新执行<strong>项目打包</strong>步骤</p><h2 id="参考自">参考自</h2><p><a href="https://blog.csdn.net/jay100500/article/details/130139964">如何用docker容器部署nuxt3项目_docker部署nuxt3-CSDN博客</a></p>]]></content>
      
      
      <categories>
          
          <category> 部署 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Nuxt3 </tag>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>课题组网站开发记录</title>
      <link href="/2025/05/19/%E8%AF%BE%E9%A2%98%E7%BB%84%E7%BD%91%E7%AB%99%E5%BC%80%E5%8F%91%E8%AE%B0%E5%BD%95/"/>
      <url>/2025/05/19/%E8%AF%BE%E9%A2%98%E7%BB%84%E7%BD%91%E7%AB%99%E5%BC%80%E5%8F%91%E8%AE%B0%E5%BD%95/</url>
      
        <content type="html"><![CDATA[<h2 id="准备工作">准备工作</h2><p>后端：</p><p>java 17，springboot，mybatis，maven，mysql</p><p>前端：</p><p>vue3，element-ui</p><p>npm 镜像配置</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> config <span class="token builtin class-name">set</span> registry https://registry.npmmirror.com<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>安装vue脚手架</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> <span class="token parameter variable">-g</span> @vue/cli<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>环境</p><p><img src="C:\Users\L\AppData\Roaming\Typora\typora-user-images\image-20240215233926470.png" alt="image-20240215233926470"></p><p>使用vue ui来创建项目</p><p>安装axios</p><p>npm install axios</p><p>设置端口号</p><p><img src="C:\Users\L\AppData\Roaming\Typora\typora-user-images\image-20240216001259371.png" alt="image-20240216001259371"></p><p>仿照<a href="http://www.rufanzhang-group.cn/">欢迎访问张如范教授课题组！Welcometo Rufan Zhang Group！ (rufanzhang-group.cn)</a></p><h2 id="数据库表结构">数据库表结构</h2><p>1、登录用户表users</p><table><thead><tr><th style="text-align: center;">id</th><th style="text-align: center;">email</th><th>name</th><th style="text-align: center;">username</th><th style="text-align: center;">password</th><th style="text-align: center;">level_key</th><th>status</th><th style="text-align: center;">update_time</th><th style="text-align: center;">create_time</th></tr></thead><tbody></tbody></table><p>2、课题组成员教师表teachers</p><table><thead><tr><th>id</th><th style="text-align: center;">name</th><th style="text-align: center;">image</th><th style="text-align: center;">username</th><th>edu_exp</th><th>direction</th><th style="text-align: center;">introduction</th></tr></thead><tbody></tbody></table><p>3、课题组成员学生表students</p><table><thead><tr><th style="text-align: center;">id</th><th style="text-align: center;">name</th><th style="text-align: center;">image</th><th style="text-align: center;">username</th><th style="text-align: center;">degree</th><th style="text-align: center;">grade</th><th style="text-align: center;">direction</th></tr></thead><tbody></tbody></table><p>4、研究成果表research</p><table><thead><tr><th style="text-align: center;">id</th><th style="text-align: center;">papers</th><th style="text-align: center;">patents</th></tr></thead><tbody></tbody></table><h2 id="接口文档">接口文档</h2><h3 id="1-登录接口">1. 登录接口</h3><h4 id="11-基本信息">1.1 基本信息</h4><blockquote><p>请求路径：/login</p><p>请求方式：post</p><p>接口描述：登录完毕后，系统下发JWT令牌。</p></blockquote><h4 id="12-请求参数">1.2 请求参数</h4><p>参数格式：json</p><p>参数说明：</p><table><thead><tr><th>名称</th><th>类型</th><th>是否必须</th><th>备注</th></tr></thead><tbody><tr><td>username</td><td>string</td><td>必须</td><td>账号</td></tr><tr><td>password</td><td>string</td><td>必须</td><td>密码</td></tr></tbody></table><p>请求样例：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span><span class="token property">"username"</span><span class="token operator">:</span> <span class="token string">"admin"</span><span class="token punctuation">,</span>    <span class="token property">"password"</span><span class="token operator">:</span> <span class="token string">"123456"</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h4 id="13-响应数据">1.3 响应数据</h4><p>参数格式：json</p><p>参数说明：</p><table><thead><tr><th>名称</th><th>类型</th><th>是否必须</th><th>默认值</th><th>备注</th><th>其他信息</th></tr></thead><tbody><tr><td>code</td><td>number</td><td>必须</td><td></td><td>响应码, 1 成功 ; 0 失败</td><td></td></tr><tr><td>msg</td><td>string</td><td>非必须</td><td></td><td>提示信息</td><td></td></tr><tr><td>data</td><td>string</td><td>必须</td><td></td><td>返回的数据 , jwt令牌</td><td></td></tr></tbody></table><p>响应数据样例：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>  <span class="token property">"code"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token property">"msg"</span><span class="token operator">:</span> <span class="token string">"success"</span><span class="token punctuation">,</span>  <span class="token property">"data"</span><span class="token operator">:</span> <span class="token punctuation">{</span>      <span class="token property">"id"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>      <span class="token property">"name"</span><span class="token operator">:</span><span class="token string">"管理员"</span><span class="token punctuation">,</span>      <span class="token property">"username"</span><span class="token operator">:</span><span class="token string">"admin"</span><span class="token punctuation">,</span>      <span class="token property">"token"</span><span class="token operator">:</span><span class="token string">"eyJhbGciOiJIUzI1NiJ9.eyJlbXBJZCI6MSwiZXhwIjoxNzA4MDk3MjY3fQ.LsY9v1oQMBTc3EEzd7Qdo3QP-B6Dl3kpzxznz9lOGtA"</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="14-备注说明">1.4 备注说明</h4><blockquote><p>用户登录成功后，系统会自动下发JWT令牌，然后在后续的每次请求中，都需要在请求头header中携带到服务端，请求头的名称为token ，值为 登录时下发的JWT令牌。</p><p>如果检测到用户未登录，则会返回如下固定错误信息：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span><span class="token property">"code"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token property">"msg"</span><span class="token operator">:</span> <span class="token string">"NOT_LOGIN"</span><span class="token punctuation">,</span><span class="token property">"data"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></blockquote><h3 id="2-注册接口">2. 注册接口</h3><h4 id="21-基本信息">2.1 基本信息</h4><blockquote><p>请求路径：/register</p><p>请求方式：post</p><p>接口描述：登录完毕后，系统下发JWT令牌。</p></blockquote><h4 id="22-请求参数">2.2 请求参数</h4><p>参数格式：json</p><p>参数说明：</p><table><thead><tr><th>名称</th><th>类型</th><th>是否必须</th><th>备注</th></tr></thead><tbody><tr><td>username</td><td>string</td><td>必须</td><td>账号</td></tr><tr><td>password</td><td>string</td><td>必须</td><td>密码</td></tr><tr><td>email</td><td>string</td><td>必须</td><td>邮箱</td></tr><tr><td>name</td><td>string</td><td>必须</td><td>名称</td></tr></tbody></table><p>请求样例：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span><span class="token property">"username"</span><span class="token operator">:</span> <span class="token string">"admin"</span><span class="token punctuation">,</span>    <span class="token property">"password"</span><span class="token operator">:</span> <span class="token string">"123456"</span><span class="token punctuation">,</span>    <span class="token property">"email"</span><span class="token operator">:</span> <span class="token string">"xxxx@xxx.com"</span><span class="token punctuation">,</span>    <span class="token property">"name"</span><span class="token operator">:</span><span class="token string">"xxx"</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="23-响应数据">2.3 响应数据</h4><p>参数格式：json</p><p>参数说明：</p><table><thead><tr><th>名称</th><th>类型</th><th>是否必须</th><th>默认值</th><th>备注</th><th>其他信息</th></tr></thead><tbody><tr><td>code</td><td>number</td><td>必须</td><td></td><td>响应码, 1 成功 ; 0 失败</td><td></td></tr><tr><td>msg</td><td>string</td><td>非必须</td><td></td><td>提示信息</td><td></td></tr><tr><td>data</td><td>string</td><td>非必须</td><td></td><td>返回的数据</td><td></td></tr></tbody></table><p>响应数据样例：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>  <span class="token property">"code"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token property">"msg"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>  <span class="token property">"data"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3-获取成员接口">3. 获取成员接口</h3><h4 id="31-基本信息">3.1 基本信息</h4><blockquote><p>请求路径：/members</p><p>请求方式：get</p><p>接口描述：获取教师和学生信息</p></blockquote><h4 id="32-请求参数">3.2 请求参数</h4><p>无</p><h4 id="33-响应数据">3.3 响应数据</h4><p>参数格式：json</p><p>参数说明：</p><table><thead><tr><th>名称</th><th>类型</th><th>是否必须</th><th>默认值</th><th>备注</th><th>其他信息</th></tr></thead><tbody><tr><td>code</td><td>number</td><td>必须</td><td></td><td>响应码, 1 成功 ; 0 失败</td><td></td></tr><tr><td>msg</td><td>string</td><td>非必须</td><td></td><td>提示信息</td><td></td></tr><tr><td>data</td><td>string</td><td>必须</td><td></td><td>返回的数据</td><td></td></tr></tbody></table><p>响应数据样例：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span><span class="token property">"code"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token property">"msg"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span><span class="token property">"data"</span><span class="token operator">:</span> <span class="token punctuation">{</span>    <span class="token property">"member_info"</span><span class="token operator">:</span> <span class="token punctuation">{</span>        <span class="token property">"teachers"</span><span class="token operator">:</span> <span class="token punctuation">[</span>            <span class="token punctuation">{</span>                <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"xxx"</span><span class="token punctuation">,</span>                <span class="token property">"image"</span><span class="token operator">:</span> <span class="token string">"http://xxx.com"</span><span class="token punctuation">,</span>                <span class="token property">"eduExp"</span><span class="token operator">:</span> <span class="token string">"xxx"</span><span class="token punctuation">,</span>                <span class="token property">"direction"</span><span class="token operator">:</span> <span class="token string">"xxx"</span>            <span class="token punctuation">}</span>        <span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token property">"students"</span><span class="token operator">:</span> <span class="token punctuation">[</span>            <span class="token punctuation">{</span>                <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"xxx"</span><span class="token punctuation">,</span>                <span class="token property">"image"</span><span class="token operator">:</span> <span class="token string">"http://xxx.com"</span><span class="token punctuation">,</span>                <span class="token property">"degree"</span><span class="token operator">:</span> <span class="token string">"xx"</span><span class="token punctuation">,</span>                <span class="token property">"grade"</span><span class="token operator">:</span> <span class="token string">"xxxx"</span><span class="token punctuation">,</span>                <span class="token property">"direction"</span><span class="token operator">:</span> <span class="token string">"xxx"</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token punctuation">{</span>                <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"xxx"</span><span class="token punctuation">,</span>                <span class="token property">"image"</span><span class="token operator">:</span> <span class="token string">"http://xxx.com"</span><span class="token punctuation">,</span>                <span class="token property">"degree"</span><span class="token operator">:</span> <span class="token string">"xx"</span><span class="token punctuation">,</span>                <span class="token property">"grade"</span><span class="token operator">:</span> <span class="token string">"xxxx"</span><span class="token punctuation">,</span>                <span class="token property">"direction"</span><span class="token operator">:</span> <span class="token string">"xxx"</span>            <span class="token punctuation">}</span>        <span class="token punctuation">]</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="34-备注说明">3.4 备注说明</h4><blockquote><p>java里封装两个表的实体类，然后把实体类装入到 Map&lt;String,List&lt;?&gt;&gt; 中，一起返回数据。</p><p>后续可以优化</p></blockquote><h3 id="4-获取研究成果接口">4. 获取研究成果接口</h3><h4 id="41-基本信息">4.1 基本信息</h4><blockquote><p>请求路径：/works</p><p>请求方式：get</p><p>接口描述：获取研究成果</p></blockquote><h4 id="42-请求参数">4.2 请求参数</h4><p>无</p><h4 id="43-响应数据">4.3 响应数据</h4><p>参数格式：json</p><p>参数说明：</p><table><thead><tr><th>名称</th><th>类型</th><th>是否必须</th><th>默认值</th><th>备注</th><th>其他信息</th></tr></thead><tbody><tr><td>code</td><td>number</td><td>必须</td><td></td><td>响应码, 1 成功 ; 0 失败</td><td></td></tr><tr><td>msg</td><td>string</td><td>非必须</td><td></td><td>提示信息</td><td></td></tr><tr><td>data</td><td>string</td><td>必须</td><td></td><td>返回的数据</td><td></td></tr></tbody></table><p>响应数据样例：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>  <span class="token property">"code"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token property">"msg"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>  <span class="token property">"data"</span><span class="token operator">:</span> <span class="token punctuation">{</span>    <span class="token property">"works"</span><span class="token operator">:</span> <span class="token punctuation">[</span>        <span class="token punctuation">{</span>            <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>            <span class="token property">"papers"</span><span class="token operator">:</span> <span class="token string">"论文1"</span><span class="token punctuation">,</span>            <span class="token property">"patents"</span><span class="token operator">:</span> <span class="token string">"专利1"</span>         <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span>            <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>            <span class="token property">"papers"</span><span class="token operator">:</span> <span class="token string">"论文2"</span><span class="token punctuation">,</span>            <span class="token property">"patents"</span><span class="token operator">:</span> <span class="token string">"专利2"</span>        <span class="token punctuation">}</span>    <span class="token punctuation">]</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="5-获取教师信息接口">5. 获取教师信息接口</h3><h4 id="51-基本信息">5.1 基本信息</h4><blockquote><p>请求路径：/t_info</p><p>请求方式：get</p><p>接口描述：获取教师信息</p></blockquote><h4 id="52-请求参数">5.2 请求参数</h4><p>无</p><h4 id="53-响应数据">5.3 响应数据</h4><p>参数格式：json</p><p>参数说明：</p><table><thead><tr><th>名称</th><th>类型</th><th>是否必须</th><th>默认值</th><th>备注</th><th>其他信息</th></tr></thead><tbody><tr><td>code</td><td>number</td><td>必须</td><td></td><td>响应码, 1 成功 ; 0 失败</td><td></td></tr><tr><td>msg</td><td>string</td><td>非必须</td><td></td><td>提示信息</td><td></td></tr><tr><td>data</td><td>string</td><td>必须</td><td></td><td>返回的数据</td><td></td></tr></tbody></table><p>响应数据样例：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>  <span class="token property">"code"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token property">"msg"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>  <span class="token property">"data"</span><span class="token operator">:</span> <span class="token punctuation">[</span>    <span class="token punctuation">{</span>        <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>        <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"xxx"</span><span class="token punctuation">,</span>        <span class="token property">"image"</span><span class="token operator">:</span> <span class="token string">"http://xxx.com"</span><span class="token punctuation">,</span>        <span class="token property">"username"</span><span class="token operator">:</span> <span class="token string">"niyuanzhi"</span><span class="token punctuation">,</span>        <span class="token property">"eduExp"</span><span class="token operator">:</span> <span class="token string">"xxx"</span><span class="token punctuation">,</span>        <span class="token property">"direction"</span><span class="token operator">:</span> <span class="token string">"xx"</span><span class="token punctuation">,</span>        <span class="token property">"introduction"</span><span class="token operator">:</span> <span class="token string">"xxxxxx"</span>    <span class="token punctuation">}</span>  <span class="token punctuation">]</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="6-根据账号获取教师信息接口">6. 根据账号获取教师信息接口</h3><h4 id="61-基本信息">6.1 基本信息</h4><blockquote><p>请求路径：/teac</p><p>请求方式：get</p><p>接口描述：获取教师信息</p></blockquote><h4 id="62-请求参数">6.2 请求参数</h4><table><thead><tr><th>名称</th><th>类型</th><th>是否必须</th><th>默认值</th><th>备注</th><th>其他信息</th></tr></thead><tbody><tr><td>username</td><td>string</td><td>必须</td><td></td><td>账号</td><td></td></tr></tbody></table><h4 id="63-响应数据">6.3 响应数据</h4><p>参数格式：json</p><p>参数说明：</p><table><thead><tr><th>名称</th><th>类型</th><th>是否必须</th><th>默认值</th><th>备注</th><th>其他信息</th></tr></thead><tbody><tr><td>code</td><td>number</td><td>必须</td><td></td><td>响应码, 1 成功 ; 0 失败</td><td></td></tr><tr><td>msg</td><td>string</td><td>非必须</td><td></td><td>提示信息</td><td></td></tr><tr><td>data</td><td>string</td><td>必须</td><td></td><td>返回的数据</td><td></td></tr></tbody></table><p>响应数据样例：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>  <span class="token property">"code"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token property">"msg"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>  <span class="token property">"data"</span><span class="token operator">:</span> <span class="token punctuation">{</span>    <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"xxx"</span><span class="token punctuation">,</span>    <span class="token property">"image"</span><span class="token operator">:</span> <span class="token string">"http://xxx.com"</span><span class="token punctuation">,</span>    <span class="token property">"username"</span><span class="token operator">:</span> <span class="token string">"niyuanzhi"</span><span class="token punctuation">,</span>    <span class="token property">"eduExp"</span><span class="token operator">:</span> <span class="token string">"xxx"</span><span class="token punctuation">,</span>    <span class="token property">"direction"</span><span class="token operator">:</span> <span class="token string">"xx"</span><span class="token punctuation">,</span>    <span class="token property">"introduction"</span><span class="token operator">:</span> <span class="token string">"xxxxxx"</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="7-修改教师信息接口">7. 修改教师信息接口</h3><h4 id="71-基本信息">7.1 基本信息</h4><blockquote><p>请求路径：/teac</p><p>请求方式：put</p><p>接口描述：修改教师信息</p></blockquote><h4 id="72-请求参数">7.2 请求参数</h4><p>参数格式：json</p><p>参数说明：</p><table><thead><tr><th>名称</th><th>类型</th><th>是否必须</th><th>默认值</th><th>备注</th></tr></thead><tbody><tr><td>id</td><td>int</td><td>必须</td><td></td><td>id</td></tr><tr><td>name</td><td>string</td><td>必须</td><td></td><td>姓名</td></tr><tr><td>image</td><td>string</td><td>非必须</td><td></td><td>图片</td></tr><tr><td>edu_exp</td><td>string</td><td>必须</td><td></td><td>教育经历</td></tr><tr><td>direction</td><td>string</td><td>必须</td><td></td><td>研究方向</td></tr><tr><td>introduction</td><td>string</td><td>非必须</td><td></td><td>介绍</td></tr></tbody></table><h4 id="73-响应数据">7.3 响应数据</h4><p>参数格式：json</p><p>参数说明：</p><table><thead><tr><th>名称</th><th>类型</th><th>是否必须</th><th>默认值</th><th>备注</th><th>其他信息</th></tr></thead><tbody><tr><td>code</td><td>number</td><td>必须</td><td></td><td>响应码, 1 成功 ; 0 失败</td><td></td></tr><tr><td>msg</td><td>string</td><td>非必须</td><td></td><td>提示信息</td><td></td></tr><tr><td>data</td><td>string</td><td>必须</td><td></td><td>返回的数据</td><td></td></tr></tbody></table><p>响应数据样例：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>  <span class="token property">"code"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token property">"msg"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>  <span class="token property">"data"</span><span class="token operator">:</span><span class="token null keyword">null</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="8-根据账号获取学生信息接口">8. 根据账号获取学生信息接口</h3><h4 id="81-基本信息">8.1 基本信息</h4><blockquote><p>请求路径：/stud</p><p>请求方式：get</p><p>接口描述：获取学生信息</p></blockquote><h4 id="82-请求参数">8.2 请求参数</h4><table><thead><tr><th>名称</th><th>类型</th><th>是否必须</th><th>默认值</th><th>备注</th><th>其他信息</th></tr></thead><tbody><tr><td>username</td><td>string</td><td>必须</td><td></td><td>账号</td><td></td></tr></tbody></table><h4 id="83-响应数据">8.3 响应数据</h4><p>参数格式：json</p><p>参数说明：</p><table><thead><tr><th>名称</th><th>类型</th><th>是否必须</th><th>默认值</th><th>备注</th><th>其他信息</th></tr></thead><tbody><tr><td>code</td><td>number</td><td>必须</td><td></td><td>响应码, 1 成功 ; 0 失败</td><td></td></tr><tr><td>msg</td><td>string</td><td>非必须</td><td></td><td>提示信息</td><td></td></tr><tr><td>data</td><td>string</td><td>必须</td><td></td><td>返回的数据</td><td></td></tr></tbody></table><p>响应数据样例：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>  <span class="token property">"code"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token property">"msg"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>  <span class="token property">"data"</span><span class="token operator">:</span> <span class="token punctuation">{</span>    <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"xxx"</span><span class="token punctuation">,</span>    <span class="token property">"image"</span><span class="token operator">:</span> <span class="token string">"http://xxx.com"</span><span class="token punctuation">,</span>    <span class="token property">"username"</span><span class="token operator">:</span> <span class="token string">"xxx"</span><span class="token punctuation">,</span>    <span class="token property">"degree"</span><span class="token operator">:</span> <span class="token string">"xx"</span><span class="token punctuation">,</span>    <span class="token property">"grade"</span><span class="token operator">:</span> <span class="token string">"xxxx"</span><span class="token punctuation">,</span>    <span class="token property">"direction"</span><span class="token operator">:</span> <span class="token string">"xx"</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="9-修改学生信息接口">9. 修改学生信息接口</h3><h4 id="91-基本信息">9.1 基本信息</h4><blockquote><p>请求路径：/stud</p><p>请求方式：put</p><p>接口描述：修改学生信息</p></blockquote><h4 id="92-请求参数">9.2 请求参数</h4><p>参数格式：json</p><p>参数说明：</p><table><thead><tr><th>名称</th><th>类型</th><th>是否必须</th><th>默认值</th><th>备注</th></tr></thead><tbody><tr><td>name</td><td>string</td><td>必须</td><td></td><td>姓名</td></tr><tr><td>image</td><td>string</td><td>非必须</td><td></td><td>图片</td></tr><tr><td>degree</td><td>string</td><td>必须</td><td></td><td>教育经历</td></tr><tr><td>grade</td><td>string</td><td>必须</td><td></td><td>研究方向</td></tr><tr><td>direction</td><td>string</td><td>非必须</td><td></td><td>介绍</td></tr></tbody></table><h4 id="93-响应数据">9.3 响应数据</h4><p>参数格式：json</p><p>参数说明：</p><table><thead><tr><th>名称</th><th>类型</th><th>是否必须</th><th>默认值</th><th>备注</th><th>其他信息</th></tr></thead><tbody><tr><td>code</td><td>number</td><td>必须</td><td></td><td>响应码, 1 成功 ; 0 失败</td><td></td></tr><tr><td>msg</td><td>string</td><td>非必须</td><td></td><td>提示信息</td><td></td></tr><tr><td>data</td><td>string</td><td>必须</td><td></td><td>返回的数据</td><td></td></tr></tbody></table><p>响应数据样例：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>  <span class="token property">"code"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token property">"msg"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>  <span class="token property">"data"</span><span class="token operator">:</span><span class="token null keyword">null</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="10校验token接口">10.校验token接口</h3><h4 id="101-基本信息">10.1 基本信息</h4><blockquote><p>请求路径：/token</p><p>请求方式：post</p><p>接口描述：校验token是否合法。</p></blockquote><h4 id="102-请求参数">10.2 请求参数</h4><table><thead><tr><th>名称</th><th>类型</th><th>是否必须</th><th>默认值</th><th>备注</th><th>其他信息</th></tr></thead><tbody><tr><td>token</td><td>string</td><td>必须</td><td></td><td></td><td></td></tr></tbody></table><h4 id="103-响应数据">10.3 响应数据</h4><p>参数格式：json</p><p>参数说明：</p><table><thead><tr><th>名称</th><th>类型</th><th>是否必须</th><th>默认值</th><th>备注</th><th>其他信息</th></tr></thead><tbody><tr><td>code</td><td>number</td><td>必须</td><td></td><td>响应码, 1 成功 ; 0 失败</td><td></td></tr><tr><td>msg</td><td>string</td><td>非必须</td><td></td><td>提示信息</td><td></td></tr><tr><td>data</td><td>string</td><td>必须</td><td></td><td>返回的数据</td><td></td></tr></tbody></table><p>响应数据样例：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>  <span class="token property">"code"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token property">"msg"</span><span class="token operator">:</span> <span class="token string">"success"</span><span class="token punctuation">,</span>  <span class="token property">"data"</span><span class="token operator">:</span> <span class="token punctuation">{</span>      <span class="token property">"id"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>      <span class="token property">"name"</span><span class="token operator">:</span><span class="token string">"管理员"</span><span class="token punctuation">,</span>      <span class="token property">"username"</span><span class="token operator">:</span><span class="token string">"admin"</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="11退出登录接口">11.退出登录接口</h3><h4 id="111-基本信息">11.1 基本信息</h4><blockquote><p>请求路径：/logout</p><p>请求方式：post</p><p>接口描述：退出登录。</p></blockquote><h4 id="112-请求参数">11.2 请求参数</h4><table><thead><tr><th>名称</th><th>类型</th><th>是否必须</th><th>默认值</th><th>备注</th><th>其他信息</th></tr></thead><tbody><tr><td>token</td><td>string</td><td>必须</td><td></td><td></td><td></td></tr></tbody></table><h4 id="113-响应数据">11.3 响应数据</h4><p>参数格式：json</p><p>参数说明：</p><table><thead><tr><th>名称</th><th>类型</th><th>是否必须</th><th>默认值</th><th>备注</th><th>其他信息</th></tr></thead><tbody><tr><td>code</td><td>number</td><td>必须</td><td></td><td>响应码, 1 成功 ; 0 失败</td><td></td></tr><tr><td>msg</td><td>string</td><td>非必须</td><td></td><td>提示信息</td><td></td></tr><tr><td>data</td><td>string</td><td>必须</td><td></td><td>返回的数据</td><td></td></tr></tbody></table><p>响应数据样例：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>  <span class="token property">"code"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token property">"msg"</span><span class="token operator">:</span> <span class="token string">"success"</span><span class="token punctuation">,</span>  <span class="token property">"data"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="springboot开发记录">springboot开发记录</h2><p>pojo: UserLoginDTO——UserLoginVo——User</p><p>server: UserController——UserMapper——UserService UserServiceImpl</p><h2 id="vue3开发记录">Vue3开发记录</h2><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>router-link</span> <span class="token attr-name">to</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/login<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>登录<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>router-link</span><span class="token punctuation">&gt;</span></span>|<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>router-link</span> <span class="token attr-name">to</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/register<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>注册<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>router-link</span><span class="token punctuation">&gt;</span></span>|<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>router-link</span> <span class="token attr-name">to</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/stud<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>学生端<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>router-link</span><span class="token punctuation">&gt;</span></span>|<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>router-link</span> <span class="token attr-name">to</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/teac<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>教师端<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>router-link</span><span class="token punctuation">&gt;</span></span>|<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>router-link</span> <span class="token attr-name">to</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>首页<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>router-link</span><span class="token punctuation">&gt;</span></span> |<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>router-link</span> <span class="token attr-name">to</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/members<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>课题组成员<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>router-link</span><span class="token punctuation">&gt;</span></span>|<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>router-link</span> <span class="token attr-name">to</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/t_info<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>教师信息<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>router-link</span><span class="token punctuation">&gt;</span></span>|<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>router-link</span> <span class="token attr-name">to</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/works<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>研究成果<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>router-link</span><span class="token punctuation">&gt;</span></span>       <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 开发记录 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> SpringBoot </tag>
            
            <tag> Vue </tag>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
