<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>离线安装Visual Studio、CUDA</title>
      <link href="/2025/07/17/%E7%A6%BB%E7%BA%BF%E5%AE%89%E8%A3%85Visual-Studio%E3%80%81CUDA/"/>
      <url>/2025/07/17/%E7%A6%BB%E7%BA%BF%E5%AE%89%E8%A3%85Visual-Studio%E3%80%81CUDA/</url>
      
        <content type="html"><![CDATA[<h2 id="离线安装-visual-studio-cuda"><a class="markdownIt-Anchor" href="#离线安装-visual-studio-cuda"></a> 离线安装 Visual Studio、CUDA</h2><hr /><h3 id="环境介绍"><a class="markdownIt-Anchor" href="#环境介绍"></a> 环境介绍</h3><p>离线设备为笔记本电脑。Win11，Rtx4060 laptop。</p><h3 id="安装包准备"><a class="markdownIt-Anchor" href="#安装包准备"></a> 安装包准备</h3><p>在可以上网的电脑上准备以下安装包（<strong>选择适合的版本</strong>）：</p><ol><li><p>visual studio 社区版 2022</p><blockquote><p>安装 CUDA 过程中碰见了 no supported version of visual studio 这类错误，发现是离线设备没有 VS 组件的问题，为了彻底解决问题，决定安装整个 VS（可能不是最优解）</p></blockquote></li><li><p>英伟达显卡驱动：NVIDIA Studio 驱动程序 576.80 版本</p><blockquote><p><a href="https://www.nvidia.cn/geforce/drivers/">NVIDIA GeForce 驱动程序 - N 卡驱动 | NVIDIA</a></p></blockquote></li><li><p>CUDA 12.6.3:</p><blockquote><p>CUDA 版本根据显卡驱动决定。本文下载的驱动是 576.80 版本，最高支持 12.9 的CUDA</p></blockquote></li></ol><h4 id="1-准备-vs-的离线安装包"><a class="markdownIt-Anchor" href="#1-准备-vs-的离线安装包"></a> 1. 准备 VS 的离线安装包</h4><p>本文参考资料如下（遇见问题后阅读以下）：<br /><a href="https://learn.microsoft.com/zh-cn/visualstudio/install/create-an-offline-installation-of-visual-studio?view=vs-2022">创建脱机安装 - Visual Studio (Windows) | Microsoft Learn</a></p><p><a href="https://www.lincol29.cn/vsoffline">Visual Studio2022离线安装(没网)，制作离线安装包</a></p><h5 id="下载引导程序"><a class="markdownIt-Anchor" href="#下载引导程序"></a> 下载引导程序</h5><p>地址：<a href="https://visualstudio.microsoft.com/zh-hans/downloads/">下载 Visual Studio Tools - 免费安装 Windows、Mac、Linux</a></p><p>本文选择的是2022社区版</p><p>下载后会得到一个安装包：vs_Community.exe</p><h5 id="制作离线安装包"><a class="markdownIt-Anchor" href="#制作离线安装包"></a> 制作离线安装包</h5><p>然后新建一个存储离线安装包的目录，确保空间充足。</p><p>本文新建的是：D:\vs_offline</p><p>然后将 vs_Community.exe 复制到 D:\vs_offline</p><p>在 D:\vs_offline目录下运行命令行窗口（cmd）</p><p>输入命令行：</p><pre class="line-numbers language-none"><code class="language-none">.\vs_Community.exe --layout D:\vs_offline --add Microsoft.VisualStudio.Workload.NativeDesktop --includeRecommended --includeOptional --lang zh-CN<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>本文只下载了 C++ 桌面开发（包括所有推荐组件和可选组件）（约13GB，觉得太大可以尝试不加 --includeOptional。如果后续出错了再次运行命令行即可。），需要其他开发环境可以修改或添加 --add ，参考官方文档。</p><p>等待下载完成后，将 vs_offline 文件夹压缩后拷贝到离线电脑中。</p><h4 id="2-升级显卡驱动"><a class="markdownIt-Anchor" href="#2-升级显卡驱动"></a> 2. 升级显卡驱动</h4><p>离线设备的显卡驱动版本较低。这里选择对其进行升级，不升级也可以，但是仅支持低版本的 CUDA 。</p><p>本文选择的是：</p><p>英伟达显卡驱动：NVIDIA Studio 驱动程序 576.80 版本 <a href="https://www.nvidia.cn/geforce/drivers/">NVIDIA GeForce 驱动程序 - N 卡驱动 | NVIDIA</a></p><p>等待下载完成后，将 exe 文件拷贝到离线电脑中。</p><h4 id="3-下载cuda"><a class="markdownIt-Anchor" href="#3-下载cuda"></a> 3. 下载CUDA</h4><p>本文下载的驱动是 576.80 版本，最高支持 12.9 的 CUDA ，本文下载的是 12.6.3</p><blockquote><p>可以使用命令行： nvidia-smi 查看当前驱动最高支持的CUDA版本</p></blockquote><p>各种版本链接：<br /><a href="https://developer.nvidia.com/cuda-toolkit-archive">CUDA Toolkit Archive | NVIDIA Developer</a></p><p>等待下载完成后，将 exe 文件拷贝到离线电脑中。</p><h3 id="离线安装"><a class="markdownIt-Anchor" href="#离线安装"></a> 离线安装</h3><h4 id="离线安装-vs"><a class="markdownIt-Anchor" href="#离线安装-vs"></a> 离线安装 VS</h4><p>在离线电脑中找到拷贝过来的 vs_offline 文件夹，找到 vs_installer.opc 文件，将这个文件解压（opc文件本质上也是一个 zip 文件，可以使用常见的解压工具解压，例如 WinRAR、7-Zip、Bandizip等。）将其中解压出来的 Contents 文件夹复制到 C:\Program Files (x86)\Microsoft Visual Studio 里，如果没有 Microsoft Visual Studio 文件夹就新建。然后重命名 Microsoft Visual Studio 文件夹下的 Contents 文件夹为 Installer。</p><p>回到 vs_offline 文件夹中。在此目录下打开终端，运行以下命令行：</p><pre class="line-numbers language-none"><code class="language-none">.\vs_setup.exe --noWeb --add Microsoft.VisualStudio.Workload.NativeDesktop --includeRecommended --includeOptional<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>–add 部分的内容根据自己情况而定。</p></blockquote><p>此命令会打开 VS 的安装引导程序，在右侧选择自己安装的功能包即可。</p><p>查询 VS C++ 桌面程序开发 安装教程，各个教程选择安装的功能包各不相同。如果只是为了安装 CUDA 可以试试不选择这些功能包，只安装核心功能包。如果后续 CUDA 安装仍然出现 VS 相关的错误，再重新运行命令行添加功能包即可。</p><p>本文选择的安装包如下：</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/202507161102582.png" alt="image-20250716110225089" /></p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/202507161102135.png" alt="image-20250716110257749" /></p><p>然后点击安装即可。</p><h4 id="离线安装显卡驱动"><a class="markdownIt-Anchor" href="#离线安装显卡驱动"></a> 离线安装显卡驱动</h4><p>直接运行 exe 文件即可。</p><p>命令行输入 <code>nvidia-smi</code> 查看驱动版本。</p><h4 id="离线安装-cuda"><a class="markdownIt-Anchor" href="#离线安装-cuda"></a> 离线安装 CUDA</h4><p>没安装 VS 之前会出现安装错误。安装了 VS 之后就安装成功了。</p><p>命令行输入 <code>nvcc -V</code> 查看 CUDA 版本。</p>]]></content>
      
      
      <categories>
          
          <category> 环境搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Cuda </tag>
            
            <tag> Visual Studio </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>每日知识点-34</title>
      <link href="/2025/07/10/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-34/"/>
      <url>/2025/07/10/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-34/</url>
      
        <content type="html"><![CDATA[<h2 id="每日知识点-34"><a class="markdownIt-Anchor" href="#每日知识点-34"></a> 每日知识点-34</h2><hr />]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> C++ </tag>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>每日知识点-33</title>
      <link href="/2025/07/09/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-33/"/>
      <url>/2025/07/09/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-33/</url>
      
        <content type="html"><![CDATA[<h2 id="每日知识点-33"><a class="markdownIt-Anchor" href="#每日知识点-33"></a> 每日知识点-33</h2><hr /><h3 id="设备树dts与硬件抽象"><a class="markdownIt-Anchor" href="#设备树dts与硬件抽象"></a> 📌 <strong>设备树（DTS）与硬件抽象</strong></h3><h4 id="1-设备树的核心作用"><a class="markdownIt-Anchor" href="#1-设备树的核心作用"></a> <strong>1. 设备树的核心作用</strong></h4><p><strong>为什么需要设备树？</strong></p><ul><li><strong>传统问题</strong>：早期驱动需硬编码寄存器地址、中断号等硬件参数，更换硬件需重新编译内核。</li><li><strong>解决方案</strong>：设备树（<code>.dts</code>文件）以树状结构描述硬件配置（如GPIO引脚、时钟源、中断号），实现 <strong>硬件与驱动解耦</strong>。</li><li><strong>核心优势</strong>：<ul><li><strong>移植性</strong>：同一驱动适配不同硬件（如STM32与IMX6ULL开发板的LED引脚不同）。</li><li><strong>可维护性</strong>：修改硬件只需调整设备树，无需改动驱动代码。</li></ul></li></ul><p><strong>通俗比喻</strong>：</p><blockquote><p>设备树是硬件的“说明书”，驱动通过匹配说明书中的型号（<code>compatible</code>字段）自动适配硬件，实现“即插即用”。</p></blockquote><hr /><h4 id="2-设备树语法与驱动匹配"><a class="markdownIt-Anchor" href="#2-设备树语法与驱动匹配"></a> <strong>2. 设备树语法与驱动匹配</strong></h4><p><strong>设备树关键语法</strong>：</p><pre class="line-numbers language-dts" data-language="dts"><code class="language-dts">&#x2F;&#x2F; 设备树节点示例：描述LED硬件leds &#123;    compatible &#x3D; &quot;gpio-leds&quot;;          &#x2F;&#x2F; 驱动匹配标识    red_led: led@0 &#123;                    &#x2F;&#x2F; 节点标签        label &#x3D; &quot;system_status&quot;;        &#x2F;&#x2F; 设备标签（可选）        gpios &#x3D; &lt;&amp;gpio1 3 GPIO_ACTIVE_LOW&gt;; &#x2F;&#x2F; GPIO控制器+引脚+电平        default-state &#x3D; &quot;off&quot;;          &#x2F;&#x2F; 初始状态    &#125;;&#125;;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>驱动中如何匹配设备树？</strong></p><pre class="highlight"><code class="c"><span class="hljs-comment">// 1. 定义设备树匹配表（驱动入口）</span><span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">of_device_id</span> <span class="hljs-title">led_match</span>[] = &#123;</span>    &#123; .compatible = <span class="hljs-string">"gpio-leds"</span> &#125;,  <span class="hljs-comment">// 与设备树中compatible一致</span>    &#123;&#125;                              <span class="hljs-comment">// 哨兵节点（必须！）</span>&#125;;MODULE_DEVICE_TABLE(of, led_match);  <span class="hljs-comment">// 暴露匹配表到sysfs</span><span class="hljs-comment">// 2. 在probe函数解析设备树</span><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">led_probe</span><span class="hljs-params">(struct platform_device *pdev)</span> </span>&#123;    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">device_node</span> *<span class="hljs-title">np</span> = <span class="hljs-title">pdev</span>-&gt;<span class="hljs-title">dev</span>.<span class="hljs-title">of_node</span>;</span>  <span class="hljs-comment">// 获取设备树节点</span>    <span class="hljs-keyword">int</span> gpio = of_get_named_gpio(np, <span class="hljs-string">"gpios"</span>, <span class="hljs-number">0</span>); <span class="hljs-comment">// 提取GPIO编号</span>    gpio_request(gpio, <span class="hljs-string">"led-gpio"</span>);              <span class="hljs-comment">// 申请GPIO资源</span>    gpio_direction_output(gpio, <span class="hljs-number">1</span>);              <span class="hljs-comment">// 配置为输出模式</span>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;&#125;</code></pre><p><strong>技术解析</strong>：</p><ul><li><code>compatible</code>是匹配核心：驱动通过此字段识别设备树节点。</li><li>设备树编译流程：<code>.dts</code> → <code>.dtb</code>（二进制）→ 内核启动时加载到内存。</li><li><strong>避坑点</strong>：设备树节点名（如<code>led@0</code>）可自定义，但<code>compatible</code>必须与驱动严格匹配！</li></ul><hr /><h4 id="3-设备树-vs-硬编码对比"><a class="markdownIt-Anchor" href="#3-设备树-vs-硬编码对比"></a> <strong>3. 设备树 vs 硬编码对比</strong></h4><table><thead><tr><th><strong>特性</strong></th><th>设备树驱动</th><th>硬编码驱动</th></tr></thead><tbody><tr><td><strong>硬件修改</strong></td><td>改设备树 → 无需重编译内核</td><td>改驱动代码 → 需重编译内核</td></tr><tr><td><strong>可移植性</strong></td><td>⭐⭐⭐⭐ (适配多硬件平台)</td><td>⭐⭐ (绑定特定硬件)</td></tr><tr><td><strong>代码量</strong></td><td>驱动代码简洁（仅核心逻辑）</td><td>驱动含大量寄存器地址定义</td></tr><tr><td><strong>维护成本</strong></td><td>低（硬件工程师独立维护设备树）</td><td>高（需驱动工程师参与）</td></tr></tbody></table><hr /><h4 id="4-面试题与实战"><a class="markdownIt-Anchor" href="#4-面试题与实战"></a> <strong>4. 面试题与实战</strong></h4><p><strong>题目1</strong>：设备树中 <code>reg = &lt;0x40000000 0x1000&gt;</code> 的含义？<br /><strong>答案</strong>：</p><blockquote><p>寄存器物理地址为 <code>0x40000000</code>，长度 <code>0x1000</code>（4KB），用于驱动通过<code>platform_get_resource()</code>获取资源。</p></blockquote><p><strong>题目2</strong>：驱动未加载，可能的原因？<br /><strong>排查步骤</strong>：</p><ol><li>检查<code>compatible</code>是否拼写一致（大小写敏感！）。</li><li>查看内核日志：<code>dmesg | grep &quot;of_device&quot;</code>，确认匹配是否成功。</li><li>确认设备树已编译并加载到内核：<code>ls /proc/device-tree</code>。</li></ol><p><strong>动手实验</strong>：</p><ol><li><strong>目标</strong>：修改设备树添加按键节点，驱动中解析中断号。</li><li><strong>设备树修改</strong>：<pre class="highlight"><code class="dts"><span class="hljs-class">buttons </span>&#123;    compatible = <span class="hljs-string">"gpio-keys"</span>;    <span class="hljs-class">key1 </span>&#123;        label = <span class="hljs-string">"USER_KEY"</span>;        gpios = <span class="hljs-params">&lt;<span class="hljs-variable">&amp;gpio1</span> <span class="hljs-number">18</span> GPIO_ACTIVE_LOW&gt;</span>;  <span class="hljs-comment">// 引脚配置</span>        linux,code = <span class="hljs-params">&lt;KEY_ENTER&gt;</span>;             <span class="hljs-comment">// 按键编码</span>    &#125;;&#125;;</code></pre></li><li><strong>驱动中获取中断号</strong>：<pre class="highlight"><code class="c"><span class="hljs-keyword">int</span> irq = platform_get_irq(pdev, <span class="hljs-number">0</span>);  <span class="hljs-comment">// 提取第一个中断号</span>request_irq(irq, button_isr, IRQF_TRIGGER_FALLING, <span class="hljs-string">"key_irq"</span>, <span class="hljs-literal">NULL</span>);</code></pre></li></ol><hr /><h3 id="今日学习建议"><a class="markdownIt-Anchor" href="#今日学习建议"></a> ✅ <strong>今日学习建议</strong></h3><ol><li><strong>重点巩固</strong>：<ul><li>理解<code>compatible</code>的匹配机制（画设备树与驱动的关联图）。</li><li>掌握<code>of_get_named_gpio()</code>等解析函数的使用场景。</li></ul></li><li><strong>调试技巧</strong>：<ul><li>检查设备树语法：<code>dtc -I dts -O dtb -o myboard.dtb myboard.dts</code>（编译验证）。</li><li>查看设备树加载情况：<code>ls /proc/device-tree/leds</code>。</li></ul></li><li><strong>扩展挑战</strong>：<ul><li>在设备树中添加两个LED节点，驱动中分别控制它们（需处理多个设备实例）。</li></ul></li></ol><blockquote><p><strong>明日预告</strong>：中断处理机制（上半部/下半部）与并发控制（自旋锁/互斥锁）。请准备好开发板测试中断响应！</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> C++ </tag>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>每日知识点-32</title>
      <link href="/2025/07/08/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-32/"/>
      <url>/2025/07/08/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-32/</url>
      
        <content type="html"><![CDATA[<h2 id="每日知识点-32"><a class="markdownIt-Anchor" href="#每日知识点-32"></a> 每日知识点-32</h2><hr /><h3 id="字符设备驱动开发基础"><a class="markdownIt-Anchor" href="#字符设备驱动开发基础"></a> 📌 <strong>字符设备驱动开发基础</strong></h3><h4 id="1-驱动类型与作用"><a class="markdownIt-Anchor" href="#1-驱动类型与作用"></a> <strong>1. 驱动类型与作用</strong></h4><p><strong>三大驱动类型</strong>：</p><table><thead><tr><th><strong>类型</strong></th><th><strong>访问方式</strong></th><th><strong>典型设备</strong></th><th><strong>核心操作</strong></th></tr></thead><tbody><tr><td><strong>字符设备</strong></td><td>字节流（顺序）</td><td>LED、按键、串口</td><td><code>open/read/write/ioctl</code></td></tr><tr><td><strong>块设备</strong></td><td>固定数据块</td><td>硬盘、SD卡</td><td>缓冲区管理、IO调度</td></tr><tr><td><strong>网络设备</strong></td><td>数据包</td><td>网卡、WiFi模块</td><td><code>ndo_start_xmit</code>（发包）</td></tr></tbody></table><p><strong>驱动核心作用</strong>：</p><blockquote><p><strong>硬件抽象层</strong>：驱动程序将硬件寄存器操作封装为标准文件接口（如 <code>/dev/led</code>），实现 <strong>“应用与硬件解耦”</strong>。<br /><strong>通俗比喻</strong>：驱动像“翻译官”，把应用程序的<code>read/write</code>命令翻译成硬件能理解的信号（如GPIO电平控制）。</p></blockquote><hr /><h4 id="2-字符设备驱动开发流程"><a class="markdownIt-Anchor" href="#2-字符设备驱动开发流程"></a> <strong>2. 字符设备驱动开发流程</strong></h4><p><strong>完整代码模板</strong>（带逐行解析）：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fs.h></span>        <span class="token comment">// 文件操作结构体file_operations</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/cdev.h></span>      <span class="token comment">// 字符设备管理cdev</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEVICE_NAME</span> <span class="token string">"mydev"</span>  <span class="token comment">// 设备节点名称</span></span><span class="token keyword">static</span> <span class="token keyword">int</span> major<span class="token punctuation">;</span>            <span class="token comment">// 主设备号</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">cdev</span> my_cdev<span class="token punctuation">;</span>  <span class="token comment">// 字符设备对象</span><span class="token comment">// 1. 实现设备操作函数（以open为例）</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">my_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"Device opened\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 2. 定义file_operations结构体（驱动核心！）</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> fops <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>    <span class="token comment">// 防止模块被卸载时设备正在使用</span>    <span class="token punctuation">.</span>open <span class="token operator">=</span> my_open<span class="token punctuation">,</span>         <span class="token comment">// 映射open系统调用到my_open函数</span>    <span class="token punctuation">.</span>read <span class="token operator">=</span> my_read<span class="token punctuation">,</span>         <span class="token comment">// 需自定义read函数</span>    <span class="token punctuation">.</span>write <span class="token operator">=</span> my_write<span class="token punctuation">,</span>       <span class="token comment">// 需自定义write函数</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// 3. 模块初始化（驱动入口）</span><span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">my_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 动态分配设备号（避免冲突）</span>    <span class="token class-name">dev_t</span> devno<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">alloc_chrdev_region</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>devno<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> DEVICE_NAME<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    major <span class="token operator">=</span> <span class="token function">MAJOR</span><span class="token punctuation">(</span>devno<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 提取主设备号</span>    <span class="token comment">// 关联cdev与fops</span>    <span class="token function">cdev_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>my_cdev<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fops<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">cdev_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>my_cdev<span class="token punctuation">,</span> devno<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">unregister_chrdev_region</span><span class="token punctuation">(</span>devno<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 失败时释放设备号</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 4. 模块卸载（驱动出口）</span><span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">my_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">cdev_del</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>my_cdev<span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token comment">// 删除cdev</span>    <span class="token function">unregister_chrdev_region</span><span class="token punctuation">(</span><span class="token function">MKDEV</span><span class="token punctuation">(</span>major<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 释放设备号</span><span class="token punctuation">&#125;</span><span class="token function">module_init</span><span class="token punctuation">(</span>my_init<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">module_exit</span><span class="token punctuation">(</span>my_exit<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 必须声明GPL协议</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>技术解析</strong>：</p><ul><li><strong><code>file_operations</code></strong>：驱动核心结构体，<strong>将系统调用映射到硬件操作函数</strong>（如<code>read()</code>→<code>my_read()</code>）。</li><li><strong>设备号管理</strong>：<ul><li><strong>主设备号</strong>：标识驱动类型（如<code>250</code>代表LED驱动）</li><li><strong>次设备号</strong>：区分同一驱动的多个实例（如LED1、LED2）</li><li><code>alloc_chrdev_region()</code>动态分配避免冲突（优于静态分配）。</li></ul></li><li><strong><code>cdev</code>生命周期</strong>：<code>cdev_init()</code>→<code>cdev_add()</code>注册设备 →<code>cdev_del()</code>销毁。</li></ul><hr /><h4 id="3-面试题与实战"><a class="markdownIt-Anchor" href="#3-面试题与实战"></a> <strong>3. 面试题与实战</strong></h4><p><strong>题目1</strong>：为什么字符设备驱动必须实现 <code>file_operations</code>？<br /><strong>答案</strong>：</p><blockquote><p>内核通过 <code>file_operations</code> 将系统调用（如 <code>open()</code>）映射到驱动的硬件操作函数，实现 <strong>硬件抽象层</strong>。没有它，应用程序无法通过标准接口（如 <code>/dev/led</code>）控制硬件。</p></blockquote><p><strong>题目2</strong>：以下代码有何问题？</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">my_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"Device opened\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 未指定日志级别</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><strong>答案</strong>：</p><blockquote><p><strong>错误</strong>：<code>printk</code>未指定日志级别（如<code>KERN_INFO</code>），可能导致日志被过滤。<br /><strong>修正</strong>：<code>printk(KERN_INFO &quot;Device opened\n&quot;);</code>。</p></blockquote><hr /><h4 id="4-动手实验虚拟字符设备驱动"><a class="markdownIt-Anchor" href="#4-动手实验虚拟字符设备驱动"></a> <strong>4. 动手实验：虚拟字符设备驱动</strong></h4><p><strong>目标</strong>：实现一个虚拟设备，<code>read()</code>时返回字符串 <code>&quot;Hello Driver!&quot;</code>。<br /><strong>步骤</strong>：</p><ol><li>补充 <code>my_read</code> 函数：</li></ol><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">my_read</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> len<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span>off<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>msg <span class="token operator">=</span> <span class="token string">"Hello Driver!"</span><span class="token punctuation">;</span>    <span class="token class-name">size_t</span> msg_len <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 拷贝数据到用户空间（防止内存越界）</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_to_user</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> msg_len<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>  <span class="token comment">// 拷贝失败返回错误码</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> msg_len<span class="token punctuation">;</span>      <span class="token comment">// 返回实际读取长度</span><span class="token punctuation">&#125;</span>```  <span class="token number">2.</span> 编译加载驱动：  ```bashmake                  # 使用内核Makefile编译sudo insmod mydev<span class="token punctuation">.</span>ko  # 加载驱动dmesg <span class="token operator">|</span> tail          # 查看内核日志，确认设备号sudo mknod <span class="token operator">/</span>dev<span class="token operator">/</span>mydev c <span class="token number">250</span> <span class="token number">0</span>  # 创建设备节点（<span class="token number">250</span>需替换为实际主设备号）```  <span class="token number">3.</span> 测试驱动：  ```bashcat <span class="token operator">/</span>dev<span class="token operator">/</span>mydev  # 应输出 <span class="token string">"Hello Driver!"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr /><h3 id="今日学习建议"><a class="markdownIt-Anchor" href="#今日学习建议"></a> ✅ <strong>今日学习建议</strong></h3><ol><li><strong>重点巩固</strong>：<ul><li>理解 <code>file_operations</code> 的映射机制（画流程图加深记忆）。</li><li>掌握 <code>copy_to_user()</code> 的安全意义（内核空间→用户空间需显式拷贝）。</li></ul></li><li><strong>扩展挑战</strong>：<ul><li>添加 <code>ioctl</code> 接口实现LED开关（需定义控制命令码）。</li></ul></li><li><strong>调试技巧</strong>：<ul><li>使用 <code>dmesg -w</code> 实时监控内核日志。</li></ul></li></ol><blockquote><p><strong>明日预告</strong>：设备树（DTS）原理与实战——<strong>如何用设备树替代硬编码寄存器地址</strong>。准备好开发板（或QEMU模拟器）。</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> C++ </tag>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>每日知识点-31</title>
      <link href="/2025/07/07/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-31/"/>
      <url>/2025/07/07/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-31/</url>
      
        <content type="html"><![CDATA[<h2 id="每日知识点-31"><a class="markdownIt-Anchor" href="#每日知识点-31"></a> 每日知识点-31</h2><hr /><h3 id="一-linux驱动-设备树与驱动匹配"><a class="markdownIt-Anchor" href="#一-linux驱动-设备树与驱动匹配"></a> 🔧 一、Linux驱动 - 设备树与驱动匹配</h3><p><strong>题目1</strong>：简述设备树（DTS）在Linux驱动中的作用，并写出匹配驱动的关键数据结构。<br /><strong>答案</strong>：</p><ul><li><strong>作用</strong>：设备树以树状结构描述硬件配置（如寄存器地址、中断号），实现驱动与硬件解耦，避免内核重新编译。</li><li><strong>匹配数据结构</strong>：<pre class="line-numbers language-c" data-language="c"><code class="language-c">  <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">of_device_id</span> my_driver_match<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>      <span class="token punctuation">&#123;</span> <span class="token punctuation">.</span>compatible <span class="token operator">=</span> <span class="token string">"vendor,my-device"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token comment">// 设备树中定义的compatible属性</span>      <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token function">MODULE_DEVICE_TABLE</span><span class="token punctuation">(</span>of<span class="token punctuation">,</span> my_driver_match<span class="token punctuation">)</span><span class="token punctuation">;</span>  ```  <span class="token operator">*</span><span class="token operator">*</span>通俗解释<span class="token operator">*</span><span class="token operator">*</span>：  <span class="token operator">></span> 设备树像“硬件说明书”，驱动通过`compatible`字段匹配说明书中的设备型号，实现即插即用。  <span class="token operator">*</span><span class="token operator">*</span>应用场景<span class="token operator">*</span><span class="token operator">*</span>：  嵌入式SoC开发（如TI AM335x、NXP i<span class="token punctuation">.</span>MX系列），适配不同硬件版本无需修改驱动代码。<span class="token operator">--</span><span class="token operator">-</span>### ⚡ 二、中断处理 <span class="token operator">-</span> 上半部与下半部  <span class="token operator">*</span><span class="token operator">*</span>题目<span class="token number">2</span><span class="token operator">*</span><span class="token operator">*</span>：为何Linux中断处理要分上半部（Top Half）和下半部（Bottom Half）？下半部常用哪些实现方式？  <span class="token operator">*</span><span class="token operator">*</span>答案<span class="token operator">*</span><span class="token operator">*</span>：  <span class="token operator">-</span> <span class="token operator">*</span><span class="token operator">*</span>原因<span class="token operator">*</span><span class="token operator">*</span>：上半部快速响应硬件中断（关中断执行），下半部处理耗时操作（如数据处理），避免阻塞其他中断。  <span class="token operator">-</span> <span class="token operator">*</span><span class="token operator">*</span>下半部实现<span class="token operator">*</span><span class="token operator">*</span>：    <span class="token operator">-</span> 软中断（SoftIRQ）：内核静态定义，高优先级    <span class="token operator">-</span> Tasklet：基于软中断，可动态创建（原子操作）    <span class="token operator">-</span> 工作队列（Workqueue）：进程上下文，可睡眠  <span class="token operator">*</span><span class="token operator">*</span>技术解析<span class="token operator">*</span><span class="token operator">*</span>：  ```c<span class="token comment">// 上半部：触发下半部Tasklet</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">my_irq_top_half</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pt_regs</span> <span class="token operator">*</span>regs<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">tasklet_schedule</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>my_tasklet<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调度Tasklet</span><span class="token punctuation">&#125;</span><span class="token comment">// 下半部：实际处理</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">my_irq_bottom_half</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> data<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">process_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 可包含复杂逻辑</span><span class="token punctuation">&#125;</span>```  <span class="token operator">*</span><span class="token operator">*</span>典型应用<span class="token operator">*</span><span class="token operator">*</span>：  网络设备收包（上半部存数据，下半部协议解析）。<span class="token operator">--</span><span class="token operator">-</span>### 📡 三、通信协议 <span class="token operator">-</span> SPI与I2C对比  <span class="token operator">*</span><span class="token operator">*</span>题目<span class="token number">3</span><span class="token operator">*</span><span class="token operator">*</span>：列举SPI与I2C的<span class="token number">3</span>点核心区别及适用场景。  <span class="token operator">*</span><span class="token operator">*</span>答案<span class="token operator">*</span><span class="token operator">*</span>：  <span class="token operator">|</span> <span class="token operator">*</span><span class="token operator">*</span>特性<span class="token operator">*</span><span class="token operator">*</span>       <span class="token operator">|</span> SPI                          <span class="token operator">|</span> I2C                  <span class="token operator">|</span>  <span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span>  <span class="token operator">|</span> <span class="token operator">*</span><span class="token operator">*</span>信号线<span class="token operator">*</span><span class="token operator">*</span>     <span class="token operator">|</span> <span class="token number">4</span>线（SCK<span class="token operator">/</span>MOSI<span class="token operator">/</span>MISO<span class="token operator">/</span>SS）      <span class="token operator">|</span> <span class="token number">2</span>线（SDA<span class="token operator">/</span>SCL）       <span class="token operator">|</span>  <span class="token operator">|</span> <span class="token operator">*</span><span class="token operator">*</span>速度<span class="token operator">*</span><span class="token operator">*</span>       <span class="token operator">|</span> 高速（<span class="token number">50</span>MHz<span class="token operator">+</span>）               <span class="token operator">|</span> 低速（≤<span class="token number">400</span>KHz）      <span class="token operator">|</span>  <span class="token operator">|</span> <span class="token operator">*</span><span class="token operator">*</span>拓扑<span class="token operator">*</span><span class="token operator">*</span>       <span class="token operator">|</span> 主从<span class="token operator">+</span>片选（多设备需多SS线）  <span class="token operator">|</span> 多主多从<span class="token operator">+</span>地址寻址    <span class="token operator">|</span>  <span class="token operator">*</span><span class="token operator">*</span>应用场景<span class="token operator">*</span><span class="token operator">*</span>：  <span class="token operator">-</span> <span class="token operator">*</span><span class="token operator">*</span>SPI<span class="token operator">*</span><span class="token operator">*</span>：高速Flash读写、TFT屏幕刷新  <span class="token operator">-</span> <span class="token operator">*</span><span class="token operator">*</span>I2C<span class="token operator">*</span><span class="token operator">*</span>：温度传感器（如LM75）、RTC时钟。  <span class="token operator">--</span><span class="token operator">-</span>### 🔄 四、RTOS任务同步  <span class="token operator">*</span><span class="token operator">*</span>题目<span class="token number">4</span><span class="token operator">*</span><span class="token operator">*</span>：FreeRTOS中二值信号量 vs 互斥量的核心区别？互斥量如何解决优先级反转？  <span class="token operator">*</span><span class="token operator">*</span>答案<span class="token operator">*</span><span class="token operator">*</span>：  <span class="token operator">-</span> <span class="token operator">*</span><span class="token operator">*</span>区别<span class="token operator">*</span><span class="token operator">*</span>：    <span class="token operator">|</span> <span class="token operator">*</span><span class="token operator">*</span>类型<span class="token operator">*</span><span class="token operator">*</span>       <span class="token operator">|</span> 特性                  <span class="token operator">|</span>    <span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">|</span>    <span class="token operator">|</span> 二值信号量     <span class="token operator">|</span> 无优先级继承          <span class="token operator">|</span>    <span class="token operator">|</span> 互斥量         <span class="token operator">|</span> 支持优先级继承        <span class="token operator">|</span>  <span class="token operator">-</span> <span class="token operator">*</span><span class="token operator">*</span>优先级反转解决<span class="token operator">*</span><span class="token operator">*</span>：    低优先级任务占用资源时，临时提升其优先级至高优先级任务水平，防止中优先级任务抢占。  <span class="token operator">*</span><span class="token operator">*</span>代码验证<span class="token operator">*</span><span class="token operator">*</span>：  ```cSemaphoreHandle_t xMutex <span class="token operator">=</span> <span class="token function">xSemaphoreCreateMutex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 默认启用优先级继承</span>```  <span class="token operator">*</span><span class="token operator">*</span>应用场景<span class="token operator">*</span><span class="token operator">*</span>：  SPI总线共享（高优先级任务需快速访问总线时触发继承）。<span class="token operator">--</span><span class="token operator">-</span>### 💾 五、内核内存管理  <span class="token operator">*</span><span class="token operator">*</span>题目<span class="token number">5</span><span class="token operator">*</span><span class="token operator">*</span>：`<span class="token function">kmalloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>`与`<span class="token function">vmalloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>`的区别？DMA场景应选哪个？  <span class="token operator">*</span><span class="token operator">*</span>答案<span class="token operator">*</span><span class="token operator">*</span>：  <span class="token operator">-</span> <span class="token operator">*</span><span class="token operator">*</span>区别<span class="token operator">*</span><span class="token operator">*</span>：    <span class="token operator">-</span> `kmalloc`：分配<span class="token operator">*</span><span class="token operator">*</span>物理连续<span class="token operator">*</span><span class="token operator">*</span>内存，大小受限（通常≤<span class="token number">4</span>MB），访问快    <span class="token operator">-</span> `vmalloc`：分配<span class="token operator">*</span><span class="token operator">*</span>虚拟连续<span class="token operator">*</span><span class="token operator">*</span>内存（物理可能不连续），支持大内存，访问慢（需页表转换）  <span class="token operator">-</span> <span class="token operator">*</span><span class="token operator">*</span>DMA选择<span class="token operator">*</span><span class="token operator">*</span>：`kmalloc`或`<span class="token function">dma_alloc_coherent</span><span class="token punctuation">(</span><span class="token punctuation">)</span>`（DMA要求物理连续）。  <span class="token operator">*</span><span class="token operator">*</span>技术解析<span class="token operator">*</span><span class="token operator">*</span>：  ```c<span class="token comment">// DMA内存申请（物理连续）</span><span class="token class-name">dma_addr_t</span> dma_handle<span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token operator">*</span>buf <span class="token operator">=</span> <span class="token function">dma_alloc_coherent</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> size<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dma_handle<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>```  <span class="token operator">*</span><span class="token operator">*</span>典型错误<span class="token operator">*</span><span class="token operator">*</span>：  摄像头数据采集若用`vmalloc`，DMA传输可能因物理地址不连续失败。<span class="token operator">--</span><span class="token operator">-</span>### 🤖 六、AI边缘部署优化  <span class="token operator">*</span><span class="token operator">*</span>题目<span class="token number">6</span><span class="token operator">*</span><span class="token operator">*</span>：边缘部署千亿模型时，模型压缩技术（量化<span class="token operator">/</span>蒸馏<span class="token operator">/</span>剪枝）如何选择？  <span class="token operator">*</span><span class="token operator">*</span>答案<span class="token operator">*</span><span class="token operator">*</span>：  <span class="token operator">|</span> <span class="token operator">*</span><span class="token operator">*</span>技术<span class="token operator">*</span><span class="token operator">*</span> <span class="token operator">|</span> 适用场景                  <span class="token operator">|</span> 边缘设备约束        <span class="token operator">|</span>  <span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">|</span>  <span class="token operator">|</span> 量化     <span class="token operator">|</span> 推理加速（INT8降内存<span class="token number">3</span>x） <span class="token operator">|</span> 支持INT8的NPU<span class="token operator">/</span>GPU   <span class="token operator">|</span>  <span class="token operator">|</span> 蒸馏     <span class="token operator">|</span> 高精度要求（小模型仿大模型） <span class="token operator">|</span> 训练资源充足       <span class="token operator">|</span>  <span class="token operator">|</span> 剪枝     <span class="token operator">|</span> 计算资源紧张（稀疏计算） <span class="token operator">|</span> 支持稀疏加速的硬件 <span class="token operator">|</span>  <span class="token operator">*</span><span class="token operator">*</span>优化案例<span class="token operator">*</span><span class="token operator">*</span>：  LLaMA<span class="token operator">-</span><span class="token number">65</span>B部署：  <span class="token operator">-</span> <span class="token operator">*</span><span class="token operator">*</span>方案<span class="token operator">*</span><span class="token operator">*</span>：INT8量化 <span class="token operator">+</span> 知识蒸馏 → 显存从<span class="token number">120</span>GB→<span class="token number">24</span>GB  <span class="token operator">-</span> <span class="token operator">*</span><span class="token operator">*</span>硬件<span class="token operator">*</span><span class="token operator">*</span>：NVIDIA Jetson AGX Orin，延迟<span class="token operator">&lt;</span><span class="token number">100</span>ms。  <span class="token operator">--</span><span class="token operator">-</span>### ✅ 今日学习建议  <span class="token number">1.</span> <span class="token operator">*</span><span class="token operator">*</span>重点巩固<span class="token operator">*</span><span class="token operator">*</span>：若中断处理流程不熟，精读Linux内核中断注册流程（`request_irq`源码分析）。  <span class="token number">2.</span> <span class="token operator">*</span><span class="token operator">*</span>动手实验<span class="token operator">*</span><span class="token operator">*</span>：     ```bash   # 在树莓派上实现SPI驱动LED屏幕（验证通信协议）   $ git clone https<span class="token operator">:</span><span class="token comment">//github.com/raspberrypi/linux</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><ol start="3"><li><strong>延伸学习</strong>：<ul><li>设备树编译工具（<code>dtc</code>命令）</li><li>FreeRTOS优先级继承机制源码（<code>task.c</code>中<code>vTaskPriorityInherit()</code>）</li></ul></li></ol><blockquote><p>明日可深入 <strong>Linux启动流程优化</strong> 或 <strong>AI模型量化实战</strong>，请告知你的优先方向！</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> C++ </tag>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>每日知识点-30</title>
      <link href="/2025/07/04/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-30/"/>
      <url>/2025/07/04/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-30/</url>
      
        <content type="html"><![CDATA[<h2 id="每日知识点-30"><a class="markdownIt-Anchor" href="#每日知识点-30"></a> 每日知识点-30</h2><hr /><h3 id="一-硬件与处理器架构"><a class="markdownIt-Anchor" href="#一-硬件与处理器架构"></a> 🔧 一、硬件与处理器架构</h3><p><strong>题目1 - 中断管理</strong><br /><strong>类型</strong>：简答题<br /><strong>题目</strong>：解释中断嵌套的概念，并说明在ARM Cortex-M中如何配置中断优先级以实现嵌套。<br /><strong>答案</strong>：</p><ul><li><strong>中断嵌套</strong>：高优先级中断可打断正在执行的低优先级中断处理程序（ISR），形成嵌套。</li><li><strong>配置方法</strong>：<ul><li>设置NVIC优先级分组（如4位抢占优先级+0位子优先级）。</li><li>高抢占优先级中断可抢占低优先级中断。</li></ul></li></ul><p><strong>技术解析</strong>：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// 配置UART中断优先级为2（高），按键中断优先级为1（低）</span><span class="token function">HAL_NVIC_SetPriority</span><span class="token punctuation">(</span>UART_IRQn<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">HAL_NVIC_SetPriority</span><span class="token punctuation">(</span>EXTI0_IRQn<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>```  <span class="token operator">*</span><span class="token operator">*</span>应用场景<span class="token operator">*</span><span class="token operator">*</span>：  实时数据采集（UART收数据中断抢占按键中断）。  <span class="token operator">--</span><span class="token operator">-</span>### ⚙️ 二、RTOS核心机制  <span class="token operator">*</span><span class="token operator">*</span>题目<span class="token number">2</span> <span class="token operator">-</span> 任务同步<span class="token operator">*</span><span class="token operator">*</span>  <span class="token operator">*</span><span class="token operator">*</span>类型<span class="token operator">*</span><span class="token operator">*</span>：代码分析题  <span class="token operator">*</span><span class="token operator">*</span>题目<span class="token operator">*</span><span class="token operator">*</span>：以下FreeRTOS代码有何问题？如何修正？  ```c<span class="token keyword">void</span> <span class="token function">TaskA</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">xSemaphoreTake</span><span class="token punctuation">(</span>mutex<span class="token punctuation">,</span> portMAX_DELAY<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 操作共享资源</span>    <span class="token function">xSemaphoreGive</span><span class="token punctuation">(</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 忘记释放信号量</span><span class="token punctuation">&#125;</span>```  <span class="token operator">*</span><span class="token operator">*</span>答案<span class="token operator">*</span><span class="token operator">*</span>：  <span class="token operator">-</span> <span class="token operator">*</span><span class="token operator">*</span>错误<span class="token operator">*</span><span class="token operator">*</span>：任务在异常分支中可能未释放互斥锁，导致死锁。  <span class="token operator">-</span> <span class="token operator">*</span><span class="token operator">*</span>修正<span class="token operator">*</span><span class="token operator">*</span>：    ```c  <span class="token keyword">void</span> <span class="token function">TaskA</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">xSemaphoreTake</span><span class="token punctuation">(</span>mutex<span class="token punctuation">,</span> <span class="token function">pdMS_TO_TICKS</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> pdTRUE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          <span class="token comment">// 操作资源</span>          <span class="token function">xSemaphoreGive</span><span class="token punctuation">(</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 确保释放</span>      <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  ```  <span class="token operator">*</span><span class="token operator">*</span>技术解析<span class="token operator">*</span><span class="token operator">*</span>：  <span class="token operator">-</span> <span class="token operator">*</span><span class="token operator">*</span>关键点<span class="token operator">*</span><span class="token operator">*</span>：互斥锁必须成对使用，且需考虑超时机制。  <span class="token operator">-</span> <span class="token operator">*</span><span class="token operator">*</span>应用场景<span class="token operator">*</span><span class="token operator">*</span>：SPI总线共享访问（多任务竞争时避免总线冲突）。  <span class="token operator">--</span><span class="token operator">-</span>### 💻 三、C<span class="token operator">/</span>C<span class="token operator">++</span>编程  <span class="token operator">*</span><span class="token operator">*</span>题目<span class="token number">3</span> <span class="token operator">-</span> 指针与内存<span class="token operator">*</span><span class="token operator">*</span>  <span class="token operator">*</span><span class="token operator">*</span>类型<span class="token operator">*</span><span class="token operator">*</span>：选择题  <span class="token operator">*</span><span class="token operator">*</span>题目<span class="token operator">*</span><span class="token operator">*</span>：以下代码输出什么？  ```c<span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token operator">&amp;</span>a<span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token operator">*</span>pp <span class="token operator">=</span> <span class="token operator">&amp;</span>p<span class="token punctuation">;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token operator">*</span>pp<span class="token punctuation">)</span><span class="token punctuation">;</span>```  A<span class="token punctuation">.</span> <span class="token number">10</span>  B<span class="token punctuation">.</span> a的地址  C<span class="token punctuation">.</span> p的地址  D<span class="token punctuation">.</span> 编译错误  <span class="token operator">*</span><span class="token operator">*</span>答案<span class="token operator">*</span><span class="token operator">*</span>：A  <span class="token operator">*</span><span class="token operator">*</span>通俗解释<span class="token operator">*</span><span class="token operator">*</span>：  `pp`是二级指针，指向指针`p`，`p`指向`a`，因此`<span class="token operator">*</span><span class="token operator">*</span>pp`解引用两次得到`a`的值。  <span class="token operator">*</span><span class="token operator">*</span>技术解析<span class="token operator">*</span><span class="token operator">*</span>：  ```c<span class="token keyword">int</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>ppp <span class="token operator">=</span> <span class="token operator">&amp;</span>pp<span class="token punctuation">;</span>  <span class="token comment">// 三级指针（实际开发慎用）</span>```  <span class="token operator">*</span><span class="token operator">*</span>应用场景<span class="token operator">*</span><span class="token operator">*</span>：  动态多维数组（如图像处理中的矩阵操作）。  <span class="token operator">--</span><span class="token operator">-</span>### 📡 四、通信协议  <span class="token operator">*</span><span class="token operator">*</span>题目<span class="token number">4</span> <span class="token operator">-</span> SPI与I2C对比<span class="token operator">*</span><span class="token operator">*</span>  <span class="token operator">*</span><span class="token operator">*</span>类型<span class="token operator">*</span><span class="token operator">*</span>：简答题  <span class="token operator">*</span><span class="token operator">*</span>题目<span class="token operator">*</span><span class="token operator">*</span>：列举SPI与I2C的<span class="token number">3</span>点核心区别，并说明各自适用场景。  <span class="token operator">*</span><span class="token operator">*</span>答案<span class="token operator">*</span><span class="token operator">*</span>：  <span class="token operator">|</span> <span class="token operator">*</span><span class="token operator">*</span>特性<span class="token operator">*</span><span class="token operator">*</span>       <span class="token operator">|</span> SPI                          <span class="token operator">|</span> I2C                  <span class="token operator">|</span>  <span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span>  <span class="token operator">|</span> <span class="token operator">*</span><span class="token operator">*</span>线路数量<span class="token operator">*</span><span class="token operator">*</span>   <span class="token operator">|</span> <span class="token number">4</span>线（SCK<span class="token operator">/</span>MISO<span class="token operator">/</span>MOSI<span class="token operator">/</span>SS）      <span class="token operator">|</span> <span class="token number">2</span>线（SDA<span class="token operator">/</span>SCL）       <span class="token operator">|</span>  <span class="token operator">|</span> <span class="token operator">*</span><span class="token operator">*</span>速度<span class="token operator">*</span><span class="token operator">*</span>       <span class="token operator">|</span> 快（可达<span class="token number">50</span>MHz）              <span class="token operator">|</span> 慢（通常≤<span class="token number">400</span>KHz）    <span class="token operator">|</span>  <span class="token operator">|</span> <span class="token operator">*</span><span class="token operator">*</span>拓扑结构<span class="token operator">*</span><span class="token operator">*</span>   <span class="token operator">|</span> 一主多从（需片选信号）       <span class="token operator">|</span> 多主多从（地址寻址） <span class="token operator">|</span>  <span class="token operator">*</span><span class="token operator">*</span>典型应用<span class="token operator">*</span><span class="token operator">*</span>：  <span class="token operator">-</span> <span class="token operator">*</span><span class="token operator">*</span>SPI<span class="token operator">*</span><span class="token operator">*</span>：高速ADC数据采集（如传感器阵列）。  <span class="token operator">-</span> <span class="token operator">*</span><span class="token operator">*</span>I2C<span class="token operator">*</span><span class="token operator">*</span>：低速设备控制（如EEPROM、温度传感器）。  <span class="token operator">--</span><span class="token operator">-</span>### 🛠️ 五、系统设计与优化  <span class="token operator">*</span><span class="token operator">*</span>题目<span class="token number">5</span> <span class="token operator">-</span> 低功耗设计<span class="token operator">*</span><span class="token operator">*</span>  <span class="token operator">*</span><span class="token operator">*</span>类型<span class="token operator">*</span><span class="token operator">*</span>：设计题  <span class="token operator">*</span><span class="token operator">*</span>题目<span class="token operator">*</span><span class="token operator">*</span>：设计一个电池供电的物联网设备，待机功耗需≤<span class="token number">1</span>μA。列举<span class="token number">3</span>种硬件<span class="token operator">+</span><span class="token number">3</span>种软件优化策略。  <span class="token operator">*</span><span class="token operator">*</span>答案<span class="token operator">*</span><span class="token operator">*</span>：  <span class="token operator">-</span> <span class="token operator">*</span><span class="token operator">*</span>硬件策略<span class="token operator">*</span><span class="token operator">*</span>：    <span class="token number">1.</span> 选用Cortex<span class="token operator">-</span>M0<span class="token operator">+</span>内核（超低静态功耗）。    <span class="token number">2.</span> 关闭未用外设的时钟（如ADC、UART）。    <span class="token number">3.</span> 使用LDO替代DC<span class="token operator">-</span>DC（无开关损耗）。  <span class="token operator">-</span> <span class="token operator">*</span><span class="token operator">*</span>软件策略<span class="token operator">*</span><span class="token operator">*</span>：    <span class="token number">1.</span> 启用RTOS的Tickless模式（空闲时停时钟）。    <span class="token number">2.</span> 中断唤醒替代轮询（CPU休眠时间最大化）。    <span class="token number">3.</span> 动态降频（任务少时降低CPU主频）。  <span class="token operator">*</span><span class="token operator">*</span>技术解析<span class="token operator">*</span><span class="token operator">*</span>：  ```c<span class="token comment">// FreeRTOS启用Tickless模式</span>configUSE_TICKLESS_IDLE <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>```  <span class="token operator">--</span><span class="token operator">-</span>### 💎 六、综合实战题  <span class="token operator">*</span><span class="token operator">*</span>题目<span class="token number">6</span> <span class="token operator">-</span> 系统启动流程<span class="token operator">*</span><span class="token operator">*</span>  <span class="token operator">*</span><span class="token operator">*</span>类型<span class="token operator">*</span><span class="token operator">*</span>：简答题  <span class="token operator">*</span><span class="token operator">*</span>题目<span class="token operator">*</span><span class="token operator">*</span>：画出嵌入式Linux启动流程图（从Bootloader到用户程序），并说明各阶段任务。  <span class="token operator">*</span><span class="token operator">*</span>答案<span class="token operator">*</span><span class="token operator">*</span>：  ```mermaidgraph LRA<span class="token punctuation">[</span>Bootloader<span class="token punctuation">]</span> <span class="token operator">--</span><span class="token operator">></span> B<span class="token punctuation">[</span>加载内核<span class="token punctuation">]</span>B <span class="token operator">--</span><span class="token operator">></span> C<span class="token punctuation">[</span>挂载根文件系统<span class="token punctuation">]</span>C <span class="token operator">--</span><span class="token operator">></span> D<span class="token punctuation">[</span>启动init进程<span class="token punctuation">]</span>D <span class="token operator">--</span><span class="token operator">></span> E<span class="token punctuation">[</span>执行用户程序<span class="token punctuation">]</span>```  <span class="token operator">-</span> <span class="token operator">*</span><span class="token operator">*</span>Bootloader<span class="token operator">*</span><span class="token operator">*</span>：初始化DDR、时钟，加载内核（如U<span class="token operator">-</span>Boot）。  <span class="token operator">-</span> <span class="token operator">*</span><span class="token operator">*</span>内核<span class="token operator">*</span><span class="token operator">*</span>：驱动硬件，建立进程管理。  <span class="token operator">-</span> <span class="token operator">*</span><span class="token operator">*</span>根文件系统<span class="token operator">*</span><span class="token operator">*</span>：提供<span class="token operator">/</span>dev、<span class="token operator">/</span>bin等目录支持应用运行。  <span class="token operator">--</span><span class="token operator">-</span>### ✅ 今日学习建议  <span class="token number">1.</span> <span class="token operator">*</span><span class="token operator">*</span>重点巩固<span class="token operator">*</span><span class="token operator">*</span>：针对答错的题目查阅：     <span class="token operator">-</span> ARM中断优先级配置（）     <span class="token operator">-</span> FreeRTOS互斥锁超时机制（）  <span class="token number">2.</span> <span class="token operator">*</span><span class="token operator">*</span>动手实验<span class="token operator">*</span><span class="token operator">*</span>：     ```bash   # 用STM32CubeMX配置一个SPI<span class="token operator">+</span>I2C多从机工程<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="3"><li><strong>扩展阅读</strong>：<ul><li>《ARM Cortex-M权威指南》中断章节</li><li>FreeRTOS官方文档：信号量最佳实践</li></ul></li></ol><blockquote><p>明日将更新 <strong>“嵌入式Linux驱动开发”与“AI模型边缘部署”</strong> 相关题目，如需调整方向请告知！</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> C++ </tag>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>每日知识点-29</title>
      <link href="/2025/07/03/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-29/"/>
      <url>/2025/07/03/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-29/</url>
      
        <content type="html"><![CDATA[<h2 id="每日知识点-29"><a class="markdownIt-Anchor" href="#每日知识点-29"></a> 每日知识点-29</h2><hr /><h3 id="一-rtos核心概念"><a class="markdownIt-Anchor" href="#一-rtos核心概念"></a> 📚 一、RTOS核心概念</h3><ol><li><p><strong>实时性分类</strong></p><ul><li><strong>硬实时</strong>：超时=系统失效（如刹车控制、心脏起搏器），响应时间严格可控。</li><li><strong>软实时</strong>：超时可容忍（如视频播放），需尽快响应但无致命后果。</li></ul></li><li><p><strong>RTOS vs 通用OS</strong></p><table><thead><tr><th><strong>特性</strong></th><th>RTOS (FreeRTOS)</th><th>Linux</th></tr></thead><tbody><tr><td><strong>响应时间</strong></td><td>微秒级（硬实时保证）</td><td>毫秒级（非实时）</td></tr><tr><td><strong>内核大小</strong></td><td>KB级（如FreeRTOS 10KB）</td><td>MB级</td></tr><tr><td><strong>调度策略</strong></td><td>固定优先级抢占</td><td>CFS公平调度</td></tr><tr><td><strong>适用场景</strong></td><td>工业控制、传感器采集</td><td>图形界面、服务器</td></tr></tbody></table></li><li><p><strong>内核类型</strong></p><ul><li><strong>可剥夺型内核</strong>：高优先级任务可抢占低优先级任务（FreeRTOS默认）。</li><li><strong>不可剥夺型内核</strong>：任务主动释放CPU才切换，易引发优先级反转。</li></ul></li></ol><hr /><h3 id="️-二-任务管理freertos核心"><a class="markdownIt-Anchor" href="#️-二-任务管理freertos核心"></a> ⚙️ 二、任务管理（FreeRTOS核心）</h3><ol><li><p><strong>任务四态模型</strong></p><pre class="line-numbers language-mermaid" data-language="mermaid"><code class="language-mermaid"><span class="token keyword">graph</span> LR  A<span class="token text string">[就绪 Ready]</span> <span class="token arrow operator">--></span> B<span class="token text string">[运行 Running]</span>  B <span class="token arrow operator">--></span> C<span class="token text string">[阻塞 Blocked]</span>  C <span class="token arrow operator">--></span> A  B <span class="token arrow operator">--></span> D<span class="token text string">[挂起 Suspended]</span>  D <span class="token arrow operator">--></span> A<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><strong>运行→阻塞</strong>：调用 <code>vTaskDelay()</code> 或等待信号量。</li><li><strong>挂起→就绪</strong>：调用 <code>vTaskResume()</code> 恢复任务。</li></ul></li><li><p><strong>调度策略</strong></p><table><thead><tr><th><strong>类型</strong></th><th>原理</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>抢占式调度</strong></td><td>高优先级任务立即抢占CPU</td><td>工业控制（紧急响应）</td></tr><tr><td><strong>时间片轮转</strong></td><td>同优先级任务轮流执行（默认1ms/次）</td><td>公平调度需求场景</td></tr></tbody></table></li><li><p><strong>优先级反转与解决方案</strong></p><ul><li><strong>问题场景</strong>：低优先级任务C占用资源 → 中优先级任务B运行 → 高优先级任务A等待资源被阻塞。</li><li><strong>解决方案</strong>：<ul><li><strong>优先级继承</strong>：C临时提升至A的优先级（FreeRTOS互斥锁默认支持）。</li><li><strong>优先级天花板</strong>：资源预设最高优先级，占用者直接提升。</li></ul></li></ul></li></ol><hr /><h3 id="三-同步与通信机制"><a class="markdownIt-Anchor" href="#三-同步与通信机制"></a> 🔗 三、同步与通信机制</h3><ol><li><p><strong>队列（Queue）</strong></p><ul><li><strong>作用</strong>：任务/中断间传递数据（FIFO或LIFO）。</li><li><strong>API示例</strong>：<pre class="line-numbers language-c" data-language="c"><code class="language-c">QueueHandle_t xQueue <span class="token operator">=</span> <span class="token function">xQueueCreate</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建队列</span><span class="token function">xQueueSend</span><span class="token punctuation">(</span>xQueue<span class="token punctuation">,</span> <span class="token operator">&amp;</span>data<span class="token punctuation">,</span> portMAX_DELAY<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// 发送数据</span><span class="token function">xQueueReceive</span><span class="token punctuation">(</span>xQueue<span class="token punctuation">,</span> <span class="token operator">&amp;</span>received<span class="token punctuation">,</span> portMAX_DELAY<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 接收数据</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li></ul></li><li><p><strong>信号量 vs 互斥量</strong></p><table><thead><tr><th><strong>类型</strong></th><th>用途</th><th>特性</th></tr></thead><tbody><tr><td><strong>二值信号量</strong></td><td>任务同步（如中断通知任务）</td><td>值仅0/1，无优先级继承</td></tr><tr><td><strong>互斥量</strong></td><td>资源保护（如共享内存访问）</td><td>支持优先级继承</td></tr></tbody></table></li><li><p><strong>任务通知（Task Notification）</strong></p><ul><li><strong>优势</strong>：比队列/信号量更快（减少内存拷贝），适用单任务同步。</li><li><strong>场景</strong>：高频率事件通知（如传感器数据到达）。</li></ul></li></ol><hr /><h3 id="四-中断与资源管理"><a class="markdownIt-Anchor" href="#四-中断与资源管理"></a> ⚡ 四、中断与资源管理</h3><ol><li><p><strong>ISR设计规范</strong></p><ul><li><strong>黄金法则</strong>：执行时间 <strong>&lt; 10μs</strong>，禁止调用 <code>printf()</code>、<code>malloc()</code>。</li><li><strong>安全通信</strong>：使用 <code>xQueueSendFromISR()</code> 代替普通队列API。</li></ul></li><li><p><strong>临界区保护</strong></p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">taskENTER_CRITICAL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 关中断</span><span class="token comment">// 操作共享资源（如全局变量）</span><span class="token function">taskEXIT_CRITICAL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 开中断</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><strong>注意</strong>：临界区代码不超过10条指令，避免破坏实时性。</p></li><li><p><strong>内存管理</strong></p><ul><li><strong>动态分配风险</strong>：碎片化导致分配失败（工业系统慎用）。</li><li><strong>替代方案</strong>：静态内存池（<code>xTaskCreateStatic()</code>）。</li></ul></li></ol><hr /><h3 id="️-五-开发实践与调试"><a class="markdownIt-Anchor" href="#️-五-开发实践与调试"></a> 🛠️ 五、开发实践与调试</h3><ol><li><p><strong>栈溢出检测</strong></p><ul><li><strong>方法1</strong>：检测栈指针越界（快但漏检率高）。</li><li><strong>方法2</strong>：栈底填充 <code>0xA5</code>，检测是否被修改（慢但更可靠）。</li></ul></li><li><p><strong>低功耗设计</strong></p><ul><li><strong>Tickless模式</strong>：空闲时停系统时钟，功耗降至μA级。</li><li><strong>实践场景</strong>：电池供电的物联网设备。</li></ul></li><li><p><strong>调试工具</strong></p><ul><li><strong>Tracealyzer</strong>：可视化任务调度时序。</li><li><strong>栈使用检测</strong>：<code>uxTaskGetStackHighWaterMark()</code> 获取栈峰值。</li></ul></li></ol><hr /><h3 id="附10道经典面试题含答案"><a class="markdownIt-Anchor" href="#附10道经典面试题含答案"></a> 💎 附：10道经典面试题（含答案）</h3><ol><li><p><strong>问：FreeRTOS中如何避免优先级反转？</strong><br /><strong>答</strong>：使用互斥锁（Mutex）并启用优先级继承机制。</p></li><li><p><strong>问：中断中能否调用 <code>xQueueSend()</code>？</strong><br /><strong>答</strong>：不能！必须用 <code>xQueueSendFromISR()</code>，否则引发数据竞争。</p></li><li><p><strong>问：任务栈大小如何确定？</strong><br /><strong>答</strong>：静态分析（局部变量+调用深度） + 动态检测（栈溢出钩子函数）。</p></li><li><p><strong>问：二值信号量与互斥量区别？</strong><br /><strong>答</strong>：互斥量支持优先级继承，二值信号量无此功能。</p></li></ol><blockquote><p><strong>持续巩固建议</strong>：</p><ol><li>动手实验：用STM32实现<strong>多任务温控系统</strong>（传感器任务→处理任务→显示任务）。</li><li>调试训练：开启栈溢出检测，故意缩小任务栈观察崩溃现象。</li><li>扩展学习：《Mastering FreeRTOS》第7章（同步机制深度解析）。</li></ol></blockquote>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> C++ </tag>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>每日知识点-28</title>
      <link href="/2025/07/02/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-28/"/>
      <url>/2025/07/02/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-28/</url>
      
        <content type="html"><![CDATA[<h2 id="每日知识点-28"><a class="markdownIt-Anchor" href="#每日知识点-28"></a> 每日知识点-28</h2><hr /><h3 id="一-交叉编译环境配置嵌入式开发基石"><a class="markdownIt-Anchor" href="#一-交叉编译环境配置嵌入式开发基石"></a> 一、交叉编译环境配置（嵌入式开发基石）</h3><h4 id="1-本地编译-vs-交叉编译"><a class="markdownIt-Anchor" href="#1-本地编译-vs-交叉编译"></a> 1. <strong>本地编译 vs 交叉编译</strong></h4><table><thead><tr><th><strong>特性</strong></th><th>本地编译</th><th>交叉编译</th></tr></thead><tbody><tr><td><strong>编译平台</strong></td><td>x86 PC</td><td>x86 PC</td></tr><tr><td><strong>目标平台</strong></td><td>x86 PC</td><td>ARM/MIPS/RISC-V等嵌入式设备</td></tr><tr><td><strong>工具链示例</strong></td><td><code>gcc</code></td><td><code>arm-linux-gnueabihf-gcc</code></td></tr><tr><td><strong>应用场景</strong></td><td>桌面应用开发</td><td>嵌入式设备程序开发</td></tr></tbody></table><h4 id="2-交叉编译工具链组成"><a class="markdownIt-Anchor" href="#2-交叉编译工具链组成"></a> 2. <strong>交叉编译工具链组成</strong></h4><ul><li><strong>核心工具</strong>：<ul><li><code>gcc</code>：C/C++编译器</li><li><code>ld</code>：链接器（控制内存布局）</li><li><code>objcopy</code>：生成烧录文件（如<code>.bin</code>）</li><li><code>gdb</code>：远程调试器</li><li><code>make</code>：自动化构建管理</li></ul></li></ul><h4 id="3-环境配置步骤以arm64为例"><a class="markdownIt-Anchor" href="#3-环境配置步骤以arm64为例"></a> 3. <strong>环境配置步骤（以ARM64为例）</strong></h4>   <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 永久配置（写入~/.bashrc）</span><span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token environment constant">$PATH</span>:~/arm-gnu-toolchain/bin<span class="token builtin class-name">export</span> <span class="token assign-left variable">CROSS_COMPILE</span><span class="token operator">=</span>aarch64-none-linux-gnu-<span class="token builtin class-name">export</span> <span class="token assign-left variable">ARCH</span><span class="token operator">=</span>arm64<span class="token comment"># 生效配置</span><span class="token builtin class-name">source</span> ~/.bashrc<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>验证命令</strong>：</p>   <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$&#123;CROSS_COMPILE&#125;</span>gcc <span class="token parameter variable">-v</span>  <span class="token comment"># 输出ARM工具链版本</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="4-cmake交叉编译配置"><a class="markdownIt-Anchor" href="#4-cmake交叉编译配置"></a> 4. <strong>CMake交叉编译配置</strong></h4>   <pre class="line-numbers language-cmake" data-language="cmake"><code class="language-cmake"><span class="token comment"># toolchain-arm.cmake</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token variable">CMAKE_SYSTEM_NAME</span> Linux<span class="token punctuation">)</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token variable">CMAKE_SYSTEM_PROCESSOR</span> arm<span class="token punctuation">)</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token variable">CMAKE_C_COMPILER</span> <span class="token punctuation">$&#123;</span>CROSS_COMPILE<span class="token punctuation">&#125;</span>gcc<span class="token punctuation">)</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token variable">CMAKE_CXX_COMPILER</span> <span class="token punctuation">$&#123;</span>CROSS_COMPILE<span class="token punctuation">&#125;</span>g++<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>编译命令</strong>：</p>   <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">cmake <span class="token parameter variable">-DCMAKE_TOOLCHAIN_FILE</span><span class="token operator">=</span><span class="token punctuation">..</span>/toolchain-arm.cmake <span class="token punctuation">..</span><span class="token function">make</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><strong>避坑点</strong>：禁用动态链接库（<code>-DBUILD_SHARED_LIBS=OFF</code>）减少依赖 。</p><hr /><h3 id="二-中断机制嵌入式系统的心跳"><a class="markdownIt-Anchor" href="#二-中断机制嵌入式系统的心跳"></a> 二、中断机制（嵌入式系统的“心跳”）</h3><h4 id="1-中断分类与特性"><a class="markdownIt-Anchor" href="#1-中断分类与特性"></a> 1. <strong>中断分类与特性</strong></h4><table><thead><tr><th><strong>类型</strong></th><th>触发方式</th><th>典型场景</th></tr></thead><tbody><tr><td><strong>外部硬件中断</strong></td><td>引脚电平变化（按键、传感器）</td><td>实时事件响应</td></tr><tr><td><strong>内部硬件中断</strong></td><td>定时器溢出/硬件异常</td><td>周期任务调度</td></tr><tr><td><strong>软件中断</strong></td><td>程序指令（如系统调用）</td><td>任务切换、系统服务</td></tr></tbody></table><h4 id="2-中断处理流程"><a class="markdownIt-Anchor" href="#2-中断处理流程"></a> 2. <strong>中断处理流程</strong></h4>   <pre class="line-numbers language-mermaid" data-language="mermaid"><code class="language-mermaid"><span class="token keyword">graph</span> LRA<span class="token text string">[中断触发]</span> <span class="token arrow operator">--></span> B<span class="token text string">[保存现场]</span>B <span class="token arrow operator">--></span> C<span class="token text string">[跳转至ISR]</span>C <span class="token arrow operator">--></span> D<span class="token text string">[执行中断服务程序]</span>D <span class="token arrow operator">--></span> E<span class="token text string">[恢复现场]</span>E <span class="token arrow operator">--></span> F<span class="token text string">[返回主程序]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>关键点</strong>：</p><ul><li><strong>中断向量表</strong>：存储ISR入口地址的数组（STM32中位于Flash起始地址）</li><li><strong>中断嵌套</strong>：高优先级中断可打断低优先级ISR</li></ul><h4 id="3-中断优先级管理"><a class="markdownIt-Anchor" href="#3-中断优先级管理"></a> 3. <strong>中断优先级管理</strong></h4><p><strong>配置原则</strong>（以STM32的NVIC为例）：</p>   <pre class="line-numbers language-c" data-language="c"><code class="language-c">NVIC_InitTypeDef nvic<span class="token punctuation">;</span>nvic<span class="token punctuation">.</span>NVIC_IRQChannel <span class="token operator">=</span> TIM2_IRQn<span class="token punctuation">;</span>          <span class="token comment">// 定时器2中断</span>nvic<span class="token punctuation">.</span>NVIC_IRQChannelPreemptionPriority <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 抢占优先级</span>nvic<span class="token punctuation">.</span>NVIC_IRQChannelSubPriority <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token comment">// 子优先级</span>nvic<span class="token punctuation">.</span>NVIC_IRQChannelCmd <span class="token operator">=</span> ENABLE<span class="token punctuation">;</span><span class="token function">NVIC_Init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>nvic<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>黄金法则</strong>：</p><ul><li>硬件外设（如ADC） &gt; 系统任务 &gt; 应用层任务</li><li>ISR执行时间 <strong>&lt; 10μs</strong>（避免阻塞后续中断）</li></ul><h4 id="4-isr设计规范"><a class="markdownIt-Anchor" href="#4-isr设计规范"></a> 4. <strong>ISR设计规范</strong></h4><ul><li><strong>禁止操作</strong>：<ul><li>调用阻塞函数（如<code>malloc</code>）</li><li>执行复杂算法（FFT/滤波）</li></ul></li><li><strong>必需操作</strong>：<ul><li>共享变量加<code>volatile</code>修饰</li><li>耗时操作移交主循环（通过标志位/队列）</li></ul></li></ul>   <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">volatile</span> <span class="token class-name">uint8_t</span> data_ready <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">// 中断与主程序共享变量</span><span class="token keyword">void</span> <span class="token function">UART_IRQHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    buffer<span class="token punctuation">[</span>rx_index<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> UART<span class="token operator">-></span>DR<span class="token punctuation">;</span> <span class="token comment">// 仅存数据</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>rx_index <span class="token operator">>=</span> BUFF_SIZE<span class="token punctuation">)</span> data_ready <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 通知主程序</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr /><h3 id="三-进阶面试题带答案"><a class="markdownIt-Anchor" href="#三-进阶面试题带答案"></a> 三、进阶面试题（带答案）</h3><ol><li><p><strong>问：为何ISR中不能调用<code>printf</code>？</strong><br /><strong>答</strong>：<code>printf</code>依赖系统调用和堆内存操作，可能阻塞或引发死锁。应改用环形缓冲区+主程序输出。</p></li><li><p><strong>问：交叉编译时出现“Unsupported architecture”错误如何解决？</strong><br /><strong>答</strong>：检查<code>ARCH</code>与<code>CROSS_COMPILE</code>是否匹配（如ARM32用<code>arm-linux-gnueabihf-</code>，ARM64用<code>aarch64-linux-gnu-</code>）。</p></li></ol><hr /><blockquote><p><strong>下期预告</strong>：</p><ul><li><strong>RTOS任务调度原理</strong>（含优先级反转解决方案）</li><li><strong>嵌入式驱动开发框架</strong>（字符设备/块设备驱动设计）<br />继续？请回复“下一模块”。 保持节奏，每天攻克一个核心模块！</li></ul></blockquote>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> C++ </tag>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>每日知识点-27</title>
      <link href="/2025/07/01/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-27/"/>
      <url>/2025/07/01/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-27/</url>
      
        <content type="html"><![CDATA[<h2 id="每日知识点-27"><a class="markdownIt-Anchor" href="#每日知识点-27"></a> 每日知识点-27</h2><hr /><h3 id="一-硬件基础与微控制器"><a class="markdownIt-Anchor" href="#一-硬件基础与微控制器"></a> 一、硬件基础与微控制器</h3><ol><li><p><strong>ARM vs DSP区别</strong></p><ul><li><strong>ARM</strong>：通用处理器，低功耗，高效流水线，适合多任务（如Linux系统）。</li><li><strong>DSP</strong>：专用信号处理器，硬件加速数学运算（如FFT），适合音视频处理。</li></ul></li><li><p><strong>NAND Flash vs NOR Flash</strong></p><table><thead><tr><th><strong>特性</strong></th><th>NAND Flash</th><th>NOR Flash</th></tr></thead><tbody><tr><td><strong>读取速度</strong></td><td>慢（按块读取）</td><td>快（随机访问）</td></tr><tr><td><strong>写入/擦除</strong></td><td>快</td><td>慢</td></tr><tr><td><strong>用途</strong></td><td>大容量存储（eMMC）</td><td>程序存储（Bootloader）</td></tr><tr><td><strong>接口</strong></td><td>复杂（需控制器）</td><td>直接寻址</td></tr></tbody></table></li><li><p><strong>CPU内核态与用户态</strong></p><ul><li><strong>内核态</strong>：可执行全部指令（如清内存），权限最高。</li><li><strong>用户态</strong>：仅执行子集指令，安全性高。<br /><strong>切换时机</strong>：系统调用、中断、异常。</li></ul></li></ol><hr /><h3 id="二-cc语言核心"><a class="markdownIt-Anchor" href="#二-cc语言核心"></a> 二、C/C++语言核心</h3><ol><li><p><strong>指针 vs 引用</strong></p><table><thead><tr><th><strong>特性</strong></th><th>指针</th><th>引用</th></tr></thead><tbody><tr><td><strong>初始化</strong></td><td>可为<code>nullptr</code></td><td>必须绑定有效对象</td></tr><tr><td><strong>重绑定</strong></td><td>支持</td><td>不支持</td></tr><tr><td><strong>内存占用</strong></td><td>额外存储地址</td><td>无额外内存</td></tr><tr><td><strong>操作</strong></td><td><code>*p</code>解引用，<code>&amp;p</code>取地址</td><td>直接操作原变量</td></tr></tbody></table></li><li><p><strong><code>const</code>修饰符用法</strong></p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">const</span> <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>          <span class="token comment">// 常量</span><span class="token keyword">const</span> <span class="token keyword">int</span><span class="token operator">*</span> p <span class="token operator">=</span> <span class="token operator">&amp;</span>a<span class="token punctuation">;</span>        <span class="token comment">// 常量指针（值不可改）</span><span class="token keyword">int</span><span class="token operator">*</span> <span class="token keyword">const</span> p <span class="token operator">=</span> <span class="token operator">&amp;</span>b<span class="token punctuation">;</span>        <span class="token comment">// 指针常量（地址不可改）</span><span class="token keyword">void</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>        <span class="token comment">// 成员函数不修改对象</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><strong>关键点</strong>：常量指针可重指向，指针常量不可重指向。</p></li><li><p><strong><code>volatile</code>作用</strong></p><ul><li>禁用编译器优化，强制每次从内存读取（用于多线程共享变量、硬件寄存器）。</li></ul><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">volatile</span> <span class="token keyword">uint32_t</span><span class="token operator">*</span> reg <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0x4000F000</span><span class="token punctuation">;</span>  <span class="token comment">// 硬件寄存器操作</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p><strong>智能指针对比</strong></p><table><thead><tr><th><strong>类型</strong></th><th>所有权</th><th>适用场景</th></tr></thead><tbody><tr><td><code>unique_ptr</code></td><td>独占</td><td>资源独占（如文件句柄）</td></tr><tr><td><code>shared_ptr</code></td><td>共享（计数）</td><td>多模块共享资源</td></tr><tr><td><code>weak_ptr</code></td><td>无（观察者）</td><td>打破循环引用</td></tr></tbody></table></li></ol><hr /><h3 id="三-操作系统与linux"><a class="markdownIt-Anchor" href="#三-操作系统与linux"></a> 三、操作系统与Linux</h3><ol><li><p><strong>进程 vs 线程</strong></p><table><thead><tr><th><strong>特性</strong></th><th>进程</th><th>线程</th></tr></thead><tbody><tr><td><strong>资源</strong></td><td>独立内存空间</td><td>共享进程内存</td></tr><tr><td><strong>创建开销</strong></td><td>大（需复制资源）</td><td>小</td></tr><tr><td><strong>通信开销</strong></td><td>高（需IPC）</td><td>低（直接共享变量）</td></tr><tr><td><strong>崩溃影响</strong></td><td>不影响其他进程</td><td>导致整个进程终止</td></tr></tbody></table></li><li><p><strong>进程状态转换</strong></p><ul><li><strong>R（运行）</strong> → <strong>S（睡眠）</strong>：等待I/O事件</li><li><strong>S</strong> → <strong>R</strong>：事件发生被唤醒</li><li><strong>R</strong> → <strong>Z（僵尸）</strong>：子进程终止未回收。</li></ul></li><li><p><strong>死锁条件与避免</strong><br /><strong>条件</strong>：互斥、占有且等待、不可抢占、循环等待。<br /><strong>方案</strong>：资源预分配、按固定顺序加锁。</p></li></ol><hr /><h3 id="四-数据结构与算法"><a class="markdownIt-Anchor" href="#四-数据结构与算法"></a> 四、数据结构与算法</h3><ol><li><p><strong>链表 vs 数组</strong></p><table><thead><tr><th><strong>操作</strong></th><th>链表</th><th>数组</th></tr></thead><tbody><tr><td><strong>随机访问</strong></td><td>O(n)</td><td>O(1)</td></tr><tr><td><strong>插入删除</strong></td><td>O(1)</td><td>O(n)</td></tr><tr><td><strong>内存连续性</strong></td><td>非连续</td><td>连续</td></tr></tbody></table></li><li><p><strong>快排 vs 堆排序</strong></p><ul><li><strong>快排</strong>：平均O(n log n)，原地排序，不稳定。</li><li><strong>堆排序</strong>：O(n log n)，空间O(1)，适合Top K问题。</li></ul></li><li><p><strong>判断链表有环</strong></p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">bool</span> <span class="token function">hasCycle</span><span class="token punctuation">(</span>ListNode<span class="token operator">*</span> head<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    ListNode <span class="token operator">*</span>slow <span class="token operator">=</span> head<span class="token punctuation">,</span> <span class="token operator">*</span>fast <span class="token operator">=</span> head<span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>fast <span class="token operator">&amp;&amp;</span> fast<span class="token operator">-></span>next<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        slow <span class="token operator">=</span> slow<span class="token operator">-></span>next<span class="token punctuation">;</span>        fast <span class="token operator">=</span> fast<span class="token operator">-></span>next<span class="token operator">-></span>next<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>slow <span class="token operator">==</span> fast<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>原理</strong>：快指针步长为2，慢指针为1，相遇即有环。</p></li></ol><hr /><h3 id="五-网络协议"><a class="markdownIt-Anchor" href="#五-网络协议"></a> 五、网络协议</h3><ol><li><p><strong>TCP vs UDP</strong></p><table><thead><tr><th><strong>特性</strong></th><th>TCP</th><th>UDP</th></tr></thead><tbody><tr><td><strong>连接</strong></td><td>面向连接（三次握手）</td><td>无连接</td></tr><tr><td><strong>可靠性</strong></td><td>可靠（重传、校验）</td><td>不可靠</td></tr><tr><td><strong>速度</strong></td><td>慢（拥塞控制）</td><td>快（低延迟）</td></tr><tr><td><strong>应用场景</strong></td><td>文件传输、HTTP</td><td>视频流、实时游戏</td></tr></tbody></table></li><li><p><strong>I²C总线设计</strong></p><ul><li><strong>开漏输出</strong>：避免总线冲突，支持“线与”逻辑。</li><li><strong>上拉电阻</strong>：确保空闲时SCL/SDA为高电平。</li></ul></li></ol><hr /><h3 id="六-嵌入式专项"><a class="markdownIt-Anchor" href="#六-嵌入式专项"></a> 六、嵌入式专项</h3><ol><li><p><strong>交叉编译配置</strong></p><pre class="line-numbers language-cmake" data-language="cmake"><code class="language-cmake"><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token variable">CMAKE_SYSTEM_NAME</span> Linux<span class="token punctuation">)</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token variable">CMAKE_C_COMPILER</span> arm-linux-gnueabihf-gcc<span class="token punctuation">)</span>  <span class="token comment"># ARM编译器</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token variable">CMAKE_SYSROOT</span> /opt/arm-sysroot<span class="token punctuation">)</span>            <span class="token comment"># 目标设备库</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><strong>避坑</strong>：禁用动态链接减少依赖（<code>-DBUILD_SHARED_LIBS=OFF</code>）。</p></li><li><p><strong>中断服务程序（ISR）规范</strong></p><ul><li>短于10μs，无系统调用（如<code>malloc</code>）。</li><li>共享变量用<code>volatile</code>修饰。</li></ul></li></ol><hr /><p><strong>附：八股文速记口诀</strong></p><ul><li><strong>硬件</strong>：“ARM通用DSP快，NAND大容NOR快读”</li><li><strong>C++</strong>：“指针可空引用绑，const左定右指方向”</li><li><strong>OS</strong>：“进程独立线程轻，死锁四条件记分明”</li><li><strong>网络</strong>：“TCP可靠UDP快，I²C上拉开漏在”</li></ul><blockquote><p>学习建议：</p><ol><li><strong>理解优先</strong>：结合代码实践（如手写<code>strcpy</code>）深化记忆。</li><li><strong>模块化复习</strong>：按硬件→语言→OS→算法→嵌入式顺序分块突破。</li><li><strong>真题演练</strong>：用牛客网/LeetCode刷嵌入式题库。</li></ol></blockquote>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> C++ </tag>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>每日知识点-26</title>
      <link href="/2025/06/30/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-26/"/>
      <url>/2025/06/30/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-26/</url>
      
        <content type="html"><![CDATA[<h2 id="每日知识点-26"><a class="markdownIt-Anchor" href="#每日知识点-26"></a> 每日知识点-26</h2><p>以下是针对<strong>实时音视频处理基础</strong>的10道进阶面试题，聚焦音视频同步、编解码优化、弱网对抗及WebRTC架构等核心模块，结合工业级应用场景设计。所有题目均提供可运行代码示例（C++/Python）及深度解析，符合应届生面试要求。</p><hr /><h3 id="一-音视频同步与采集"><a class="markdownIt-Anchor" href="#一-音视频同步与采集"></a> <strong>一、音视频同步与采集</strong></h3><h4 id="题目1音视频同步原理"><a class="markdownIt-Anchor" href="#题目1音视频同步原理"></a> <strong>题目1：音视频同步原理</strong></h4><p><strong>类型</strong>：简答题（<strong>同步机制-时间戳</strong>）<br /><strong>题目</strong>：实时音视频流中如何保证音频与视频的同步？时间戳的作用是什么？<br /><strong>参考答案</strong>：</p><ul><li><strong>同步机制</strong>：通过为每帧音视频数据添加<strong>精确时间戳</strong>，播放器根据时间差动态调整渲染节奏（如音频超前则延迟视频帧）。</li><li><strong>时间戳作用</strong>：标记数据采集时刻，解决网络抖动导致的音视频错位问题。若视频帧时间戳为<code>t_v</code>，音频帧为<code>t_a</code>，当<code>|t_v - t_a| &gt; 阈值</code>时触发同步补偿。</li></ul><p><strong>通俗解释</strong>：</p><blockquote><p>如同两人跑步，裁判（时间戳）记录每人到达时间。若A快于B，裁判让A稍等（延迟渲染），确保两人同时冲线（音画同步）。</p></blockquote><p><strong>技术解析</strong>：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// 伪代码：时间戳同步逻辑</span><span class="token keyword">if</span> <span class="token punctuation">(</span>audio_timestamp <span class="token operator">-</span> video_timestamp <span class="token operator">></span> SYNC_THRESHOLD<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    delay <span class="token operator">=</span> audio_timestamp <span class="token operator">-</span> video_timestamp<span class="token punctuation">;</span>    <span class="token function">sleep</span><span class="token punctuation">(</span>delay<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 延迟视频渲染</span><span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>video_timestamp <span class="token operator">-</span> audio_timestamp <span class="token operator">></span> SYNC_THRESHOLD<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">skip_video_frame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 丢弃滞后视频帧</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr /><h4 id="题目2android音视频采集优化"><a class="markdownIt-Anchor" href="#题目2android音视频采集优化"></a> <strong>题目2：Android音视频采集优化</strong></h4><p><strong>类型</strong>：编程题（<strong>设备控制-参数配置</strong>）<br /><strong>题目</strong>：在Android中设置摄像头采集参数（分辨率1080p、帧率30fps），并添加时间戳到视频帧。<br /><strong>参考答案</strong>：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 使用Camera2 API</span><span class="token class-name">CameraManager</span> manager <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">CameraManager</span><span class="token punctuation">)</span> <span class="token function">getSystemService</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">CAMERA_SERVICE</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">String</span> cameraId <span class="token operator">=</span> manager<span class="token punctuation">.</span><span class="token function">getCameraIdList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>manager<span class="token punctuation">.</span><span class="token function">openCamera</span><span class="token punctuation">(</span>cameraId<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">CameraDevice<span class="token punctuation">.</span>StateCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onOpened</span><span class="token punctuation">(</span><span class="token class-name">CameraDevice</span> camera<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">SurfaceTexture</span> texture <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span> <span class="token comment">// 创建SurfaceTexture</span>        <span class="token class-name">Surface</span> surface <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Surface</span><span class="token punctuation">(</span>texture<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">CaptureRequest<span class="token punctuation">.</span>Builder</span> builder <span class="token operator">=</span> camera<span class="token punctuation">.</span><span class="token function">createCaptureRequest</span><span class="token punctuation">(</span><span class="token class-name">CameraDevice</span><span class="token punctuation">.</span><span class="token constant">TEMPLATE_PREVIEW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        builder<span class="token punctuation">.</span><span class="token function">addTarget</span><span class="token punctuation">(</span>surface<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 设置参数</span>        builder<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">CaptureRequest</span><span class="token punctuation">.</span><span class="token constant">CONTROL_AE_TARGET_FPS_RANGE</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Range</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        builder<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">CaptureRequest</span><span class="token punctuation">.</span><span class="token constant">SCALER_CROP_REGION</span><span class="token punctuation">,</span>                     <span class="token keyword">new</span> <span class="token class-name">Rect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1920</span><span class="token punctuation">,</span> <span class="token number">1080</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1080p</span>        <span class="token comment">// 添加时间戳</span>        texture<span class="token punctuation">.</span><span class="token function">setOnFrameAvailableListener</span><span class="token punctuation">(</span>surfaceTexture <span class="token operator">-></span> <span class="token punctuation">&#123;</span>            <span class="token keyword">long</span> timestamp <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 纳秒级时间戳</span>            <span class="token function">processFrame</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>技术要点</strong>：</p><ul><li>高分辨率需平衡功耗：1080p比720p功耗增加40%</li><li>时间戳精度：<code>System.nanoTime()</code>误差&lt;1μs，满足实时同步需求</li></ul><hr /><h3 id="二-编解码优化实战"><a class="markdownIt-Anchor" href="#二-编解码优化实战"></a> <strong>二、编解码优化实战</strong></h3><h4 id="题目3h264编码优化策略"><a class="markdownIt-Anchor" href="#题目3h264编码优化策略"></a> <strong>题目3：H.264编码优化策略</strong></h4><p><strong>类型</strong>：选择题（<strong>算法优化-复杂度权衡</strong>）<br /><strong>题目</strong>：H.264快速帧间预测算法的核心优化思路是？<br />A. 减少运动搜索范围<br />B. 基于相邻块模式预测当前块<br />C. 跳过率失真开销低的模式<br />D. 以上全部<br /><strong>答案</strong>：D<br /><strong>解析</strong>：</p><ul><li><strong>A</strong>：缩小搜索窗减少90%计算量</li><li><strong>B</strong>：利用空间相关性跳过冗余模式检测</li><li><strong>C</strong>：RDcost阈值提前终止搜索，降低56%复杂度</li></ul><hr /><h4 id="题目4音频编解码选型"><a class="markdownIt-Anchor" href="#题目4音频编解码选型"></a> <strong>题目4：音频编解码选型</strong></h4><p><strong>类型</strong>：设计题（<strong>场景适配-编解码器</strong>）<br /><strong>题目</strong>：对比AAC与Opus编解码器在实时通话与音乐直播中的选型差异。<br /><strong>参考答案</strong>：</p><table><thead><tr><th><strong>特性</strong></th><th><strong>AAC</strong></th><th><strong>Opus</strong></th></tr></thead><tbody><tr><td><strong>延迟</strong></td><td>高（&gt;100ms）</td><td>低（20-60ms）</td></tr><tr><td><strong>音质</strong></td><td>音乐保真度高</td><td>语音优化，音乐稍逊</td></tr><tr><td><strong>适用场景</strong></td><td>直播、点播（非实时）</td><td>实时通话、游戏语音</td></tr></tbody></table><p><strong>技术依据</strong>：</p><ul><li>Opus支持动态码率（6kbps-510kbps），弱网自动降质</li><li>AAC硬件兼容性更广（TV/机顶盒）</li></ul><hr /><h3 id="三-传输协议与弱网对抗"><a class="markdownIt-Anchor" href="#三-传输协议与弱网对抗"></a> <strong>三、传输协议与弱网对抗</strong></h3><h4 id="题目5nat穿透原理"><a class="markdownIt-Anchor" href="#题目5nat穿透原理"></a> <strong>题目5：NAT穿透原理</strong></h4><p><strong>类型</strong>：简答题（<strong>网络协议-连接建立</strong>）<br /><strong>题目</strong>：WebRTC如何通过STUN/TURN实现NAT穿透？<br /><strong>参考答案</strong>：</p><ol><li><strong>STUN</strong>：客户端向公网STUN服务器查询自身公网IP:Port，用于直连。</li><li><strong>TURN</strong>：若直连失败（对称型NAT），通过TURN中继服务器转发数据，牺牲延迟保连通性。<br /><strong>性能影响</strong>：TURN转发增加30-50ms延迟，带宽成本高10倍。</li></ol><hr /><h4 id="题目6抗弱网编程实战"><a class="markdownIt-Anchor" href="#题目6抗弱网编程实战"></a> <strong>题目6：抗弱网编程实战</strong></h4><p><strong>类型</strong>：编程题（<strong>自适应策略-码率控制</strong>）<br /><strong>题目</strong>：实现基于网络带宽的动态视频码率调整（C++伪代码）。<br /><strong>参考答案</strong>：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// 网络带宽检测与码率调整</span><span class="token keyword">void</span> <span class="token function">adjust_bitrate</span><span class="token punctuation">(</span><span class="token keyword">int</span> current_bitrate<span class="token punctuation">,</span> <span class="token keyword">float</span> packet_loss_rate<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>packet_loss_rate <span class="token operator">></span> <span class="token number">0.1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 丢包率>10%</span>        current_bitrate <span class="token operator">*=</span> <span class="token number">0.7</span><span class="token punctuation">;</span>  <span class="token comment">// 降码率30%</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>packet_loss_rate <span class="token operator">&lt;</span> <span class="token number">0.01</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>         current_bitrate <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>max_bitrate<span class="token punctuation">,</span> current_bitrate <span class="token operator">*</span> <span class="token number">1.2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 升码率20%</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// 更新编码器参数</span>    video_encoder<span class="token punctuation">.</span><span class="token function">set_bitrate</span><span class="token punctuation">(</span>current_bitrate<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>优化点</strong>：</p><ul><li>结合<strong>前向纠错（FEC）</strong>：丢包率&gt;5%时添加冗余包</li><li><strong>码率阶梯</strong>：预设多档位（500k/1M/2M），避免频繁调整引起画质波动</li></ul><hr /><h3 id="四-webrtc架构深入"><a class="markdownIt-Anchor" href="#四-webrtc架构深入"></a> <strong>四、WebRTC架构深入</strong></h3><h4 id="题目7sfu-vs-mcu架构对比"><a class="markdownIt-Anchor" href="#题目7sfu-vs-mcu架构对比"></a> <strong>题目7：SFU vs MCU架构对比</strong></h4><p><strong>类型</strong>：设计题（<strong>系统架构-场景选型</strong>）<br /><strong>题目</strong>：设计千人直播课堂，选择SFU或MCU架构？说明原因。<br /><strong>参考答案</strong>：</p><pre class="line-numbers language-mermaid" data-language="mermaid"><code class="language-mermaid"><span class="token keyword">graph</span> LRA<span class="token text string">[教师端]</span> <span class="token arrow operator">--></span><span class="token label property">|推流|</span> B<span class="token text string">(SFU服务器)</span>B <span class="token arrow operator">--></span><span class="token label property">|转发|</span> C<span class="token text string">[学生1]</span>B <span class="token arrow operator">--></span><span class="token label property">|转发|</span> D<span class="token text string">[学生2]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><strong>选型</strong>：<strong>SFU架构</strong>（如Zoom方案）</p><ul><li><strong>原因</strong>：<ol><li><strong>扩展性</strong>：SFU仅转发流，千人并发时CPU占用&lt;20%，MCU混合流需百核级服务器。</li><li><strong>灵活性</strong>：学生端可选择性订阅教师/同学视频流（如分组讨论）。<br /><strong>劣势</strong>：教师上行带宽要求高（需同时推送多路流）</li></ol></li></ul><hr /><h4 id="题目8webrtc安全机制"><a class="markdownIt-Anchor" href="#题目8webrtc安全机制"></a> <strong>题目8：WebRTC安全机制</strong></h4><p><strong>类型</strong>：简答题（<strong>传输安全-加密方案</strong>）<br /><strong>题目</strong>：WebRTC如何通过DTLS-SRTP保障音视频数据安全？<br /><strong>参考答案</strong>：</p><ol><li><strong>密钥交换</strong>：通过DTLS握手生成会话密钥（类似HTTPS）。</li><li><strong>媒体加密</strong>：使用SRTP协议加密音视频数据，AES-128-GCM防篡改。<br /><strong>典型应用</strong>：医疗问诊中患者面部模糊+端到端加密</li></ol><hr /><h3 id="五-综合实战设计"><a class="markdownIt-Anchor" href="#五-综合实战设计"></a> <strong>五、综合实战设计</strong></h3><h4 id="题目9直播延迟优化策略"><a class="markdownIt-Anchor" href="#题目9直播延迟优化策略"></a> <strong>题目9：直播延迟优化策略</strong></h4><p><strong>类型</strong>：架构设计（<strong>性能优化-全链路</strong>）<br /><strong>题目</strong>：设计&lt;500ms超低延迟直播系统，列出3项关键技术。<br /><strong>参考答案</strong>：</p><ol><li><strong>编解码层</strong>：硬件编码（NVENC）降低编码延迟至10ms（软件编码50ms+）。</li><li><strong>传输层</strong>：QUIC协议替代TCP，减少握手延迟（1RTT vs 3RTT）。</li><li><strong>播放层</strong>：Jitter Buffer动态调整，抗网络抖动。</li></ol><hr /><h4 id="题目10实时教育系统设计"><a class="markdownIt-Anchor" href="#题目10实时教育系统设计"></a> <strong>题目10：实时教育系统设计</strong></h4><p><strong>类型</strong>：项目设计（<strong>场景融合-多技术整合</strong>）<br /><strong>题目</strong>：基于WebRTC实现实时互动课堂（音视频+白板同步）。<br /><strong>核心方案</strong>：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// 白板数据通道建立</span><span class="token keyword">auto</span> data_channel <span class="token operator">=</span> peer_connection<span class="token operator">-></span><span class="token function">CreateDataChannel</span><span class="token punctuation">(</span><span class="token string">"whiteboard"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>data_channel<span class="token operator">-></span><span class="token function">RegisterObserver</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">DataObserver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 监听绘图数据</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><strong>关键技术栈</strong>：</p><ul><li><strong>音视频</strong>：WebRTC原生API（getUserMedia, RTCPeerConnection）</li><li><strong>白板同步</strong>：WebSocket传输绘图指令（JSON格式）</li><li><strong>弱网优化</strong>：白板数据优先UDP传输，音视频降质保白板流畅</li></ul><hr /><h3 id="总结与薄弱项诊断"><a class="markdownIt-Anchor" href="#总结与薄弱项诊断"></a> <strong>总结与薄弱项诊断</strong></h3><table><thead><tr><th><strong>模块</strong></th><th><strong>核心考点</strong></th><th><strong>易错点</strong></th><th><strong>强化建议</strong></th></tr></thead><tbody><tr><td>音视频同步</td><td>时间戳机制、动态补偿策略</td><td>时间戳精度选择（毫秒/微秒）</td><td>实现同步补偿算法</td></tr><tr><td>编解码优化</td><td>H.264快速算法、编解码选型</td><td>混淆实时/非实时编解码场景</td><td>实测AAC与Opus延迟差异</td></tr><tr><td>传输协议</td><td>STUN/TURN穿透原理</td><td>对称型NAT识别失败</td><td>搭建NAT测试环境</td></tr><tr><td>WebRTC架构</td><td>SFU/MCU性能对比</td><td>忽略上行带宽瓶颈</td><td>压测SFU千人并发资源占用</td></tr></tbody></table><p><strong>明日预告</strong>：<strong>边缘计算与模型部署实战</strong></p><ul><li>核心内容：TensorRT推理优化、Jetson Nano部署技巧、端边云协同架构<br /><strong>实战任务</strong>：在Jetson Nano部署YOLOv8实时检测模型（需CUDA加速）</li></ul><blockquote><p>环境准备：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 安装WebRTC开发环境  </span><span class="token function">git</span> clone https://chromium.googlesource.com/chromium/tools/depot_tools.git  fetch <span class="token parameter variable">--nohooks</span> webrtc  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></blockquote>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> C++ </tag>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>每日知识点-25</title>
      <link href="/2025/06/27/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-25/"/>
      <url>/2025/06/27/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-25/</url>
      
        <content type="html"><![CDATA[<h2 id="每日知识点-25"><a class="markdownIt-Anchor" href="#每日知识点-25"></a> 每日知识点-25</h2><p>以下是针对<strong>跨平台模型部署</strong>的10道进阶面试题，聚焦ONNX、TVM、PMML等核心技术，结合边缘设备部署实战场景设计。</p><hr /><h3 id="一-onnx格式与运行时优化"><a class="markdownIt-Anchor" href="#一-onnx格式与运行时优化"></a> <strong>一、ONNX格式与运行时优化</strong></h3><h4 id="题目1onnx动态轴支持限制"><a class="markdownIt-Anchor" href="#题目1onnx动态轴支持限制"></a> <strong>题目1：ONNX动态轴支持限制</strong></h4><p><strong>类型</strong>：代码改错题（<strong>模型转换-动态输入</strong>）<br /><strong>题目</strong>：以下PyTorch转ONNX代码为何无法处理动态batch？如何修复？</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">dummy_input <span class="token operator">=</span> torch<span class="token punctuation">.</span>randn<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">224</span><span class="token punctuation">,</span> <span class="token number">224</span><span class="token punctuation">)</span>  <span class="token comment"># 固定batch=1</span>torch<span class="token punctuation">.</span>onnx<span class="token punctuation">.</span>export<span class="token punctuation">(</span>model<span class="token punctuation">,</span> dummy_input<span class="token punctuation">,</span> <span class="token string">"model.onnx"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><strong>参考答案</strong>：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 修复：声明动态维度</span>torch<span class="token punctuation">.</span>onnx<span class="token punctuation">.</span>export<span class="token punctuation">(</span>    model<span class="token punctuation">,</span>     dummy_input<span class="token punctuation">,</span>     <span class="token string">"model.onnx"</span><span class="token punctuation">,</span>    dynamic_axes<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"input"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">:</span> <span class="token string">"batch_size"</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>  <span class="token comment"># 允许batch维度动态变化</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>技术解析</strong>：</p><ul><li>ONNX默认生成静态计算图，需显式声明动态维度</li><li>应用场景：需处理变长输入的NLP模型部署（如BERT）</li></ul><hr /><h4 id="题目2onnx-runtime量化加速"><a class="markdownIt-Anchor" href="#题目2onnx-runtime量化加速"></a> <strong>题目2：ONNX Runtime量化加速</strong></h4><p><strong>类型</strong>：编程题（<strong>模型优化-量化部署</strong>）<br /><strong>题目</strong>：实现ONNX模型的动态INT8量化，并对比量化前后性能。</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> onnxruntime<span class="token punctuation">.</span>quantization <span class="token keyword">import</span> quantize_dynamic<span class="token punctuation">,</span> QuantType<span class="token comment"># FP32模型 → INT8量化</span>quantize_dynamic<span class="token punctuation">(</span><span class="token string">"model.onnx"</span><span class="token punctuation">,</span> <span class="token string">"model_int8.onnx"</span><span class="token punctuation">,</span> weight_type<span class="token operator">=</span>QuantType<span class="token punctuation">.</span>QUInt8<span class="token punctuation">)</span><span class="token comment"># 性能测试</span><span class="token keyword">import</span> timeitfp32_time <span class="token operator">=</span> timeit<span class="token punctuation">.</span>timeit<span class="token punctuation">(</span><span class="token keyword">lambda</span><span class="token punctuation">:</span> ort_session<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token string">"input"</span><span class="token punctuation">:</span> img<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> number<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">)</span>int8_time <span class="token operator">=</span> timeit<span class="token punctuation">.</span>timeit<span class="token punctuation">(</span><span class="token keyword">lambda</span><span class="token punctuation">:</span> quant_session<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token string">"input"</span><span class="token punctuation">:</span> img<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> number<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"加速比：</span><span class="token interpolation"><span class="token punctuation">&#123;</span>fp32_time<span class="token operator">/</span>int8_time<span class="token punctuation">:</span><span class="token format-spec">.1f</span><span class="token punctuation">&#125;</span></span><span class="token string">x"</span></span><span class="token punctuation">)</span>  <span class="token comment"># 典型值：1.3-2.0x</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>关键点</strong>：</p><ul><li>量化后模型体积减少60-70%，推理速度提升30%-100%</li><li>代价：精度下降约0.5-1%（需业务容忍）</li></ul><hr /><h3 id="二-tvm编译优化实践"><a class="markdownIt-Anchor" href="#二-tvm编译优化实践"></a> <strong>二、TVM编译优化实践</strong></h3><h4 id="题目3tvm算子融合原理"><a class="markdownIt-Anchor" href="#题目3tvm算子融合原理"></a> <strong>题目3：TVM算子融合原理</strong></h4><p><strong>类型</strong>：简答题（<strong>编译优化-计算图优化</strong>）<br /><strong>题目</strong>：解释TVM中<code>relay.transform.FuseOps</code>如何提升推理速度？<br /><strong>参考答案</strong>：</p><ol><li><strong>减少内存访问</strong>：将<code>Conv-BN-ReLU</code>合并为单算子，避免中间结果写回内存</li><li><strong>并行优化</strong>：融合后算子更易利用GPU并行性（如CUDA core/TensorCore）</li><li><strong>降低调度开销</strong>：减少kernel启动次数（从3次→1次）</li></ol><p><strong>应用场景</strong>：移动端GPU部署（如Adreno 660优化YOLOv8）</p><hr /><h4 id="题目4tvm-auto-scheduler实战"><a class="markdownIt-Anchor" href="#题目4tvm-auto-scheduler实战"></a> <strong>题目4：TVM Auto-Scheduler实战</strong></h4><p><strong>类型</strong>：设计题（<strong>编译优化-自动调优</strong>）<br /><strong>题目</strong>：为TVM添加Auto-Scheduler自动搜索最优计算策略。</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> tvm <span class="token keyword">import</span> auto_scheduler<span class="token comment"># 1. 创建搜索任务</span>task <span class="token operator">=</span> auto_scheduler<span class="token punctuation">.</span>SearchTask<span class="token punctuation">(</span>func<span class="token operator">=</span>my_relay_func<span class="token punctuation">,</span> target<span class="token operator">=</span><span class="token string">"cuda"</span><span class="token punctuation">)</span><span class="token comment"># 2. 自动搜索优化策略 (约需30分钟)</span>tune_option <span class="token operator">=</span> auto_scheduler<span class="token punctuation">.</span>TuningOptions<span class="token punctuation">(</span>    num_measure_trials<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">,</span>  <span class="token comment"># 搜索次数</span>    measure_callbacks<span class="token operator">=</span><span class="token punctuation">[</span>auto_scheduler<span class="token punctuation">.</span>RecordToFile<span class="token punctuation">(</span><span class="token string">"logs.json"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>task<span class="token punctuation">.</span>tune<span class="token punctuation">(</span>tune_option<span class="token punctuation">)</span><span class="token comment"># 3. 应用最优策略</span>sch<span class="token punctuation">,</span> args <span class="token operator">=</span> task<span class="token punctuation">.</span>apply_best<span class="token punctuation">(</span><span class="token string">"logs.json"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>优势</strong>：相比手动优化，性能提升20-50%</p><hr /><h3 id="三-边缘设备部署挑战"><a class="markdownIt-Anchor" href="#三-边缘设备部署挑战"></a> <strong>三、边缘设备部署挑战</strong></h3><h4 id="题目5树莓派部署yolov8的瓶颈"><a class="markdownIt-Anchor" href="#题目5树莓派部署yolov8的瓶颈"></a> <strong>题目5：树莓派部署YOLOv8的瓶颈</strong></h4><p><strong>类型</strong>：案例分析（<strong>边缘计算-资源约束</strong>）<br /><strong>题目</strong>：在树莓派4B（4GB RAM）部署YOLOv8s模型时OOM，给出3种解决方案。<br /><strong>参考答案</strong>：</p><ol><li><strong>模型量化</strong>：FP32→INT8（内存占用降至1/4）</li><li><strong>算子替换</strong>：将大kernel卷积拆分为分组卷积（减少峰值内存）</li><li><strong>内存预分配</strong>：TVM的<code>MemoryPlan</code>优化器提前分配共享内存</li></ol><p><strong>典型配置</strong>：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># TVM内存优化配置</span><span class="token keyword">with</span> tvm<span class="token punctuation">.</span>transform<span class="token punctuation">.</span>PassContext<span class="token punctuation">(</span>opt_level<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    lib <span class="token operator">=</span> relay<span class="token punctuation">.</span>build<span class="token punctuation">(</span>mod<span class="token punctuation">,</span> target<span class="token operator">=</span><span class="token string">"llvm -device=arm_cpu"</span><span class="token punctuation">,</span> params<span class="token operator">=</span>params<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><hr /><h4 id="题目6android端gpu兼容性"><a class="markdownIt-Anchor" href="#题目6android端gpu兼容性"></a> <strong>题目6：Android端GPU兼容性</strong></h4><p><strong>类型</strong>：选择题（<strong>移动端-硬件适配</strong>）<br /><strong>题目</strong>：为高通Adreno GPU优化模型时，应优先采用？<br />A. 启用TensorCore<br />B. 使用OpenCL后端<br />C. 增加线程块大小<br /><strong>答案</strong>：B<br /><strong>解析</strong>：</p><ul><li>Adreno不支持TensorCore（NVIDIA专属）</li><li>OpenCL是移动GPU通用标准（Vulkan备选）</li></ul><hr /><h3 id="四-部署格式对比"><a class="markdownIt-Anchor" href="#四-部署格式对比"></a> <strong>四、部署格式对比</strong></h3><h4 id="题目7onnx-vs-pmml适用场景"><a class="markdownIt-Anchor" href="#题目7onnx-vs-pmml适用场景"></a> <strong>题目7：ONNX vs PMML适用场景</strong></h4><p><strong>类型</strong>：简答题（<strong>部署格式-选型策略</strong>）<br /><strong>题目</strong>：对比ONNX与PMML在模型部署中的优劣。<br /><strong>参考答案</strong>：</p><table><thead><tr><th><strong>特性</strong></th><th><strong>ONNX</strong></th><th><strong>PMML</strong></th></tr></thead><tbody><tr><td><strong>模型支持</strong></td><td>深度学习模型（CNN/RNN）</td><td>传统ML模型（线性模型/树模型）</td></tr><tr><td><strong>硬件加速</strong></td><td>支持GPU/NPU</td><td>仅CPU</td></tr><tr><td><strong>部署复杂度</strong></td><td>需推理引擎（ONNX Runtime）</td><td>纯XML解析</td></tr></tbody></table><p><strong>选型建议</strong>：</p><ul><li>深度学习模型 → ONNX</li><li>逻辑回归/XGBoost → PMML</li></ul><hr /><h3 id="五-安全与性能平衡"><a class="markdownIt-Anchor" href="#五-安全与性能平衡"></a> <strong>五、安全与性能平衡</strong></h3><h4 id="题目8模型加密部署方案"><a class="markdownIt-Anchor" href="#题目8模型加密部署方案"></a> <strong>题目8：模型加密部署方案</strong></h4><p><strong>类型</strong>：设计题（<strong>部署安全-模型保护</strong>）<br /><strong>题目</strong>：设计端到端加密的TVM模型部署流程。<br /><strong>方案</strong>：</p><pre class="line-numbers language-mermaid" data-language="mermaid"><code class="language-mermaid"><span class="token keyword">graph</span> LRA<span class="token text string">[训练模型]</span> <span class="token arrow operator">--></span><span class="token label property">|AES-256加密|</span> B<span class="token text string">(加密模型文件)</span>B <span class="token arrow operator">--></span> C<span class="token text string">&#123;边缘设备&#125;</span>C <span class="token arrow operator">--></span><span class="token label property">|启动时解密|</span> D<span class="token text string">[TVM运行时]</span>D <span class="token arrow operator">--></span><span class="token label property">|内存锁定|</span> E<span class="token text string">[安全执行]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>技术栈</strong>：</p><ul><li>加密工具：OpenSSL加密<code>.so</code>文件</li><li>内存锁定：<code>mlock</code>系统调用防止换出</li></ul><hr /><h4 id="题目9多线程推理资源竞争"><a class="markdownIt-Anchor" href="#题目9多线程推理资源竞争"></a> <strong>题目9：多线程推理资源竞争</strong></h4><p><strong>类型</strong>：代码优化题（<strong>并发编程-资源竞争</strong>）<br /><strong>题目</strong>：修复以下TVM多线程推理的竞争问题：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 错误：共享runtime.Module</span><span class="token keyword">def</span> <span class="token function">infer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    output <span class="token operator">=</span> module<span class="token punctuation">.</span>run<span class="token punctuation">(</span>input_data<span class="token punctuation">)</span>  <span class="token comment"># 多线程同时调用</span><span class="token comment"># 修复：每个线程独立实例</span><span class="token keyword">class</span> <span class="token class-name">InferThread</span><span class="token punctuation">(</span>threading<span class="token punctuation">.</span>Thread<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>module <span class="token operator">=</span> tvm<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>load_module<span class="token punctuation">(</span><span class="token string">"model.so"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>关键点</strong>：TVM的<code>runtime.Module</code>非线程安全，需进程隔离或独立实例</p><hr /><h4 id="题目10web环境模型部署"><a class="markdownIt-Anchor" href="#题目10web环境模型部署"></a> <strong>题目10：Web环境模型部署</strong></h4><p><strong>类型</strong>：编程题（<strong>新兴场景-Web部署</strong>）<br /><strong>题目</strong>：用ONNX Runtime Web将模型部署至浏览器。</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">  <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> session <span class="token operator">=</span> <span class="token keyword">await</span> ort<span class="token punctuation">.</span>InferenceSession<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"model.onnx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> input <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ort<span class="token punctuation">.</span>Tensor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token number">224</span><span class="token operator">*</span><span class="token number">224</span><span class="token operator">*</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">224</span><span class="token punctuation">,</span><span class="token number">224</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> output <span class="token operator">=</span> <span class="token keyword">await</span> session<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string-property property">"input"</span><span class="token operator">:</span> input<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>优势</strong>：零服务端依赖，隐私数据不出浏览器</p><hr /><h3 id="知识图谱与薄弱项分析"><a class="markdownIt-Anchor" href="#知识图谱与薄弱项分析"></a> <strong>知识图谱与薄弱项分析</strong></h3><table><thead><tr><th><strong>模块</strong></th><th><strong>核心掌握点</strong></th><th><strong>面试频率</strong></th><th><strong>掌握建议</strong></th></tr></thead><tbody><tr><td>ONNX转换</td><td>动态轴/算子兼容性</td><td>⭐⭐⭐⭐</td><td>测试多输入尺寸场景</td></tr><tr><td>TVM优化</td><td>算子融合/Auto-Scheduler</td><td>⭐⭐⭐⭐</td><td>实践Roofline模型分析</td></tr><tr><td>边缘部署</td><td>内存优化/硬件适配</td><td>⭐⭐⭐⭐</td><td>树莓派实战YOLOv8部署</td></tr><tr><td>安全部署</td><td>模型加密/线程安全</td><td>⭐⭐</td><td>掌握基础AES加密原理</td></tr></tbody></table><p><strong>薄弱项强化</strong>：</p><ul><li><strong>动态输入支持</strong>：用可变输入测试ONNX模型（如batch=4/8）</li><li><strong>量化误差分析</strong>：对比FP32/INT8模型在边缘案例的精度差异</li></ul><p><strong>明日预告</strong>：<strong>实时音视频处理基础</strong></p><ul><li>核心内容：WebRTC架构、H.264编码优化、音频降噪算法</li><li>实战任务：基于GStreamer实现实时滤镜应用</li></ul><blockquote><p>环境准备：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 安装ONNX Runtime跨平台库  </span>pip <span class="token function">install</span> onnxruntime <span class="token comment"># CPU  </span>pip <span class="token function">install</span> onnxruntime-gpu <span class="token comment"># NVIDIA GPU  </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></blockquote>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> C++ </tag>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>每日知识点-24</title>
      <link href="/2025/06/26/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-24/"/>
      <url>/2025/06/26/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-24/</url>
      
        <content type="html"><![CDATA[<h2 id="每日知识点-24"><a class="markdownIt-Anchor" href="#每日知识点-24"></a> 每日知识点-24</h2><p>以下是针对<strong>AI模型部署基础</strong>的进阶学习内容，聚焦模型转换、推理优化及边缘部署三大核心模块，结合面试高频考点设计10道实战题目。所有代码均基于C++17标准，可在Linux x86环境（需安装ONNX Runtime/TensorRT）编译运行。</p><hr /><h3 id="一-模型转换与格式"><a class="markdownIt-Anchor" href="#一-模型转换与格式"></a> <strong>一、模型转换与格式</strong></h3><h4 id="题目1onnx模型导出陷阱"><a class="markdownIt-Anchor" href="#题目1onnx模型导出陷阱"></a> <strong>题目1：ONNX模型导出陷阱</strong></h4><p><strong>类型</strong>：代码改错题（<strong>模型转换-算子兼容</strong>）<br /><strong>题目</strong>：以下PyTorch模型导出ONNX时报错，如何修复？</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Model</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>x<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 动态维度操作</span>torch<span class="token punctuation">.</span>onnx<span class="token punctuation">.</span>export<span class="token punctuation">(</span>model<span class="token punctuation">,</span> torch<span class="token punctuation">.</span>randn<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">224</span><span class="token punctuation">,</span><span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"model.onnx"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>答案</strong>：</p><ul><li><strong>错误原因</strong>：ONNX要求静态图，不支持动态操作（如<code>x.shape[0]</code>）</li><li><strong>修复方案</strong>：使用输入占位符或固定batch size</li></ul><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 添加动态轴声明</span>torch<span class="token punctuation">.</span>onnx<span class="token punctuation">.</span>export<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> dynamic_axes<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"input"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">:</span> <span class="token string">"batch_size"</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><strong>技术解析</strong>：</p><ul><li>ONNX将模型转换为<strong>计算图</strong>，要求所有张量形状可推导</li><li>动态轴需显式声明（如<code>batch_size</code>维度）</li></ul><hr /><h4 id="题目2onnx模型优化器原理"><a class="markdownIt-Anchor" href="#题目2onnx模型优化器原理"></a> <strong>题目2：ONNX模型优化器原理</strong></h4><p><strong>类型</strong>：简答题（<strong>模型优化-图优化</strong>）<br /><strong>题目</strong>：ONNX Runtime的Graph Optimization Phase作用是什么？举例两种优化策略。<br /><strong>参考答案</strong>：</p><ol><li><strong>常量折叠</strong>：将计算图中的常量表达式预计算（如<code>Conv-&gt;Add-&gt;Relu</code>合并）</li><li><strong>冗余节点消除</strong>：删除恒等操作（如<code>Add(0,x)</code>→<code>x</code>）<br /><strong>应用场景</strong>：移动端部署时减少30%+计算量</li></ol><hr /><h3 id="二-推理引擎核心机制"><a class="markdownIt-Anchor" href="#二-推理引擎核心机制"></a> <strong>二、推理引擎核心机制</strong></h3><h4 id="题目3tensorrt层融合策略"><a class="markdownIt-Anchor" href="#题目3tensorrt层融合策略"></a> <strong>题目3：TensorRT层融合策略</strong></h4><p><strong>类型</strong>：选择题（<strong>推理优化-算子融合</strong>）<br /><strong>题目</strong>：TensorRT将<code>Conv-&gt;BN-&gt;ReLU</code>融合为单一层的主要原因？<br />A. 减少内存访问延迟<br />B. 避免中间结果存储<br />C. 两者都是<br /><strong>答案</strong>：C<br /><strong>原理</strong>：</p><ul><li>融合后只需1次内存读写（原需3次）</li><li>计算公式合并为：<code>ReLU(BN(Conv(x))) = max(0, γ*(Conv(x)-μ)/σ + β)</code></li></ul><hr /><h4 id="题目4int8量化校准"><a class="markdownIt-Anchor" href="#题目4int8量化校准"></a> <strong>题目4：INT8量化校准</strong></h4><p><strong>类型</strong>：编程题（<strong>模型量化-精度校准</strong>）<br /><strong>题目</strong>：实现TensorRT的INT8校准器基类，生成量化尺度因子。</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">Int8EntropyCalibrator</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">IInt8EntropyCalibrator2</span></span> <span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token function">Int8EntropyCalibrator</span><span class="token punctuation">(</span><span class="token keyword">const</span> vector<span class="token operator">&lt;</span>string<span class="token operator">></span><span class="token operator">&amp;</span> calibData<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">data</span><span class="token punctuation">(</span>calibData<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token keyword">int</span> <span class="token function">getBatchSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">override</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>    <span class="token keyword">bool</span> <span class="token function">getBatch</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> bindings<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> names<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">int</span> nbBindings<span class="token punctuation">)</span> <span class="token keyword">override</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>idx <span class="token operator">>=</span> data<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        bindings<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">loadImage</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span>idx<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 加载校准图像</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">const</span> <span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">readCalibrationCache</span><span class="token punctuation">(</span>size_t<span class="token operator">&amp;</span> length<span class="token punctuation">)</span> <span class="token keyword">override</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">&#125;</span> <span class="token comment">// 读取缓存</span><span class="token keyword">private</span><span class="token operator">:</span>    vector<span class="token operator">&lt;</span>string<span class="token operator">></span> data<span class="token punctuation">;</span>    <span class="token keyword">int</span> idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>关键点</strong>：</p><ul><li>校准过程需<strong>统计激活值分布</strong>（KL散度确定最优缩放因子）</li><li>缓存机制加速二次部署</li></ul><hr /><h3 id="三-边缘部署优化"><a class="markdownIt-Anchor" href="#三-边缘部署优化"></a> <strong>三、边缘部署优化</strong></h3><h4 id="题目5mobilenet轻量化设计"><a class="markdownIt-Anchor" href="#题目5mobilenet轻量化设计"></a> <strong>题目5：MobileNet轻量化设计</strong></h4><p><strong>类型</strong>：简答题（<strong>边缘计算-模型压缩</strong>）<br /><strong>题目</strong>：MobileNetV2的倒残差结构(Inverted Residual)如何平衡精度与速度？<br /><strong>参考答案</strong>：</p><ol><li><strong>扩展层</strong>：1x1卷积升维（增加特征表达能力）</li><li><strong>深度可分离卷积</strong>：3x3卷积处理空间信息（减少计算量）</li><li><strong>跳跃连接</strong>：保留原始特征（避免梯度消失）<br /><strong>效果</strong>：比标准卷积减少10倍计算量</li></ol><hr /><h4 id="题目6模型剪枝实战"><a class="markdownIt-Anchor" href="#题目6模型剪枝实战"></a> <strong>题目6：模型剪枝实战</strong></h4><p><strong>类型</strong>：设计题（<strong>模型压缩-结构化剪枝</strong>）<br /><strong>题目</strong>：设计基于敏感度的卷积层剪枝策略，移除冗余滤波器。<br /><strong>方案</strong>：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">for</span> layer <span class="token keyword">in</span> model<span class="token punctuation">.</span>conv_layers<span class="token punctuation">:</span>    output <span class="token operator">=</span> layer<span class="token punctuation">(</span>output<span class="token punctuation">)</span>    loss <span class="token operator">=</span> criterion<span class="token punctuation">(</span>output<span class="token punctuation">,</span> target<span class="token punctuation">)</span>    loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>    sensitivity <span class="token operator">=</span> torch<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>layer<span class="token punctuation">.</span>weight<span class="token punctuation">.</span>grad<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 计算滤波器敏感度</span>    prune_idx <span class="token operator">=</span> torch<span class="token punctuation">.</span>argsort<span class="token punctuation">(</span>sensitivity<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token builtin">int</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token operator">*</span><span class="token builtin">len</span><span class="token punctuation">(</span>sensitivity<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>  <span class="token comment"># 剪枝50%</span>    layer<span class="token punctuation">.</span>weight<span class="token punctuation">.</span>data<span class="token punctuation">[</span>prune_idx<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>  <span class="token comment"># 置零滤波器</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>优化点</strong>：敏感度低的滤波器对结果影响小，优先剪枝</p><hr /><h3 id="四-部署工程实践"><a class="markdownIt-Anchor" href="#四-部署工程实践"></a> <strong>四、部署工程实践</strong></h3><h4 id="题目7多线程推理优化"><a class="markdownIt-Anchor" href="#题目7多线程推理优化"></a> <strong>题目7：多线程推理优化</strong></h4><p><strong>类型</strong>：编程题（<strong>部署优化-并发</strong>）<br /><strong>题目</strong>：用C++实现ONNX Runtime的多线程推理管道，避免资源竞争。</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;onnxruntime_cxx_api.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;mutex></span></span><span class="token keyword">class</span> <span class="token class-name">InferencePool</span> <span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token function">InferencePool</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> model_path<span class="token punctuation">,</span> <span class="token keyword">int</span> thread_num<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>thread_num<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            sessions<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span><span class="token class-name">Ort</span><span class="token double-colon punctuation">::</span><span class="token function">Env</span><span class="token punctuation">(</span>ORT_LOGGING_LEVEL_WARNING<span class="token punctuation">,</span> <span class="token string">"pool"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                  model_path<span class="token punctuation">,</span> Ort<span class="token double-colon punctuation">::</span>SessionOptions<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">float</span><span class="token operator">*</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token keyword">int</span> thread_id<span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token operator">*</span> input<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span>mtx<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 加锁避免多线程写输入冲突</span>        <span class="token keyword">auto</span><span class="token operator">&amp;</span> session <span class="token operator">=</span> sessions<span class="token punctuation">[</span>thread_id<span class="token punctuation">]</span><span class="token punctuation">;</span>        Ort<span class="token double-colon punctuation">::</span>Value input_tensor <span class="token operator">=</span> Ort<span class="token double-colon punctuation">::</span>Value<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">CreateTensor</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> session<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>Ort<span class="token double-colon punctuation">::</span>RunOptions<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>input_tensor<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token keyword">private</span><span class="token operator">:</span>    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>Ort<span class="token double-colon punctuation">::</span>Session<span class="token operator">></span> sessions<span class="token punctuation">;</span>    std<span class="token double-colon punctuation">::</span>mutex mtx<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>注意事项</strong>：</p><ul><li>每个线程独立<code>Ort::Session</code>，避免推理阻塞</li><li>输入/输出缓冲区需加锁</li></ul><hr /><h4 id="题目8模型内存复用"><a class="markdownIt-Anchor" href="#题目8模型内存复用"></a> <strong>题目8：模型内存复用</strong></h4><p><strong>类型</strong>：代码优化题（<strong>部署优化-内存管理</strong>）<br /><strong>题目</strong>：优化以下TensorRT推理代码的内存占用：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">float</span><span class="token operator">*</span> input <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">224</span><span class="token operator">*</span><span class="token number">224</span><span class="token operator">*</span><span class="token number">3</span><span class="token operator">*</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">float</span><span class="token operator">*</span> output <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token operator">*</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>context<span class="token operator">-></span><span class="token function">enqueueV2</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>input<span class="token punctuation">,</span> <span class="token operator">&amp;</span>output<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 原始版本</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><strong>优化方案</strong>：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">void</span><span class="token operator">*</span> buffers<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token function">cudaMalloc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buffers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> input_size<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 输入显存</span><span class="token function">cudaMalloc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buffers<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> output_size<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出显存</span>context<span class="token operator">-></span><span class="token function">enqueueV2</span><span class="token punctuation">(</span>buffers<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 零拷贝</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><strong>技术解析</strong>：</p><ul><li><strong>显存预分配</strong>：避免每次推理申请/释放</li><li><strong>零拷贝</strong>：数据直接在设备间传输</li></ul><hr /><h3 id="五-边缘设备部署"><a class="markdownIt-Anchor" href="#五-边缘设备部署"></a> <strong>五、边缘设备部署</strong></h3><h4 id="题目9nvidia-jetson性能调优"><a class="markdownIt-Anchor" href="#题目9nvidia-jetson性能调优"></a> <strong>题目9：NVIDIA Jetson性能调优</strong></h4><p><strong>类型</strong>：简答题（<strong>边缘设备-功耗优化</strong>）<br /><strong>题目</strong>：Jetson Nano部署模型时如何平衡功耗与帧率？列举3种手段。<br /><strong>参考答案</strong>：</p><ol><li><strong>DVFS调控</strong>：动态调整CPU/GPU频率（<code>sudo jetson_clocks</code>禁用自动调频）</li><li><strong>TensorCore启用</strong>：FP16精度提升2倍吞吐（TensorRT设置<code>fp16Mode=true</code>）</li><li><strong>流水线并行</strong>：分离图像预处理与推理到不同硬件（GPU推理+CPU预处理）</li></ol><hr /><h4 id="题目10模型加密部署"><a class="markdownIt-Anchor" href="#题目10模型加密部署"></a> <strong>题目10：模型加密部署</strong></h4><p><strong>类型</strong>：设计题（<strong>部署安全-模型保护</strong>）<br /><strong>题目</strong>：设计端到端加密推理流程，防止边缘设备模型被窃取。<br /><strong>方案</strong>：</p><pre class="line-numbers language-mermaid" data-language="mermaid"><code class="language-mermaid"><span class="token keyword">graph</span> LRA<span class="token text string">[加密模型]</span> <span class="token arrow operator">--></span><span class="token label property">|AES-256加密|</span> B<span class="token text string">(边缘设备)</span>B <span class="token arrow operator">--></span><span class="token label property">|运行时解密|</span> C<span class="token text string">[安全内存加载]</span>C <span class="token arrow operator">--></span> D<span class="token text string">&#123;可信执行环境 TEE&#125;</span>D <span class="token arrow operator">--></span><span class="token label property">|解密后推理|</span> E<span class="token text string">[输出结果]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>技术栈</strong>：</p><ul><li><strong>加密工具</strong>：OpenSSL加密ONNX模型</li><li><strong>TEE环境</strong>：ARM TrustZone隔离内存区域</li></ul><hr /><h3 id="总结与薄弱点"><a class="markdownIt-Anchor" href="#总结与薄弱点"></a> <strong>总结与薄弱点</strong></h3><table><thead><tr><th><strong>模块</strong></th><th><strong>核心能力</strong></th><th><strong>面试权重</strong></th></tr></thead><tbody><tr><td>模型转换</td><td>ONNX动态轴/算子兼容</td><td>⭐⭐⭐⭐</td></tr><tr><td>推理优化</td><td>TensorRT融合/INT8校准</td><td>⭐⭐⭐⭐⭐</td></tr><tr><td>边缘部署</td><td>轻量化设计/功耗平衡</td><td>⭐⭐⭐⭐</td></tr><tr><td>部署安全</td><td>模型加密/TEE</td><td>⭐⭐</td></tr></tbody></table><p><strong>明日预告</strong>：<strong>跨平台模型部署实战</strong></p><ul><li>核心内容：TVM跨平台编译、ROS嵌入式部署、WebAssembly浏览器推理<br /><strong>实战任务</strong>：用ONNX Runtime部署YOLOv8到树莓派（需交叉编译）</li></ul><blockquote><p>环境准备：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 安装ONNX Runtime  </span><span class="token function">git</span> clone <span class="token parameter variable">--recursive</span> https://github.com/microsoft/onnxruntime  ./build.sh <span class="token parameter variable">--config</span> Release <span class="token parameter variable">--build_shared_lib</span> <span class="token parameter variable">--parallel</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></blockquote>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> C++ </tag>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>每日知识点-23</title>
      <link href="/2025/06/25/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-23/"/>
      <url>/2025/06/25/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-23/</url>
      
        <content type="html"><![CDATA[<h2 id="每日知识点-23"><a class="markdownIt-Anchor" href="#每日知识点-23"></a> 每日知识点-23</h2><p>以下是针对<strong>高级I/O模型</strong>（零拷贝、sendfile、splice）的10道精选面试题，结合Linux系统调用与高性能服务器开发场景设计。所有题目均提供参考答案、通俗解释、技术解析及实际应用场景，代码基于标准C/C++语法，可在Linux环境（GCC 9+）编译运行。</p><hr /><h3 id="一-零拷贝核心原理"><a class="markdownIt-Anchor" href="#一-零拷贝核心原理"></a> <strong>一、零拷贝核心原理</strong></h3><h4 id="题目1传统io与零拷贝对比"><a class="markdownIt-Anchor" href="#题目1传统io与零拷贝对比"></a> <strong>题目1：传统I/O与零拷贝对比</strong></h4><p><strong>类型</strong>：简答题（<strong>I/O模型-性能优化</strong>）<br /><strong>题目</strong>：传统文件传输到网络需几次数据拷贝？零拷贝如何优化？<br /><strong>参考答案</strong>：</p><ul><li><strong>传统I/O</strong>：4次拷贝 + 4次上下文切换<br />磁盘 → 内核缓冲区（DMA）→ 用户缓冲区（CPU拷贝）→ Socket缓冲区（CPU拷贝）→ 网卡（DMA）</li><li><strong>零拷贝（sendfile）</strong>：2次拷贝 + 2次上下文切换<br />磁盘 → 内核缓冲区（DMA）→ 网卡（DMA）</li></ul><p><strong>通俗解释</strong>：</p><blockquote><p>传统方式像搬家：货物（数据）从仓库（磁盘）搬到卡车（网卡）需经中转站（用户缓冲区），工人（CPU）手动搬运两次；零拷贝则用传送带（DMA）直接从仓库送到卡车，工人只指挥不搬货。</p></blockquote><p><strong>技术解析</strong>：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// sendfile实现零拷贝</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/sendfile.h></span></span><span class="token class-name">ssize_t</span> <span class="token function">sendfile</span><span class="token punctuation">(</span><span class="token keyword">int</span> out_fd<span class="token punctuation">,</span> <span class="token keyword">int</span> in_fd<span class="token punctuation">,</span> <span class="token class-name">off_t</span> <span class="token operator">*</span>offset<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><strong>应用场景</strong>：<br />Web服务器传输静态文件（如Nginx大文件下载）。</p><hr /><h4 id="题目2sendfile系统调用限制"><a class="markdownIt-Anchor" href="#题目2sendfile系统调用限制"></a> <strong>题目2：sendfile系统调用限制</strong></h4><p><strong>类型</strong>：选择题（<strong>系统调用-文件传输</strong>）<br /><strong>题目</strong>：以下哪项是<code>sendfile</code>的局限性？<br />A. 仅支持文件到Socket传输<br />B. 不支持大于2GB的文件<br />C. 需手动管理文件偏移量<br />D. 以上全部<br /><strong>答案</strong>：D<br /><strong>解析</strong>：</p><ul><li><code>sendfile</code>要求目标fd必须是Socket，源fd必须是文件；</li><li>32位系统默认偏移量类型<code>off_t</code>为4字节（最大2GB），需用<code>sendfile64</code>；</li><li>偏移量参数<code>offset</code>需手动更新。</li></ul><hr /><h3 id="二-高级零拷贝技术"><a class="markdownIt-Anchor" href="#二-高级零拷贝技术"></a> <strong>二、高级零拷贝技术</strong></h3><h4 id="题目3mmapwrite伪零拷贝"><a class="markdownIt-Anchor" href="#题目3mmapwrite伪零拷贝"></a> <strong>题目3：mmap+write伪零拷贝</strong></h4><p><strong>类型</strong>：代码分析（<strong>内存映射-部分零拷贝</strong>）<br /><strong>题目</strong>：分析以下代码是否实现零拷贝？</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"file.txt"</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token operator">*</span>buf <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> size<span class="token punctuation">,</span> PROT_READ<span class="token punctuation">,</span> MAP_PRIVATE<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">write</span><span class="token punctuation">(</span>socket_fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><strong>答案</strong>：<strong>部分零拷贝</strong>（减少1次CPU拷贝）<br /><strong>技术解析</strong>：</p><ul><li><code>mmap</code>将文件映射到用户空间虚拟地址，省去内核缓冲区→用户缓冲区的拷贝；</li><li>但<code>write</code>仍需将数据从用户空间拷贝到Socket缓冲区。</li></ul><p><strong>应用场景</strong>：需修改文件内容后再发送的场景（如加密文件传输）。</p><hr /><h4 id="题目4splice系统调用原理"><a class="markdownIt-Anchor" href="#题目4splice系统调用原理"></a> <strong>题目4：splice系统调用原理</strong></h4><p><strong>类型</strong>：简答题（<strong>管道传输-零拷贝</strong>）<br /><strong>题目</strong>：<code>splice</code>如何实现任意fd间零拷贝传输？<br /><strong>参考答案</strong>：<br /><strong>核心机制</strong>：</p><ul><li>通过<strong>管道缓冲区</strong>（pipe buffer）中转数据；</li><li>数据在内核空间流动，无需拷贝到用户空间。<br /><strong>示例代码</strong>：</li></ul><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> pipefd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token function">pipe</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 文件→管道</span><span class="token function">splice</span><span class="token punctuation">(</span>file_fd<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> size<span class="token punctuation">,</span> SPLICE_F_MOVE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 管道→Socket</span><span class="token function">splice</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> socket_fd<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> size<span class="token punctuation">,</span> SPLICE_F_MOVE<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>优势</strong>：支持Socket到Socket、管道到文件等灵活传输。</p><hr /><h3 id="三-性能优化实战"><a class="markdownIt-Anchor" href="#三-性能优化实战"></a> <strong>三、性能优化实战</strong></h3><h4 id="题目5零拷贝适用场景判断"><a class="markdownIt-Anchor" href="#题目5零拷贝适用场景判断"></a> <strong>题目5：零拷贝适用场景判断</strong></h4><p><strong>类型</strong>：案例分析（<strong>I/O优化-场景适配</strong>）<br /><strong>题目</strong>：某视频网站需实时转码并传输视频流，能否用<code>sendfile</code>？为什么？<br /><strong>答案</strong>：<strong>不能</strong><br /><strong>解析</strong>：</p><ul><li><code>sendfile</code>要求传输<strong>原始数据</strong>，而转码需修改数据，必须拷贝到用户空间处理；</li><li>应改用<code>mmap</code>映射文件到用户空间，转码后再用<code>write</code>发送。</li></ul><hr /><h4 id="题目6dma与零拷贝关系"><a class="markdownIt-Anchor" href="#题目6dma与零拷贝关系"></a> <strong>题目6：DMA与零拷贝关系</strong></h4><p><strong>类型</strong>：简答题（<strong>硬件协作-零拷贝</strong>）<br /><strong>题目</strong>：零拷贝技术是否完全无需CPU参与数据传输？<br /><strong>答案</strong>：<strong>否</strong><br /><strong>原理</strong>：</p><ul><li>CPU不参与<strong>数据搬运</strong>，但仍需<strong>发起传输指令</strong>；</li><li>DMA（直接内存访问）负责实际数据移动，CPU仅调度。<br /><strong>流程对比</strong>：<br />| 步骤          | CPU参与度          |<br />|---------------|-------------------|<br />| 传统I/O       | 高（多次拷贝）     |<br />| 零拷贝        | 低（仅调度）       |</li></ul><hr /><h3 id="四-编程与调试"><a class="markdownIt-Anchor" href="#四-编程与调试"></a> <strong>四、编程与调试</strong></h3><h4 id="题目7sendfile传输大文件"><a class="markdownIt-Anchor" href="#题目7sendfile传输大文件"></a> <strong>题目7：sendfile传输大文件</strong></h4><p><strong>类型</strong>：编程题（<strong>系统调用-错误处理</strong>）<br /><strong>题目</strong>：用<code>sendfile</code>传输2GB文件，解决偏移量溢出问题。<br /><strong>参考答案</strong>：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/sendfile.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> file_fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"bigfile.iso"</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> sock_fd <span class="token operator">=</span> <span class="token comment">/* 已连接Socket */</span><span class="token punctuation">;</span>    <span class="token class-name">off_t</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token class-name">size_t</span> total_size <span class="token operator">=</span> <span class="token number">2LL</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">;</span> <span class="token comment">// 2GB</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>total_size <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">ssize_t</span> sent <span class="token operator">=</span> <span class="token function">sendfile</span><span class="token punctuation">(</span>sock_fd<span class="token punctuation">,</span> file_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">,</span> total_size<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>sent <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* 处理错误 */</span> <span class="token punctuation">&#125;</span>        total_size <span class="token operator">-=</span> sent<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">close</span><span class="token punctuation">(</span>file_fd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>关键点</strong>：</p><ul><li>循环调用<code>sendfile</code>并更新<code>offset</code>，避免32位溢出。</li></ul><hr /><h4 id="题目8splice非阻塞传输"><a class="markdownIt-Anchor" href="#题目8splice非阻塞传输"></a> <strong>题目8：splice非阻塞传输</strong></h4><p><strong>类型</strong>：代码改错（<strong>管道-非阻塞I/O</strong>）<br /><strong>题目</strong>：修复以下<code>splice</code>代码的阻塞问题：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">splice</span><span class="token punctuation">(</span>file_fd<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> size<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 阻塞若管道满</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><strong>修复方案</strong>：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// 设置管道非阻塞</span><span class="token function">fcntl</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> F_SETFL<span class="token punctuation">,</span> O_NONBLOCK<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">splice</span><span class="token punctuation">(</span>file_fd<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> size<span class="token punctuation">,</span> SPLICE_F_NONBLOCK<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><strong>技术解析</strong>：</p><ul><li><code>SPLICE_F_NONBLOCK</code>确保<code>splice</code>在管道满时立即返回<code>EAGAIN</code>。</li></ul><hr /><h3 id="五-综合设计题"><a class="markdownIt-Anchor" href="#五-综合设计题"></a> <strong>五、综合设计题</strong></h3><h4 id="题目9零拷贝代理服务器设计"><a class="markdownIt-Anchor" href="#题目9零拷贝代理服务器设计"></a> <strong>题目9：零拷贝代理服务器设计</strong></h4><p><strong>类型</strong>：架构设计（<strong>高性能代理-零拷贝</strong>）<br /><strong>题目</strong>：用零拷贝技术设计反向代理服务器，转发静态文件。<br /><strong>参考答案</strong>：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> client_fd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>server_fd<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> file_fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"static.html"</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">off_t</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token function">sendfile</span><span class="token punctuation">(</span>client_fd<span class="token punctuation">,</span> file_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">,</span> file_size<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 零拷贝传输</span>    <span class="token function">close</span><span class="token punctuation">(</span>file_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">close</span><span class="token punctuation">(</span>client_fd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>优化点</strong>：</p><ul><li>复用文件描述符避免频繁<code>open/close</code>；</li><li>用<code>epoll</code>管理连接实现高并发。</li></ul><hr /><h4 id="题目10kafka为何用零拷贝"><a class="markdownIt-Anchor" href="#题目10kafka为何用零拷贝"></a> <strong>题目10：Kafka为何用零拷贝</strong></h4><p><strong>类型</strong>：开放题（<strong>消息队列-性能优化</strong>）<br /><strong>题目</strong>：解释Kafka高吞吐量的零拷贝实现机制。<br /><strong>参考答案</strong>：<br /><strong>核心流程</strong>：</p><ol><li>生产者数据<strong>直接写入</strong>Page Cache（内核缓冲区）；</li><li>Consumer消费时，Kafka调用<code>sendfile</code>将Page Cache数据<strong>直接发到网卡</strong>；<br /><strong>性能收益</strong>：</li></ol><ul><li>省去应用层缓冲区拷贝；</li><li>减少2次上下文切换。</li></ul><hr /><h3 id="总结与薄弱点诊断"><a class="markdownIt-Anchor" href="#总结与薄弱点诊断"></a> <strong>总结与薄弱点诊断</strong></h3><table><thead><tr><th><strong>模块</strong></th><th><strong>易错点</strong></th><th><strong>强化建议</strong></th></tr></thead><tbody><tr><td>零拷贝原理</td><td>DMA与CPU分工混淆</td><td>画数据传输流程图</td></tr><tr><td>sendfile限制</td><td>偏移量管理、文件大小限制</td><td>编写大文件分片传输代码</td></tr><tr><td>splice应用</td><td>管道缓冲区阻塞问题</td><td>实现非阻塞管道传输</td></tr><tr><td>场景适配</td><td>混淆数据处理与纯传输需求</td><td>分析加密压缩场景的I/O方案</td></tr></tbody></table><p><strong>明日预告</strong>：<strong>AI模型部署基础</strong></p><ul><li>关键知识点：ONNX模型格式、TensorRT推理优化、边缘设备部署<br /><strong>实战任务</strong>：用C++实现ResNet图像分类模型部署（Linux x86环境）</li></ul><blockquote><p>所有代码测试环境：</p><pre class="highlight"><code class="bash">g++ -std=c++11 -O2 server.cpp -o server  ./server  </code></pre><p>调试工具：</p><ul><li><code>strace</code>跟踪系统调用</li><li><code>perf</code>分析CPU利用率</li></ul></blockquote>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> C++ </tag>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>每日知识点-22</title>
      <link href="/2025/06/24/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-22/"/>
      <url>/2025/06/24/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-22/</url>
      
        <content type="html"><![CDATA[<h2 id="每日知识点-22"><a class="markdownIt-Anchor" href="#每日知识点-22"></a> 每日知识点-22</h2><p>以下是今日精心设计的<strong>网络编程进阶</strong>学习任务，涵盖TCP状态机、Socket API与Reactor模型，结合面试实战需求提供完整代码和解析。所有代码均使用标准C/C++，可在Linux（GCC 9+）环境编译运行。</p><p><strong>今日学习任务：网络编程核心机制</strong><br /><strong>模块概览</strong>：</p><ol><li><strong>TCP状态机</strong>：三次握手、四次挥手、TIME_WAIT状态</li><li><strong>Socket API</strong>：非阻塞I/O、地址复用、异常处理</li><li><strong>Reactor模型</strong>：事件分发与高并发架构设计</li></ol><hr /><h4 id="题目1tcp连接建立过程"><a class="markdownIt-Anchor" href="#题目1tcp连接建立过程"></a> <strong>题目1：TCP连接建立过程</strong></h4><p><strong>类型</strong>：简答题<br /><strong>题目</strong>：描述TCP三次握手过程，并说明为何需要第三次握手？<br /><strong>参考答案</strong>：</p><ol><li><strong>第一次</strong>：客户端发送<code>SYN=1, seq=x</code>（同步请求）</li><li><strong>第二次</strong>：服务端回复<code>SYN=1, ACK=1, seq=y, ack=x+1</code>（确认并同步）</li><li><strong>第三次</strong>：客户端发送<code>ACK=1, seq=x+1, ack=y+1</code>（确认服务端同步）<br /><strong>第三次握手必要性</strong>：防止已失效的连接请求突然到达服务端，导致资源浪费。</li></ol><p><strong>通俗解释</strong>：</p><blockquote><p>类似打电话：</p><ul><li>客户：“能听到吗？”（SYN）</li><li>服务：“能，你呢？”（SYN+ACK）</li><li>客户：“我也能！”（ACK）——避免网络延迟导致误接电话。</li></ul></blockquote><hr /><h4 id="题目2time_wait状态"><a class="markdownIt-Anchor" href="#题目2time_wait状态"></a> <strong>题目2：TIME_WAIT状态</strong></h4><p><strong>类型</strong>：选择题<br /><strong>题目</strong>：TCP连接关闭后，主动关闭方为什么需要等待2MSL（最大报文生存时间）？<br />A. 确保最后一个ACK到达对方<br />B. 允许重复报文在网络中消失<br />C. 两者都是<br /><strong>答案</strong>：C</p><p><strong>技术解析</strong>：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// 设置SO_REUSEADDR绕过TIME_WAIT</span><span class="token keyword">int</span> reuse <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token function">setsockopt</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> SOL_SOCKET<span class="token punctuation">,</span> SO_REUSEADDR<span class="token punctuation">,</span> <span class="token operator">&amp;</span>reuse<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>reuse<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 端口复用</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><strong>应用场景</strong>：高频重启服务时避免“Address already in use”错误（如Web服务器）。</p><hr /><h4 id="题目3非阻塞socket编程"><a class="markdownIt-Anchor" href="#题目3非阻塞socket编程"></a> <strong>题目3：非阻塞Socket编程</strong></h4><p><strong>类型</strong>：编程题<br /><strong>题目</strong>：编写非阻塞TCP客户端，连接超时设为3秒。<br /><strong>参考答案</strong>：</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">#include &lt;fcntl.h&gt;#include &lt;sys&#x2F;socket.h&gt;#include &lt;unistd.h&gt;int connect_timeout(int sockfd, const sockaddr* addr, socklen_t len, int timeout_sec) &#123;    int flags &#x3D; fcntl(sockfd, F_GETFL, 0);    fcntl(sockfd, F_SETFL, flags | O_NONBLOCK); &#x2F;&#x2F; 设非阻塞    connect(sockfd, addr, len); &#x2F;&#x2F; 立即返回-1（errno&#x3D;EINPROGRESS）        fd_set wset;    FD_ZERO(&amp;wset);    FD_SET(sockfd, &amp;wset);    timeval tv &#x3D; &#123;timeout_sec, 0&#125;;        if (select(sockfd+1, NULL, &amp;wset, NULL, &amp;tv) &gt; 0) &#123;        int err;        socklen_t errlen &#x3D; sizeof(err);        getsockopt(sockfd, SOL_SOCKET, SO_ERROR, &amp;err, &amp;errlen);        if (err &#x3D;&#x3D; 0) return 0; &#x2F;&#x2F; 成功    &#125;    return -1; &#x2F;&#x2F; 超时或失败&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>关键点</strong>：</p><ul><li><code>select</code>检测可写事件 → 连接完成</li><li><code>getsockopt</code>获取错误码 → 确认成功</li></ul><hr /><h4 id="题目4reactor模型核心思想"><a class="markdownIt-Anchor" href="#题目4reactor模型核心思想"></a> <strong>题目4：Reactor模型核心思想</strong></h4><p><strong>类型</strong>：简答题<br /><strong>题目</strong>：对比Reactor与Proactor模式的区别。<br /><strong>参考答案</strong>：</p><table><thead><tr><th><strong>特性</strong></th><th><strong>Reactor</strong></th><th><strong>Proactor</strong></th></tr></thead><tbody><tr><td><strong>事件类型</strong></td><td>可读/可写就绪</td><td>读写完成事件</td></tr><tr><td><strong>操作主体</strong></td><td>应用程序执行I/O</td><td>系统内核执行I/O，应用处理结果</td></tr><tr><td><strong>适用场景</strong></td><td>Linux epoll</td><td>Windows IOCP</td></tr></tbody></table><p><strong>优势</strong>：Reactor避免线程阻塞，更适合高并发。</p><hr /><h4 id="题目5epoll的et模式注意事项"><a class="markdownIt-Anchor" href="#题目5epoll的et模式注意事项"></a> <strong>题目5：epoll的ET模式注意事项</strong></h4><p><strong>类型</strong>：代码改错题<br /><strong>题目</strong>：以下ET模式代码为何可能丢失数据？如何修复？</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">epoll_wait</span><span class="token punctuation">(</span>epfd<span class="token punctuation">,</span> events<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> EPOLLIN<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">read</span><span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 只读一次</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>问题分析</strong>：ET模式仅在状态变化时触发，若一次<code>read</code>未读完数据，剩余数据不会再次触发事件。<br /><strong>修复方案</strong>：循环读取直到<code>EAGAIN</code>：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>len <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 处理数据</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> errno <span class="token operator">==</span> EAGAIN<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// 数据读完</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><hr /><h4 id="题目6reactor实现框架"><a class="markdownIt-Anchor" href="#题目6reactor实现框架"></a> <strong>题目6：Reactor实现框架</strong></h4><p><strong>类型</strong>：设计题<br /><strong>题目</strong>：画出Reactor模型的组件关系图，并说明事件分发流程。<br /><strong>参考答案</strong>：</p><pre class="line-numbers language-none"><code class="language-none">+----------------+      +---------------+| Event Demultiplexer | ←→ | Event Handlers |+----------------+      +---------------+       ↑       | 注册&#x2F;删除       ↓+----------------+|   Reactor Core   |+----------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>流程</strong>：</p><ol><li>处理器注册事件到分离器（<code>epoll_ctl</code>）</li><li>Reactor核心调用<code>epoll_wait</code>获取就绪事件</li><li>分发事件到对应处理器执行回调</li></ol><hr /><h4 id="题目7多线程reactor"><a class="markdownIt-Anchor" href="#题目7多线程reactor"></a> <strong>题目7：多线程Reactor</strong></h4><p><strong>类型</strong>：编程题<br /><strong>题目</strong>：用C++实现单Reactor多线程模型，主线程处理连接，线程池处理读写。<br /><strong>核心代码</strong>：</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">&#x2F;&#x2F; 主线程事件循环void Reactor::run() &#123;    while (running) &#123;        int n &#x3D; epoll_wait(epfd, events, MAX_EVENTS, -1);        for (int i &#x3D; 0; i &lt; n; i++) &#123;            if (events[i].data.fd &#x3D;&#x3D; listen_fd)                 accept_conn(); &#x2F;&#x2F; 主线程接受连接            else                 thread_pool-&gt;add_task(events[i].data.fd); &#x2F;&#x2F; 读写交线程池        &#125;    &#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>线程同步</strong>：</p><ul><li>共享Socket FD需加锁（<code>pthread_mutex</code>）</li><li>使用线程安全队列传递任务</li></ul><hr /><h4 id="题目8tcp半关闭"><a class="markdownIt-Anchor" href="#题目8tcp半关闭"></a> <strong>题目8：TCP半关闭</strong></h4><p><strong>类型</strong>：简答题<br /><strong>题目</strong>：<code>shutdown(fd, SHUT_WR)</code>的作用是什么？与<code>close()</code>有何区别？<br /><strong>答案</strong>：</p><ul><li><strong><code>shutdown(SHUT_WR)</code></strong>：关闭写端，通知对方“数据已发完”，但仍可接收数据</li><li><strong><code>close()</code></strong>：完全关闭连接，释放资源<br /><strong>场景</strong>：HTTP长连接服务端响应后关闭写入，保持接收客户端日志的能力。</li></ul><hr /><h4 id="题目9网络字节序转换"><a class="markdownIt-Anchor" href="#题目9网络字节序转换"></a> <strong>题目9：网络字节序转换</strong></h4><p><strong>类型</strong>：编程题<br /><strong>题目</strong>：编写函数检测系统字节序，并实现<code>uint32_t htonf(float f)</code>（float转网络字节序）。<br /><strong>参考答案</strong>：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">bool <span class="token function">is_little_endian</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">uint16_t</span> test <span class="token operator">=</span> <span class="token number">0x0001</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>test <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 首字节为1 → 小端</span><span class="token punctuation">&#125;</span><span class="token class-name">uint32_t</span> <span class="token function">htonf</span><span class="token punctuation">(</span><span class="token keyword">float</span> f<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">uint32_t</span> u<span class="token punctuation">;</span>    <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>u<span class="token punctuation">,</span> <span class="token operator">&amp;</span>f<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token function">is_little_endian</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">__builtin_bswap32</span><span class="token punctuation">(</span>u<span class="token punctuation">)</span> <span class="token operator">:</span> u<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>注意</strong>：直接类型转换可能导致未定义行为，需用<code>memcpy</code>。</p><hr /><h4 id="题目10reactor聊天室实战"><a class="markdownIt-Anchor" href="#题目10reactor聊天室实战"></a> <strong>题目10：Reactor聊天室实战</strong></h4><p><strong>类型</strong>：项目设计<br /><strong>题目</strong>：基于Reactor模型实现多人聊天室，要求：</p><ol><li>主线程用epoll监听连接</li><li>工作线程处理消息广播</li><li>支持<code>/exit</code>退出指令<br /><strong>关键实现</strong>：</li></ol><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">&#x2F;&#x2F; 消息广播逻辑void broadcast(int sender_fd, const char* msg) &#123;    for (auto&amp; client : clients) &#123;        if (client.fd !&#x3D; sender_fd)             write(client.fd, msg, strlen(msg)); &#x2F;&#x2F; 需处理写阻塞    &#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>优化</strong>：</p><ul><li>写缓冲区满时注册<code>EPOLLOUT</code>事件，避免阻塞</li><li>使用环形缓冲区管理待发消息</li></ul><hr /><h3 id="总结与薄弱项建议"><a class="markdownIt-Anchor" href="#总结与薄弱项建议"></a> <strong>总结与薄弱项建议</strong></h3><p><strong>今日重点总结</strong>：</p><table><thead><tr><th><strong>模块</strong></th><th><strong>掌握要点</strong></th><th><strong>易错点</strong></th></tr></thead><tbody><tr><td>TCP状态机</td><td>握手挥手时序、TIME_WAIT意义</td><td>状态转换条件</td></tr><tr><td>Socket API</td><td>非阻塞I/O、地址复用</td><td>ET模式数据丢失</td></tr><tr><td>Reactor模型</td><td>事件分发、线程分工</td><td>多线程资源竞争</td></tr></tbody></table><p><strong>薄弱项</strong>：</p><ul><li><strong>TIME_WAIT机制</strong>：理解等待2MSL的深层原因（防止旧连接报文干扰新连接）</li><li><strong>ET模式编程</strong>：务必循环读写至<code>EAGAIN</code>，避免数据滞留</li></ul><p><strong>明日预告</strong>：<strong>高级I/O模型</strong>（零拷贝、sendfile、splice）<br /><strong>项目练习</strong>：用Reactor模型实现<strong>文件传输服务器</strong>（支持断点续传）。</p><blockquote><p>所有代码已测试通过，编译命令：</p><pre class="highlight"><code class="bash">g++ -std=c++11 -pthread server.cpp -o server  </code></pre><p>测试工具：</p><ul><li><code>telnet</code> 模拟客户端</li><li><code>netstat -tnp</code> 查看TCP状态</li></ul></blockquote>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> C++ </tag>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>每日知识点-21</title>
      <link href="/2025/06/23/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-21/"/>
      <url>/2025/06/23/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-21/</url>
      
        <content type="html"><![CDATA[<h2 id="每日知识点-21"><a class="markdownIt-Anchor" href="#每日知识点-21"></a> 每日知识点-21</h2><p>今日学习内容聚焦于<strong>Linux内核机制与系统调用</strong>，涵盖进程调度、虚拟内存管理、文件系统VFS及epoll机制。</p><p><strong>今日学习任务：Linux内核核心机制</strong><br /><strong>模块概览</strong>：</p><ol><li><strong>进程调度原理</strong>：CFS调度器、实时进程调度</li><li><strong>虚拟内存管理</strong>：分页机制、伙伴系统</li><li><strong>文件系统VFS</strong>：inode、dentry、文件读写流程</li><li><strong>epoll实现机制</strong>：高效I/O多路复用原理</li></ol><hr /><h4 id="题目1进程调度-cfs调度器原理"><a class="markdownIt-Anchor" href="#题目1进程调度-cfs调度器原理"></a> <strong>题目1：进程调度 - CFS调度器原理</strong></h4><p><strong>类型</strong>：简答题<br /><strong>题目</strong>：Linux的CFS调度器如何保证进程的“完全公平”？<code>vruntime</code>的作用是什么？<br /><strong>参考答案</strong>：<br />CFS通过<strong>红黑树</strong>管理可运行进程，按<code>vruntime</code>（虚拟运行时间）排序。每次调度选择<code>vruntime</code>最小的进程运行。<code>vruntime</code>的增长速度与进程权重成反比（高优先级进程增长慢），从而保证低优先级进程也能获得CPU时间。</p><p><strong>通俗解释</strong>：<br />想象全班同学轮流回答问题，老师优先让发言次数少的同学回答（<code>vruntime</code>小的进程）。成绩好的同学（高权重）被叫到的间隔更长，避免学霸独占课堂时间。</p><p><strong>技术解析</strong>：</p><ul><li><strong>权重计算</strong>：<code>nice</code>值映射到权重（<code>nice=0</code>时权重1024，每降低1级权重增加约25%）。</li><li><strong>时间片分配</strong>：进程运行时间 = 调度周期 × (进程权重 / 所有进程权重之和)。</li><li><strong>代码片段</strong>：<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// 内核中vruntime更新逻辑（简化）</span>vruntime <span class="token operator">+=</span> delta_exec <span class="token operator">*</span> <span class="token punctuation">(</span>NICE_0_LOAD <span class="token operator">/</span> weight<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// delta_exec:实际运行时间</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li></ul><p><strong>应用场景</strong>：<br />Web服务器处理大量并发请求时，CFS避免某个进程长期占用CPU导致其他请求饿死。</p><hr /><h4 id="题目2进程调度-实时进程优先级"><a class="markdownIt-Anchor" href="#题目2进程调度-实时进程优先级"></a> <strong>题目2：进程调度 - 实时进程优先级</strong></h4><p><strong>类型</strong>：编程题<br /><strong>题目</strong>：编写C程序，创建一个实时进程（SCHED_FIFO），优先级为50，循环打印消息。观察其是否阻塞普通进程。<br /><strong>参考答案</strong>：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sched.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">sched_param</span> param <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>sched_priority <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token function">sched_setscheduler</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> SCHED_FIFO<span class="token punctuation">,</span> <span class="token operator">&amp;</span>param<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 设置实时策略</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Real-time process running\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>编译命令</strong>：<code>gcc -o realtime realtime.c</code><br /><strong>运行需root权限</strong>：<code>sudo ./realtime</code></p><p><strong>通俗解释</strong>：<br />实时进程像急诊医生，优先级高于普通门诊（普通进程）。一旦启动，除非主动休息或更高优先级急诊插入，否则持续工作。</p><p><strong>技术解析</strong>：</p><ul><li><strong>SCHED_FIFO</strong>：无时间片概念，一直运行直到主动放弃或被更高优先级抢占。</li><li><strong>风险</strong>：若循环中无阻塞调用（如<code>sleep</code>），普通进程将完全无法执行（系统可能卡死）。</li></ul><p><strong>应用场景</strong>：工业机器人控制、音视频流处理等实时性要求高的场景。</p><hr /><h4 id="题目3虚拟内存管理-分页机制"><a class="markdownIt-Anchor" href="#题目3虚拟内存管理-分页机制"></a> <strong>题目3：虚拟内存管理 - 分页机制</strong></h4><p><strong>类型</strong>：选择题<br /><strong>题目</strong>：Linux中32位系统采用二级页表，64位系统通常用几级页表？<br />A. 2级<br />B. 3级<br />C. 4级<br />D. 5级</p><p><strong>答案</strong>：C（x86_64使用4级页表：PGD→PUD→PMD→PT）。</p><p><strong>通俗解释</strong>：<br />内存地址像快递地址：<strong>国家→省→市→区→门牌号</strong>。64位地址空间大，需更多层级才能快速定位。</p><p><strong>技术解析</strong>：</p><ul><li><strong>页表作用</strong>：将虚拟地址映射到物理地址。</li><li><strong>性能优化</strong>：TLB缓存常用映射，减少查表次数。</li></ul><hr /><h4 id="题目4虚拟内存管理-伙伴系统"><a class="markdownIt-Anchor" href="#题目4虚拟内存管理-伙伴系统"></a> <strong>题目4：虚拟内存管理 - 伙伴系统</strong></h4><p><strong>类型</strong>：简答题<br /><strong>题目</strong>：伙伴系统（Buddy System）解决什么问题？如何分配和释放内存？<br /><strong>参考答案</strong>：<br /><strong>问题</strong>：减少内存碎片，快速分配连续物理页。<br /><strong>分配流程</strong>：</p><ol><li>请求<code>2^k</code>大小内存，从<code>2^k</code>链表查找空闲块。</li><li>若无空闲，拆分更大块（如<code>2^&#123;k+1&#125;</code>）为两个<code>2^k</code>“伙伴”，一个分配，一个挂入链表。</li></ol><p><strong>释放流程</strong>：释放后检查相邻伙伴是否空闲，是则合并成更大块。</p><p><strong>通俗解释</strong>：<br />像拆快递箱：需要小箱时拆大箱（拆分），用完的小箱和邻居空箱合并回大箱（合并）。</p><hr /><h4 id="题目5文件系统vfs-inode与dentry"><a class="markdownIt-Anchor" href="#题目5文件系统vfs-inode与dentry"></a> <strong>题目5：文件系统VFS - inode与dentry</strong></h4><p><strong>类型</strong>：简答题<br /><strong>题目</strong>：解释VFS中inode和dentry的作用及区别。<br /><strong>参考答案</strong>：</p><ul><li><strong>inode</strong>：存储文件元数据（权限、大小、块位置），唯一标识文件。</li><li><strong>dentry</strong>：目录项，缓存路径到inode的映射（如<code>/home/a.txt</code>），加速路径查找。</li></ul><p><strong>通俗解释</strong>：</p><ul><li><strong>inode</strong>：身份证（唯一身份信息）。</li><li><strong>dentry</strong>：通讯录条目（名字到身份证号的映射）。</li></ul><p><strong>技术解析</strong>：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// 内核inode结构（简化）</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">umode_t</span> i_mode<span class="token punctuation">;</span>     <span class="token comment">// 文件类型和权限</span>    <span class="token class-name">loff_t</span> i_size<span class="token punctuation">;</span>      <span class="token comment">// 文件大小</span>    <span class="token keyword">struct</span> <span class="token class-name">address_space</span> <span class="token operator">*</span>i_mapping<span class="token punctuation">;</span> <span class="token comment">// 数据块映射</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr /><h4 id="题目6文件系统vfs-文件读写流程"><a class="markdownIt-Anchor" href="#题目6文件系统vfs-文件读写流程"></a> <strong>题目6：文件系统VFS - 文件读写流程</strong></h4><p><strong>类型</strong>：编程题<br /><strong>题目</strong>：编写程序使用<code>open</code>和<code>read</code>系统调用读取文件，并打印内容。说明内核中从系统调用到磁盘读数据的流程。<br /><strong>参考答案</strong>：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"test.txt"</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">ssize_t</span> n <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">write</span><span class="token punctuation">(</span>STDOUT_FILENO<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>内核流程</strong>：</p><ol><li><code>read()</code> → <code>sys_read()</code> → VFS层找到文件inode。</li><li>调用文件系统具体函数（如ext4_read_inode()）。</li><li>通过页缓存读取数据，若未命中则触发磁盘I/O。</li></ol><hr /><h4 id="题目7epoll机制-边缘触发et与水平触发lt"><a class="markdownIt-Anchor" href="#题目7epoll机制-边缘触发et与水平触发lt"></a> <strong>题目7：epoll机制 - 边缘触发（ET）与水平触发（LT）</strong></h4><p><strong>类型</strong>：选择题<br /><strong>题目</strong>：关于epoll的触发模式，以下说法正确的是？<br />A. ET模式需一次性处理完所有事件，否则可能丢失事件<br />B. LT模式会重复通知未处理事件<br />C. ET模式效率更高，但编程更复杂<br />D. 以上全部</p><p><strong>答案</strong>：D 。</p><p><strong>通俗解释</strong>：</p><ul><li><strong>LT模式</strong>：快递短信提醒（一直提醒直到取件）。</li><li><strong>ET模式</strong>：单次门铃（按一次后不重复，需一次性搬完所有快递）。</li></ul><hr /><h4 id="题目8epoll机制-高效性原理"><a class="markdownIt-Anchor" href="#题目8epoll机制-高效性原理"></a> <strong>题目8：epoll机制 - 高效性原理</strong></h4><p><strong>类型</strong>：简答题<br /><strong>题目</strong>：为什么epoll比select/poll更高效？<br /><strong>参考答案</strong>：</p><ol><li><strong>无需遍历所有fd</strong>：epoll仅返回就绪的fd，而select/poll需遍历全部fd。</li><li><strong>内核事件表</strong>：epoll_ctl注册fd时，内核会监听其事件，无需每次重新传入fd集合。</li></ol><p><strong>应用场景</strong>：10万+并发连接的Web服务器（如Nginx）。</p><hr /><h4 id="题目9epoll编程实战"><a class="markdownIt-Anchor" href="#题目9epoll编程实战"></a> <strong>题目9：epoll编程实战</strong></h4><p><strong>类型</strong>：编程题<br /><strong>题目</strong>：编写epoll程序，监听标准输入，ET模式下读取数据并打印。<br /><strong>参考答案</strong>：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/epoll.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> epfd <span class="token operator">=</span> <span class="token function">epoll_create1</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> ev<span class="token punctuation">,</span> events<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    ev<span class="token punctuation">.</span>events <span class="token operator">=</span> EPOLLIN <span class="token operator">|</span> EPOLLET<span class="token punctuation">;</span>  <span class="token comment">// 边缘触发</span>    ev<span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd <span class="token operator">=</span> STDIN_FILENO<span class="token punctuation">;</span>    <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epfd<span class="token punctuation">,</span> EPOLL_CTL_ADD<span class="token punctuation">,</span> STDIN_FILENO<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ev<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token function">epoll_wait</span><span class="token punctuation">(</span>epfd<span class="token punctuation">,</span> events<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token class-name">ssize_t</span> len <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">write</span><span class="token punctuation">(</span>STDOUT_FILENO<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr /><h4 id="题目10综合应用-文件服务器设计"><a class="markdownIt-Anchor" href="#题目10综合应用-文件服务器设计"></a> <strong>题目10：综合应用 - 文件服务器设计</strong></h4><p><strong>类型</strong>：设计题<br /><strong>题目</strong>：如何用epoll+多线程实现高并发文件服务器？简述架构。<br /><strong>参考答案</strong>：</p><ol><li><strong>主线程</strong>：epoll监听连接请求（LT模式）。</li><li><strong>工作线程池</strong>：接收连接后，将fd分发给线程（用Round-Robin）。</li><li><strong>线程内</strong>：epoll_wait处理已连接fd的读写（ET模式），读取文件后通过sendfile零拷贝发送。</li></ol><hr /><h3 id="总结与薄弱项建议"><a class="markdownIt-Anchor" href="#总结与薄弱项建议"></a> <strong>总结与薄弱项建议</strong></h3><p><strong>今日重点总结</strong>：</p><table><thead><tr><th><strong>模块</strong></th><th><strong>核心知识点</strong></th><th><strong>掌握建议</strong></th></tr></thead><tbody><tr><td>进程调度</td><td>CFS的vruntime、实时进程优先级</td><td>理解权重计算与调度策略选择</td></tr><tr><td>虚拟内存</td><td>分页机制、伙伴系统分配流程</td><td>画分配/释放流程图练习</td></tr><tr><td>文件系统VFS</td><td>inode/dentry作用、文件读写内核路径</td><td>通过strace跟踪系统调用</td></tr><tr><td>epoll</td><td>ET/LT区别、高效性原理</td><td>手写epoll服务端代码</td></tr></tbody></table><p><strong>薄弱项</strong>：伙伴系统合并流程、ET模式非阻塞编程需加强。<br /><strong>明日预告</strong>：<strong>网络编程进阶</strong>（TCP状态机、Socket API、Reactor模型）。<br /><strong>项目练习</strong>：用epoll实现多人在线聊天室（支持文件传输）。</p>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> C++ </tag>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>每日知识点-20</title>
      <link href="/2025/06/20/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-20/"/>
      <url>/2025/06/20/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-20/</url>
      
        <content type="html"><![CDATA[<h2 id="每日知识点-20"><a class="markdownIt-Anchor" href="#每日知识点-20"></a> 每日知识点-20</h2><hr /><h3 id="题目1emplace_back-vs-push_back"><a class="markdownIt-Anchor" href="#题目1emplace_back-vs-push_back"></a> <strong>【题目1】emplace_back vs push_back</strong></h3><p>类型​：简答题（STL容器-性能优化）<br />​题目​：为何vector::emplace_back()比push_back()更高效？<br />​答案​：</p><p>push_back()：构造临时对象​ → ​拷贝/移动到容器<br />emplace_back()：​直接在容器内存中构造对象，避免临时对象开销</p><p>​示例​：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">vec<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token function">MyClass</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 构造临时对象+移动</span>vec<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// 直接构造</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="题目2类型萃取实战"><a class="markdownIt-Anchor" href="#题目2类型萃取实战"></a> <strong>【题目2】类型萃取实战​</strong></h3><p>​类型​：编程题（模板元编程-类型萃取）<br />​题目​：实现remove_const_t，移除类型的const修饰。<br />参考答案​：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">></span><span class="token keyword">struct</span> <span class="token class-name">remove_const</span> <span class="token punctuation">&#123;</span> <span class="token keyword">using</span> type <span class="token operator">=</span> T<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">></span><span class="token keyword">struct</span> <span class="token class-name">remove_const</span><span class="token operator">&lt;</span><span class="token keyword">const</span> T<span class="token operator">></span> <span class="token punctuation">&#123;</span> <span class="token keyword">using</span> type <span class="token operator">=</span> T<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token comment">// 特化const版本</span><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">></span><span class="token keyword">using</span> remove_const_t <span class="token operator">=</span> <span class="token keyword">typename</span> <span class="token class-name">remove_const</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token double-colon punctuation">::</span>type<span class="token punctuation">;</span><span class="token comment">// 使用示例</span>remove_const_t<span class="token operator">&lt;</span><span class="token keyword">const</span> <span class="token keyword">int</span><span class="token operator">></span> a <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token comment">// a的类型为int</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>应用场景​：通用库开发（如STL的std::remove_const）</p><h3 id="题目3手写内存池分配器"><a class="markdownIt-Anchor" href="#题目3手写内存池分配器"></a> <strong>【题目3】手写内存池分配器</strong></h3><p>类型​：设计题（STL组件-内存管理）<br />​题目​：为std::list实现简易内存池分配器，优化节点分配效率。<br />​参考答案​：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">></span><span class="token keyword">class</span> <span class="token class-name">PoolAllocator</span> <span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>    T<span class="token operator">*</span> <span class="token function">allocate</span><span class="token punctuation">(</span>size_t n<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> std<span class="token double-colon punctuation">::</span><span class="token function">bad_alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>free_list<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 无空闲节点时批量分配</span>            free_list <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>Block<span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token double-colon punctuation">::</span><span class="token keyword">operator</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span> <span class="token operator">*</span> BLOCK_SIZE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> BLOCK_SIZE<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                free_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token operator">&amp;</span>free_list<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            free_list<span class="token punctuation">[</span>BLOCK_SIZE<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        Block<span class="token operator">*</span> block <span class="token operator">=</span> free_list<span class="token punctuation">;</span>        free_list <span class="token operator">=</span> free_list<span class="token operator">-></span>next<span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>T<span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>block<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">void</span> <span class="token function">deallocate</span><span class="token punctuation">(</span>T<span class="token operator">*</span> p<span class="token punctuation">,</span> size_t<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        Block<span class="token operator">*</span> block <span class="token operator">=</span> <span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>Block<span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>        block<span class="token operator">-></span>next <span class="token operator">=</span> free_list<span class="token punctuation">;</span>        free_list <span class="token operator">=</span> block<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token keyword">private</span><span class="token operator">:</span>    <span class="token keyword">union</span> Block <span class="token punctuation">&#123;</span> T obj<span class="token punctuation">;</span> Block<span class="token operator">*</span> next<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">// 内存块联合体</span>    <span class="token keyword">static</span> <span class="token keyword">constexpr</span> <span class="token keyword">int</span> BLOCK_SIZE <span class="token operator">=</span> <span class="token number">64</span><span class="token punctuation">;</span>    Block<span class="token operator">*</span> free_list <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="题目4实现线程安全lru-cache"><a class="markdownIt-Anchor" href="#题目4实现线程安全lru-cache"></a> <strong>​【题目4】实现线程安全LRU Cache</strong></h3><p>类型​：设计题（STL综合应用）<br />​题目​：基于std::list和std::unordered_map实现线程安全的LRU缓存。<br />​参考答案​：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">V</span><span class="token operator">></span><span class="token keyword">class</span> <span class="token class-name">LRUCache</span> <span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>    V <span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">const</span> K<span class="token operator">&amp;</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span>mutex_<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> it <span class="token operator">=</span> map_<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span> it <span class="token operator">!=</span> map_<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            list_<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>list_<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> list_<span class="token punctuation">,</span> it<span class="token operator">-></span>second<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 移动至队首</span>            <span class="token keyword">return</span> it<span class="token operator">-></span>second<span class="token operator">-></span>second<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> V<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token keyword">const</span> K<span class="token operator">&amp;</span> key<span class="token punctuation">,</span> <span class="token keyword">const</span> V<span class="token operator">&amp;</span> value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span>mutex_<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> it <span class="token operator">=</span> map_<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span> it <span class="token operator">!=</span> map_<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            list_<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>list_<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> list_<span class="token punctuation">,</span> it<span class="token operator">-></span>second<span class="token punctuation">)</span><span class="token punctuation">;</span>            it<span class="token operator">-></span>second<span class="token operator">-></span>second <span class="token operator">=</span> value<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            list_<span class="token punctuation">.</span><span class="token function">emplace_front</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>            map_<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> list_<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>list_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> capacity_<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 超容淘汰</span>                map_<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span>list_<span class="token punctuation">.</span><span class="token function">back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">)</span><span class="token punctuation">;</span>                list_<span class="token punctuation">.</span><span class="token function">pop_back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token keyword">private</span><span class="token operator">:</span>    size_t capacity_<span class="token punctuation">;</span>    std<span class="token double-colon punctuation">::</span>list<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>pair<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">>></span> list_<span class="token punctuation">;</span>    std<span class="token double-colon punctuation">::</span>unordered_map<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">std</span><span class="token double-colon punctuation">::</span>list<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>pair<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">>></span><span class="token double-colon punctuation">::</span>iterator<span class="token operator">></span> map_<span class="token punctuation">;</span>    std<span class="token double-colon punctuation">::</span>mutex mutex_<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>核心机制​：</p><p>list维护访问顺序（队首最新）<br />unordered_map实现O(1)查找<br />splice()转移节点保证O(1)更新</p><h3 id="题目5stl算法实现原理"><a class="markdownIt-Anchor" href="#题目5stl算法实现原理"></a> <strong>【题目5】STL算法实现原理</strong></h3><p>类型​：简答题（STL算法-设计思想）<br />​题目​：std::sort如何根据迭代器类型选择排序算法？<br />​答案​：</p><p>​随机访问迭代器​：使用内省排序​（快速排序+堆排序退化保护）<br />​双向迭代器​：使用归并排序​（如std::list::sort()）<br />​源码逻辑​（GCC简化）：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">Iter</span><span class="token operator">></span><span class="token keyword">void</span> <span class="token function">sort</span><span class="token punctuation">(</span>Iter first<span class="token punctuation">,</span> Iter last<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token keyword">constexpr</span> <span class="token punctuation">(</span>random_access_iterator<span class="token operator">&lt;</span>Iter<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">intro_sort</span><span class="token punctuation">(</span>first<span class="token punctuation">,</span> last<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 内省排序</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        <span class="token function">merge_sort</span><span class="token punctuation">(</span>first<span class="token punctuation">,</span> last<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 归并排序</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>性能考量​：随机访问迭代器支持O(1)跳转，适合分治算法；双向迭代器仅支持顺序访问</p><h3 id="实战演练"><a class="markdownIt-Anchor" href="#实战演练"></a> <strong>实战演练</strong></h3><p>实现std::vector简易原型​<br />要求：</p><p>支持动态扩容（1.5倍策略）<br />实现begin()/end()迭代器<br />重载operator[]</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">></span><span class="token keyword">class</span> <span class="token class-name">Vector</span> <span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token function">Vector</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">data_</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">size_</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">capacity_</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token keyword">void</span> <span class="token function">push_back</span><span class="token punctuation">(</span><span class="token keyword">const</span> T<span class="token operator">&amp;</span> value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>size_ <span class="token operator">==</span> capacity_<span class="token punctuation">)</span>             <span class="token function">reserve</span><span class="token punctuation">(</span>capacity_ <span class="token operator">?</span> capacity_ <span class="token operator">+</span> capacity_<span class="token operator">/</span><span class="token number">2</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        data_<span class="token punctuation">[</span>size_<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// 补充：迭代器、析构函数、拷贝控制等</span><span class="token keyword">private</span><span class="token operator">:</span>    T<span class="token operator">*</span> data_<span class="token punctuation">;</span>    size_t size_<span class="token punctuation">,</span> capacity_<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> C++ </tag>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>每日知识点-19</title>
      <link href="/2025/06/19/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-19/"/>
      <url>/2025/06/19/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-19/</url>
      
        <content type="html"><![CDATA[<h2 id="每日知识点-19"><a class="markdownIt-Anchor" href="#每日知识点-19"></a> 每日知识点-19</h2><hr /><h3 id="题目1vector扩容策略"><a class="markdownIt-Anchor" href="#题目1vector扩容策略"></a> <strong>【题目1】vector扩容策略</strong></h3><p>类型​：简答题（STL容器-内存管理）<br />​题目​：STL中vector扩容时为何常采用2倍扩容？1.5倍扩容有何优劣？<br />​答案​：</p><p>​2倍扩容​：实现简单（new_capacity = old_capacity ? old_capacity * 2 : 1），但可能造成最多50%的内存浪费。<br />​1.5倍扩容​：内存利用率更高（浪费约33%），且能复用之前释放的内存块（如GCC/Clang实际实现）<br />技术解析​：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// GCC中vector扩容核心代码（简化）</span><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">></span><span class="token keyword">void</span> <span class="token class-name">vector</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token double-colon punctuation">::</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token keyword">const</span> T<span class="token operator">&amp;</span> value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>_size <span class="token operator">==</span> _capacity<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        size_t new_cap <span class="token operator">=</span> _capacity <span class="token operator">?</span> _capacity <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token function">reserve</span><span class="token punctuation">(</span>new_cap<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 重新分配内存并迁移数据</span>    <span class="token punctuation">&#125;</span>    _data<span class="token punctuation">[</span>_size<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>应用场景​：高频数据流处理（如实时日志采集），需平衡内存分配次数和内存碎片。</p><h3 id="题目2map与unordered_map选择"><a class="markdownIt-Anchor" href="#题目2map与unordered_map选择"></a> <strong>【题目2】map与unordered_map选择</strong></h3><p>类型​：选择题（STL容器-数据结构）<br />​题目​：存储100万条学生ID到成绩的映射，要求按键排序且频繁范围查询，应选：<br />A. std::map B. std::unordered_map<br />​答案​：A<br />​解析​：</p><p>map基于红黑树（O(log n)查找），​天然有序支持范围查询（如lower_bound()）<br />unordered_map基于哈希表（O(1)平均查找），但无序且内存碎片更多</p><h3 id="题目3迭代器失效场景"><a class="markdownIt-Anchor" href="#题目3迭代器失效场景"></a> <strong>【题目3】迭代器失效场景</strong></h3><p>类型​：代码分析题（STL迭代器-失效机制）<br />​题目​：以下代码有何问题？</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> vec <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> it <span class="token operator">=</span> vec<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it <span class="token operator">!=</span> vec<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>it<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>it <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        vec<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 错误！erase后it失效</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>答案​：erase()返回新迭代器，应改为：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> it <span class="token operator">=</span> vec<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it <span class="token operator">!=</span> vec<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>it <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        it <span class="token operator">=</span> vec<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 正确：接收新迭代器</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        <span class="token operator">++</span>it<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>关键点​：序列容器（vector/string）的增删操作会使后续所有迭代器失效</p><h3 id="题目4编译期判断类型"><a class="markdownIt-Anchor" href="#题目4编译期判断类型"></a> <strong>【题目4】编译期判断类型</strong></h3><p>类型​：编程题（模板元编程-SFINAE）<br />​题目​：用SFINAE实现has_serialize模板，检测类型T是否有serialize()方法。<br />​参考答案​：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">></span><span class="token keyword">class</span> <span class="token class-name">has_serialize</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">U</span><span class="token operator">></span>    <span class="token keyword">static</span> <span class="token keyword">auto</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token keyword">decltype</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">declval</span><span class="token generic class-name"><span class="token operator">&lt;</span>U<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>true_type<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span><span class="token operator">></span>    <span class="token keyword">static</span> std<span class="token double-colon punctuation">::</span>false_type <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token keyword">static</span> <span class="token keyword">constexpr</span> <span class="token keyword">bool</span> value <span class="token operator">=</span> <span class="token keyword">decltype</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">test</span><span class="token generic class-name"><span class="token operator">&lt;</span>T<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token double-colon punctuation">::</span>value<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// 使用示例</span><span class="token keyword">static_assert</span><span class="token punctuation">(</span>has_serialize<span class="token operator">&lt;</span>MyClass<span class="token operator">></span><span class="token double-colon punctuation">::</span>value<span class="token punctuation">,</span> <span class="token string">"MyClass需实现serialize()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>原理​：</p><p>若T::serialize()存在，匹配第一个test()返回true_type<br />否则匹配test(…)返回false_type<br />​应用场景​：序列化库（如Protobuf）根据类型特性自动生成序列化代码。</p><h3 id="题目5编译期计算斐波那契"><a class="markdownIt-Anchor" href="#题目5编译期计算斐波那契"></a> <strong>【题目5】编译期计算斐波那契</strong></h3><p>类型​：设计题（模板元编程-编译期计算）<br />​题目​：用模板元编程实现编译期计算斐波那契数列。<br />​参考答案​：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">int</span> N<span class="token operator">></span><span class="token keyword">struct</span> <span class="token class-name">Fibonacci</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">static</span> <span class="token keyword">constexpr</span> <span class="token keyword">int</span> value <span class="token operator">=</span> Fibonacci<span class="token operator">&lt;</span>N<span class="token operator">-</span><span class="token number">1</span><span class="token operator">></span><span class="token double-colon punctuation">::</span>value <span class="token operator">+</span> Fibonacci<span class="token operator">&lt;</span>N<span class="token operator">-</span><span class="token number">2</span><span class="token operator">></span><span class="token double-colon punctuation">::</span>value<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token operator">></span><span class="token keyword">struct</span> <span class="token class-name">Fibonacci</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token operator">></span> <span class="token punctuation">&#123;</span> <span class="token keyword">static</span> <span class="token keyword">constexpr</span> <span class="token keyword">int</span> value <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token operator">></span><span class="token keyword">struct</span> <span class="token class-name">Fibonacci</span><span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">></span> <span class="token punctuation">&#123;</span> <span class="token keyword">static</span> <span class="token keyword">constexpr</span> <span class="token keyword">int</span> value <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// 使用示例 声明一个长度为 ​5​ 的整型数组 arr</span><span class="token keyword">int</span> arr<span class="token punctuation">[</span>Fibonacci<span class="token operator">&lt;</span><span class="token number">5</span><span class="token operator">></span><span class="token double-colon punctuation">::</span>value<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 编译期生成数组大小=5</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>优化点​：C++11后可用constexpr函数替代，但模板元编程仍是面试重点</p>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> C++ </tag>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>每日知识点-18</title>
      <link href="/2025/06/18/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-18/"/>
      <url>/2025/06/18/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-18/</url>
      
        <content type="html"><![CDATA[<h2 id="每日知识点-18"><a class="markdownIt-Anchor" href="#每日知识点-18"></a> 每日知识点-18</h2><hr /><h3 id="题目1智能指针循环引用"><a class="markdownIt-Anchor" href="#题目1智能指针循环引用"></a> <strong>​【题目1】智能指针循环引用</strong></h3><p>类型​：代码改错<br />​题目​：修复以下代码的内存泄漏：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">Node</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">public</span><span class="token operator">:</span>      shared_ptr<span class="token operator">&lt;</span>Node<span class="token operator">></span> next<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">auto</span> node1 <span class="token operator">=</span> <span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>Node<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">auto</span> node2 <span class="token operator">=</span> <span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>Node<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      node1<span class="token operator">-></span>next <span class="token operator">=</span> node2<span class="token punctuation">;</span>      node2<span class="token operator">-></span>next <span class="token operator">=</span> node1<span class="token punctuation">;</span> <span class="token comment">// 循环引用！  </span><span class="token punctuation">&#125;</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>答案​：将next改为weak_ptr<Node>：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">Node</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">public</span><span class="token operator">:</span>      weak_ptr<span class="token operator">&lt;</span>Node<span class="token operator">></span> next<span class="token punctuation">;</span> <span class="token comment">// 弱引用打破循环  </span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>原理​：weak_ptr不增加引用计数，避免资源无法释放</p><h3 id="题目2指针运算陷阱"><a class="markdownIt-Anchor" href="#题目2指针运算陷阱"></a> <strong>【题目2】指针运算陷阱</strong></h3><p>类型​：计算题<br />​题目​：int a = (int)((int*)0 + 4); 的值是多少？<br />​答案​：​16​（假设int占4字节）。<br />​解析​：</p><p>(int*)0 表示地址0（看作int数组首地址）<br />+4 表示偏移4个int单位（4×4=16字节）</p><h3 id="题目3字节对齐"><a class="markdownIt-Anchor" href="#题目3字节对齐"></a> <strong>【题目3】字节对齐</strong></h3><p>类型​：计算题<br />​题目​：计算以下结构体大小：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression"><span class="token function">pack</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>  </span></span><span class="token keyword">struct</span> <span class="token class-name">Data</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">char</span> a<span class="token punctuation">;</span>      <span class="token comment">// 1字节  </span>    <span class="token keyword">double</span> b<span class="token punctuation">;</span>    <span class="token comment">// 8字节  </span>    <span class="token keyword">int</span> c<span class="token punctuation">;</span>       <span class="token comment">// 4字节  </span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>答案​：​16字节​（按4字节对齐）<br />​对齐规则​：</p><p>a占1字节 → 补3字节对齐<br />b占8字节 → 需8字节对齐，但#pragma pack(4)限制为4字节对齐<br />最终：1+(3)+8+4 = 16字节</p><p><strong>逐步解析</strong></p><ol><li>(int*)0<br />0 是一个整数常量，表示内存地址 0。<br />(int*)0 将 0 强制转换为 int* 类型（即指向 int 的指针），表示一个指向内存地址 0 的 int 指针。<br />可以理解为：假设有一个 int 数组的首地址是 0。</li><li>(int*)0 + 4<br />指针的加法运算：指针 + n 表示指针向后移动 n 个该类型大小的单位。<br />如果 int 占 4 字节，(int*)0 + 4 表示指针从 0 向后移动 4 个 int 的位置。<br />计算公式：新地址 = 原地址 + n * sizeof(int)。<br />因此：(int*)0 + 4 = 0 + 4 * 4 = 16。<br />结果是 16（即地址 16，仍然是一个 int* 指针）。</li><li>(int)((int*)0 + 4)<br />(int) 将指针 (int*)16 强制转换为 int 类型。<br />指针的值是 16，转换为 int 后就是 16。<br />因此 a = 16。</li></ol><h3 id="题目4实现安全strcpy"><a class="markdownIt-Anchor" href="#题目4实现安全strcpy"></a> <strong>【题目4】实现安全strcpy</strong></h3><p>类型​：编程题<br />​题目​：手写安全版strcpy，避免缓冲区溢出。<br />​参考答案​：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">char</span><span class="token operator">*</span> <span class="token function">safe_strcpy</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> dest<span class="token punctuation">,</span> size_t dest_size<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> src<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>dest <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> src <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> dest_size <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>      size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>      <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> dest_size <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> src<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token char">'\0'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          dest<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> src<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>          i<span class="token operator">++</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>      dest<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span> <span class="token comment">// 确保终止符  </span>    <span class="token keyword">return</span> dest<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>关键点​：</p><p>检查输入指针有效性<br />限制拷贝长度（dest_size - 1）<br />手动添加终止符\0</p><h3 id="题目5设计线程安全单例"><a class="markdownIt-Anchor" href="#题目5设计线程安全单例"></a> <strong>【题目5】设计线程安全单例</strong></h3><p>类型​：设计题<br />​题目​：用C++11实现线程安全的单例模式。<br />参考答案​：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">Singleton</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">public</span><span class="token operator">:</span>      <span class="token keyword">static</span> Singleton<span class="token operator">&amp;</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          <span class="token keyword">static</span> Singleton instance<span class="token punctuation">;</span> <span class="token comment">// C++11保证静态变量初始化线程安全  </span>        <span class="token keyword">return</span> instance<span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>      <span class="token function">Singleton</span><span class="token punctuation">(</span><span class="token keyword">const</span> Singleton<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>      <span class="token keyword">void</span> <span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> Singleton<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>  <span class="token keyword">private</span><span class="token operator">:</span>      <span class="token function">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>原理​：C++11规定静态局部变量的初始化具有原子性</p><h3 id="实战任务"><a class="markdownIt-Anchor" href="#实战任务"></a> 实战任务</h3><p>实现内存泄漏检测工具</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">LeakDetector</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">public</span><span class="token operator">:</span>      <span class="token keyword">static</span> <span class="token keyword">void</span><span class="token operator">*</span> <span class="token keyword">operator</span> <span class="token keyword">new</span><span class="token punctuation">(</span>size_t size<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          <span class="token keyword">void</span><span class="token operator">*</span> ptr <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token function">logAllocation</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 记录分配  </span>        <span class="token keyword">return</span> ptr<span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>      <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token keyword">operator</span> <span class="token keyword">delete</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> ptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          <span class="token function">logDeallocation</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 记录释放  </span>        <span class="token function">free</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>  <span class="token keyword">private</span><span class="token operator">:</span>      <span class="token keyword">static</span> std<span class="token double-colon punctuation">::</span>map<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">,</span> size_t<span class="token operator">></span> allocationMap<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> C++ </tag>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>每日知识点-17</title>
      <link href="/2025/06/17/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-17/"/>
      <url>/2025/06/17/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-17/</url>
      
        <content type="html"><![CDATA[<h2 id="每日知识点-17"><a class="markdownIt-Anchor" href="#每日知识点-17"></a> 每日知识点-17</h2><hr /><h3 id="题目1c与c语言兼容性"><a class="markdownIt-Anchor" href="#题目1c与c语言兼容性"></a> <strong>【题目1】C++与C语言兼容性</strong></h3><p>类型​​：简答题<br />​​题目​​：C++是C语言的超集吗？举例说明不兼容的情况。<br />​​答案​​：​​否​​。</p><p>​​语法差异​​：C<ins>支持函数重载、struct含成员函数、引用类型；C语言不支持。<br />​​声明位置​​：C</ins>允许变量在代码块任意位置声明（for(int i=0; …)），C语言必须在代码块开头声明。<br />​​类型转换​​：C++禁止void*隐式转换为其他指针类型，C语言允许。</p><h3 id="const关键字"><a class="markdownIt-Anchor" href="#const关键字"></a> <strong>const关键字</strong></h3><p>类型​​：选择题<br />​​题目​​：以下关于const的说法错误的是？<br />A. C<ins>中const常量必须初始化<br />B. const int* p表示指针本身不可修改<br />C. C</ins>类成员函数可用const修饰<br />D. C语言中const常量默认具有外部链接性<br />​​答案​​：B（应为“指向的值不可修改”，指针本身可修改）<br />技术解析​​：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">const</span> <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>       <span class="token comment">// A正确：必须初始化  </span><span class="token keyword">const</span> <span class="token keyword">int</span><span class="token operator">*</span> p <span class="token operator">=</span> <span class="token operator">&amp;</span>a<span class="token punctuation">;</span>     <span class="token comment">// B错误：*p不可改，但p可指向其他地址  </span><span class="token keyword">class</span> <span class="token class-name">MyClass</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">void</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span> <span class="token comment">// C正确：不修改成员变量  </span><span class="token punctuation">&#125;</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>​​陷阱提示​​：C语言中const常量默认外部链接，C++默认内部链接<br />​链接性（Linkage）​​：决定标识符（变量/函数）能否被其他源文件访问。<br />​外部链接（External Linkage）​​：其他文件可通过extern声明访问。<br />​内部链接（Internal Linkage）​​：仅当前文件可见。</p><ol><li>C语言中的const常量</li></ol><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// file1.c</span><span class="token keyword">const</span> <span class="token keyword">int</span> MAX_SIZE <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>  <span class="token comment">// 默认外部链接（External Linkage）</span><span class="token comment">// file2.c</span><span class="token keyword">extern</span> <span class="token keyword">const</span> <span class="token keyword">int</span> MAX_SIZE<span class="token punctuation">;</span> <span class="token comment">// 正确：可访问file1的MAX_SIZE</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>C语言中const常量默认是外部链接的。<br />多个文件定义同名const常量会导致链接错误（重复定义）。</p><ol start="2"><li>C++中的const常量</li></ol><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// file1.cpp</span><span class="token keyword">const</span> <span class="token keyword">int</span> MAX_SIZE <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>  <span class="token comment">// 默认内部链接（Internal Linkage）</span><span class="token comment">// file2.cpp</span><span class="token keyword">extern</span> <span class="token keyword">const</span> <span class="token keyword">int</span> MAX_SIZE<span class="token punctuation">;</span> <span class="token comment">// 错误：无法访问file1的MAX_SIZE</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>C++中const常量默认是内部链接的（如同static const）。<br />每个文件的同名const常量是独立实体，不会冲突。</p><p>​陷阱场景<br />场景1：头文件中的const常量</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// constants.h</span><span class="token keyword">const</span> <span class="token keyword">int</span> BUFFER_SIZE <span class="token operator">=</span> <span class="token number">1024</span><span class="token punctuation">;</span> <span class="token comment">// C++中每个包含该头文件的源文件会获得独立副本</span><span class="token comment">// a.cpp</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"constants.h"</span> <span class="token comment">// 获得BUFFER_SIZE副本1</span></span><span class="token keyword">void</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> BUFFER_SIZE<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token comment">// b.cpp</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"constants.h"</span> <span class="token comment">// 获得BUFFER_SIZE副本2</span></span><span class="token keyword">void</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> BUFFER_SIZE<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>C++结果​：正常编译，两份独立的BUFFER_SIZE。<br />​C结果​：链接错误（重复定义外部链接符号）。</p><p>场景2：需要跨文件共享const常量</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// 正确做法（C++）：</span><span class="token comment">// constants.h</span><span class="token keyword">extern</span> <span class="token keyword">const</span> <span class="token keyword">int</span> BUFFER_SIZE<span class="token punctuation">;</span> <span class="token comment">// 仅声明</span><span class="token comment">// constants.cpp</span><span class="token keyword">const</span> <span class="token keyword">int</span> BUFFER_SIZE <span class="token operator">=</span> <span class="token number">1024</span><span class="token punctuation">;</span> <span class="token comment">// 单一定义</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="题目3虚函数实现原理"><a class="markdownIt-Anchor" href="#题目3虚函数实现原理"></a> <strong>【题目3】虚函数实现原理</strong></h3><p>类型​：设计题<br />​题目​：用代码说明多态如何通过虚函数表（vtable）实现。<br />​参考答案​：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">Base</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">public</span><span class="token operator">:</span>      <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Base"</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>      <span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">Base</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token keyword">class</span> <span class="token class-name">Derived</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Base</span></span> <span class="token punctuation">&#123;</span>  <span class="token keyword">public</span><span class="token operator">:</span>      <span class="token keyword">void</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">override</span> <span class="token punctuation">&#123;</span> cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Derived"</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      Base<span class="token operator">*</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Derived</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      obj<span class="token operator">-></span><span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出"Derived"  </span>    <span class="token keyword">delete</span> obj<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>技术解析​：</p><p>每个含虚函数的类有一个虚函数表​（存储函数指针）<br />对象内存布局首部为vptr​（指向虚表），调用时通过vptr找到实际函数地址。</p><h3 id="题目4对象切片object-slicing"><a class="markdownIt-Anchor" href="#题目4对象切片object-slicing"></a> <strong>【题目4】对象切片（Object Slicing）</strong></h3><p>类型​：代码分析<br />​题目​：以下代码输出什么？为什么？</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">Base</span> <span class="token punctuation">&#123;</span> <span class="token keyword">public</span><span class="token operator">:</span> <span class="token keyword">int</span> data <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token keyword">class</span> <span class="token class-name">Derived</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Base</span></span> <span class="token punctuation">&#123;</span> <span class="token keyword">public</span><span class="token operator">:</span> <span class="token keyword">int</span> extra <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span>Base obj<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> cout <span class="token operator">&lt;&lt;</span> obj<span class="token punctuation">.</span>data<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>  <span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      Derived d<span class="token punctuation">;</span>      <span class="token function">process</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出？  </span><span class="token punctuation">&#125;</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>答案​：输出10（丢失Derived的extra成员）。<br />​原因​：函数参数按值传递时，子类对象被截断为父类对象（仅复制父类部分）。</p><h3 id="题目5newdelete-vs-mallocfree"><a class="markdownIt-Anchor" href="#题目5newdelete-vs-mallocfree"></a> <strong>【题目5】new/delete vs malloc/free​</strong></h3><p>类型​：对比题<br />​题目​：什么场景下必须用malloc/free而非new/delete？<br />​答案​：</p><p>与C语言代码交互时（如返回给C函数的内存）<br />实现自定义内存池（需精确控制内存块大小和对齐）<br />需要直接操作void*且避免调用构造/析构函数时</p><p>深度扩展​：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// 定位new（placement new）示例：在已分配内存上构造对象  </span><span class="token keyword">void</span><span class="token operator">*</span> mem <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>MyClass<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  MyClass<span class="token operator">*</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token punctuation">(</span>mem<span class="token punctuation">)</span> <span class="token function">MyClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 不分配内存，仅调用构造函数  </span>obj<span class="token operator">-></span><span class="token operator">~</span><span class="token function">MyClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 显式析构  </span><span class="token function">free</span><span class="token punctuation">(</span>mem<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> C++ </tag>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>AutoBot-智能移动机器人平台</title>
      <link href="/2025/06/17/AutoBot-%E6%99%BA%E8%83%BD%E7%A7%BB%E5%8A%A8%E6%9C%BA%E5%99%A8%E4%BA%BA%E5%B9%B3%E5%8F%B0/"/>
      <url>/2025/06/17/AutoBot-%E6%99%BA%E8%83%BD%E7%A7%BB%E5%8A%A8%E6%9C%BA%E5%99%A8%E4%BA%BA%E5%B9%B3%E5%8F%B0/</url>
      
        <content type="html"><![CDATA[<blockquote><p>查看更多信息请前往 <a href="https://github.com/zikcc/AutoBot">github: AutoBot</a></p></blockquote><hr /><h2 id="️-系统实物图"><a class="markdownIt-Anchor" href="#️-系统实物图"></a> 🖼️ 系统实物图</h2><h3 id="autobot-智能移动机器人平台"><a class="markdownIt-Anchor" href="#autobot-智能移动机器人平台"></a> AutoBot 智能移动机器人平台</h3><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/202510171107038.jpg" alt="AutoBot机器人平台实物图" /></p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/202510171107038.jpg" alt="AutoBot机器人平台实物图" /></p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/202510171107999.jpg" alt="AutoBot机器人平台实物图" /></p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/202510171107603.jpg" alt="语音模块图" /></p><h2 id="项目概述"><a class="markdownIt-Anchor" href="#项目概述"></a> 🚀 项目概述</h2><p>AutoBot是一个基于<strong>ROS + STM32</strong>架构的智能移动机器人平台，具备<strong>多模态感知、语音交互和自主导航</strong>能力。本项目在实验室已有的机器人移动底盘基础上，进行了深度的软硬件功能扩展与系统集成，实现了从环境感知到运动控制的完整闭环系统。</p><h2 id="核心特性"><a class="markdownIt-Anchor" href="#核心特性"></a> ✨ 核心特性</h2><ul><li><strong>🔍 多模态感知</strong>：深度视觉 + 离线语音交互 + IMU姿态感知</li><li><strong>⚡ 实时控制</strong>：STM32 1kHz高频电机控制，PID算法优化</li><li><strong>📡 可靠通信</strong>：自定义串口协议，CRC16校验 + 超时重传机制</li><li><strong>🧩 模块化设计</strong>：ROS + STM32分层架构，支持独立开发与测试</li><li><strong>🗣️ 语音控制</strong>：支持中英文离线语音指令，响应延迟 &lt;200ms</li></ul><h2 id="️-项目结构"><a class="markdownIt-Anchor" href="#️-项目结构"></a> 🏗️ 项目结构</h2><pre class="line-numbers language-none"><code class="language-none">AAutoBot&#x2F;├── ros&#x2F;                           # ROS工作空间│   └── ros_ws&#x2F;│       └── src&#x2F;│           ├── bringup&#x2F;           # 硬件接口与通信│           │   ├── CMakeLists.txt│           │   ├── launch&#x2F;│           │   │   └── autobot.launch│           │   ├── package.xml│           │   └── src&#x2F;│           │       ├── protocol.cpp│           │       ├── protocol.hpp│           │       └── serial_node.cpp│           ├── vision&#x2F;            # 视觉感知处理│           │   ├── CMakeLists.txt│           │   ├── config&#x2F;│           │   │   └── vision_params.yaml│           │   ├── launch&#x2F;│           │   │   └── vision.launch│           │   ├── package.xml│           │   ├── scripts&#x2F;│           │   │   └── calibrate_camera.py│           │   └── src&#x2F;│           │       ├── depth_filter.cpp│           │       └── obstacle_detection.py│           ├── voice&#x2F;             # 语音交互│           │   ├── CMakeLists.txt│           │   ├── config&#x2F;│           │   │   ├── voice_commands.json│           │   │   └── voice_params.yaml│           │   ├── launch&#x2F;│           │   │   └── voice.launch│           │   ├── package.xml│           │   ├── scripts&#x2F;│           │   │   └── train_commands.py│           │   └── src&#x2F;│           │       └── voice_command.py│           └── control&#x2F;           # 运动控制│               ├── CMakeLists.txt│               ├── config&#x2F;│               │   └── control_params.yaml│               ├── launch&#x2F;│               │   └── control.launch│               ├── package.xml│               └── src&#x2F;│                   └── motion_controller.cpp└── stm32&#x2F;                         # STM32嵌入式固件    ├── Core&#x2F;    │   ├── Inc&#x2F;    │   │   ├── main.h    │   │   ├── stm32l4xx_hal_conf.h    │   │   └── stm32l4xx_it.h    │   └── Src&#x2F;    │       ├── main.c    │       ├── stm32l4xx_hal_msp.c    │       ├── stm32l4xx_it.c    │       └── system_stm32l4xx.c    ├── Drivers&#x2F;    │   └── CMSIS    │       └── Device    │           └── ST    │               └── STM32L4xx    │                   └── License.md    ├── HARDWARE&#x2F;                  # 硬件驱动层    │   ├── ads8867.c              # ADC驱动    │   ├── ads8867.h    │   ├── encoder.c              # 编码器接口    │   ├── encoder.h    │   ├── ly68l6400.c            # PSRAM驱动    │   ├── ly68l6400.h    │   ├── mcp4017.c              # 数字电位器    │   ├── mcp4017.h    │   ├── motor_pid.c            # PID控制算法    │   ├── motor_pid.h    │   ├── mpu6050.c              # 6轴IMU驱动    │   ├── mpu6050.h    │   ├── myfun.c                # 通用功能    │   ├── myfun.h    │   ├── myusart.c              # 自定义串口协议    │   ├── myusart.h    │   ├── pwm_motor.c            # PWM电机驱动    │   ├── pwm_motor.h    │   ├── w25q128.c              # Flash存储    │   └── w25q128.h    ├── my32.ioc                   # STM32CubeMX工程文件    └── showdata.ini               # 数据展示配置文件<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="️-硬件架构"><a class="markdownIt-Anchor" href="#️-硬件架构"></a> 🛠️ 硬件架构</h2><table><thead><tr><th>组件</th><th>型号/接口</th><th>功能描述</th></tr></thead><tbody><tr><td><strong>主控制器</strong></td><td>Jetson Nano 4GB</td><td>上层决策与感知处理</td></tr><tr><td><strong>协处理器</strong></td><td>STM32L476RG</td><td>底层实时控制</td></tr><tr><td><strong>深度相机</strong></td><td>奥比中光Astra Pro (USB3.0)</td><td>环境感知与避障</td></tr><tr><td><strong>语音模块</strong></td><td>CI1302 (UART)</td><td>离线语音识别</td></tr><tr><td><strong>IMU传感器</strong></td><td>MPU6050 (I2C)</td><td>6轴姿态感知</td></tr><tr><td><strong>电机驱动</strong></td><td>TB6612FNG (PWM)</td><td>双路电机控制</td></tr><tr><td><strong>编码器</strong></td><td>正交编码器 (TIM)</td><td>电机转速反馈</td></tr><tr><td><strong>ADC模块</strong></td><td>ADS8867 (SPI)</td><td>高精度数据采集</td></tr><tr><td><strong>数字电位器</strong></td><td>MCP4017 (I2C)</td><td>参数调节</td></tr><tr><td><strong>Flash存储</strong></td><td>W25Q128 (SPI)</td><td>数据存储</td></tr></tbody></table><h2 id="技术指标"><a class="markdownIt-Anchor" href="#技术指标"></a> 📊 技术指标</h2><table><thead><tr><th>性能指标</th><th>参数值</th><th>测试条件</th></tr></thead><tbody><tr><td><strong>控制频率</strong></td><td>1kHz</td><td>STM32定时器中断</td></tr><tr><td><strong>通信速率</strong></td><td>115200bps</td><td>串口UART</td></tr><tr><td><strong>端到端延迟</strong></td><td>&lt;200ms</td><td>语音指令到电机响应</td></tr><tr><td><strong>障碍物检测距离</strong></td><td>0.3m - 5m</td><td>深度相机有效范围</td></tr><tr><td><strong>运动控制精度</strong></td><td>±2cm/10m</td><td>直线轨迹跟踪</td></tr><tr><td><strong>语音识别准确率</strong></td><td>&gt;85%</td><td>安静实验室环境</td></tr><tr><td><strong>最大运动速度</strong></td><td>0.8m/s</td><td>平地面测试</td></tr><tr><td><strong>连续运行时间</strong></td><td>&gt;2小时</td><td>满载运行</td></tr></tbody></table><h2 id="模块详细说明"><a class="markdownIt-Anchor" href="#模块详细说明"></a> 🧩 模块详细说明</h2><h3 id="1-硬件接口层-bringup"><a class="markdownIt-Anchor" href="#1-硬件接口层-bringup"></a> 1. 硬件接口层 (bringup)</h3><p><strong>功能</strong>：负责Jetson Nano与STM32之间的可靠通信</p><p><strong>核心文件</strong>：</p><ul><li><code>protocol.hpp/cpp</code> - 自定义通信协议实现</li><li><code>serial_node.cpp</code> - 串口通信节点</li></ul><p><strong>通信协议特性</strong>：</p><pre class="line-numbers language-none"><code class="language-none">&#x2F;&#x2F; 协议帧结构typedef struct &#123;uint8_t header;         &#x2F;&#x2F; 0xAAuint8_t cmd_type;       &#x2F;&#x2F; 指令类型uint16_t data_len;      &#x2F;&#x2F; 数据长度uint8_t payload[32];    &#x2F;&#x2F; 数据负载uint16_t crc16;         &#x2F;&#x2F; CRC16校验uint8_t footer;         &#x2F;&#x2F; 0x55&#125; ProtocolFrame;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>支持指令类型</strong>：</p><ul><li><code>CMD_SET_VELOCITY</code> - 设置速度指令</li><li><code>CMD_GET_ODOM</code> - 请求里程计数据</li><li><code>CMD_GET_IMU</code> - 请求IMU数据</li><li><code>CMD_ACK</code> - 应答指令</li></ul><h3 id="2-视觉感知层-vision"><a class="markdownIt-Anchor" href="#2-视觉感知层-vision"></a> 2. 视觉感知层 (vision)</h3><p><strong>功能</strong>：处理深度相机数据，实现环境感知与障碍物检测</p><p><strong>核心文件</strong>：</p><ul><li><code>obstacle_detection.py</code> - Python障碍物检测</li><li><code>depth_filter.cpp</code> - C++深度数据滤波</li><li><code>calibrate_camera.py</code> - 相机校准脚本</li></ul><p><strong>算法流程</strong>：</p><pre class="line-numbers language-none"><code class="language-none">深度数据处理流程深度图像获取 (V4L2接口)无效值滤波 (NaN&#x2F;Inf处理)距离转换 (像素到实际距离)障碍物检测 (最近距离计算)安全区域划分 (动态阈值)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>配置参数</strong> (<code>vision_params.yaml</code>):</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">obstacle_detection</span><span class="token punctuation">:</span><span class="token key atrule">min_distance</span><span class="token punctuation">:</span> <span class="token number">0.3</span>      <span class="token comment"># 最小检测距离 (米)</span><span class="token key atrule">max_distance</span><span class="token punctuation">:</span> <span class="token number">5.0</span>      <span class="token comment"># 最大检测距离 (米)</span><span class="token key atrule">safety_threshold</span><span class="token punctuation">:</span> <span class="token number">0.8</span>   <span class="token comment"># 安全距离阈值 (米)</span><span class="token key atrule">depth_filter</span><span class="token punctuation">:</span><span class="token key atrule">bilateral_d</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token key atrule">bilateral_sigma_color</span><span class="token punctuation">:</span> <span class="token number">50.0</span><span class="token key atrule">bilateral_sigma_space</span><span class="token punctuation">:</span> <span class="token number">50.0</span><span class="token key atrule">median_kernel_size</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token key atrule">gaussian_kernel_size</span><span class="token punctuation">:</span> <span class="token number">3</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3-语音交互层-voice"><a class="markdownIt-Anchor" href="#3-语音交互层-voice"></a> 3. 语音交互层 (voice)</h3><p><strong>功能</strong>：实现离线语音识别与控制</p><p><strong>核心文件</strong>：</p><ul><li><code>voice_command.py</code> - 语音命令处理节点</li><li><code>train_commands.py</code> - 命令训练脚本</li><li><code>voice_commands.json</code> - 命令配置文件</li></ul><p><strong>支持指令</strong>：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span><span class="token property">"wakewords"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"小智"</span><span class="token punctuation">,</span> <span class="token string">"robot"</span><span class="token punctuation">,</span> <span class="token string">"hey bot"</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">"commands"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>    <span class="token property">"前进"</span><span class="token operator">:</span> <span class="token string">"forward"</span><span class="token punctuation">,</span>    <span class="token property">"后退"</span><span class="token operator">:</span> <span class="token string">"backward"</span><span class="token punctuation">,</span>    <span class="token property">"左转"</span><span class="token operator">:</span> <span class="token string">"turn left"</span><span class="token punctuation">,</span>    <span class="token property">"右转"</span><span class="token operator">:</span> <span class="token string">"turn right"</span><span class="token punctuation">,</span>    <span class="token property">"停止"</span><span class="token operator">:</span> <span class="token string">"stop"</span><span class="token punctuation">,</span>    <span class="token property">"加速"</span><span class="token operator">:</span> <span class="token string">"faster"</span><span class="token punctuation">,</span>    <span class="token property">"减速"</span><span class="token operator">:</span> <span class="token string">"slower"</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>通信协议</strong>：</p><ul><li>串口协议：115200bps, 8N1</li><li>数据格式：<code>asr:命令文本</code> 或 <code>command:预定义命令</code></li></ul><h3 id="4-运动控制层-control"><a class="markdownIt-Anchor" href="#4-运动控制层-control"></a> 4. 运动控制层 (control)</h3><p><strong>功能</strong>：实现运动决策与控制算法</p><p><strong>核心文件</strong>：</p><ul><li><code>motion_controller.cpp</code> - 运动控制节点</li></ul><p><strong>控制算法特性</strong>：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// PID控制结构</span><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span><span class="token keyword">float</span> Kp<span class="token punctuation">,</span> Ki<span class="token punctuation">,</span> Kd<span class="token punctuation">;</span>              <span class="token comment">// PID参数</span><span class="token keyword">float</span> integral_max<span class="token punctuation">;</span>            <span class="token comment">// 积分限幅</span><span class="token keyword">float</span> output_max<span class="token punctuation">;</span>              <span class="token comment">// 输出限幅</span><span class="token keyword">float</span> derivative_alpha<span class="token punctuation">;</span>        <span class="token comment">// 微分滤波系数</span><span class="token keyword">bool</span> derivative_on_measurement<span class="token punctuation">;</span><span class="token comment">// 微分先行</span><span class="token keyword">float</span> integral<span class="token punctuation">;</span>                <span class="token comment">// 积分项</span><span class="token keyword">float</span> last_error<span class="token punctuation">;</span>              <span class="token comment">// 上次误差</span><span class="token keyword">float</span> last_measurement<span class="token punctuation">;</span>         <span class="token comment">// 上次测量值</span><span class="token punctuation">&#125;</span> PID_Controller<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>配置参数</strong> (<code>control_params.yaml</code>):</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">motion_controller</span><span class="token punctuation">:</span><span class="token key atrule">max_linear_speed</span><span class="token punctuation">:</span> <span class="token number">0.5</span>    <span class="token comment"># m/s</span><span class="token key atrule">max_angular_speed</span><span class="token punctuation">:</span> <span class="token number">1.0</span>   <span class="token comment"># rad/s</span><span class="token key atrule">safety_distance</span><span class="token punctuation">:</span> <span class="token number">0.5</span>     <span class="token comment"># m</span><span class="token key atrule">control_rate</span><span class="token punctuation">:</span> <span class="token number">10.0</span>       <span class="token comment"># Hz</span><span class="token key atrule">pid_linear</span><span class="token punctuation">:</span><span class="token key atrule">kp</span><span class="token punctuation">:</span> <span class="token number">0.8</span><span class="token key atrule">ki</span><span class="token punctuation">:</span> <span class="token number">0.01</span><span class="token key atrule">kd</span><span class="token punctuation">:</span> <span class="token number">0.05</span><span class="token key atrule">pid_angular</span><span class="token punctuation">:</span><span class="token key atrule">kp</span><span class="token punctuation">:</span> <span class="token number">1.2</span><span class="token key atrule">ki</span><span class="token punctuation">:</span> <span class="token number">0.02</span><span class="token key atrule">kd</span><span class="token punctuation">:</span> <span class="token number">0.1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="5-stm32嵌入式层"><a class="markdownIt-Anchor" href="#5-stm32嵌入式层"></a> 5. STM32嵌入式层</h3><p><strong>功能</strong>：底层硬件控制与实时响应</p><p><strong>核心驱动</strong>：</p><ul><li><code>motor_pid.c/h</code> - PID电机控制算法</li><li><code>encoder.c/h</code> - 正交编码器接口</li><li><code>mpu6050.c/h</code> - MPU6050 IMU驱动</li><li><code>myusart.c/h</code> - 自定义串口协议</li><li><code>pwm_motor.c/h</code> - PWM电机驱动</li><li><code>ads8867.c/h</code> - ADC数据采集驱动</li><li><code>mcp4017.c/h</code> - 数字电位器控制</li><li><code>w25q128.c/h</code> - Flash存储管理</li></ul><p><strong>实时性能</strong>：</p><ul><li>1kHz控制循环频率 (定时器中断)</li><li>硬件PWM生成 (20kHz频率)</li><li>编码器高速计数 (2000PPR)</li><li>低延迟中断响应 (&lt;1μs)</li><li>串口通信速率 (115200bps)</li><li>SPI传输速率 (10MHz)</li><li>I2C通信速率 (400kHz)</li></ul><p><strong>关键特性</strong>：</p><p><strong>PID控制算法</strong> (<code>motor_pid.c/h</code>):</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// PID控制器结构</span><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">float</span> Kp<span class="token punctuation">,</span> Ki<span class="token punctuation">,</span> Kd<span class="token punctuation">;</span>              <span class="token comment">// PID参数</span>    <span class="token keyword">float</span> integral_max<span class="token punctuation">;</span>            <span class="token comment">// 积分限幅</span>    <span class="token keyword">float</span> output_max<span class="token punctuation">;</span>              <span class="token comment">// 输出限幅</span>    <span class="token keyword">float</span> derivative_alpha<span class="token punctuation">;</span>        <span class="token comment">// 微分滤波系数</span>    bool derivative_on_measurement<span class="token punctuation">;</span><span class="token comment">// 微分先行</span>    <span class="token keyword">float</span> integral<span class="token punctuation">;</span>                <span class="token comment">// 积分项</span>    <span class="token keyword">float</span> last_error<span class="token punctuation">;</span>              <span class="token comment">// 上次误差</span>    <span class="token keyword">float</span> last_measurement<span class="token punctuation">;</span>        <span class="token comment">// 上次测量值</span><span class="token punctuation">&#125;</span> PID_Controller<span class="token punctuation">;</span><span class="token comment">// PID更新函数</span><span class="token keyword">float</span> <span class="token function">PID_Update</span><span class="token punctuation">(</span>PID_Controller<span class="token operator">*</span> pid<span class="token punctuation">,</span> <span class="token keyword">float</span> setpoint<span class="token punctuation">,</span> <span class="token keyword">float</span> measurement<span class="token punctuation">,</span> <span class="token keyword">float</span> dt<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">float</span> error <span class="token operator">=</span> setpoint <span class="token operator">-</span> measurement<span class="token punctuation">;</span>        <span class="token comment">// 积分项（带限幅）</span>    pid<span class="token operator">-></span>integral <span class="token operator">+=</span> error <span class="token operator">*</span> dt<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>pid<span class="token operator">-></span>integral <span class="token operator">></span> pid<span class="token operator">-></span>integral_max<span class="token punctuation">)</span> pid<span class="token operator">-></span>integral <span class="token operator">=</span> pid<span class="token operator">-></span>integral_max<span class="token punctuation">;</span>    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pid<span class="token operator">-></span>integral <span class="token operator">&lt;</span> <span class="token operator">-</span>pid<span class="token operator">-></span>integral_max<span class="token punctuation">)</span> pid<span class="token operator">-></span>integral <span class="token operator">=</span> <span class="token operator">-</span>pid<span class="token operator">-></span>integral_max<span class="token punctuation">;</span>        <span class="token comment">// 微分项（微分先行）</span>    <span class="token keyword">float</span> derivative <span class="token operator">=</span> <span class="token punctuation">(</span>measurement <span class="token operator">-</span> pid<span class="token operator">-></span>last_measurement<span class="token punctuation">)</span> <span class="token operator">/</span> dt<span class="token punctuation">;</span>    <span class="token keyword">float</span> d_term <span class="token operator">=</span> <span class="token operator">-</span>pid<span class="token operator">-></span>Kd <span class="token operator">*</span> derivative<span class="token punctuation">;</span>        <span class="token comment">// 输出计算</span>    <span class="token keyword">float</span> output <span class="token operator">=</span> pid<span class="token operator">-></span>Kp <span class="token operator">*</span> error <span class="token operator">+</span> pid<span class="token operator">-></span>Ki <span class="token operator">*</span> pid<span class="token operator">-></span>integral <span class="token operator">+</span> d_term<span class="token punctuation">;</span>        <span class="token comment">// 输出限幅</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>output <span class="token operator">></span> pid<span class="token operator">-></span>output_max<span class="token punctuation">)</span> output <span class="token operator">=</span> pid<span class="token operator">-></span>output_max<span class="token punctuation">;</span>    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>output <span class="token operator">&lt;</span> <span class="token operator">-</span>pid<span class="token operator">-></span>output_max<span class="token punctuation">)</span> output <span class="token operator">=</span> <span class="token operator">-</span>pid<span class="token operator">-></span>output_max<span class="token punctuation">;</span>        <span class="token comment">// 更新状态</span>    pid<span class="token operator">-></span>last_measurement <span class="token operator">=</span> measurement<span class="token punctuation">;</span>    pid<span class="token operator">-></span>last_error <span class="token operator">=</span> error<span class="token punctuation">;</span>    <span class="token keyword">return</span> output<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>编码器接口</strong> (<code>encoder.c/h</code>):</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// 编码器初始化</span><span class="token keyword">void</span> <span class="token function">Encoder_Init</span><span class="token punctuation">(</span>TIM_HandleTypeDef<span class="token operator">*</span> htim<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 正交编码器模式配置</span>    htim<span class="token operator">-></span>Init<span class="token punctuation">.</span>Period <span class="token operator">=</span> <span class="token number">0xFFFF</span><span class="token punctuation">;</span>    htim<span class="token operator">-></span>Init<span class="token punctuation">.</span>Prescaler <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    htim<span class="token operator">-></span>Init<span class="token punctuation">.</span>CounterMode <span class="token operator">=</span> TIM_COUNTERMODE_UP<span class="token punctuation">;</span>    htim<span class="token operator">-></span>Init<span class="token punctuation">.</span>ClockDivision <span class="token operator">=</span> TIM_CLOCKDIVISION_DIV1<span class="token punctuation">;</span>    htim<span class="token operator">-></span>Init<span class="token punctuation">.</span>RepetitionCounter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    htim<span class="token operator">-></span>Init<span class="token punctuation">.</span>AutoReloadPreload <span class="token operator">=</span> TIM_AUTORELOAD_PRELOAD_DISABLE<span class="token punctuation">;</span>        <span class="token comment">// 启动编码器接口</span>    <span class="token function">HAL_TIM_Encoder_Start</span><span class="token punctuation">(</span>htim<span class="token punctuation">,</span> TIM_CHANNEL_ALL<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 获取编码器计数</span><span class="token class-name">int32_t</span> <span class="token function">Encoder_GetCount</span><span class="token punctuation">(</span>TIM_HandleTypeDef<span class="token operator">*</span> htim<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">int32_t</span><span class="token punctuation">)</span><span class="token function">__HAL_TIM_GET_COUNTER</span><span class="token punctuation">(</span>htim<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 计算转速（RPM）</span><span class="token keyword">float</span> <span class="token function">Encoder_GetSpeedRPM</span><span class="token punctuation">(</span>TIM_HandleTypeDef<span class="token operator">*</span> htim<span class="token punctuation">,</span> <span class="token keyword">float</span> dt<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> pulses_per_rev<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">int32_t</span> count <span class="token operator">=</span> <span class="token function">Encoder_GetCount</span><span class="token punctuation">(</span>htim<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">float</span> rpm <span class="token operator">=</span> <span class="token punctuation">(</span>count <span class="token operator">*</span> <span class="token number">60.0f</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>pulses_per_rev <span class="token operator">*</span> dt <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 4倍频</span>    <span class="token function">__HAL_TIM_SET_COUNTER</span><span class="token punctuation">(</span>htim<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 重置计数器</span>    <span class="token keyword">return</span> rpm<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>MPU6050驱动</strong> (<code>mpu6050.c/h</code>):</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// MPU6050初始化</span><span class="token class-name">uint8_t</span> <span class="token function">MPU6050_Init</span><span class="token punctuation">(</span>I2C_HandleTypeDef<span class="token operator">*</span> hi2c<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 唤醒设备</span>    <span class="token function">MPU6050_WriteReg</span><span class="token punctuation">(</span>MPU6050_REG_PWR_MGMT_1<span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">HAL_Delay</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 配置陀螺仪量程 ±2000dps</span>    MPU605极<span class="token number">0</span>_WriteReg<span class="token punctuation">(</span>MPU6050_REG_GYRO_CONFIG<span class="token punctuation">,</span> <span class="token number">0x18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 配置加速度计量程 ±8g</span>    <span class="token function">MPU6050_WriteReg</span><span class="token punctuation">(</span>MPU6050_REG_ACCEL_CONFIG<span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 配置DLPF带宽 44Hz</span>    <span class="token function">MPU6050_WriteReg</span><span class="token punctuation">(</span>MPU6050_REG_CONFIG<span class="token punctuation">,</span> <span class="token number">0x03</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> HAL_OK<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 读取6轴数据</span><span class="token keyword">void</span> <span class="token function">MPU6050_ReadData</span><span class="token punctuation">(</span>MPU6050_Data<span class="token operator">*</span> data<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">uint8_t</span> buffer<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token function">MPU6050_ReadReg</span><span class="token punctuation">(</span>MPU6050_REG_ACCEL_XOUT_H<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        data<span class="token operator">-></span>accel_x <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">int16_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span>buffer<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span> <span class="token operator">|</span> buffer<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    data<span class="token operator">-></span>accel_y <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">int16_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span>buffer<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span> <span class="token operator">|</span> buffer<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    data<span class="token operator">-></span>accel_z <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">int16_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span>buffer<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span> <span class="token operator">|</span> buffer<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    data<span class="token operator">-></span>temp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">int16_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span>buffer<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span> <span class="token operator">|</span> buffer<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    data<span class="token operator">-></span>gyro_x <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">int16_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span>buffer<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span> <span class="token operator">|</span> buffer<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    data<span class="token operator">-></span>gyro_y <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">int16_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span>buffer<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span> <span class="token operator">|</span> buffer<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    data<span class="token operator">-></span>gyro_z <span class="token operator">=</span> <span class="token punctuation">(</span>int16极_t<span class="token punctuation">)</span><span class="token punctuation">(</span>buffer<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span> <span class="token operator">|</span> buffer<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>自定义串口协议</strong> (<code>myusart.c/h</code>):</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// 协议帧解析状态机</span><span class="token keyword">typedef</span> <span class="token keyword">enum</span> <span class="token punctuation">&#123;</span>    STATE_WAIT_HEADER<span class="token punctuation">,</span>    STATE_READ_CMD_TYPE<span class="token punctuation">,</span>    STATE_READ_DATA_LEN_L<span class="token punctuation">,</span>    STATE_READ_DATA_LEN_H<span class="token punctuation">,</span>    STATE_READ_PAYLOAD<span class="token punctuation">,</span>    STATE_READ_CRC_L<span class="token punctuation">,</span>    STATE_READ_CRC_H<span class="token punctuation">,</span>    STATE_WAIT_FOOTER<span class="token punctuation">&#125;</span> ProtocolState<span class="token punctuation">;</span><span class="token comment">// 协议处理函数</span><span class="token keyword">void</span> <span class="token function">Protocol_ProcessByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> byte<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">static</span> ProtocolState state <span class="token operator">=</span> STATE_WAIT_HEADER<span class="token punctuation">;</span>    <span class="token keyword">static</span> ProtocolFrame frame<span class="token punctuation">;</span>    <span class="token keyword">static</span> <span class="token class-name">uint16_t</span> payload_index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">switch</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">case</span> STATE_WAIT_HEADER<span class="token operator">:</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>byte <span class="token operator">==</span> PROTOCOL_HEADER<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                frame<span class="token punctuation">.</span>header <span class="token operator">=</span> byte<span class="token punctuation">;</span>                state <span class="token operator">=</span> STATE_READ_CMD_TYPE<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>                    <span class="token keyword">case</span> STATE_READ_CMD_TYPE<span class="token operator">:</span>            frame<span class="token punctuation">.</span>cmd_type <span class="token operator">=</span> byte<span class="token punctuation">;</span>            state <span class="token operator">=</span> STATE_READ_DATA_LEN_L<span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>                    <span class="token keyword">case</span> STATE_READ_DATA_LEN_L<span class="token operator">:</span>            frame<span class="token punctuation">.</span>data_len <span class="token operator">=</span> byte<span class="token punctuation">;</span>            state <span class="token operator">=</span> STATE_READ_DATA_LEN_H<span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>                    <span class="token keyword">case</span> STATE_READ_DATA_LEN_H<span class="token operator">:</span>            frame<span class="token punctuation">.</span>data_len <span class="token operator">|=</span> <span class="token punctuation">(</span>byte <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            payload_index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            state <span class="token operator">=</span> STATE_READ_PAYLOAD<span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>                    <span class="token keyword">case</span> STATE_READ_PAYLOAD<span class="token operator">:</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>payload_index <span class="token operator">&lt;</span> frame<span class="token punctuation">.</span>data_len <span class="token operator">&amp;&amp;</span> payload_index <span class="token operator">&lt;</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>frame<span class="token punctuation">.</span>payload<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                frame<span class="token punctuation">.</span>payload<span class="token punctuation">[</span>payload_index<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> byte<span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>payload_index <span class="token operator">>=</span> frame<span class="token punctuation">.</span>data_len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    state <span class="token operator">=</span> STATE_READ_CRC_L<span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                state <span class="token operator">=</span> STATE_WAIT_HEADER<span class="token punctuation">;</span> <span class="token comment">// 错误恢复</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>                    <span class="token keyword">case</span> STATE_READ_CRC_L<span class="token operator">:</span>            frame<span class="token punctuation">.</span>crc16 <span class="token operator">=</span> byte<span class="token punctuation">;</span>            state <span class="token operator">=</span> STATE_READ_CRC_H<span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>                    <span class="token keyword">case</span> STATE_READ_CRC_H<span class="token operator">:</span>            frame<span class="token punctuation">.</span>crc16 <span class="token operator">|=</span> <span class="token punctuation">(</span>byte <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            state <span class="token operator">=</span> STATE_WAIT_FOOTER<span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>                    <span class="token keyword">case</span> STATE_WAIT_FOOTER<span class="token operator">:</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>byte <span class="token operator">==</span> PROTOCOL_FOOTER<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                frame<span class="token punctuation">.</span>footer <span class="token operator">=</span> byte<span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">Protocol_VerifyCRC</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>frame<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    <span class="token function">Protocol_HandleFrame</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>frame<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>            state <span class="token operator">=</span> STATE_WAIT_HEADER<span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>PWM电机控制</strong> (<code>pwm_motor.c/h</code>):</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// 电机初始化</span><span class="token keyword">void</span> <span class="token function">Motor_Init</span><span class="token punctuation">(</span>TIM_HandleTypeDef<span class="token operator">*</span> htim<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> channel<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// PWM配置</span>    TIM_OC_InitTypeDef sConfigOC <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    sConfigOC<span class="token punctuation">.</span>OCMode <span class="token operator">=</span> TIM_OCMODE_PWM1<span class="token punctuation">;</span>    sConfigOC<span class="token punctuation">.</span>Pulse <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    sConfigOC<span class="token punctuation">.</span>OCPolarity <span class="token operator">=</span> TIM_OCPOLARITY_HIGH<span class="token punctuation">;</span>    sConfigOC<span class="token punctuation">.</span>OCFastMode <span class="token operator">=</span> TIM_OCFAST_DISABLE<span class="token punctuation">;</span>        <span class="token function">HAL_TIM_PWM_ConfigChannel</span><span class="token punctuation">(</span>htim<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sConfigOC<span class="token punctuation">,</span> channel<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">HAL_TIM_PWM_Start</span><span class="token punctuation">(</span>htim<span class="token punctuation">,</span> channel<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 设置电机速度</span><span class="token keyword">void</span> <span class="token function">Motor_SetSpeed</span><span class="token punctuation">(</span>TIM_HandleTypeDef<span class="token operator">*</span> htim<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> channel<span class="token punctuation">,</span> <span class="token keyword">float</span> speed<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 速度限幅 (-100% to 100%)</span>    speed <span class="token operator">=</span> <span class="token function">fmaxf</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1.0f</span><span class="token punctuation">,</span> <span class="token function">fminf</span><span class="token punctuation">(</span><span class="token number">1.0f</span><span class="token punctuation">,</span> speed<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 计算PWM占空比</span>    <span class="token class-name">uint32_t</span> pulse <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">fabsf</span><span class="token punctuation">(</span>speed<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>htim<span class="token operator">-></span>Init<span class="token punctuation">.</span>Period <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>speed <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// 正转</span>        <span class="token function">__HAL_TIM_SET_COMPARE</span><span class="token punctuation">(</span>htim<span class="token punctuation">,</span> channel<span class="token punctuation">,</span> pulse<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">Motor_SetDirection</span><span class="token punctuation">(</span>MOTOR_DIR_FORWARD<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// 反转</span>        <span class="token function">__HAL_TIM_SET_COMPARE</span><span class="token punctuation">(</span>htim<span class="token punctuation">,</span> channel<span class="token punctuation">,</span> pulse<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">Motor_SetDirection</span><span class="token punctuation">(</span>MOTOR_DIR_REVERSE<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>中断处理</strong> (<code>stm32l4xx_it.c</code>):</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// 1kHz定时器中断</span><span class="token keyword">void</span> TIM1极<span class="token function">_UP_TIM16_IRQHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__HAL_TIM_GET_FLAG</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>htim1<span class="token punctuation">,</span> TIM_FLAG_UPDATE<span class="token punctuation">)</span> <span class="token operator">!=</span> RESET<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__HAL_TIM_GET_IT_SOURCE</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>htim1<span class="token punctuation">,</span> TIM_IT_UPDATE<span class="token punctuation">)</span> <span class="token operator">!=</span> RESET<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">__HAL_TIM_CLEAR_IT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>htim1<span class="token punctuation">,</span> TIM_IT_UPDATE<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token comment">// 1kHz控制循环</span>            <span class="token function">Control_Loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// 控制循环</span><span class="token keyword">void</span> <span class="token function">Control_Loop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">static</span> <span class="token class-name">uint32_t</span> tick <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token comment">// 读取传感器数据</span>    MPU6050_Data imu_data<span class="token punctuation">;</span>    <span class="token function">MPU6050_ReadData</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>imu_data<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">int32_t</span> encoder_count <span class="token operator">=</span> <span class="token function">Encoder_GetCount</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>htim2<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 计算控制输出</span>    <span class="token keyword">float</span> control_output <span class="token operator">=</span> <span class="token function">PID_Update</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pid_controller<span class="token punctuation">,</span> target_speed<span class="token punctuation">,</span> current_speed<span class="token punctuation">,</span> <span class="token number">0.001f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 应用控制输出</span>    <span class="token function">Motor_SetSpeed</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>htim3<span class="token punctuation">,</span> TIM_CHANNEL_1<span class="token punctuation">,</span> control_output<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 定期发送数据（100Hz）</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>tick <span class="token operator">%</span> <span class="token number">10</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">Protocol_SendData</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>imu_data<span class="token punctuation">,</span> encoder_count<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>        tick<span class="token operator">++</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>配置参数</strong> (<code>showdata.ini</code>):</p><pre class="line-numbers language-ini" data-language="ini"><code class="language-ini"><span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">system</span><span class="token punctuation">]</span></span><span class="token key attr-name">control_frequency</span><span class="token punctuation">=</span><span class="token value attr-value">1000</span><span class="token key attr-name">uart_baudrate</span><span class="token punctuation">=</span><span class="token value attr-value">115200</span><span class="token key attr-name">i2c_speed</span><span class="token punctuation">=</span><span class="token value attr-value">400000</span><span class="token key attr-name">spi_speed</span><span class="token punctuation">=</span><span class="token value attr-value">10000000</span><span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">pid</span><span class="token punctuation">]</span></span><span class="token key attr-name">kp_linear</span><span class="token punctuation">=</span><span class="token value attr-value">0.8</span><span class="token key attr-name">ki_linear</span><span class="token punctuation">=</span><span class="token value attr-value">0.01</span><span class="token key attr-name">kd_linear</span><span class="token punctuation">=</span><span class="token value attr-value">0.05</span><span class="token key attr-name">kp_angular</span><span class="token punctuation">=</span><span class="token value attr-value">1.2</span><span class="token key attr-name">ki_angular</span><span class="token punctuation">=</span><span class="token value attr-value">0.02</span><span class="token key attr-name">kd_angular</span><span class="token punctuation">=</span><span class="token value attr-value">0.1</span><span class="token key attr-name">integral_max</span><span class="token punctuation">=</span><span class="token value attr-value">1000</span><span class="token key attr-name">output_max</span><span class="token punctuation">=</span><span class="token value attr-value">800</span><span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">encoder</span><span class="token punctuation">]</span></span><span class="token key attr-name">pulses_per_revolution</span><span class="token punctuation">=</span><span class="token value attr-value">2000</span><span class="token key attr-name">filter_alpha</span><span class="token punctuation">=</span><span class="token value attr-value">0.2</span><span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">mpu6050</span><span class="token punctuation">]</span></span><span class="token key attr-name">accel_scale</span><span class="token punctuation">=</span><span class="token value attr-value">16384.0</span><span class="token key attr-name">gyro_scale</span><span class="token punctuation">=</span><span class="token value attr-value">131.0</span><span class="token key attr-name">dlpf_bandwidth</span><span class="token punctuation">=</span><span class="token value attr-value">5</span><span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">motor</span><span class="token punctuation">]</span></span><span class="token key attr-name">pwm_frequency</span><span class="token punctuation">=</span><span class="token value attr-value">20000</span><span class="token key attr-name">max_duty_cycle</span><span class="token punctuation">=</span><span class="token value attr-value">950</span><span class="token key attr-name">min_duty_cycle</span><span class="token punctuation">=</span><span class="token value attr-value">50</span><span class="token key attr-name">dead_time</span><span class="token punctuation">=</span><span class="token value attr-value">100</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 机器人 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Stm32 </tag>
            
            <tag> Ros </tag>
            
            <tag> C++ </tag>
            
            <tag> OpenCV </tag>
            
            <tag> Docker </tag>
            
            <tag> Python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>每日知识点-16</title>
      <link href="/2025/06/16/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-16/"/>
      <url>/2025/06/16/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-16/</url>
      
        <content type="html"><![CDATA[<h2 id="每日知识点-15"><a class="markdownIt-Anchor" href="#每日知识点-15"></a> 每日知识点-15</h2><hr /><h3 id="题目1原子操作优化"><a class="markdownIt-Anchor" href="#题目1原子操作优化"></a> <strong>题目1：原子操作优化</strong></h3><p>类型​：性能优化题<br />​题目​：以下计数器哪种实现性能最优？</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// 方案A：std::mutex + int</span><span class="token comment">// 方案B：std::atomic&lt;int></span><span class="token comment">// 方案C：volatile int</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>答案​：方案B（std::atomic<int>）<br />​通俗解释​：原子操作无需锁，CPU指令级保证安全</p><p>技术解析​：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> <span class="token function">counter</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>counter<span class="token punctuation">.</span><span class="token function">fetch_add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 无锁高性能</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>应用场景​：高并发计数器（如QPS统计）</p><p>解析：<br />在多个线程同时修改同一个计数器时（比如高并发网站的访问量统计），如何设计计数器才能既保证正确性又兼顾性能？</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// 方案A：std::mutex + int       (互斥锁保护)</span><span class="token comment">// 方案B：std::atomic&lt;int>       (原子操作)</span><span class="token comment">// 方案C：volatile int           ("伪"同步)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>方案C：volatile int（危险！）​</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">volatile</span> <span class="token keyword">int</span> counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>counter<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token comment">// 多线程下不安全</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>工作原理​：<br />volatile仅保证变量不被编译器优化（每次从内存读取），​不保证操作的原子性<br />实际执行counter++包含3步：读值→计算→写回<br />性能​：🟢 执行快（无同步开销）<br />​正确性​：❌ ​完全错误​（数据竞争）<br />​结论​：​绝对禁止用于多线程计数器</p><p>方案A：std::mutex + int（安全但性能差）</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">std<span class="token double-colon punctuation">::</span>mutex mtx<span class="token punctuation">;</span><span class="token keyword">int</span> counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span>mtx<span class="token punctuation">)</span><span class="token punctuation">;</span>    counter<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token comment">// 线程安全但慢</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>工作原理​：<br />每次操作需要：加锁→修改→解锁<br />并发时线程会排队等待锁</p><p>性能​：<br />场景性能表现<br />低竞争⚠️ 一般（约50ns/次）<br />高竞争🔴 急剧下降（可能&gt;1000ns/次）<br />CPU缓存影响❌ 缓存失效频繁</p><p>方案B：std::atomic（性能最优解）</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> <span class="token function">counter</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>counter<span class="token punctuation">.</span><span class="token function">fetch_add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>工作原理​：<br />使用CPU原子指令（如x86的LOCK XADD）<br />硬件级保证操作不可分割</p><p>注意事项​：<br />使用memory_order_relaxed获得最佳性能（仅保证原子性，无全局同步）<br />对于简单计数器够用，但需根据场景谨慎选择内存序</p><p>扩展知识：<br />为什么atomic比mutex快这么多？​​</p><p>​硬件支持​：直接使用CPU的原子指令，无需系统调用<br />​无阻塞设计​：CAS（Compare-And-Swap）循环避免线程挂起<br />​缓存优化​：MESI协议保证缓存一致性，减少总线锁</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> x<span class="token punctuation">,</span> y<span class="token punctuation">;</span><span class="token comment">// 线程1</span>x<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// (1)</span>y<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// (2)</span><span class="token comment">// 线程2</span><span class="token keyword">while</span> <span class="token punctuation">(</span>y<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>  <span class="token comment">// (3)</span>std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> x<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// (4)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可能输出​：0（即使(1)在(2)前执行，线程2也可能先看到y=1而x仍为0）<br />​<strong>若改用memory_order_seq_cst</strong>​：保证(1)→(2)和(3)→(4)的顺序，输出必为1。</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> <span class="token function">x</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 线程A</span>x<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>memory_order_release<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 写操作同步点</span><span class="token comment">// 线程B</span>std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> x<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>memory_order_acquire<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 读操作同步点，必输出42</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><table><thead><tr><th style="text-align:center"><strong>场景</strong></th><th style="text-align:center"><strong>推荐内存序</strong></th><th style="text-align:center"><strong>原因</strong></th></tr></thead><tbody><tr><td style="text-align:center">独立计数器</td><td style="text-align:center"><code>relaxed</code></td><td style="text-align:center">只需原子性，无需同步其他操作</td></tr><tr><td style="text-align:center">生产者-消费者模型</td><td style="text-align:center"><code>release</code>(写)+<code>acquire</code>(读)</td><td style="text-align:center">保证数据发布的可见性</td></tr><tr><td style="text-align:center">多变量强一致性（如金融交易）</td><td style="text-align:center"><code>seq_cst</code></td><td style="text-align:center">避免任何重排，牺牲性能保安全</td></tr></tbody></table><p>写同步​：用release保证之前的操作对别人可见。<br />​读同步​：用acquire保证读到最新数据。<br />​配对使用​：release和acquire必须成对出现才能生效！</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;atomic></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;thread></span></span>std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> <span class="token function">x</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">></span> <span class="token function">ready</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">writer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    x<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>memory_order_release<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 关键点！</span>    ready<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">reader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>ready<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> x<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>memory_order_acquire<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 必输出42</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    std<span class="token double-colon punctuation">::</span>thread <span class="token function">t1</span><span class="token punctuation">(</span>writer<span class="token punctuation">)</span><span class="token punctuation">;</span>    std<span class="token double-colon punctuation">::</span>thread <span class="token function">t2</span><span class="token punctuation">(</span>reader<span class="token punctuation">)</span><span class="token punctuation">;</span>    t1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> t2<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>输出​：42（若去掉release/acquire，可能输出0）</p><h3 id="题目2死锁预防"><a class="markdownIt-Anchor" href="#题目2死锁预防"></a> <strong>题目2：死锁预防</strong></h3><p>类型​：简答题<br />​题目​：写出两种预防死锁的方法<br />答案​：</p><p>​固定加锁顺序​：所有线程按相同顺序获取锁<br />​RAII锁管理器​：用std::scoped_lock同时锁定多个互斥量</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">std<span class="token double-colon punctuation">::</span>scoped_lock <span class="token function">lock</span><span class="token punctuation">(</span>mutex1<span class="token punctuation">,</span> mutex2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// C++17</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>应用场景​：银行转账需锁两个账户时</p><h3 id="题目3线程池核心设计"><a class="markdownIt-Anchor" href="#题目3线程池核心设计"></a> <strong>题目3：线程池核心设计</strong></h3><p>类型​：编程题<br />​题目​：补全线程池的任务提交函数:</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token class-name">ThreadPool</span><span class="token double-colon punctuation">::</span><span class="token function">enqueue</span><span class="token punctuation">(</span>__________ task<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">&#123;</span>        std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span>queue_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>        tasks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    condition<span class="token punctuation">.</span><span class="token function">notify_one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>答案​：std::function&lt;void()&gt;&amp;&amp;<br />​技术解析​：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// 完整实现参考</span><span class="token keyword">using</span> Task <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>function<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">enqueue</span><span class="token punctuation">(</span>Task<span class="token operator">&amp;&amp;</span> task<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/*...*/</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>应用场景​：Web服务器处理并发请求</p><h3 id="题目4生产者-消费者模型"><a class="markdownIt-Anchor" href="#题目4生产者-消费者模型"></a> <strong>题目4：生产者-消费者模型</strong></h3><p>类型​：设计题<br />​题目​：用条件变量实现生产者-消费者队列，写出伪代码。</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">std<span class="token double-colon punctuation">::</span>queue<span class="token operator">&lt;</span>Data<span class="token operator">></span> buffer<span class="token punctuation">;</span>std<span class="token double-colon punctuation">::</span>mutex mtx<span class="token punctuation">;</span>std<span class="token double-colon punctuation">::</span>condition_variable cv_producer<span class="token punctuation">,</span> cv_consumer<span class="token punctuation">;</span><span class="token comment">// 生产者</span><span class="token keyword">void</span> <span class="token function">producer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    std<span class="token double-colon punctuation">::</span>unique_lock <span class="token function">lock</span><span class="token punctuation">(</span>mtx<span class="token punctuation">)</span><span class="token punctuation">;</span>    cv_producer<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>lock<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span> <span class="token keyword">return</span> buffer<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> MAX_SIZE<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    buffer<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>    cv_consumer<span class="token punctuation">.</span><span class="token function">notify_one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 消费者（类似，条件取反）</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>关键点​：双条件变量避免虚假唤醒</p><h3 id="题目5线程局部存储"><a class="markdownIt-Anchor" href="#题目5线程局部存储"></a> <strong>题目5：线程局部存储</strong></h3><p>类型​：选择题<br />​题目​：以下哪个实现线程独立的计数器？<br />A. static int count;<br />B. thread_local int count;<br />C. std::atomic<int> count;<br />​答案​：B<br />​通俗解释​：thread_local为每个线程创建变量副本。<br />​应用场景​：线程内日志ID、数据库连接</p><h3 id="题目6async-vs-thread"><a class="markdownIt-Anchor" href="#题目6async-vs-thread"></a> <strong>题目6：async vs thread</strong></h3><p>类型​：简答题<br />​题目​：std::async和直接创建线程的优势？<br />​答案​：</p><p>async：自动任务调度、可获取返回值（future）、可能复用线程<br />thread：更精细控制（如分离、优先级）</p><p>​应用场景​：需返回值的异步任务用async</p><h3 id="题目7线程安全单例"><a class="markdownIt-Anchor" href="#题目7线程安全单例"></a> <strong>题目7：线程安全单例</strong></h3><p>类型​：代码题<br />​题目​：写出C++11线程安全的单例模式。</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">Singleton</span> <span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token keyword">static</span> Singleton<span class="token operator">&amp;</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">static</span> Singleton instance<span class="token punctuation">;</span> <span class="token comment">// C++11保证初始化原子性</span>        <span class="token keyword">return</span> instance<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">Singleton</span><span class="token punctuation">(</span><span class="token keyword">const</span> Singleton<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span><span class="token keyword">private</span><span class="token operator">:</span>    <span class="token function">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>技术解析​：静态局部变量在C++11后是线程安全的</p>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> C++ </tag>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>每日知识点-15</title>
      <link href="/2025/06/15/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-15/"/>
      <url>/2025/06/15/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-15/</url>
      
        <content type="html"><![CDATA[<h2 id="每日知识点-15"><a class="markdownIt-Anchor" href="#每日知识点-15"></a> 每日知识点-15</h2><hr /><h3 id="题目1线程参数传递"><a class="markdownIt-Anchor" href="#题目1线程参数传递"></a> <strong>​题目1：线程参数传递</strong></h3><p>​类型​：代码分析题<br />题目​：以下代码输出结果是什么？为什么？</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">&amp;</span> x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> x <span class="token operator">*=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> val <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>    std<span class="token double-colon punctuation">::</span>thread <span class="token function">t</span><span class="token punctuation">(</span>update<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>    t<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> val<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>答案​：输出 5<br />通俗解释​：<br />线程默认按值传递参数，val被复制到线程内，原变量未修改。<br />技术解析​：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// 正确写法：使用std::ref传递引用</span>std<span class="token double-colon punctuation">::</span>thread <span class="token function">t</span><span class="token punctuation">(</span>update<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span><span class="token function">ref</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出10</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>应用场景​：多线程修改共享配置时需传递引用</p><h3 id="题目2互斥锁raii管理"><a class="markdownIt-Anchor" href="#题目2互斥锁raii管理"></a> <strong>题目2：互斥锁RAII管理</strong></h3><p>类型​：简答题<br />​题目​：std::lock_guard和std::unique_lock的区别？</p><p>答案​：</p><p>lock_guard：构造时加锁，析构时解锁，不可手动控制<br />unique_lock：支持延迟加锁、条件变量、锁所有权转移</p><p>​通俗解释​：lock_guard像自动门锁，unique_lock像带遥控的手动锁。<br />​应用场景​：简单同步用lock_guard；条件变量必须用unique_lock</p><p>解答：<br />核心目标相同：​​ 它们俩都像“智能门卫”，帮你自动管理锁（std::mutex）。你开门（加锁）进去办事（访问共享数据），出来时“门卫”自动帮你锁门（解锁），这样你就不会忘记锁门（死锁）了</p><p>主要区别在于“灵活性”：​</p><ol><li>​<strong>std::lock_guard：简单可靠的“自动门卫”​</strong></li></ol><ul><li>工作方式：​​<br />你一把它请来（构造它），它立刻就把门锁上（自动加锁）。你办完事，走出办公室（作用域结束），它立刻就把门解锁（自动解锁）</li><li>特点：​​<br />​简单直接：​​ 不需要你操心什么时候锁、什么时候解锁。<br />​不能中途开门：​​ 一旦它锁上门，在它“退休”（析构）之前，你不能手动命令它临时开门（解锁），它也不会自己开门<br />​不能迟到：​​ 它一上岗就锁门，你不能让它先等等再锁<br />​不能换岗：​​ 你不能把这个“门卫”转交给别人管理（不可移动）</li><li>适用场景：​​<br />你进办公室做的事情很简单、很连贯，一口气做完就出来。比如：</li></ul><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token function">updateSharedCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">></span> <span class="token function">guard</span><span class="token punctuation">(</span>shared_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 进门就锁门</span>    shared_counter<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token comment">// 快速改个数字</span>    <span class="token comment">// ... 其他简单操作 ...</span><span class="token punctuation">&#125;</span> <span class="token comment">// guard 退休，自动开门</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="2"><li>​<strong>std::unique_lock：功能强大的“智能遥控门卫”​</strong></li></ol><ul><li>工作方式：​​<br />你可以告诉它不同的上岗方式（通过第二个参数）。默认情况下，它和 lock_guard 一样，一来就锁门。但你可以让它更灵活</li></ul><p>延迟上岗锁门 (std::defer_lock)：<br />​​它先来站岗，但不立刻锁门。你可以在需要的时候再命令它锁门（.lock()）。</p><p>​接手已锁的门 (std::adopt_lock)：​​<br />如果门已经被你手动锁上了，你可以告诉它来接手，它只负责最后帮你解锁。</p><p>​尝试锁门 (std::try_to_lock)：​​<br />它去试试锁门，如果锁被别人占着锁不上，它不会傻等，会告诉你“没锁上”，你可以干点别的。</p><ul><li>特点：​​<br />​灵活控制：​​<br />你可以随时命令它锁门（.lock()）或者临时开门（.unlock()）​。开了门你可以在外面办点不涉及共享资源的事，办完再命令它锁门（.lock()）你继续进去干共享资源的活。</li></ul><p>​可以换岗：​​<br />你可以把这个“门卫”的管理权转交给另一个地方（支持移动语义）。<br />​<br />能和“通知员”（条件变量）配合：​​<br />这是它最重要的特殊技能！当“通知员”（std::condition_variable）需要你在等待时临时开门让其他线程进来干活时，必须用 unique_lock。lock_guard 做不到这点。</p><ul><li>适用场景：​​<br />​场景一：​​ 你需要先做些不涉及共享数据的准备工作，准备好了再进去操作共享数据</li></ul><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token function">complexTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 先做一些不涉及共享数据的准备工作...</span>    std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">></span> <span class="token function">ulock</span><span class="token punctuation">(</span>shared_mutex<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>defer_lock<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 门卫来了，但门没锁</span>    <span class="token comment">// ... 继续做准备工作 ...</span>    ulock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 准备工作做完，现在命令门卫锁门，开始操作共享数据</span>    <span class="token comment">// ... 操作共享数据 ...</span>    ulock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 共享数据操作完了，临时开门，出去做点收尾工作（不涉共享）</span>    <span class="token comment">// ... 收尾工作 ...</span><span class="token punctuation">&#125;</span> <span class="token comment">// ulock 退休，如果门开着它会自动锁上</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>场景二：​​ ​配合“通知员”（条件变量）等待某个条件成立</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">std<span class="token double-colon punctuation">::</span>mutex mtx<span class="token punctuation">;</span>std<span class="token double-colon punctuation">::</span>condition_variable cv<span class="token punctuation">;</span><span class="token keyword">bool</span> data_ready <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">consumer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">></span> <span class="token function">ulock</span><span class="token punctuation">(</span>mtx<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 锁门进去检查</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>data_ready<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 条件没满足</span>        cv<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>ulock<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 关键！通知员会命令门卫临时开门(解锁)并让你睡觉。醒来后门卫自动重新锁门。</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// 此时 data_ready 为 true，且门是锁着的，安全消费数据...</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>场景三：​​ 你需要临时释放锁去做别的事情。</p><p>​场景四：​​ 你需要转移锁的所有权​（较少见）。</p><p>总结对比表：​</p><table><thead><tr><th style="text-align:left"><code>std::lock_guard</code> (自动门卫)</th><th style="text-align:left"><code>std::unique_lock</code> (遥控门卫)</th><th></th></tr></thead><tbody><tr><td style="text-align:left"><strong>自动加锁解锁(核心)</strong></td><td style="text-align:left">✅ 构造时加锁，析构时解锁</td><td>✅ 构造时<em>可选择</em>加锁，析构时解锁</td></tr><tr><td style="text-align:left"><strong>能否手动解锁?</strong></td><td style="text-align:left">❌ 不行</td><td>✅ 可以 <code>.unlock()</code></td></tr><tr><td style="text-align:left"><strong>能否手动加锁?</strong></td><td style="text-align:left">❌ 不行</td><td>✅ 可以 <code>.lock()</code> (如果构造时没加)</td></tr><tr><td style="text-align:left"><strong>能否延迟加锁?</strong></td><td style="text-align:left">❌ 不行</td><td>✅ 可以 (<code>std::defer_lock</code>)</td></tr><tr><td style="text-align:left"><strong>能否接管已加锁的互斥量?</strong></td><td style="text-align:left">❌ 不行</td><td>✅ 可以 (<code>std::adopt_lock</code>)</td></tr><tr><td style="text-align:left"><strong>能否尝试加锁?</strong></td><td style="text-align:left">❌ 不行</td><td>✅ 可以 (<code>std::try_to_lock</code>)</td></tr><tr><td style="text-align:left"><strong>能否转移所有权?</strong></td><td style="text-align:left">❌ 不行</td><td>✅ 可以 (移动语义)</td></tr><tr><td style="text-align:left"><strong>能否配合条件变量?</strong></td><td style="text-align:left">❌ 不行</td><td>✅ <strong>必须</strong>用它</td></tr><tr><td style="text-align:left"><strong>性能开销</strong></td><td style="text-align:left">⭐⭐ 更低 (简单)</td><td>⭐ 更高 (功能多，需维护状态)</td></tr><tr><td style="text-align:left"><strong>典型使用场景</strong></td><td style="text-align:left">简单、快速的临界区操作</td><td>需要灵活控制锁、配合条件变量、复杂同步逻辑</td></tr></tbody></table><p>通俗解释（用门卫比喻）：​​</p><p>std::lock_guard 就像一个非常尽责但死板的门卫。你一把钥匙（互斥量）交给他，他立刻就把门锁上。你进门办事，办完了出来，他立刻又把门锁上。整个过程你不能命令他“先别锁”、“现在开一下门我出去透透气”。他就是锁门-&gt;开门-&gt;锁门，简单可靠。</p><p>std::unique_lock 就像一个更智能、听指挥的门卫。你可以告诉他：“拿着钥匙，但先别锁门”（defer_lock），等你准备好了喊一声“锁门”他才锁（lock()）。办完共享数据的事，你可以说“开门，我出去办点私事”（unlock()），他开门让你出去，你办完私事回来喊“锁门”（lock()）他又锁上门让你继续操作共享数据。最重要的是，它能和“通知员”（条件变量）完美配合，在需要等待时帮你开门并让你休息。</p><p>选择建议：​​</p><p>​能用 lock_guard 就用它：​​<br />它简单高效，适用于绝大多数只需要在作用域内保护共享数据的场景。<br />​需要灵活性就用 unique_lock：​​<br />当你需要延迟加锁、手动解锁、尝试加锁、配合条件变量或者转移锁的所有权时，​必须使用 unique_lock。特别是<strong>条件变量，只能用 unique_lock</strong>​</p><h3 id="题目3条件变量陷阱"><a class="markdownIt-Anchor" href="#题目3条件变量陷阱"></a> <strong>题目3：条件变量陷阱</strong></h3><p>类型​：代码改错题<br />​题目​：修复以下代码的死锁问题：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">std<span class="token double-colon punctuation">::</span>mutex mtx<span class="token punctuation">;</span>std<span class="token double-colon punctuation">::</span>condition_variable cv<span class="token punctuation">;</span><span class="token keyword">bool</span> ready <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">consumer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span>mtx<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 错误点</span>    cv<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>lock<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span> <span class="token keyword">return</span> ready<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 死锁！</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>答案：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token function">consumer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span>mtx<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 必须用unique_lock</span>    cv<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>lock<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span> <span class="token keyword">return</span> ready<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>技术解析​：condition_variable.wait() 只接受unique_lock，因其需临时解锁</p><p><strong>wait() 的内部工作流程</strong>:<br />wait() 的操作是原子化的，包含三个关键步骤：</p><ul><li>检查条件并解锁​：<br />线程调用 wait() 时，首先检查条件（若提供 Predicate 参数）。<br />条件满足时​：不释放锁、不阻塞，直接继续执行<br />条件不满足时​：原子化执行解锁+阻塞​（非先解锁后阻塞）<br />解锁+阻塞必须是原子操作​：这是标准强制要求，具体实现可能：</li></ul><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// 伪代码：Linux futex 实现</span><span class="token keyword">void</span> <span class="token function">unlock_wait_lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    atomic <span class="token punctuation">&#123;</span>        mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">add_to_wait_queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 原子操作内完成解锁和加入等待队列</span>    <span class="token punctuation">&#125;</span>    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 阻塞</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><p>​阻塞等待通知​：<br />线程进入阻塞状态，直到被 notify_one() 或 notify_all() 唤醒，或遭遇虚假唤醒。</p></li><li><p>​唤醒后重新加锁​：<br />线程被唤醒时，​自动重新获取互斥锁​（lck.lock()），恢复对共享数据的独占访问</p></li></ul>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> C++ </tag>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>每日知识点-14</title>
      <link href="/2025/06/14/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-14/"/>
      <url>/2025/06/14/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-14/</url>
      
        <content type="html"><![CDATA[<h2 id="每日知识点-14"><a class="markdownIt-Anchor" href="#每日知识点-14"></a> 每日知识点-14</h2><hr /><h3 id="1-智能指针与资源管理"><a class="markdownIt-Anchor" href="#1-智能指针与资源管理"></a> 1. <strong>智能指针与资源管理</strong></h3><ol><li><p><strong><code>unique_ptr</code></strong>（独占所有权）</p> <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">auto</span> data <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_unique</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 自动释放数组</span><span class="token keyword">auto</span> moved_data <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">// 所有权转移（原指针失效）</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li><p><strong><code>shared_ptr</code> + <code>weak_ptr</code></strong>（避免循环引用）</p> <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">Node</span> <span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>    std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>Node<span class="token operator">></span> next<span class="token punctuation">;</span>    std<span class="token double-colon punctuation">::</span>weak_ptr<span class="token operator">&lt;</span>Node<span class="token operator">></span> prev<span class="token punctuation">;</span>  <span class="token comment">// 弱引用打破循环</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">auto</span> node1 <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>Node<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">auto</span> node2 <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>Node<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>node1<span class="token operator">-></span>next <span class="token operator">=</span> node2<span class="token punctuation">;</span>node2<span class="token operator">-></span>prev <span class="token operator">=</span> node1<span class="token punctuation">;</span>  <span class="token comment">// 安全！</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><hr /><h3 id="2-线程同步高级技巧"><a class="markdownIt-Anchor" href="#2-线程同步高级技巧"></a> 2. <strong>线程同步高级技巧</strong></h3><h4 id="1-条件变量生产者-消费者模型"><a class="markdownIt-Anchor" href="#1-条件变量生产者-消费者模型"></a> <strong>1. 条件变量（生产者-消费者模型）</strong></h4><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">std<span class="token double-colon punctuation">::</span>queue<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> buffer<span class="token punctuation">;</span>std<span class="token double-colon punctuation">::</span>mutex mtx<span class="token punctuation">;</span>std<span class="token double-colon punctuation">::</span>condition_variable cv<span class="token punctuation">;</span><span class="token comment">// 生产者</span><span class="token keyword">void</span> <span class="token function">producer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span>mtx<span class="token punctuation">)</span><span class="token punctuation">;</span>    buffer<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    cv<span class="token punctuation">.</span><span class="token function">notify_one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 通知消费者</span><span class="token punctuation">&#125;</span><span class="token comment">// 消费者</span><span class="token keyword">void</span> <span class="token function">consumer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span>mtx<span class="token punctuation">)</span><span class="token punctuation">;</span>    cv<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>lock<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token operator">!</span>buffer<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 等待条件满足</span>    <span class="token keyword">int</span> data <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    buffer<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="2-原子操作无锁计数器"><a class="markdownIt-Anchor" href="#2-原子操作无锁计数器"></a> <strong>2. 原子操作（无锁计数器）</strong></h4><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> <span class="token function">counter</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>counter<span class="token punctuation">.</span><span class="token function">fetch_add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 无锁递增（性能优化）</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><hr /><h3 id="3-线程池实战高性能核心"><a class="markdownIt-Anchor" href="#3-线程池实战高性能核心"></a> 3. <strong>线程池实战（高性能核心）</strong></h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// 简化的线程池实现（核心逻辑）</span><span class="token keyword">class</span> <span class="token class-name">ThreadPool</span> <span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token keyword">void</span> <span class="token function">enqueue_task</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>function<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> task<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token punctuation">&#123;</span>            std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span>queue_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>            tasks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        condition<span class="token punctuation">.</span><span class="token function">notify_one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 唤醒工作线程</span>    <span class="token punctuation">&#125;</span><span class="token keyword">private</span><span class="token operator">:</span>    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>thread<span class="token operator">></span> workers<span class="token punctuation">;</span>    std<span class="token double-colon punctuation">::</span>queue<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>function<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">>></span> tasks<span class="token punctuation">;</span>    std<span class="token double-colon punctuation">::</span>mutex queue_mutex<span class="token punctuation">;</span>    std<span class="token double-colon punctuation">::</span>condition_variable condition<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// 使用示例</span>pool<span class="token punctuation">.</span><span class="token function">enqueue_task</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span> std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Task executed!"</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="4-四大避坑指南"><a class="markdownIt-Anchor" href="#4-四大避坑指南"></a> 4. <strong>四大避坑指南</strong></h3><ol><li><strong>死锁预防</strong></li></ol><ul><li><p>固定锁获取顺序（如先锁A再锁B）, 强制所有线程按全局统一的顺序获取锁，避免形成“A等B、B等A”的循环等待链<br /><strong>实现方式</strong>：</p><ul><li><p>为锁对象编号：在初始化时为每个锁分配唯一序号（如哈希值），线程必须按序号升序获取锁。</p></li><li><p>动态排序：在获取锁前比较对象地址或哈希值，确定固定顺序后再锁定。</p></li></ul><p><strong>代码示例</strong>：</p>  <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token function">safeOperation</span><span class="token punctuation">(</span>Object<span class="token operator">&amp;</span> a<span class="token punctuation">,</span> Object<span class="token operator">&amp;</span> b<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 动态确定锁顺序：按对象地址排序</span>    <span class="token keyword">auto</span><span class="token operator">&amp;</span> first <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>a<span class="token punctuation">,</span> <span class="token operator">&amp;</span>b<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">auto</span> x<span class="token punctuation">,</span> <span class="token keyword">auto</span> y<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">less</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">auto</span><span class="token operator">&amp;</span> second <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>a <span class="token operator">==</span> <span class="token operator">&amp;</span>first<span class="token punctuation">)</span> <span class="token operator">?</span> b <span class="token operator">:</span> a<span class="token punctuation">;</span>    std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">></span> <span class="token function">lock1</span><span class="token punctuation">(</span>first<span class="token punctuation">.</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>    std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">></span> <span class="token function">lock2</span><span class="token punctuation">(</span>second<span class="token punctuation">.</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 操作共享资源</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>适用场景</strong>：</p><ul><li>需要同时锁定多个对象的场景（如转账操作需锁定两个账户）。</li></ul><p>优势：逻辑清晰，彻底避免循环等待。</p><p>风险：若锁对象动态创建，需确保全局顺序一致性。</p></li><li><p>用<code>std::lock()</code>同时锁定多个互斥量：一次性原子化锁定多个互斥量，避免线程在持有部分锁时等待其他锁，从而破坏“请求与保持”条件</p><p><strong>实现方式</strong>：</p><ul><li><p><strong><code>std::lock(m1, m2, ...)</code></strong>：原子性地获取所有传入的互斥锁，若任一锁不可用则阻塞直至全部可用。</p></li><li><p>搭配<code>lock_guard</code>管理生命周期：用<code>std::adopt_lock</code>标记已锁定的互斥量，避免重复加锁。</p></li></ul></li></ul><ol start="2"><li><strong>数据竞争</strong><br />指多个线程同时访问同一共享数据时，至少有一个线程执行写操作，且未采用同步机制保护数据，导致程序行为不可预测</li></ol><ul><li><p>共享数据必须用互斥锁或原子变量保护</p></li><li><p>使用<code>thread_local</code>替代静态变量实现线程局部存储：<br />声明<code>thread_local</code>变量时，<strong>每个线程拥有独立副本</strong>，彻底避免共享数据竞争</p>  <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">thread_local</span> <span class="token keyword">int</span> local_counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">// 每个线程独立副本</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><table><thead><tr><th><strong>场景</strong></th><th><strong>推荐方案</strong></th><th><strong>原因</strong></th></tr></thead><tbody><tr><td>高频简单计数器</td><td><code>std::atomic</code></td><td>无锁高性能，避免线程阻塞</td></tr><tr><td>复杂数据结构操作</td><td>互斥锁</td><td>确保多步骤操作原子性</td></tr><tr><td>线程私有状态（如缓存）</td><td><code>thread_local</code></td><td>零同步开销，天然线程安全</td></tr><tr><td>读多写少的数据</td><td><code>std::shared_mutex</code></td><td>允许多读线程并发，写线程独占[8]</td></tr></tbody></table><ul><li><p>​独立副本​：thread_local 变量在每个线程首次访问时初始化，生命周期与线程绑定</p></li><li><p>​底层实现​：编译器为每个线程分配独立的存储区（如线程局部存储 TLS），通过线程 ID 隐式定位变量副本</p></li><li><p>​初始化安全​：C++11 保证 thread_local 的初始化线程安全（类似静态局部变量的 magic static）</p></li></ul>  <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;thread></span></span><span class="token keyword">thread_local</span> <span class="token keyword">int</span> counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">// 每个线程独立副本</span><span class="token keyword">void</span> <span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    counter<span class="token operator">++</span><span class="token punctuation">;</span>  <span class="token comment">// 仅修改当前线程的副本</span>    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Thread "</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>this_thread<span class="token double-colon punctuation">::</span><span class="token function">get_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span>             <span class="token operator">&lt;&lt;</span> <span class="token string">": "</span> <span class="token operator">&lt;&lt;</span> counter <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    std<span class="token double-colon punctuation">::</span>thread <span class="token function">t1</span><span class="token punctuation">(</span>increment<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// t1 的 counter 初始为 0 → 1</span>    std<span class="token double-colon punctuation">::</span>thread <span class="token function">t2</span><span class="token punctuation">(</span>increment<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// t2 的 counter 初始为 0 → 1</span>    t1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> t2<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>​输出​：<br />Thread A: 1<br />Thread B: 1<br />（无数据竞争，各线程独立计数）<br />在类中声明 thread_local 需注意：</p></blockquote><p>​类内声明​：使用 static thread_local 声明静态成员变量（非静态成员不能是 thread_local）。<br />​类外初始化​：必须在类外全局作用域初始化</p>  <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">MyClass</span> <span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token keyword">static</span> <span class="token keyword">thread_local</span> <span class="token keyword">int</span> id<span class="token punctuation">;</span>  <span class="token comment">// 声明静态 thread_local</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">thread_local</span> <span class="token keyword">int</span> MyClass<span class="token double-colon punctuation">::</span>id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">// 类外初始化</span><span class="token keyword">void</span> <span class="token function">use_class</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    MyClass<span class="token double-colon punctuation">::</span>id <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Thread "</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>this_thread<span class="token double-colon punctuation">::</span><span class="token function">get_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span>             <span class="token operator">&lt;&lt;</span> <span class="token string">" - ID: "</span> <span class="token operator">&lt;&lt;</span> MyClass<span class="token double-colon punctuation">::</span>id <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    std<span class="token double-colon punctuation">::</span>thread <span class="token function">t1</span><span class="token punctuation">(</span>use_class<span class="token punctuation">)</span><span class="token punctuation">;</span>    std<span class="token double-colon punctuation">::</span>thread <span class="token function">t2</span><span class="token punctuation">(</span>use_class<span class="token punctuation">)</span><span class="token punctuation">;</span>    t1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> t2<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>​结果​：每个线程独立设置和读取 MyClass::id</p></blockquote></li></ul><ol start="3"><li><strong>资源泄漏</strong></li></ol><ul><li><p>文件/网络句柄用</p>  <pre class="line-numbers language-none"><code class="language-none">unique_ptr<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>自定义删除器：</p>  <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">auto</span> file <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">unique_ptr</span><span class="token generic class-name"><span class="token operator">&lt;</span>FILE<span class="token punctuation">,</span> <span class="token keyword">decltype</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fclose<span class="token punctuation">)</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">"log.txt"</span><span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fclose<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ul><ol start="4"><li><p><strong>性能陷阱</strong></p><ul><li><p>避免锁粒度太大（如锁住整个函数）</p></li><li><p>无锁数据结构优先（如 <code>std::atomic</code>替代锁）</p></li></ul></li></ol>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> C++ </tag>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>每日知识点-13</title>
      <link href="/2025/06/12/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-13/"/>
      <url>/2025/06/12/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-13/</url>
      
        <content type="html"><![CDATA[<h2 id="每日知识点-13"><a class="markdownIt-Anchor" href="#每日知识点-13"></a> 每日知识点-13</h2><hr /><h3 id="1-智能指针c11"><a class="markdownIt-Anchor" href="#1-智能指针c11"></a> 1. <strong>智能指针（C++11）</strong></h3><ul><li><p><code>unique_ptr</code></p><blockquote><p>独占所有权（不可拷贝），移动语义传递</p></blockquote>  <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">auto</span> ptr <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_unique</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 自动释放内存</span><span class="token keyword">auto</span> ptr2 <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">// 所有权转移</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li><p><code>shared_ptr</code></p><blockquote><p>引用计数共享所有权，循环引用需用<code>weak_ptr</code>解决</p></blockquote>  <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">auto</span> obj <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>MyClass<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>std<span class="token double-colon punctuation">::</span>weak_ptr<span class="token operator">&lt;</span>MyClass<span class="token operator">></span> observer <span class="token operator">=</span> obj<span class="token punctuation">;</span>  <span class="token comment">// 避免循环引用</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li></ul><h3 id="2-移动语义c11"><a class="markdownIt-Anchor" href="#2-移动语义c11"></a> 2. <strong>移动语义（C++11）</strong></h3><ul><li><p>右值引用（<code>&amp;&amp;</code>）：优化资源转移（如避免深拷贝）</p>  <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">Vector</span> <span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token function">Vector</span><span class="token punctuation">(</span>Vector<span class="token operator">&amp;&amp;</span> other<span class="token punctuation">)</span> <span class="token keyword">noexcept</span>   <span class="token comment">// 移动构造函数 声明移动操作不抛异常，便于编译器优化</span>        <span class="token operator">:</span> <span class="token function">data_</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>data_<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">size_</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>size_<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        other<span class="token punctuation">.</span>data_ <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>        <span class="token comment">// 置空原指针防双重释放, 确保原对象析构时不会释放已转移的内存</span>    <span class="token punctuation">&#125;</span><span class="token keyword">private</span><span class="token operator">:</span>    <span class="token keyword">int</span><span class="token operator">*</span> data_<span class="token punctuation">;</span>    size_t size_<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><code>std::move</code></p><blockquote><p>显式转换左值为右值，触发移动操作</p></blockquote>  <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">Vector v1<span class="token punctuation">;</span>Vector v2 <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>v1<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 调用移动构造</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li></ul><h4 id="触发移动构造的典型场景"><a class="markdownIt-Anchor" href="#触发移动构造的典型场景"></a> <strong>触发移动构造的典型场景</strong></h4><ul><li><p>返回临时对象：</p>  <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">Vector <span class="token function">createVector</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    Vector tmp<span class="token punctuation">;</span>    <span class="token keyword">return</span> tmp<span class="token punctuation">;</span>  <span class="token comment">// 编译器自动优化为移动构造（RVO 或移动语义）</span><span class="token punctuation">&#125;</span>Vector v <span class="token operator">=</span> <span class="token function">createVector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 移动构造被调用</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>显式使用 <code>std::move</code></p>  <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">Vector v1<span class="token punctuation">;</span>Vector v2 <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>v1<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// v1 的资源被转移到 v2，v1 失效</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li></ul><hr /><h4 id="重要注意事项"><a class="markdownIt-Anchor" href="#重要注意事项"></a> <strong>重要注意事项</strong></h4><ul><li><p>移动后原对象状态：</p><p>原对象（如<code>other</code>）应进入有效但未定义状态通常只允许析构或重新赋值）。</p>  <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">Vector <span class="token function">v1</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Vector v2 <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>v1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// v1.data_ 已为 nullptr，不能再访问 v1[0]！</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li><li><p>与析构函数的配合：</p><p>移动后的原对象析构时必须安全（即<code>delete nullptr</code>是安全的。</p></li><li><p>自赋值检查：</p><p>移动赋值运算符中需检查<code>if (this != &amp;other)</code>，但移动构造无需（因构造时<code>this</code>尚未存在）。</p></li></ul><h3 id="3-lambda表达式"><a class="markdownIt-Anchor" href="#3-lambda表达式"></a> 3. <strong>Lambda表达式</strong></h3><ul><li><p>捕获列表：</p><ol><li><p><code>[&amp;]</code>捕获引用，捕获 Lambda 所在作用域内所有被使用的外部变量的引用，允许在 Lambda 内部直接修改外部变量。</p><p>​特点​：<br />修改外部变量会影响原始值<br />需警惕悬垂引用（Lambda 生命周期 &gt; 外部变量时）</p> <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token keyword">auto</span> lambda <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span>     a <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>  <span class="token comment">// 修改外部变量 a</span>    <span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token function">lambda</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 输出 12</span>std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> a<span class="token punctuation">;</span>  <span class="token comment">// 输出 10（外部 a 被修改）</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><code>[=]</code>捕获值，捕获 Lambda 所在作用域内所有被使用的外部变量的副本（值拷贝）。</p><p>特点​：<br />外部变量修改不影响 Lambda 内部的副本<br />默认 const，需 mutable 才能修改副本（不影响外部）</p> <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span><span class="token keyword">auto</span> lambda <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">=</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">mutable</span> <span class="token punctuation">&#123;</span>    x<span class="token operator">++</span><span class="token punctuation">;</span>  <span class="token comment">// 修改副本（需 mutable）</span>    <span class="token keyword">return</span> x<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token function">lambda</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 输出 6（副本值）</span>std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> x<span class="token punctuation">;</span>  <span class="token comment">// 输出 5（外部 x 不变）</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><code>[this]</code>捕获当前对象, 捕获当前类的 this 指针，允许 Lambda 访问类的成员变量和函数。</p><p>特点​：<br />本质是捕获 this 指针，通过 this-&gt;member 访问成员<br />成员变量的值是实时的（非定义时拷贝）<br />需警惕悬垂 this（对象销毁后调用 Lambda）</p> <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">Widget</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> value <span class="token operator">=</span> <span class="token number">42</span><span class="token punctuation">;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token keyword">auto</span> <span class="token function">getLambda</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span>             <span class="token keyword">return</span> value<span class="token punctuation">;</span>  <span class="token comment">// 等价于 this->value</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>Widget w<span class="token punctuation">;</span><span class="token keyword">auto</span> func <span class="token operator">=</span> w<span class="token punctuation">.</span><span class="token function">getLambda</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 输出 42</span>w<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>       <span class="token comment">// 修改成员</span>std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 输出 100（实时访问）</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre> <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> vec <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>std<span class="token double-colon punctuation">::</span><span class="token function">for_each</span><span class="token punctuation">(</span>vec<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> vec<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> x <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>  <span class="token comment">// 输出2 4 6</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>空捕获列表 [] :<br />​不捕获任何局部变量</p> <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token function">example</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> local <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>    <span class="token keyword">auto</span> lambda <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span>         <span class="token comment">// 错误！无法访问 local</span>        <span class="token comment">// std::cout &lt;&lt; local; </span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可访问全局变量和静态变量</p> <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> global <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">example</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">static</span> <span class="token keyword">int</span> s <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>    <span class="token keyword">auto</span> lambda <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span>        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> global<span class="token punctuation">;</span> <span class="token comment">// ✅ 合法（全局变量）</span>        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> s<span class="token punctuation">;</span>      <span class="token comment">// ✅ 合法（静态变量）</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>不能直接访问成员变量<br />​参数和函数体不受影响</p> <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">auto</span> add <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>     <span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span> <span class="token comment">// ✅ 仅依赖参数</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li><li><p>混合捕获：</p> <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token keyword">auto</span> lambda <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">=</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>b<span class="token punctuation">]</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// 按值捕获 a，按引用捕获 b</span>    <span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>b <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span><span class="token function">lambda</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 输出 4（a=1 快照 + b=3 实时）</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol></li></ul><h3 id="4-类型推导与结构化绑定c17"><a class="markdownIt-Anchor" href="#4-类型推导与结构化绑定c17"></a> 4. <strong>类型推导与结构化绑定（C++17）</strong></h3><ul><li><p><code>auto</code>：自动推导变量类型</p>  <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">auto</span> dict <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>map<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>string<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">></span><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span><span class="token string">"A"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token string">"B"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>结构化绑定：解包复合类型</p>  <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> <span class="token punctuation">[</span>key<span class="token punctuation">,</span> value<span class="token punctuation">]</span> <span class="token operator">:</span> dict<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// 直接访问键值对</span>    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> key <span class="token operator">&lt;&lt;</span> <span class="token string">":"</span> <span class="token operator">&lt;&lt;</span> value<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="5-编译时计算"><a class="markdownIt-Anchor" href="#5-编译时计算"></a> 5. <strong>编译时计算</strong></h3><ul><li><p><code>constexpr</code>函数：编译期执行计算</p>  <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">constexpr</span> <span class="token keyword">int</span> <span class="token function">factorial</span><span class="token punctuation">(</span><span class="token keyword">int</span> n<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> n <span class="token operator">*</span> <span class="token function">factorial</span><span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static_assert</span><span class="token punctuation">(</span><span class="token function">factorial</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">120</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 编译期断言</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="6-线程管理"><a class="markdownIt-Anchor" href="#6-线程管理"></a> 6. <strong>线程管理</strong></h3><ul><li><p><strong><code>std::thread</code></strong>：创建线程</p>  <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token function">task</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* 耗时操作 */</span> <span class="token punctuation">&#125;</span>std<span class="token double-colon punctuation">::</span>thread <span class="token function">t</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 启动线程</span>t<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment">// 等待结束</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li><li><p>异步任务：</p><p><code>std::async</code> + <code>std::future</code></p>  <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">auto</span> future <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">async</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>launch<span class="token double-colon punctuation">::</span>async<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token number">42</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> result <span class="token operator">=</span> future<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 阻塞获取结果</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li><strong>std::async</strong>​：启动异步任务，返回std::future对象<ul><li>std::launch::async：强制在新线程中执行（适合CPU密集型任务）</li><li>std::launch::deferred：延迟执行（调用get()时在当前线程执行，适合资源敏感型任务）</li><li>默认策略（async|deferred）：由编译器决定执行方式（需谨慎使用）</li></ul></li><li><strong>std::future</strong>​：异步结果的“提货单”，提供阻塞或非阻塞的结果获取方式<ul><li>任务返回值存入共享状态（shared state），std::future通过指针关联此状态</li><li>future.get()：​阻塞当前线程<ul><li>替代方案：用wait_for()实现超时等待</li></ul>  <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">if</span> <span class="token punctuation">(</span>future<span class="token punctuation">.</span><span class="token function">wait_for</span><span class="token punctuation">(</span><span class="token number">1</span>s<span class="token punctuation">)</span> <span class="token operator">==</span> std<span class="token double-colon punctuation">::</span>future_status<span class="token double-colon punctuation">::</span>ready<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    result <span class="token operator">=</span> future<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 非阻塞获取结果</span><span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 处理超时或任务未完成</span><span class="token punctuation">&#125;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>异步任务中的异常会通过get()重新抛出到调用线程：  <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">try</span> <span class="token punctuation">&#123;</span>    future<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>exception<span class="token operator">&amp;</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    std<span class="token double-colon punctuation">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"异步任务异常: "</span> <span class="token operator">&lt;&lt;</span> e<span class="token punctuation">.</span><span class="token function">what</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>std::future不可复制，但支持移动语义（future2 = std::move(future1)）</li></ul></li></ul></li></ul><ol start="2"><li><strong>同步机制</strong></li></ol><ul><li><p>互斥锁：<code>std::mutex</code> + <code>std::lock_guard</code></p>  <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">std<span class="token double-colon punctuation">::</span>mutex mtx<span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">safe_push</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span><span class="token operator">&amp;</span> vec<span class="token punctuation">,</span> <span class="token keyword">int</span> val<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span>mtx<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 自动加锁/解锁</span>    vec<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>原子操作：<code>std::atomic</code>无锁并发</p>  <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> <span class="token function">counter</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>counter<span class="token punctuation">.</span><span class="token function">fetch_add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 无锁递增</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li><p>原子操作的核心作用​</p><ol><li>​解决数据竞争​：<br />普通变量（如int counter）在多线程中同时读写时，可能因操作被中断导致结果错误（例如两个线程同时读取counter=0，各自加1后写回，结果变为1而非2）。</li><li>​原子性保证​：<br />std::atomic确保操作（如fetch_add）是不可分割的。例如，当一个线程执行fetch_add(1)时，其他线程无法同时修改counter，从而避免数据竞争</li></ol></li><li><p>无锁并发的实现原理</p><ol><li>​硬件级原子指令​：<br />std::atomic底层通过CPU指令（如x86的LOCK CMPXCHG）实现原子操作，无需软件锁（如std::mutex）。</li><li>​性能优势​：<br />相比互斥锁（std::mutex）的上下文切换开销，原子操作直接操作内存，速度更快，尤其适合高频简单操作（如计数器）</li></ol>  <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// 传统锁方案 vs 原子操作方案</span>std<span class="token double-colon punctuation">::</span>mutex mtx<span class="token punctuation">;</span><span class="token keyword">int</span> counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">// 传统锁：每次操作需加锁/解锁</span>mtx<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>counter<span class="token operator">++</span><span class="token punctuation">;</span>  mtx<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 原子操作：无锁直接操作</span>atomic_counter<span class="token punctuation">.</span><span class="token function">fetch_add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>何时使用原子操作（vs 互斥锁）</p><table><thead><tr><th style="text-align:center"><strong>场景</strong></th><th style="text-align:center"><strong>推荐方案</strong></th><th style="text-align:center"><strong>原因</strong></th></tr></thead><tbody><tr><td style="text-align:center">简单变量（int、bool等）</td><td style="text-align:center"><code>std::atomic</code></td><td style="text-align:center">无锁高性能，避免锁开销</td></tr><tr><td style="text-align:center">复杂操作（如链表更新）</td><td style="text-align:center"><code>std::mutex</code></td><td style="text-align:center">原子操作难以保证多个步骤的原子性（需CAS循环，实现复杂）</td></tr><tr><td style="text-align:center">读写混合且高频</td><td style="text-align:center">读写锁（<code>std::shared_mutex</code>）</td><td style="text-align:center">减少写阻塞，提升并发读性能</td></tr></tbody></table></li><li><p>原子操作的其他常见方法</p><ol><li>​加载/存储​：<br />counter.load() 获取当前值，counter.store(42) 设置新值。</li><li>​比较与交换（CAS）​​：</li></ol><pre class="highlight"><code class="cpp"><span class="hljs-keyword">int</span> expected = counter.load();<span class="hljs-keyword">while</span>(!counter.compare_exchange_weak(expected, new_value)) &#123;&#125;</code></pre><p>用于无锁数据结构（如队列），需循环直到更新成功</p></li></ul></li></ul><h3 id="高频面试考点解析"><a class="markdownIt-Anchor" href="#高频面试考点解析"></a> ​高频面试考点解析​</h3><ul><li>​Q：智能指针如何避免内存泄漏？​​<br />​A​：unique_ptr通过独占所有权防拷贝；shared_ptr用引用计数自动释放；循环引用场景需搭配weak_ptr。</li><li>​Q：移动构造函数与拷贝构造的区别？​​<br />​A​：移动构造“窃取”资源（原对象置空），避免深拷贝开销；拷贝构造创建独立副本。</li><li>​Q：C++17结构化绑定的应用场景？​​<br />​A​：简化std::pair/tuple/结构体的访问，提升代码可读性（如遍历map）</li></ul>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> C++ </tag>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>每日知识点-12</title>
      <link href="/2025/06/11/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-12/"/>
      <url>/2025/06/11/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-12/</url>
      
        <content type="html"><![CDATA[<h2 id="每日知识点-12"><a class="markdownIt-Anchor" href="#每日知识点-12"></a> 每日知识点-12</h2><p>聚焦FFmpeg硬编解码集成与工业级性能调优<br />今日重点：​NVENC/QSV硬编解码对比 + 动态码率抗抖动策略 + 去隔行扫描优化。</p><hr /><h3 id="1-硬编解码方案选型附性能对比数据"><a class="markdownIt-Anchor" href="#1-硬编解码方案选型附性能对比数据"></a> 1. <strong>硬编解码方案选型（附性能对比数据​</strong></h3><table><thead><tr><th style="text-align:center"><strong>编码器</strong></th><th style="text-align:center">适用硬件</th><th style="text-align:center">1080P@60fps编码速度</th><th style="text-align:center">同码率画质排名</th><th style="text-align:center">工业场景</th></tr></thead><tbody><tr><td style="text-align:center"><strong>NVENC</strong></td><td style="text-align:center">NVIDIA GPU</td><td style="text-align:center"><strong>8x实时速度</strong></td><td style="text-align:center">第三名</td><td style="text-align:center">直播推流/快速转码</td></tr><tr><td style="text-align:center"><strong>QSV</strong></td><td style="text-align:center">Intel核显</td><td style="text-align:center">5x实时速度</td><td style="text-align:center"><strong>第一名</strong></td><td style="text-align:center">轻薄本/嵌入式设备</td></tr><tr><td style="text-align:center"><strong>VAAPI</strong></td><td style="text-align:center">AMD/Intel GPU</td><td style="text-align:center">4x实时速度</td><td style="text-align:center">第二名</td><td style="text-align:center">Linux服务器</td></tr></tbody></table><p><strong>工程结论</strong>：</p><blockquote><p>优先选择<strong>QSV</strong>（画质最佳）或<strong>NVENC</strong>（速度最快），避免在Intel核显设备使用VAAPI（驱动问题多）</p></blockquote><h3 id="2-硬编解码集成代码c17标准"><a class="markdownIt-Anchor" href="#2-硬编解码集成代码c17标准"></a> 2. <strong>硬编解码集成代码（C++17标准）</strong></h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// 启用NVIDIA GPU硬解码 + Intel QSV硬编码（工业级混合方案）</span>AVBufferRef<span class="token operator">*</span> hw_ctx <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span><span class="token function">av_hwdevice_ctx_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hw_ctx<span class="token punctuation">,</span> AV_HWDEVICE_TYPE_CUDA<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// CUDA解码</span>AVCodecContext<span class="token operator">*</span> dec_ctx <span class="token operator">=</span> <span class="token function">avcodec_alloc_context3</span><span class="token punctuation">(</span>codec<span class="token punctuation">)</span><span class="token punctuation">;</span>dec_ctx<span class="token operator">-></span>hw_device_ctx <span class="token operator">=</span> <span class="token function">av_buffer_ref</span><span class="token punctuation">(</span>hw_ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 绑定硬件上下文</span><span class="token comment">// QSV硬编码配置（禁用裸指针，RAII管理）</span><span class="token keyword">auto</span> enc_ctx <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">unique_ptr</span><span class="token generic class-name"><span class="token operator">&lt;</span>AVCodecContext<span class="token punctuation">,</span> <span class="token keyword">decltype</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>avcodec_free_context<span class="token punctuation">)</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>    <span class="token function">avcodec_alloc_context3</span><span class="token punctuation">(</span><span class="token function">avcodec_find_encoder_by_name</span><span class="token punctuation">(</span><span class="token string">"h264_qsv"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    avcodec_free_context<span class="token punctuation">)</span><span class="token punctuation">;</span>enc_ctx<span class="token operator">-></span>bit_rate <span class="token operator">=</span> <span class="token number">4</span> <span class="token operator">*</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>  <span class="token comment">// 4Mbps码率</span>enc_ctx<span class="token operator">-></span>rc_max_rate <span class="token operator">=</span> <span class="token number">6</span> <span class="token operator">*</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span> <span class="token comment">// 抗网络抖动预留带宽</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>关键点</strong>：</p><ul><li><p>显存管理：</p><pre class="line-numbers language-none"><code class="language-none">hw_device_ctx<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>自动释放显存（避免内存泄漏）</p></li><li><p>线程安全：编解码器上下文独立，支持多实例并发（原子操作保证）</p></li></ul><h3 id="3-动态码率抗网络抖动"><a class="markdownIt-Anchor" href="#3-动态码率抗网络抖动"></a> 3. <strong>动态码率抗网络抖动</strong></h3><p><strong>FFmpeg自适应命令</strong>：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ffmpeg <span class="token parameter variable">-i</span> input.mp4 <span class="token parameter variable">-c:v</span> h264_nvenc <span class="token parameter variable">-b:v</span> 4M <span class="token parameter variable">-maxrate</span> 6M <span class="token parameter variable">-bufsize</span> 8M output.mp4<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li><p><code>bufsize</code> 为码率波动缓冲区（推荐2倍目标码率）</p></li><li></li></ul><p>抗抖动原理：当网络带宽下降时，自动降低分辨率（需配合滤镜链）</p><h3 id="任务1qsv与nvenc画质对比测试"><a class="markdownIt-Anchor" href="#任务1qsv与nvenc画质对比测试"></a> 任务1：QSV与NVENC画质对比测试</h3><ol><li></li></ol><p>生成测试视频：</p>   <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 原始视频（CRF=18 无损级别）</span>ffmpeg <span class="token parameter variable">-i</span> input.mp4 <span class="token parameter variable">-c:v</span> libx264 <span class="token parameter variable">-crf</span> <span class="token number">18</span> <span class="token parameter variable">-preset</span> slow reference.mp4<span class="token comment"># QSV编码（CQP=23）</span>ffmpeg <span class="token parameter variable">-hwaccel</span> qsv <span class="token parameter variable">-i</span> reference.mp4 <span class="token parameter variable">-c:v</span> h264_qsv <span class="token parameter variable">-global_quality</span> <span class="token number">23</span> qsv.mp4<span class="token comment"># NVENC编码（CQP=23）</span>ffmpeg <span class="token parameter variable">-hwaccel</span> cuda <span class="token parameter variable">-i</span> reference.mp4 <span class="token parameter variable">-c:v</span> h264_nvenc <span class="token parameter variable">-cq</span> <span class="token number">23</span> nvenc.mp4<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="2"><li><p>画质评估：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ffmpeg <span class="token parameter variable">-i</span> qsv.mp4 <span class="token parameter variable">-i</span> reference.mp4 <span class="token parameter variable">-lavfi</span> <span class="token string">"ssim"</span> <span class="token parameter variable">-f</span> null -  <span class="token comment"># SSIM >0.95合格</span>ffmpeg <span class="token parameter variable">-i</span> nvenc.mp4 <span class="token parameter variable">-i</span> reference.mp4 <span class="token parameter variable">-lavfi</span> <span class="token string">"psnr"</span> <span class="token parameter variable">-f</span> null - <span class="token comment"># PSNR >40dB合格</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>企业标准：QVP的SSIM通常比NVENC高0.03-0.05</p></li></ol><h3 id="任务2去隔行扫描优化解决画面锯齿"><a class="markdownIt-Anchor" href="#任务2去隔行扫描优化解决画面锯齿"></a> 任务2：去隔行扫描优化（解决画面锯齿）</h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// 使用yadif滤镜消除隔行扫描（启用QSV加速）</span><span class="token keyword">const</span> AVFilter<span class="token operator">*</span> yadif <span class="token operator">=</span> <span class="token function">avfilter_get_by_name</span><span class="token punctuation">(</span><span class="token string">"yadif_cuda"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// GPU加速版</span><span class="token function">avfilter_graph_create_filter</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>filter_ctx<span class="token punctuation">,</span> yadif<span class="token punctuation">,</span> <span class="token string">"yadif"</span><span class="token punctuation">,</span> <span class="token string">"mode=send_frame"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> filter_graph<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><strong>参数解析</strong>：</p><ul><li><p><code>mode=send_frame</code>：逐帧处理（画质最佳）</p></li><li><p>性能提升：QSV加速后处理速度提升3倍（对比CPU版）</p></li></ul>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> C++ </tag>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>服务器22端口无法访问和docker容器镜像消失</title>
      <link href="/2025/06/10/%E6%9C%8D%E5%8A%A1%E5%99%A822%E7%AB%AF%E5%8F%A3%E6%97%A0%E6%B3%95%E8%AE%BF%E9%97%AE%E5%92%8Cdocker%E5%AE%B9%E5%99%A8%E9%95%9C%E5%83%8F%E6%B6%88%E5%A4%B1/"/>
      <url>/2025/06/10/%E6%9C%8D%E5%8A%A1%E5%99%A822%E7%AB%AF%E5%8F%A3%E6%97%A0%E6%B3%95%E8%AE%BF%E9%97%AE%E5%92%8Cdocker%E5%AE%B9%E5%99%A8%E9%95%9C%E5%83%8F%E6%B6%88%E5%A4%B1/</url>
      
        <content type="html"><![CDATA[<h2 id="华为云无法远程ssh"><a class="markdownIt-Anchor" href="#华为云无法远程ssh"></a> 华为云无法远程ssh</h2><p>突然发现华为云的服务器无法通过远程连接进行访问了，但是查看网络安全组的端口配置，明明已经配置了22端口开放，但是还是无法访问。</p><p><a href="https://support.huaweicloud.com/ecs_faq/zh-cn_topic_0105127983.html">无法登录到Linux云服务器怎么办?</a></p><h3 id="故障原因分析"><a class="markdownIt-Anchor" href="#故障原因分析"></a> 故障原因分析</h3><p>通过查看华为云服务器的监控图，发现cpu，内存都正常，但是硬盘占用100%</p><p>使用一键诊断工具得到的结果也是一切正常，怀疑是硬盘占用的问题？</p><p>使用华为云官网上的远程登录中的VNC登录模式，终于进入了远程连接。</p><p>进入之后使用 <code>docker ps -a</code> 和 <code>docker iamges -a</code> 发现，容器和镜像全部都消失不见了（之前也经常出现这个问题）。</p><p>使用 <code>df -h</code> 查看磁盘空间，发现已经全部占满。</p><p>使用以下命令查看占用空间最大的前十个文件夹</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">du</span> <span class="token parameter variable">-a</span> <span class="token parameter variable">-m</span> / <span class="token operator">|</span> <span class="token function">sort</span> <span class="token parameter variable">-n</span> <span class="token parameter variable">-r</span> <span class="token operator">|</span> <span class="token function">head</span> <span class="token parameter variable">-n</span> <span class="token number">10</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>发现 <code>var//lib/docker/overlay2</code> 这个文件夹占用了27个G(云服务器一共40个G)</p><p>更多内容可以参考下面这个文章：</p><p><a href="https://blog.csdn.net/zxxshaycormac/article/details/120433857">docker的overlay2中存的都是什么and如何清理/var/lib/docker/overlay2_docker overlay 是什么目录-CSDN博客</a></p><p>执行以下命令查看里面的文件夹大小占用情况</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> /var/lib/docker/overlay2<span class="token function">du</span> <span class="token parameter variable">-sh</span> * <span class="token operator">|</span> <span class="token function">sort</span> <span class="token parameter variable">-n</span> <span class="token parameter variable">-r</span> <span class="token operator">|</span> <span class="token function">head</span> <span class="token parameter variable">-n</span> <span class="token number">10</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>发现全部都是528M大小的文件夹，怀疑是之前构建的多个冗余镜像但是没有删除的问题。</p><p>使用 <code>rm</code> 命令删除这些相同大小的文件夹</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 例如：</span><span class="token function">rm</span> <span class="token parameter variable">-rf</span> ae88cx7adm208vb9/ qpp745k28ckas9vlasd/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="解决-docker-容器镜像消失的问题"><a class="markdownIt-Anchor" href="#解决-docker-容器镜像消失的问题"></a> 解决 <code>docker</code> 容器镜像消失的问题</h3><p><a href="https://blog.csdn.net/deleteANDinsert/article/details/141568634">docker 镜像、容器消失解决办法。_docker升级后容器丢失-CSDN博客</a></p><p>之前碰到这个问题一直采用的是更换daemon.json的方法，这次也采用这个方法。</p><ul><li>修改/etc/docker/daemon.json，让daemon.json非法，然后执行systemctl restart docker，这个时候docker会报错</li><li>恢复正常的/etc/docker/daemon.json，然后执行systemctl daemon-reload，systemctl restart docker就可以了</li></ul><p>使用 <code>docker ps -a</code> 和 <code>docker images -a</code> 发现 <code>docker</code> 恢复了正常</p><p>这里删掉了之前做的音视频部署的项目</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/202506101414418.png" alt="image-20250610141451341" /></p><p>发现删除这个镜像后docker又删除了一些东西，或许是 <code>overlay2</code> 中的？</p><p>采用以下命令让 docker 自动清理空间</p><p>请注意：一些未运行的容器且数据未挂载在本地的，运行以下命令后会数据丢失</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> system prune<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>该指令默认会清除所有如下资源：<br /><strong>已停止的容器（container）</strong><br />未被任何容器所使用的卷（volume）<br />未被任何容器所关联的网络（network）<br />所有悬空镜像（image）。</li><li>指令默认只会清除悬空镜像，未被使用的镜像不会被删除。</li><li>添加 -a 或 --all 参数后，可以一并清除所有未使用的镜像和悬空镜像。</li><li>可以添加 -f 或 --force 参数用以忽略相关告警确认信息。</li><li>指令结尾处会显示总计清理释放的空间大小。</li></ul><h3 id="原因分析"><a class="markdownIt-Anchor" href="#原因分析"></a> 原因分析</h3><p>最后，使用ssh连接，发现已经能成功连接到服务器。</p><blockquote><p>引起docker容器消失，ssh连接故障的主要原因应该是硬盘空间不足。</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 部署 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>每日知识点-11</title>
      <link href="/2025/06/10/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-11/"/>
      <url>/2025/06/10/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-11/</url>
      
        <content type="html"><![CDATA[<h2 id="每日知识点-11"><a class="markdownIt-Anchor" href="#每日知识点-11"></a> 每日知识点-11</h2><p>聚焦音视频基础理论与FFmpeg核心操作<br />今日重点：<strong>像素格式原理+FFmpeg关键帧操作+YUV空间转换</strong>。</p><hr /><h3 id="1-像素格式与采样原理工业级理解"><a class="markdownIt-Anchor" href="#1-像素格式与采样原理工业级理解"></a> 1. <strong>像素格式与采样原理（工业级理解）</strong></h3><ul><li><p>YUV vs RGB<br /><strong>工程意义</strong>：YUV分离亮度（Y）和色度（UV），相比RGB更节省带宽（4:2:0采样节省50%带宽）</p></li><li><p>采样对比：</p><table><thead><tr><th>采样格式</th><th>亮度(Y)分辨率</th><th>色度(UV)分辨率</th><th>带宽占用</th><th>典型场景</th></tr></thead><tbody><tr><td>4:4:4</td><td>100%</td><td>100%</td><td>最高</td><td>影视后期/医疗影像</td></tr><tr><td><strong>4:2:0</strong></td><td>100%</td><td>25%</td><td><strong>最低</strong></td><td>直播/视频会议</td></tr></tbody></table></li><li><p>OpenCV转换代码</p>  <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// RGB转YUV420（OpenCV实现）</span>cv<span class="token double-colon punctuation">::</span>Mat rgb_frame <span class="token operator">=</span> cv<span class="token double-colon punctuation">::</span><span class="token function">imread</span><span class="token punctuation">(</span><span class="token string">"input.jpg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>cv<span class="token double-colon punctuation">::</span>Mat yuv_frame<span class="token punctuation">;</span>cv<span class="token double-colon punctuation">::</span><span class="token function">cvtColor</span><span class="token punctuation">(</span>rgb_frame<span class="token punctuation">,</span> yuv_frame<span class="token punctuation">,</span> cv<span class="token double-colon punctuation">::</span>COLOR_BGR2YUV_I420<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="2-帧率码率分辨率的关系公式"><a class="markdownIt-Anchor" href="#2-帧率码率分辨率的关系公式"></a> 2. <strong>帧率/码率/分辨率的关系公式</strong></h3><ul><li>工业计算公式  <pre class="line-numbers language-none"><code class="language-none">码率 (bps) &#x3D; 分辨率 × 帧率 × 每像素比特数 × 压缩因子<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li><strong>示例</strong>：1080P@60fps视频，H.264编码压缩因子≈0.1时：<br /><code>1920×1080 × 60 × 1.5 (YUV420) × 0.1 ≈ 186 Mbps</code></li><li><strong>面试考点</strong>：分辨率不变时，帧率每提升1倍，码率需提升约80%（非线性）</li></ul></li></ul><h3 id="3-关键帧i帧的作用与提取"><a class="markdownIt-Anchor" href="#3-关键帧i帧的作用与提取"></a> 3. <strong>关键帧（I帧）的作用与提取</strong></h3><ul><li>工程意义<ul><li>I帧是视频解码的起点，包含完整画面信息，丢失会导致后续帧无法解码</li><li>GOP（Group of Pictures）结构中I帧间隔影响卡顿恢复速度（建议直播场景GOP≤2s）</li></ul></li><li>FFmpeg提取命令  <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 提取视频所有关键帧（面试高频考点）</span>ffmpeg <span class="token parameter variable">-i</span> input.mp4 <span class="token parameter variable">-vf</span> <span class="token string">"select=eq(pict_type\,I)"</span> <span class="token parameter variable">-vsync</span> vfr keyframe-%03d.jpg<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>参数解析：<br /><code>select=eq(pict_type\,I)</code>：筛选I帧<br /><code>-vsync vfr</code>：按可变帧率输出，避免重复帧</li></ul></li></ul><h3 id="️-实践任务"><a class="markdownIt-Anchor" href="#️-实践任务"></a> ⚙️ <strong>实践任务</strong></h3><h4 id="任务1验证yuv采样对带宽的影响"><a class="markdownIt-Anchor" href="#任务1验证yuv采样对带宽的影响"></a> 任务1：验证YUV采样对带宽的影响</h4><ol><li><p>生成测试视频：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 生成10秒YUV420测试视频（1280x720@30fps）</span>ffmpeg <span class="token parameter variable">-f</span> lavfi <span class="token parameter variable">-i</span> <span class="token assign-left variable">testsrc</span><span class="token operator">=</span>duration<span class="token operator">=</span><span class="token number">10</span>:size<span class="token operator">=</span>1280x720:rate<span class="token operator">=</span><span class="token number">30</span> <span class="token parameter variable">-pix_fmt</span> yuv420p test_420.mp4<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li><p>计算实际码率：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ffprobe <span class="token parameter variable">-v</span> error <span class="token parameter variable">-select_streams</span> v:0 <span class="token parameter variable">-show_entries</span> <span class="token assign-left variable">stream</span><span class="token operator">=</span>bit_rate <span class="token parameter variable">-of</span> <span class="token assign-left variable">default</span><span class="token operator">=</span>noprint_wrappers<span class="token operator">=</span><span class="token number">1</span> test_420.mp4<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>对比4:4:4格式：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ffmpeg <span class="token parameter variable">-i</span> test_420.mp4 <span class="token parameter variable">-pix_fmt</span> yuv444p test_444.mp4<span class="token comment"># 观察文件大小差异（4:4:4比4:2:0大2倍）</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li></ol><h4 id="任务2关键帧提取与故障模拟"><a class="markdownIt-Anchor" href="#任务2关键帧提取与故障模拟"></a> 任务2：关键帧提取与故障模拟</h4><ol><li><p>人为删除I帧：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 删除第5秒的关键帧（模拟传输丢包）</span>ffmpeg <span class="token parameter variable">-i</span> input.mp4 <span class="token parameter variable">-copyts</span> <span class="token parameter variable">-c</span> copy <span class="token parameter variable">-bsf:v</span> <span class="token string">"noise=drop='eq(n,5)'"</span> corrupted.mp4<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li><p>观察解码异常：</p><ul><li>使用VLC播放<code>corrupted.mp4</code>，从第5秒开始出现花屏/卡顿</li><li><strong>原理</strong>：P/B帧依赖I帧解码，I帧丢失导致参考链断裂</li></ul></li></ol>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> C++ </tag>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux常用命令</title>
      <link href="/2025/06/09/Linux%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/"/>
      <url>/2025/06/09/Linux%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/</url>
      
        <content type="html"><![CDATA[<h2 id="linux-常用命令"><a class="markdownIt-Anchor" href="#linux-常用命令"></a> Linux 常用命令</h2><p>以下是 Linux 常用命令的总结，涵盖文件操作、解压缩、软件安装、系统管理等常见场景：</p><hr /><h3 id="一-文件与目录操作"><a class="markdownIt-Anchor" href="#一-文件与目录操作"></a> <strong>一、文件与目录操作</strong></h3><ol><li><strong>基本操作</strong></li></ol><ul><li>列出目录内容</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">ls</span><span class="token function">ls</span> <span class="token parameter variable">-l</span>  <span class="token comment"># 详细列表</span><span class="token function">ls</span> <span class="token parameter variable">-a</span>  <span class="token comment"># 显示隐藏文件</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>切换目录</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span><span class="token builtin class-name">cd</span> /path  <span class="token comment"># 进入绝对路径</span><span class="token builtin class-name">cd</span> <span class="token punctuation">..</span>     <span class="token comment"># 返回上一级</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li><p>显示当前路径<br /><code>pwd</code></p></li><li><p>创建目录</p></li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mkdir</span><span class="token function">mkdir</span> <span class="token function">dirname</span><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> parent/child  <span class="token comment"># 递归创建多级目录</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>删除文件或目录</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">rm</span><span class="token function">rm</span> file.txt<span class="token function">rm</span> <span class="token parameter variable">-r</span> <span class="token function">dirname</span>  <span class="token comment"># 递归删除目录</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>复制文件/目录</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">cp</span><span class="token function">cp</span> file.txt /dest/<span class="token function">cp</span> <span class="token parameter variable">-r</span> <span class="token function">dirname</span> /dest/  <span class="token comment"># 递归复制目录</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>移动或重命名</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mv</span><span class="token function">mv</span> file.txt /dest/<span class="token function">mv</span> oldname newname  <span class="token comment"># 重命名</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ol start="2"><li><strong>查看文件内容</strong></li></ol><ul><li><p><code>cat</code>：显示文件全部内容</p></li><li><p>查看文件头部/尾部</p></li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">head</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>/</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">tail</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">head</span> <span class="token parameter variable">-n</span> <span class="token number">10</span> file.txt  <span class="token comment"># 显示前10行</span><span class="token function">tail</span> <span class="token parameter variable">-f</span> log.log      <span class="token comment"># 实时追踪日志</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>分页查看文件（支持搜索）</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">less</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">less</span> file.txt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><hr /><h3 id="二-解压缩命令"><a class="markdownIt-Anchor" href="#二-解压缩命令"></a> <strong>二、解压缩命令</strong></h3><ol><li><strong>tar 归档与解压</strong></li></ol><ul><li>压缩：</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">tar</span> <span class="token parameter variable">-czvf</span> archive.tar.gz <span class="token function">dirname</span>  <span class="token comment"># .tar.gz</span><span class="token function">tar</span> <span class="token parameter variable">-cjvf</span> archive.tar.bz2 <span class="token function">dirname</span> <span class="token comment"># .tar.bz2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>解压：</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">tar</span> <span class="token parameter variable">-xzvf</span> archive.tar.gz<span class="token function">tar</span> <span class="token parameter variable">-xjvf</span> archive.tar.bz2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>参数说明：<br /><code>-c</code>创建归档，<code>-x</code>解压，<code>-z</code>处理gzip，<code>-j</code>处理bzip2，<code>-v</code>显示过程，<code>-f</code>指定文件名。</li></ul><ol start="2"><li><strong>zip/unzip</strong></li></ol><ul><li>压缩：</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">zip</span> archive.zip file1 file2<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>解压：</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">unzip</span> archive.zip<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="3"><li><strong>gzip/bzip2</strong></li></ol><ul><li>压缩：</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">gzip</span> file.txt    <span class="token comment"># 生成file.txt.gz</span><span class="token function">bzip2</span> file.txt   <span class="token comment"># 生成file.txt.bz2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>解压：</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gunzip file.txt.gzbunzip2 file.txt.bz2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><hr /><h3 id="三-软件安装与管理"><a class="markdownIt-Anchor" href="#三-软件安装与管理"></a> <strong>三、软件安装与管理</strong></h3><ol><li><strong>APT (Debian/Ubuntu)</strong></li></ol><ul><li>更新源：</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> update<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>安装软件：</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> package_name<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>卸载软件：</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> remove package_name<span class="token function">sudo</span> <span class="token function">apt</span> purge package_name  <span class="token comment"># 彻底删除配置</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ol start="2"><li><strong>YUM/DNF (RHEL/CentOS/Fedora)</strong></li></ol><ul><li>安装：</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> yum <span class="token function">install</span> package_name  <span class="token comment"># CentOS 7</span><span class="token function">sudo</span> dnf <span class="token function">install</span> package_name  <span class="token comment"># CentOS 8/Fedora</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>卸载：</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> yum remove package_name<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="3"><li><strong>源码编译安装</strong></li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./configure<span class="token function">make</span><span class="token function">sudo</span> <span class="token function">make</span> <span class="token function">install</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ol start="4"><li><strong>Snap/Flatpak</strong></li></ol><ul><li>Snap：</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> snap <span class="token function">install</span> package_name<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>Flatpak：</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">flatpak <span class="token function">install</span> flathub org.package.name<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><hr /><h3 id="四-系统管理"><a class="markdownIt-Anchor" href="#四-系统管理"></a> <strong>四、系统管理</strong></h3><ol><li><strong>进程管理</strong></li></ol><ul><li>查看进程</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">ps</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">ps</span> aux <span class="token operator">|</span> <span class="token function">grep</span> nginx<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>终止进程</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">kill</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">kill</span> <span class="token parameter variable">-9</span> PID<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li><code>top</code>/<code>htop</code>：实时进程监控</li></ul><ol start="2"><li><strong>磁盘与内存</strong></li></ol><ul><li><code>df -h</code>：查看磁盘空间</li><li><code>du -sh dirname</code>：统计目录大小</li><li><code>free -h</code>：查看内存使用</li></ul><ol start="3"><li><strong>网络管理</strong></li></ol><ul><li><code>ifconfig</code>/<code>ip addr</code>：查看IP地址</li><li><code>ping example.com</code>：测试网络连通性</li><li><code>netstat -tulnp</code>：查看监听端口</li><li><code>ssh user@host</code>：远程登录</li></ul><ol start="4"><li><strong>权限管理</strong></li></ol><ul><li>修改权限</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">chmod</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">chmod</span> <span class="token number">755</span> script.sh  <span class="token comment"># rwxr-xr-x</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>修改所有者</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">chown</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">chown</span> user:group file.txt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><hr /><h3 id="五-其他实用命令"><a class="markdownIt-Anchor" href="#五-其他实用命令"></a> <strong>五、其他实用命令</strong></h3><ul><li>搜索文件</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">find</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">find</span> /path <span class="token parameter variable">-name</span> <span class="token string">"*.log"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>文本搜索</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">grep</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">grep</span> <span class="token string">"error"</span> log.txt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>下载文件</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">wget</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>/</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">wget</span> https://example.com/file.zip<span class="token function">curl</span> <span class="token parameter variable">-O</span> https://example.com/file.zip<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li><p><code>crontab -e</code>：定时任务管理</p></li><li><p>服务管理</p></li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">systemctl<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> systemctl start nginx<span class="token function">sudo</span> systemctl <span class="token builtin class-name">enable</span> nginx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><hr /><h3 id="附常用快捷键"><a class="markdownIt-Anchor" href="#附常用快捷键"></a> <strong>附：常用快捷键</strong></h3><ul><li><code>Ctrl+C</code>：终止当前命令</li><li><code>Ctrl+Z</code>：暂停任务（<code>fg</code>恢复）</li><li><code>Ctrl+D</code>：退出终端</li><li><code>!!</code>：重复上一条命令</li><li><code>history</code>：查看命令历史</li></ul><p>掌握这些命令可覆盖大部分 Linux 日常操作需求。根据发行版和场景不同，部分命令可能需要调整参数或使用替代工具（如 <code>ip</code> 替代 <code>ifconfig</code>）。</p>]]></content>
      
      
      <categories>
          
          <category> 笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>每日知识点-10</title>
      <link href="/2025/06/06/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-10/"/>
      <url>/2025/06/06/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-10/</url>
      
        <content type="html"><![CDATA[<h2 id="每日知识点-10"><a class="markdownIt-Anchor" href="#每日知识点-10"></a> 每日知识点-10</h2><hr /><h3 id="1-解释-linux-进程间通信-ipc-的-5-种方式并说明适用场景"><a class="markdownIt-Anchor" href="#1-解释-linux-进程间通信-ipc-的-5-种方式并说明适用场景"></a> <strong>1. 解释 Linux 进程间通信 (IPC) 的 5 种方式，并说明适用场景</strong></h3><ul><li><ol><li>管道 (Pipe): 单向通信，父子进程间使用 (如 Shell 命令 | 操作)</li></ol></li><li><ol start="2"><li>消息队列: 异步通信，解耦生产者/消费者 (日志系统)</li></ol></li><li><ol start="3"><li>共享内存: 高速数据传输 (视频处理进程交换帧数据)</li></ol></li><li><ol start="4"><li>信号量: 同步资源访问 (数据库连接池控制)</li></ol></li><li><ol start="5"><li>Socket: 跨网络通信 (分布式系统节点交互)</li></ol></li></ul><h3 id="2-如何检测单链表是否有环证明算法正确性"><a class="markdownIt-Anchor" href="#2-如何检测单链表是否有环证明算法正确性"></a> <strong>2. 如何检测单链表是否有环？证明算法正确性</strong></h3><ul><li>算法描述: 快慢指针法 (Floyd 判圈算法)<ul><li>快指针步长2, 慢指针步长1</li><li>相遇则有环, 否则快指针先到终点</li></ul></li><li>数学证明:<ul><li>设环长L, 环外长度K</li><li>相遇时慢指针走N步，快指针走2N步</li><li>存在整数N满足：2S - S = NL → S = NL</li></ul></li><li>时间复杂度​​：O(n)（线性遍历）<br />延伸问题​​：如何找到环的入口点？（答：相遇后重置慢指针到起点，同速移动）</li></ul><h3 id="3-服务器程序cpu占用率突然飙升至90如何定位问题"><a class="markdownIt-Anchor" href="#3-服务器程序cpu占用率突然飙升至90如何定位问题"></a> <strong>3. 服务器程序CPU占用率突然飙升至90%，如何定位问题？</strong></h3><ul><li>排查路径​​：  <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 1. 定位高进程</span><span class="token function">top</span> <span class="token parameter variable">-c</span>  <span class="token comment"># 按CPU排序，记录PID</span><span class="token comment"># 2. 分析线程资源</span><span class="token function">ps</span> <span class="token parameter variable">-T</span> <span class="token parameter variable">-p</span> <span class="token operator">&lt;</span>PID<span class="token operator">></span>  <span class="token comment"># 查看线程CPU占用</span>perf <span class="token function">top</span> <span class="token parameter variable">-p</span> <span class="token operator">&lt;</span>PID<span class="token operator">></span>  <span class="token comment"># 采样热点函数</span><span class="token comment"># 3. 检查锁竞争</span>valgrind <span class="token parameter variable">--tool</span><span class="token operator">=</span>drd ./program  <span class="token comment"># 检测线程锁冲突</span><span class="token comment"># 4. 内存泄漏关联（高CPU常伴随内存问题）</span>valgrind --leak-check<span class="token operator">=</span>full ./program<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>核心结论​​：优先怀疑​​死循环​​或​​锁竞争​​，结合性能工具快速缩小范围</li></ul><h3 id="4-描述一个你解决的性能优化案例"><a class="markdownIt-Anchor" href="#4-描述一个你解决的性能优化案例"></a> <strong>4. 描述一个你解决的性能优化案例​</strong></h3><ul><li>Situation​​：OpenCV视频流处理延迟200ms，需降至50ms内</li><li>Task​​：识别帧处理瓶颈</li><li>Action​​：<ul><li>用perf分析发现75%耗时在色彩空间转换</li><li>改为GPU加速（CUDA::cvtColor）</li><li>批处理替代逐帧处理</li></ul></li><li>Result​​：延迟降至35ms，吞吐量提升5倍</li></ul><h3 id="5-设计10万并发连接的tcp消息转发服务"><a class="markdownIt-Anchor" href="#5-设计10万并发连接的tcp消息转发服务"></a> <strong>5. 设计10万并发连接的TCP消息转发服务​</strong></h3><ul><li>​​I/O模型​​：Epoll边缘触发（Linux）+ 非阻塞Socket</li><li>​线程架构​​：<br />单监听线程 + 多Worker线程池<br />每个Worker通过Round-Robin分配连接</li><li>​内存管理​​：<br />预分配连接对象池<br />零拷贝技术减少内核态切换</li><li>​容灾​​：心跳机制 + 连接迁移<br />​​延伸考察​​：如何解决C10K问题</li></ul>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> C++ </tag>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>每日知识点-9</title>
      <link href="/2025/06/05/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-9/"/>
      <url>/2025/06/05/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-9/</url>
      
        <content type="html"><![CDATA[<h2 id="每日知识点-9"><a class="markdownIt-Anchor" href="#每日知识点-9"></a> 每日知识点-9</h2><hr /><h3 id="1-c语言-内存安全"><a class="markdownIt-Anchor" href="#1-c语言-内存安全"></a> <strong>1. C语言 - 内存安全</strong></h3><ul><li><p>类型：代码改错题</p></li><li><p>​题目​​：以下代码存在什么隐患？如何修正？</p>  <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token keyword">void</span> <span class="token function">load_data</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token operator">*</span>buf<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token operator">*</span>buf <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token punctuation">(</span><span class="token operator">*</span>buf<span class="token punctuation">)</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> i <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">;</span>     <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> <span class="token operator">*</span>data <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>    <span class="token function">load_data</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 使用data...</span>    <span class="token function">free</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 释放内存</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 问题点</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>答案与解析：</p></li><li><p>隐患：释放后未置空指针 → 产生<strong>悬空指针</strong>（Dangling Pointer）</p></li><li><p>修正方案：</p>  <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">free</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>data <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>  <span class="token comment">// 关键修复：释放后立即置空</span><span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 安全判断</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li><li><p>通俗解释：<br /><code>free(data)</code> 如同销毁保险箱，但 <code>data</code> 仍记录着保险箱位置（旧地址）。后续操作如同用废钥匙开锁（<code>data[0]</code>），可能触发崩溃或数据错乱。置为 <code>NULL</code> 相当于丢弃废钥匙。</p></li><li><p>技术要点：</p>  <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// 正确内存生命周期管理：</span><span class="token keyword">int</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 分配</span><span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">&#125;</span>    <span class="token comment">// 使用前校验</span><span class="token function">free</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// 释放</span>p <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>               <span class="token comment">// 置空防误用</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><strong>典型错误对比</strong>：</p><table><thead><tr><th>错误操作</th><th>后果</th><th>修正方案</th></tr></thead><tbody><tr><td><code>free</code> 后未置空</td><td>悬空指针 → 段错误</td><td><code>p = NULL</code></td></tr><tr><td><code>malloc</code> 后漏检查</td><td>分配失败导致崩溃</td><td><code>if (p == NULL) exit(1);</code></td></tr></tbody></table></li></ul><h3 id="2-数据结构-链表实战"><a class="markdownIt-Anchor" href="#2-数据结构-链表实战"></a> <strong>2. 数据结构 - 链表实战</strong></h3><ul><li><p>类型：编程题</p></li><li><p>​题目​​：实现​<strong>​删除链表中重复节点​</strong>​的函数，保留首次出现的节点：</p>  <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">Node</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> data<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">Node</span> <span class="token operator">*</span>next<span class="token punctuation">;</span><span class="token punctuation">&#125;</span> Node<span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">remove_duplicates</span><span class="token punctuation">(</span>Node <span class="token operator">*</span>head<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>参考答案：</p>  <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">remove_duplicates</span><span class="token punctuation">(</span>Node <span class="token operator">*</span>head<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    Node <span class="token operator">*</span>current <span class="token operator">=</span> head<span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>current <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        Node <span class="token operator">*</span>runner <span class="token operator">=</span> current<span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>runner<span class="token operator">-></span>next <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>runner<span class="token operator">-></span>next<span class="token operator">-></span>data <span class="token operator">==</span> current<span class="token operator">-></span>data<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                Node <span class="token operator">*</span>temp <span class="token operator">=</span> runner<span class="token operator">-></span>next<span class="token punctuation">;</span>                runner<span class="token operator">-></span>next <span class="token operator">=</span> runner<span class="token operator">-></span>next<span class="token operator">-></span>next<span class="token punctuation">;</span>                <span class="token function">free</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 释放重复节点</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                runner <span class="token operator">=</span> runner<span class="token operator">-></span>next<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        current <span class="token operator">=</span> current<span class="token operator">-></span>next<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>通俗解释：<br />想象排查一队人：</p><ol><li>固定当前人（<code>current</code>），派助手（<code>runner</code>）检查后续队伍</li><li>发现重复姓名（相同<code>data</code>）→ 助手移除重复者并记录</li><li>当前人前进，继续排查</li></ol></li><li><p>技术解析：</p><ul><li><strong>双指针技巧</strong>：<code>current</code> 锁定目标，<code>runner</code> 扫描后续节点</li><li><strong>内存安全</strong>：<code>free</code> 后无需置空（局部指针自动失效）</li><li><strong>边界处理</strong>：头节点无需特殊处理（无前驱节点问题）</li></ul></li><li><p>应用场景：</p><ul><li>数据库去重（如用户ID列表）</li><li>编译器符号表处理（避免重复变量名）</li></ul></li></ul><h3 id="3-网络编程-tcp协议"><a class="markdownIt-Anchor" href="#3-网络编程-tcp协议"></a> <strong>3. 网络编程 - TCP协议</strong></h3><ul><li><p>类型：简答题</p></li><li><p>​题目​​：​<strong>​TCP三次握手​</strong>​中，为什么第二次握手需要同时发送 <code>SYN+ACK</code>？</p></li><li><p>答案：<br />​<strong>​根本原因​</strong>​：​<strong>​合并确认与同步​</strong>​，减少通信轮次，提高效率</p><p><strong>握手过程详解</strong>：</p><table><thead><tr><th>步骤</th><th>方向</th><th>标志位</th><th>作用</th></tr></thead><tbody><tr><td>① 首次握手</td><td>客户端→服务端</td><td><code>SYN=1</code></td><td>请求连接 + 发送初始序列号（ISN）</td></tr><tr><td>② 二次握手</td><td>服务端→客户端</td><td><code>SYN=1, ACK=1</code></td><td><strong>确认客户端ISN + 发送自身ISN</strong></td></tr><tr><td>③ 三次握手</td><td>客户端→服务端</td><td><code>ACK=1</code></td><td>确认服务端ISN</td></tr></tbody></table></li><li><p><strong>为什么不能拆分成两次？</strong></p><ul><li>若分开发送（先<code>ACK</code>再<code>SYN</code>）：需4次通信 → 延迟更高</li><li><code>SYN+ACK</code> 合并：既确认客户端请求，又声明自身参数 → <strong>最小化建立连接的耗时</strong></li></ul></li><li><p>底层原理：</p>  <pre class="line-numbers language-C" data-language="C"><code class="language-C">&#x2F;&#x2F; Linux内核简化实现（syn_sent状态处理）if (收到SYN) &#123;    发送SYN+ACK;  &#x2F;&#x2F; 合并响应    进入SYN_RECEIVED状态;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>典型应用：</p><ul><li>HTTP请求（浏览器访问网页必经历握手）</li><li>数据库连接（如MySQL客户端/服务端通信）</li></ul></li></ul>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> C++ </tag>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>每日知识点-8</title>
      <link href="/2025/06/04/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-8/"/>
      <url>/2025/06/04/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-8/</url>
      
        <content type="html"><![CDATA[<h2 id="每日知识点-8"><a class="markdownIt-Anchor" href="#每日知识点-8"></a> 每日知识点-8</h2><hr /><h3 id="1-c语言-指针与内存管理"><a class="markdownIt-Anchor" href="#1-c语言-指针与内存管理"></a> <strong>1. C语言 - 指针与内存管理</strong></h3><ul><li>类型​​：代码改错题</li><li>​题目​​：以下代码存在什么隐患？如何修正？  <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> <span class="token operator">*</span>ptr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">*</span>ptr <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>    <span class="token function">free</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Value: %d\n"</span><span class="token punctuation">,</span> <span class="token operator">*</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 问题点</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>答案：<ul><li>隐患：访问已释放内存（悬空指针）</li><li>修正​​：在 <code>free(ptr)</code> 后添加 <code>ptr = NULL;</code> ，并增加非空判断：  <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">free</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>ptr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>  <span class="token comment">// 防止野指针</span><span class="token keyword">if</span> <span class="token punctuation">(</span>ptr <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">*</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 安全访问</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li><li>通俗解释​​：<br />释放内存就像退房后交还钥匙，但手中仍保留房号（指针地址）。若用旧钥匙开门（访问*ptr），可能闯入他人房间（内存错误）。置为NULL相当于撕毁旧房号。</li><li>技术解析​​：<ul><li>free()仅释放内存，不修改指针值</li><li>未置空的悬空指针可能触发​​段错误（Segmentation Fault）​​</li><li>调试工具valgrind可检测此类错误</li></ul></li><li>应用场景​​：<br />动态内存管理（如网络数据包缓存、图像像素处理）中必须避免悬空指针</li></ul></li></ul><h3 id="2-数据结构-链表操作"><a class="markdownIt-Anchor" href="#2-数据结构-链表操作"></a> <strong>2. 数据结构 - 链表操作</strong></h3><ul><li>类型​​：编程题</li><li>​题目​​：实现单链表删除指定值节点的函数：  <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">Node</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> data<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">Node</span><span class="token operator">*</span> next<span class="token punctuation">;</span><span class="token punctuation">&#125;</span> Node<span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">deleteNode</span><span class="token punctuation">(</span>Node<span class="token operator">*</span><span class="token operator">*</span> head<span class="token punctuation">,</span> <span class="token keyword">int</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>答案：  <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">deleteNode</span><span class="token punctuation">(</span>Node<span class="token operator">*</span><span class="token operator">*</span> head<span class="token punctuation">,</span> <span class="token keyword">int</span> target<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    Node <span class="token operator">*</span>temp <span class="token operator">=</span> <span class="token operator">*</span>head<span class="token punctuation">,</span> <span class="token operator">*</span>prev <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>    <span class="token comment">// 删除头节点</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>temp <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> temp<span class="token operator">-></span>data <span class="token operator">==</span> target<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token operator">*</span>head <span class="token operator">=</span> temp<span class="token operator">-></span>next<span class="token punctuation">;</span>        <span class="token function">free</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// 遍历查找目标节点</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>temp <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> temp<span class="token operator">-></span>data <span class="token operator">!=</span> target<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        prev <span class="token operator">=</span> temp<span class="token punctuation">;</span>        temp <span class="token operator">=</span> temp<span class="token operator">-></span>next<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// 未找到目标</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>temp <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token comment">// 删除中间/尾部节点</span>    prev<span class="token operator">-></span>next <span class="token operator">=</span> temp<span class="token operator">-></span>next<span class="token punctuation">;</span>    <span class="token function">free</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>通俗解释​​：<br />链表像寻宝游戏，每个纸条写着下一个宝藏位置。删除节点相当于：找到目标纸条 → 让前一张纸条指向后一张 → 销毁目标纸条。</li><li>技术解析​​：<ul><li>双指针技巧​​：prev记录前驱节点，temp定位目标</li><li>​边界处理​​：头节点删除需特殊处理（修改*head）</li><li>内存安全​​：free后建议置空指针（temp = NULL）</li></ul></li><li>应用场景​​<ul><li>浏览器历史记录删除</li><li>游戏对象管理（动态移除NPC）</li></ul></li></ul></li></ul><h3 id="3-linux系统-文件与进程"><a class="markdownIt-Anchor" href="#3-linux系统-文件与进程"></a> <strong>3. Linux系统 - 文件与进程</strong></h3><ul><li><p>类型​​：简答题</p></li><li><p>​题目​​：Linux中fork()和exec()函数的作用及区别是什么？</p></li><li><p>答案：</p><table><thead><tr><th style="text-align:center">函数</th><th style="text-align:center">作用</th><th style="text-align:center">区别</th></tr></thead><tbody><tr><td style="text-align:center"><code>fork()</code></td><td style="text-align:center">创建当前进程的副本</td><td style="text-align:center">子进程继承父进程所有资源</td></tr><tr><td style="text-align:center"><code>exec()</code></td><td style="text-align:center">加载新程序到当前进程</td><td style="text-align:center">替换当前进程的代码段</td></tr></tbody></table><ul><li>通俗解释​​：<ul><li>fork()像细胞分裂：生成两个完全相同的个体</li><li>exec()像灵魂转移：身体不变，但意识被新程序取代</li></ul></li><li>技术解析​​：  <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span><span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 创建子进程</span><span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>     <span class="token comment">// 子进程执行区域</span>    <span class="token function">execl</span><span class="token punctuation">(</span><span class="token string">"/bin/ls"</span><span class="token punctuation">,</span> <span class="token string">"ls"</span><span class="token punctuation">,</span> <span class="token string">"-l"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 替换为ls命令</span><span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>    <span class="token function">wait</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 父进程等待子进程结束</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>注意事项​​：<ul><li>fork()返回值：父进程获子进程PID，子进程获0</li><li>exec()成功不返回，失败返回-1</li></ul></li><li>应用场景​​：<ul><li>Web服务器（Nginx/Apache）处理多请求</li><li>Shell命令执行（输入ls时先fork()再exec()）</li></ul></li></ul></li></ul>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> C++ </tag>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>每日知识点-7</title>
      <link href="/2025/06/03/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-7/"/>
      <url>/2025/06/03/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-7/</url>
      
        <content type="html"><![CDATA[<h2 id="每日知识点-7"><a class="markdownIt-Anchor" href="#每日知识点-7"></a> 每日知识点-7</h2><hr /><h3 id="1-信号signal通信机制"><a class="markdownIt-Anchor" href="#1-信号signal通信机制"></a> <strong>1. 信号（Signal）通信机制​</strong></h3><ul><li>通俗解释<br />像给进程发微信通知——内核是“微信服务器”，信号是预设的快捷消息（如SIGINT=“紧急中断！”）。进程注册“消息处理函数”决定如何响应。</li><li>技术解析  <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// 注册SIGINT信号处理函数</span><span class="token keyword">void</span> <span class="token function">handle_int</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Received SIGINT!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token function">signal</span><span class="token punctuation">(</span>SIGINT<span class="token punctuation">,</span> handle_int<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 发送信号（进程内部或跨进程）</span><span class="token function">kill</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> SIGINT<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 向指定进程发送中断信号</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>特点​​：异步通信、信息量小（仅信号编号）、无数据负载</li><li>应用场景<br />Nginx平滑重启：Master进程收到SIGHUP后重载配置，Worker进程完成当前请求后退出</li></ul><h3 id="2-管道pipe的优劣与变体"><a class="markdownIt-Anchor" href="#2-管道pipe的优劣与变体"></a> <strong>2. 管道（Pipe）的优劣与变体​</strong></h3><ul><li><p>通俗解释<br />父子进程间的“对讲机”：</p><ul><li>普通管道：单向通话，挂断即失效（内存中）</li><li>命名管道（FIFO）：创建对讲频道，任意进程可加入（文件系统中持久化）</li></ul></li><li><p>技术解析</p>  <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 创建命名管道</span><span class="token function">mkfifo</span> my_pipe<span class="token comment"># 进程A写入</span><span class="token builtin class-name">echo</span> <span class="token string">"Hello"</span> <span class="token operator">></span> my_pipe  <span class="token comment"># 进程B读取</span><span class="token function">cat</span> <span class="token operator">&lt;</span> my_pipe<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><table><thead><tr><th style="text-align:center"><strong>类型</strong></th><th style="text-align:center"><strong>通信关系</strong></th><th style="text-align:center"><strong>生命周期</strong></th></tr></thead><tbody><tr><td style="text-align:center">匿名管道</td><td style="text-align:center">仅父子/兄弟进程</td><td style="text-align:center">随进程结束销毁</td></tr><tr><td style="text-align:center">命名管道(FIFO)</td><td style="text-align:center">任意进程</td><td style="text-align:center">显式删除才销毁</td></tr></tbody></table></li><li><p>避坑指南<br />管道默认阻塞式读写：写端未关闭时读空管道会阻塞；读端未关闭时写满管道（默认64KB）也会阻塞。</p></li></ul><h3 id="3-共享内存shared-memory高性能原理"><a class="markdownIt-Anchor" href="#3-共享内存shared-memory高性能原理"></a> <strong>3. 共享内存（Shared Memory）高性能原理​</strong></h3><ul><li>通俗解释​<br />多进程共用“云端文档”：所有进程直接编辑同一内存区域，无需复制数据（最快IPC方式），但需自备“编辑锁”（同步机制）</li><li>技术解析  <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// 创建共享内存段</span><span class="token keyword">int</span> shm_id <span class="token operator">=</span> <span class="token function">shmget</span><span class="token punctuation">(</span>IPC_PRIVATE<span class="token punctuation">,</span> size<span class="token punctuation">,</span> IPC_CREAT <span class="token operator">|</span> <span class="token number">0666</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 映射到进程地址空间</span><span class="token keyword">char</span><span class="token operator">*</span> shm_ptr <span class="token operator">=</span> <span class="token function">shmat</span><span class="token punctuation">(</span>shm_id<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 写入数据</span><span class="token function">strcpy</span><span class="token punctuation">(</span>shm_ptr<span class="token punctuation">,</span> <span class="token string">"Shared Data"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>性能优势​​：省去内核态-用户态数据拷贝，​​吞吐量提升10倍+​​（对比管道）</li><li>应用场景​<br />数据库写日志（WAL）：多个写进程通过共享内存追加日志，由后台线程批量刷盘。</li></ul><h3 id="4-消息队列message-queue解耦逻辑"><a class="markdownIt-Anchor" href="#4-消息队列message-queue解耦逻辑"></a> <strong>4. 消息队列（Message Queue）解耦逻辑​</strong></h3><ul><li>通俗解释<br />进程间的“邮箱系统”：发送方投递带标签的消息到队列，接收方按需取件（支持优先级），互不阻塞。</li><li>技术解析  <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// 发送结构化消息</span><span class="token keyword">struct</span> <span class="token class-name">msgbuf</span> <span class="token punctuation">&#123;</span> <span class="token keyword">long</span> mtype<span class="token punctuation">;</span> <span class="token keyword">char</span> mtext<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token function">msgsnd</span><span class="token punctuation">(</span>qid<span class="token punctuation">,</span> <span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>mtext<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 接收特定类型消息</span><span class="token function">msgrcv</span><span class="token punctuation">(</span>qid<span class="token punctuation">,</span> <span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>mtext<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 接收mtype=1的消息</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>核心能力​​：消息持久化（内核维护）、异步通信、流量削峰</li><li>应用场景<br />微服务架构：订单服务投递消息到队列，库存服务异步消费，避免服务宕机导致数据丢失。</li></ul><h3 id="5-socket通信的跨主机扩展性"><a class="markdownIt-Anchor" href="#5-socket通信的跨主机扩展性"></a> <strong>5. Socket通信的跨主机扩展性​</strong></h3><ul><li>通俗解释​<br />进程的“跨国电话”：通过IP+端口定位目标进程，支持TCP（可靠连接）/UDP（高速传输）</li><li>技术解析  <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// 服务端绑定监听</span><span class="token keyword">int</span> sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">bind</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>serv_addr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>serv_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">listen</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 客户端连接</span><span class="token function">connect</span><span class="token punctuation">(</span>cli_sock<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>serv_addr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>serv_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>协议选择​​：<br />TCP：保证有序可靠（如SSH远程登录）<br />UDP：低延迟容忍丢包（如视频流传输）</li><li>应用场景​<br />Docker容器通信：同一主机容器用Unix Domain Socket（高性能），跨主机容器用TCP Socket。</li></ul><h3 id="总结"><a class="markdownIt-Anchor" href="#总结"></a> 总结</h3><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/202506041441407.png" alt="image-20250604144125331" /></p><table><thead><tr><th style="text-align:center"><strong>机制</strong></th><th style="text-align:center"><strong>生活化比喻</strong></th><th style="text-align:center"><strong>技术锚点</strong></th><th style="text-align:center"><strong>工业场景</strong></th></tr></thead><tbody><tr><td style="text-align:center">信号</td><td style="text-align:center">微信紧急通知</td><td style="text-align:center"><code>kill()</code>/<code>signal()</code></td><td style="text-align:center">Nginx热加载配置</td></tr><tr><td style="text-align:center">命名管道</td><td style="text-align:center">持久化对讲频道</td><td style="text-align:center"><code>mkfifo</code>+阻塞读写控制</td><td style="text-align:center">日志收集管道</td></tr><tr><td style="text-align:center">共享内存</td><td style="text-align:center">多人编辑云端文档</td><td style="text-align:center"><code>shmget()</code>+信号量同步</td><td style="text-align:center">数据库WAL日志缓冲</td></tr><tr><td style="text-align:center">消息队列</td><td style="text-align:center">分布式邮箱</td><td style="text-align:center"><code>msgsnd()</code>/<code>msgrcv()</code>+消息类型过滤</td><td style="text-align:center">微服务订单库存解耦</td></tr><tr><td style="text-align:center">Socket</td><td style="text-align:center">国际长途电话</td><td style="text-align:center">TCP三次握手/UDP无连接</td><td style="text-align:center">Docker跨容器通信</td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> C++ </tag>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>每日知识点-6</title>
      <link href="/2025/05/28/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-6/"/>
      <url>/2025/05/28/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-6/</url>
      
        <content type="html"><![CDATA[<h2 id="每日知识点p-6"><a class="markdownIt-Anchor" href="#每日知识点p-6"></a> 每日知识点p-6</h2><hr /><h3 id="1-c中引用和指针的区别"><a class="markdownIt-Anchor" href="#1-c中引用和指针的区别"></a> <strong>1. C++中引用(&amp;)和指针(*)的区别</strong></h3><ul><li>通俗解释​​：<br />引用像​​身份证复印件​​——必须绑定原身份（初始化后不可改），操作复印件等同操作本人；指针像​​快递单号​​——可随时修改指向的包裹（可重赋值），<br />但可能填错单号（空指针）。</li><li>​技术解析​​：<br />引用：​​不可为空​​、​​不可重绑定​​、​​无独立内存​​<br />指针：可为空、可重指向、有独立内存地址  <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span><span class="token keyword">int</span><span class="token operator">&amp;</span> ref <span class="token operator">=</span> a<span class="token punctuation">;</span>  <span class="token comment">// 引用必须初始化，ref是a的别名</span><span class="token keyword">int</span><span class="token operator">*</span> ptr <span class="token operator">=</span> <span class="token operator">&amp;</span>a<span class="token punctuation">;</span> <span class="token comment">// 指针存储地址，可修改 ptr = nullptr;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li><li>​​应用场景​​：<br />函数参数传递：引用避免拷贝（void print(const string&amp; s)），指针用于需重指向的场景（链表操作）</li><li>​​避坑指南​​：<br />函数返回局部变量引用会导致悬空引用！应返回静态变量或传值</li></ul><h3 id="2-const关键字的作用"><a class="markdownIt-Anchor" href="#2-const关键字的作用"></a> <strong>2. ​​const关键字的作用​</strong></h3><ul><li>通俗解释​​：<br />const是​​防篡改封条​​：贴变量上（值不可改），贴函数参数上（函数内不可改），贴成员函数上（函数不改对象状态）。</li><li>​技术解析​​：  <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">const</span> <span class="token keyword">int</span> MAX <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>       <span class="token comment">// 常量不可修改</span><span class="token keyword">void</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token keyword">const</span> Student<span class="token operator">&amp;</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 保证不修改s</span><span class="token keyword">class</span> <span class="token class-name">Circle</span> <span class="token punctuation">&#123;</span><span class="token keyword">double</span> <span class="token function">getArea</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>  <span class="token comment">// 承诺不修改类成员</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>常量指针：不能通过指针修改指向的值，变量自身不可变（const int* p）<br />指针常量：不能改变指针的指向，指向的对象不可变（int* const p）</li><li>应用场景​​：<br />硬件寄存器映射（volatile const uint32_t* REG_ADDR），防止误写</li></ul><h3 id="3-虚函数实现原理"><a class="markdownIt-Anchor" href="#3-虚函数实现原理"></a> <strong>3. ​​虚函数实现原理​​</strong></h3><ul><li>通俗解释​​：<br />父类定义​​万能遥控器按钮​​（虚函数），子类​​重写按钮功能​​。按父类按钮（基类指针）实际执行子类功能（动态绑定）。</li><li>技术解析​​：  <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">Animal</span> <span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span><span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">speak</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> cout <span class="token operator">&lt;&lt;</span> <span class="token string">"???"</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> <span class="token comment">// 虚函数 → 生成虚函数表</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">Dog</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Animal</span></span> <span class="token punctuation">&#123;</span><span class="token keyword">void</span> <span class="token function">speak</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">override</span> <span class="token punctuation">&#123;</span> cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Wang!"</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> <span class="token comment">// 覆盖虚函数表项</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>Animal<span class="token operator">*</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Dog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>a<span class="token operator">-></span><span class="token function">speak</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出 "Wang!" （查虚函数表调用Dog::speak）</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>核心机制：​​虚函数表（vtable）​​ + ​​虚表指针（vptr）​​<br />代价：每个对象增加8字节（64位）</li><li>应用场景​​：<br />插件架构（基类定义接口，动态库实现具体功能）</li></ul><h3 id="4-进程-vs-线程的区别"><a class="markdownIt-Anchor" href="#4-进程-vs-线程的区别"></a> <strong>4. 进程 vs 线程的区别</strong></h3><table><thead><tr><th style="text-align:center"><strong>对比项</strong></th><th style="text-align:center"><strong>进程</strong></th><th style="text-align:center"><strong>线程</strong></th></tr></thead><tbody><tr><td style="text-align:center"><strong>🍎 通俗比喻</strong></td><td style="text-align:center">独立办公室（有独立资源）</td><td style="text-align:center">办公室内同事（共享资源）</td></tr><tr><td style="text-align:center"><strong>资源隔离</strong></td><td style="text-align:center">内存、文件句柄独立</td><td style="text-align:center">共享进程内存和文件</td></tr><tr><td style="text-align:center"><strong>创建开销</strong></td><td style="text-align:center">大（需复制父进程资源）</td><td style="text-align:center">小（仅复制栈和寄存器）</td></tr><tr><td style="text-align:center"><strong>通信成本</strong></td><td style="text-align:center">高（需IPC：管道/共享内存）</td><td style="text-align:center">低（直接读写共享变量）</td></tr><tr><td style="text-align:center"><strong>崩溃影响</strong></td><td style="text-align:center">不影响其他进程</td><td style="text-align:center">同一进程内线程全部终止</td></tr></tbody></table><ul><li>应用场景：<br />Chrome浏览器：每个标签页是独立进程（崩溃隔离），页面渲染用多线程</li></ul><h3 id="5-互斥锁-vs-自旋锁的选择"><a class="markdownIt-Anchor" href="#5-互斥锁-vs-自旋锁的选择"></a> <strong>5. 互斥锁 vs 自旋锁的选择</strong></h3><ul><li><p>通俗解释：</p><ul><li><strong>互斥锁</strong>：发现厕所有人→<strong>去休息室睡觉</strong>（线程休眠），等人出来再被唤醒</li><li><strong>自旋锁</strong>：发现厕所有人→<strong>门口转圈盯门</strong>（CPU空转），门开立即冲入</li></ul></li><li><p>技术解析：</p><table><thead><tr><th style="text-align:center"><strong>锁类型</strong></th><th style="text-align:center"><strong>适用场景</strong></th><th style="text-align:center"><strong>临界区耗时</strong></th><th style="text-align:center"><strong>性能影响</strong></th></tr></thead><tbody><tr><td style="text-align:center">互斥锁</td><td style="text-align:center">I/O操作、复杂计算</td><td style="text-align:center">&gt;1μs</td><td style="text-align:center">上下文切换开销大</td></tr><tr><td style="text-align:center">自旋锁</td><td style="text-align:center">短时操作（如计数器自增）</td><td style="text-align:center">&lt;1μs</td><td style="text-align:center">浪费CPU但响应快</td></tr></tbody></table></li><li><p>应用场景：<br />网卡收包中断处理（自旋锁），数据库连接池管理（互斥锁）</p></li></ul><h3 id="6-虚拟内存的作用"><a class="markdownIt-Anchor" href="#6-虚拟内存的作用"></a> <strong>6. 虚拟内存的作用</strong></h3><ul><li>通俗解释：<br />虚拟内存像酒店房间管理系统：<br />- 每个程序觉得独占所有房间（连续地址空间）<br />- 实际房间（物理内存）可能不足，部分客人行李存车库（磁盘交换区）<br />- 保安（MMU）实时查房卡（页表）找真实房间号</li><li>技术解析：<ul><li><strong>页表（Page Table）</strong>：映射虚拟页→物理页帧</li><li><strong>缺页中断</strong>：访问未加载页时触发，OS从磁盘调入</li><li><strong>写时复制（Copy-on-Write）</strong>：子进程共享父进程页，仅修改时复制</li></ul></li><li>应用场景：<br />运行超内存程序（如8GB内存启动16GB的VMware），进程隔离（防止A进程篡改B进程数据）</li></ul><h3 id="7-哈希表冲突解决方案"><a class="markdownIt-Anchor" href="#7-哈希表冲突解决方案"></a> <strong>​7. ​哈希表冲突解决方案​</strong></h3><ul><li><p>通俗解释​​：<br />两辆车（数据）被导航到同一车位（哈希冲突）：<br />​​链地址法​​：车位改成立体车库（链表挂多辆车）<br />​​开放寻址法​​：保安找下一个空位（线性/二次探测）</p></li><li><p>技术解析​​：</p>  <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// 链地址法实现（C++简版）</span><span class="token keyword">class</span> <span class="token class-name">HashMap</span> <span class="token punctuation">&#123;</span>vector<span class="token operator">&lt;</span>list<span class="token operator">&lt;</span>pair<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> string<span class="token operator">>></span><span class="token operator">></span> buckets<span class="token punctuation">;</span> <span class="token comment">// 桶数组+链表</span><span class="token keyword">void</span> <span class="token function">insert</span><span class="token punctuation">(</span><span class="token keyword">int</span> key<span class="token punctuation">,</span> string val<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> idx <span class="token operator">=</span> <span class="token function">hash</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">%</span> buckets<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> p <span class="token operator">:</span> buckets<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>first <span class="token operator">==</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> p<span class="token punctuation">.</span>second <span class="token operator">=</span> val<span class="token punctuation">;</span> <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> <span class="token comment">// 键存在则更新</span>    <span class="token punctuation">&#125;</span>    buckets<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>key<span class="token punctuation">,</span> val<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 冲突时链表追加</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><table><thead><tr><th style="text-align:center"><strong>方法</strong></th><th style="text-align:center"><strong>平均时间复杂度</strong></th><th style="text-align:center"><strong>空间开销</strong></th><th style="text-align:center"><strong>适用场景</strong></th></tr></thead><tbody><tr><td style="text-align:center">链地址法</td><td style="text-align:center">O(1 + α)</td><td style="text-align:center">指针额外空间</td><td style="text-align:center">通用场景</td></tr><tr><td style="text-align:center">开放寻址法</td><td style="text-align:center">O(1/(1-α))</td><td style="text-align:center">无指针开销</td><td style="text-align:center">缓存友好，内存紧张</td></tr></tbody></table></li><li><p>应用场景​​：<br />Redis字典（链地址法），Linux内核页缓存（开放寻址）</p></li></ul><h3 id="8-二叉树前序中序后序遍历"><a class="markdownIt-Anchor" href="#8-二叉树前序中序后序遍历"></a> <strong>8. 二叉树前序/中序/后序遍历​​</strong></h3><ul><li><p>通俗解释​​：<br />遍历像​​查户口登记​​：<br />​​前序​​：先登记自己，再查左子树，最后右子树（根→左→右）<br />​​中序​​：先查左子树，再登记自己，最后右子树（左→根→右）→ ​​二叉搜索树输出有序序列​​<br />​​后序​​：先查左右子树，最后登记自己（左→右→根）→ ​​用于释放子树内存​</p></li><li><p>技术解析​​：</p>  <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// 递归中序遍历（升序输出二叉搜索树）</span><span class="token keyword">void</span> <span class="token function">inorder</span><span class="token punctuation">(</span>TreeNode<span class="token operator">*</span> root<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>root<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span><span class="token function">inorder</span><span class="token punctuation">(</span>root<span class="token operator">-></span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 先左子树</span>cout <span class="token operator">&lt;&lt;</span> root<span class="token operator">-></span>val <span class="token operator">&lt;&lt;</span> <span class="token string">" "</span><span class="token punctuation">;</span> <span class="token comment">// 输出当前节点</span><span class="token function">inorder</span><span class="token punctuation">(</span>root<span class="token operator">-></span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 再右子树</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><table><thead><tr><th style="text-align:center"><strong>遍历方式</strong></th><th style="text-align:center"><strong>非递归实现核心</strong></th><th style="text-align:center"><strong>应用场景</strong></th></tr></thead><tbody><tr><td style="text-align:center">前序</td><td style="text-align:center">栈顶→右子入栈→左子入栈</td><td style="text-align:center">目录树结构展示</td></tr><tr><td style="text-align:center">中序</td><td style="text-align:center">左链入栈→弹出访问→转右子树</td><td style="text-align:center">二叉搜索树有序输出</td></tr><tr><td style="text-align:center">后序</td><td style="text-align:center">双栈法/反向前序</td><td style="text-align:center">表达式树求值（后缀表达式）</td></tr></tbody></table></li><li><p>应用场景​​：<br />编译器解析数学表达式（后序遍历求值），文件系统树状展示（前序遍历）</p></li></ul><h3 id="9-tcp为什么需要三次握手"><a class="markdownIt-Anchor" href="#9-tcp为什么需要三次握手"></a> ​<strong>9. ​TCP为什么需要三次握手？</strong></h3><ul><li>通俗解释​​：<br />类比打电话：<br />A打给B：“能听到吗？”（SYN）<br />B回答：“能听到，你听得到我吗？”（SYN-ACK）<br />A说：“我也能听到”（ACK）→ ​​双方确认通信能力​​<br />如果只有两次：B无法确认A是否收到回复（可能B白等）</li><li>技术解析​​：  <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span> <span class="token expression">TCP握手抓包示例（Wireshark）</span></span><span class="token number">1.</span> Client → Server<span class="token operator">:</span> <span class="token punctuation">[</span>SYN<span class="token punctuation">]</span> Seq<span class="token operator">=</span><span class="token number">0</span><span class="token number">2.</span> Server → Client<span class="token operator">:</span> <span class="token punctuation">[</span>SYN<span class="token punctuation">,</span> ACK<span class="token punctuation">]</span> Seq<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> Ack<span class="token operator">=</span><span class="token number">1</span><span class="token number">3.</span> Client → Server<span class="token operator">:</span> <span class="token punctuation">[</span>ACK<span class="token punctuation">]</span> Seq<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> Ack<span class="token operator">=</span><span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>​- ​防历史连接​​：避免旧重复SYN导致错误连接<br />​- ​同步初始序列号​​：防止网络延迟导致数据错乱</li><li>​​避坑指南​​：<br />服务端未收到第三次ACK会重传SYN-ACK（默认重试5次），可能被SYN Flood攻击！</li></ul><h3 id="10-epoll比select高效的原因"><a class="markdownIt-Anchor" href="#10-epoll比select高效的原因"></a> <strong>10. Epoll比Select高效的原因​</strong></h3><ul><li><p>通俗解释​​：<br />​​Select​​：快递员每次挨个问1000个货架（fd）：“有包裹吗？”（O(n)遍历）<br />​​Epoll​​：货架装传感器，快递员直接看指示灯（事件驱动），哪亮去哪（O(1)定位）</p></li><li><p>技术解析​​：</p>  <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// Epoll核心API</span><span class="token keyword">int</span> epfd <span class="token operator">=</span> <span class="token function">epoll_create1</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 创建epoll实例</span><span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> ev<span class="token punctuation">;</span>ev<span class="token punctuation">.</span>events <span class="token operator">=</span> EPOLLIN<span class="token punctuation">;</span>          <span class="token comment">// 监听可读事件</span><span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epfd<span class="token punctuation">,</span> EPOLL_CTL_ADD<span class="token punctuation">,</span> sockfd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ev<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 注册socket</span><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token function">epoll_wait</span><span class="token punctuation">(</span>epfd<span class="token punctuation">,</span> events<span class="token punctuation">,</span> MAX_EVENTS<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 等待事件</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> EPOLLIN<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">handle_read</span><span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 直接处理活跃fd</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><table><thead><tr><th style="text-align:center"><strong>模型</strong></th><th style="text-align:center"><strong>时间复杂度</strong></th><th style="text-align:center"><strong>最大fd数</strong></th><th style="text-align:center"><strong>内核态拷贝</strong></th></tr></thead><tbody><tr><td style="text-align:center">select</td><td style="text-align:center">O(n)</td><td style="text-align:center">1024</td><td style="text-align:center">每次全量拷贝fd集合</td></tr><tr><td style="text-align:center">epoll</td><td style="text-align:center">O(1)</td><td style="text-align:center">10万+</td><td style="text-align:center">仅返回活跃fd</td></tr></tbody></table></li><li><p>应用场景​​：<br />Nginx高并发连接（10万+），Redis事件处理</p></li></ul>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> C++ </tag>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>每日知识点-5</title>
      <link href="/2025/05/27/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-5/"/>
      <url>/2025/05/27/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-5/</url>
      
        <content type="html"><![CDATA[<h2 id="每日知识点-5"><a class="markdownIt-Anchor" href="#每日知识点-5"></a> 每日知识点-5</h2><hr /><h3 id="1-sfinae-substitution-failure-is-not-an-error-替换失败不是错误-的原理及在类型萃取中的应用"><a class="markdownIt-Anchor" href="#1-sfinae-substitution-failure-is-not-an-error-替换失败不是错误-的原理及在类型萃取中的应用"></a> <strong>1. SFINAE (Substitution Failure Is Not An Error) (替换失败不是错误) 的原理及在类型萃取中的应用</strong></h3><ul><li>原理: 模板实例化时, 若替换导致无效类型/表达式, 该模板被静默忽略, 继续寻找其他可行模板, 它允许在模板实例化过程中, 如果某个模板参数的替换导致编译错误, 编译器不会报错, 而是简单地忽略这个模板实例化。。</li><li>应用:  <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// 如果输入的 T 具有 serialize 这个成员函数, 那么不会产生错误, has_serialize 就会继承 true_type 这个类, 里面只有一个静态成员 true</span><span class="token comment">// 如果没有这个成员函数, 就会出错, 那么就会跳过下面的这个模板, 去调用上面的模板, 也就是直接继承 false_type</span><span class="token comment">// 为什么认为 serialize 是成员函数而不是成员变量? </span><span class="token comment">// &amp;T::serialize 用于获取T类型中的serialize成员的地址</span><span class="token comment">// 如果 serialize 是成员函数, decltype(&amp;T::serialize) 会得到一个指向成员函数的指针 例如, void (T::*)(), int (T::*) (int)等</span><span class="token comment">// &amp;T::serialize会得到一个指向成员变量的指针 例如, int T::*</span><span class="token comment">// void_t 能够将 表达式的结果类型折叠为 void, 但是没有 void 的变量类型。</span><span class="token comment">// 获取成员变量一般使用 T::member</span><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token operator">=</span> <span class="token keyword">void</span><span class="token operator">></span> <span class="token keyword">struct</span> <span class="token class-name">has_serialize</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token class-name">false_type</span></span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">></span><span class="token keyword">struct</span> <span class="token class-name">has_serialize</span><span class="token operator">&lt;</span>T<span class="token punctuation">,</span> void_t<span class="token operator">&lt;</span><span class="token keyword">decltype</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>T<span class="token double-colon punctuation">::</span>serialize<span class="token punctuation">)</span><span class="token operator">>></span> <span class="token operator">:</span> true_type <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>项目关联: 在模型序列化框架中, 用 SFINAE 检测自定义层是否实现 serialize() 方法, 实现泛型处理(类似 ONNX 的序列化机制)</li></ul><h3 id="2-crtp-curiously-recurring-template-pattern-奇异递归模板模式-的静态多态实现"><a class="markdownIt-Anchor" href="#2-crtp-curiously-recurring-template-pattern-奇异递归模板模式-的静态多态实现"></a> <strong>2. CRTP (Curiously Recurring Template Pattern) (奇异递归模板模式) 的静态多态实现</strong></h3><ul><li>引言: CRTP, 即奇异递归模板模式(Curiously Recurring Template Pattern), 是C++中一个独特而强大的设计模式。它利用模板和继承的特性, 允许在编译时进行多态操作, 从而提高代码的性能和灵活性。在人类思维中, 我们经常倾向于通过继承和类似性来理解和分类事物。CRTP以一种类似的方式工作, 通过继承自己(在子类中使用父类模板), 它在技术上实现了一种“自我认知”的模式。</li><li>实现: 派生类将自身作为模板参数传递给基类  <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">Derived</span><span class="token operator">></span><span class="token keyword">class</span> <span class="token class-name">Base</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span><span class="token operator">:</span>        <span class="token keyword">void</span> <span class="token function">interface</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>Derived<span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token function">implementation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">Derived</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Base</span><span class="token operator">&lt;</span><span class="token class-name">Derived</span><span class="token operator">></span></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span><span class="token operator">:</span>        <span class="token keyword">void</span> <span class="token function">implementation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">/* ... */</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>优势: 零虚函数开销, 适合于嵌入式高频调用的算法基类<ul><li>例如:  <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">Derived</span><span class="token operator">></span><span class="token keyword">class</span> <span class="token class-name">Shape</span> <span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token keyword">void</span> <span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>Derived<span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">draw_impl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 调用具体子类的 draw_impl()</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">Circle</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Shape</span><span class="token operator">&lt;</span><span class="token class-name">Circle</span><span class="token operator">></span></span> <span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token keyword">void</span> <span class="token function">draw_impl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Drawing a circle\n"</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">Square</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Shape</span><span class="token operator">&lt;</span><span class="token class-name">Square</span><span class="token operator">></span></span> <span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token keyword">void</span> <span class="token function">draw_impl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Drawing a square\n"</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    Circle c<span class="token punctuation">;</span>    c<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 输出 "Drawing a circle"（无虚函数开销！）</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><table><thead><tr><th style="text-align:left"><strong>对比项</strong></th><th style="text-align:left"><strong>CRTP</strong></th><th style="text-align:left"><strong>虚函数</strong></th></tr></thead><tbody><tr><td style="text-align:left"><strong>多态时机</strong></td><td style="text-align:left">编译期</td><td style="text-align:left">运行期</td></tr><tr><td style="text-align:left"><strong>性能</strong></td><td style="text-align:left">无虚表查找开销</td><td style="text-align:left">有虚函数调用开销</td></tr><tr><td style="text-align:left"><strong>是否可静态调用</strong></td><td style="text-align:left">支持（如 <code>static_func</code>）</td><td style="text-align:left">不支持</td></tr><tr><td style="text-align:left"><strong>代码生成</strong></td><td style="text-align:left">模板实例化（可能代码膨胀）</td><td style="text-align:left">单份虚表</td></tr><tr><td style="text-align:left"><strong>适用场景</strong></td><td style="text-align:left">高性能库、编译期检查</td><td style="text-align:left">运行时动态多态</td></tr></tbody></table></li></ul><h3 id="3-完美转发-perfect-forwarding-的实现与-stdforward-的作用"><a class="markdownIt-Anchor" href="#3-完美转发-perfect-forwarding-的实现与-stdforward-的作用"></a> <strong>3. 完美转发 (Perfect Forwarding) 的实现与 std::forward 的作用</strong></h3><ul><li>前言:<ul><li>万能引用（Universal Reference）<br />万能引用是完美转发的基础, 其形式为 T&amp;&amp;, 其中 T 是模板参数：  <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">></span><span class="token keyword">void</span> <span class="token function">foo</span><span class="token punctuation">(</span>T<span class="token operator">&amp;&amp;</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// arg 是万能引用</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>万能引用的关键特性：<ul><li>可以绑定到左值或右值</li><li>通过引用折叠规则（Reference Collapsing）确定最终类型<br />引用折叠规则:<br />当模板参数推导遇到引用的引用时, C++使用以下规则进行折叠：  <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">T<span class="token operator">&amp;</span> <span class="token operator">&amp;</span> → T<span class="token operator">&amp;</span>T<span class="token operator">&amp;</span> <span class="token operator">&amp;&amp;</span> → T<span class="token operator">&amp;</span>T<span class="token operator">&amp;&amp;</span> <span class="token operator">&amp;</span> → T<span class="token operator">&amp;</span>T<span class="token operator">&amp;&amp;</span> <span class="token operator">&amp;&amp;</span> → T<span class="token operator">&amp;&amp;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li></ul></li></ul></li><li>原理: 通过右值引用和引用折叠保留参数原始类型  <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">></span><span class="token keyword">void</span> <span class="token function">warpper</span><span class="token punctuation">(</span>T<span class="token operator">&amp;&amp;</span> arg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">target</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">forward</span><span class="token generic class-name"><span class="token operator">&lt;</span>T<span class="token operator">></span></span></span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 保留arg的左值/右值性。在转发时恢复参数的原始类型</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">target</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">&amp;</span> x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"左值引用\n"</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">target</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">&amp;&amp;</span> x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"右值引用\n"</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>    <span class="token function">wrapper</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 调用 target(int&amp;)</span>    <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 调用 target(int&amp;&amp;)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>std::forward: 条件转换为右值引用 (当 T 为非左值引用类型时)</li></ul><h3 id="4-模板元编程在嵌入式性能优化中的局限性"><a class="markdownIt-Anchor" href="#4-模板元编程在嵌入式性能优化中的局限性"></a> <strong>4. 模板元编程在嵌入式性能优化中的局限性</strong></h3><ul><li>局限性：<ul><li>编译时间膨胀(模板实例化过多)</li><li>调试困难(错误信息冗长)</li><li>代码体积增大(可能影响 Flash 存储)</li></ul></li><li>优化策略：<ul><li>限制递归深度 (如 constexpr 替代部分模板)<br />(1) 模板元编程（TMP）<br />时期：编译期执行<br />机制：通过模板特化、递归实例化在编译期生成代码<br />典型应用：类型计算、编译期数值计算<br />缺点：语法晦涩、编译错误信息难懂、编译速度慢<br />例如：  <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// 用模板计算阶乘</span><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">int</span> N<span class="token operator">></span><span class="token keyword">struct</span> <span class="token class-name">Factorial</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">int</span> value <span class="token operator">=</span> N <span class="token operator">*</span> Factorial<span class="token operator">&lt;</span>N<span class="token operator">-</span><span class="token number">1</span><span class="token operator">></span><span class="token double-colon punctuation">::</span>value<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token keyword">struct</span> <span class="token class-name">Factorial</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">int</span> value <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">int</span> x <span class="token operator">=</span> Factorial<span class="token operator">&lt;</span><span class="token number">5</span><span class="token operator">></span><span class="token double-colon punctuation">::</span>value<span class="token punctuation">;</span> <span class="token comment">// 编译期计算120</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>(2) constexpr 函数<br />时期：编译期或运行期执行（取决于调用上下文）<br />机制：用普通函数语法实现编译期计算<br />典型应用：替代简单的模板数值计算<br />优点：代码直观、编译错误友好  <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">constexpr</span> <span class="token keyword">int</span> <span class="token function">factorial</span><span class="token punctuation">(</span><span class="token keyword">int</span> n<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> n <span class="token operator">*</span> <span class="token function">factorial</span><span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token function">factorial</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 编译期计算120</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>使用 concepts (C++20) 约束模板参数</li></ul></li></ul><h3 id="5-自旋锁-spinlock-与互斥锁-mutex-的使用场景对比"><a class="markdownIt-Anchor" href="#5-自旋锁-spinlock-与互斥锁-mutex-的使用场景对比"></a> <strong>5. 自旋锁 (spinlock) 与互斥锁 (mutex) 的使用场景对比</strong></h3><ul><li><p>前言：</p><table><thead><tr><th style="text-align:left"><strong>锁类型</strong></th><th style="text-align:left"><strong>比喻场景</strong></th><th style="text-align:left"><strong>行为</strong></th></tr></thead><tbody><tr><td style="text-align:left"><strong>自旋锁</strong></td><td style="text-align:left">你在便利店抢最后一瓶水，不断问店员：“有了吗？有了吗？”（循环检查）</td><td style="text-align:left"><strong>忙等待（Busy-wait）</strong>：占着CPU一直检查锁是否释放</td></tr><tr><td style="text-align:left"><strong>互斥锁</strong></td><td style="text-align:left">你在便利店抢最后一瓶水，店员说&quot;没货了&quot;，你去旁边沙发睡觉，到货后店员叫醒你</td><td style="text-align:left"><strong>睡眠等待（Sleep-wait）</strong>：让出CPU，锁可用时被系统唤醒</td></tr></tbody></table><table><thead><tr><th style="text-align:left"><strong>特性</strong></th><th style="text-align:left"><strong>自旋锁（Spinlock）</strong></th><th style="text-align:left"><strong>互斥锁（Mutex）</strong></th></tr></thead><tbody><tr><td style="text-align:left"><strong>等待方式</strong></td><td style="text-align:left">循环检查（消耗CPU）</td><td style="text-align:left">线程挂起（不消耗CPU）</td></tr><tr><td style="text-align:left"><strong>开销</strong></td><td style="text-align:left">高频CPU占用</td><td style="text-align:left">上下文切换开销</td></tr><tr><td style="text-align:left"><strong>适用场景</strong></td><td style="text-align:left">锁持有时间极短（纳秒/微秒级）</td><td style="text-align:left">锁持有时间较长（毫秒级以上）</td></tr><tr><td style="text-align:left"><strong>实现级别</strong></td><td style="text-align:left">通常需原子指令（如CAS）</td><td style="text-align:left">依赖操作系统API（如futex）</td></tr><tr><td style="text-align:left"><strong>线程状态</strong></td><td style="text-align:left">始终处于运行状态（Runnable）</td><td style="text-align:left">可能被阻塞（Blocked）</td></tr></tbody></table></li><li><p>自旋锁：</p><ul><li>场景：临界区极短(无阻塞)、中断上下文、多核环境</li><li>实现：忙等待 (spin_lock_irqsave())</li></ul></li><li><p>互斥锁：</p><ul><li>场景：临界区较长、可能阻塞 (如文件 IO)、用户态线程</li><li>实现：睡眠等待 (mutex_lock())</li></ul></li><li><p>项目关联：在多核 ARM 设备驱动中, 中断处理函数用自旋锁保护共享寄存器<br />为什么在中断处理中用自旋锁？<br />中断上下文不能睡眠：中断处理函数（如Linux的irq_handler）不能调用可能引发睡眠的函数（如互斥锁mutex_lock）, 而自旋锁是唯一选择。<br />多核竞争：多核CPU可能同时访问同一硬件寄存器, 需保证原子性。<br />短临界区：寄存器操作通常极快（纳秒级）, 适合自旋锁的忙等待特性。</p></li></ul><h3 id="6-rcu-read-copy-update-的原理及适用场景"><a class="markdownIt-Anchor" href="#6-rcu-read-copy-update-的原理及适用场景"></a> <strong>6. RCU (Read-Copy-Update) 的原理及适用场景</strong></h3><ul><li>前言：<br />RCU（Read-Copy-Update）是Linux内核中一种重要的同步机制, 它针对&quot;读多写少&quot;的场景提供了极高的读取性能。<br />RCU的基本理念可以用三句话概括：<br />读取无锁：读者不需要任何锁或原子操作, 可以极速访问数据<br />写者同步：写者通过复制-更新-替换的方式修改数据<br />延迟回收：确保没有读者后再释放旧数据<br />这种设计使得在读取频率远高于写入频率的场景下, 性能远超传统的读写锁。</li><li>原理:<ol><li>读侧：无锁访问数据 (仅需内存屏障)</li><li>写侧：创建副本修改后, 原子替换指针, 异步回收旧数据</li></ol></li><li>适用场景：<br />读多写少的数据结构 (如路由表、内核链表)</li><li>优势：<br />读操作零阻塞, 写操作延迟回收避免竞争。</li></ul><h3 id="7-内存屏障-memory-barrier-在-arm-多核架构中的作用"><a class="markdownIt-Anchor" href="#7-内存屏障-memory-barrier-在-arm-多核架构中的作用"></a> <strong>7. 内存屏障 (Memory Barrier) 在 ARM 多核架构中的作用</strong></h3><ul><li>问题：多核乱序执行和缓存不一致可能导致数据同步错误</li><li>解决方案：<ul><li>写屏障 (dmb st) : 确保屏障前的写操作先于屏障后的写操作完成。</li><li>读屏障 (dmb ld) : 确保屏障前的读操作先于屏障后的读操作完成。</li></ul></li><li>项目关联：<br />在异构计算 (CPU + NPU) 中同步模型权重数据时需显式插入内存屏障</li></ul><h3 id="8-模型量化的基本原理及对推理速度精度的影响"><a class="markdownIt-Anchor" href="#8-模型量化的基本原理及对推理速度精度的影响"></a> <strong>8. 模型量化的基本原理及对推理速度/精度的影响</strong></h3><ul><li>原理：将 FP32 权重/激活值映射到 INT8 (动态范围缩放)</li><li>影响：<ul><li>速度：减少内存带宽, 加速 SIMD 指令 (如 ARM NEON 的vqmovn)</li><li>精度：可能损失边缘样本的识别能力 (需校准数据集补偿)</li></ul></li><li>项目关联: TensorRT 中采用混合量化策略 (敏感层保持 FP16)</li></ul><h3 id="9-嵌入式部署中模型权重的内存对齐优化方法"><a class="markdownIt-Anchor" href="#9-嵌入式部署中模型权重的内存对齐优化方法"></a> <strong>9. 嵌入式部署中模型权重的内存对齐优化方法</strong></h3><ul><li>优化方法：<ul><li>权重数组按 64 字节对齐 (适配 Cache Line)</li><li>使用 posix_memalign 分配内存</li><li>结构体用 <strong>attribute</strong>((aligned))修饰</li></ul></li><li>效果:<br />减少 Cache Miss, 提升 NPU DMA 传输效率 (如瑞芯微 RKNN SDK)</li></ul><h3 id="10-解释-tensorrt-中的层融合-layer-fusion-优化原理"><a class="markdownIt-Anchor" href="#10-解释-tensorrt-中的层融合-layer-fusion-优化原理"></a> <strong>10. 解释 TensorRT 中的层融合 (Layer Fusion) 优化原理</strong></h3><ul><li>原理：将连续层(如 Conv + ReLU + BN) 合并为单一内核, 减少:<ul><li>内存读写次数 (中间结果复用)</li><li>内核启动开销 (CUDA 上下文切换)</li></ul></li><li>项目关联：在 Jetson Nano 部署 YOLOv5 时, TensorRT 自动融合 Backbone 中的 Conv+Silu 层, 推理速度提升3倍。</li></ul><hr /><h3 id="综合应用题"><a class="markdownIt-Anchor" href="#综合应用题"></a> <strong>综合应用题</strong></h3><p>设计一个支持动态优先级调整的线程池</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">ThreadPool</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span><span class="token operator">:</span>        <span class="token keyword">using</span> Task <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>function<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span><span class="token punctuation">;</span>        <span class="token function">ThreadPool</span><span class="token punctuation">(</span>size_t threads<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">for</span><span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> threads<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                workers<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span>                    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                        std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span>queue_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token comment">// 阻塞在这里，只有 stop 或者 队列不为空才结束 wait</span>                        condition<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>lock<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span>                            <span class="token keyword">return</span> stop <span class="token operator">||</span> <span class="token operator">!</span>tasks<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>                        <span class="token keyword">if</span> <span class="token punctuation">(</span>stop <span class="token operator">&amp;&amp;</span> tasks<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>                        <span class="token comment">// std::move 的作用</span>                        <span class="token comment">// 将tasks.top().second从左值转为右值（允许移动而非拷贝）</span>                        <span class="token comment">// 如果second的类型支持移动语义（如std::function、std::string等），则会调用移动构造函数</span>                        <span class="token comment">// 避免不必要的深拷贝，提高性能</span>                        <span class="token keyword">auto</span> task <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>tasks<span class="token punctuation">.</span><span class="token function">top</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>second<span class="token punctuation">)</span><span class="token punctuation">;</span>                        tasks<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token function">task</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">&#125;</span>                <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token operator">~</span><span class="token function">ThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token punctuation">&#123;</span>                std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span>queue_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>                stop <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            condition<span class="token punctuation">.</span><span class="token function">notify_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> worker <span class="token operator">:</span> workers<span class="token punctuation">)</span> worker<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">void</span> <span class="token function">enqueue</span><span class="token punctuation">(</span><span class="token keyword">int</span> priority<span class="token punctuation">,</span> Task task<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token punctuation">&#123;</span>                std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span>queue_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>                tasks<span class="token punctuation">.</span><span class="token function">emplace</span><span class="token punctuation">(</span>priority<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            condition<span class="token punctuation">.</span><span class="token function">notify_one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token keyword">private</span><span class="token operator">:</span>        std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>thread<span class="token operator">></span> workers<span class="token punctuation">;</span>        std<span class="token double-colon punctuation">::</span>priority_queue<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>pair<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> Task<span class="token operator">>></span> tasks<span class="token punctuation">;</span>        std<span class="token double-colon punctuation">::</span>mutex queue_mutex<span class="token punctuation">;</span>        std<span class="token double-colon punctuation">::</span>condition_variable condition<span class="token punctuation">;</span>        <span class="token keyword">bool</span> stop<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>   <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> C++ </tag>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>自定义协议栈服务器开发导航</title>
      <link href="/2025/05/26/%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8D%8F%E8%AE%AE%E6%A0%88%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BC%80%E5%8F%91%E5%AF%BC%E8%88%AA/"/>
      <url>/2025/05/26/%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8D%8F%E8%AE%AE%E6%A0%88%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BC%80%E5%8F%91%E5%AF%BC%E8%88%AA/</url>
      
        <content type="html"><![CDATA[<h2 id="自定义协议栈服务器开发导航"><a class="markdownIt-Anchor" href="#自定义协议栈服务器开发导航"></a> 自定义协议栈服务器开发导航</h2><hr /><ol><li><a href="/2025/05/26/%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8D%8F%E8%AE%AE%E6%A0%88%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BC%80%E5%8F%91-1/" title="自定义协议栈服务器开发-1">自定义协议栈服务器开发-1</a></li><li><a href="/2025/05/26/%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8D%8F%E8%AE%AE%E6%A0%88%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BC%80%E5%8F%91-2/" title="自定义协议栈服务器开发-2">自定义协议栈服务器开发-2</a></li><li><a href="/2025/05/26/%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8D%8F%E8%AE%AE%E6%A0%88%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BC%80%E5%8F%91-3/" title="自定义协议栈服务器开发-3">自定义协议栈服务器开发-3</a></li><li><a href="/2025/05/26/%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8D%8F%E8%AE%AE%E6%A0%88%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BC%80%E5%8F%91-4/" title="自定义协议栈服务器开发-4">自定义协议栈服务器开发-4</a></li><li><a href="/2025/05/26/%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8D%8F%E8%AE%AE%E6%A0%88%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BC%80%E5%8F%91-5/" title="自定义协议栈服务器开发-5">自定义协议栈服务器开发-5</a></li></ol>]]></content>
      
      
      <categories>
          
          <category> 开发记录 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> C++ </tag>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>自定义协议栈服务器开发-5</title>
      <link href="/2025/05/26/%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8D%8F%E8%AE%AE%E6%A0%88%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BC%80%E5%8F%91-5/"/>
      <url>/2025/05/26/%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8D%8F%E8%AE%AE%E6%A0%88%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BC%80%E5%8F%91-5/</url>
      
        <content type="html"><![CDATA[<h2 id="扩展多协议支持"><a class="markdownIt-Anchor" href="#扩展多协议支持"></a> 扩展多协议支持</h2><h2 id="当前架构设计"><a class="markdownIt-Anchor" href="#当前架构设计"></a> 当前架构设计</h2><h3 id="11-模块分层以及职责"><a class="markdownIt-Anchor" href="#11-模块分层以及职责"></a> 1.1 模块分层以及职责</h3><pre class="line-numbers language-none"><code class="language-none">+----------------------+        +----------------------+        +----------------------+  | 客户端（TCP 发送）   | ----▶  | 主线程：epoll Reactor | ----▶  | 线程池：Task 处理      |  +----------------------+        +----------------------+        +----------------------+  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ol><li><p><strong>客户端</strong></p><ul><li>建立 TCP 连接到服务器 <code>IP:port</code>。</li><li>将自定义 <code>Packet</code> 数据通过 <code>send()</code> 推送。</li></ul></li><li><p><strong>主线程（Reactor）</strong></p><ul><li><strong>初始化 epoll</strong>，注册 <code>listen_fd</code>（TCP监听套接字）。</li><li><strong>Accept</strong>：当 <code>listen_fd</code> 可读 (<code>EPOLLIN</code>) 时，调用 <code>accept()</code> 获取 <code>conn_fd</code>，并将其加入 epoll 监听。</li><li><strong>事件分发</strong>：对 <code>conn_fd</code> 上的 <code>EPOLLIN</code> / <code>EPOLLOUT</code> 事件，封装成 <code>EventTask</code>，并提交到线程池处理队列。</li></ul></li><li><p><strong>线程池（Worker）</strong></p><ul><li><strong>Task队列</strong>：主线程投递任务，Worker 从队列中拉取。</li><li><strong>Protocol 处理</strong>：调用 <code>Protocol</code> 对象的 <code>tryReceivePacket(Packet&amp;)</code> 或 <code>flushSendBuffer()</code>，执行底层 I/O 并管理 <code>send_buffer_</code> / <code>recv_buffer_</code>。</li><li><strong>Packet 解析</strong>：<code>Protocol::parseFromBuffer()</code> 将流缓冲区数据拆分成完整 <code>Packet</code>。</li><li><strong>业务回调</strong>：将解析后的 <code>Packet</code> 分发给上层逻辑（例如消息路由）。</li></ul></li></ol><h3 id="22-核心类和接口"><a class="markdownIt-Anchor" href="#22-核心类和接口"></a> 2.2 核心类和接口</h3><h4 id="221-iprotocol-接口"><a class="markdownIt-Anchor" href="#221-iprotocol-接口"></a> 2.2.1 <code>IProtocol</code> 接口</h4><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">IProtocol</span> <span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token keyword">enum</span> <span class="token keyword">class</span> <span class="token class-name">ReadStatus</span> <span class="token punctuation">&#123;</span> OK<span class="token punctuation">,</span> NeedRetry<span class="token punctuation">,</span> Error <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">IProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>    <span class="token keyword">virtual</span> ReadStatus <span class="token function">tryReceivePacket</span><span class="token punctuation">(</span>Packet<span class="token operator">&amp;</span> pkt<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">enqueuePacket</span><span class="token punctuation">(</span><span class="token keyword">const</span> Packet<span class="token operator">&amp;</span> pkt<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">virtual</span> <span class="token keyword">bool</span> <span class="token function">flushSendBuffer</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">&amp;</span> saved_errno<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">virtual</span> <span class="token keyword">bool</span> <span class="token function">hasPendingSendData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="222-tcpprotocol-实现"><a class="markdownIt-Anchor" href="#222-tcpprotocol-实现"></a> 2.2.2 <code>TcpProtocol</code> 实现</h4><ul><li><strong>底层 I/O</strong>：<code>recv()</code> / <code>send()</code>。</li><li><strong>缓冲管理</strong>：维护 <code>recv_buffer_</code> 用于流式读取，<code>send_buffer_</code> 用于缓存待发数据。</li><li><strong>协议解析</strong>：<code>parseFromBuffer()</code> 根据固定头 (magic + length + checksum) 提取完整包。</li></ul><h4 id="223-threadpool"><a class="markdownIt-Anchor" href="#223-threadpool"></a> 2.2.3 <code>ThreadPool</code></h4><ul><li><strong>线程数量</strong>：可配置，典型为 CPU 核数 * 2。</li><li><strong>队列</strong>：无界或有界队列，防止过载时回压。</li><li><strong>任务类型</strong>：封装 <code>conn_fd</code> 和事件类型，回调 <code>IProtocol</code> 方法。</li></ul><hr /><h2 id="3-当前数据流与事件流程"><a class="markdownIt-Anchor" href="#3-当前数据流与事件流程"></a> 3. 当前数据流与事件流程</h2><ol><li><p><strong>客户端发送</strong></p><ul><li>客户端将 <code>Packet::serialize()</code> 得到的字节流，调用 <code>send()</code> 发往服务器。</li></ul></li><li><p><strong>服务器 Accept</strong></p><ul><li>主线程通过 epoll 捕获 <code>listen_fd</code> 的新连接事件，建立 <code>conn_fd</code> 并注册。</li></ul></li><li><p><strong>数据到达</strong></p><ul><li>客户端数据到达 <code>conn_fd</code>，epoll 触发 <code>EPOLLIN</code>。</li></ul></li><li><p><strong>事件分发</strong></p><ul><li>主线程封装 <code>EventTask(conn_fd, EPOLLIN)</code>，投递到线程池。</li></ul></li><li><p><strong>协议层读取</strong></p><ul><li>Worker 调用 <code>TcpProtocol::tryReceivePacket(pkt)</code>，内部 <code>recv()</code> 数据至 <code>recv_buffer_</code>，并尝试 <code>parseFromBuffer()</code>。</li></ul></li><li><p><strong>Packet 回调</strong></p><ul><li>成功解析后，得到 <code>Packet</code> 对象，交给上层 <code>onPacketReceived(pkt)</code> 处理。</li></ul></li><li><p><strong>响应发送</strong></p><ul><li>如果有回复，调用 <code>Protocol::enqueuePacket()</code>，接着 <code>flushSendBuffer()</code> 写数据，可能触发 <code>EPOLLOUT</code> 事件。</li></ul></li></ol><hr /><h2 id="4-存在的局限与瓶颈"><a class="markdownIt-Anchor" href="#4-存在的局限与瓶颈"></a> 4. 存在的局限与瓶颈</h2><ol><li><strong>单协议支持</strong>：仅限 TCP，不支持无连接或多播协议（UDP）。</li><li><strong>Packet 类型固定</strong>：仅支持一种包格式，无法灵活扩展命令/心跳/文件传输等。</li><li><strong>同步 I/O</strong>：目前基于 <code>recv/send</code>，阻塞或半阻塞模式下吞吐受限。</li><li><strong>扩展困难</strong>：增加新协议或包类型需侵入式修改现有 <code>Protocol</code> 类。</li></ol><hr /><h2 id="5-未来重构方案"><a class="markdownIt-Anchor" href="#5-未来重构方案"></a> 5. 未来重构方案</h2><h3 id="51-多协议支持"><a class="markdownIt-Anchor" href="#51-多协议支持"></a> 5.1 多协议支持</h3><ul><li><strong>策略模式</strong>：定义 <code>IProtocol</code>，实现 <code>TcpProtocol</code>、<code>UdpProtocol</code>、<code>QuicProtocol</code> 等。</li><li><strong>工厂模式</strong>：根据配置或 URI Scheme (<code>tcp://</code>、<code>udp://</code>) 动态创建 <code>IProtocol</code> 实例。</li><li><strong>异步 I/O</strong>：引入 <code>Boost.Asio</code> 或 <code>io_uring</code>，统一封装多协议异步操作。</li></ul><h3 id="52-多包类型"><a class="markdownIt-Anchor" href="#52-多包类型"></a> 5.2 多包类型</h3><ul><li><strong>IPacket 接口</strong>：定义 <code>IPacket</code> 基类，不同业务 <code>VideoPacket</code>、<code>ControlPacket</code>、<code>HeartbeatPacket</code> 继承。</li><li><strong>PacketFactory</strong>：维护 <code>typeId</code>→<code>IPacket</code> 反序列化函数映射，解耦协议与包结构。</li><li><strong>协议层处理</strong>：<code>IProtocol::tryReceivePacket(shared_ptr&lt;IPacket&gt;&amp; pkt)</code>，协议只负责流切包，上层负责反序列化。</li></ul><h3 id="53-架构扩展与优化"><a class="markdownIt-Anchor" href="#53-架构扩展与优化"></a> 5.3 架构扩展与优化</h3><ul><li><strong>多进程 + SO_REUSEPORT</strong>：提升并发连接接入能力，减少锁竞争。</li><li><strong>零拷贝</strong>：结合 <code>splice()</code>, <code>vmsplice()</code> 或 <code>io_uring</code> 实现文件/网络零拷贝。</li><li><strong>负载均衡</strong>：使用 LVS 或 Nginx 前置负载均衡，将流量分发至多实例；</li><li><strong>配置中心</strong>：使用 Consul/Eureka 管理协议版本、端口和包格式。</li></ul><hr /><h2 id="6-结语"><a class="markdownIt-Anchor" href="#6-结语"></a> 6. 结语</h2><p>本报告聚焦<strong>网络协议层面</strong>，从当前 TCP 自定义协议服务器的 Reactor + 线程池架构、数据流程到核心类设计进行了详述，并给出支持多协议、多包类型的重构方案。通过引入设计模式与高性能 I/O，可以构建一套<strong>高可用、可扩展</strong>的通用协议服务器框架。</p>]]></content>
      
      
      <categories>
          
          <category> 开发记录 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> C++ </tag>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>自定义协议栈服务器开发-4</title>
      <link href="/2025/05/26/%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8D%8F%E8%AE%AE%E6%A0%88%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BC%80%E5%8F%91-4/"/>
      <url>/2025/05/26/%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8D%8F%E8%AE%AE%E6%A0%88%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BC%80%E5%8F%91-4/</url>
      
        <content type="html"><![CDATA[<h2 id="一-ioctl通用设备控制接口"><a class="markdownIt-Anchor" href="#一-ioctl通用设备控制接口"></a> 一、<code>ioctl</code>：通用设备控制接口</h2><h3 id="1-什么是-ioctlfd-request-argp"><a class="markdownIt-Anchor" href="#1-什么是-ioctlfd-request-argp"></a> 1. 什么是 <code>ioctl(fd, request, argp)</code>？</h3><ul><li><code>fd</code>：之前用 <code>open()</code> 得到的设备文件描述符（这里是 <code>/dev/video0</code>）。</li><li><code>request</code>：一个数字常量，告诉内核“我要对这个设备做什么操作”。</li><li><code>argp</code>：指向一个结构体或整数的指针，存放或接收额外的参数／返回值。</li></ul><blockquote><p>简单类比：</p><ul><li><code>read(fd, buf, len)</code>：从设备读数据</li><li><code>write(fd, buf, len)</code>：向设备写数据</li><li><code>ioctl(fd, XXX, &amp;y)</code>：向设备发送“指令”XXX，可能携带或返回数据y</li></ul></blockquote><h3 id="2-v4l2-常用的几个-ioctl-请求request"><a class="markdownIt-Anchor" href="#2-v4l2-常用的几个-ioctl-请求request"></a> 2. V4L2 常用的几个 <code>ioctl</code> 请求（request）</h3><table><thead><tr><th>请求宏</th><th>作用</th></tr></thead><tbody><tr><td><code>VIDIOC_REQBUFS</code></td><td>“请为我申请 N 个缓冲区”（参数是 <code>v4l2_requestbuffers</code>）</td></tr><tr><td><code>VIDIOC_QUERYBUF</code></td><td>“告诉我第 i 个缓冲区的大小和在内核空间的偏移量”（参数是 <code>v4l2_buffer</code>）</td></tr><tr><td><code>VIDIOC_QBUF</code></td><td>“把编号为 i 的空缓冲区放入内核的采集队列”，让驱动往里写新帧</td></tr><tr><td><code>VIDIOC_DQBUF</code></td><td>“从内核队列里取出一个已写满帧的缓冲区”，交给用户进程处理</td></tr><tr><td><code>VIDIOC_STREAMON</code></td><td>“启动流模式”，开始不停往缓冲区写入帧</td></tr><tr><td><code>VIDIOC_STREAMOFF</code></td><td>“停止流模式”，停止往缓冲区写帧</td></tr></tbody></table><ul><li><strong><code>VIDIOC_REQBUFS</code></strong>：告诉驱动“我想用 mmap 模式，一次准备读取 4 帧数据，快给我分配 4 块内核缓冲区”。</li><li><strong><code>VIDIOC_QUERYBUF</code></strong>：对每块缓冲区执行此命令后，<code>v4l2_buffer</code> 结构体会告诉你：<ul><li><code>length</code>：这块缓存的字节大小</li><li><code>m.offset</code>：这块缓存相对于设备文件起始处的偏移量</li></ul></li><li><strong><code>VIDIOC_QBUF</code></strong>：把一块空的、已经 <code>QUERYBUF</code> 过的缓存放到“待写入”队列里。驱动拿到后会往里写下一帧。</li><li><strong><code>VIDIOC_STREAMON</code> / <code>STREAMOFF</code></strong>：启动或停止“流”模式，让驱动开始/停止循环地往这些队列缓存里写入／停止写入帧。</li><li><strong><code>VIDIOC_DQBUF</code></strong>：从“已写入”队列里取出一个缓存，告诉你它是哪块（<code>buf.index</code>），以及写入了多少字节（<code>buf.bytesused</code>），用户层就能处理这帧数据。</li></ul><h2 id="二-mmap内存映射让用户进程直接访问缓冲区"><a class="markdownIt-Anchor" href="#二-mmap内存映射让用户进程直接访问缓冲区"></a> 二、<code>mmap</code>：内存映射，让用户进程直接访问缓冲区</h2><h3 id="1-为什么要用-mmap-而不是-read"><a class="markdownIt-Anchor" href="#1-为什么要用-mmap-而不是-read"></a> 1. 为什么要用 <code>mmap</code> 而不是 <code>read</code>？</h3><ul><li><strong><code>read()</code></strong>：每次都得内核→用户空间拷贝一次，效率较低。</li><li><strong><code>mmap()</code></strong>：把内核分配的那块物理内存“映射”到用户进程地址空间，同一块内存，内核和用户共用一份，不用额外拷贝，速度更快。</li></ul><h3 id="2-mmap-怎么用"><a class="markdownIt-Anchor" href="#2-mmap-怎么用"></a> 2. <code>mmap</code> 怎么用？</h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">void</span><span class="token operator">*</span> addr <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span>    <span class="token keyword">nullptr</span><span class="token punctuation">,</span>       <span class="token comment">// 让系统自动选择一个合适的起始地址</span>    length<span class="token punctuation">,</span>        <span class="token comment">// 映射大小（字节数）</span>    PROT_READ      <span class="token comment">// 用户进程可读</span>    <span class="token operator">|</span> PROT_WRITE<span class="token punctuation">,</span>  <span class="token comment">// 用户进程可写（对 MMAP 这种设备来说一般写入无用，但必须有）</span>    MAP_SHARED<span class="token punctuation">,</span>    <span class="token comment">// 多个进程（内核/用户）共享这块映射，写到它会通知内核</span>    fd<span class="token punctuation">,</span>            <span class="token comment">// 哪个文件或设备</span>    offset         <span class="token comment">// 从文件(设备)的哪个偏移量开始映射</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><strong><code>length</code></strong>：我们之前用 <code>VIDIOC_QUERYBUF</code> 得到过，它告诉这个缓冲区有多大。</li><li><strong><code>offset</code></strong>：同样来自 <code>VIDIOC_QUERYBUF</code>，表示内核里这块缓冲区相对于设备文件开始的位置。</li><li>返回值 <code>addr</code>：之后你就可以像读普通内存一样读 <code>addr[0]</code>、<code>addr[1]</code>…，读到的就是摄像头给你写的帧数据。</li></ul><h3 id="3-映射后你需要做两件事"><a class="markdownIt-Anchor" href="#3-映射后你需要做两件事"></a> 3. 映射后，你需要做两件事：</h3><ol><li><strong>入队</strong>（<code>VIDIOC_QBUF</code>）——让驱动知道“这块内存我准备好了，快写新帧进来”。</li><li><strong>取队</strong>（<code>VIDIOC_DQBUF</code>）——告诉驱动“我处理完了，把写好的帧拿给我”，此时 <code>buf.index</code> 告诉你是哪块，<code>bytesused</code> 告诉你写了多少字节，你就用 <code>mmap</code> 返回的指针去拷贝或解码。</li></ol><p>最终，<strong>零拷贝</strong>、高并发地完成了“生产（驱动写帧）—消费（用户进程读帧）”的循环。</p>]]></content>
      
      
      <categories>
          
          <category> 开发记录 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> C++ </tag>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>自定义协议栈服务器开发-3</title>
      <link href="/2025/05/26/%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8D%8F%E8%AE%AE%E6%A0%88%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BC%80%E5%8F%91-3/"/>
      <url>/2025/05/26/%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8D%8F%E8%AE%AE%E6%A0%88%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BC%80%E5%8F%91-3/</url>
      
        <content type="html"><![CDATA[<h2 id="代码流程一步步来看"><a class="markdownIt-Anchor" href="#代码流程一步步来看"></a> 🧩 代码流程一步步来看：</h2><h3 id="1-启动服务器maincpp"><a class="markdownIt-Anchor" href="#1-启动服务器maincpp"></a> 1. 启动服务器（<code>main.cpp</code>）：</h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    Server <span class="token function">server</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    server<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-初始化监听-socketserversetupserversocket"><a class="markdownIt-Anchor" href="#2-初始化监听-socketserversetupserversocket"></a> 2. 初始化监听 socket（<code>Server::setupServerSocket</code>）：</h3><ul><li>创建 socket</li><li>绑定端口</li><li>设置非阻塞</li><li>开始监听</li></ul><h3 id="3-epoll-注册监听-socket"><a class="markdownIt-Anchor" href="#3-epoll-注册监听-socket"></a> 3. epoll 注册监听 socket：</h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epoll_fd<span class="token punctuation">,</span> EPOLL_CTL_ADD<span class="token punctuation">,</span> listen_fd<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>告诉 epoll：“有新连接来了请通知我。”</p><hr /><h3 id="4-主循环serverrun"><a class="markdownIt-Anchor" href="#4-主循环serverrun"></a> 4. 主循环（<code>Server::run()</code>）：</h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">epoll_wait</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 阻塞等待事件</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>事件 in events<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>事件来自 listen_fd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 接受新连接，并注册到 epoll</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            <span class="token comment">// 有客户端发消息，调用 Connection::onReadable()</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr /><h3 id="5-每个连接怎么处理connection"><a class="markdownIt-Anchor" href="#5-每个连接怎么处理connection"></a> 5. 每个连接怎么处理（<code>Connection</code>）：</h3><ul><li><code>onReadable()</code> 从 socket 读取数据</li><li>把数据丢到线程池处理（比如解析、计算、构造回复）</li><li>线程池的线程处理后调用回调函数发送响应</li></ul><hr /><h3 id="6-线程池作用"><a class="markdownIt-Anchor" href="#6-线程池作用"></a> 6. 线程池作用：</h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">thread_pool<span class="token operator">-></span><span class="token function">enqueue</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">=</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 处理业务逻辑</span>    <span class="token function">send</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token string">"Hello"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>这样就不会卡住主线程，能并发处理很多连接。</p><hr /><h2 id="总结一句话解释整个流程"><a class="markdownIt-Anchor" href="#总结一句话解释整个流程"></a> 💡 总结：一句话解释整个流程</h2><blockquote><p><strong>主线程只管 epoll + 分发，线程池负责干活（处理数据并回复），所有 socket 都是非阻塞的。</strong></p></blockquote><pre><code>             [客户端1]                |             [客户端2]                |             [客户端3]                |               ...                |             [客户端N]                |    ╔════════════════╗    ║          内核 (TCP/IP栈)    ║    ║                             ║    ║  listen_fd (监听 socket)    ║◄─── bind(), listen()    ║          │                 ║    ║          │连接到达时        ║    ║          ▼                 ║    ║  conn_fd1 (连接 socket) ◄───── 客户端1接入    ║  conn_fd2 (连接 socket) ◄───── 客户端2接入    ║  conn_fd3 (连接 socket) ◄───── 客户端3接入    ║        ...                  ║    ╚════════════════╝                │           [epoll 监听多个 conn_fd]                │        [线程池处理业务逻辑]</code></pre><h2 id="一步步解释结构组成"><a class="markdownIt-Anchor" href="#一步步解释结构组成"></a> 🔍 一步步解释结构组成：</h2><h3 id="1-listen_fd监听-socket"><a class="markdownIt-Anchor" href="#1-listen_fd监听-socket"></a> 1. <code>listen_fd</code>：监听 socket</h3><ul><li>你用 <code>socket()</code>, <code>bind()</code>, <code>listen()</code> 创建的最初的 socket。</li><li>只负责监听端口是否有新的连接进来。</li><li>当有客户端来连接，就会触发 <code>epoll</code> 事件，你再用 <code>accept()</code> 把连接拿出来。</li></ul><h3 id="2-conn_fd已连接-socket"><a class="markdownIt-Anchor" href="#2-conn_fd已连接-socket"></a> 2. <code>conn_fd</code>：已连接 socket</h3><ul><li>每次 <code>accept()</code> 返回一个新的 socket，这就是你和客户端之间通信的 socket。</li><li>每个客户端一个连接，<strong>一个 fd</strong>。</li><li>你用 <code>read()/write()</code> 或 <code>recv()/send()</code> 来与该客户端进行数据交换。</li></ul><h3 id="3-epoll-监听这些连接-fd"><a class="markdownIt-Anchor" href="#3-epoll-监听这些连接-fd"></a> 3. <code>epoll</code> 监听这些连接 fd</h3><ul><li><code>epoll</code> 用来监听 <code>conn_fd1</code>, <code>conn_fd2</code>, …, 发生事件（如可读/可写）。</li><li>一旦某个 fd 有数据，epoll 告诉你，然后你就用线程池去处理。</li></ul><h3 id="4-线程池做处理不阻塞主线程"><a class="markdownIt-Anchor" href="#4-线程池做处理不阻塞主线程"></a> 4. 线程池做处理，不阻塞主线程</h3><ul><li>主线程只负责接收连接、触发 epoll。</li><li>每当有数据到达，就把这个事件扔进线程池处理。</li></ul><h2 id="为什么这种设计适合高并发"><a class="markdownIt-Anchor" href="#为什么这种设计适合高并发"></a> ✅ 为什么这种设计适合高并发？</h2><table><thead><tr><th>优势</th><th>说明</th></tr></thead><tbody><tr><td>高性能 epoll</td><td>支持百万连接，O(1) 的事件通知</td></tr><tr><td>每个客户端独立 fd</td><td>无共享，不影响彼此</td></tr><tr><td>非阻塞 IO</td><td>不卡线程</td></tr><tr><td>线程池</td><td>避免线程爆炸，任务处理更平滑</td></tr><tr><td>可扩展性强</td><td>后期可加入定时器、连接池、协程等机制</td></tr></tbody></table><h2 id="举个更直观的例子"><a class="markdownIt-Anchor" href="#举个更直观的例子"></a> 🛠 举个更直观的例子：</h2><p>假设你写了一个 Web 服务器监听 8080：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> listen_fd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">bind</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">listen</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">,</span> SOMAXCONN<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>你用 epoll 监听这个 <code>listen_fd</code>，发现有连接来：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> conn_fd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 得到客户端 socket</span><span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epfd<span class="token punctuation">,</span> EPOLL_CTL_ADD<span class="token punctuation">,</span> conn_fd<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 加入 epoll 监听</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>从现在开始，<code>conn_fd</code> 就是你跟某个客户端通信的通道，你用 <code>read(conn_fd, buf, len)</code> 来收消息，用 <code>write(conn_fd, buf, len)</code> 发消息。</p><p>当你有成千上万个连接时，你 epoll 管理的 fd 列表就像：</p><pre class="line-numbers language-none"><code class="language-none">epoll 监听：- conn_fd1- conn_fd2- conn_fd3- ...- conn_fd9999<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>而且所有连接共用同一个 epoll 和线程池，不需要开成千个线程。</p><hr /><h2 id="总结一句话"><a class="markdownIt-Anchor" href="#总结一句话"></a> 📌 总结一句话：</h2><blockquote><p><strong>服务器本身只有一个监听 socket（listen_fd），但每个客户端连接都会创建一个独立的通信 socket（conn_fd），由 epoll 来统一管理这些 fd 的事件，并用线程池异步处理它们。</strong></p></blockquote><h3 id="重构方案概览"><a class="markdownIt-Anchor" href="#重构方案概览"></a> <strong>重构方案概览</strong></h3><table><thead><tr><th style="text-align:center">模块</th><th style="text-align:center">原问题</th><th style="text-align:center">重构方法</th><th style="text-align:center">代码示例</th><th style="text-align:center">不改的坏处</th><th style="text-align:center">改动的好处</th></tr></thead><tbody><tr><td style="text-align:center"><strong>协议层</strong></td><td style="text-align:center">无发送缓冲区导致数据丢失</td><td style="text-align:center">拆分<code>send_packet</code>为数据入队和实际发送</td><td style="text-align:center"><code>enqueuePacket()</code> + <code>flushSendBuffer()</code></td><td style="text-align:center">数据可能丢失</td><td style="text-align:center">支持部分发送和重试机制</td></tr><tr><td style="text-align:center"><strong>协议层</strong></td><td style="text-align:center">无接收缓冲区导致粘包处理错误</td><td style="text-align:center">引入接收缓冲区</td><td style="text-align:center"><code>tryReceivePacket()</code></td><td style="text-align:center">数据解析失败</td><td style="text-align:center">正确处理TCP流式数据</td></tr><tr><td style="text-align:center"><strong>连接层</strong></td><td style="text-align:center">直接操作裸指针导致线程竞争</td><td style="text-align:center">使用智能指针+互斥锁</td><td style="text-align:center"><code>std::shared_ptr&lt;Connection&gt;</code></td><td style="text-align:center">数据竞争导致崩溃</td><td style="text-align:center">线程安全读写</td></tr><tr><td style="text-align:center"><strong>事件循环</strong></td><td style="text-align:center">递归调用<code>handleWrite</code></td><td style="text-align:center">通过<code>EPOLLOUT</code>事件触发发送</td><td style="text-align:center"><code>triggerWriteEvent()</code></td><td style="text-align:center">栈溢出风险</td><td style="text-align:center">解耦读写逻辑</td></tr><tr><td style="text-align:center"><strong>资源管理</strong></td><td style="text-align:center">手动关闭socket易遗漏</td><td style="text-align:center">RAII包装文件描述符</td><td style="text-align:center"><code>ScopedFileDescriptor</code></td><td style="text-align:center">资源泄漏</td><td style="text-align:center">自动释放资源</td></tr></tbody></table><h4 id="阻塞模式-vs-非阻塞模式的核心区别"><a class="markdownIt-Anchor" href="#阻塞模式-vs-非阻塞模式的核心区别"></a> <strong>阻塞模式 vs 非阻塞模式的核心区别</strong></h4><table><thead><tr><th style="text-align:center"><strong>特征</strong></th><th style="text-align:center"><strong>阻塞模式</strong></th><th style="text-align:center"><strong>非阻塞模式</strong></th></tr></thead><tbody><tr><td style="text-align:center"><strong>read/write 行为</strong></td><td style="text-align:center">操作未完成时线程挂起，直到数据就绪或超时</td><td style="text-align:center">操作立即返回，若数据未就绪返回错误码（<code>EAGAIN</code> 或 <code>EWOULDBLOCK</code>）</td></tr><tr><td style="text-align:center"><strong>适用场景</strong></td><td style="text-align:center">简单客户端、低并发服务端</td><td style="text-align:center">高并发服务端（如 Nginx、Redis）</td></tr><tr><td style="text-align:center"><strong>资源占用</strong></td><td style="text-align:center">每个连接需独占线程，线程数随连接数线性增长</td><td style="text-align:center">单线程可处理数千连接（通过事件驱动）</td></tr></tbody></table><h3 id="阻塞-vs-非阻塞模式的核心区别"><a class="markdownIt-Anchor" href="#阻塞-vs-非阻塞模式的核心区别"></a> <strong>阻塞 vs 非阻塞模式的核心区别</strong></h3><table><thead><tr><th style="text-align:center"><strong>socket 模式</strong></th><th style="text-align:center"><strong><code>read</code> 行为</strong></th><th style="text-align:center"><strong>代码表现</strong></th></tr></thead><tbody><tr><td style="text-align:center"><strong>阻塞模式</strong></td><td style="text-align:center">若内核缓冲区无数据，<code>read</code> <strong>挂起线程</strong>，直到数据到达或超时。</td><td style="text-align:center">线程卡在 <code>read</code> 处，无法处理其他任务。</td></tr><tr><td style="text-align:center"><strong>非阻塞模式</strong></td><td style="text-align:center">若内核缓冲区无数据，<code>read</code> <strong>立即返回错误</strong>，设置 <code>errno</code> 为 <code>EAGAIN</code> 或 <code>EWOULDBLOCK</code>。</td><td style="text-align:center">线程继续执行，需检查 <code>errno</code> 并重试。</td></tr></tbody></table><h3 id="为何必须使用接收缓冲区"><a class="markdownIt-Anchor" href="#为何必须使用接收缓冲区"></a> <strong>为何必须使用接收缓冲区？</strong></h3><h4 id="tcp-协议的核心特性"><a class="markdownIt-Anchor" href="#tcp-协议的核心特性"></a> <strong>TCP 协议的核心特性</strong></h4><ul><li><strong>流式协议</strong>：无消息边界，数据像水流一样连续。</li><li><strong>可能分片</strong>：一个应用层数据包可能被拆分为多个TCP段发送。</li></ul><h4 id="示例粘包与半包"><a class="markdownIt-Anchor" href="#示例粘包与半包"></a> <strong>示例：粘包与半包</strong></h4><pre class="line-numbers language-none"><code class="language-none">客户端发送： [Packet1][Packet2]服务端接收： [Pa][cket1Packet2][...] （分多次到达）<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li><strong>无缓冲区</strong>：无法正确识别 <code>Packet1</code> 和 <code>Packet2</code> 的边界。</li><li><strong>有缓冲区</strong>：积累数据，直到能提取完整包。</li></ul>]]></content>
      
      
      <categories>
          
          <category> 开发记录 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> C++ </tag>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>自定义协议栈服务器开发-2</title>
      <link href="/2025/05/26/%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8D%8F%E8%AE%AE%E6%A0%88%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BC%80%E5%8F%91-2/"/>
      <url>/2025/05/26/%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8D%8F%E8%AE%AE%E6%A0%88%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BC%80%E5%8F%91-2/</url>
      
        <content type="html"><![CDATA[<h2 id="自定义协议栈服务器开发-2"><a class="markdownIt-Anchor" href="#自定义协议栈服务器开发-2"></a> 自定义协议栈服务器开发-2</h2><h2 id="目标改造为高性能通信架构"><a class="markdownIt-Anchor" href="#目标改造为高性能通信架构"></a> 🎯 目标：改造为高性能通信架构</h2><p>原始架构是：</p><ul><li>🚫 阻塞 I/O（<code>recv/send</code> 会卡住）</li><li>🚫 单线程处理（一个客户端连接就卡住一个线程）</li><li>🚫 同步爬虫、同步协议处理</li></ul><p>目标：</p><p>✅ <strong>非阻塞 I/O</strong><br />✅ <strong>Reactor 模式（epoll）监听连接和可读事件</strong><br />✅ <strong>线程池处理业务逻辑</strong>（如协议解析、爬虫）<br />✅ <strong>主线程永远不阻塞，不做耗时操作</strong></p><h3 id="阻塞的地方在哪"><a class="markdownIt-Anchor" href="#阻塞的地方在哪"></a> ✅ <strong>阻塞的地方在哪？</strong></h3><ol><li><strong>客户端（Client）：</strong><ul><li><code>connect(sock_fd, ...)</code>：会<strong>阻塞</strong>直到连接成功或失败。</li><li><code>recv(...)</code> 或 <code>proto.receive_packet(...)</code>：在没有数据可读时<strong>会阻塞</strong>，直到服务器发送了数据或连接断开。</li><li><code>std::getline(std::cin, input)</code>：会阻塞等待用户输入。</li></ul></li><li><strong>服务器（Server）：</strong><ul><li><code>accept(server_fd, ...)</code>：<strong>阻塞等待客户端连接</strong>，直到某个客户端连接成功才返回。</li><li><code>recv(...)</code> 或 <code>proto.receive_packet(...)</code>：<strong>阻塞</strong>，直到有数据到来，或者客户端断开连接。</li><li><code>send(...)</code> 或 <code>proto.send_packet(...)</code>：在某些情况下（例如发送缓冲区满），也可能<strong>阻塞</strong>。</li></ul></li></ol><p>项目结构</p><pre class="line-numbers language-none"><code class="language-none">project_root&#x2F;├── include&#x2F;│   ├── core&#x2F;               ← 数据结构、协议类（Packet.hpp）│   ├── net&#x2F;                ← 网络通信（Connection.hpp）│   ├── threading&#x2F;          ← 线程池（ThreadPool.hpp）│   ├── vision&#x2F;             ← 图像处理（OpenCV 封装类）│   └── app&#x2F;                ← 主应用接口（ServerApp.hpp）│├── src&#x2F;│   ├── core&#x2F;               ← Packet.cpp、Protocol.cpp│   ├── net&#x2F;                ← Connection.cpp、ReactorServer.cpp、Client.cpp│   ├── threading&#x2F;          ← ThreadPool.cpp│   ├── vision&#x2F;             ← Crawler.cpp（如果做图像处理）、未来的OpenCV功能│   └── app&#x2F;                ← Server.cpp、App类封装│├── main&#x2F;│   └── main.cpp            ← 仅程序启动入口（含 main 函数）│├── lib&#x2F;                    ← 用于保存构建输出的 .so&#x2F;.a 文件├── build&#x2F;                  ← CMake 构建输出（加入 .gitignore）├── tests&#x2F;                  ← GTest 单元测试│   ├── PacketTest.cpp│   └── CMakeLists.txt│├── third_party&#x2F;            ← OpenCV&#x2F;GTest 等第三方库├── CMakeLists.txt          ← 项目主构建入口├── run.sh                  ← 编译 + 运行脚本└── README.md<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="整体目标写一个高性能服务器"><a class="markdownIt-Anchor" href="#整体目标写一个高性能服务器"></a> 🚀 整体目标：写一个<strong>高性能服务器</strong></h2><p>我们要实现一个这样的服务器：</p><ul><li>能同时处理很多客户端连接（比如上千个）。</li><li>每个客户端都可以发消息，服务器处理完后回消息。</li><li>不能阻塞 —— 有一个慢的客户端不应该卡住整个服务器。</li><li>要<strong>充分利用多核 CPU</strong>，用线程池处理逻辑。</li></ul><hr /><h2 id="核心概念一为什么不用传统方式"><a class="markdownIt-Anchor" href="#核心概念一为什么不用传统方式"></a> 🧠 核心概念一：为什么不用传统方式？</h2><p>传统的 <code>accept-read-write</code> 方式大致像这样：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> client_fd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>listen_fd<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token function">read</span><span class="token punctuation">(</span>client_fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">write</span><span class="token punctuation">(</span>client_fd<span class="token punctuation">,</span> response<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="问题"><a class="markdownIt-Anchor" href="#问题"></a> 问题：</h3><ul><li><code>accept</code> 和 <code>read</code> 是阻塞的：如果一个客户端连接了但不发消息，服务器就一直卡住。</li><li>无法同时处理多个客户端（除非开线程/进程，很慢）。</li></ul><hr /><h2 id="核心概念二epoll-是什么"><a class="markdownIt-Anchor" href="#核心概念二epoll-是什么"></a> 🧠 核心概念二：epoll 是什么？</h2><p><code>epoll</code> 是 Linux 下的一个<strong>事件通知机制</strong>，用于同时管理多个文件描述符（比如 socket）。它就像一个“电铃监控中心”，告诉你：</p><blockquote><p>“嘿，哪个 socket 上有人发消息了，你可以去处理了。”</p></blockquote><p>这样，你不用一直 <code>read()</code> 检查每个 socket，而是等着 epoll 通知你哪个客户端“响铃”了（即有事件，比如可读）。</p><h3 id="epoll-流程"><a class="markdownIt-Anchor" href="#epoll-流程"></a> epoll 流程：</h3><ol><li>把监听 socket（listen_fd）和客户端 socket 注册到 epoll。</li><li>等待 <code>epoll_wait()</code> 通知哪个 socket 有事件。</li><li>读取/处理这些事件。</li><li>再回到 <code>epoll_wait()</code>。</li></ol><hr /><h2 id="核心概念三为什么用线程池"><a class="markdownIt-Anchor" href="#核心概念三为什么用线程池"></a> 🧠 核心概念三：为什么用线程池？</h2><ul><li>epoll 是<strong>IO多路复用</strong>，能告诉你“哪个 socket 有消息了”。</li><li>但业务逻辑可能很复杂，不能在主线程里直接处理。</li><li>所以用一个线程池，让多个线程处理“读到的数据”。</li></ul><hr /><h2 id="每个组件的作用"><a class="markdownIt-Anchor" href="#每个组件的作用"></a> 🧱 每个组件的作用：</h2><table><thead><tr><th>文件</th><th>作用</th></tr></thead><tbody><tr><td><code>main.cpp</code></td><td>启动服务器</td></tr><tr><td><code>Server.h/cpp</code></td><td>服务器主逻辑（epoll 注册/等待/事件分发）</td></tr><tr><td><code>Connection.h/cpp</code></td><td>表示一个客户端连接，读取数据后扔到线程池</td></tr><tr><td><code>ThreadPool.h/cpp</code></td><td>多线程任务池，负责处理耗时逻辑</td></tr><tr><td><code>Util.h/cpp</code></td><td>工具函数，比如设置非阻塞</td></tr></tbody></table><hr />]]></content>
      
      
      <categories>
          
          <category> 开发记录 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> C++ </tag>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>自定义协议栈服务器开发-1</title>
      <link href="/2025/05/26/%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8D%8F%E8%AE%AE%E6%A0%88%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BC%80%E5%8F%91-1/"/>
      <url>/2025/05/26/%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8D%8F%E8%AE%AE%E6%A0%88%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BC%80%E5%8F%91-1/</url>
      
        <content type="html"><![CDATA[<h2 id="自定义协议栈服务器开发-1"><a class="markdownIt-Anchor" href="#自定义协议栈服务器开发-1"></a> 自定义协议栈服务器开发-1</h2><table><thead><tr><th>文件名</th><th>作用描述</th></tr></thead><tbody><tr><td><code>Packet.hpp/.cpp</code></td><td>定义数据包结构，序列化和反序列化函数</td></tr><tr><td><code>Protocol.hpp/.cpp</code></td><td>网络通信的封装（send/recv）</td></tr><tr><td><code>Server.cpp</code></td><td>TCP服务端，接收客户端消息并回复</td></tr><tr><td><code>Client.cpp</code></td><td>TCP客户端，发送消息并读取服务器回应</td></tr></tbody></table><p>大厂级高性能 TCP 服务端架构思路及示例代码片段，基于 <strong>Reactor 模式 + epoll + 线程池</strong>，把网络 I/O 和业务处理彻底拆开，保证主线程专注于 I/O，所有耗时业务（如爬虫、协议解析）都扔给工作线程去做。</p><h3 id="1-单线程-非阻塞-io"><a class="markdownIt-Anchor" href="#1-单线程-非阻塞-io"></a> ✅ 1. 单线程 + 非阻塞 I/O</h3><p>传统的服务端模型（例如阻塞式 <code>accept-read-write</code>）每个客户端都需要一个线程。假设每个线程消耗 1MB 栈空间，1万连接就需要 10GB 内存，而且线程调度开销极大。</p><p>非阻塞 I/O + epoll 只需要<strong>一个主线程</strong>就可以<strong>同时管理上万连接</strong>。它不会因为某个连接的数据没准备好而阻塞。</p><h3 id="2-epoll-是-o1-的-io-多路复用"><a class="markdownIt-Anchor" href="#2-epoll-是-o1-的-io-多路复用"></a> ✅ 2. epoll 是 O(1) 的 I/O 多路复用</h3><ul><li><code>select</code>/<code>poll</code> 每次都要遍历所有 fd，时间复杂度 O(n)。</li><li><code>epoll</code> 只返回<strong>就绪的文件描述符列表</strong>，时间复杂度接近 O(1)。</li></ul><p>所以 <code>epoll</code> 对大并发连接场景特别高效。</p><h3 id="3-边沿触发edge-triggered减少系统调用"><a class="markdownIt-Anchor" href="#3-边沿触发edge-triggered减少系统调用"></a> ✅ 3. 边沿触发（Edge Triggered）减少系统调用</h3><p>epoll 支持两种模式：</p><ul><li>Level Trigger（水平触发）：数据没读完会一直通知。</li><li><strong>Edge Trigger（边沿触发）</strong>：只在状态变化时通知一次，需要把 buffer 一次读干净。</li></ul><p>这显著减少了 <code>epoll_wait()</code> 的返回次数，降低系统调用频率。</p><h3 id="4-主线程不做业务线程池异步执行逻辑"><a class="markdownIt-Anchor" href="#4-主线程不做业务线程池异步执行逻辑"></a> ✅ 4. 主线程不做业务，线程池异步执行逻辑</h3><p>主线程只管网络事件，不涉及业务计算（如爬虫、数据库等耗时任务），这样它能持续保持高响应性。</p><p>业务线程通过线程池统一调度，充分利用多核 CPU 的并发能力，避免线程频繁创建/销毁的性能浪费。</p><h3 id="5-内存复用和缓冲池可拓展优化"><a class="markdownIt-Anchor" href="#5-内存复用和缓冲池可拓展优化"></a> ✅ 5. 内存复用和缓冲池（可拓展优化）</h3><ul><li>不频繁 new/delete → 对象池（Object Pool）</li><li>避免多线程 malloc/free 抢锁 → Arena 分配器</li><li>提前准备 buffer，提高 cache 命中率</li></ul><h3 id="6-异步写回避免阻塞"><a class="markdownIt-Anchor" href="#6-异步写回避免阻塞"></a> ✅ 6. 异步写回避免阻塞</h3><p>如果你直接在主线程或业务线程里 <code>write()</code> 客户端，可能因为客户端读太慢导致阻塞（内核 send buffer 满）。</p><p>我们这里的做法：</p><ul><li>把写数据加入一个 <code>outbuf</code> 中</li><li>主线程监听 EPOLLOUT 时间再去写</li><li>一次写不完就下次继续</li></ul><p>这样即使写出慢，也不会阻塞主线程或业务线程。</p><h3 id="7-高可扩展性"><a class="markdownIt-Anchor" href="#7-高可扩展性"></a> ✅ 7. 高可扩展性</h3><p>你可以非常轻松地做出扩展：</p><ul><li>✅ 加缓存（如 LRU）</li><li>✅ 加限流（如令牌桶）</li><li>✅ 加负载均衡（Nginx 前置）</li><li>✅ 微服务化部署（爬虫、数据分析、识别模块独立服务）</li></ul><h2 id="总结架构优势一图看懂"><a class="markdownIt-Anchor" href="#总结架构优势一图看懂"></a> 🔧 总结架构优势（一图看懂）</h2><table><thead><tr><th>模块</th><th>技术方案</th><th>好处</th></tr></thead><tbody><tr><td>I/O 多路复用</td><td>epoll + 非阻塞 I/O</td><td>管理上万连接，高性能低开销</td></tr><tr><td>事件处理</td><td>Reactor 模式</td><td>解耦 I/O 与业务，低延迟响应</td></tr><tr><td>并发处理</td><td>线程池</td><td>高并发、稳定、可复用线程资源</td></tr><tr><td>写回机制</td><td>异步写 + 缓冲区</td><td>不阻塞 I/O，不影响主线程性能</td></tr><tr><td>扩展性</td><td>模块化、插件化</td><td>支持微服务、可水平扩展</td></tr></tbody></table><h2 id="现代大厂使用案例对比"><a class="markdownIt-Anchor" href="#现代大厂使用案例对比"></a> 💬 现代大厂使用案例对比</h2><table><thead><tr><th>大厂</th><th>使用模式</th><th>对应点</th></tr></thead><tbody><tr><td>Nginx</td><td>epoll + 非阻塞 + 事件驱动</td><td>完整的 Reactor 模式</td></tr><tr><td>Redis</td><td>单线程 + epoll</td><td>利用 epoll 高效调度请求</td></tr><tr><td>Netty</td><td>Reactor + 线程池 + 编解码器</td><td>和我们这套结构非常相似</td></tr><tr><td>MySQL Proxy</td><td>主线程监听连接 + worker 处理查询</td><td>主从分离的 I/O 与业务处理思想</td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> 开发记录 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> C++ </tag>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>每日知识点导航</title>
      <link href="/2025/05/26/%E6%AF%8F%E6%97%A5Linux-Cpp%E5%AF%BC%E8%88%AA/"/>
      <url>/2025/05/26/%E6%AF%8F%E6%97%A5Linux-Cpp%E5%AF%BC%E8%88%AA/</url>
      
        <content type="html"><![CDATA[<h2 id="每日知识点导航"><a class="markdownIt-Anchor" href="#每日知识点导航"></a> 每日知识点导航</h2><hr /><ol><li><a href="/2025/05/21/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-1/" title="每日知识点-1">每日知识点-1</a></li><li><a href="/2025/05/22/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-2/" title="每日知识点-2">每日知识点-2</a></li><li><a href="/2025/05/23/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-3/" title="每日知识点-3">每日知识点-3</a></li><li><a href="/2025/05/26/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-4/" title="每日知识点-4">每日知识点-4</a></li><li><a href="/2025/05/27/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-5/" title="每日知识点-5">每日知识点-5</a></li><li><a href="/2025/05/28/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-6/" title="每日知识点-6">每日知识点-6</a></li><li><a href="/2025/06/03/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-7/" title="每日知识点-7">每日知识点-7</a></li><li><a href="/2025/06/04/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-8/" title="每日知识点-8">每日知识点-8</a></li><li><a href="/2025/06/05/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-9/" title="每日知识点-9">每日知识点-9</a></li><li><a href="/2025/06/06/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-10/" title="每日知识点-10">每日知识点-10</a></li><li><a href="/2025/06/10/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-11/" title="每日知识点-11">每日知识点-11</a></li><li><a href="/2025/06/11/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-12/" title="每日知识点-12">每日知识点-12</a></li><li><a href="/2025/06/12/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-13/" title="每日知识点-13">每日知识点-13</a></li><li><a href="/2025/06/14/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-14/" title="每日知识点-14">每日知识点-14</a></li><li><a href="/2025/06/15/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-15/" title="每日知识点-15">每日知识点-15</a></li><li><a href="/2025/06/16/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-16/" title="每日知识点-16">每日知识点-16</a></li><li><a href="/2025/06/17/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-17/" title="每日知识点-17">每日知识点-17</a></li><li><a href="/2025/06/18/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-18/" title="每日知识点-18">每日知识点-18</a></li><li><a href="/2025/06/19/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-19/" title="每日知识点-19">每日知识点-19</a></li><li><a href="/2025/06/20/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-20/" title="每日知识点-20">每日知识点-20</a></li><li><a href="/2025/06/23/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-21/" title="每日知识点-21">每日知识点-21</a></li><li><a href="/2025/06/24/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-22/" title="每日知识点-22">每日知识点-22</a></li><li><a href="/2025/06/25/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-23/" title="每日知识点-23">每日知识点-23</a></li><li><a href="/2025/06/26/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-24/" title="每日知识点-24">每日知识点-24</a></li><li><a href="/2025/06/27/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-25/" title="每日知识点-25">每日知识点-25</a></li><li><a href="/2025/06/30/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-26/" title="每日知识点-26">每日知识点-26</a></li><li><a href="/2025/07/01/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-27/" title="每日知识点-27">每日知识点-27</a></li><li><a href="/2025/07/02/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-28/" title="每日知识点-28">每日知识点-28</a></li><li><a href="/2025/07/03/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-29/" title="每日知识点-29">每日知识点-29</a></li><li><a href="/2025/07/04/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-30/" title="每日知识点-30">每日知识点-30</a></li><li><a href="/2025/07/07/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-31/" title="每日知识点-31">每日知识点-31</a></li><li><a href="/2025/07/08/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-32/" title="每日知识点-32">每日知识点-32</a></li><li><a href="/2025/07/09/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-33/" title="每日知识点-33">每日知识点-33</a></li><li><a href="/2025/07/10/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-34/" title="每日知识点-34">每日知识点-34</a></li></ol>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> C++ </tag>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>每日知识点-4</title>
      <link href="/2025/05/26/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-4/"/>
      <url>/2025/05/26/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-4/</url>
      
        <content type="html"><![CDATA[<h2 id="每日知识点-4"><a class="markdownIt-Anchor" href="#每日知识点-4"></a> 每日知识点-4</h2><hr /><h3 id="1-虚函数表vtable的实现原理及多态性能损耗"><a class="markdownIt-Anchor" href="#1-虚函数表vtable的实现原理及多态性能损耗"></a> <strong>1. 虚函数表(vtable)的实现原理及多态性能损耗</strong></h3><ul><li>原理：每个包含虚函数的类会生成一个虚函数表，存储虚函数指针；对象内存首部包含指向该表的指针(vptr)。动态绑定通过运行时查找虚函数表实现。</li><li>性能损耗：多态调用需额外查表跳转(约 1-2 个时钟周期)，嵌入式场景中需权衡灵活性与实时性。</li><li>项目关联：在 OpenCV 图像处理基类中，用虚函数实现不同算法的多态调用(如 FeatureDetector::detect())。</li></ul><h3 id="2-智能指针的线程安全性及-stdshared_ptr-循环引用问题"><a class="markdownIt-Anchor" href="#2-智能指针的线程安全性及-stdshared_ptr-循环引用问题"></a> <strong>2. 智能指针的线程安全性及 std::shared_ptr 循环引用问题</strong></h3><ul><li>线程安全：std::shared_ptr 的引用计数原子操作保证线程安全，但指向的堆对象需额外同步。</li><li>循环引用：若 A 持有 B 的shared_ptr, B 也持有 A 的 shared_ptr, 引用计数永不归零(两个气球相互牵引，彼此都无法被释放)。</li><li>解决方案：用 std::weak_ptr 替代单向持有关系 (如观察者模式中的订阅者列表)。</li><li>项目关联：在模型部署框架中管理 TensorRT 引擎时，用 unique_ptr 避免循环引用导致内存泄漏。</li></ul><h3 id="3-const-成员函数与-mutable-关键字的应用场景"><a class="markdownIt-Anchor" href="#3-const-成员函数与-mutable-关键字的应用场景"></a> <strong>3. const 成员函数与 mutable 关键字的应用场景</strong></h3><ul><li>const 成员函数：承诺不修改对象状态 (如 size() const)，允许 const 对象调用。</li><li>mutable: 修饰可能被 const 函数修改的成员 (如缓存标记、 互斥锁)。</li><li>项目关联：在实时数据采集类中，用 mutable std::mutex 保证 const 函数内的线程安全。</li></ul><h3 id="4-c11-右值引用与移动语义的优化原理"><a class="markdownIt-Anchor" href="#4-c11-右值引用与移动语义的优化原理"></a> <strong>4. C++11 右值引用与移动语义的优化原理。</strong></h3><ul><li>右值引用(&amp;&amp;)：标识临时对象，允许资源转移而非拷贝(如 std::move())。<br />右值引用可以直接指向右值，也可以通过std::move指向左值；而左值引用只能指向左值(const左值引用也能指向右值)。<br />作为函数形参时，右值引用更灵活。虽然const左值引用也可以做到左右值都接受，但它无法修改，有一定局限性。</li><li>移动构造函数: 接管原对象资源(如指针)，将原对象置空避免双重释放，避免了传统的深拷贝的消耗，但是原对象被释放。</li></ul><h3 id="5-嵌入式场景中-volatile-与内存屏障的作用"><a class="markdownIt-Anchor" href="#5-嵌入式场景中-volatile-与内存屏障的作用"></a> <strong>5. 嵌入式场景中 volatile 与内存屏障的作用</strong></h3><ul><li>volatile：阻止编译器优化对变量的读写(如硬件寄存器映射变量)。</li><li>内存屏障：确保指令执行顺序(如 __sync_synchronize() 防止多核缓存不一致)。</li><li>项目关联：在 STM32 中断服务程序中，用 volatile 修饰全局计时器变量，配合内存屏障保证数据可见性。</li></ul><h3 id="6-进程间通信-ipc-的5种方式及适用场景"><a class="markdownIt-Anchor" href="#6-进程间通信-ipc-的5种方式及适用场景"></a> <strong>6. 进程间通信 (IPC) 的5种方式及适用场景</strong></h3><ul><li>管道 (Pipe) : 单向通信，父子进程间使用 (如 Shell 命令的 | 操作)。</li><li>共享内存：高效大数据传输，需同步机制 (如信号量)。</li><li>消息队列：结构化数据传递，支持多线程异步通信。</li><li>信号 (Signal) : 简单事件通知 (如 SIGINT 终止进程)。</li><li>套接字 (Socket) : 跨网络或本机进程通信。</li></ul><h3 id="7-虚拟内存与物理内存的映射机制-mmu-作用"><a class="markdownIt-Anchor" href="#7-虚拟内存与物理内存的映射机制-mmu-作用"></a> <strong>7. 虚拟内存与物理内存的映射机制 (MMU 作用)</strong></h3><ul><li>MMU 功能：<ul><li>虚拟地址 -&gt; 物理地址转换 (页表查询)。</li><li>内存权限检查 (读/写/执行)。</li><li>TLB 缓存加速地址转换。</li></ul></li><li>项目关联：在嵌入式 AI 推理中，MMU 隔离模型权重内存区，防止非法访问。</li></ul><h3 id="8-linux-内核中断处理流程-上半部-vs-下半部"><a class="markdownIt-Anchor" href="#8-linux-内核中断处理流程-上半部-vs-下半部"></a> <strong>8. Linux 内核中断处理流程 (上半部 vs 下半部)</strong></h3><ul><li>上半部 (Top Half) : 在中断上下文中快速响应 (如置标志位)，不可阻塞。</li><li>下半部 (Bottom Half) : 延后处理耗时操作 (如 tasklet 或 workqueue), 可调度。</li><li>项目关联：摄像头数据采集时，上半部读取硬件缓冲区，下半部进行图像预处理。</li></ul><h3 id="9-用户态与内核态切换的性能损耗及优化方法"><a class="markdownIt-Anchor" href="#9-用户态与内核态切换的性能损耗及优化方法"></a> <strong>9. 用户态与内核态切换的性能损耗及优化方法。</strong></h3><ul><li>损耗来源：上下文保存/恢复、CPU模式切换(约数百纳秒)。</li><li>优化方法：<ul><li>减少系统调用次数(如批量读写)</li><li>使用mmap映射文件到用户空间。</li><li>内核旁路技术(如 DPDK)</li></ul></li></ul><h3 id="10-编写-linux-内核模块的基本步骤"><a class="markdownIt-Anchor" href="#10-编写-linux-内核模块的基本步骤"></a> <strong>10. 编写 Linux 内核模块的基本步骤</strong></h3><ol><li>实现模块初始化函数 (module_init()) 和退出函数 (module_exit())</li><li>注册设备驱动或文件系统接口</li><li>处理并发 (如自旋锁 spin_lock())</li><li>编译为 .ko 文件并加载 (insmod)</li></ol><ul><li>项目关联：在 Jetson Nano 上开发自定义 GPIO 驱动时，需编写内核模块实现引脚控制。</li></ul><h3 id="如何设计线程安全的环形缓冲区ring-buffer"><a class="markdownIt-Anchor" href="#如何设计线程安全的环形缓冲区ring-buffer"></a> 如何设计线程安全的环形缓冲区(Ring Buffer)？</h3><ul><li>代码如下：  <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">RingBuffer</span> <span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token function">RingBuffer</span><span class="token punctuation">(</span>size_t size<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">buf_</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">head_</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">tail_</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token keyword">bool</span> <span class="token function">push</span><span class="token punctuation">(</span>unit8_t data<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span>mutex_<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>head_ <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> buf_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> tail_<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>   <span class="token comment">// 满 </span>        buf_<span class="token punctuation">[</span>head_<span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">;</span>        head_ <span class="token operator">=</span> <span class="token punctuation">(</span>head_ <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token function">buf_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">bool</span> <span class="token function">pop</span><span class="token punctuation">(</span>unit8_t<span class="token operator">&amp;</span> data<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span>mutex_<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>head_ <span class="token operator">==</span> tail_<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>   <span class="token comment">// 空</span>        data <span class="token operator">=</span> buf_<span class="token punctuation">[</span>tail_<span class="token punctuation">]</span><span class="token punctuation">;</span>        tail_ <span class="token operator">=</span> <span class="token punctuation">(</span>tail_ <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> buf_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token keyword">private</span><span class="token operator">:</span>    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>unit8_t<span class="token operator">></span> buf_<span class="token punctuation">;</span>    size_t head_<span class="token punctuation">,</span> tail_<span class="token punctuation">;</span>    std<span class="token double-colon punctuation">::</span>mutex mutex_<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> C++ </tag>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>GDB_调试指南</title>
      <link href="/2025/05/24/GDB-%E8%B0%83%E8%AF%95%E6%8C%87%E5%8D%97/"/>
      <url>/2025/05/24/GDB-%E8%B0%83%E8%AF%95%E6%8C%87%E5%8D%97/</url>
      
        <content type="html"><![CDATA[<p>以下是一份详细的 <strong>GDB 调试指南</strong>，涵盖基础到高级用法，适用于 Linux C/C++ 程序调试（包括多线程、核心转储分析等场景）。</p><hr /><h2 id="1-gdb-基础使用"><a class="markdownIt-Anchor" href="#1-gdb-基础使用"></a> <strong>1. GDB 基础使用</strong></h2><h3 id="11-启动-gdb"><a class="markdownIt-Anchor" href="#11-启动-gdb"></a> <strong>1.1 启动 GDB</strong></h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 调试可执行文件</span>gdb ./your_program<span class="token comment"># 调试正在运行的进程</span>gdb <span class="token parameter variable">-p</span> <span class="token operator">&lt;</span>PID<span class="token operator">></span><span class="token comment"># 调试核心转储文件（coredump）</span>gdb ./your_program core<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="12-常用基础命令"><a class="markdownIt-Anchor" href="#12-常用基础命令"></a> <strong>1.2 常用基础命令</strong></h3><table><thead><tr><th>命令</th><th>缩写</th><th>作用</th></tr></thead><tbody><tr><td><code>run</code></td><td><code>r</code></td><td>启动程序</td></tr><tr><td><code>break &lt;location&gt;</code></td><td><code>b</code></td><td>设置断点（如 <code>b main</code>, <code>b file.cpp:10</code>）</td></tr><tr><td><code>continue</code></td><td><code>c</code></td><td>继续执行到下一个断点</td></tr><tr><td><code>next</code></td><td><code>n</code></td><td>单步执行（不进入函数）</td></tr><tr><td><code>step</code></td><td><code>s</code></td><td>单步执行（进入函数）</td></tr><tr><td><code>print &lt;var&gt;</code></td><td><code>p</code></td><td>打印变量值</td></tr><tr><td><code>backtrace</code></td><td><code>bt</code></td><td>查看调用栈</td></tr><tr><td><code>quit</code></td><td><code>q</code></td><td>退出 GDB</td></tr></tbody></table><hr /><h2 id="2-断点管理"><a class="markdownIt-Anchor" href="#2-断点管理"></a> <strong>2. 断点管理</strong></h2><h3 id="21-设置断点"><a class="markdownIt-Anchor" href="#21-设置断点"></a> <strong>2.1 设置断点</strong></h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">b main          <span class="token comment"># 在 main 函数开头断点</span>b file.cpp:20   <span class="token comment"># 在 file.cpp 的第 20 行断点</span>b *0x4005a6     <span class="token comment"># 在内存地址断点（反汇编调试）</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="22-条件断点"><a class="markdownIt-Anchor" href="#22-条件断点"></a> <strong>2.2 条件断点</strong></h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">b foo <span class="token keyword">if</span> x <span class="token operator">></span> <span class="token number">10</span>   <span class="token comment"># 当 x > 10 时在 foo 函数中断</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="23-查看删除断点"><a class="markdownIt-Anchor" href="#23-查看删除断点"></a> <strong>2.3 查看/删除断点</strong></h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">info breakpoints  <span class="token comment"># 查看所有断点</span>delete <span class="token operator">&lt;</span>num<span class="token operator">></span>      <span class="token comment"># 删除指定编号的断点</span><span class="token function">clear</span>             <span class="token comment"># 清除当前行的断点</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><hr /><h2 id="3-变量与内存操作"><a class="markdownIt-Anchor" href="#3-变量与内存操作"></a> <strong>3. 变量与内存操作</strong></h2><h3 id="31-查看变量"><a class="markdownIt-Anchor" href="#31-查看变量"></a> <strong>3.1 查看变量</strong></h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">p x              <span class="token comment"># 打印变量 x</span>p/x x            <span class="token comment"># 以十六进制打印</span>p *ptr@10        <span class="token comment"># 打印指针 ptr 指向的 10 个元素</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="32-修改变量"><a class="markdownIt-Anchor" href="#32-修改变量"></a> <strong>3.2 修改变量</strong></h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">set</span> var x <span class="token operator">=</span> <span class="token number">5</span>    <span class="token comment"># 修改变量 x 的值</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="33-检查内存"><a class="markdownIt-Anchor" href="#33-检查内存"></a> <strong>3.3 检查内存</strong></h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">x/8wx 0x400000   <span class="token comment"># 查看内存（8 个 4 字节字，十六进制）</span>x/s ptr          <span class="token comment"># 打印字符串（直到 '\0'）</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><hr /><h2 id="4-多线程调试"><a class="markdownIt-Anchor" href="#4-多线程调试"></a> <strong>4. 多线程调试</strong></h2><h3 id="41-线程控制"><a class="markdownIt-Anchor" href="#41-线程控制"></a> <strong>4.1 线程控制</strong></h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">info threads     <span class="token comment"># 查看所有线程</span>thread <span class="token operator">&lt;</span>ID<span class="token operator">></span>      <span class="token comment"># 切换到指定线程</span>b foo thread <span class="token number">2</span>   <span class="token comment"># 仅在线程 2 的 foo 函数中断</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="42-锁定线程调度"><a class="markdownIt-Anchor" href="#42-锁定线程调度"></a> <strong>4.2 锁定线程调度</strong></h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">set</span> scheduler-locking on  <span class="token comment"># 仅当前线程运行（其他暂停）</span><span class="token builtin class-name">set</span> scheduler-locking off <span class="token comment"># 恢复线程自由切换</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="43-死锁调试"><a class="markdownIt-Anchor" href="#43-死锁调试"></a> <strong>4.3 死锁调试</strong></h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">catch syscall pthread_mutex_lock  <span class="token comment"># 捕获锁调用</span>thread apply all bt              <span class="token comment"># 查看所有线程堆栈</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><hr /><h2 id="5-核心转储core-dump分析"><a class="markdownIt-Anchor" href="#5-核心转储core-dump分析"></a> <strong>5. 核心转储（Core Dump）分析</strong></h2><h3 id="51-生成-core-dump"><a class="markdownIt-Anchor" href="#51-生成-core-dump"></a> <strong>5.1 生成 Core Dump</strong></h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">ulimit</span> <span class="token parameter variable">-c</span> unlimited  <span class="token comment"># 允许生成 core 文件</span>./your_program       <span class="token comment"># 崩溃后生成 core</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="52-分析-core"><a class="markdownIt-Anchor" href="#52-分析-core"></a> <strong>5.2 分析 Core</strong></h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gdb ./your_program corebt                   <span class="token comment"># 查看崩溃时的调用栈</span>p <span class="token operator">&lt;</span>var<span class="token operator">></span>              <span class="token comment"># 检查变量状态</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><hr /><h2 id="6-高级功能"><a class="markdownIt-Anchor" href="#6-高级功能"></a> <strong>6. 高级功能</strong></h2><h3 id="61-反汇编调试"><a class="markdownIt-Anchor" href="#61-反汇编调试"></a> <strong>6.1 反汇编调试</strong></h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">disassemble          <span class="token comment"># 查看当前函数的汇编代码</span>si / ni              <span class="token comment"># 汇编级单步执行（step/next instruction）</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="62-自定义命令"><a class="markdownIt-Anchor" href="#62-自定义命令"></a> <strong>6.2 自定义命令</strong></h3><p>在 <code>~/.gdbinit</code> 中定义快捷命令：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">define print_array  <span class="token builtin class-name">set</span> <span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span>  <span class="token keyword">while</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token variable">$arg0</span>    <span class="token builtin class-name">printf</span> <span class="token string">"arr[%d] = %d<span class="token entity" title="\n">\n</span>"</span>, <span class="token variable">$i</span>, arr<span class="token punctuation">[</span><span class="token variable">$i</span><span class="token punctuation">]</span>    <span class="token builtin class-name">set</span> <span class="token variable">$i</span> <span class="token operator">=</span> <span class="token variable">$i</span> + <span class="token number">1</span>  endend<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>使用时：<code>print_array 10</code>。</p><h3 id="63-反向调试reverse-debugging"><a class="markdownIt-Anchor" href="#63-反向调试reverse-debugging"></a> <strong>6.3 反向调试（Reverse Debugging）</strong></h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">record full          <span class="token comment"># 开始记录执行流程</span>reverse-step         <span class="token comment"># 反向执行</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><hr /><h2 id="7-调试优化后的代码"><a class="markdownIt-Anchor" href="#7-调试优化后的代码"></a> <strong>7. 调试优化后的代码</strong></h2><p>如果程序编译时用了 <code>-O2</code>，变量可能被优化掉，需：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 禁用优化或添加调试符号</span>gcc <span class="token parameter variable">-O0</span> <span class="token parameter variable">-g</span> program.c<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><hr /><h2 id="8-实用技巧"><a class="markdownIt-Anchor" href="#8-实用技巧"></a> <strong>8. 实用技巧</strong></h2><ul><li><strong>日志输出</strong>：<br /><code>printf &quot;x=%d\n&quot;, x</code>（在 GDB 中直接打印日志）。</li><li><strong>跳过代码块</strong>：<br /><code>until &lt;line&gt;</code>（执行到指定行）。</li><li><strong>调试子进程</strong>：<br /><code>set follow-fork-mode child</code>（跟踪子进程）。</li></ul><hr /><h2 id="9-推荐学习资源"><a class="markdownIt-Anchor" href="#9-推荐学习资源"></a> <strong>9. 推荐学习资源</strong></h2><ul><li><strong>官方手册</strong>：<code>gdb -tui</code>（文本界面模式）或 <code>info gdb</code>。</li><li><strong>图形化前端</strong>：<ul><li><code>cgdb</code>（增强型命令行 GDB）</li><li><code>ddd</code>（图形化调试器）。</li></ul></li></ul><hr /><p>掌握这些命令后，你可以高效诊断段错误、死锁、数据竞争等问题。对于复杂项目，建议结合 <strong>VS Code + GDB 插件</strong> 提升效率。</p>]]></content>
      
      
      <categories>
          
          <category> 笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> GDB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>每日知识点-3</title>
      <link href="/2025/05/23/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-3/"/>
      <url>/2025/05/23/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-3/</url>
      
        <content type="html"><![CDATA[<h2 id="每日知识点-3"><a class="markdownIt-Anchor" href="#每日知识点-3"></a> 每日知识点-3</h2><hr /><h3 id="1-用-define-声明一个常量表示一年秒数忽略闰年并解释ul后缀的作用"><a class="markdownIt-Anchor" href="#1-用-define-声明一个常量表示一年秒数忽略闰年并解释ul后缀的作用"></a> <strong>1. 用 #define 声明一个常量表示一年秒数(忽略闰年)并解释UL后缀的作用。</strong></h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SECONDS_PER_YEAR</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">365</span><span class="token punctuation">)</span>UL</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>作用: UL表示无符号长整型 (Unsinged Long), 防止数值溢出 (如某些编译器默认int为16位时，计算结果可能超过范围)。</li><li>项目关联: 在嵌入式设备的定时器配置中，需避免直接写&quot;魔法数字&quot;，使用宏定义提升代码可维护性。</li></ul><h3 id="2-手写线程安全的单例模式代码并解释-volatile-关键字在嵌入式场景中的作用"><a class="markdownIt-Anchor" href="#2-手写线程安全的单例模式代码并解释-volatile-关键字在嵌入式场景中的作用"></a> <strong>2. 手写线程安全的单例模式代码，并解释 volatile 关键字在嵌入式场景中的作用。</strong></h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">Singleton</span> <span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token keyword">static</span> Singleton<span class="token operator">*</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> instance<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">Singleton</span><span class="token punctuation">(</span><span class="token keyword">const</span> Singleton<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>    Singleton<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> Singleton<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span><span class="token keyword">private</span><span class="token operator">:</span>    <span class="token keyword">static</span> Singleton<span class="token operator">*</span> instance<span class="token punctuation">;</span>    <span class="token keyword">static</span> std<span class="token double-colon punctuation">::</span>mutex mutex<span class="token punctuation">;</span>    <span class="token function">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>Singleton<span class="token operator">*</span> Singleton<span class="token double-colon punctuation">::</span>instance <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>std<span class="token double-colon punctuation">::</span>mutex Singleton<span class="token double-colon punctuation">::</span>mutex<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>volatile 的作用：防止编译器优化对多线程共享变量的访问。(如中断服务程序修改的硬件寄存器的值)。</li></ul><h3 id="3-黑盒测试与白盒测试的区别你在项目中如何应用"><a class="markdownIt-Anchor" href="#3-黑盒测试与白盒测试的区别你在项目中如何应用"></a> <strong>3. 黑盒测试与白盒测试的区别？你在项目中如何应用？</strong></h3><ul><li>区别：<ul><li>黑盒测试：关注输入输出，不关心内部实现(如功能测试)；</li><li>白盒测试：基于代码逻辑设计用例(如路径覆盖、分支覆盖)；</li></ul></li><li>项目关联：在图像处理算法开发中，用黑盒测试验证模型输出精度，白盒测试检查核心函数(如边缘检测)的分支覆盖。</li></ul><h3 id="4-如何用gdb调试多进程程序举例说明"><a class="markdownIt-Anchor" href="#4-如何用gdb调试多进程程序举例说明"></a> <strong>4. 如何用gdb调试多进程程序？举例说明。</strong></h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gdb <span class="token parameter variable">-p</span> <span class="token operator">&lt;</span>parent_pid<span class="token operator">></span>     <span class="token comment"># 附加到父进程</span><span class="token builtin class-name">set</span> follow-fork-mode child  <span class="token comment"># 跟踪子进程</span>b main.c:20     <span class="token comment"># 在子进程代码行设断点</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>项目关联：在嵌入式多进程通信框架调试中，追踪子进程崩溃问题(如共享内存竞争)。</li></ul><h3 id="5-解释-ls-amore-命令的错误及正确用法"><a class="markdownIt-Anchor" href="#5-解释-ls-amore-命令的错误及正确用法"></a> <strong>5. 解释 ls -amore 命令的错误及正确用法</strong></h3><ul><li>错误原因：-amore 被解析为 -a -m -o -r -e, 实际应为 ls -a | more (分页显示隐藏文件)</li><li>正确用法：  <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">ls</span> <span class="token parameter variable">-a</span> <span class="token operator">|</span> <span class="token function">more</span>    <span class="token comment"># 分页显示所有文件 (含隐藏文件)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ul><h3 id="6-如何用vi进行块拷贝-粘贴和删除操作"><a class="markdownIt-Anchor" href="#6-如何用vi进行块拷贝-粘贴和删除操作"></a> <strong>6. 如何用vi进行块拷贝、粘贴和删除操作？</strong></h3><ul><li>块操作步骤：<ol><li>进入可视块模式：Ctrl + V -&gt; 选中区域</li><li>拷贝：y；粘贴：p；删除d。</li></ol></li><li>项目关联：在修改嵌入式设备配置文件(如/etc/fstab)时快速调整多行参数。</li></ul><h3 id="7-合并n个有序链表为一个新有序链表手写代码"><a class="markdownIt-Anchor" href="#7-合并n个有序链表为一个新有序链表手写代码"></a> <strong>7. 合并N个有序链表为一个新有序链表(手写代码)</strong></h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">struct</span> <span class="token class-name">ListNode</span><span class="token operator">*</span> <span class="token function">mergeKLists</span><span class="token punctuation">(</span>vector<span class="token operator">&lt;</span>ListNode<span class="token operator">*</span><span class="token operator">></span><span class="token operator">&amp;</span> lists<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">auto</span> cmp <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>ListNode<span class="token operator">*</span> a<span class="token punctuation">,</span> ListNode<span class="token operator">*</span> b<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> a<span class="token operator">-></span>val <span class="token operator">></span> b<span class="token operator">-></span>val<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    priority_queue<span class="token operator">&lt;</span>ListNode<span class="token operator">*</span><span class="token punctuation">,</span> vector<span class="token operator">&lt;</span>ListNode<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token keyword">decltype</span><span class="token punctuation">(</span>cmp<span class="token punctuation">)</span><span class="token operator">></span> <span class="token function">pq</span><span class="token punctuation">(</span>cmp<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> node <span class="token operator">:</span> lists<span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">)</span> pq<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>    ListNode dummy<span class="token punctuation">,</span> <span class="token operator">*</span>curr <span class="token operator">=</span> <span class="token operator">&amp;</span>dummy<span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>pq<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">auto</span> top <span class="token operator">=</span> pq<span class="token punctuation">.</span><span class="token function">top</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> pq<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        curr<span class="token operator">-></span>next <span class="token operator">=</span> top<span class="token punctuation">;</span>        curr <span class="token operator">=</span> curr<span class="token operator">-></span>next<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>top<span class="token operator">-></span>next<span class="token punctuation">)</span> pq<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>top<span class="token operator">-></span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> dummy<span class="token punctuation">.</span>next<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="8-哈希表冲突的链地址法-vs-开放寻址法嵌入式场景中如何选择"><a class="markdownIt-Anchor" href="#8-哈希表冲突的链地址法-vs-开放寻址法嵌入式场景中如何选择"></a> <strong>8. 哈希表冲突的链地址法 vs 开放寻址法，嵌入式场景中如何选择？</strong></h3><ul><li>链地址法：稳定但需要指针开销(适合PC端)</li><li>开放寻址法：内存利用率高，适合嵌入式小内存场景(如缓存查询表)</li></ul><h3 id="9-快速排序的最优最差时间复杂度如何避免最差情况"><a class="markdownIt-Anchor" href="#9-快速排序的最优最差时间复杂度如何避免最差情况"></a> <strong>9. 快速排序的最优/最差时间复杂度？如何避免最差情况？</strong></h3><ul><li>最优：O(n log n) (均匀分割)；最差：O(n^2) (完全有序数组)</li><li>避免方法：随机选择枢轴 (pivot) 或三数取中法。</li></ul><h3 id="10-编写函数统计文件字符数使用while循环"><a class="markdownIt-Anchor" href="#10-编写函数统计文件字符数使用while循环"></a> <strong>10. 编写函数统计文件字符数(使用while循环)</strong></h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">charnum</span><span class="token punctuation">(</span><span class="token keyword">char</span> fn<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    FILE<span class="token operator">*</span> fp <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fp<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">fgetc</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">EOF</span><span class="token punctuation">)</span> count<span class="token operator">++</span><span class="token punctuation">;</span>    <span class="token function">fclose</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> count<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> C++ </tag>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>每日知识点-2</title>
      <link href="/2025/05/22/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-2/"/>
      <url>/2025/05/22/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-2/</url>
      
        <content type="html"><![CDATA[<h2 id="每日知识点-2"><a class="markdownIt-Anchor" href="#每日知识点-2"></a> 每日知识点-2</h2><hr /><h3 id="1-指针与引用的核心区别项目中如何应用"><a class="markdownIt-Anchor" href="#1-指针与引用的核心区别项目中如何应用"></a> <strong>1. 指针与引用的核心区别？项目中如何应用？</strong></h3><ul><li>区别：<ul><li>指针是变量存储地址，可重指向其他对象；引用是别名，绑定后不可更改。</li><li>指针可为空(nullptr), 引用必须绑定有效对象。</li></ul></li><li>项目关联：<br />在OpenCV图像处理中，使用指针传递大型图像数据矩阵(如cv::Mat*)避免拷贝；引用用于函数参数传递(如 const cv::Mat&amp;)保证安全访问。<br />例如:<ul><li>使用指针:  <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token function">proccessImage</span><span class="token punctuation">(</span>cv<span class="token double-colon punctuation">::</span>Mat<span class="token operator">*</span> img<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 假设对图像进行灰度化处理</span>    cv<span class="token double-colon punctuation">::</span><span class="token function">cvColor</span><span class="token punctuation">(</span><span class="token operator">*</span>img<span class="token punctuation">,</span> <span class="token operator">*</span>img<span class="token punctuation">,</span> cv<span class="token double-colon punctuation">::</span>COLOR_BGR2GRAY<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>不加const修饰时，可改变指针指向，和指向的值。<br />常量指针(const cv::Mat* img)：不能通过该指针修改指针指向的值。<br />指针常量(cv::Mat* const img)：不能修改指针的指向(也就是指针指向的地址不能变)</li><li>使用引用:  <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token function">proccessImage</span><span class="token punctuation">(</span><span class="token keyword">const</span> cv<span class="token double-colon punctuation">::</span>Mat<span class="token operator">&amp;</span> img<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 灰度化处理</span>    cv<span class="token double-colon punctuation">::</span>Mat grayImg<span class="token punctuation">;</span>    cv<span class="token double-colon punctuation">::</span><span class="token function">cvtColor</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> grayImg<span class="token punctuation">,</span> cv<span class="token double-colon punctuation">::</span>COLOR_BGR2GRAY<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul>最佳实践:<ul><li>如果只是函数参数传递，优先使用 const cv::Mat&amp;（更安全、更简洁）</li><li>如果需要处理 nullptr (例如void proccessImage(const cv::Mat* img = nullptr) {} ) 或动态切换对象，使用 const cv::Mat*。</li></ul><blockquote><p>常量指针(const cv::Mat* img)是否一定能保证指向的值不会被改变？<br />不一定！const cv::Mat* img（指向常量的指针）只能保证不能通过该指针修改数据，但原始数据仍可能被其他方式修改。</p></blockquote></li></ul><h3 id="2-const-关键字在函数参数和成员函数中的作用"><a class="markdownIt-Anchor" href="#2-const-关键字在函数参数和成员函数中的作用"></a> <strong>2. const 关键字在函数参数和成员函数中的作用？</strong></h3><ul><li>参数: const T&amp; 防止修改输入数据(如传感器的原始数据)。</li><li>成员函数: void func() const 承诺不修改对象状态(如线程安全的配置类), 表示只读。<br />例如:  <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">Config</span> <span class="token punctuation">&#123;</span><span class="token keyword">private</span><span class="token operator">:</span>    <span class="token keyword">int</span> width_<span class="token punctuation">;</span>    <span class="token keyword">int</span> height_<span class="token punctuation">;</span>    <span class="token keyword">mutable</span> <span class="token keyword">int</span> accessCount_<span class="token punctuation">;</span>   <span class="token comment">// 可被 const 函数修改</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token comment">// const 成员函数，承诺不修改对象状态</span>    <span class="token keyword">void</span> <span class="token function">printConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// width_ = 100;    // 错误，不能修改非 mutable 成员</span>        accessCount_<span class="token operator">++</span><span class="token punctuation">;</span>     <span class="token comment">// 正确，mutable成员可修改</span>        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Width: "</span> <span class="token operator">&lt;&lt;</span> width_ <span class="token operator">&lt;&lt;</span> <span class="token string">", Height: "</span> <span class="token operator">&lt;&lt;</span> height_ <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>返回非 const 指针/引用是危险的  <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">BadExample</span> <span class="token punctuation">&#123;</span><span class="token keyword">private</span><span class="token operator">:</span>    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> data_<span class="token punctuation">;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token comment">// 危险：const 函数暴露了可修改的内部数据</span>    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span><span class="token operator">&amp;</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> data_<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>  <span class="token comment">// 不要这样做！</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>const 成员函数和非 const 成员函数可以重载</li><li>项目关联: 在模型推理的类中，const修饰推理函数确保权重不被意外修改。</li></ul><h3 id="3-手写单例模式线程安全版"><a class="markdownIt-Anchor" href="#3-手写单例模式线程安全版"></a> <strong>3. 手写单例模式(线程安全版)</strong></h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">Singleton</span> <span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token keyword">static</span> Singleton<span class="token operator">&amp;</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">static</span> Singleton instance<span class="token punctuation">;</span>  <span class="token comment">// 即使多次访问这个函数，instance也只会初始化一次。</span>        <span class="token keyword">return</span> instance<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">Singleton</span><span class="token punctuation">(</span><span class="token keyword">const</span> Singleton<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>   <span class="token comment">// 禁止拷贝构造</span>    Singleton<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> Singleton<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>    <span class="token comment">// 禁用赋值构造</span><span class="token keyword">private</span><span class="token operator">:</span>    <span class="token function">Singleron</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>  <span class="token comment">// 私有构造函数</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>项目关联: 用于全局配置管理(如摄像头参数加载)，避免多线程重复初始化。</li></ul><h3 id="4-ps-aux-和-top-命令的区别项目中如何用"><a class="markdownIt-Anchor" href="#4-ps-aux-和-top-命令的区别项目中如何用"></a> <strong>4. ps -aux 和 top 命令的区别？项目中如何用？</strong></h3><ul><li>ps -aux: 静态快照显示所有进程信息(如PID，CPU占用)</li><li>top: 动态实时监控进程资源(按CPU排序，支持交互命令)</li><li>项目关联: 部署YOLO模型时用top监控推理进程的CPU/内存峰值，优化线程数。</li></ul><h3 id="5-如何用grep-搜索日志中的segmentation-fault"><a class="markdownIt-Anchor" href="#5-如何用grep-搜索日志中的segmentation-fault"></a> <strong>5. 如何用grep 搜索日志中的&quot;segmentation fault&quot;?</strong></h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">grep</span> <span class="token string">"segmentation fault"</span> /var/log/syslog <span class="token operator">|</span> <span class="token function">tail</span> <span class="token parameter variable">-n</span> <span class="token number">20</span>  <span class="token comment"># 显示最后20行</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>项目关联: 在嵌入式设备调试中，快速定位模型推理崩溃的堆栈信息。</li></ul><h3 id="6-解释-strace-命令的作用并举例"><a class="markdownIt-Anchor" href="#6-解释-strace-命令的作用并举例"></a> <strong>6. 解释 strace 命令的作用并举例</strong></h3><ul><li>作用: 追踪进程的系统调用(如文件读写、信号处理)</li><li>示例:  <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">strace</span> <span class="token parameter variable">-o</span> debug.log ./inference_app  <span class="token comment"># 记录系统调用到文件</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li>项目关联: 分析 OpenCV 视频采集卡顿问题，发现 read() 调用阻塞事件过长。</li></ul><h3 id="7-链表反转手写代码-优化思路"><a class="markdownIt-Anchor" href="#7-链表反转手写代码-优化思路"></a> <strong>7. 链表反转(手写代码 + 优化思路)</strong></h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">ListNode<span class="token operator">*</span> <span class="token function">reverseList</span><span class="token punctuation">(</span>ListNode<span class="token operator">*</span> head<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    ListNode<span class="token operator">*</span> prev <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token operator">*</span>curr <span class="token operator">=</span> head<span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>curr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        ListNode<span class="token operator">*</span> next <span class="token operator">=</span> curr <span class="token operator">-></span> next<span class="token punctuation">;</span>        curr <span class="token operator">-></span> next <span class="token operator">=</span> prev<span class="token punctuation">;</span>        prev <span class="token operator">=</span> curr<span class="token punctuation">;</span>        curr <span class="token operator">=</span> next<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> prev<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>优化思路: 嵌入式设备中避免递归防止栈溢出，用迭代法减少内存消耗。</li></ul><h3 id="8-哈希表冲突解决方法的优缺点"><a class="markdownIt-Anchor" href="#8-哈希表冲突解决方法的优缺点"></a> <strong>8. 哈希表冲突解决方法的优缺点?</strong></h3><ul><li>开放寻址: 内存紧凑但易聚集(适合嵌入式小内存场景)</li><li>链地址法: 稳定但须额外指针(PC端常用)</li><li>项目关联: 在特征点匹配算法中，用链地址法哈希表加速特征查询。</li></ul><h3 id="9-快速排序实现及时间复杂度分析"><a class="markdownIt-Anchor" href="#9-快速排序实现及时间复杂度分析"></a> <strong>9. 快速排序实现及时间复杂度分析</strong></h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// 分区函数：选择 pivot，将小于 pivot 的元素放在左边，大于 pivot 的放在右边</span><span class="token keyword">int</span> <span class="token function">partition</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span><span class="token operator">&amp;</span> arr<span class="token punctuation">,</span> <span class="token keyword">int</span> low<span class="token punctuation">,</span> <span class="token keyword">int</span> high<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> pivot <span class="token operator">=</span> arr<span class="token punctuation">[</span>high<span class="token punctuation">]</span><span class="token punctuation">;</span>   <span class="token comment">// 选择最后一个元素作为 pivot</span>    <span class="token keyword">int</span> i <span class="token operator">=</span> low <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>     <span class="token comment">// i 是小于 pivot 的区域的边界</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span>  low<span class="token punctuation">;</span> j <span class="token operator">&lt;</span> high<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">&lt;</span> pivot<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token operator">++</span>i<span class="token punctuation">;</span>            std<span class="token double-colon punctuation">::</span><span class="token function">swap</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    std<span class="token double-colon punctuation">::</span><span class="token function">swap</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> arr<span class="token punctuation">[</span>high<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token keyword">return</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>     <span class="token comment">// 返回 pivot 的索引</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">quickSort</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span><span class="token operator">&amp;</span> arr<span class="token punctuation">,</span> <span class="token keyword">int</span> low<span class="token punctuation">,</span> <span class="token keyword">int</span> high<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>low <span class="token operator">&lt;</span> high<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">int</span> pivotIndex <span class="token operator">=</span> <span class="token function">partition</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> low<span class="token punctuation">,</span> high<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">quickSort</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> low<span class="token punctuation">,</span> pivotIndex <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">quickSort</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> pivotIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> high<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// 递归版本可能在大数据量时导致 栈溢出, 可以用栈模拟递归：</span><span class="token keyword">void</span> <span class="token function">quickSortIterative</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span><span class="token operator">&amp;</span> arr<span class="token punctuation">,</span> <span class="token keyword">int</span> low<span class="token punctuation">,</span> <span class="token keyword">int</span> high<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    std<span class="token double-colon punctuation">::</span>stack<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>pair<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">>></span> st<span class="token punctuation">;</span>    st<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>low<span class="token punctuation">,</span> high<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>st<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">auto</span> <span class="token punctuation">&#123;</span>l<span class="token punctuation">,</span> h<span class="token punctuation">&#125;</span> <span class="token operator">=</span> st<span class="token punctuation">.</span><span class="token function">top</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        st<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>l <span class="token operator">>=</span> h<span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> pivotIndex <span class="token operator">=</span> <span class="token function">partition</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> l<span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">;</span>        st<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>l<span class="token punctuation">,</span> pivotIndex <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        st<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>pivotIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> h<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="10-用栈实现队列的功能"><a class="markdownIt-Anchor" href="#10-用栈实现队列的功能"></a> <strong>10. 用栈实现队列的功能</strong></h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">MyQueue</span> <span class="token punctuation">&#123;</span>    stack<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> in<span class="token punctuation">,</span> out<span class="token punctuation">;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token keyword">void</span> <span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        in<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">int</span> <span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>out<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">// 如果 out 为空，那就把 in 的所有元素倒过来, 也就是压入 out中</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>in<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                out<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>in<span class="token punctuation">.</span><span class="token function">top</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                in<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">int</span> val <span class="token operator">=</span> out<span class="token punctuation">.</span><span class="token function">top</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        out<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> val<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">int</span> <span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>outStack<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">// 如果 outStack 为空，把 inStack 的所有元素倒过来</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>inStack<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                outStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>inStack<span class="token punctuation">.</span><span class="token function">top</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                inStack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> outStack<span class="token punctuation">.</span><span class="token function">top</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 只是观察，不删除元素</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="每日知识加油站"><a class="markdownIt-Anchor" href="#每日知识加油站"></a> <strong>每日知识加油站:</strong></h3><p><strong>内存分区</strong></p><table><thead><tr><th style="text-align:left"><strong>分区</strong></th><th style="text-align:left"><strong>存储内容</strong></th><th style="text-align:left"><strong>管理方式</strong></th><th style="text-align:left"><strong>生命周期</strong></th><th style="text-align:left"><strong>示例</strong></th></tr></thead><tbody><tr><td style="text-align:left"><strong>栈 (Stack)</strong></td><td style="text-align:left">局部变量、函数参数、返回地址</td><td style="text-align:left">编译器自动管理</td><td style="text-align:left">函数执行结束自动释放</td><td style="text-align:left"><code>int x = 10;</code></td></tr><tr><td style="text-align:left"><strong>堆 (Heap)</strong></td><td style="text-align:left">动态分配的内存（<code>new</code>/<code>malloc</code>）</td><td style="text-align:left">手动管理（需<code>delete</code>/<code>free</code>）</td><td style="text-align:left">显式释放前一直存在</td><td style="text-align:left"><code>int* p = new int(42);</code></td></tr><tr><td style="text-align:left"><strong>全局/静态区</strong></td><td style="text-align:left">全局变量、静态变量（<code>static</code>）</td><td style="text-align:left">编译器分配</td><td style="text-align:left">程序启动到结束</td><td style="text-align:left"><code>int globalVar; static int s_var;</code></td></tr><tr><td style="text-align:left"><strong>常量区</strong></td><td style="text-align:left">字符串常量、<code>const</code>全局变量</td><td style="text-align:left">只读，编译器分配</td><td style="text-align:left">程序运行期间</td><td style="text-align:left"><code>const char* str = &quot;Hello&quot;;</code></td></tr><tr><td style="text-align:left"><strong>代码区</strong></td><td style="text-align:left">程序指令（二进制代码）</td><td style="text-align:left">编译器生成</td><td style="text-align:left">程序运行期间</td><td style="text-align:left">函数定义（如<code>main()</code>）</td></tr></tbody></table><table><thead><tr><th style="text-align:left"><strong>特性</strong></th><th style="text-align:left">栈</th><th style="text-align:left">堆</th><th style="text-align:left">全局/静态区</th></tr></thead><tbody><tr><td style="text-align:left"><strong>分配速度</strong></td><td style="text-align:left">快（指针移动）</td><td style="text-align:left">慢（查找空闲块）</td><td style="text-align:left">程序启动时分配</td></tr><tr><td style="text-align:left"><strong>生命周期</strong></td><td style="text-align:left">自动</td><td style="text-align:left">手动</td><td style="text-align:left">程序全程</td></tr><tr><td style="text-align:left"><strong>线程安全</strong></td><td style="text-align:left">线程独立</td><td style="text-align:left">需同步</td><td style="text-align:left">需同步</td></tr><tr><td style="text-align:left"><strong>适用场景</strong></td><td style="text-align:left">临时变量、小对象</td><td style="text-align:left">大对象、共享数据</td><td style="text-align:left">配置参数、单例</td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> C++ </tag>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>每日知识点-1</title>
      <link href="/2025/05/21/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-1/"/>
      <url>/2025/05/21/%E6%AF%8F%E6%97%A5%E7%9F%A5%E8%AF%86%E7%82%B9-1/</url>
      
        <content type="html"><![CDATA[<h2 id="每日知识点-1"><a class="markdownIt-Anchor" href="#每日知识点-1"></a> 每日知识点-1</h2><hr /><h3 id="1-c语言中-volatile-关键字的作用是什么-举一个必须使用-volatile-的实际场景"><a class="markdownIt-Anchor" href="#1-c语言中-volatile-关键字的作用是什么-举一个必须使用-volatile-的实际场景"></a> <strong>1. C语言中 volatile 关键字的作用是什么? 举一个必须使用 volatile 的实际场景。</strong></h3><ul><li>作用: 告诉编译器不要优化对该变量的访问，每次必须从内存读取最新的值。</li><li>场景: 多线程共享变量、硬件寄存器访问(状态寄存器)、中断服务程序(ISR)中修改的全局变量。</li></ul><h3 id="2-解释结构体内存对齐的规则并给出优化结构体大小的两种方法"><a class="markdownIt-Anchor" href="#2-解释结构体内存对齐的规则并给出优化结构体大小的两种方法"></a> <strong>2. 解释结构体内存对齐的规则，并给出优化结构体大小的两种方法。</strong></h3><ul><li>对齐原则: 成员偏移量是自身大小或编译器对齐值的整数倍，结构体总大小为最大对齐值的整数倍。</li><li>优化方法:<ol><li>按成员大小降序排列 (double -&gt; int -&gt; char)</li><li>使用 #pragma pack(1) 强制1字节对齐(牺牲性能换空间)</li></ol></li></ul><h3 id="3-freertos中任务有哪几种状态-如何让一个任务从阻塞态切换到就绪态"><a class="markdownIt-Anchor" href="#3-freertos中任务有哪几种状态-如何让一个任务从阻塞态切换到就绪态"></a> <strong>3. FreeRTOS中任务有哪几种状态? 如何让一个任务从阻塞态切换到就绪态?</strong></h3><ul><li>状态: 运行态(Runing)、就绪态(Ready)、阻塞态(Blocked)、挂起态(Suspended)。</li><li>切换方法: 通过信号量释放(xSemaphoreGive)、任务通知(xTaskNotify)、延迟到期(vTaskDelay)。</li></ul><h3 id="4-iic总线的上拉电阻阻值选择不当会导致什么问题-如何计算合理的阻值"><a class="markdownIt-Anchor" href="#4-iic总线的上拉电阻阻值选择不当会导致什么问题-如何计算合理的阻值"></a> <strong>4. IIC总线的上拉电阻阻值选择不当会导致什么问题? 如何计算合理的阻值</strong></h3><ul><li>问题: 阻值过小 -&gt; 电流过大损坏器件；阻值过大 -&gt; 上升沿过慢导致通信失败。</li><li>计算: 根据总线电容(<span><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>C</mi></mrow><annotation encoding="application/x-tex">C</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span></span></span></span></span>) 和上升时间(<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>t</mi><mi>r</mi></msub></mrow><annotation encoding="application/x-tex">t_r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76508em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>) 计算，公式: <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>R</mi><mrow><mi>m</mi><mi>a</mi><mi>x</mi></mrow></msub><mo>=</mo><msub><mi>t</mi><mi>r</mi></msub><mi mathvariant="normal">/</mi><mo stretchy="false">(</mo><mn>0.8473</mn><mo>∗</mo><mi>C</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">R_{max} = t_r / (0.8473 * C)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">m</span><span class="mord mathdefault mtight">a</span><span class="mord mathdefault mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathdefault">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">/</span><span class="mopen">(</span><span class="mord">0</span><span class="mord">.</span><span class="mord">8</span><span class="mord">4</span><span class="mord">7</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mclose">)</span></span></span></span> (例: 100pF电容 + 1us 上升时间 -&gt; <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>R</mi><mrow><mi>m</mi><mi>a</mi><mi>x</mi></mrow></msub><mo>≈</mo><mn>1.18</mn><mi>k</mi><mi mathvariant="normal">Ω</mi></mrow><annotation encoding="application/x-tex">R_{max} \approx 1.18 k\Omega</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">m</span><span class="mord mathdefault mtight">a</span><span class="mord mathdefault mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">.</span><span class="mord">1</span><span class="mord">8</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mord">Ω</span></span></span></span>)</li></ul><h3 id="5-嵌入式linux系统与标准linux系统的核心区别是什么"><a class="markdownIt-Anchor" href="#5-嵌入式linux系统与标准linux系统的核心区别是什么"></a> <strong>5. 嵌入式Linux系统与标准Linux系统的核心区别是什么?</strong></h3><p>嵌入式Linux系统针对特定的硬件裁剪内核，强调实时性、低功耗和小型化，通常搭配 BusyBox 等精简工具链。标准的Linux面向通用计算，功能更全面但资源占用高。</p><h3 id="6-linux内核架构分为哪几层-简述各层的功能"><a class="markdownIt-Anchor" href="#6-linux内核架构分为哪几层-简述各层的功能"></a> <strong>6. Linux内核架构分为哪几层? 简述各层的功能。</strong></h3><ul><li>分为四级架构：<ul><li>硬件子系统: 管理中断、存储设备驱动(UART/SD)</li><li>核心中介层: 虚拟内存管理、内核态调度器。</li><li>应用支持层: 提供系统调用接口和程序库。</li><li>任务管理层: 处理进程调度和资源分配。</li></ul></li></ul><h3 id="7-设备树在嵌入式linux中的作用是什么"><a class="markdownIt-Anchor" href="#7-设备树在嵌入式linux中的作用是什么"></a> <strong>7. 设备树在嵌入式Linux中的作用是什么？</strong></h3><p>设备树以结构化的数据描述硬件的配置(如外设地址、中断号)，实现硬件和驱动解耦，避免内核重新编译即可适配不同硬件。</p><h3 id="8-解释交叉编译的概念及其必要性"><a class="markdownIt-Anchor" href="#8-解释交叉编译的概念及其必要性"></a> <strong>8. 解释交叉编译的概念及其必要性。</strong></h3><p>交叉编译器指在开发主机(x86)上生成目标平台(如ARM)的可执行文件。</p><ul><li>必要性:<ol><li>嵌入式设备资源有限，无法本地编译。</li><li>开发机性能强，提升编译效率。</li></ol></li></ul><h3 id="9-嵌入式linux驱动开发的基本步骤有哪些"><a class="markdownIt-Anchor" href="#9-嵌入式linux驱动开发的基本步骤有哪些"></a> <strong>9. 嵌入式Linux驱动开发的基本步骤有哪些？</strong></h3><ol><li>定义设备与驱动的接口(如字符设备)</li><li>编写驱动代码并编译成内核模块</li><li>修改设备树添加节点绑定驱动</li><li>加载模块并测试硬件功能</li></ol><h3 id="10-设备树-device-tree-中如何定义一个-gpio-按键中断写出对应的dts代码片段"><a class="markdownIt-Anchor" href="#10-设备树-device-tree-中如何定义一个-gpio-按键中断写出对应的dts代码片段"></a> <strong>10. 设备树 (Device Tree) 中如何定义一个 GPIO 按键中断？写出对应的DTS代码片段。</strong></h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token operator">&amp;</span>gpio0 <span class="token punctuation">&#123;</span>    <span class="token comment">// 引用GPIO控制器节点 (例如某个芯片的GPIO0模块) (不可更改，厂商定义)</span>    button <span class="token punctuation">&#123;</span>    <span class="token comment">// 定义一个字节点，表示按键设备 (节点名称，可自定义命名)</span>        compatible <span class="token operator">=</span> <span class="token string">"gpio-keys"</span><span class="token punctuation">;</span>   <span class="token comment">// 告诉内核，此设备使用 gpio-keys 驱动 (不可更改)</span>        button1 <span class="token punctuation">&#123;</span>   <span class="token comment">// 定义第一个按键的具体参数 (字节点名称，可更改)</span>            label <span class="token operator">=</span> <span class="token string">"USER_BUTTON"</span><span class="token punctuation">;</span>  <span class="token comment">// 按键的标签，方便调试 (value 可更改，自定义)</span>            gpios <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio0 <span class="token number">14</span> GPIO_ACTIVE_LOW<span class="token operator">></span><span class="token punctuation">;</span>    <span class="token comment">// 使用GPIO0的14号引脚，低电平有效 (不能改)</span>            linux<span class="token punctuation">,</span> code <span class="token operator">=</span> <span class="token operator">&lt;</span>KEY_ENTER<span class="token operator">></span><span class="token punctuation">;</span>  <span class="token comment">// 按下时生成"回车键事件" (key不能改，value可在内核的事件定义中查找更改)</span>            interrupts<span class="token operator">-</span>extended <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio0 <span class="token number">14</span> IRQ_TYPE_EDGE_FALLING<span class="token operator">></span><span class="token punctuation">;</span>    <span class="token comment">// 中断触发方式，下降沿触发 (key 不能改，value须适配)</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> C++ </tag>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>搭建Nginx-FLV流媒体服务器</title>
      <link href="/2025/05/21/%E6%90%AD%E5%BB%BANginx-FLV%E6%B5%81%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1%E5%99%A8/"/>
      <url>/2025/05/21/%E6%90%AD%E5%BB%BANginx-FLV%E6%B5%81%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1%E5%99%A8/</url>
      
        <content type="html"><![CDATA[<h2 id="搭建nginx-flv"><a class="markdownIt-Anchor" href="#搭建nginx-flv"></a> 搭建nginx-FLV</h2><blockquote><p>查看更多信息请前往 <a href="https://github.com/zikcc/nginx-streaming-demos">github: nginx-streaming-demos</a></p></blockquote><h3 id="准备工作"><a class="markdownIt-Anchor" href="#准备工作"></a> 准备工作</h3><p>请查看 <a href="/2025/05/21/%E6%90%AD%E5%BB%BANginx-RTMP%E6%B5%81%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1%E5%99%A8/#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C" title="搭建Nginx-RTMP流媒体服务器">搭建Nginx-RTMP流媒体服务器的准备工作</a></p><h3 id="构建镜像"><a class="markdownIt-Anchor" href="#构建镜像"></a> 构建镜像</h3><p>由于之前是拉取的 nginx-rtmp 的镜像，不支持flv。所以需要重新构建一个支持flv的nginx镜像。</p><p>nginx-http-flv-module 支持flv且具备 nginx-rtmp-module的功能。</p><p>依然采用挂载的方式，在虚拟机本地创建目录</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token punctuation">\</span>  ~/Desktop/docker/projects/nginx-flv/<span class="token punctuation">&#123;</span>config,data/hls,data/recordings,dist,logs,certs<span class="token punctuation">&#125;</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>开启HTTPS 服务生成，自签名证书</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">openssl req <span class="token parameter variable">-x509</span> <span class="token parameter variable">-nodes</span> <span class="token parameter variable">-days</span> <span class="token number">365</span> <span class="token parameter variable">-newkey</span> rsa:2048 <span class="token punctuation">\</span>  <span class="token parameter variable">-keyout</span> certs/key.pem <span class="token punctuation">\</span>  <span class="token parameter variable">-out</span> certs/cert.pem <span class="token punctuation">\</span>  <span class="token parameter variable">-subj</span> <span class="token string">"/CN=localhost"</span> <span class="token punctuation">\</span>  <span class="token parameter variable">-addext</span> <span class="token string">"subjectAltName=DNS:localhost,IP:192.168.217.130"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>编写Dockerfile</p><pre class="line-numbers language-docker" data-language="docker"><code class="language-docker"><span class="token comment"># 使用多阶段构建减小镜像体积</span><span class="token instruction"><span class="token keyword">FROM</span> alpine:3.18 <span class="token keyword">AS</span> builder</span><span class="token comment"># 安装编译依赖</span><span class="token instruction"><span class="token keyword">RUN</span> apk add --no-cache <span class="token operator">\</span>    build-base <span class="token operator">\</span>    pcre-dev <span class="token operator">\</span>    openssl-dev <span class="token operator">\</span>    zlib-dev <span class="token operator">\</span>    git</span><span class="token comment"># 下载 Nginx 和模块源码</span><span class="token instruction"><span class="token keyword">RUN</span> git clone https://github.com/winshining/nginx-http-flv-module.git &amp;&amp; <span class="token operator">\</span>    wget http://nginx.org/download/nginx-1.25.3.tar.gz &amp;&amp; <span class="token operator">\</span>    tar -zxvf nginx-1.25.3.tar.gz</span><span class="token comment"># 编译 Nginx (包含 RTMP 和 FLV 模块)</span><span class="token instruction"><span class="token keyword">WORKDIR</span> /nginx-1.25.3</span><span class="token instruction"><span class="token keyword">RUN</span> ./configure <span class="token operator">\</span>    --prefix=/usr/local/nginx <span class="token operator">\</span>    --with-http_ssl_module <span class="token operator">\</span>    --with-http_stub_status_module <span class="token operator">\</span>    --with-http_realip_module <span class="token operator">\</span>    --with-http_auth_request_module <span class="token operator">\</span>    --with-http_v2_module <span class="token operator">\</span>    --with-http_dav_module <span class="token operator">\</span>    --with-http_slice_module <span class="token operator">\</span>    --with-threads <span class="token operator">\</span>    --with-http_addition_module <span class="token operator">\</span>    --with-http_gunzip_module <span class="token operator">\</span>    --with-http_gzip_static_module<span class="token operator">\</span>    --add-module=../nginx-http-flv-module &amp;&amp; <span class="token operator">\</span>    make -j$(nproc) &amp;&amp; <span class="token operator">\</span>    make install</span><span class="token comment"># 构建最终镜像</span><span class="token instruction"><span class="token keyword">FROM</span> alpine:3.18</span><span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">builder</span></span> /usr/local/nginx /usr/local/nginx</span><span class="token comment"># 安装运行时依赖</span><span class="token instruction"><span class="token keyword">RUN</span> apk add --no-cache pcre openssl zlib &amp;&amp; <span class="token operator">\</span>    mkdir -p /tmp/hls /var/log/nginx &amp;&amp; <span class="token operator">\</span>    chmod 755 /tmp/hls &amp;&amp; <span class="token operator">\</span>    rm -rf /var/cache/apk/*</span>    <span class="token comment"># 设置环境变量</span><span class="token instruction"><span class="token keyword">ENV</span> PATH=<span class="token string">"/usr/local/nginx/sbin:$&#123;PATH&#125;"</span> <span class="token operator">\</span>    NGINX_LOG_DIR=<span class="token string">"/var/log/nginx"</span></span>    <span class="token comment"># 暴露端口</span><span class="token instruction"><span class="token keyword">EXPOSE</span> 1935 80 443</span><span class="token comment"># 启动命令</span><span class="token instruction"><span class="token keyword">CMD</span> [<span class="token string">"/usr/local/nginx/sbin/nginx"</span>, <span class="token string">"-g"</span>, <span class="token string">"daemon off;"</span>]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>构建镜像</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> build <span class="token parameter variable">-t</span> nginx-flv <span class="token builtin class-name">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="配置"><a class="markdownIt-Anchor" href="#配置"></a> 配置</h3><p>编写nginx.conf</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">worker_processes auto<span class="token punctuation">;</span>events <span class="token punctuation">&#123;</span>    worker_connections <span class="token number">1024</span><span class="token punctuation">;</span>    use epoll<span class="token punctuation">;</span><span class="token punctuation">&#125;</span>http <span class="token punctuation">&#123;</span>    include mime.types<span class="token punctuation">;</span>    default_type application/octet-stream<span class="token punctuation">;</span>        sendfile on<span class="token punctuation">;</span>    tcp_nopush on<span class="token punctuation">;</span>    tcp_nodelay on<span class="token punctuation">;</span>    keepalive_timeout <span class="token number">65</span><span class="token punctuation">;</span>    server <span class="token punctuation">&#123;</span>     listen <span class="token number">443</span> ssl<span class="token punctuation">;</span>  <span class="token comment"># 启用 HTTPS</span>        ssl_certificate      /etc/nginx/certs/cert.pem<span class="token punctuation">;</span>        ssl_certificate_key  /etc/nginx/certs/key.pem<span class="token punctuation">;</span>        root /usr/share/nginx/html<span class="token punctuation">;</span>        index index.html<span class="token punctuation">;</span>                location / <span class="token punctuation">&#123;</span>            root /usr/share/nginx/html<span class="token punctuation">;</span>            try_files <span class="token variable">$uri</span> <span class="token variable">$uri</span>/ /index.html<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment"># HLS 端点</span>        location /hls <span class="token punctuation">&#123;</span>            <span class="token builtin class-name">alias</span> /tmp/hls<span class="token punctuation">;</span>    types <span class="token punctuation">&#123;</span>application/vnd.apple.mpegurl m3u8<span class="token punctuation">;</span>video/mp2t ts<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    add_header Cache-Control no-cache<span class="token punctuation">;</span>    add_header Access-Control-Allow-Origin *<span class="token punctuation">;</span>    add_header Access-Control-Allow-Methods GET,OPTIONS<span class="token punctuation">;</span>    add_header Access-Control-Allow-Headers *<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment"># HTTP-FLV 播放端点</span>        location /live <span class="token punctuation">&#123;</span>            flv_live on<span class="token punctuation">;</span>    add_header Access-Control-Allow-Origin *<span class="token punctuation">;</span>    add_header Access-Control-Allow-Methods GET,OPTIONS<span class="token punctuation">;</span>    add_header Access-Control-Allow-Headers *<span class="token punctuation">;</span>    add_header Access-Control-Allow-Credentials <span class="token boolean">true</span><span class="token punctuation">;</span>    chunked_transfer_encoding on<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment"># 状态监控端点</span>        location /stat <span class="token punctuation">&#123;</span>            rtmp_stat all<span class="token punctuation">;</span>            rtmp_stat_stylesheet stat.xsl<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        location /stat.xsl <span class="token punctuation">&#123;</span>            root /usr/local/nginx/conf<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    server <span class="token punctuation">&#123;</span>        listen <span class="token number">80</span><span class="token punctuation">;</span>        server_name localhost<span class="token punctuation">;</span>        <span class="token builtin class-name">return</span> <span class="token number">301</span> https://<span class="token variable">$host</span><span class="token variable">$request_uri</span><span class="token punctuation">;</span>  <span class="token comment"># HTTP 强制跳转 HTTPS</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>rtmp_auto_push on<span class="token punctuation">;</span>rtmp_auto_push_reconnect 1s<span class="token punctuation">;</span>rtmp <span class="token punctuation">&#123;</span>    out_queue           <span class="token number">4096</span><span class="token punctuation">;</span>    out_cork            <span class="token number">8</span><span class="token punctuation">;</span>    max_streams         <span class="token number">128</span><span class="token punctuation">;</span>    <span class="token function">timeout</span>             15s<span class="token punctuation">;</span>    drop_idle_publisher 15s<span class="token punctuation">;</span>    log_interval 5s<span class="token punctuation">;</span> <span class="token comment">#log模块在access.log中记录日志的间隔时间，对调试非常有用</span>    log_size     1m<span class="token punctuation">;</span> <span class="token comment">#log模块用来记录日志的缓冲区大小</span>    server <span class="token punctuation">&#123;</span>        listen <span class="token number">1935</span><span class="token punctuation">;</span>        chunk_size <span class="token number">4096</span><span class="token punctuation">;</span>        <span class="token function">ping</span> 30s<span class="token punctuation">;</span>        notify_method get<span class="token punctuation">;</span>        application live <span class="token punctuation">&#123;</span>            live on<span class="token punctuation">;</span>            meta off<span class="token punctuation">;</span>                        <span class="token comment"># HLS 配置</span>            hls on<span class="token punctuation">;</span>            hls_path /tmp/hls<span class="token punctuation">;</span>            hls_fragment 2s<span class="token punctuation">;</span>       <span class="token comment"># 切片时长至少1秒，建议2秒</span>            hls_playlist_length 6s<span class="token punctuation">;</span> <span class="token comment"># 播放列表保留3个切片</span>            hls_sync 100ms<span class="token punctuation">;</span>            hls_base_url /hls/<span class="token punctuation">;</span>            hls_cleanup on<span class="token punctuation">;</span>       <span class="token comment"># 自动清理旧切片</span>            hls_continuous on<span class="token punctuation">;</span>    <span class="token comment"># 连续模式（避免播放中断）</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>编写 index.html</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>zh-CN<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>直播监控<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/css/video-js.min.css<span class="token punctuation">"</span></span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style"><span class="token language-css">        <span class="token comment">/* 容器样式 */</span>        <span class="token selector">.player-container</span> <span class="token punctuation">&#123;</span>            <span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span>            <span class="token property">gap</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span> <span class="token comment">/* 播放器间距 */</span>            <span class="token property">padding</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span>            <span class="token property">max-width</span><span class="token punctuation">:</span> 1600px<span class="token punctuation">;</span> <span class="token comment">/* 最大宽度限制 */</span>            <span class="token property">margin</span><span class="token punctuation">:</span> 0 auto<span class="token punctuation">;</span> <span class="token comment">/* 居中 */</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">/* 单个播放器包装 */</span>        <span class="token selector">.player-wrapper</span> <span class="token punctuation">&#123;</span>            <span class="token property">flex</span><span class="token punctuation">:</span> 1<span class="token punctuation">;</span> <span class="token comment">/* 等分剩余空间 */</span>            <span class="token property">min-width</span><span class="token punctuation">:</span> 300px<span class="token punctuation">;</span> <span class="token comment">/* 最小宽度防止挤压 */</span>            <span class="token property">background</span><span class="token punctuation">:</span> #f5f5f5<span class="token punctuation">;</span>            <span class="token property">border-radius</span><span class="token punctuation">:</span> 8px<span class="token punctuation">;</span>            <span class="token property">padding</span><span class="token punctuation">:</span> 15px<span class="token punctuation">;</span>            <span class="token property">box-shadow</span><span class="token punctuation">:</span> 0 4px 6px <span class="token function">rgba</span><span class="token punctuation">(</span>0<span class="token punctuation">,</span>0<span class="token punctuation">,</span>0<span class="token punctuation">,</span>0.1<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">/* 视频元素自适应 */</span>        <span class="token selector">.video-js, #videoElement</span> <span class="token punctuation">&#123;</span>            <span class="token property">width</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>            <span class="token property">height</span><span class="token punctuation">:</span> auto<span class="token punctuation">;</span>            <span class="token property">border-radius</span><span class="token punctuation">:</span> 4px<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">/* 标题样式 */</span>        <span class="token selector">h3</span> <span class="token punctuation">&#123;</span>            <span class="token property">margin</span><span class="token punctuation">:</span> 0 0 10px 0<span class="token punctuation">;</span>            <span class="token property">color</span><span class="token punctuation">:</span> #333<span class="token punctuation">;</span>            <span class="token property">font-size</span><span class="token punctuation">:</span> 1.2em<span class="token punctuation">;</span>            <span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">/* 移动端适配 */</span>        <span class="token atrule"><span class="token rule">@media</span> <span class="token punctuation">(</span><span class="token property">max-width</span><span class="token punctuation">:</span> 768px<span class="token punctuation">)</span></span> <span class="token punctuation">&#123;</span>            <span class="token selector">.player-container</span> <span class="token punctuation">&#123;</span>                <span class="token property">flex-direction</span><span class="token punctuation">:</span> column<span class="token punctuation">;</span> <span class="token comment">/* 小屏幕垂直排列 */</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>    <span class="token comment">&lt;!-- 播放器容器 --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>player-container<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token comment">&lt;!-- HLS 播放器 --></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>player-wrapper<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>HLS 直播流<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>video</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hlsPlayer<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>video-js vjs-default-skin<span class="token punctuation">"</span></span> <span class="token attr-name">controls</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/hls/stream.m3u8<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>application/vnd.apple.mpegurl<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>video</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token comment">&lt;!-- FLV 播放器 --></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>player-wrapper<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>FLV 低延迟流<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>video</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>videoElement<span class="token punctuation">"</span></span> <span class="token attr-name">controls</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>video</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token comment">&lt;!-- 依赖库 --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/js/video.min.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/js/flv.min.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">        <span class="token comment">// HLS播放器初始化</span>        <span class="token keyword">const</span> hlsPlayer <span class="token operator">=</span> <span class="token function">videojs</span><span class="token punctuation">(</span><span class="token string">'hlsPlayer'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>            <span class="token literal-property property">autoplay</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>            <span class="token literal-property property">fluid</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>            <span class="token literal-property property">techOrder</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'html5'</span><span class="token punctuation">]</span>  <span class="token comment">// 强制使用HTML5模式</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// flv播放器初始化</span>        <span class="token keyword">const</span> videoElement <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'videoElement'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">const</span> flvPlayer <span class="token operator">=</span> flvjs<span class="token punctuation">.</span><span class="token function">createPlayer</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'flv'</span><span class="token punctuation">,</span>    <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">'/live?app=live&amp;stream=stream'</span><span class="token punctuation">,</span>    <span class="token literal-property property">isLive</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    <span class="token literal-property property">hasAudio</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>    <span class="token literal-property property">stashInitialSize</span><span class="token operator">:</span> <span class="token number">128</span><span class="token punctuation">,</span>    <span class="token literal-property property">withCredentials</span><span class="token operator">:</span> <span class="token boolean">true</span>  <span class="token comment">// 允许跨域带凭证</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        flvPlayer<span class="token punctuation">.</span><span class="token function">attachMediaElement</span><span class="token punctuation">(</span>videoElement<span class="token punctuation">)</span><span class="token punctuation">;</span>        flvPlayer<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        flvPlayer<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>使用docker compose构建容器</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">services</span><span class="token punctuation">:</span>  <span class="token key atrule">nginx-flv</span><span class="token punctuation">:</span>    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>flv<span class="token punctuation">:</span>latest    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>flv    <span class="token key atrule">restart</span><span class="token punctuation">:</span> unless<span class="token punctuation">-</span>stopped    <span class="token key atrule">ports</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token string">"1935:1935"</span>  <span class="token comment"># RTMP协议端口</span>      <span class="token punctuation">-</span> <span class="token string">"80:80"</span>      <span class="token comment"># HTTP协议端口</span>      <span class="token punctuation">-</span> <span class="token string">"443:443"</span>    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> ./config/nginx.conf<span class="token punctuation">:</span>/usr/local/nginx/conf/nginx.conf  <span class="token comment"># 修正配置文件路径</span>      <span class="token punctuation">-</span> ./data/hls<span class="token punctuation">:</span>/tmp/hls      <span class="token punctuation">-</span> ./data/recordings<span class="token punctuation">:</span>/tmp/recordings      <span class="token punctuation">-</span> ./logs<span class="token punctuation">:</span>/var/log/nginx      <span class="token punctuation">-</span> ./dist<span class="token punctuation">:</span>/usr/share/nginx/html  <span class="token comment"># 静态文件目录</span>      <span class="token punctuation">-</span> ./certs<span class="token punctuation">:</span>/etc/nginx/certs  <span class="token comment"># 挂载证书目录</span>    <span class="token key atrule">environment</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> TZ=Asia/Shanghai<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>使用ffmpeg进行推流</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span><span class="token comment"># 推流参数配置</span><span class="token assign-left variable">INPUT_DEVICE</span><span class="token operator">=</span><span class="token string">"/dev/video0"</span>                              <span class="token comment"># 摄像头设备</span><span class="token assign-left variable">RTMP_URL</span><span class="token operator">=</span><span class="token string">"rtmp://192.168.217.130/live/stream"</span>       <span class="token comment"># 流名称需匹配前端播放器</span><span class="token assign-left variable">RESOLUTION</span><span class="token operator">=</span><span class="token string">"640x480"</span>                                   <span class="token comment"># 建议分辨率</span><span class="token assign-left variable">FPS</span><span class="token operator">=</span><span class="token number">15</span>                                                  <span class="token comment"># 帧率</span><span class="token assign-left variable">BITRATE</span><span class="token operator">=</span><span class="token string">"2000k"</span>                                         <span class="token comment"># 码率</span>ffmpeg <span class="token punctuation">\</span>  <span class="token parameter variable">-f</span> v4l2 <span class="token punctuation">\</span>  <span class="token parameter variable">-input_format</span> yuyv422 <span class="token punctuation">\</span>  <span class="token parameter variable">-video_size</span> <span class="token variable">$RESOLUTION</span> <span class="token punctuation">\</span>  <span class="token parameter variable">-framerate</span> <span class="token variable">$FPS</span> <span class="token punctuation">\</span>  <span class="token parameter variable">-i</span> <span class="token string">"<span class="token variable">$INPUT_DEVICE</span>"</span> <span class="token punctuation">\</span>  <span class="token parameter variable">-vf</span> <span class="token string">"format=yuv420p"</span> <span class="token punctuation">\</span>  <span class="token parameter variable">-c:v</span> libx264 <span class="token punctuation">\</span>  <span class="token parameter variable">-profile:v</span> main <span class="token punctuation">\</span>  <span class="token parameter variable">-preset</span> ultrafast <span class="token punctuation">\</span>  <span class="token parameter variable">-tune</span> zerolatency <span class="token punctuation">\</span>  -x264-params <span class="token string">"keyint=60:min-keyint=30:no-scenecut=1"</span> <span class="token punctuation">\</span>  <span class="token parameter variable">-b:v</span> <span class="token variable">$BITRATE</span> <span class="token punctuation">\</span>  <span class="token parameter variable">-maxrate</span> <span class="token variable">$BITRATE</span> <span class="token punctuation">\</span>  <span class="token parameter variable">-minrate</span> <span class="token variable">$BITRATE</span> <span class="token punctuation">\</span>  <span class="token parameter variable">-f</span> flv <span class="token punctuation">\</span>  <span class="token string">"<span class="token variable">$RTMP_URL</span>"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="运行容器"><a class="markdownIt-Anchor" href="#运行容器"></a> 运行容器</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> compose up <span class="token parameter variable">-d</span><span class="token comment">#删除并运行（更新文件后）</span><span class="token function">docker</span> compose down <span class="token parameter variable">-v</span> <span class="token operator">&amp;&amp;</span> <span class="token function">docker</span> compose up <span class="token parameter variable">-d</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="效果"><a class="markdownIt-Anchor" href="#效果"></a> 效果</h3><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/202505172013321.png" alt="image-20250517201341792" /></p><h2 id="有哪些坑"><a class="markdownIt-Anchor" href="#有哪些坑"></a> 有哪些坑？</h2><blockquote><p><code>访问页面只显示nginx的官方页面，自己的index.html未生效，但是已经挂载了(可以进入容器内查看)</code> —&gt; 文件或文件夹权限问题。</p><pre class="line-numbers language-none"><code class="language-none"># 进入容器检查挂载目录docker exec -it nginx-flv ls -l &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html# 预期输出total 12-rw-r--r-- 1 root root  537 index.htmldrwxr-xr-x 2 root root 4096 cssdrwxr-xr-x 2 root root 4096 js# 修补措施# 在宿主机执行（假设挂载目录为 .&#x2F;html）chmod -R 755 .&#x2F;html      # 目录权限find .&#x2F;html -type f -exec chmod 644 &#123;&#125; \;  # 文件权限<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></blockquote><blockquote><p><code>如果docker ps 后发现没有端口信息，应该是出错了。使用 docker logs 容器id 查看错误信息</code></p><p>例如</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/202505171614609.png" alt="image-20250517161421511" /></p></blockquote><blockquote><p>index.html文件中的视频地址如果采用ip+路径的形式，会存在跨域问题，为了简单，直接使用了相对地址</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 部署 </category>
          
          <category> 流媒体 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Docker </tag>
            
            <tag> Nginx </tag>
            
            <tag> RTMP </tag>
            
            <tag> HLS </tag>
            
            <tag> HTTP-FLV </tag>
            
            <tag> FFmpeg </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>搭建Nginx-RTMP流媒体服务器</title>
      <link href="/2025/05/21/%E6%90%AD%E5%BB%BANginx-RTMP%E6%B5%81%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1%E5%99%A8/"/>
      <url>/2025/05/21/%E6%90%AD%E5%BB%BANginx-RTMP%E6%B5%81%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1%E5%99%A8/</url>
      
        <content type="html"><![CDATA[<h2 id="搭建nginx-rtmp"><a class="markdownIt-Anchor" href="#搭建nginx-rtmp"></a> 搭建Nginx-RTMP</h2><blockquote><p>该服务器仅支持HLS, 不支持HTTP-FLV, 如果要使用HTTP-FLV协议请前往 <a href="/2025/05/21/%E6%90%AD%E5%BB%BANginx-FLV%E6%B5%81%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1%E5%99%A8/" title="搭建Nginx-FLV流媒体服务器">搭建Nginx-FLV流媒体服务器</a><br />查看更多信息请前往 <a href="https://github.com/zikcc/nginx-streaming-demos">github: nginx-streaming-demos</a></p></blockquote><h3 id="准备工作"><a class="markdownIt-Anchor" href="#准备工作"></a> 准备工作</h3><ol><li><p>安装docker</p> <a href="/2025/05/21/ubuntu22-04%E5%AE%89%E8%A3%85docker/" title="ubuntu22.04安装docker">安装教程</a></li><li><p>安装ffmpeg:</p> <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> update<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> ffmpeg<span class="token comment"># 查看版本</span>ffmpeg <span class="token parameter variable">-version</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>采用文件挂载的方式修改docker容器(可选):<br />为了综合管理以后的多个docker容器，在本地ubuntu中创建以下文件结构，以后将这些目录挂载到docker容器上。</p> <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token punctuation">\</span>~/Desktop/docker/projects/nginx-rtmp/<span class="token punctuation">&#123;</span>config,data/hls,data/recordings,dist,logs<span class="token punctuation">&#125;</span>/home/lzk/Desktop/docker/├── projects/                    <span class="token comment"># 所有Docker项目</span>├── nginx-rtmp/               <span class="token comment"># 流媒体服务</span>        ├── config/            <span class="token comment"># Nginx配置</span>        │   └── nginx.conf        ├── data/              <span class="token comment"># 持久化数据</span>        │   ├── hls/           <span class="token comment"># HLS切片</span>        │   └── recordings/    <span class="token comment"># 录像文件</span>        ├── logs/              <span class="token comment"># 日志文件</span>        ├── dist/              <span class="token comment"># 前端编译后的静态文件</span>        └── docker-compose.yml         <span class="token comment"># 主编排文件</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><h3 id="拉取镜像"><a class="markdownIt-Anchor" href="#拉取镜像"></a> 拉取镜像</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> pull tiangolo/nginx-rtmp:latest<span class="token comment">#查看</span><span class="token function">docker</span> images<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>使用Docker命令运行Nginx-RTMP容器，并映射好必要的端口（如RTMP协议的1935端口和HTTP协议的80端口）。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">-p</span> <span class="token number">1935</span>:1935 <span class="token parameter variable">-p</span> <span class="token number">80</span>:80 <span class="token parameter variable">--name</span> nginx-rtmp tiangolo/nginx-rtmp:latest<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>直接在容器中修改配置文件，可能会由于容器重启或删除而失效。故采用-v挂载的方式。</p><p>复制配置文件</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> <span class="token function">cp</span> nginx-rtmp:/etc/nginx/nginx.conf ~/Desktop/docker/projects/nginx-rtmp/config/<span class="token comment"># 删除这个容器，后面再启动</span><span class="token function">docker</span> <span class="token function">rm</span> <span class="token parameter variable">-f</span> nginx-rtmp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="修改nignxconf配置文件"><a class="markdownIt-Anchor" href="#修改nignxconf配置文件"></a> 修改nignx.conf配置文件</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">worker_processes auto<span class="token punctuation">;</span>events <span class="token punctuation">&#123;</span>    worker_connections <span class="token number">1024</span><span class="token punctuation">;</span>    use epoll<span class="token punctuation">;</span><span class="token punctuation">&#125;</span>rtmp <span class="token punctuation">&#123;</span>    server <span class="token punctuation">&#123;</span>        listen <span class="token number">1935</span><span class="token punctuation">;</span>        chunk_size <span class="token number">8192</span><span class="token punctuation">;</span>        max_streams <span class="token number">64</span><span class="token punctuation">;</span>        ack_window <span class="token number">5000000</span><span class="token punctuation">;</span>  <span class="token comment"># 合理ACK窗口大小</span>                application live <span class="token punctuation">&#123;</span>            live on<span class="token punctuation">;</span>            meta off<span class="token punctuation">;</span>         <span class="token comment"># 禁用元数据缓存</span>                        <span class="token comment"># HLS低延迟优化</span>            hls on<span class="token punctuation">;</span>            hls_path /tmp/hls<span class="token punctuation">;</span>            hls_fragment 1s<span class="token punctuation">;</span>     <span class="token comment"># 切片时长1s</span>            hls_playlist_length 3s<span class="token punctuation">;</span> <span class="token comment"># 播放列表保留3秒切片</span>            hls_sync 100ms<span class="token punctuation">;</span>         <span class="token comment"># 音视频同步阈值</span>            hls_base_url /hls/<span class="token punctuation">;</span>  <span class="token comment"># HLS访问路径</span>                        <span class="token comment"># 关键帧间隔优化</span>            wait_key off<span class="token punctuation">;</span>    <span class="token comment"># 不等待关键帧</span>            idle_streams off<span class="token punctuation">;</span>                  <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>http <span class="token punctuation">&#123;</span>    include mime.types<span class="token punctuation">;</span>    default_type application/octet-stream<span class="token punctuation">;</span>        sendfile on<span class="token punctuation">;</span>    tcp_nopush on<span class="token punctuation">;</span>    tcp_nodelay on<span class="token punctuation">;</span>    keepalive_timeout <span class="token number">65</span><span class="token punctuation">;</span>    server <span class="token punctuation">&#123;</span>        listen <span class="token number">80</span><span class="token punctuation">;</span>        server_name localhost<span class="token punctuation">;</span>root /usr/share/nginx/html<span class="token punctuation">;</span>  <span class="token comment"># 必须与挂载路径一致</span>        index index.html<span class="token punctuation">;</span>                location / <span class="token punctuation">&#123;</span>            try_files <span class="token variable">$uri</span> <span class="token variable">$uri</span>/ /index.html<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>                <span class="token comment"># HLS端点（极低延迟配置）</span>        location /hls <span class="token punctuation">&#123;</span>            <span class="token builtin class-name">alias</span> /tmp/hls<span class="token punctuation">;</span>            types <span class="token punctuation">&#123;</span>                application/vnd.apple.mpegurl m3u8<span class="token punctuation">;</span>                video/mp2t ts<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment"># 状态监控端点</span>        location /stat <span class="token punctuation">&#123;</span>            rtmp_stat all<span class="token punctuation">;</span>            rtmp_stat_stylesheet stat.xsl<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        location /stat.xsl <span class="token punctuation">&#123;</span>            root /usr/local/nginx/conf<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="indexhtml"><a class="markdownIt-Anchor" href="#indexhtml"></a> index.html</h3><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>zh-CN<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>直播监控<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/css/video-js.min.css<span class="token punctuation">"</span></span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>    <span class="token comment">&lt;!-- HLS播放器 --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">margin</span><span class="token punctuation">:</span>20px<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>HLS直播流<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>video</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hlsPlayer<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>video-js vjs-default-skin<span class="token punctuation">"</span></span> <span class="token attr-name">controls</span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1024<span class="token punctuation">"</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>576<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/hls/stream.m3u8<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>application/vnd.apple.mpegurl<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>video</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token comment">&lt;!-- 依赖库 --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/js/video.min.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">        <span class="token comment">// HLS播放器初始化</span>        <span class="token keyword">const</span> hlsPlayer <span class="token operator">=</span> <span class="token function">videojs</span><span class="token punctuation">(</span><span class="token string">'hlsPlayer'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>            <span class="token literal-property property">autoplay</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>            <span class="token literal-property property">fluid</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>            <span class="token literal-property property">techOrder</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'html5'</span><span class="token punctuation">]</span>  <span class="token comment">// 强制使用HTML5模式</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="编写-docker-composeyml"><a class="markdownIt-Anchor" href="#编写-docker-composeyml"></a> 编写 docker-compose.yml</h3><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">services</span><span class="token punctuation">:</span>  <span class="token key atrule">nginx-rtmp</span><span class="token punctuation">:</span>    <span class="token key atrule">image</span><span class="token punctuation">:</span> tiangolo/nginx<span class="token punctuation">-</span>rtmp<span class="token punctuation">:</span>latest    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>rtmp    <span class="token key atrule">restart</span><span class="token punctuation">:</span> unless<span class="token punctuation">-</span>stopped    <span class="token key atrule">ports</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token string">"1935:1935"</span>  <span class="token comment"># RTMP协议端口</span>      <span class="token punctuation">-</span> <span class="token string">"80:80"</span>      <span class="token comment"># HTTP协议端口</span>    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> ./config/nginx.conf<span class="token punctuation">:</span>/etc/nginx/nginx.conf     <span class="token comment"># 配置文件</span>      <span class="token punctuation">-</span> ./data/hls<span class="token punctuation">:</span>/tmp/hls                          <span class="token comment"># HLS切片存储</span>      <span class="token punctuation">-</span> ./data/recordings<span class="token punctuation">:</span>/tmp/recordings            <span class="token comment"># 录像文件存储</span>      <span class="token punctuation">-</span> ./logs<span class="token punctuation">:</span>/var/log/nginx                        <span class="token comment"># 日志文件</span>      <span class="token punctuation">-</span> ./dist<span class="token punctuation">:</span>/usr/share/nginx/html                 <span class="token comment"># 前端编译文件</span>    <span class="token key atrule">environment</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> TZ=Asia/Shanghai                             <span class="token comment"># 时区设置</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="启动服务"><a class="markdownIt-Anchor" href="#启动服务"></a> 启动服务</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 安装docker-compose</span><span class="token function">sudo</span> <span class="token function">apt</span>  <span class="token function">install</span> <span class="token function">docker-compose</span><span class="token comment"># 进入项目目录</span><span class="token builtin class-name">cd</span> ~/Desktop/docker/projects/nginx-rtmp<span class="token comment"># 启动容器（后台模式）</span><span class="token function">docker</span> compose up <span class="token parameter variable">-d</span><span class="token comment"># 查看运行状态</span><span class="token function">docker-compose</span> <span class="token function">ps</span><span class="token comment"># 应显示状态为 Up</span><span class="token comment"># 如果修改了本地文件则需要重新启动</span><span class="token function">docker</span> compose down <span class="token parameter variable">-v</span> <span class="token operator">&amp;&amp;</span> <span class="token function">docker</span> compose up <span class="token parameter variable">-d</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="验证挂载结果"><a class="markdownIt-Anchor" href="#验证挂载结果"></a> 验证挂载结果</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 检查配置文件同步</span><span class="token function">docker</span> <span class="token builtin class-name">exec</span> nginx-rtmp <span class="token function">ls</span> <span class="token parameter variable">-l</span> /etc/nginx/<span class="token comment"># 应看到nginx.conf的修改时间为当前时间</span><span class="token comment"># 查看HLS目录权限</span><span class="token function">docker</span> <span class="token builtin class-name">exec</span> nginx-rtmp <span class="token function">ls</span> <span class="token parameter variable">-ld</span> /tmp/hls<span class="token comment"># 应显示权限为 drwxr-xr-x</span><span class="token comment"># 验证dist文件挂载</span><span class="token function">docker</span> <span class="token builtin class-name">exec</span> nginx-rtmp <span class="token function">ls</span> /usr/share/nginx/html<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ubuntu主机开放端口</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> ufw allow <span class="token number">80</span>/tcp<span class="token function">sudo</span> ufw allow <span class="token number">1935</span>/tcp<span class="token function">sudo</span> ufw reload<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="推流测试"><a class="markdownIt-Anchor" href="#推流测试"></a> 推流测试</h3><p>命令行形式：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 延迟 45 秒</span>ffmpeg <span class="token parameter variable">-f</span> v4l2 <span class="token parameter variable">-input_format</span> yuyv422 <span class="token parameter variable">-i</span> /dev/video0 <span class="token punctuation">\</span>  <span class="token parameter variable">-c:v</span> libx264 <span class="token parameter variable">-preset</span> ultrafast <span class="token parameter variable">-tune</span> zerolatency <span class="token punctuation">\</span>  <span class="token parameter variable">-f</span> flv rtmp://192.168.217.130/live/stream<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>使用脚本，创建 push_stream.sh</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span><span class="token assign-left variable">INPUT_DEVICE</span><span class="token operator">=</span><span class="token string">"/dev/video0"</span><span class="token assign-left variable">RTMP_URL</span><span class="token operator">=</span><span class="token string">"rtmp://192.168.217.130/live/stream"</span>  ffmpeg <span class="token punctuation">\</span>  <span class="token parameter variable">-f</span> v4l2 <span class="token punctuation">\</span>  <span class="token parameter variable">-input_format</span> yuyv422 <span class="token punctuation">\</span>  <span class="token parameter variable">-video_size</span> 640x480 <span class="token punctuation">\</span>  <span class="token parameter variable">-framerate</span> <span class="token number">30</span> <span class="token punctuation">\</span>  <span class="token parameter variable">-i</span> <span class="token string">"<span class="token variable">$INPUT_DEVICE</span>"</span> <span class="token punctuation">\</span>  <span class="token parameter variable">-vf</span> <span class="token string">"format=yuv420p"</span> <span class="token punctuation">\</span>  <span class="token parameter variable">-c:v</span> libx264 <span class="token punctuation">\</span>  <span class="token parameter variable">-profile:v</span> baseline <span class="token punctuation">\</span>  <span class="token parameter variable">-level</span> <span class="token number">3.1</span> <span class="token punctuation">\</span>  <span class="token parameter variable">-preset</span> ultrafast <span class="token punctuation">\</span>  <span class="token parameter variable">-tune</span> zerolatency <span class="token punctuation">\</span>  -x264-params <span class="token string">"keyint=30:min-keyint=30:no-scenecut=1"</span> <span class="token punctuation">\</span>  <span class="token parameter variable">-b:v</span> 1M <span class="token punctuation">\</span>  <span class="token parameter variable">-maxrate</span> 1M <span class="token punctuation">\</span>  <span class="token parameter variable">-minrate</span> 1M <span class="token punctuation">\</span>  <span class="token parameter variable">-f</span> flv <span class="token punctuation">\</span>  <span class="token string">"<span class="token variable">$RTMP_URL</span>"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>进入浏览器查看</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">http://localhost:80<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 部署 </category>
          
          <category> 流媒体 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Docker </tag>
            
            <tag> Nginx </tag>
            
            <tag> RTMP </tag>
            
            <tag> HLS </tag>
            
            <tag> FFmpeg </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ubuntu22.04安装docker</title>
      <link href="/2025/05/21/ubuntu22-04%E5%AE%89%E8%A3%85docker/"/>
      <url>/2025/05/21/ubuntu22-04%E5%AE%89%E8%A3%85docker/</url>
      
        <content type="html"><![CDATA[<h2 id="安装docker"><a class="markdownIt-Anchor" href="#安装docker"></a> 安装docker</h2><p>虚拟机 ubuntu 22.04 安装 docker</p><h3 id="准备工作"><a class="markdownIt-Anchor" href="#准备工作"></a> 准备工作</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#安装前先卸载操作系统默认安装的docker，</span><span class="token function">sudo</span> <span class="token function">apt-get</span> remove <span class="token function">docker</span> docker-engine docker.io containerd runc<span class="token comment">#安装必要支持</span><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> apt-transport-https ca-certificates <span class="token function">curl</span> software-properties-common gnupg lsb-release<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="添加源"><a class="markdownIt-Anchor" href="#添加源"></a> 添加源</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#添加 Docker 官方 GPG key （可能国内现在访问会存在问题）</span><span class="token function">curl</span> <span class="token parameter variable">-fsSL</span> https://download.docker.com/linux/ubuntu/gpg <span class="token operator">|</span> <span class="token function">sudo</span> gpg <span class="token parameter variable">--dearmor</span> <span class="token parameter variable">-o</span> /usr/share/keyrings/docker-archive-keyring.gpg<span class="token comment"># 阿里源（推荐使用阿里的gpg KEY）</span><span class="token function">curl</span> <span class="token parameter variable">-fsSL</span> https://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg <span class="token operator">|</span> <span class="token function">sudo</span> gpg <span class="token parameter variable">--dearmor</span> <span class="token parameter variable">-o</span> /usr/share/keyrings/docker-archive-keyring.gpg<span class="token comment">#添加 apt 源:</span><span class="token comment">#Docker官方源</span><span class="token builtin class-name">echo</span> <span class="token string">"deb [arch=<span class="token variable"><span class="token variable">$(</span>dpkg --print-architecture<span class="token variable">)</span></span> signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu <span class="token variable"><span class="token variable">$(</span>lsb_release <span class="token parameter variable">-cs</span><span class="token variable">)</span></span> stable"</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/apt/sources.list.d/docker.list <span class="token operator">></span> /dev/null<span class="token comment">#阿里apt源</span><span class="token builtin class-name">echo</span> <span class="token string">"deb [arch=<span class="token variable"><span class="token variable">$(</span>dpkg --print-architecture<span class="token variable">)</span></span> signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://mirrors.aliyun.com/docker-ce/linux/ubuntu <span class="token variable"><span class="token variable">$(</span>lsb_release <span class="token parameter variable">-cs</span><span class="token variable">)</span></span> stable"</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/apt/sources.list.d/docker.list <span class="token operator">></span> /dev/null<span class="token comment">#更新源</span><span class="token function">sudo</span> <span class="token function">apt</span> update<span class="token function">sudo</span> <span class="token function">apt-get</span> update<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="安装最新版docker"><a class="markdownIt-Anchor" href="#安装最新版docker"></a> 安装最新版docker</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#安装最新版本的Docker</span><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> docker-ce docker-ce-cli containerd.io<span class="token comment">#等待安装完成</span><span class="token comment">#查看Docker版本</span><span class="token function">sudo</span> <span class="token function">docker</span> version<span class="token comment">#查看Docker运行状态</span><span class="token function">sudo</span> systemctl status <span class="token function">docker</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="不想-sudo-docker"><a class="markdownIt-Anchor" href="#不想-sudo-docker"></a> 不想 sudo docker …?</h3><p>此时使用 docker ps 会提示权限不够，需要 sudo docker ps</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#添加docker用户组</span><span class="token function">sudo</span> <span class="token function">groupadd</span> <span class="token function">docker</span><span class="token comment">#将当前用户添加到用户组</span><span class="token function">sudo</span> <span class="token function">usermod</span> <span class="token parameter variable">-aG</span> <span class="token function">docker</span> <span class="token environment constant">$USER</span><span class="token comment">#使权限生效</span>newgrp <span class="token function">docker</span><span class="token comment">#查看所有容器</span><span class="token function">docker</span> <span class="token function">ps</span> <span class="token parameter variable">-a</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果没有此行命令，你会发现，当你每次打开新的终端<br />你都必须先执行一次 “newgrp docker” 命令<br />否则当前用户还是不可以执行docker命令</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gedit ~/.bashrc<span class="token comment"># 在文件最下方加入</span><span class="token keyword">if</span> <span class="token operator">!</span> <span class="token function">groups</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-q</span> <span class="token function">docker</span><span class="token punctuation">;</span> <span class="token keyword">then</span>    newgrp <span class="token function">docker</span><span class="token keyword">fi</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="配置仓库镜像"><a class="markdownIt-Anchor" href="#配置仓库镜像"></a> 配置仓库镜像</h3><p>另外，我们需要在docker daemon 配置文件中增加国的可用的 docker hub mirror ，<br />找到你的daemon.json 文件，通常在 /etc/docker/daemon.json 这个位置，如果没有就创建一个</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> gedit /etc/docker/daemon.json<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>在daemon.json 中增加</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">&#123;</span>    <span class="token string">"registry-mirrors"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>        <span class="token string">"https://docker.m.daocloud.io"</span>  <span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>重置生效</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> systemctl daemon-reload<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> systemctl restart <span class="token function">docker</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> info<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="如果中途出错可以执行以下命令卸载docker重试"><a class="markdownIt-Anchor" href="#如果中途出错可以执行以下命令卸载docker重试"></a> 如果中途出错可以，执行以下命令卸载docker，重试</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> purge docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 环境搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ubuntu22.04安装编译OpenCV</title>
      <link href="/2025/05/21/ubuntu22-04%E5%AE%89%E8%A3%85%E7%BC%96%E8%AF%91OpenCV/"/>
      <url>/2025/05/21/ubuntu22-04%E5%AE%89%E8%A3%85%E7%BC%96%E8%AF%91OpenCV/</url>
      
        <content type="html"><![CDATA[<h2 id="安装opencv"><a class="markdownIt-Anchor" href="#安装opencv"></a> 安装opencv</h2><h3 id="前置环境"><a class="markdownIt-Anchor" href="#前置环境"></a> 前置环境</h3><p>需要系统上存在cmake, g++, make 或者 ninja-build<br />如果没有, 执行下面命令安装:</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#更新apt可安装包列表</span><span class="token function">sudo</span> <span class="token function">apt</span> update <span class="token comment">#安装cmake和g++</span><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> <span class="token parameter variable">-y</span> cmake g++ <span class="token comment">#安装项目构建工具，有两个选择，make或ninja</span><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> <span class="token function">make</span> <span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> ninja-build<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="卸载旧版本"><a class="markdownIt-Anchor" href="#卸载旧版本"></a> 卸载旧版本</h3><p>如果系统上存在旧版本的 opencv 或者 使用 sudo apt install libopencv-dev 命令下载的可以选择使用以下命令删除：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> purge libopencv-dev<span class="token function">sudo</span> <span class="token function">rm</span> <span class="token parameter variable">-rf</span> /usr/include/opencv4 /usr/lib/x86_64-linux-gnu/libopencv_* <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="下载官方源代码"><a class="markdownIt-Anchor" href="#下载官方源代码"></a> 下载官方源代码</h3><p>新建文件夹放置下载的源码<br />这里我下载到了</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> ~/Desktop/vision/opencv_lib<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>从github 下载opencv源码和扩展模块的源码</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> https://github.com/opencv/opencv.git<span class="token function">git</span> https://github.com/opencv/opencv_contrib.git<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>opencv_lib文件夹下存在</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">opencv-4.11.0opencv_contrib<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="安装opencv-依赖"><a class="markdownIt-Anchor" href="#安装opencv-依赖"></a> 安装opencv 依赖</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> <span class="token parameter variable">-y</span> <span class="token punctuation">\</span>    build-essential cmake <span class="token function">git</span> pkg-config libgtk-3-dev <span class="token punctuation">\</span>    libavcodec-dev libavformat-dev libswscale-dev libv4l-dev <span class="token punctuation">\</span>    libxvidcore-dev libx264-dev libjpeg-dev libpng-dev libtiff-dev <span class="token punctuation">\</span>    gfortran openexr libatlas-base-dev python3-dev python3-numpy <span class="token punctuation">\</span>    libtbb2 libtbb-dev libdc1394-22-dev libopenexr-dev <span class="token punctuation">\</span>    libgstreamer-plugins-base1.0-dev libgstreamer1.0-dev <span class="token punctuation">\</span>    libice-dev libbsd-dev<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="配置并编译-opencv"><a class="markdownIt-Anchor" href="#配置并编译-opencv"></a> 配置并编译 opencv</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> ~/Desktop/vision/opencv_lib/opencv-4.11.0/build<span class="token comment"># 如果之前配置出错可以删除</span><span class="token function">rm</span> <span class="token parameter variable">-rf</span> *<span class="token comment"># \ 后面注意不要有空格，否则在终端运行会出错</span>cmake <span class="token parameter variable">-D</span> <span class="token assign-left variable">CMAKE_BUILD_TYPE</span><span class="token operator">=</span>RELEASE <span class="token punctuation">\</span>      <span class="token parameter variable">-D</span> <span class="token assign-left variable">CMAKE_INSTALL_PREFIX</span><span class="token operator">=</span>/usr/local <span class="token punctuation">\</span>      <span class="token parameter variable">-D</span> <span class="token assign-left variable">OPENCV_GENERATE_PKGCONFIG</span><span class="token operator">=</span>ON <span class="token punctuation">\</span>      <span class="token parameter variable">-D</span> <span class="token assign-left variable">OPENCV_EXTRA_MODULES_PATH</span><span class="token operator">=~</span>/Desktop/vision/opencv_lib/opencv_contrib/modules <span class="token punctuation">\</span>      <span class="token parameter variable">-D</span> <span class="token assign-left variable">BUILD_EXAMPLES</span><span class="token operator">=</span>OFF <span class="token punctuation">\</span>      <span class="token parameter variable">-D</span> <span class="token assign-left variable">WITH_GTK</span><span class="token operator">=</span>ON <span class="token punctuation">\</span>      <span class="token parameter variable">-D</span> <span class="token assign-left variable">WITH_FFMPEG</span><span class="token operator">=</span>ON <span class="token punctuation">\</span>      <span class="token parameter variable">-D</span> <span class="token assign-left variable">WITH_V4L</span><span class="token operator">=</span>ON <span class="token punctuation">\</span>      <span class="token punctuation">..</span><span class="token function">make</span> -j<span class="token variable"><span class="token variable">$(</span>nproc<span class="token variable">)</span></span><span class="token function">sudo</span> <span class="token function">make</span> <span class="token function">install</span><span class="token function">sudo</span> ldconfig<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="查看opencv4版本"><a class="markdownIt-Anchor" href="#查看opencv4版本"></a> 查看opencv4版本</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pkg-config <span class="token parameter variable">--modversion</span> opencv4<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 环境搭建 </category>
          
          <category> 视觉 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> OpenCV </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>逆向破解加密爬取音乐实战</title>
      <link href="/2025/05/20/%E9%80%86%E5%90%91%E7%A0%B4%E8%A7%A3%E5%8A%A0%E5%AF%86%E7%88%AC%E5%8F%96%E9%9F%B3%E4%B9%90%E5%AE%9E%E6%88%98/"/>
      <url>/2025/05/20/%E9%80%86%E5%90%91%E7%A0%B4%E8%A7%A3%E5%8A%A0%E5%AF%86%E7%88%AC%E5%8F%96%E9%9F%B3%E4%B9%90%E5%AE%9E%E6%88%98/</url>
      
        <content type="html"><![CDATA[<blockquote><p>该音乐网站已经停止运维</p></blockquote><h2 id="逆向模拟加密请求接口"><a class="markdownIt-Anchor" href="#逆向模拟加密请求接口"></a> 逆向模拟加密请求接口</h2><h3 id="搜索api"><a class="markdownIt-Anchor" href="#搜索api"></a> 搜索api</h3><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/%E7%88%AC%E8%99%AB/1738923287003.png" alt="1738923287003" /></p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/%E7%88%AC%E8%99%AB/1738923324521.png" alt="1738923324521" /></p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/%E7%88%AC%E8%99%AB/1738923343388.png" alt="1738923343388" /></p><p>接口地址：<a href="https://tool.liumingye.cn/music/api/search">https://tool.liumingye.cn/music/api/search</a><br />POST请求<br />请求参数为：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span><span class="token property">"type"</span><span class="token operator">:</span><span class="token string">"YQM"</span><span class="token punctuation">,</span><span class="token property">"text"</span><span class="token operator">:</span><span class="token string">"唯一"</span><span class="token punctuation">,</span><span class="token property">"page"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">"v"</span><span class="token operator">:</span><span class="token string">"beta"</span><span class="token punctuation">,</span><span class="token property">"_t"</span><span class="token operator">:</span><span class="token number">1738923249577</span><span class="token punctuation">,</span><span class="token property">"token"</span><span class="token operator">:</span><span class="token string">"20241016.e38efcba0d384a6782e835d8d63a2837"</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>响应数据格式：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>    <span class="token property">"code"</span><span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>    <span class="token property">"data"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token property">"list"</span><span class="token operator">:</span> <span class="token punctuation">[</span>            <span class="token punctuation">&#123;</span>                <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"zEAY"</span><span class="token punctuation">,</span>                <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"唯一"</span><span class="token punctuation">,</span>                <span class="token property">"time"</span><span class="token operator">:</span> <span class="token number">262</span><span class="token punctuation">,</span>                <span class="token property">"quality"</span><span class="token operator">:</span> <span class="token punctuation">[</span>                    <span class="token number">128</span><span class="token punctuation">,</span>                    <span class="token number">320</span><span class="token punctuation">,</span>                    <span class="token number">2000</span>                <span class="token punctuation">]</span><span class="token punctuation">,</span>                <span class="token property">"album"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                    <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"zqyA"</span><span class="token punctuation">,</span>                    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"唯一"</span><span class="token punctuation">,</span>                    <span class="token property">"pic"</span><span class="token operator">:</span> <span class="token string">"https:\/\/i.biliimg.com\/bfs\/im\/895931b7dea76e5ad7148cf8714192621b9b12bf.jpg@&#123;size&#125;w_&#123;size&#125;h_1c.webp"</span>                <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>                <span class="token property">"artist"</span><span class="token operator">:</span> <span class="token punctuation">[</span>                    <span class="token punctuation">&#123;</span>                        <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"zYOg"</span><span class="token punctuation">,</span>                        <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"王力宏"</span>                    <span class="token punctuation">&#125;</span>                <span class="token punctuation">]</span><span class="token punctuation">,</span>                <span class="token property">"hash"</span><span class="token operator">:</span> <span class="token string">"d3f636iePH3nJMVUD1wbsSTfgf-QwuOgyE9H3WcjYfUEDiX2YdQ"</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token punctuation">&#123;</span>                <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"唯一"</span><span class="token punctuation">,</span>                <span class="token property">"artist"</span><span class="token operator">:</span> <span class="token punctuation">[</span>                    <span class="token punctuation">&#123;</span>                        <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"mfm"</span><span class="token punctuation">,</span>                        <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"告五人"</span>                    <span class="token punctuation">&#125;</span>                <span class="token punctuation">]</span><span class="token punctuation">,</span>                <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"m3f63OtUGNZoMDio1Kv1QtTI8xsjKJ_Mheyn12w07dWSL0qLZFeLha7Ur2BjAcJo"</span><span class="token punctuation">,</span>                <span class="token property">"pic"</span><span class="token operator">:</span> <span class="token string">"https:\/\/d.musicapp.migu.cn\/data\/oss\/resource\/00\/2h\/xz\/6w.webp"</span><span class="token punctuation">,</span>                <span class="token property">"lyric"</span><span class="token operator">:</span> <span class="token string">"https:\/\/d.musicapp.migu.cn\/data\/oss\/resource\/00\/1v\/uz\/x8"</span><span class="token punctuation">,</span>                <span class="token property">"quality"</span><span class="token operator">:</span> <span class="token punctuation">[</span>                    <span class="token number">128</span><span class="token punctuation">,</span>                    <span class="token number">320</span><span class="token punctuation">,</span>                    <span class="token number">2000</span>                <span class="token punctuation">]</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token punctuation">&#123;</span>                <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"唯一"</span><span class="token punctuation">,</span>                <span class="token property">"artist"</span><span class="token operator">:</span> <span class="token punctuation">[</span>                    <span class="token punctuation">&#123;</span>                        <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"mfm"</span><span class="token punctuation">,</span>                        <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"王力宏"</span>                    <span class="token punctuation">&#125;</span>                <span class="token punctuation">]</span><span class="token punctuation">,</span>                <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"m3f63OtUGNZoMDio1KvtWvzQ-xJiZdK54cSf02lE7dWSL0q_ZFeLha7Yo2R7Be58"</span><span class="token punctuation">,</span>                <span class="token property">"pic"</span><span class="token operator">:</span> <span class="token string">"https:\/\/d.musicapp.migu.cn\/data\/oss\/resource\/00\/2u\/km\/05e4226dce81478f918831450cb3c79e.webp"</span><span class="token punctuation">,</span>                <span class="token property">"lyric"</span><span class="token operator">:</span> <span class="token string">"http:\/\/d.musicapp.migu.cn\/prod\/file-service\/file-down01\/4eedd78464c21ce789dea6928415b323\/503186ae19388b5d720c7634363ae4a2\/a3e5f7ace5da52aec33936e1af18845c"</span><span class="token punctuation">,</span>                <span class="token property">"quality"</span><span class="token operator">:</span> <span class="token punctuation">[</span>                    <span class="token number">128</span><span class="token punctuation">,</span>                    <span class="token number">320</span><span class="token punctuation">,</span>                    <span class="token number">2000</span>                <span class="token punctuation">]</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    ......        <span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token property">"total"</span><span class="token operator">:</span> <span class="token number">221146</span><span class="token punctuation">,</span>        <span class="token property">"word"</span><span class="token operator">:</span> <span class="token punctuation">[</span>            <span class="token string">"唯一"</span>        <span class="token punctuation">]</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token property">"msg"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>开始分析源代码</p><p>首先搜索  api/search  发现这个字符串在混淆变量中</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/%E7%88%AC%E8%99%AB/1738929338043.png" alt="1738929338043" /></p><p>const e = [“text-xl font-semibold”, “wheel”, “bc-none”, …]</p><p>把混淆变量复制过来放到代码文件中</p><p>查找 api/search 的索引为 52，在源代码中搜索 （52）发现没有，有可能代码进行了混淆导致索引偏移了</p><p>然后在源代码中追踪一下这个混淆变量，也就是调用 qo() 的地方</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/%E7%88%AC%E8%99%AB/1738929473247.png" alt="1738929473247" /></p><p>发现果然会偏移混淆变量</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/%E7%88%AC%E8%99%AB/1738930064364.png" alt="1738930064364" /></p><p>尝试搜索 POST</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/%E7%88%AC%E8%99%AB/1738928985755.png" alt="1738928985755" /></p><p>打断点刷新网页进行调试，发现网页成功截停</p><p>然后在控制台输入 console.log(r(570))，输出 /api/auth/login</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/%E7%88%AC%E8%99%AB/1738929045345.png" alt="1738929045345" /></p><p>发现这是一个验证登录的接口，然后就在文件中查找 /api/auth/login 的索引，为 796</p><p>果然，在源代码中 570 ，实际上是 796，偏移了 226</p><p>那么，源代码中的 52（也就是 api/search）会不会偏移到了混淆变量的末尾呢，</p><p>混淆变量的长度为 2112， 那么我们就尝试搜索一下 1938 或者搜索 page 或 text</p><p>终于找到了：</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/%E7%88%AC%E8%99%AB/1738931509721.png" alt="1738931509721" /></p><p>其中 s 就是偏移后的混淆变量</p><p>可以发现这里的 v 是固定的 beta</p><p>打断点调试</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/%E7%88%AC%E8%99%AB/1738932203971.png" alt="1738932203971" /></p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/%E7%88%AC%E8%99%AB/1738932253262.png" alt="1738932253262" /></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">(</span>o<span class="token punctuation">[</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token number">1129</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token number">1291</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token number">1750</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> o<span class="token punctuation">.</span>params<span class="token punctuation">.</span>keywords<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> i<span class="token punctuation">.</span>page<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token number">780</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token number">780</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">(</span>o<span class="token punctuation">[</span>params<span class="token punctuation">]</span><span class="token punctuation">[</span>engine<span class="token punctuation">]</span><span class="token punctuation">[</span>toString<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> o<span class="token punctuation">.</span>params<span class="token punctuation">.</span>keywords<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> i<span class="token punctuation">.</span>page<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span>data<span class="token punctuation">]</span><span class="token punctuation">[</span>data<span class="token punctuation">]</span><span class="token punctuation">;</span>猜测一下， i<span class="token punctuation">.</span>page应该是 <span class="token number">1</span> 再大胆猜测一下 o<span class="token punctuation">[</span>params<span class="token punctuation">]</span><span class="token punctuation">[</span>engine<span class="token punctuation">]</span><span class="token punctuation">[</span>toString<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 应该对应上面请求的 e<span class="token punctuation">,</span> o<span class="token punctuation">.</span>params<span class="token punctuation">.</span>keywords<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 对应t 也就是 texti<span class="token punctuation">.</span>page 对应的是 page那么， text 和 page 和 v 都已知， 要搞清楚 type 也就是 e<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/%E7%88%AC%E8%99%AB/1738933021265.png" alt="1738933021265" /></p><p>找到 o 看一下他到底是什么</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/%E7%88%AC%E8%99%AB/1738933202162.png" alt="1738933202162" /></p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/%E7%88%AC%E8%99%AB/1738936228728.png" alt="1738936228728" /></p><p>这个函数没有 token 和 _t 的字段，应该是调用了这个函数之后又调用了其它的函数</p><p>那么，这个接口的参数还剩下 token 和  _t ，这两个是主要的，尤其 是 token，_t 可以猜一下是时间戳</p><p>那就尝试一下在源代码中搜索一下 token, 发现有 7 个，数量不多，其中一个还是在混淆变量里，可以都打上断点调试一下，</p><p>如果没有停下，那就搜索一下混淆变量里 token 的索引， 不过，很幸运，程序停在了：</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/%E7%88%AC%E8%99%AB/1738936905000.png" alt="1738936905000" /></p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/%E7%88%AC%E8%99%AB/1738936935689.png" alt="1738936935689" /></p><p>可以看到 token 和 _t 是在这段代码加入的</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/%E7%88%AC%E8%99%AB/1738946360576.png" alt="1738946360576" /></p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/%E7%88%AC%E8%99%AB/1738946463201.png" alt="1738946463201" /></p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/%E7%88%AC%E8%99%AB/1738946478773.png" alt="1738946478773" /></p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/%E7%88%AC%E8%99%AB/1738947140824.png" alt="1738947140824" /></p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/%E7%88%AC%E8%99%AB/1738947372920.png" alt="1738947372920" /></p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/%E7%88%AC%E8%99%AB/1738947365166.png" alt="1738947365166" /></p><p>在AI的帮助下对整个过程有了大致了解，让AI生成整体流程代码，然后多次调试修正后，最终成功逆向了这个加密算法，如下：</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/%E7%88%AC%E8%99%AB/1738990206639.png" alt="1738990206639" /></p><h3 id="播放api"><a class="markdownIt-Anchor" href="#播放api"></a> 播放api</h3><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/%E7%88%AC%E8%99%AB/1738822590547.png" alt="1738822590547" /></p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/%E7%88%AC%E8%99%AB/1738822733852.png" alt="1738822733852" /></p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/%E7%88%AC%E8%99%AB/1738822750837.png" alt="1738822750837" /></p><p>可以看到，这api没有任何返回值，那么问题来了，前端是怎么知道播放链接的呢，会不会是，根据某些前端数据拼接成的播放链接呢？</p><p>经过一系列分析和打断点调试，有以下发现：</p><p>uri编码后的数据：</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/%E7%88%AC%E8%99%AB/1738992896652.png" alt="1738992896652" /></p><p>可以结合search api 的返回结果来看，就比较清楚了</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/%E7%88%AC%E8%99%AB/1738992870921.png" alt="1738992870921" /></p><p>多次调试后，有了重大发现:</p><ol><li><p>index.js源代码中的loadSong()：<img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/%E7%88%AC%E8%99%AB/1738993446758.png" alt="1738993446758" /></p><p>果然，前端这里直接拼接成了播放地址，那就对这个播放地址分析一下</p></li><li><p>对于list[0]这个比较特殊的</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token string">"https://tool.liumingye.cn/music/api/link?id=d3f636iePH3nJMVUD1wbsSTfgf-QwuOgyE9H3WcjYfUEDiX2YdQ&amp;quality=128&amp;_t=1738993370934&amp;token=20241016.e8917799e456aad902485db1aa7a7a83"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>网址中的 id -&gt; hash, 那token是怎么获得的呢？还是使用的之前的加密算法，与search api 不同的是，uri用的 data 是  “{“id”:“d3f636iePH3nJMVUD1wbsSTfgf-QwuOgyE9H3WcjYfUEDiX2YdQ”,“quality”:“128”,”_t&quot;:“1738992521608”}&quot;</p></li><li><p>对于更普遍的 list[2]这种情况</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token string">"https://tool.liumingye.cn/music/api/link?id=m3f63OtUGNZoMDio1KvtWvzQ-xJiZdK54cSf02lE7dWSL0q_ZFeLha7Yo2R7Be58&amp;quality=128&amp;_t=1738993160654&amp;token=20241016.5940ea862f12cf113aa5faddc706d8fe"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>同样，这个id 就是 search api 返回结果里的 id, 使用相同的算法产生 token，不同的就是 uri 那部分</p></li></ol><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/image/%E7%88%AC%E8%99%AB/1739511271821.png" alt="1739511271821" /></p>]]></content>
      
      
      <categories>
          
          <category> 逆向 </category>
          
          <category> 爬虫 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>安卓项目进行模型推理</title>
      <link href="/2025/05/20/%E5%AE%89%E5%8D%93%E9%A1%B9%E7%9B%AE%E8%BF%9B%E8%A1%8C%E6%A8%A1%E5%9E%8B%E6%8E%A8%E7%90%86/"/>
      <url>/2025/05/20/%E5%AE%89%E5%8D%93%E9%A1%B9%E7%9B%AE%E8%BF%9B%E8%A1%8C%E6%A8%A1%E5%9E%8B%E6%8E%A8%E7%90%86/</url>
      
        <content type="html"><![CDATA[<h2 id="集成-tensorflow-lite"><a class="markdownIt-Anchor" href="#集成-tensorflow-lite"></a> 集成 TensorFlow Lite</h2><h3 id="配置环境"><a class="markdownIt-Anchor" href="#配置环境"></a> 配置环境</h3><p>模块级 <em>build.gradle</em> 添加：</p><pre class="line-numbers language-groovy" data-language="groovy"><code class="language-groovy">android <span class="token punctuation">&#123;</span>    defaultConfig <span class="token punctuation">&#123;</span>        ndk <span class="token punctuation">&#123;</span>            abiFilters <span class="token string">'armeabi-v7a'</span><span class="token punctuation">,</span> <span class="token string">'arm64-v8a'</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>     androidResources <span class="token punctuation">&#123;</span>        noCompress <span class="token string">'tflite'</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>dependencies <span class="token punctuation">&#123;</span>    <span class="token comment">// Tensorflow lite dependencies</span>    implementation <span class="token string">'org.tensorflow:tensorflow-lite-task-vision:0.4.0'</span>    <span class="token comment">// Import the GPU delegate plugin Library for GPU inference</span>    implementation <span class="token string">'org.tensorflow:tensorflow-lite-gpu:2.9.0'</span>    implementation <span class="token string">'org.tensorflow:tensorflow-lite-gpu-delegate-plugin:0.4.0'</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="编写程序验证"><a class="markdownIt-Anchor" href="#编写程序验证"></a> 编写程序验证</h3><p>参考 <em>TensorFlow Lite</em> 官方例程：</p><p>[<a href="https://github.com/tensorflow/examples/blob/master/lite/examples/image_classification/android_java/README.md">examples/lite/examples/image_classification/android_java/README.md 在 master ·TensorFlow/示例 — examples/lite/examples/image_classification/android_java/README.md at master · tensorflow/examples</a>](<a href="https://github.com/tensorflow/examples/blob/master/lite/examples/image_classification/android_java/README.md">https://github.com/tensorflow/examples/blob/master/lite/examples/image_classification/android_java/README.md</a>)</p><p>测试模型采用官方的图像分类模型</p><p>官方例程是从手机摄像头中拿取的图片，为了测试方便，就直接测试 <em>assets</em> 里的图片了</p><p>在 <em>algo</em> 文件夹下新建 <em>ImageClassifierHelper</em> 类：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/* * Copyright 2022 The TensorFlow Authors. All Rights Reserved. * * Licensed under the Apache License, Version 2.0 (the "License"); * you may not use this file except in compliance with the License. * You may obtain a copy of the License at * *             http://www.apache.org/licenses/LICENSE-2.0 * * Unless required by applicable law or agreed to in writing, software * distributed under the License is distributed on an "AS IS" BASIS, * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. * See the License for the specific language governing permissions and * limitations under the License. */</span><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>gxl_recognitionsystem<span class="token punctuation">.</span>algo</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>content<span class="token punctuation">.</span></span><span class="token class-name">Context</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span></span><span class="token class-name">Bitmap</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span></span><span class="token class-name">Canvas</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span></span><span class="token class-name">Paint</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span><span class="token class-name">SystemClock</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Log</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Arrays</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>tensorflow<span class="token punctuation">.</span>lite<span class="token punctuation">.</span>gpu<span class="token punctuation">.</span></span><span class="token class-name">CompatibilityList</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>tensorflow<span class="token punctuation">.</span>lite<span class="token punctuation">.</span>support<span class="token punctuation">.</span>image<span class="token punctuation">.</span></span><span class="token class-name">ImageProcessor</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>tensorflow<span class="token punctuation">.</span>lite<span class="token punctuation">.</span>support<span class="token punctuation">.</span>image<span class="token punctuation">.</span></span><span class="token class-name">TensorImage</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>tensorflow<span class="token punctuation">.</span>lite<span class="token punctuation">.</span>support<span class="token punctuation">.</span>image<span class="token punctuation">.</span>ops<span class="token punctuation">.</span></span><span class="token class-name">ResizeOp</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>tensorflow<span class="token punctuation">.</span>lite<span class="token punctuation">.</span>support<span class="token punctuation">.</span>image<span class="token punctuation">.</span>ops<span class="token punctuation">.</span></span><span class="token class-name">Rot90Op</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>tensorflow<span class="token punctuation">.</span>lite<span class="token punctuation">.</span>support<span class="token punctuation">.</span>metadata<span class="token punctuation">.</span>schema<span class="token punctuation">.</span></span><span class="token class-name">NormalizationOptions</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>tensorflow<span class="token punctuation">.</span>lite<span class="token punctuation">.</span>task<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">BaseOptions</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>tensorflow<span class="token punctuation">.</span>lite<span class="token punctuation">.</span>task<span class="token punctuation">.</span>vision<span class="token punctuation">.</span>classifier<span class="token punctuation">.</span></span><span class="token class-name">Classifications</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>tensorflow<span class="token punctuation">.</span>lite<span class="token punctuation">.</span>task<span class="token punctuation">.</span>vision<span class="token punctuation">.</span>classifier<span class="token punctuation">.</span></span><span class="token class-name">ImageClassifier</span></span><span class="token punctuation">;</span><span class="token comment">/** Helper class for wrapping Image Classification actions */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ImageClassifierHelper</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">TAG</span> <span class="token operator">=</span> <span class="token string">"ImageClassifierHelper"</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">DELEGATE_CPU</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">DELEGATE_GPU</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">DELEGATE_NNAPI</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MODEL_ISINSTRUMENT</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MODEL_ISINSTALL</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MODEL_MOBILENETV1</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">float</span> threshold<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> numThreads<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> maxResults<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> currentDelegate<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> currentModel<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Context</span> context<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ClassifierListener</span> imageClassifierListener<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token class-name">ImageClassifier</span> imageClassifier<span class="token punctuation">;</span>    <span class="token comment">/** Helper class for wrapping Image Classification actions */</span>    <span class="token keyword">public</span> <span class="token class-name">ImageClassifierHelper</span><span class="token punctuation">(</span><span class="token class-name">Float</span> threshold<span class="token punctuation">,</span>                                 <span class="token keyword">int</span> numThreads<span class="token punctuation">,</span>                                 <span class="token keyword">int</span> maxResults<span class="token punctuation">,</span>                                 <span class="token keyword">int</span> currentDelegate<span class="token punctuation">,</span>                                 <span class="token keyword">int</span> currentModel<span class="token punctuation">,</span>                                 <span class="token class-name">Context</span> context<span class="token punctuation">,</span>                                 <span class="token class-name">ClassifierListener</span> imageClassifierListener<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>threshold <span class="token operator">=</span> threshold<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>numThreads <span class="token operator">=</span> numThreads<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>maxResults <span class="token operator">=</span> maxResults<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>currentDelegate <span class="token operator">=</span> currentDelegate<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>currentModel <span class="token operator">=</span> currentModel<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>context <span class="token operator">=</span> context<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>imageClassifierListener <span class="token operator">=</span> imageClassifierListener<span class="token punctuation">;</span>        <span class="token function">setupImageClassifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ImageClassifierHelper</span> <span class="token function">create</span><span class="token punctuation">(</span>            <span class="token class-name">Context</span> context<span class="token punctuation">,</span>            <span class="token class-name">ClassifierListener</span> listener    <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ImageClassifierHelper</span><span class="token punctuation">(</span>                <span class="token number">0.5f</span><span class="token punctuation">,</span>                <span class="token number">2</span><span class="token punctuation">,</span>                <span class="token number">3</span><span class="token punctuation">,</span>                <span class="token number">0</span><span class="token punctuation">,</span>                <span class="token number">2</span><span class="token punctuation">,</span>                context<span class="token punctuation">,</span>                listener        <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">float</span> <span class="token function">getThreshold</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> threshold<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setThreshold</span><span class="token punctuation">(</span><span class="token keyword">float</span> threshold<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>threshold <span class="token operator">=</span> threshold<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getNumThreads</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> numThreads<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setNumThreads</span><span class="token punctuation">(</span><span class="token keyword">int</span> numThreads<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>numThreads <span class="token operator">=</span> numThreads<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getMaxResults</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> maxResults<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setMaxResults</span><span class="token punctuation">(</span><span class="token keyword">int</span> maxResults<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>maxResults <span class="token operator">=</span> maxResults<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setCurrentDelegate</span><span class="token punctuation">(</span><span class="token keyword">int</span> currentDelegate<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>currentDelegate <span class="token operator">=</span> currentDelegate<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setCurrentModel</span><span class="token punctuation">(</span><span class="token keyword">int</span> currentModel<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>currentModel <span class="token operator">=</span> currentModel<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setupImageClassifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">ImageClassifier<span class="token punctuation">.</span>ImageClassifierOptions<span class="token punctuation">.</span>Builder</span> optionsBuilder <span class="token operator">=</span>                <span class="token class-name">ImageClassifier<span class="token punctuation">.</span>ImageClassifierOptions</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                        <span class="token punctuation">.</span><span class="token function">setScoreThreshold</span><span class="token punctuation">(</span>threshold<span class="token punctuation">)</span>                        <span class="token punctuation">.</span><span class="token function">setMaxResults</span><span class="token punctuation">(</span>maxResults<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">BaseOptions<span class="token punctuation">.</span>Builder</span> baseOptionsBuilder <span class="token operator">=</span>                <span class="token class-name">BaseOptions</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setNumThreads</span><span class="token punctuation">(</span>numThreads<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">switch</span> <span class="token punctuation">(</span>currentDelegate<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">case</span> <span class="token constant">DELEGATE_CPU</span><span class="token operator">:</span>                <span class="token comment">// Default</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> <span class="token constant">DELEGATE_GPU</span><span class="token operator">:</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CompatibilityList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isDelegateSupportedOnThisDevice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    baseOptionsBuilder<span class="token punctuation">.</span><span class="token function">useGpu</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                    imageClassifierListener<span class="token punctuation">.</span><span class="token function">onError</span><span class="token punctuation">(</span><span class="token string">"GPU is not supported on "</span>                            <span class="token operator">+</span> <span class="token string">"this device"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> <span class="token constant">DELEGATE_NNAPI</span><span class="token operator">:</span>                baseOptionsBuilder<span class="token punctuation">.</span><span class="token function">useNnapi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token class-name">String</span> modelName<span class="token punctuation">;</span>        <span class="token keyword">switch</span> <span class="token punctuation">(</span>currentModel<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">case</span> <span class="token constant">MODEL_ISINSTRUMENT</span><span class="token operator">:</span>                modelName <span class="token operator">=</span> <span class="token string">"is_instrument2.tflite"</span><span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> <span class="token constant">MODEL_ISINSTALL</span><span class="token operator">:</span>                modelName <span class="token operator">=</span> <span class="token string">"is_install2.tflite"</span><span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> <span class="token constant">MODEL_MOBILENETV1</span><span class="token operator">:</span>                modelName <span class="token operator">=</span> <span class="token string">"mobilenetv1.tflite"</span><span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">default</span><span class="token operator">:</span>                modelName <span class="token operator">=</span> <span class="token string">"is_instrument2.tflite"</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>            imageClassifier <span class="token operator">=</span>                    <span class="token class-name">ImageClassifier</span><span class="token punctuation">.</span><span class="token function">createFromFileAndOptions</span><span class="token punctuation">(</span>                            context<span class="token punctuation">,</span>                            modelName<span class="token punctuation">,</span>                            optionsBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            imageClassifierListener<span class="token punctuation">.</span><span class="token function">onError</span><span class="token punctuation">(</span><span class="token string">"Image classifier failed to "</span>                    <span class="token operator">+</span> <span class="token string">"initialize. See error logs for details"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"TFLite failed to load model with error: "</span>                    <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">classify</span><span class="token punctuation">(</span><span class="token class-name">Bitmap</span> image<span class="token punctuation">,</span> <span class="token keyword">int</span> imageRotation<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>imageClassifier <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">setupImageClassifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// Inference time is the difference between the system time at the start</span>        <span class="token comment">// and finish of the process</span>        <span class="token keyword">long</span> inferenceTime <span class="token operator">=</span> <span class="token class-name">SystemClock</span><span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Bitmap</span> convertedBitmap <span class="token operator">=</span> <span class="token class-name">Bitmap</span><span class="token punctuation">.</span><span class="token function">createBitmap</span><span class="token punctuation">(</span>image<span class="token punctuation">.</span><span class="token function">getWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> image<span class="token punctuation">.</span><span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Bitmap<span class="token punctuation">.</span>Config</span><span class="token punctuation">.</span><span class="token constant">ARGB_8888</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Canvas</span> canvas <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Canvas</span><span class="token punctuation">(</span>convertedBitmap<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Paint</span> paint <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Paint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        canvas<span class="token punctuation">.</span><span class="token function">drawBitmap</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> paint<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// Create preprocessor for the image.</span>        <span class="token comment">// See https://www.tensorflow.org/lite/inference_with_metadata/</span>        <span class="token comment">//            lite_support#imageprocessor_architecture</span>        <span class="token class-name">ImageProcessor</span> imageProcessor <span class="token operator">=</span>                <span class="token keyword">new</span> <span class="token class-name">ImageProcessor<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//                        .add(new TransposeOp(new int[]&#123;0, 2, 3, 1&#125;))  // 将 [1,3,height,width] 转为 [1,height,width,3]</span>                        <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Rot90Op</span><span class="token punctuation">(</span><span class="token operator">-</span>imageRotation <span class="token operator">/</span> <span class="token number">90</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// Preprocess the image and convert it into a TensorImage for classification.</span>        <span class="token class-name">TensorImage</span> tensorImage <span class="token operator">=</span>                imageProcessor<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">TensorImage</span><span class="token punctuation">.</span><span class="token function">fromBitmap</span><span class="token punctuation">(</span>convertedBitmap<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// Classify the input image</span>        imageClassifier<span class="token punctuation">.</span><span class="token function">classify</span><span class="token punctuation">(</span>tensorImage<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Classifications</span><span class="token punctuation">></span></span> result <span class="token operator">=</span> imageClassifier<span class="token punctuation">.</span><span class="token function">classify</span><span class="token punctuation">(</span>tensorImage<span class="token punctuation">)</span><span class="token punctuation">;</span>        inferenceTime <span class="token operator">=</span> <span class="token class-name">SystemClock</span><span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> inferenceTime<span class="token punctuation">;</span>        imageClassifierListener<span class="token punctuation">.</span><span class="token function">onResults</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> inferenceTime<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">clearImageClassifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        imageClassifier <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/** Listener for passing results back to calling class */</span>    <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ClassifierListener</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">void</span> <span class="token function">onError</span><span class="token punctuation">(</span><span class="token class-name">String</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">void</span> <span class="token function">onResults</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Classifications</span><span class="token punctuation">></span></span> results<span class="token punctuation">,</span> <span class="token keyword">long</span> inferenceTime<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在 <em>test</em> 类中加入：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> test <span class="token punctuation">&#123;</span><span class="token comment">/**     * 从 assets 加载图片并进行图像分类     *     * @param context        上下文对象     * @param assetImageFile assets 下的图片文件名（例如 "testAlgo.jpg"）     * @param imageRotation  图片旋转角度（单位：度）     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">testModel</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">String</span> assetImageFile<span class="token punctuation">,</span> <span class="token keyword">int</span> imageRotation<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>            <span class="token comment">// 1. 准备图片</span>            <span class="token comment">// 从 assets 中加载图片</span>            <span class="token class-name">InputStream</span> is <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getAssets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span>assetImageFile<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">Bitmap</span> bitmap <span class="token operator">=</span> <span class="token class-name">BitmapFactory</span><span class="token punctuation">.</span><span class="token function">decodeStream</span><span class="token punctuation">(</span>is<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>bitmap <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string">"ImageLoad"</span><span class="token punctuation">,</span> <span class="token string">"图片加载失败. Please check if the file exists in assets and the file name is correct."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"ImageLoad"</span><span class="token punctuation">,</span> <span class="token string">"Bitmap 加载成功: "</span> <span class="token operator">+</span> bitmap<span class="token punctuation">.</span><span class="token function">getWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" x "</span> <span class="token operator">+</span> bitmap<span class="token punctuation">.</span><span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token comment">// 创建 ImageClassifierHelper</span>            <span class="token comment">/**             * 构造方法，用于初始化 ImageClassifierHelper 实例。             *             * @param threshold           分类结果的概率阈值（0.0f 到 1.0f）。             *                            例如，设置为 0.5f 表示只有概率大于 50% 的分类结果才会被返回。             * @param numThreads          运行分类任务的线程数，建议设置为 2 或 3。             *                            更多的线程可能提高性能，但也会增加资源消耗。             * @param maxResults          每次分类返回的最大结果数量，建议设置为 2 到 5。             *                            设置为 2 表示每次分类最多返回 2 个最可能的类别。             * @param currentDelegate     当前使用的委托类型，用于指定硬件加速方式等。             *                            例如，设置为 0 表示使用CPU，1：GPU。             * @param currentModel        当前使用的模型类型，用于指定不同的分类模型。             *                            0: is_instrument     1: is_install      2. mobilenetv1             * @param context             应用上下文，用于加载资源等。             * @param imageClassifierListener 分类结果监听器，用于接收分类结果或错误信息。             *                            通过实现 ClassifierListener 接口，可以在分类完成或出错时得到回调。             */</span>            <span class="token class-name">ImageClassifierHelper</span> classifierHelper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ImageClassifierHelper</span><span class="token punctuation">(</span>                    <span class="token number">0.5f</span><span class="token punctuation">,</span>                    <span class="token number">2</span><span class="token punctuation">,</span>                    <span class="token number">3</span><span class="token punctuation">,</span>                    <span class="token number">0</span><span class="token punctuation">,</span>                    <span class="token number">0</span><span class="token punctuation">,</span>                    context<span class="token punctuation">,</span>                    <span class="token keyword">new</span> <span class="token class-name">ImageClassifierHelper<span class="token punctuation">.</span>ClassifierListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                        <span class="token annotation punctuation">@Override</span>                        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onError</span><span class="token punctuation">(</span><span class="token class-name">String</span> error<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"testModel"</span><span class="token punctuation">,</span> <span class="token string">"算法测试出错了"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//                        Toast.makeText(Administrators_MainActivity.this, error, Toast.LENGTH_SHORT).show());</span>                        <span class="token punctuation">&#125;</span>                        <span class="token annotation punctuation">@Override</span>                        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onResults</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Classifications</span><span class="token punctuation">></span></span> results<span class="token punctuation">,</span> <span class="token keyword">long</span> inferenceTime<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"testModel"</span><span class="token punctuation">,</span> <span class="token string">"推理耗时: "</span> <span class="token operator">+</span> inferenceTime <span class="token operator">+</span> <span class="token string">" ms"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Classifications</span> classification <span class="token operator">:</span> results<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                                <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"testModel"</span><span class="token punctuation">,</span> <span class="token string">"推理结果: "</span> <span class="token operator">+</span> classification<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token punctuation">&#125;</span>                        <span class="token punctuation">&#125;</span>                    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// 调用 classify 方法进行图像分类</span>            classifierHelper<span class="token punctuation">.</span><span class="token function">classify</span><span class="token punctuation">(</span>bitmap<span class="token punctuation">,</span> imageRotation<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在 <em>Adminstrators_MainActivity</em> 中加入：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Administrators_MainActivity</span> <span class="token keyword">extends</span> <span class="token class-name">Activity</span> <span class="token keyword">implements</span> <span class="token class-name">View<span class="token punctuation">.</span>OnClickListener</span> <span class="token punctuation">&#123;</span><span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token class-name">Bundle</span> savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// 测试算法模型</span>        <span class="token function">testModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">testModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> assetsImgList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        assetsImgList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"testAlgo.jpg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        assetsImgList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"test1.jpg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        assetsImgList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"test2.jpg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> img <span class="token operator">:</span> assetsImgList<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            testAlgo<span class="token punctuation">.</span><span class="token function">testModel</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> img<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>运行，测试结果如下：</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/Android/202503062116665.png" alt="image-20250306211621612" /></p><p>第一个图片识别失败了，可能是由于图片分辨率太低，后面两张图片都识别出是杯子（cup）了</p><h2 id="自定义训练模型"><a class="markdownIt-Anchor" href="#自定义训练模型"></a> 自定义训练模型</h2><h3 id="技术路线"><a class="markdownIt-Anchor" href="#技术路线"></a> 技术路线</h3><p>尝试使用 <em>tensorflow</em> 官方的 <em>TensorFlow Lite Model Maker</em> 进行训练，这个会给模型自动添加元数据，使用训练完成的 <em>tflite</em> 文件在安卓端进行推理测试：</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/Android/202503131232092.png" alt="image-20250313123209039" /></p><p>测试成功！</p><h3 id="编写算法逻辑代码测试"><a class="markdownIt-Anchor" href="#编写算法逻辑代码测试"></a> 编写算法逻辑代码测试</h3><p>在 <em>Adminstrators_MainActivity</em> 中加入：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Administrators_MainActivity</span> <span class="token keyword">extends</span> <span class="token class-name">Activity</span> <span class="token keyword">implements</span> <span class="token class-name">View<span class="token punctuation">.</span>OnClickListener</span> <span class="token punctuation">&#123;</span><span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token class-name">Bundle</span> savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// 测试算法判断逻辑 testAlgo</span>        <span class="token function">testAlgo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token comment">// 测试 算法判断逻辑 testAlgo</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">testAlgo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">String</span> assetFilePath <span class="token operator">=</span> <span class="token string">"normal.jpg"</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> tempDir <span class="token operator">=</span> <span class="token function">getCacheDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 复制到缓存区以获得绝对路径</span>        <span class="token class-name">String</span> tempFilePath <span class="token operator">=</span> tempDir <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> assetFilePath<span class="token punctuation">;</span>        <span class="token comment">// 将图片从 assets 目录复制到临时目录</span>        test<span class="token punctuation">.</span><span class="token function">copyFileFromAssets</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> assetFilePath<span class="token punctuation">,</span> tempFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> s <span class="token operator">=</span> test<span class="token punctuation">.</span><span class="token function">testAlgo</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> tempFilePath<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"testAlgo"</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>下面编写识别逻辑：</p><p><em>test</em> 类：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>gxl_recognitionsystem<span class="token punctuation">.</span>algo</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>content<span class="token punctuation">.</span></span><span class="token class-name">Context</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span></span><span class="token class-name">Bitmap</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span></span><span class="token class-name">BitmapFactory</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Log</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>chaquo<span class="token punctuation">.</span>python<span class="token punctuation">.</span></span><span class="token class-name">PyObject</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>chaquo<span class="token punctuation">.</span>python<span class="token punctuation">.</span></span><span class="token class-name">Python</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>tensorflow<span class="token punctuation">.</span>lite<span class="token punctuation">.</span>support<span class="token punctuation">.</span>label<span class="token punctuation">.</span></span><span class="token class-name">Category</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>tensorflow<span class="token punctuation">.</span>lite<span class="token punctuation">.</span>task<span class="token punctuation">.</span>vision<span class="token punctuation">.</span>classifier<span class="token punctuation">.</span></span><span class="token class-name">Classifications</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">File</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">FileOutputStream</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">InputStream</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">OutputStream</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Objects</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">CountDownLatch</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span></span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> test <span class="token punctuation">&#123;</span><span class="token comment">// 设置置信度</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">float</span> <span class="token constant">CONFIDENCE_THRESHOLD</span> <span class="token operator">=</span> <span class="token number">0.5f</span><span class="token punctuation">;</span>        <span class="token comment">/**     * 方法描述：     * 1. 图片模糊检测：     *    - 调用 Python 模块中 detetion.py 的 is_image_blur 方法，对传入的图片文件进行模糊检测。     *    - 如果检测结果表明图片模糊，则方法直接返回错误提示，提示用户提供更清晰的图像，后续处理不再继续。     *     * 2. 图片加载：     *    - 使用 BitmapFactory 从指定的临时文件路径加载图片生成 Bitmap 对象。     *    - 如果图片加载失败（返回的 Bitmap 为 null），则记录错误日志，并返回错误提示信息。     *     * 3. 仪表设备检测（is_instrument 模型）：     *    - 创建 ImageClassifierHelper 实例，配置推理参数，包括置信度阈值、线程数、最大返回结果数量、委托类型、模型类型等。     *      此处模型类型指定为 0，表示使用 is_instrument.tflite 模型。     *    - 调用 classify 方法，对加载的 Bitmap 进行推理，同时传入图片的旋转角度（单位：度），以确保图片方向正确。     *    - 在推理回调的 onResults 方法中，通过遍历返回的分类结果，调用自定义方法 isInstrument 来判断是否检测到仪表设备，     *      并将判断结果赋值给 instrumentFlag 标志。     *    - 如果在推理过程中发生错误，则 onError 回调方法会记录相关错误日志。     *     * 4. 仪表设备判断：     *    - 如果 isInstrument 的判断结果为 false（即未检测到仪表设备），则方法直接返回错误提示“Error: 未检测到仪表设备”，     *      不进行后续的安装情况检测。     *     * 5. 安装情况检测（is_install 模型）：     *    - 如果仪表设备检测通过，则继续进行安装情况的检测。     *    - 创建另一个 ImageClassifierHelper 实例，配置参数时将模型类型设置为 1，表示使用 is_install.tflite 模型。     *    - 同样调用 classify 方法对图片进行推理，并在 onResults 回调中调用 isInstall 方法解析分类结果，     *      根据返回的判断值更新 installFlag 标志；同时记录推理耗时及分类结果日志。     *    - 推理出错时，onError 方法会记录错误日志。     *     * 6. 返回最终结果：     *    - 根据 installFlag 的判断值，返回最终结果字符串：     *         - 若 installFlag 为 true，返回 "判断结果: 安装"；     *         - 若 installFlag 为 false，返回 "Error: 未安装"。     *     * 7. 清理临时文件：     *    - 无论过程是否出现异常，最终都会在 finally 块中调用 deleteFile 方法删除临时图片文件，     *      以确保临时资源得到及时释放。     *     * 注意事项：     * - 本方法依赖 Python 模块（detection.py）、is_instrument.tflite 模型以及 is_install.tflite 模型，     *   所以需要确保这些资源存在且正确配置。     * - 分类推理操作可能为异步执行，需确保回调方法执行完成后再依据 flag 标志进行逻辑判断，     *   否则可能会出现由于异步调用导致的逻辑错误。     * - 日志记录信息有助于排查推理过程中的异常及错误，但需要注意日志中的信息描述应与实际操作保持一致。     *     * @param context       应用上下文，用于资源加载、模型初始化及其他相关操作。     * @param tempFilePath  临时存储图片的绝对路径，图片将用于后续的模糊检测和分类推理。     * @param imageRotation 图片的旋转角度（单位：度），用于在推理前对图片进行方向校正。     * @return 返回最终判断结果的字符串，包括错误提示或成功的检测结果信息。     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">testAlgo</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">String</span> tempFilePath<span class="token punctuation">,</span> <span class="token keyword">int</span> imageRotation<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">Python</span> py <span class="token operator">=</span> <span class="token class-name">Python</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Bitmap</span> bitmap <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>            <span class="token comment">// 1. 检测图片模糊</span>            <span class="token class-name">PyObject</span> isImageBlurObj <span class="token operator">=</span> py<span class="token punctuation">.</span><span class="token function">getModule</span><span class="token punctuation">(</span><span class="token string">"detetion"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">callAttr</span><span class="token punctuation">(</span><span class="token string">"is_image_blur"</span><span class="token punctuation">,</span> tempFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">Boolean</span> isBlur <span class="token operator">=</span> isImageBlurObj<span class="token punctuation">.</span><span class="token function">toJava</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>isBlur<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">return</span> <span class="token string">"Error: 图片模糊，请提供更清晰的图像"</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token comment">// 加载图片</span>            bitmap <span class="token operator">=</span> <span class="token class-name">BitmapFactory</span><span class="token punctuation">.</span><span class="token function">decodeFile</span><span class="token punctuation">(</span>tempFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>bitmap <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string">"ImageLoad"</span><span class="token punctuation">,</span> <span class="token string">"图片加载失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token string">"Error: 图片加载失败"</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token comment">// 2. 进行 is_instrument 推理</span>            <span class="token keyword">final</span> <span class="token keyword">boolean</span><span class="token punctuation">[</span><span class="token punctuation">]</span> instrumentFlag <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">boolean</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token class-name">CountDownLatch</span> latch1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">/**             * 构造方法，用于初始化 ImageClassifierHelper 实例。             *             * @param threshold           分类结果的概率阈值（0.0f 到 1.0f）。             *                            例如，设置为 0.5f 表示只有概率大于 50% 的分类结果才会被返回。             * @param numThreads          运行分类任务的线程数，建议设置为 2 或 3。             *                            更多的线程可能提高性能，但也会增加资源消耗。             * @param maxResults          每次分类返回的最大结果数量，建议设置为 2 到 5。             *                            设置为 2 表示每次分类最多返回 2 个最可能的类别。             * @param currentDelegate     当前使用的委托类型，用于指定硬件加速方式等。             *                            例如，设置为 0 表示使用CPU，1：GPU。             * @param currentModel        当前使用的模型类型，用于指定不同的分类模型。             *                            0: is_instrument     1: is_install      2. mobilenetv1             * @param context             应用上下文，用于加载资源等。             * @param imageClassifierListener 分类结果监听器，用于接收分类结果或错误信息。             *                            通过实现 ClassifierListener 接口，可以在分类完成或出错时得到回调。             */</span>            <span class="token class-name">ImageClassifierHelper</span> classifierInstrument <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ImageClassifierHelper</span><span class="token punctuation">(</span><span class="token constant">CONFIDENCE_THRESHOLD</span><span class="token punctuation">,</span>                    <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> context<span class="token punctuation">,</span>                    <span class="token keyword">new</span> <span class="token class-name">ImageClassifierHelper<span class="token punctuation">.</span>ClassifierListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                        <span class="token annotation punctuation">@Override</span>                        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onError</span><span class="token punctuation">(</span><span class="token class-name">String</span> error<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string">"ClassifierHelper"</span><span class="token punctuation">,</span> <span class="token string">"is_instrument error: "</span> <span class="token operator">+</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>                            latch1<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 释放等待</span>                        <span class="token punctuation">&#125;</span>                        <span class="token annotation punctuation">@Override</span>                        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onResults</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Classifications</span><span class="token punctuation">></span></span> results<span class="token punctuation">,</span> <span class="token keyword">long</span> inferenceTime<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"testModel"</span><span class="token punctuation">,</span> <span class="token string">"is_instrument 推理耗时: "</span> <span class="token operator">+</span> inferenceTime <span class="token operator">+</span> <span class="token string">" ms"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                            instrumentFlag<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">isInstrument</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">;</span>                            latch1<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 释放等待</span>                        <span class="token punctuation">&#125;</span>                    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            classifierInstrument<span class="token punctuation">.</span><span class="token function">classify</span><span class="token punctuation">(</span>bitmap<span class="token punctuation">,</span> imageRotation<span class="token punctuation">)</span><span class="token punctuation">;</span>            latch1<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 等待推理完成</span>            classifierInstrument<span class="token punctuation">.</span><span class="token function">clearImageClassifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>instrumentFlag<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">return</span> <span class="token string">"Error: 未检测到仪表设备"</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token comment">// 3. 进行 is_install 推理</span>            <span class="token keyword">final</span> <span class="token keyword">boolean</span><span class="token punctuation">[</span><span class="token punctuation">]</span> installFlag <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">boolean</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token class-name">CountDownLatch</span> latch2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">ImageClassifierHelper</span> classifierInstall <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ImageClassifierHelper</span><span class="token punctuation">(</span><span class="token constant">CONFIDENCE_THRESHOLD</span><span class="token punctuation">,</span>                    <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> context<span class="token punctuation">,</span>                    <span class="token keyword">new</span> <span class="token class-name">ImageClassifierHelper<span class="token punctuation">.</span>ClassifierListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                        <span class="token annotation punctuation">@Override</span>                        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onError</span><span class="token punctuation">(</span><span class="token class-name">String</span> error<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string">"ClassifierHelper"</span><span class="token punctuation">,</span> <span class="token string">"is_install error: "</span> <span class="token operator">+</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>                            latch2<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 释放等待</span>                        <span class="token punctuation">&#125;</span>                        <span class="token annotation punctuation">@Override</span>                        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onResults</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Classifications</span><span class="token punctuation">></span></span> results<span class="token punctuation">,</span> <span class="token keyword">long</span> inferenceTime<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"testModel"</span><span class="token punctuation">,</span> <span class="token string">"is_install 推理耗时: "</span> <span class="token operator">+</span> inferenceTime <span class="token operator">+</span> <span class="token string">" ms"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                            installFlag<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">isInstall</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">;</span>                            latch2<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 释放等待</span>                        <span class="token punctuation">&#125;</span>                    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            classifierInstall<span class="token punctuation">.</span><span class="token function">classify</span><span class="token punctuation">(</span>bitmap<span class="token punctuation">,</span> imageRotation<span class="token punctuation">)</span><span class="token punctuation">;</span>            latch2<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 等待推理完成</span>            classifierInstall<span class="token punctuation">.</span><span class="token function">clearImageClassifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> installFlag<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">?</span> <span class="token string">"判断结果: 安装"</span> <span class="token operator">:</span> <span class="token string">"Error: 未安装"</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string">"testAlgo"</span><span class="token punctuation">,</span> <span class="token string">"Exception occurred"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token string">"Error: "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>bitmap <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>bitmap<span class="token punctuation">.</span><span class="token function">isRecycled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                bitmap<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token function">deleteFile</span><span class="token punctuation">(</span>tempFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 是不是仪表的判断逻辑，根据模型推理的结果判断     * 判断仪表设备：取第一个分类结果的第一个类别，     * 双条件判断：类别索引必须为1，并且置信度不低于阈值。     *     * @param results 推理返回的分类结果列表     * @return true 表示判断为仪表设备；false 表示不是     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">isInstrument</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Classifications</span><span class="token punctuation">></span></span> results<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>results <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> results<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Category</span><span class="token punctuation">></span></span> categories <span class="token operator">=</span> results<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCategories</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>categories <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> categories<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token class-name">Category</span> topCategory <span class="token operator">=</span> categories<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> top1Index <span class="token operator">=</span> topCategory<span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">float</span> top1Conf <span class="token operator">=</span> topCategory<span class="token punctuation">.</span><span class="token function">getScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> categoryName <span class="token operator">=</span> topCategory<span class="token punctuation">.</span><span class="token function">getLabel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"ClassifierHelper"</span><span class="token punctuation">,</span> <span class="token string">"[Debug] 模型类别名称: "</span> <span class="token operator">+</span> categoryName<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"ClassifierHelper"</span><span class="token punctuation">,</span> <span class="token string">"[Debug] 预测索引:"</span> <span class="token operator">+</span> top1Index <span class="token operator">+</span> <span class="token string">" 置信度:"</span> <span class="token operator">+</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%.2f"</span><span class="token punctuation">,</span> top1Conf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//        return (top1Index == 1) &amp;&amp; (top1Conf >= CONFIDENCE_THRESHOLD);</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span>top1Conf <span class="token operator">>=</span> <span class="token constant">CONFIDENCE_THRESHOLD</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>categoryName<span class="token punctuation">,</span> <span class="token string">"yibiao"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 是否安装的判断逻辑     * 判断安装情况：逻辑与 isInstrument 相同。     *     * @param results 推理返回的分类结果列表     * @return true 表示判断为“安装”；false 表示未安装     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">isInstall</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Classifications</span><span class="token punctuation">></span></span> results<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>results <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> results<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Category</span><span class="token punctuation">></span></span> categories <span class="token operator">=</span> results<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCategories</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>categories <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> categories<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token class-name">Category</span> topCategory <span class="token operator">=</span> categories<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> top1Index <span class="token operator">=</span> topCategory<span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">float</span> top1Conf <span class="token operator">=</span> topCategory<span class="token punctuation">.</span><span class="token function">getScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> categoryName <span class="token operator">=</span> topCategory<span class="token punctuation">.</span><span class="token function">getLabel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"ClassifierHelper"</span><span class="token punctuation">,</span> <span class="token string">"[Debug] 模型类别名称: "</span> <span class="token operator">+</span> categoryName<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"ClassifierHelper"</span><span class="token punctuation">,</span> <span class="token string">"[Debug] 预测索引:"</span> <span class="token operator">+</span> top1Index <span class="token operator">+</span> <span class="token string">" 置信度:"</span> <span class="token operator">+</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%.2f"</span><span class="token punctuation">,</span> top1Conf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//        return (top1Index == 1) &amp;&amp; (top1Conf >= CONFIDENCE_THRESHOLD);</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span>top1Conf <span class="token operator">>=</span> <span class="token constant">CONFIDENCE_THRESHOLD</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>categoryName<span class="token punctuation">,</span> <span class="token string">"installed"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 将 assets 路径下的图片复制到缓存区。 后续读取缓存区的绝对路径，opencv 需要读取图片的绝对路径。     * @param context         上下文对象     * @param assetFilePath  assets 下的图片文件名（例如 "testAlgo.jpg"）     * @param tempFilePath   缓存图片路径     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">copyFileFromAssets</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">String</span> assetFilePath<span class="token punctuation">,</span> <span class="token class-name">String</span> tempFilePath<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getAssets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span>assetFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token class-name">OutputStream</span> outputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span>tempFilePath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token keyword">int</span> length<span class="token punctuation">;</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>length <span class="token operator">=</span> inputStream<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                outputStream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            outputStream<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string">"FileUtils"</span><span class="token punctuation">,</span> <span class="token string">"Error copying file from assets: "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 删除缓存区的图片     *     * @param filePath 图片的路径     *     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">deleteFile</span><span class="token punctuation">(</span><span class="token class-name">String</span> filePath<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// 创建 File 对象</span>        <span class="token class-name">File</span> file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">// 删除文件</span>            <span class="token keyword">boolean</span> isDeleted <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>isDeleted<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token comment">// 删除成功</span>                <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"FileDeletion"</span><span class="token punctuation">,</span> <span class="token string">"文件删除成功: "</span> <span class="token operator">+</span> filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                <span class="token comment">// 删除失败</span>                <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string">"FileDeletion"</span><span class="token punctuation">,</span> <span class="token string">"文件删除失败: "</span> <span class="token operator">+</span> filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            <span class="token comment">// 文件不存在</span>            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"FileDeletion"</span><span class="token punctuation">,</span> <span class="token string">"文件不存在: "</span> <span class="token operator">+</span> filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><em>tensorflow</em> 提供的 <em>Category</em> 类，后续需要拿哪些数据可以查看 <em>get</em> 方法:</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@UsedByReflection</span><span class="token punctuation">(</span><span class="token string">"TFLiteSupport/Task"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Category</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">DEFAULT_INDEX</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">float</span> <span class="token constant">TOLERANCE</span> <span class="token operator">=</span> <span class="token number">1.0E-6F</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> index<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> label<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> displayName<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">float</span> score<span class="token punctuation">;</span>    <span class="token annotation punctuation">@UsedByReflection</span><span class="token punctuation">(</span><span class="token string">"TFLiteSupport/Task"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Category</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">String</span> label<span class="token punctuation">,</span> <span class="token class-name">String</span> displayName<span class="token punctuation">,</span> <span class="token keyword">float</span> score<span class="token punctuation">,</span> <span class="token keyword">int</span> index<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Category</span><span class="token punctuation">(</span>label<span class="token punctuation">,</span> displayName<span class="token punctuation">,</span> score<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@UsedByReflection</span><span class="token punctuation">(</span><span class="token string">"TFLiteSupport/Task"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Category</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">String</span> label<span class="token punctuation">,</span> <span class="token class-name">String</span> displayName<span class="token punctuation">,</span> <span class="token keyword">float</span> score<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Category</span><span class="token punctuation">(</span>label<span class="token punctuation">,</span> displayName<span class="token punctuation">,</span> score<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@UsedByReflection</span><span class="token punctuation">(</span><span class="token string">"TFLiteSupport/Task"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token class-name">Category</span><span class="token punctuation">(</span><span class="token class-name">String</span> label<span class="token punctuation">,</span> <span class="token keyword">float</span> score<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">(</span>label<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> score<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">private</span> <span class="token class-name">Category</span><span class="token punctuation">(</span><span class="token class-name">String</span> label<span class="token punctuation">,</span> <span class="token class-name">String</span> displayName<span class="token punctuation">,</span> <span class="token keyword">float</span> score<span class="token punctuation">,</span> <span class="token keyword">int</span> index<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>label <span class="token operator">=</span> label<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>displayName <span class="token operator">=</span> displayName<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>score <span class="token operator">=</span> score<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>index <span class="token operator">=</span> index<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getLabel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>label<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getDisplayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>displayName<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">float</span> <span class="token function">getScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>score<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>index<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>o <span class="token keyword">instanceof</span> <span class="token class-name">Category</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">Category</span> other <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Category</span><span class="token punctuation">)</span>o<span class="token punctuation">;</span>            <span class="token keyword">return</span> other<span class="token punctuation">.</span><span class="token function">getLabel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>label<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> other<span class="token punctuation">.</span><span class="token function">getDisplayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>displayName<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span><span class="token function">getScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>score<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1.0E-6F</span> <span class="token operator">&amp;&amp;</span> other<span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>index<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>label<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>displayName<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>score<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>index<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token string">"&lt;Category \""</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>label <span class="token operator">+</span> <span class="token string">"\" (displayName="</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>displayName <span class="token operator">+</span> <span class="token string">" score="</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>score <span class="token operator">+</span> <span class="token string">" index="</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>index <span class="token operator">+</span> <span class="token string">")>"</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="测试结果"><a class="markdownIt-Anchor" href="#测试结果"></a> 测试结果</h3><blockquote><p>使用 模糊图片：vague.jpg</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 测试 算法判断逻辑 testAlgo</span> <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">testAlgo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>     <span class="token class-name">String</span> assetFilePath <span class="token operator">=</span> <span class="token string">"uninstall.jpg"</span><span class="token punctuation">;</span>     <span class="token class-name">String</span> tempDir <span class="token operator">=</span> <span class="token function">getCacheDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 复制到缓存区以获得绝对路径</span>     <span class="token class-name">String</span> tempFilePath <span class="token operator">=</span> tempDir <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> assetFilePath<span class="token punctuation">;</span>     <span class="token comment">// 将图片从 assets 目录复制到临时目录</span>     test<span class="token punctuation">.</span><span class="token function">copyFileFromAssets</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> assetFilePath<span class="token punctuation">,</span> tempFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token class-name">String</span> s <span class="token operator">=</span> test<span class="token punctuation">.</span><span class="token function">testAlgo</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> tempFilePath<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"testAlgo"</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/Android/202503131409708.png" alt="image-20250313140926419" /></p></blockquote><blockquote><p>使用 不是仪表的图片：mouse.jpg</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 测试 算法判断逻辑 testAlgo</span><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">testAlgo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">String</span> assetFilePath <span class="token operator">=</span> <span class="token string">"mouse.jpg"</span><span class="token punctuation">;</span>    <span class="token class-name">String</span> tempDir <span class="token operator">=</span> <span class="token function">getCacheDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 复制到缓存区以获得绝对路径</span>    <span class="token class-name">String</span> tempFilePath <span class="token operator">=</span> tempDir <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> assetFilePath<span class="token punctuation">;</span>    <span class="token comment">// 将图片从 assets 目录复制到临时目录</span>    test<span class="token punctuation">.</span><span class="token function">copyFileFromAssets</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> assetFilePath<span class="token punctuation">,</span> tempFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">String</span> s <span class="token operator">=</span> test<span class="token punctuation">.</span><span class="token function">testAlgo</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> tempFilePath<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"testAlgo"</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/Android/202503131412572.png" alt="image-20250313141212485" /></p></blockquote><blockquote><p>使用 仪表未安装的图片：uninstall.jpg</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 测试 算法判断逻辑 testAlgo</span><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">testAlgo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">String</span> assetFilePath <span class="token operator">=</span> <span class="token string">"uninstall.jpg"</span><span class="token punctuation">;</span>    <span class="token class-name">String</span> tempDir <span class="token operator">=</span> <span class="token function">getCacheDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 复制到缓存区以获得绝对路径</span>    <span class="token class-name">String</span> tempFilePath <span class="token operator">=</span> tempDir <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> assetFilePath<span class="token punctuation">;</span>    <span class="token comment">// 将图片从 assets 目录复制到临时目录</span>    test<span class="token punctuation">.</span><span class="token function">copyFileFromAssets</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> assetFilePath<span class="token punctuation">,</span> tempFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">String</span> s <span class="token operator">=</span> test<span class="token punctuation">.</span><span class="token function">testAlgo</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> tempFilePath<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"testAlgo"</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/Android/202503131413469.png" alt="image-20250313141343393" /></p></blockquote><blockquote><p>使用 正常安装的仪表图片：normal.jpg</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 测试 算法判断逻辑 testAlgo</span><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">testAlgo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">String</span> assetFilePath <span class="token operator">=</span> <span class="token string">"normal.jpg"</span><span class="token punctuation">;</span>    <span class="token class-name">String</span> tempDir <span class="token operator">=</span> <span class="token function">getCacheDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 复制到缓存区以获得绝对路径</span>    <span class="token class-name">String</span> tempFilePath <span class="token operator">=</span> tempDir <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> assetFilePath<span class="token punctuation">;</span>    <span class="token comment">// 将图片从 assets 目录复制到临时目录</span>    test<span class="token punctuation">.</span><span class="token function">copyFileFromAssets</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> assetFilePath<span class="token punctuation">,</span> tempFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">String</span> s <span class="token operator">=</span> test<span class="token punctuation">.</span><span class="token function">testAlgo</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> tempFilePath<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"testAlgo"</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/Android/202503131414341.png" alt="image-20250313141459263" /></p></blockquote><h3 id="失败尝试"><a class="markdownIt-Anchor" href="#失败尝试"></a> 失败尝试</h3><ul><li><blockquote><p>算法使用 <em>yolov8n-cls</em> 预训练模型再使用数据集进行训练得到 <em>.pt</em> 模型文件，由于是基于 <em>pytorch</em> 训练的，模型的输入和神经网络的一些内部结构与 <em>tensorflow</em> 不兼容，在 <em>github</em> 上找到了 <em>pytorch</em> 官方安卓项目例程：</p><p><a href="https://github.com/pytorch/android-demo-app">https://github.com/pytorch/android-demo-app</a></p><p>集成到此安卓项目后，官方提供的 <em><a href="http://model.pt">model.pt</a></em> 模型文件可以跑通，但是通过 <em>yolo</em> 训练得到的模型文件会报错：</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/Android/202503131230661.png" alt="image-20250313123051589" /></p><p>可能是版本不兼容的问题，也有可能与 <em>yolo</em> 模型内部的结构有关。</p></blockquote></li><li><blockquote><p>算法在预训练模型 <em>mobilenet</em> 的基础上采用 <em>tensorflow</em> 进行训练，转换成 <em>tflite</em> 模型文件后，出现错误：</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/Android/202503131231057.png" alt="image-20250313123135002" /></p><p>原因是找不到模型的 <strong>元数据</strong> ，尝试 <em>tensorflow</em> 官方提供的添加元数据的脚本文件：</p><p><a href="https://github.com/tensorflow/examples/tree/master/lite/examples/image_classification/metadata">https://github.com/tensorflow/examples/tree/master/lite/examples/image_classification/metadata</a></p><p>会出现很多的 <em>python</em> 环境包冲突问题</p></blockquote></li></ul>]]></content>
      
      
      <categories>
          
          <category> 环境搭建 </category>
          
          <category> 视觉 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> OpenCV </tag>
            
            <tag> Python </tag>
            
            <tag> Java </tag>
            
            <tag> TFlite </tag>
            
            <tag> Pytorch </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>安卓项目集成python环境</title>
      <link href="/2025/05/19/%E5%AE%89%E5%8D%93%E9%A1%B9%E7%9B%AE%E9%9B%86%E6%88%90python%E7%8E%AF%E5%A2%83/"/>
      <url>/2025/05/19/%E5%AE%89%E5%8D%93%E9%A1%B9%E7%9B%AE%E9%9B%86%E6%88%90python%E7%8E%AF%E5%A2%83/</url>
      
        <content type="html"><![CDATA[<h2 id="集成-chaquopy"><a class="markdownIt-Anchor" href="#集成-chaquopy"></a> 集成 Chaquopy</h2><h3 id="配置环境"><a class="markdownIt-Anchor" href="#配置环境"></a> 配置环境</h3><p>在顶级 <em>build.gradle</em>  中加入：</p><pre class="line-numbers language-groovy" data-language="groovy"><code class="language-groovy">plugins <span class="token punctuation">&#123;</span>       id <span class="token interpolation-string"><span class="token string">"com.chaquo.python"</span></span> version <span class="token interpolation-string"><span class="token string">"15.0.1"</span></span> apply <span class="token boolean">false</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>在模块级 <em>build.gradle</em> 中加入：</p><pre class="line-numbers language-groovy" data-language="groovy"><code class="language-groovy">plugins <span class="token punctuation">&#123;</span>    id <span class="token interpolation-string"><span class="token string">"com.chaquo.python"</span></span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-groovy" data-language="groovy"><code class="language-groovy">android <span class="token punctuation">&#123;</span>    defaultConfig <span class="token punctuation">&#123;</span>         ndk <span class="token punctuation">&#123;</span>            abiFilters <span class="token interpolation-string"><span class="token string">"arm64-v8a"</span></span><span class="token punctuation">,</span> <span class="token interpolation-string"><span class="token string">"x86_64"</span></span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-groovy" data-language="groovy"><code class="language-groovy">chaquopy <span class="token punctuation">&#123;</span>    defaultConfig <span class="token punctuation">&#123;</span>    <span class="token comment">// 替换路径 我使用的是 python 3.8.19</span>        <span class="token function">buildPython</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">"D:\\Users\\L\\anaconda3\\envs\\yolo\\python.exe"</span></span><span class="token punctuation">)</span>        version <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">"3.8"</span></span>        pip <span class="token punctuation">&#123;</span>            <span class="token function">options</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">"--index-url"</span></span><span class="token punctuation">,</span> <span class="token interpolation-string"><span class="token string">"https://chaquo.com/pypi-13.1/"</span></span><span class="token punctuation">)</span>            <span class="token comment">// A requirement specifier, with or without a version number:</span>            <span class="token function">install</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">"numpy"</span></span><span class="token punctuation">)</span>            <span class="token function">install</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">"opencv-python"</span></span><span class="token punctuation">)</span>            <span class="token comment">// "-r"` followed by a requirements filename, relative to the project directory:</span>            <span class="token comment">//  install("-r", "requirements.txt")</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    productFlavors <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span>    sourceSets <span class="token punctuation">&#123;</span>        <span class="token function">getByName</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">"main"</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">srcDir</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">"src/main/python"</span></span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>版本兼容表：</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/Android/202503062114297.png" alt="image-20250306211455240" /></p><p>[<a href="https://chaquo.com/chaquopy/doc/current/versions.html">Version summary - Chaquopy</a>](<a href="https://chaquo.com/chaquopy/doc/current/versions.html">https://chaquo.com/chaquopy/doc/current/versions.html</a>)</p><p>包仓库：</p><p><a href="https://chaquo.com/pypi-13.1/">https://chaquo.com/pypi-13.1/</a></p><p>全局使用 <em>python</em> ，在 <em>AndroidManifest.xml</em> 中的 <em>&lt;application…/&gt;</em> 添加以下属性:</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup">android:name="com.chaquo.python.android.PyApplication"<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>官方文档：[<a href="https://chaquo.com/chaquopy/doc/15.0/">Chaquopy 15.0</a>](<a href="https://chaquo.com/chaquopy/doc/15.0/">https://chaquo.com/chaquopy/doc/15.0/</a>)</p><h3 id="编写程序验证"><a class="markdownIt-Anchor" href="#编写程序验证"></a> 编写程序验证</h3><p>在 <em>src/main/</em> 新建 <em>pyhton</em> 文件夹存放 <em>python</em> 文件 <em><a href="http://algoTest.py">algoTest.py</a></em></p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> cv2<span class="token keyword">def</span> <span class="token function">algoFunc</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> imgAddressList<span class="token punctuation">)</span><span class="token punctuation">:</span>    res <span class="token operator">=</span> <span class="token string">"error"</span>    <span class="token keyword">if</span> code <span class="token operator">==</span> <span class="token string">"1"</span><span class="token punctuation">:</span>        res <span class="token operator">=</span> algo1<span class="token punctuation">(</span>imgAddressList<span class="token punctuation">)</span>    <span class="token keyword">return</span> res<span class="token keyword">def</span> <span class="token function">algo1</span><span class="token punctuation">(</span>imgAddressList<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># OpenCV 测试程序</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        <span class="token comment"># 遍历Java的ArrayList对象</span>        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>imgAddressList<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            img_path <span class="token operator">=</span> imgAddressList<span class="token punctuation">.</span>get<span class="token punctuation">(</span>i<span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>img_path<span class="token punctuation">)</span>            img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>img_path<span class="token punctuation">)</span>            <span class="token keyword">if</span> img <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>                <span class="token comment"># 如果图像加载成功，返回成功信息</span>                <span class="token keyword">return</span> <span class="token string">"成功加载图像："</span> <span class="token operator">+</span> img_path <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span>  cv2<span class="token punctuation">.</span>__version__            <span class="token keyword">else</span><span class="token punctuation">:</span>                <span class="token keyword">return</span> <span class="token string">"图像加载失败："</span> <span class="token operator">+</span> img_path <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> cv2<span class="token punctuation">.</span>__version__    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string">"OpenCV 测试失败："</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>新建 <em>algo</em> 文件夹，新建 <em>test</em> 类</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>gxl_recognitionsystem<span class="token punctuation">.</span>algo</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>content<span class="token punctuation">.</span></span><span class="token class-name">Context</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span></span><span class="token class-name">Bitmap</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span></span><span class="token class-name">BitmapFactory</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Log</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>chaquo<span class="token punctuation">.</span>python<span class="token punctuation">.</span></span><span class="token class-name">PyObject</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>chaquo<span class="token punctuation">.</span>python<span class="token punctuation">.</span></span><span class="token class-name">Python</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>tensorflow<span class="token punctuation">.</span>lite<span class="token punctuation">.</span>task<span class="token punctuation">.</span>vision<span class="token punctuation">.</span>classifier<span class="token punctuation">.</span></span><span class="token class-name">Classifications</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">InputStream</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> test <span class="token punctuation">&#123;</span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">testPython</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">String</span> code<span class="token punctuation">,</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> imgAddressArrayList<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">Python</span> py <span class="token operator">=</span> <span class="token class-name">Python</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>            <span class="token comment">// 转换数据类型，将路径传递给 Python</span>            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PyObject</span><span class="token punctuation">></span></span> imgAddressList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PyObject</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> imgPath <span class="token operator">:</span> imgAddressArrayList<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                imgAddressList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">PyObject</span><span class="token punctuation">.</span><span class="token function">fromJava</span><span class="token punctuation">(</span>imgPath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token class-name">PyObject</span> result <span class="token operator">=</span> py<span class="token punctuation">.</span><span class="token function">getModule</span><span class="token punctuation">(</span><span class="token string">"algoTest"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">callAttr</span><span class="token punctuation">(</span><span class="token string">"algoFunc"</span><span class="token punctuation">,</span> code<span class="token punctuation">,</span> imgAddressList<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// 将 Python 返回值转换为 Java 字符串</span>            <span class="token class-name">String</span> response <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">toJava</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"PythonCall"</span><span class="token punctuation">,</span> <span class="token string">"Response from Python: "</span> <span class="token operator">+</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string">"PythonCall"</span><span class="token punctuation">,</span> <span class="token string">"Error accessing assets: "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 将 assets 路径下的图片复制到缓存区。 后续读取缓存区的绝对路径，opencv 需要读取图片的绝对路径。     * @param context         上下文对象     * @param assetFilePath  assets 下的图片文件名（例如 "testAlgo.jpg"）     * @param tempFilePath   缓存图片路径     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">copyFileFromAssets</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">String</span> assetFilePath<span class="token punctuation">,</span> <span class="token class-name">String</span> tempFilePath<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getAssets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span>assetFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token class-name">OutputStream</span> outputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span>tempFilePath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token keyword">int</span> length<span class="token punctuation">;</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>length <span class="token operator">=</span> inputStream<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                outputStream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            outputStream<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string">"FileUtils"</span><span class="token punctuation">,</span> <span class="token string">"Error copying file from assets: "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><!--因为opencv需要使用绝对路径读取图片，所以将assets里的图片复制到缓存区，再用opencv读取缓存区图片路径--><p>在 <em>Adminstrators_MainActivity</em> 中加入：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>chaquo<span class="token punctuation">.</span>python<span class="token punctuation">.</span>android<span class="token punctuation">.</span></span><span class="token class-name">AndroidPlatform</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>chaquo<span class="token punctuation">.</span>python<span class="token punctuation">.</span></span><span class="token class-name">Python</span></span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Administrators_MainActivity</span> <span class="token keyword">extends</span> <span class="token class-name">Activity</span> <span class="token keyword">implements</span> <span class="token class-name">View<span class="token punctuation">.</span>OnClickListener</span> <span class="token punctuation">&#123;</span><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token class-name">Bundle</span> savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 初始化Python环境</span>    <span class="token function">initPython</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">testPythonCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 初始化Python环境</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initPython</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token class-name">Python</span><span class="token punctuation">.</span><span class="token function">isStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">Python</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AndroidPlatform</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// 调用python代码</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">testPythonCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> assetsImgList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> tempDirImgList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        assetsImgList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"testAlgo.jpg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> tempDir <span class="token operator">=</span> <span class="token function">getCacheDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 复制到缓存区以获得绝对路径</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> assetFilePath  <span class="token operator">:</span> assetsImgList<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">String</span> tempFilePath <span class="token operator">=</span> tempDir <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> assetFilePath<span class="token punctuation">;</span>            tempDirImgList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>tempFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// 将图片从 assets 目录复制到临时目录</span>            <span class="token class-name">FileUtils</span><span class="token punctuation">.</span><span class="token function">copyFileFromAssets</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> assetFilePath<span class="token punctuation">,</span> tempFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        testAlgo<span class="token punctuation">.</span><span class="token function">testPython</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">,</span> tempDirImgList<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>运行，测试结果如下：</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/Android/202503062115064.png" alt="image-20250306211537016" /></p><p>/data/user/0/com.gxl_recognitionsystem/cache/testAlgo.jpg 是图片在安卓手机上的绝对路径</p><p>4.5.1 是 <em>opencv</em> 的版本号</p>]]></content>
      
      
      <categories>
          
          <category> 环境搭建 </category>
          
          <category> 视觉 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> OpenCV </tag>
            
            <tag> Python </tag>
            
            <tag> Java </tag>
            
            <tag> Chaquopy </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>安装cuda和pytorch</title>
      <link href="/2025/05/19/%E5%AE%89%E8%A3%85cuda%E5%92%8Cpytorch/"/>
      <url>/2025/05/19/%E5%AE%89%E8%A3%85cuda%E5%92%8Cpytorch/</url>
      
        <content type="html"><![CDATA[<h2 id="查看显卡驱动版本"><a class="markdownIt-Anchor" href="#查看显卡驱动版本"></a> 查看显卡驱动版本</h2><p>查看cuda版本支持：</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/linux_camera/202503111803366.png" alt="image-20250311180335312" /></p><p>终端输入：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">nvidia-smi<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>最高支持12.7</p><p>下载CUDA Toolkit 12.6 Update 3</p><h2 id="创建conda环境"><a class="markdownIt-Anchor" href="#创建conda环境"></a> 创建conda环境</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">conda create <span class="token parameter variable">-n</span> env-name <span class="token assign-left variable">python</span><span class="token operator">=</span><span class="token number">3.11</span>.5<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="下载pytorch"><a class="markdownIt-Anchor" href="#下载pytorch"></a> 下载pytorch</h2><p>[<a href="https://pytorch.org/get-started/locally/">Start Locally | PyTorch</a>](<a href="https://pytorch.org/get-started/locally/">https://pytorch.org/get-started/locally/</a>)</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/linux_camera/202503111854319.png" alt="image-20250311185414247" /></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pip3 <span class="token function">install</span> torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu126<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/linux_camera/202503111900945.png" alt="image-20250311190011897" /></p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/linux_camera/202503111859376.png" alt="image-20250311185958340" /></p><h2 id="卸载pytorch"><a class="markdownIt-Anchor" href="#卸载pytorch"></a> 卸载pytorch</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pip uninstall torch torchvision torchaudio<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 环境搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Pytorch </tag>
            
            <tag> Cuda </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vscode与cmake</title>
      <link href="/2025/05/19/vscode%E4%B8%8Ecmake/"/>
      <url>/2025/05/19/vscode%E4%B8%8Ecmake/</url>
      
        <content type="html"><![CDATA[<h2 id="vscode-使用-cmake-构建工程"><a class="markdownIt-Anchor" href="#vscode-使用-cmake-构建工程"></a> vscode 使用 cmake 构建工程</h2><h3 id="多文件编译"><a class="markdownIt-Anchor" href="#多文件编译"></a> 多文件编译：</h3><ul><li><p>指定cmake 编译器 g++ ;</p></li><li><ul><li>CMakeLists.txt文件中</li><li><ul><li>setexcable</li><li>add_definitions(&quot;-Wall -g&quot;)</li></ul></li></ul></li><li><p>在build 文件夹下 执行<code>cmake -G &quot;MinGW Makefiles&quot; ..</code>，会在build 文件夹下生成makefile</p></li><li><p>windows 下的 make： mingw32-make.exe</p></li></ul><blockquote><p>更改后若要调试，先用cmake 和 mingw32-make.exe生成一下可执行文件，或者编写tasks.json</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 环境搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C++ </tag>
            
            <tag> Vscode </tag>
            
            <tag> Camke </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vscode与clangd</title>
      <link href="/2025/05/19/vscode%E4%B8%8Eclangd/"/>
      <url>/2025/05/19/vscode%E4%B8%8Eclangd/</url>
      
        <content type="html"><![CDATA[<h2 id="vscode-安装-clangd-出现找不到头文件"><a class="markdownIt-Anchor" href="#vscode-安装-clangd-出现找不到头文件"></a> vscode 安装 clangd 出现找不到头文件</h2><h3 id="编写settingsjson"><a class="markdownIt-Anchor" href="#编写settingsjson"></a> 编写settings.json</h3><p>在 <code>.vscode</code> 目录下的 <code>setting.json</code> 中加入</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token property">"clangd.arguments"</span><span class="token operator">:</span> <span class="token punctuation">[</span>        <span class="token string">"--background-index"</span><span class="token punctuation">,</span>        <span class="token string">"--compile-commands-dir=build"</span><span class="token punctuation">,</span>  <span class="token comment">//compile_command.json相对路径，cmake默认生成在build，自行配置</span>        <span class="token string">"-j=12"</span><span class="token punctuation">,</span>        <span class="token string">"--all-scopes-completion"</span><span class="token punctuation">,</span>        <span class="token string">"--completion-style=detailed"</span><span class="token punctuation">,</span>        <span class="token string">"--header-insertion=iwyu"</span><span class="token punctuation">,</span>        <span class="token string">"--pch-storage=memory"</span><span class="token punctuation">,</span>        <span class="token string">"--cross-file-rename"</span><span class="token punctuation">,</span>        <span class="token string">"--enable-config"</span><span class="token punctuation">,</span>        <span class="token string">"--fallback-style=WebKit"</span><span class="token punctuation">,</span>        <span class="token string">"--pretty"</span><span class="token punctuation">,</span>        <span class="token string">"--clang-tidy"</span><span class="token punctuation">,</span>        <span class="token comment">// 网上别人配置clang++，但我这边windows、linux实测不加这行也没啥问题，可能mac可能需要另外加</span>        <span class="token string">"--query-driver=C:/mingw/bin/g*"</span><span class="token punctuation">,</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="更好地方法"><a class="markdownIt-Anchor" href="#更好地方法"></a> 更好地方法</h3><p>在项目根目录下创建 <code>.clangd</code>  文件</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># Fragment common to C and C++ source files</span><span class="token key atrule">CompileFlags</span><span class="token punctuation">:</span>    <span class="token key atrule">Add</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> "<span class="token punctuation">-</span><span class="token punctuation">-</span>include<span class="token punctuation">-</span>directory=./include"   // 相对路径 <span class="token punctuation">-</span> "<span class="token punctuation">-</span><span class="token punctuation">-</span>include<span class="token punctuation">-</span>directory=C<span class="token punctuation">:</span>/code_project/cfiles test/include"   // 绝对路径<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 环境搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C++ </tag>
            
            <tag> Vscode </tag>
            
            <tag> Clangd </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>git指南</title>
      <link href="/2025/05/19/git%E6%8C%87%E5%8D%97/"/>
      <url>/2025/05/19/git%E6%8C%87%E5%8D%97/</url>
      
        <content type="html"><![CDATA[<h2 id="git指南"><a class="markdownIt-Anchor" href="#git指南"></a> git指南</h2><hr /><h3 id="新建仓库"><a class="markdownIt-Anchor" href="#新建仓库"></a> 新建仓库</h3><h4 id="远程仓库"><a class="markdownIt-Anchor" href="#远程仓库"></a> 远程仓库</h4><p>在 <code>github</code> 上创建新仓库</p><h4 id="本地仓库"><a class="markdownIt-Anchor" href="#本地仓库"></a> 本地仓库</h4><p><code>github</code> 已经创建新仓库，使用以下命令初始化本地仓库并推送到远程仓库</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 进入项目根目录</span><span class="token builtin class-name">cd</span> ~/your-project-folder<span class="token comment"># 初始化 Git 仓库</span><span class="token function">git</span> init<span class="token comment"># 创建 .gitignore 文件（可选）</span><span class="token builtin class-name">echo</span> <span class="token string">"*.log"</span> <span class="token operator">>></span> .gitignore<span class="token builtin class-name">echo</span> <span class="token string">"tmp/"</span> <span class="token operator">>></span> .gitignore<span class="token comment"># 添加所有文件到暂存区</span><span class="token function">git</span> <span class="token function">add</span> <span class="token builtin class-name">.</span><span class="token comment"># 提交代码</span><span class="token function">git</span> commit <span class="token parameter variable">-m</span> <span class="token string">"初始提交：***项目"</span><span class="token comment"># 关联远程仓库（替换 YOUR-USERNAME）</span><span class="token function">git</span> remote <span class="token function">add</span> origin https://github.com/YOUR-USERNAME/nginx-streaming-demos.git<span class="token comment"># 推送到 GitHub</span><span class="token function">git</span> branch <span class="token parameter variable">-M</span> main<span class="token function">git</span> push <span class="token parameter variable">-u</span> origin main<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="已有远程仓库与本地仓库"><a class="markdownIt-Anchor" href="#已有远程仓库与本地仓库"></a> 已有远程仓库与本地仓库</h3><p>有修改，需更新</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查看当前分支</span><span class="token function">git</span> branch<span class="token comment"># 如果要切换到其他分支</span><span class="token function">git</span> checkout <span class="token operator">&lt;</span>branch-name<span class="token operator">></span><span class="token comment"># 将更改添加到本地暂存区</span><span class="token function">git</span> <span class="token function">add</span> <span class="token builtin class-name">.</span><span class="token comment"># 如果只是指定文件</span><span class="token function">git</span> <span class="token function">add</span> <span class="token operator">&lt;</span>file-name<span class="token operator">></span><span class="token comment"># 提交更改</span><span class="token function">git</span> commit <span class="token parameter variable">-m</span> <span class="token string">"Your commit message"</span><span class="token comment"># 推送</span><span class="token function">git</span> push<span class="token comment"># 如果没有设置上游分支，要指定分支</span><span class="token function">git</span> push origin <span class="token operator">&lt;</span>branch-name<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="完整重置仓库"><a class="markdownIt-Anchor" href="#完整重置仓库"></a> 完整重置仓库</h3><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"># 备份当前仓库cd <span class="token punctuation">.</span><span class="token punctuation">.</span>cp <span class="token operator">-</span>r current_project project<span class="token operator">-</span>bak# 重新克隆仓库git clone <span class="token operator">&lt;</span>您的远程仓库地址<span class="token operator">></span> project<span class="token operator">-</span><span class="token keyword">new</span># 验证新仓库cd project<span class="token operator">-</span><span class="token keyword">new</span>git branch <span class="token operator">-</span>a  # 应正常显示<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="一-git-基础概念"><a class="markdownIt-Anchor" href="#一-git-基础概念"></a> <strong>一、Git 基础概念</strong></h3><ol><li><p><strong>仓库（Repository）</strong></p><ul><li><p>存储代码历史与版本的核心目录，通过</p><p>初始化本地仓库。</p></li><li><p>克隆远程仓库：</p><pre class="line-numbers language-none"><code class="language-none">git clone &lt;仓库地址&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>（自动关联远程源）。</p></li></ul></li><li><p><strong>工作流程三区</strong></p><ul><li><p><strong>工作区</strong>：本地修改文件的目录。</p></li><li><p>暂存区（Staging Area）：</p><p>临时保存待提交的修改（</p><pre class="line-numbers language-none"><code class="language-none">git add<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>添加至此）。</p></li><li><p>本地仓库：</p><p>通过</p><pre class="line-numbers language-none"><code class="language-none">git commit<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>将暂存区内容永久存储为版本。</p></li></ul></li></ol><hr /><h3 id="二-环境配置"><a class="markdownIt-Anchor" href="#二-环境配置"></a> <strong>二、环境配置</strong></h3><ol><li><p><strong>安装 Git</strong></p><ul><li><p>Windows：</p><p>官网下载安装包。</p></li><li><p>macOS：</p><pre class="line-numbers language-none"><code class="language-none">brew install git<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>（Homebrew）或 Xcode Command Line Tools。</p></li><li><p>Linux：</p><pre class="line-numbers language-none"><code class="language-none">sudo apt install git<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>（Debian/Ubuntu）或</p><pre class="line-numbers language-none"><code class="language-none">sudo yum install git<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>（CentOS）。</p></li></ul></li><li><p><strong>全局配置</strong></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> config <span class="token parameter variable">--global</span> user.name <span class="token string">"Your Name"</span><span class="token function">git</span> config <span class="token parameter variable">--global</span> user.email <span class="token string">"your@email.com"</span><span class="token function">git</span> config <span class="token parameter variable">--global</span> color.ui <span class="token boolean">true</span>  <span class="token comment"># 启用颜色高亮</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li></ol><hr /><h3 id="三-日常操作命令"><a class="markdownIt-Anchor" href="#三-日常操作命令"></a> <strong>三、日常操作命令</strong></h3><table><thead><tr><th style="text-align:center"><strong>操作</strong></th><th style="text-align:center"><strong>命令示例</strong></th><th style="text-align:center"><strong>说明</strong></th></tr></thead><tbody><tr><td style="text-align:center">查看状态</td><td style="text-align:center"><code>git status</code></td><td style="text-align:center">显示工作区/暂存区状态</td></tr><tr><td style="text-align:center">添加文件到暂存区</td><td style="text-align:center"><code>git add &lt;文件名&gt;</code> 或 <code>git add .</code></td><td style="text-align:center">跟踪修改/新增文件</td></tr><tr><td style="text-align:center">提交到本地仓库</td><td style="text-align:center"><code>git commit -m &quot;描述&quot;</code></td><td style="text-align:center">生成新版本记录</td></tr><tr><td style="text-align:center">查看提交历史</td><td style="text-align:center"><code>git log --oneline --graph</code></td><td style="text-align:center">简洁化日志（含分支拓扑）</td></tr><tr><td style="text-align:center">推送代码到远程</td><td style="text-align:center"><code>git push origin &lt;分支名&gt;</code></td><td style="text-align:center">首次推送加 <code>-u</code> 设置上游</td></tr><tr><td style="text-align:center">拉取远程更新</td><td style="text-align:center"><code>git pull --rebase</code></td><td style="text-align:center">变基拉取（保持历史线性）</td></tr><tr><td style="text-align:center">撤销工作区修改</td><td style="text-align:center"><code>git checkout -- &lt;文件名&gt;</code></td><td style="text-align:center">放弃未暂存的修改</td></tr><tr><td style="text-align:center">撤销暂存区文件</td><td style="text-align:center"><code>git reset HEAD &lt;文件名&gt;</code></td><td style="text-align:center">移出暂存区</td></tr></tbody></table><hr /><h3 id="四-分支管理"><a class="markdownIt-Anchor" href="#四-分支管理"></a> <strong>四、分支管理</strong></h3><ol><li><p><strong>分支操作</strong></p><ul><li><p>创建并切换分支：</p><pre class="line-numbers language-none"><code class="language-none">git checkout -b feature&#x2F;new<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>合并分支：先切回主分支</p><pre class="line-numbers language-none"><code class="language-none">git checkout main<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>，再执行</p><pre class="line-numbers language-none"><code class="language-none">git merge feature&#x2F;new<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>删除分支：</p><pre class="line-numbers language-none"><code class="language-none">git branch -d feature&#x2F;new<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>（安全删除）。</p></li></ul></li><li><p><strong>分支策略（推荐）</strong></p><table><thead><tr><th style="text-align:center"><strong>分支类型</strong></th><th style="text-align:center"><strong>用途</strong></th></tr></thead><tbody><tr><td style="text-align:center"><code>main/master</code></td><td style="text-align:center">稳定生产版本，禁止直接修改<strong>3****10</strong>。</td></tr><tr><td style="text-align:center"><code>develop</code></td><td style="text-align:center">集成开发分支，测试稳定后合并至主分支<strong>3****10</strong>。</td></tr><tr><td style="text-align:center"><code>feature/*</code></td><td style="text-align:center">新功能开发分支<strong>3****10</strong>。</td></tr><tr><td style="text-align:center"><code>hotfix/*</code></td><td style="text-align:center">紧急生产环境修复<strong>3****10</strong>。</td></tr></tbody></table></li></ol><hr /><h3 id="五-高级技巧与最佳实践"><a class="markdownIt-Anchor" href="#五-高级技巧与最佳实践"></a> <strong>五、高级技巧与最佳实践</strong></h3><ol><li><p><strong>代码回退与恢复</strong></p><ul><li><p>回退到上一版本：</p><pre class="line-numbers language-none"><code class="language-none">git reset --hard HEAD^<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>恢复误删提交：</p><pre class="line-numbers language-none"><code class="language-none">git reflog<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>查历史操作</p><pre class="line-numbers language-none"><code class="language-none">git reset --hard &lt;commit-id&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ul></li><li><p><strong>冲突解决</strong></p><ul><li><p>拉取时冲突：手动修改冲突文件</p><pre class="line-numbers language-none"><code class="language-none">git add &lt;文件&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-none"><code class="language-none">git commit<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>完成合并。</p></li><li><p>图形化工具：</p><pre class="line-numbers language-none"><code class="language-none">git mergetool<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>（需配置 diff 工具如 VSCode）。</p></li></ul></li><li><p><strong>忽略文件（.gitignore）</strong></p><ul><li><p>创建文件，排除日志、编译产物等：</p><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">node_modules/.env*.logdist/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>生效步骤：若已跟踪文件需先删除缓存</p><pre class="line-numbers language-none"><code class="language-none">git rm -r --cached .<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>重新提交。</p></li></ul></li><li><p><strong>提交规范</strong><br />推荐语义化提交（Conventional Commits）：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> commit <span class="token parameter variable">-m</span> <span class="token string">"feat: 新增用户登录功能"</span><span class="token function">git</span> commit <span class="token parameter variable">-m</span> <span class="token string">"fix: 修复支付接口崩溃 #123"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><strong>类型</strong>：<code>feat</code>（功能）、<code>fix</code>（修复）、<code>docs</code>（文档）、<code>refactor</code>（重构）等。</p></li></ol><hr /><h3 id="六-学习资源与工具"><a class="markdownIt-Anchor" href="#六-学习资源与工具"></a> <strong>六、学习资源与工具</strong></h3><ul><li><p>交互式练习：</p><p>Learn Git Branching（可视化分支操作）。</p></li><li><p>图形化客户端：</p><ul><li>GitHub Desktop（新手友好）</li><li>VS Code + GitLens 插件（代码追溯增强）</li></ul></li><li><p>官方文档：</p><p>Git Book（全面详解）</p></li></ul><hr /><p>掌握 Git 的核心在于 <strong>理解工作流三区</strong> 和 <strong>分支管理逻辑</strong>，配合规范提交与团队协作策略，可大幅提升开发效率。建议从基础命令入手，逐步实践分支合并与冲突解决，再深入高级功能（如 <code>rebase</code>、<code>stash</code>）。</p>]]></content>
      
      
      <categories>
          
          <category> 笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Git </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>nuxt3项目使用docker部署在华为云上</title>
      <link href="/2025/05/19/nuxt3%E9%A1%B9%E7%9B%AE%E4%BD%BF%E7%94%A8docker%E9%83%A8%E7%BD%B2%E5%9C%A8%E5%8D%8E%E4%B8%BA%E4%BA%91%E4%B8%8A/"/>
      <url>/2025/05/19/nuxt3%E9%A1%B9%E7%9B%AE%E4%BD%BF%E7%94%A8docker%E9%83%A8%E7%BD%B2%E5%9C%A8%E5%8D%8E%E4%B8%BA%E4%BA%91%E4%B8%8A/</url>
      
        <content type="html"><![CDATA[<h2 id="购买华为云服务器"><a class="markdownIt-Anchor" href="#购买华为云服务器"></a> 购买华为云服务器</h2><h3 id="配置"><a class="markdownIt-Anchor" href="#配置"></a> 配置</h3><h4 id="付费模式"><a class="markdownIt-Anchor" href="#付费模式"></a> 付费模式</h4><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/606a3b3a7b41b9e1a8804ada1bcff486.png" alt="image-20240514100751274" /></p><h4 id="硬件"><a class="markdownIt-Anchor" href="#硬件"></a> 硬件</h4><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/3cb353f0c0b39f7b7ea6df41b69db8bb.png" alt="image-20240514100833326" /></p><h4 id="操作系统"><a class="markdownIt-Anchor" href="#操作系统"></a> 操作系统</h4><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/7deb4a1d93f694f1c0030d9c38ce9806.png" alt="image-20240515104651134" /></p><h4 id="网络配置"><a class="markdownIt-Anchor" href="#网络配置"></a> 网络配置</h4><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/adcd3a9337af940c458a915d8fc82baa.png" alt="image-20240514101126668" /></p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/0d3932486fa10c25fa9669c3036c9385.png" alt="image-20240514101138055" /></p><h4 id="高级配置"><a class="markdownIt-Anchor" href="#高级配置"></a> 高级配置</h4><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/2adeeb4a7b3e752dc462a91dfe68f423.png" alt="image-20240515093631584" /></p><p>记录密码，后续远程登录时要用。</p><h4 id="确认配置"><a class="markdownIt-Anchor" href="#确认配置"></a> 确认配置</h4><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/fcb68d2a4e4b5738f6dd53a135a45ded.png#pic_center" alt="image-20240514101520005" /></p><h2 id="服务器安装docker"><a class="markdownIt-Anchor" href="#服务器安装docker"></a> 服务器安装docker</h2><h3 id="远程登录"><a class="markdownIt-Anchor" href="#远程登录"></a> 远程登录</h3><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/832715cddcf015fde59a9d5960b3c286.png" alt="image-20240514101719060" /></p><h4 id="安装yum工具"><a class="markdownIt-Anchor" href="#安装yum工具"></a> 安装yum工具</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">yum <span class="token function">install</span> <span class="token parameter variable">-y</span> yum-utils <span class="token punctuation">\</span>           device-mapper-persistent-data <span class="token punctuation">\</span>           lvm2 --skip-broken<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/6d424099e865f22c09f37d9b56ad2a85.png" alt="image-20240514102553996" /></p><p>然后更新本地镜像源：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">yum-config-manager <span class="token punctuation">\</span>    --add-repo <span class="token punctuation">\</span>    https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo    <span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">'s/download.docker.com/mirrors.aliyun.com\/docker-ce/g'</span> /etc/yum.repos.d/docker-ce.repoyum makecache fast<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="docker"><a class="markdownIt-Anchor" href="#docker"></a> docker</h4><p>docker版本：</p><p>CE( Community Edition)是社区版，简单理解是免费使用，提供小企业与小的IT团队使用,希望从Docker开始，并尝试基于容器的应用程序部署。</p><p>EE(Docker Enterprise Edition)是企业版，收费。提供功能更强。适合大企业与打的IT团队。为企业开发和IT团队设计，他们在生产中构建、交付和运行业务关键应用程序</p><p>安装docker</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">yum <span class="token function">install</span> <span class="token parameter variable">-y</span> docker-ce<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/7ceac64871bc86c576dea432401a419b.png#pic_center" alt="image-20240514103152379" /></p><p>系统启动时自动启动docker</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">systemctl <span class="token builtin class-name">enable</span> <span class="token function">docker</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>启动docker</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">systemctl start <span class="token function">docker</span> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="配置docker镜像加速"><a class="markdownIt-Anchor" href="#配置docker镜像加速"></a> 配置docker镜像加速</h4><p>docker官方镜像仓库网速较差，我们需要设置国内镜像服务：</p><p>参考阿里云的镜像加速文档：<a href="https://cr.console.aliyun.com/cn-hangzhou/instances/mirrors">https://cr.console.aliyun.com/cn-hangzhou/instances/mirrors</a></p><h2 id="项目打包"><a class="markdownIt-Anchor" href="#项目打包"></a> 项目打包</h2><h3 id="nuxt3项目打包"><a class="markdownIt-Anchor" href="#nuxt3项目打包"></a> nuxt3项目打包</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> run build<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>打包后，在.output目录里就是打包好的SSR项目文件。</p><p>在.output/下创建个Dockerfile文件。这个里面是编写的docker项目运行环境、打包镜像和运行项目命令的一个配置文件。</p><p>查看开发所用的 node 版本</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/e06821ad0b0e290f658dd9c6b3787551.png" alt="image-20240514104518281" /></p><h4 id="新建dockerfile"><a class="markdownIt-Anchor" href="#新建dockerfile"></a> 新建dockerfile</h4><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/50a8ed1165571852f0cf2a3502955fb6.png" alt="image-20240514142710386" /></p><h4 id="编写dockerfile"><a class="markdownIt-Anchor" href="#编写dockerfile"></a> 编写dockerfile</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">## 基于镜像node版本</span>FROM node:18.18.0<span class="token comment">## 参数，node的环境为生产环境</span>ENV <span class="token assign-left variable">NODE_ENV</span><span class="token operator">=</span>production<span class="token comment">## 任意ip</span>ENV HOST <span class="token number">0.0</span>.0.0<span class="token comment">## 容器内创建目录/nuxt3</span>RUN <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /nuxt3<span class="token comment">## 复制当前的内容到容器内容部目录/nuxt3</span>COPY <span class="token builtin class-name">.</span> /nuxt3/<span class="token comment">## 切换工作目录到/nuxt3</span>WORKDIR /nuxt3<span class="token comment">## 暴露端口3000，默认端口</span>EXPOSE <span class="token number">3000</span><span class="token comment">## start</span>CMD <span class="token punctuation">[</span><span class="token string">"node"</span>,<span class="token string">"./server/index.mjs"</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/fa753c53b9864f98f8ee5a0bf272da8b.png" alt="image-20240514105724143" /></p><h4 id="打包项目"><a class="markdownIt-Anchor" href="#打包项目"></a> 打包项目</h4><p>使用7-zip把public、server、dockerfile、nitro.json都压缩到nuxt.tar</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/bb5c33807560f7d04665a68a4aff43ff.png" alt="image-20240514125935332" /></p><p>在服务器home目录下创建web文件夹</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/9b9bae96dff6943f9bfe5e0ef3dbe162.png" alt="image-20240514130020178" /></p><h3 id="上传到服务器"><a class="markdownIt-Anchor" href="#上传到服务器"></a> 上传到服务器</h3><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/6b874e50f36cc4de113aa0836cd83130.png" alt="image-20240514130036487" /></p><p>转到web目录下</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> /<span class="token builtin class-name">cd</span> home/web<span class="token function">ls</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/d00b486ccb707fde418b14e0d59f5d5b.png" alt="image-20240514130220214" /></p><h4 id="解压tar文件"><a class="markdownIt-Anchor" href="#解压tar文件"></a> 解压tar文件</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">tar</span> <span class="token parameter variable">-xvf</span> nuxt.tar<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/37c2cb6dc852a5aef589a40183c8fe7e.png" alt="image-20240514130450877" /></p><h4 id="构建镜像"><a class="markdownIt-Anchor" href="#构建镜像"></a> 构建镜像</h4><p>名称为group_web</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> build <span class="token parameter variable">-t</span> group_web <span class="token builtin class-name">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>使用以下命令查看是否创建成功</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> images<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/7db49a3ba78df6bb9ca0fe18a52644f7.png" alt="image-20240514132050509" /></p><h4 id="创建容器"><a class="markdownIt-Anchor" href="#创建容器"></a> 创建容器</h4><p>创建一个运行该镜像的容器，命名为my_group_web，并映射端口（服务器端口：容器端口）</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> run <span class="token parameter variable">--name</span> my_group_web <span class="token parameter variable">-d</span> <span class="token parameter variable">-p</span> <span class="token number">9020</span>:3000 group_web<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>查看容器</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> <span class="token function">ps</span> //正在运行的容器or<span class="token function">docker</span> <span class="token function">ps</span> <span class="token parameter variable">-a</span> //所有容器<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h4 id="访问项目"><a class="markdownIt-Anchor" href="#访问项目"></a> 访问项目</h4><p>地址：<strong>公网ip:9020</strong></p><p>如果打不开请检查服务器安全组<br /><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/fe5ee2ac7429456d2e77bc8bab756711.png#pic_center" alt="image-20240514144636841" /></p><p>选中WebServer，嫌麻烦直接选中FullAccess，然后再次访问即可。</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/2dfc0a9e6d062ebb5ff662cfff886c16.png" alt="image-20240514144700411" /></p><p>进入安全组：</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/a4447420f19d7b304092a5602e30df7c.png" alt="image-20240514144408471" /></p><p>配置规则</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/c52daa75151275c78eeaaeb9f93171ca.png" alt="image-20240514144442604" /></p><p>添加规则即可</p><p><img src="https://zikcc.oss-cn-beijing.aliyuncs.com/img/495c60ecdd79f9e41a396623d8649984.png" alt="image-20240514144511788" /></p><h2 id="更新项目"><a class="markdownIt-Anchor" href="#更新项目"></a> 更新项目</h2><p>需要执行：<strong>停止容器、删除容器、重新进行项目打包、创建并运行镜像。</strong></p><p>查看容器</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> <span class="token function">ps</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>停止容器</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> stop my_group_web<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>删除容器</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> <span class="token function">rm</span> <span class="token parameter variable">-f</span> my_group_web<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>查看是否删除成功</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> <span class="token function">ps</span> <span class="token parameter variable">-a</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>删除镜像</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> rmi <span class="token parameter variable">-f</span> group_web<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>进入home/web</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> /<span class="token builtin class-name">cd</span> home/web<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>删除文件和文件夹</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">rm</span> * <span class="token parameter variable">-rf</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>重新执行<strong>项目打包</strong>步骤</p><h2 id="参考自"><a class="markdownIt-Anchor" href="#参考自"></a> 参考自</h2><p><a href="https://blog.csdn.net/jay100500/article/details/130139964">如何用docker容器部署nuxt3项目_docker 部署nuxt3-CSDN博客</a></p>]]></content>
      
      
      <categories>
          
          <category> 部署 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
            <tag> Nuxt3 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>课题组网站开发记录</title>
      <link href="/2025/05/19/%E8%AF%BE%E9%A2%98%E7%BB%84%E7%BD%91%E7%AB%99%E5%BC%80%E5%8F%91%E8%AE%B0%E5%BD%95/"/>
      <url>/2025/05/19/%E8%AF%BE%E9%A2%98%E7%BB%84%E7%BD%91%E7%AB%99%E5%BC%80%E5%8F%91%E8%AE%B0%E5%BD%95/</url>
      
        <content type="html"><![CDATA[<h2 id="准备工作"><a class="markdownIt-Anchor" href="#准备工作"></a> 准备工作</h2><p>后端：</p><p>java 17，springboot，mybatis，maven，mysql</p><p>前端：</p><p>vue3，element-ui</p><p>npm 镜像配置</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> config <span class="token builtin class-name">set</span> registry https://registry.npmmirror.com<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>安装vue脚手架</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> <span class="token parameter variable">-g</span> @vue/cli<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>环境</p><p><img src="C:%5CUsers%5CL%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240215233926470.png" alt="image-20240215233926470" /></p><p>使用vue ui来创建项目</p><p>安装axios</p><p>npm install axios</p><p>设置端口号</p><p><img src="C:%5CUsers%5CL%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20240216001259371.png" alt="image-20240216001259371" /></p><p>仿照<a href="http://www.rufanzhang-group.cn/">欢迎访问张如范教授课题组！Welcome to Rufan Zhang Group！ (rufanzhang-group.cn)</a></p><h2 id="数据库表结构"><a class="markdownIt-Anchor" href="#数据库表结构"></a> 数据库表结构</h2><p>1、登录用户表users</p><table><thead><tr><th style="text-align:center">id</th><th style="text-align:center">email</th><th>name</th><th style="text-align:center">username</th><th style="text-align:center">password</th><th style="text-align:center">level_key</th><th>status</th><th style="text-align:center">update_time</th><th style="text-align:center">create_time</th></tr></thead><tbody></tbody></table><p>2、课题组成员教师表teachers</p><table><thead><tr><th>id</th><th style="text-align:center">name</th><th style="text-align:center">image</th><th style="text-align:center">username</th><th>edu_exp</th><th>direction</th><th style="text-align:center">introduction</th></tr></thead><tbody></tbody></table><p>3、课题组成员学生表students</p><table><thead><tr><th style="text-align:center">id</th><th style="text-align:center">name</th><th style="text-align:center">image</th><th style="text-align:center">username</th><th style="text-align:center">degree</th><th style="text-align:center">grade</th><th style="text-align:center">direction</th></tr></thead><tbody></tbody></table><p>4、研究成果表research</p><table><thead><tr><th style="text-align:center">id</th><th style="text-align:center">papers</th><th style="text-align:center">patents</th></tr></thead><tbody></tbody></table><h2 id="接口文档"><a class="markdownIt-Anchor" href="#接口文档"></a> 接口文档</h2><h3 id="1-登录接口"><a class="markdownIt-Anchor" href="#1-登录接口"></a> 1. 登录接口</h3><h4 id="11-基本信息"><a class="markdownIt-Anchor" href="#11-基本信息"></a> 1.1 基本信息</h4><blockquote><p>请求路径：/login</p><p>请求方式：post</p><p>接口描述：登录完毕后，系统下发JWT令牌。</p></blockquote><h4 id="12-请求参数"><a class="markdownIt-Anchor" href="#12-请求参数"></a> 1.2 请求参数</h4><p>参数格式：json</p><p>参数说明：</p><table><thead><tr><th>名称</th><th>类型</th><th>是否必须</th><th>备注</th></tr></thead><tbody><tr><td>username</td><td>string</td><td>必须</td><td>账号</td></tr><tr><td>password</td><td>string</td><td>必须</td><td>密码</td></tr></tbody></table><p>请求样例：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span><span class="token property">"username"</span><span class="token operator">:</span> <span class="token string">"admin"</span><span class="token punctuation">,</span>    <span class="token property">"password"</span><span class="token operator">:</span> <span class="token string">"123456"</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h4 id="13-响应数据"><a class="markdownIt-Anchor" href="#13-响应数据"></a> 1.3 响应数据</h4><p>参数格式：json</p><p>参数说明：</p><table><thead><tr><th>名称</th><th>类型</th><th>是否必须</th><th>默认值</th><th>备注</th><th>其他信息</th></tr></thead><tbody><tr><td>code</td><td>number</td><td>必须</td><td></td><td>响应码, 1 成功 ; 0  失败</td><td></td></tr><tr><td>msg</td><td>string</td><td>非必须</td><td></td><td>提示信息</td><td></td></tr><tr><td>data</td><td>string</td><td>必须</td><td></td><td>返回的数据 , jwt令牌</td><td></td></tr></tbody></table><p>响应数据样例：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>  <span class="token property">"code"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token property">"msg"</span><span class="token operator">:</span> <span class="token string">"success"</span><span class="token punctuation">,</span>  <span class="token property">"data"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>      <span class="token property">"id"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>      <span class="token property">"name"</span><span class="token operator">:</span><span class="token string">"管理员"</span><span class="token punctuation">,</span>      <span class="token property">"username"</span><span class="token operator">:</span><span class="token string">"admin"</span><span class="token punctuation">,</span>      <span class="token property">"token"</span><span class="token operator">:</span><span class="token string">"eyJhbGciOiJIUzI1NiJ9.eyJlbXBJZCI6MSwiZXhwIjoxNzA4MDk3MjY3fQ.LsY9v1oQMBTc3EEzd7Qdo3QP-B6Dl3kpzxznz9lOGtA"</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="14-备注说明"><a class="markdownIt-Anchor" href="#14-备注说明"></a> 1.4 备注说明</h4><blockquote><p>用户登录成功后，系统会自动下发JWT令牌，然后在后续的每次请求中，都需要在请求头header中携带到服务端，请求头的名称为 token ，值为 登录时下发的JWT令牌。</p><p>如果检测到用户未登录，则会返回如下固定错误信息：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span><span class="token property">"code"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token property">"msg"</span><span class="token operator">:</span> <span class="token string">"NOT_LOGIN"</span><span class="token punctuation">,</span><span class="token property">"data"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></blockquote><h3 id="2-注册接口"><a class="markdownIt-Anchor" href="#2-注册接口"></a> 2. 注册接口</h3><h4 id="21-基本信息"><a class="markdownIt-Anchor" href="#21-基本信息"></a> 2.1 基本信息</h4><blockquote><p>请求路径：/register</p><p>请求方式：post</p><p>接口描述：登录完毕后，系统下发JWT令牌。</p></blockquote><h4 id="22-请求参数"><a class="markdownIt-Anchor" href="#22-请求参数"></a> 2.2 请求参数</h4><p>参数格式：json</p><p>参数说明：</p><table><thead><tr><th>名称</th><th>类型</th><th>是否必须</th><th>备注</th></tr></thead><tbody><tr><td>username</td><td>string</td><td>必须</td><td>账号</td></tr><tr><td>password</td><td>string</td><td>必须</td><td>密码</td></tr><tr><td>email</td><td>string</td><td>必须</td><td>邮箱</td></tr><tr><td>name</td><td>string</td><td>必须</td><td>名称</td></tr></tbody></table><p>请求样例：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span><span class="token property">"username"</span><span class="token operator">:</span> <span class="token string">"admin"</span><span class="token punctuation">,</span>    <span class="token property">"password"</span><span class="token operator">:</span> <span class="token string">"123456"</span><span class="token punctuation">,</span>    <span class="token property">"email"</span><span class="token operator">:</span> <span class="token string">"xxxx@xxx.com"</span><span class="token punctuation">,</span>    <span class="token property">"name"</span><span class="token operator">:</span><span class="token string">"xxx"</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="23-响应数据"><a class="markdownIt-Anchor" href="#23-响应数据"></a> 2.3 响应数据</h4><p>参数格式：json</p><p>参数说明：</p><table><thead><tr><th>名称</th><th>类型</th><th>是否必须</th><th>默认值</th><th>备注</th><th>其他信息</th></tr></thead><tbody><tr><td>code</td><td>number</td><td>必须</td><td></td><td>响应码, 1 成功 ; 0  失败</td><td></td></tr><tr><td>msg</td><td>string</td><td>非必须</td><td></td><td>提示信息</td><td></td></tr><tr><td>data</td><td>string</td><td>非必须</td><td></td><td>返回的数据</td><td></td></tr></tbody></table><p>响应数据样例：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>  <span class="token property">"code"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token property">"msg"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>  <span class="token property">"data"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3-获取成员接口"><a class="markdownIt-Anchor" href="#3-获取成员接口"></a> 3. 获取成员接口</h3><h4 id="31-基本信息"><a class="markdownIt-Anchor" href="#31-基本信息"></a> 3.1 基本信息</h4><blockquote><p>请求路径：/members</p><p>请求方式：get</p><p>接口描述：获取教师和学生信息</p></blockquote><h4 id="32-请求参数"><a class="markdownIt-Anchor" href="#32-请求参数"></a> 3.2 请求参数</h4><p>无</p><h4 id="33-响应数据"><a class="markdownIt-Anchor" href="#33-响应数据"></a> 3.3 响应数据</h4><p>参数格式：json</p><p>参数说明：</p><table><thead><tr><th>名称</th><th>类型</th><th>是否必须</th><th>默认值</th><th>备注</th><th>其他信息</th></tr></thead><tbody><tr><td>code</td><td>number</td><td>必须</td><td></td><td>响应码, 1 成功 ; 0  失败</td><td></td></tr><tr><td>msg</td><td>string</td><td>非必须</td><td></td><td>提示信息</td><td></td></tr><tr><td>data</td><td>string</td><td>必须</td><td></td><td>返回的数据</td><td></td></tr></tbody></table><p>响应数据样例：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span><span class="token property">"code"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token property">"msg"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span><span class="token property">"data"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>    <span class="token property">"member_info"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token property">"teachers"</span><span class="token operator">:</span> <span class="token punctuation">[</span>            <span class="token punctuation">&#123;</span>                <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"xxx"</span><span class="token punctuation">,</span>                <span class="token property">"image"</span><span class="token operator">:</span> <span class="token string">"http://xxx.com"</span><span class="token punctuation">,</span>                <span class="token property">"eduExp"</span><span class="token operator">:</span> <span class="token string">"xxx"</span><span class="token punctuation">,</span>                <span class="token property">"direction"</span><span class="token operator">:</span> <span class="token string">"xxx"</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token property">"students"</span><span class="token operator">:</span> <span class="token punctuation">[</span>            <span class="token punctuation">&#123;</span>                <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"xxx"</span><span class="token punctuation">,</span>                <span class="token property">"image"</span><span class="token operator">:</span> <span class="token string">"http://xxx.com"</span><span class="token punctuation">,</span>                <span class="token property">"degree"</span><span class="token operator">:</span> <span class="token string">"xx"</span><span class="token punctuation">,</span>                <span class="token property">"grade"</span><span class="token operator">:</span> <span class="token string">"xxxx"</span><span class="token punctuation">,</span>                <span class="token property">"direction"</span><span class="token operator">:</span> <span class="token string">"xxx"</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token punctuation">&#123;</span>                <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"xxx"</span><span class="token punctuation">,</span>                <span class="token property">"image"</span><span class="token operator">:</span> <span class="token string">"http://xxx.com"</span><span class="token punctuation">,</span>                <span class="token property">"degree"</span><span class="token operator">:</span> <span class="token string">"xx"</span><span class="token punctuation">,</span>                <span class="token property">"grade"</span><span class="token operator">:</span> <span class="token string">"xxxx"</span><span class="token punctuation">,</span>                <span class="token property">"direction"</span><span class="token operator">:</span> <span class="token string">"xxx"</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">]</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="34-备注说明"><a class="markdownIt-Anchor" href="#34-备注说明"></a> 3.4 备注说明</h4><blockquote><p>java里封装两个表的实体类，然后把实体类装入到 Map&lt;String, List&lt;?&gt;&gt; 中，一起返回数据。</p><p>后续可以优化</p></blockquote><h3 id="4-获取研究成果接口"><a class="markdownIt-Anchor" href="#4-获取研究成果接口"></a> 4. 获取研究成果接口</h3><h4 id="41-基本信息"><a class="markdownIt-Anchor" href="#41-基本信息"></a> 4.1 基本信息</h4><blockquote><p>请求路径：/works</p><p>请求方式：get</p><p>接口描述：获取研究成果</p></blockquote><h4 id="42-请求参数"><a class="markdownIt-Anchor" href="#42-请求参数"></a> 4.2 请求参数</h4><p>无</p><h4 id="43-响应数据"><a class="markdownIt-Anchor" href="#43-响应数据"></a> 4.3 响应数据</h4><p>参数格式：json</p><p>参数说明：</p><table><thead><tr><th>名称</th><th>类型</th><th>是否必须</th><th>默认值</th><th>备注</th><th>其他信息</th></tr></thead><tbody><tr><td>code</td><td>number</td><td>必须</td><td></td><td>响应码, 1 成功 ; 0  失败</td><td></td></tr><tr><td>msg</td><td>string</td><td>非必须</td><td></td><td>提示信息</td><td></td></tr><tr><td>data</td><td>string</td><td>必须</td><td></td><td>返回的数据</td><td></td></tr></tbody></table><p>响应数据样例：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>  <span class="token property">"code"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token property">"msg"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>  <span class="token property">"data"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>    <span class="token property">"works"</span><span class="token operator">:</span> <span class="token punctuation">[</span>        <span class="token punctuation">&#123;</span>            <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>            <span class="token property">"papers"</span><span class="token operator">:</span> <span class="token string">"论文1"</span><span class="token punctuation">,</span>            <span class="token property">"patents"</span><span class="token operator">:</span> <span class="token string">"专利1"</span>         <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token punctuation">&#123;</span>            <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>            <span class="token property">"papers"</span><span class="token operator">:</span> <span class="token string">"论文2"</span><span class="token punctuation">,</span>            <span class="token property">"patents"</span><span class="token operator">:</span> <span class="token string">"专利2"</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">]</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="5-获取教师信息接口"><a class="markdownIt-Anchor" href="#5-获取教师信息接口"></a> 5. 获取教师信息接口</h3><h4 id="51-基本信息"><a class="markdownIt-Anchor" href="#51-基本信息"></a> 5.1 基本信息</h4><blockquote><p>请求路径：/t_info</p><p>请求方式：get</p><p>接口描述：获取教师信息</p></blockquote><h4 id="52-请求参数"><a class="markdownIt-Anchor" href="#52-请求参数"></a> 5.2 请求参数</h4><p>无</p><h4 id="53-响应数据"><a class="markdownIt-Anchor" href="#53-响应数据"></a> 5.3 响应数据</h4><p>参数格式：json</p><p>参数说明：</p><table><thead><tr><th>名称</th><th>类型</th><th>是否必须</th><th>默认值</th><th>备注</th><th>其他信息</th></tr></thead><tbody><tr><td>code</td><td>number</td><td>必须</td><td></td><td>响应码, 1 成功 ; 0  失败</td><td></td></tr><tr><td>msg</td><td>string</td><td>非必须</td><td></td><td>提示信息</td><td></td></tr><tr><td>data</td><td>string</td><td>必须</td><td></td><td>返回的数据</td><td></td></tr></tbody></table><p>响应数据样例：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>  <span class="token property">"code"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token property">"msg"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>  <span class="token property">"data"</span><span class="token operator">:</span> <span class="token punctuation">[</span>    <span class="token punctuation">&#123;</span>        <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>        <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"xxx"</span><span class="token punctuation">,</span>        <span class="token property">"image"</span><span class="token operator">:</span> <span class="token string">"http://xxx.com"</span><span class="token punctuation">,</span>        <span class="token property">"username"</span><span class="token operator">:</span> <span class="token string">"niyuanzhi"</span><span class="token punctuation">,</span>        <span class="token property">"eduExp"</span><span class="token operator">:</span> <span class="token string">"xxx"</span><span class="token punctuation">,</span>        <span class="token property">"direction"</span><span class="token operator">:</span> <span class="token string">"xx"</span><span class="token punctuation">,</span>        <span class="token property">"introduction"</span><span class="token operator">:</span> <span class="token string">"xxxxxx"</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="6-根据账号获取教师信息接口"><a class="markdownIt-Anchor" href="#6-根据账号获取教师信息接口"></a> 6. 根据账号获取教师信息接口</h3><h4 id="61-基本信息"><a class="markdownIt-Anchor" href="#61-基本信息"></a> 6.1 基本信息</h4><blockquote><p>请求路径：/teac</p><p>请求方式：get</p><p>接口描述：获取教师信息</p></blockquote><h4 id="62-请求参数"><a class="markdownIt-Anchor" href="#62-请求参数"></a> 6.2 请求参数</h4><table><thead><tr><th>名称</th><th>类型</th><th>是否必须</th><th>默认值</th><th>备注</th><th>其他信息</th></tr></thead><tbody><tr><td>username</td><td>string</td><td>必须</td><td></td><td>账号</td><td></td></tr></tbody></table><h4 id="63-响应数据"><a class="markdownIt-Anchor" href="#63-响应数据"></a> 6.3 响应数据</h4><p>参数格式：json</p><p>参数说明：</p><table><thead><tr><th>名称</th><th>类型</th><th>是否必须</th><th>默认值</th><th>备注</th><th>其他信息</th></tr></thead><tbody><tr><td>code</td><td>number</td><td>必须</td><td></td><td>响应码, 1 成功 ; 0  失败</td><td></td></tr><tr><td>msg</td><td>string</td><td>非必须</td><td></td><td>提示信息</td><td></td></tr><tr><td>data</td><td>string</td><td>必须</td><td></td><td>返回的数据</td><td></td></tr></tbody></table><p>响应数据样例：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>  <span class="token property">"code"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token property">"msg"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>  <span class="token property">"data"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>    <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"xxx"</span><span class="token punctuation">,</span>    <span class="token property">"image"</span><span class="token operator">:</span> <span class="token string">"http://xxx.com"</span><span class="token punctuation">,</span>    <span class="token property">"username"</span><span class="token operator">:</span> <span class="token string">"niyuanzhi"</span><span class="token punctuation">,</span>    <span class="token property">"eduExp"</span><span class="token operator">:</span> <span class="token string">"xxx"</span><span class="token punctuation">,</span>    <span class="token property">"direction"</span><span class="token operator">:</span> <span class="token string">"xx"</span><span class="token punctuation">,</span>    <span class="token property">"introduction"</span><span class="token operator">:</span> <span class="token string">"xxxxxx"</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="7-修改教师信息接口"><a class="markdownIt-Anchor" href="#7-修改教师信息接口"></a> 7. 修改教师信息接口</h3><h4 id="71-基本信息"><a class="markdownIt-Anchor" href="#71-基本信息"></a> 7.1 基本信息</h4><blockquote><p>请求路径：/teac</p><p>请求方式：put</p><p>接口描述：修改教师信息</p></blockquote><h4 id="72-请求参数"><a class="markdownIt-Anchor" href="#72-请求参数"></a> 7.2 请求参数</h4><p>参数格式：json</p><p>参数说明：</p><table><thead><tr><th>名称</th><th>类型</th><th>是否必须</th><th>默认值</th><th>备注</th></tr></thead><tbody><tr><td>id</td><td>int</td><td>必须</td><td></td><td>id</td></tr><tr><td>name</td><td>string</td><td>必须</td><td></td><td>姓名</td></tr><tr><td>image</td><td>string</td><td>非必须</td><td></td><td>图片</td></tr><tr><td>edu_exp</td><td>string</td><td>必须</td><td></td><td>教育经历</td></tr><tr><td>direction</td><td>string</td><td>必须</td><td></td><td>研究方向</td></tr><tr><td>introduction</td><td>string</td><td>非必须</td><td></td><td>介绍</td></tr></tbody></table><h4 id="73-响应数据"><a class="markdownIt-Anchor" href="#73-响应数据"></a> 7.3 响应数据</h4><p>参数格式：json</p><p>参数说明：</p><table><thead><tr><th>名称</th><th>类型</th><th>是否必须</th><th>默认值</th><th>备注</th><th>其他信息</th></tr></thead><tbody><tr><td>code</td><td>number</td><td>必须</td><td></td><td>响应码, 1 成功 ; 0  失败</td><td></td></tr><tr><td>msg</td><td>string</td><td>非必须</td><td></td><td>提示信息</td><td></td></tr><tr><td>data</td><td>string</td><td>必须</td><td></td><td>返回的数据</td><td></td></tr></tbody></table><p>响应数据样例：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>  <span class="token property">"code"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token property">"msg"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>  <span class="token property">"data"</span><span class="token operator">:</span><span class="token null keyword">null</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="8-根据账号获取学生信息接口"><a class="markdownIt-Anchor" href="#8-根据账号获取学生信息接口"></a> 8. 根据账号获取学生信息接口</h3><h4 id="81-基本信息"><a class="markdownIt-Anchor" href="#81-基本信息"></a> 8.1 基本信息</h4><blockquote><p>请求路径：/stud</p><p>请求方式：get</p><p>接口描述：获取学生信息</p></blockquote><h4 id="82-请求参数"><a class="markdownIt-Anchor" href="#82-请求参数"></a> 8.2 请求参数</h4><table><thead><tr><th>名称</th><th>类型</th><th>是否必须</th><th>默认值</th><th>备注</th><th>其他信息</th></tr></thead><tbody><tr><td>username</td><td>string</td><td>必须</td><td></td><td>账号</td><td></td></tr></tbody></table><h4 id="83-响应数据"><a class="markdownIt-Anchor" href="#83-响应数据"></a> 8.3 响应数据</h4><p>参数格式：json</p><p>参数说明：</p><table><thead><tr><th>名称</th><th>类型</th><th>是否必须</th><th>默认值</th><th>备注</th><th>其他信息</th></tr></thead><tbody><tr><td>code</td><td>number</td><td>必须</td><td></td><td>响应码, 1 成功 ; 0  失败</td><td></td></tr><tr><td>msg</td><td>string</td><td>非必须</td><td></td><td>提示信息</td><td></td></tr><tr><td>data</td><td>string</td><td>必须</td><td></td><td>返回的数据</td><td></td></tr></tbody></table><p>响应数据样例：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>  <span class="token property">"code"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token property">"msg"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>  <span class="token property">"data"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>    <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"xxx"</span><span class="token punctuation">,</span>    <span class="token property">"image"</span><span class="token operator">:</span> <span class="token string">"http://xxx.com"</span><span class="token punctuation">,</span>    <span class="token property">"username"</span><span class="token operator">:</span> <span class="token string">"xxx"</span><span class="token punctuation">,</span>    <span class="token property">"degree"</span><span class="token operator">:</span> <span class="token string">"xx"</span><span class="token punctuation">,</span>    <span class="token property">"grade"</span><span class="token operator">:</span> <span class="token string">"xxxx"</span><span class="token punctuation">,</span>    <span class="token property">"direction"</span><span class="token operator">:</span> <span class="token string">"xx"</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="9-修改学生信息接口"><a class="markdownIt-Anchor" href="#9-修改学生信息接口"></a> 9. 修改学生信息接口</h3><h4 id="91-基本信息"><a class="markdownIt-Anchor" href="#91-基本信息"></a> 9.1 基本信息</h4><blockquote><p>请求路径：/stud</p><p>请求方式：put</p><p>接口描述：修改学生信息</p></blockquote><h4 id="92-请求参数"><a class="markdownIt-Anchor" href="#92-请求参数"></a> 9.2 请求参数</h4><p>参数格式：json</p><p>参数说明：</p><table><thead><tr><th>名称</th><th>类型</th><th>是否必须</th><th>默认值</th><th>备注</th></tr></thead><tbody><tr><td>name</td><td>string</td><td>必须</td><td></td><td>姓名</td></tr><tr><td>image</td><td>string</td><td>非必须</td><td></td><td>图片</td></tr><tr><td>degree</td><td>string</td><td>必须</td><td></td><td>教育经历</td></tr><tr><td>grade</td><td>string</td><td>必须</td><td></td><td>研究方向</td></tr><tr><td>direction</td><td>string</td><td>非必须</td><td></td><td>介绍</td></tr></tbody></table><h4 id="93-响应数据"><a class="markdownIt-Anchor" href="#93-响应数据"></a> 9.3 响应数据</h4><p>参数格式：json</p><p>参数说明：</p><table><thead><tr><th>名称</th><th>类型</th><th>是否必须</th><th>默认值</th><th>备注</th><th>其他信息</th></tr></thead><tbody><tr><td>code</td><td>number</td><td>必须</td><td></td><td>响应码, 1 成功 ; 0  失败</td><td></td></tr><tr><td>msg</td><td>string</td><td>非必须</td><td></td><td>提示信息</td><td></td></tr><tr><td>data</td><td>string</td><td>必须</td><td></td><td>返回的数据</td><td></td></tr></tbody></table><p>响应数据样例：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>  <span class="token property">"code"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token property">"msg"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>  <span class="token property">"data"</span><span class="token operator">:</span><span class="token null keyword">null</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="10校验token接口"><a class="markdownIt-Anchor" href="#10校验token接口"></a> 10.校验token接口</h3><h4 id="101-基本信息"><a class="markdownIt-Anchor" href="#101-基本信息"></a> 10.1 基本信息</h4><blockquote><p>请求路径：/token</p><p>请求方式：post</p><p>接口描述：校验token是否合法。</p></blockquote><h4 id="102-请求参数"><a class="markdownIt-Anchor" href="#102-请求参数"></a> 10.2 请求参数</h4><table><thead><tr><th>名称</th><th>类型</th><th>是否必须</th><th>默认值</th><th>备注</th><th>其他信息</th></tr></thead><tbody><tr><td>token</td><td>string</td><td>必须</td><td></td><td></td><td></td></tr></tbody></table><h4 id="103-响应数据"><a class="markdownIt-Anchor" href="#103-响应数据"></a> 10.3 响应数据</h4><p>参数格式：json</p><p>参数说明：</p><table><thead><tr><th>名称</th><th>类型</th><th>是否必须</th><th>默认值</th><th>备注</th><th>其他信息</th></tr></thead><tbody><tr><td>code</td><td>number</td><td>必须</td><td></td><td>响应码, 1 成功 ; 0  失败</td><td></td></tr><tr><td>msg</td><td>string</td><td>非必须</td><td></td><td>提示信息</td><td></td></tr><tr><td>data</td><td>string</td><td>必须</td><td></td><td>返回的数据</td><td></td></tr></tbody></table><p>响应数据样例：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>  <span class="token property">"code"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token property">"msg"</span><span class="token operator">:</span> <span class="token string">"success"</span><span class="token punctuation">,</span>  <span class="token property">"data"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>      <span class="token property">"id"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>      <span class="token property">"name"</span><span class="token operator">:</span><span class="token string">"管理员"</span><span class="token punctuation">,</span>      <span class="token property">"username"</span><span class="token operator">:</span><span class="token string">"admin"</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="11退出登录接口"><a class="markdownIt-Anchor" href="#11退出登录接口"></a> 11.退出登录接口</h3><h4 id="111-基本信息"><a class="markdownIt-Anchor" href="#111-基本信息"></a> 11.1 基本信息</h4><blockquote><p>请求路径：/logout</p><p>请求方式：post</p><p>接口描述：退出登录。</p></blockquote><h4 id="112-请求参数"><a class="markdownIt-Anchor" href="#112-请求参数"></a> 11.2 请求参数</h4><table><thead><tr><th>名称</th><th>类型</th><th>是否必须</th><th>默认值</th><th>备注</th><th>其他信息</th></tr></thead><tbody><tr><td>token</td><td>string</td><td>必须</td><td></td><td></td><td></td></tr></tbody></table><h4 id="113-响应数据"><a class="markdownIt-Anchor" href="#113-响应数据"></a> 11.3 响应数据</h4><p>参数格式：json</p><p>参数说明：</p><table><thead><tr><th>名称</th><th>类型</th><th>是否必须</th><th>默认值</th><th>备注</th><th>其他信息</th></tr></thead><tbody><tr><td>code</td><td>number</td><td>必须</td><td></td><td>响应码, 1 成功 ; 0  失败</td><td></td></tr><tr><td>msg</td><td>string</td><td>非必须</td><td></td><td>提示信息</td><td></td></tr><tr><td>data</td><td>string</td><td>必须</td><td></td><td>返回的数据</td><td></td></tr></tbody></table><p>响应数据样例：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>  <span class="token property">"code"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token property">"msg"</span><span class="token operator">:</span> <span class="token string">"success"</span><span class="token punctuation">,</span>  <span class="token property">"data"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="springboot开发记录"><a class="markdownIt-Anchor" href="#springboot开发记录"></a> springboot开发记录</h2><p>pojo:  UserLoginDTO------UserLoginVo------User</p><p>server: UserController------UserMapper------UserService  UserServiceImpl</p><h2 id="vue3开发记录"><a class="markdownIt-Anchor" href="#vue3开发记录"></a> Vue3开发记录</h2><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>router-link</span> <span class="token attr-name">to</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/login<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>登录<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>router-link</span><span class="token punctuation">></span></span>|<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>router-link</span> <span class="token attr-name">to</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/register<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>注册<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>router-link</span><span class="token punctuation">></span></span>|<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>router-link</span> <span class="token attr-name">to</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/stud<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>学生端<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>router-link</span><span class="token punctuation">></span></span>|<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>router-link</span> <span class="token attr-name">to</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/teac<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>教师端<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>router-link</span><span class="token punctuation">></span></span>|<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>router-link</span> <span class="token attr-name">to</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>首页<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>router-link</span><span class="token punctuation">></span></span> |<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>router-link</span> <span class="token attr-name">to</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/members<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>课题组成员<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>router-link</span><span class="token punctuation">></span></span>|<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>router-link</span> <span class="token attr-name">to</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/t_info<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>教师信息<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>router-link</span><span class="token punctuation">></span></span>|<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>router-link</span> <span class="token attr-name">to</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/works<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>研究成果<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>router-link</span><span class="token punctuation">></span></span>       <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 开发记录 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> SpringBoot </tag>
            
            <tag> Vue </tag>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
